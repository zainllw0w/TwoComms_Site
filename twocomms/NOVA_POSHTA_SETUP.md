# Настройка интеграции с Новой Почтой

## Описание

Интеграция с API Новой Почты позволяет автоматически отслеживать статус посылок и отправлять уведомления в Telegram при изменении статуса.

## Настройка

### 1. Получение API ключа

1. Зарегистрируйтесь на [сайте Новой Почты](https://novaposhta.ua/)
2. Перейдите в раздел "API" в личном кабинете
3. Создайте новый API ключ
4. Скопируйте полученный ключ

### 2. Настройка переменных окружения

Добавьте в sPanel Environment Variables:

```
NOVA_POSHTA_API_KEY=ваш_api_ключ_новой_почты
```

### 3. Применение миграций

```bash
python manage.py migrate orders
```

## Использование

### Обновление статусов всех заказов

```bash
python manage.py update_tracking_statuses
```

### Обновление конкретного заказа

```bash
python manage.py update_tracking_statuses --order-number TWC09092025N01
```

### Тестовый режим (без обновления)

```bash
python manage.py update_tracking_statuses --dry-run
```

## Автоматизация

### Настройка cron для автоматического обновления

Добавьте в crontab для обновления каждые 30 минут:

```bash
*/30 * * * * cd /path/to/your/project && python manage.py update_tracking_statuses
```

### Настройка через sPanel

1. Перейдите в раздел "Cron Jobs"
2. Создайте новую задачу:
   - **Команда**: `python manage.py update_tracking_statuses`
   - **Частота**: `*/30 * * * *` (каждые 30 минут)
   - **Путь**: `/home/qlknpodo/TWC/TwoComms_Site/twocomms`

## Функции

### Отслеживание статуса

- Автоматическое получение статуса посылки по ТТН
- Обновление статуса в базе данных
- Отображение статуса в интерфейсе заказов

### Уведомления в Telegram

- Отправка уведомлений при изменении статуса
- Уведомления отправляются пользователю, указанному в профиле
- Красивое форматирование сообщений

### Интерфейс

- Отображение статуса посылки рядом с ТТН
- Индикация времени последнего обновления
- Адаптивный дизайн для мобильных устройств

## Структура данных

### Новые поля в модели Order

- `shipment_status` - текущий статус посылки
- `shipment_status_updated` - время последнего обновления статуса

### Статусы посылок

Статусы приходят от API Новой Почты в формате:
- `"Статус - Описание статуса"`
- Например: `"В пути - Посылка в пути к получателю"`

## Безопасность

- API ключ хранится в переменных окружения
- Обработка ошибок при недоступности API
- Таймауты для запросов к API
- Логирование ошибок

## Мониторинг

### Проверка работы

```bash
# Проверка настроек
python manage.py shell -c "from django.conf import settings; print('API Key configured:', bool(settings.NOVA_POSHTA_API_KEY))"

# Тест обновления
python manage.py update_tracking_statuses --dry-run
```

### Логи

Ошибки логируются в консоль Django. Для продакшена рекомендуется настроить логирование в файл.

## Поддержка

При возникновении проблем:

1. Проверьте правильность API ключа
2. Убедитесь, что ТТН корректный
3. Проверьте доступность API Новой Почты
4. Проверьте настройки Telegram бота
