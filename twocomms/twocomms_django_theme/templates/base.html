{% load static %}
{% load cache %}
{% load seo_tags %}
{% load image_optimization %}
<!DOCTYPE html>
<html lang='uk' data-bs-theme='dark'>
<head>
  <!-- Google Analytics - отложенная загрузка для оптимизации критического пути -->
  <script>
    // Инициализация Google Analytics с отложенной загрузкой
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-109EFTWM05', {
      'send_page_view': false // Отключаем автоматическую отправку
    });
    
    // Загружаем Google Analytics после загрузки страницы
    function loadGoogleAnalytics() {
      var script = document.createElement('script');
      script.async = true;
      script.src = 'https://www.googletagmanager.com/gtag/js?id=G-109EFTWM05';
      document.head.appendChild(script);
      
      // Отправляем pageview после загрузки
      script.onload = function() {
        gtag('event', 'page_view', {
          'page_title': document.title,
          'page_location': window.location.href
        });
      };
    }
    
    // Загружаем в idle time или после load
    if('requestIdleCallback' in window) {
      requestIdleCallback(loadGoogleAnalytics, {timeout: 2000});
    } else {
      window.addEventListener('load', loadGoogleAnalytics, {once: true});
    }
  </script>
  
  <!-- Microsoft Clarity - отложенная загрузка -->
  <script>
    function loadClarity() {
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "t7u94cvpqc");
    }
    
    // Загружаем Clarity в idle time
    if('requestIdleCallback' in window) {
      requestIdleCallback(loadClarity, {timeout: 3000});
    } else {
      window.addEventListener('load', loadClarity, {once: true});
    }
  </script>
  
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <meta name="csrf-token" content="{{ csrf_token }}">
  
  <!-- Расширенные SEO Meta Tags -->
  {% block seo_meta %}
    <title>{% block title %}TwoComms — Стріт & Мілітарі Одяг{% endblock %}</title>
    <meta name="robots" content="{% block robots %}index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1{% endblock %}">
    <meta name="description" content="{% block description %}TwoComms - магазин стріт & мілітарі одягу з ексклюзивним дизайном. Футболки, худі, лонгсліви з характером. Якісний одяг для сучасного стилю.{% endblock %}">
    <meta name="keywords" content="{% block keywords %}стріт одяг, мілітарі одяг, футболки, худі, лонгсліви, TwoComms, ексклюзивний дизайн, якісний одяг, одяг з характером, стріт стиль, мілітарі стиль{% endblock %}">
    <link rel="canonical" href="{% block canonical %}{{ request.scheme }}://{{ request.get_host }}{{ request.path }}{% endblock %}">
    {% block pagination_links %}{% endblock %}
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.scheme }}://{{ request.get_host }}{{ request.path }}{% endblock %}">
    <meta property="og:title" content="{% block og_title %}TwoComms — Стріт & Мілітарі Одяг{% endblock %}">
    <meta property="og:description" content="{% block og_description %}TwoComms - магазин стріт & мілітарі одягу з ексклюзивним дизайном. Футболки, худі, лонгсліви з характером. Якісний одяг для сучасного стилю.{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ request.scheme }}://{{ request.get_host }}{% static 'img/logo.svg' %}{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="TwoComms">
    <meta property="og:locale" content="uk_UA">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{% block twitter_url %}{{ request.scheme }}://{{ request.get_host }}{{ request.path }}{% endblock %}">
    <meta property="twitter:title" content="{% block twitter_title %}TwoComms — Стріт & Мілітарі Одяг{% endblock %}">
    <meta property="twitter:description" content="{% block twitter_description %}TwoComms - магазин стріт & мілітарі одягу з ексклюзивним дизайном. Футболки, худі, лонгсліви з характером. Якісний одяг для сучасного стилю.{% endblock %}">
    <meta property="twitter:image" content="{% block twitter_image %}{{ request.scheme }}://{{ request.get_host }}{% static 'img/logo.svg' %}{% endblock %}">
  {% endblock %}
  
  <!-- Performance and Caching -->
  <meta http-equiv="Cache-Control" content="public, max-age=3600">
  <meta http-equiv="Expires" content="{% now 'D, d M Y H:i:s' %} GMT">
  
  <!-- External Resources - Оптимизированное дерево зависимостей -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <link rel="preload" href="{% static 'js/main.js' %}?v=38" as="script" crossorigin="anonymous">
  <link rel="modulepreload" href="{% static 'js/modules/shared.js' %}">
  <link rel="modulepreload" href="{% static 'js/modules/optimizers.js' %}">
  <link rel="modulepreload" href="{% static 'js/modules/product-media.js' %}">
  <link rel="modulepreload" href="{% static 'js/modules/homepage.js' %}">
  <link rel="modulepreload" href="{% static 'js/modules/cart.js' %}">
  
  <!-- Асинхронная загрузка Bootstrap CSS с приоритизацией -->
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' 
        rel='preload' as='style' 
        onload="this.onload=null;this.rel='stylesheet'"
        media="all">
  <noscript><link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet'></noscript>
  
  <!-- Шрифты с display=swap для предотвращения FOIT -->
  <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap' 
        rel='preload' as='style' 
        onload="this.onload=null;this.rel='stylesheet'"
        media="all">
  <noscript><link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap' rel='stylesheet'></noscript>
  
  <!-- PWA Support -->
  <link rel="manifest" href="{% static 'site.webmanifest' %}">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TwoComms">
  
  <!-- Favicon and Icons -->
  <link rel='apple-touch-icon' sizes='180x180' href='{% static 'img/favicon-180x180.png' %}'>
  <link rel='icon' type='image/png' sizes='32x32' href='{% static 'img/favicon-32x32.png' %}'>
  <link rel='icon' type='image/png' sizes='192x192' href='{% static 'img/favicon-192x192.png' %}'>
  <link rel='icon' type='image/png' sizes='512x512' href='{% static 'img/favicon-512x512.png' %}'>
  <meta name='application-name' content='TwoComms'>
  <meta name='theme-color' content='#111111'>
  <meta name='msapplication-TileColor' content='#111111'>
  <meta name='msapplication-TileImage' content='{% static 'img/favicon-180x180.png' %}'>
  <meta name='msapplication-square512x512logo' content="{% static 'img/favicon-512x512.png' %}">
  <link rel='mask-icon' href='{% static 'img/logo.svg' %}' color='#7c3aed'>
  <link rel='icon' href='{% static 'img/favicon.ico' %}' sizes='any' type='image/x-icon'>
  
  <!-- Early performance hint: enable lite mode for save-data/low-memory/low-CPU -->
  <script>(function(){try{var c=navigator.connection||navigator.mozConnection||navigator.webkitConnection;var save=c&&c.saveData;var lowRam=Number(navigator.deviceMemory||0)&&navigator.deviceMemory<=1;var lowCPU=Number(navigator.hardwareConcurrency||0)&&navigator.hardwareConcurrency<=1;if(save||lowRam||lowCPU){document.documentElement.classList.add('perf-lite');}}catch(e){}})();</script>
  
  <!-- Critical CSS inline для быстрой отрисовки с CLS исправлениями -->
  <style>
    /* Critical CSS - минимальные стили для первой отрисовки */
    body { 
      margin: 0; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #ffffff;
      font-size-adjust: 0.52;
    }
    .navbar { 
      background: rgba(0,0,0,0.8); 
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      height: 70px; /* Фиксированная высота */
      contain: layout; /* Изолируем layout */
    }
    .hero-section { 
      min-height: 60vh; /* Уменьшаем высоту hero-панели */
      height: 60vh; /* Фиксированная высота */
      max-height: 60vh; /* Предотвращаем переполнение */
      display: flex; 
      align-items: center;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      position: relative;
      contain: layout size; /* Изолируем layout и размеры */
      overflow: hidden;
    }
    .hero-content {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    .hero-container {
      --hero-gutter-x: 1.5rem;
      --hero-gutter-y: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-top: calc(-1 * var(--hero-gutter-y));
      margin-right: calc(-.5 * var(--hero-gutter-x));
      margin-left: calc(-.5 * var(--hero-gutter-x));
    }
    .hero-container > [class*='col-'] {
      flex: 0 0 auto;
      padding-right: calc(var(--hero-gutter-x) * .5);
      padding-left: calc(var(--hero-gutter-x) * .5);
      padding-top: var(--hero-gutter-y);
      padding-bottom: 0;
      width: 100%;
      max-width: 100%;
    }
    @media (min-width: 768px) {
      .hero-container > .col-md-6 {
        width: 50%;
        max-width: 50%;
      }
    }
    .hero-text-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      min-height: clamp(320px, 28vw, 420px);
    }
    .hero-title-main,
    .hero-title-accent,
    .hero-subtitle {
      font-size-adjust: 0.52;
    }
    main.container-xxl {
      min-height: 100vh; /* Предотвращаем смещения при загрузке контента */
      position: relative;
      contain: layout; /* Изолируем layout от внешних влияний */
    }
    .hero-particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      contain: layout; /* Изолируем layout */
      z-index: 1;
    }
    .hero-particles .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      contain: layout; /* Изолируем layout */
    }
    .loading { opacity: 0.7; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
    /* Предотвращаем смещения при загрузке изображений */
    img {
      height: auto;
      max-width: 100%;
      contain: layout; /* Изолируем layout */
    }
    /* Фиксируем стартовые состояния панелей и ratio-блоков без ожидания внешнего CSS */
    .user-panel,
    #mini-cart-panel-mobile,
    #user-panel-mobile {
      display: none !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }
    .user-panel.show,
    #mini-cart-panel-mobile.show,
    #user-panel-mobile.show {
      display: block !important;
      visibility: visible !important;
      pointer-events: auto !important;
    }
    @media (min-width: 768px) {
      #mini-cart-panel-mobile,
      #user-panel-mobile {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
      }
    }
    @media (max-width: 768px) {
      .hero-text-section {
        min-height: 340px;
      }
    }
    .ratio {
      position: relative;
      overflow: hidden;
    }
    .ratio picture,
    .ratio img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .hero-logo-image {
      aspect-ratio: 1 / 1;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      contain: layout;
    }
    picture {
      display: block;
      contain: layout;
    }
    /* Предотвращаем смещения при загрузке скриптов */
    .script-loading {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .script-loaded {
      opacity: 1;
    }
  </style>
  
  <!-- Асинхронная загрузка основного CSS с приоритизацией -->
  <link href="{% static 'css/styles.min.css' %}?v=2025.10.03.005" 
        rel="preload" as="style" 
        onload="this.onload=null;this.rel='stylesheet'"
        media="all">
  <noscript><link href="{% static 'css/styles.min.css' %}?v=2025.10.03.005" rel="stylesheet"></noscript>
  
  <!-- CLS Fixes CSS — лениво активируем после первой отрисовки через media swap -->
  <link href="{% static 'css/cls-fixes.css' %}?v=2025.09.18.011"
        rel="stylesheet"
        media="print"
        onload="this.media='all'">
  <noscript><link href="{% static 'css/cls-fixes.css' %}?v=2025.09.18.011" rel="stylesheet"></noscript>
  <style>
  
  
  
  /* Lite mode on constrained devices: reduce expensive visual effects */
  .perf-lite .hero.bg-hero,
  .perf-lite .bottom-nav,
  .perf-lite #mini-cart-panel-mobile,
  .perf-lite #user-panel-mobile { backdrop-filter: none !important; }
  .perf-lite .card.product,
  .perf-lite .bottom-nav-item:hover .bottom-nav-icon svg,
  .perf-lite .bottom-nav-item.active .bottom-nav-icon svg { filter: none !important; box-shadow: none !important; }
  .perf-lite .hint-wiggle,
  .perf-lite .reveal,
  .perf-lite .reveal-fast { transition: none !important; }
  /* Отключаем только тяжелые фоновые эффекты на слабых устройствах */
  .perf-lite body::before, .perf-lite body::after { opacity: 0.3 !important; animation-duration: 20s !important; }
  .perf-lite .cart-sparks-container, .perf-lite .avatar-glow, .perf-lite .avatar-glow-large, .perf-lite .avatar-glow-mobile, .perf-lite .cart-glow, .perf-lite .cart-glow-mobile { opacity: 0.5 !important; }
  @media (max-width: 576px){
    .perf-lite .bottom-nav { box-shadow: none !important; }
  }
  </style>
  {% block extra_css %}{% endblock %}
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "TwoComms",
    "url": "{{ request.scheme }}://{{ request.get_host }}",
    "logo": "{{ request.scheme }}://{{ request.get_host }}{% static 'img/logo.svg' %}",
    "description": "Магазин стріт & мілітарі одягу з ексклюзивним дизайном",
    "foundingDate": "2024",
    "address": {
      "@type": "PostalAddress",
      "addressCountry": "UA",
      "addressLocality": "Україна"
    },
    "contactPoint": {
      "@type": "ContactPoint",
      "contactType": "customer service",
      "availableLanguage": "Ukrainian"
    },
    "sameAs": [
      "https://instagram.com/twocomms",
      "https://t.me/twocomms"
    ]
  }
  </script>
  <!-- Meta Pixel Code - оптимизированная загрузка -->
  <div id="am"
       {% if request.user.is_authenticated %}
         data-external-id="{{ request.user.id }}"
         {% if request.user.email %}data-em="{{ request.user.email|lower|escapejs }}"{% elif request.user.userprofile and request.user.userprofile.email %}data-em="{{ request.user.userprofile.email|lower|escapejs }}"{% endif %}
         {% if request.user.userprofile and request.user.userprofile.phone %}data-ph="{{ request.user.userprofile.phone|escapejs }}"{% endif %}
         {% if request.user.userprofile and request.user.userprofile.full_name %}data-fn="{{ request.user.userprofile.full_name|escapejs }}"{% else %}data-fn="{{ request.user.first_name|escapejs }} {{ request.user.last_name|escapejs }}"{% endif %}
         {% if request.user.userprofile and request.user.userprofile.city %}data-ct="{{ request.user.userprofile.city|escapejs }}"{% endif %}
       {% endif %} style="display:none"></div>
  <script>
  (function(){
    function loadPixel(){
      !function(f,b,e,v,n,t,s){
        if(f.fbq)return; n=f.fbq=function(){ n.callMethod ? n.callMethod.apply(n,arguments) : n.queue.push(arguments) };
        if(!f._fbq) f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[]; t=b.createElement(e); t.async=!0; t.src=v; s=b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t,s);
      }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
      try{
        var amEl=document.getElementById('am');
        var am={};
        if(amEl){
          var fn=(amEl.dataset.fn||'').trim();
          var parts=fn.split(/\s+/);
          if(fn && parts.length>1){ am.fn=parts[0]; am.ln=parts.slice(1).join(' ');} else if(fn){ am.fn=fn; }
          if(amEl.dataset.externalId) am.external_id=amEl.dataset.externalId;
          if(amEl.dataset.em) am.em=amEl.dataset.em;
          if(amEl.dataset.ph) am.ph=amEl.dataset.ph;
          if(amEl.dataset.ct) am.ct=amEl.dataset.ct;
        }
        fbq('init','823958313630148', am);
      }catch(_){ try{ fbq('init','823958313630148'); }catch(__){} }
      try{ fbq('track','PageView'); }catch(__){}
    }
    // Загружаем Facebook Pixel в idle time для оптимизации критического пути
    if('requestIdleCallback' in window){ 
      requestIdleCallback(loadPixel, {timeout: 2000}); 
    } else { 
      window.addEventListener('load', loadPixel, {once:true}); 
    }
  })();
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=823958313630148&ev=PageView&noscript=1"
  /></noscript>
  <!-- End Meta Pixel Code -->
  {% block structured_data %}{% endblock %}
  <script>
  // Лёгкий аналитический хелпер: шлёт события во все доступные источники
  (function(){
    window.trackEvent = function(eventName, payload){
      try{ if(window.fbq) fbq('track', eventName, payload||{}); }catch(_){ }
      try{ if(window.gtag) gtag('event', eventName, payload||{}); }catch(_){ }
      try{ if(window.ym) ym(window.YM_ID||0, 'reachGoal', eventName, payload||{}); }catch(_){ }
    };
  })();
  </script>
</head><body class='bg-body text-body' style='font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;'>{% include 'partials/header.html' %}<main class='container-xxl py-4 py-md-5'>{% block breadcrumbs %}{% endblock %}{% block content %}{% endblock %}</main>{% cache 86400 footer_block %}{% include 'partials/footer.html' %}{% endcache %}

<!-- Мобильные мини-панели (только для мобильной версии) -->
<div id="mini-cart-panel-mobile" class="cart-panel d-none d-md-none">
  <!-- Анимация искр для корзины -->
  <div class="cart-sparks-container">
    <div class="cart-spark cart-spark-1"></div>
    <div class="cart-spark cart-spark-2"></div>
    <div class="cart-spark cart-spark-3"></div>
    <div class="cart-spark cart-spark-4"></div>
    <div class="cart-spark cart-spark-5"></div>
    <div class="cart-spark cart-spark-6"></div>
  </div>
  
  <!-- Заголовок корзины -->
  <div class="cart-header">
    <div class="cart-header-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
      </svg>
    </div>
    <div class="cart-title">Кошик</div>
    <button type="button" class="close-btn" data-cart-close-mobile aria-label="Закрити">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
      </svg>
    </button>
  </div>
  
  <!-- Содержимое корзины -->
  <div id="mini-cart-content-mobile" class="cart-content">
    <div class="cart-loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Завантаження…</div>
    </div>
  </div>
  
  <!-- Меню действий корзины -->
  <div class="cart-menu">
    <a href="{% url 'delivery' %}" class="cart-menu-item">
      <div class="cart-menu-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
        </svg>
      </div>
      <span>Умови доставки і оплати</span>
      <div class="cart-menu-arrow">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
        </svg>
      </div>
    </a>
  </div>
  
  <!-- Информационная панель -->
  <div class="cart-info">
    <div class="cart-info-icon">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
      </svg>
    </div>
    <div class="cart-info-text">
      Залишайте заявку на сайті або оплачуйте миттєво через mono checkout
    </div>
  </div>
</div>

<div id="user-panel-mobile" class="user-panel d-none d-md-none" aria-hidden="true" inert>
            {% if request.user.is_authenticated %}
              <!-- Заголовок профиля -->
              <div class="user-header">
                <div class="user-avatar-large">
                  {% if request.user.userprofile and request.user.userprofile.avatar %}
                    <img src="{{ request.user.userprofile.avatar.url }}" class="avatar-image" loading="lazy" decoding="async" fetchpriority="low" alt="Аватар користувача - TwoComms">
                  {% elif request.session.profile_avatar %}
                    <img src="{{ MEDIA_URL }}{{ request.session.profile_avatar }}" class="avatar-image" loading="lazy" decoding="async" fetchpriority="low" alt="Аватар користувача - TwoComms">
                  {% else %}
                    <img src="{% static 'img/placeholder.jpg' %}" class="avatar-image" loading="lazy" decoding="async" fetchpriority="low" alt="Аватар користувача - TwoComms">
                  {% endif %}
                  <div class="avatar-glow-large"></div>
                </div>
                <div class="user-info">
                  <div class="username">{{ request.user.username }}</div>
                  <div class="user-phone">
                    {% if request.user.userprofile and request.user.userprofile.phone %}
                      {{ request.user.userprofile.phone }}
                    {% else %}
                      {{ request.session.profile_phone|default:"Телефон не вказано" }}
                    {% endif %}
                  </div>
                </div>
                <button type="button" class="close-btn" data-user-close-mobile aria-label="Закрити">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                </button>
              </div>

              <!-- Блок с баллами -->
              {% if request.user.points %}
              <a href="{% url 'buy_with_points' %}" class="points-card-link">
                <div class="points-card">
                  <!-- Анимация искр -->
                  <div class="sparks-container">
                    <div class="spark spark-1"></div>
                    <div class="spark spark-2"></div>
                    <div class="spark spark-3"></div>
                    <div class="spark spark-4"></div>
                    <div class="spark spark-5"></div>
                    <div class="spark spark-6"></div>
                  </div>
                  
                  <div class="points-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      <path d="M12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z" fill="rgba(255,255,255,0.3)"/>
                    </svg>
                  </div>
                  <div class="points-info">
                    <div class="points-label">Ваші бали</div>
                    <div class="points-amount">{{ request.user.points.points|default:0 }}</div>
                    <div class="points-hint">Знижки • Промокоди • Підтримка ЗСУ</div>
                  </div>
                </div>
              </a>
              {% endif %}

              <!-- Меню действий -->
              <div class="user-menu">
                <a href="{% url 'profile_setup' %}" class="menu-item">
                  <div class="menu-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                  </div>
                  <span>Налаштування профілю</span>
                  <div class="menu-arrow">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                    </svg>
                  </div>
                </a>
                
                <a href="{% url 'my_orders' %}" class="menu-item">
                  <div class="menu-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                  </div>
                  <span>Мої замовлення</span>
                  <div class="menu-arrow">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                    </svg>
                  </div>
                </a>
                
                
                <a href="{% url 'my_promocodes' %}" class="menu-item">
                  <div class="menu-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
                    </svg>
                  </div>
                  <span>Мої промокоди</span>
                  <div class="menu-arrow">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                    </svg>
                  </div>
                </a>
                
                {% if request.user.is_staff or request.user.is_superuser %}
                <a href="{% url 'admin_panel' %}" class="menu-item admin-item">
                  <div class="menu-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                    </svg>
                  </div>
                  <span>Панель адміністратора</span>
                  <div class="menu-arrow">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                    </svg>
                  </div>
                </a>
                {% endif %}
              </div>

              <!-- Кнопка выхода -->
              <div class="logout-section">
                <a href="{% url 'logout' %}" class="logout-btn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                  </svg>
                  <span>Вийти</span>
                </a>
              </div>
            {% else %}
              <!-- Для неавторизованных пользователей -->
              <div class="auth-header">
                <div class="auth-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                </div>
                <div class="auth-title">Вхід в акаунт</div>
                <button type="button" class="close-btn" data-user-close-mobile aria-label="Закрити">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                </button>
              </div>
              
              <div class="auth-menu">
                <a href="{% url 'login' %}" class="auth-btn primary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
                  </svg>
                  <span>Увійти</span>
                </a>
                
                <a href="{% url 'register' %}" class="auth-btn secondary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                  <span>Зареєструватись</span>
                </a>
                
                <a href="{% url 'social:begin' 'google-oauth2' %}" class="auth-btn secondary">
                  <img src="{% static 'img/google.svg' %}" width="16" height="16" alt="Вхід через Google - TwoComms" loading="lazy">
                  <span>Увійти через Google</span>
                </a>
              </div>
              
              <div class="auth-info">
                <div class="info-icon">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                  </svg>
                </div>
                <div class="info-text">
                  Авторизуйтесь, щоб не вводити дані кожного разу та накопичувати бали
                </div>
              </div>
            {% endif %}
          </div>

<!-- Performance optimization: CSS loading enhancement -->
<script>
// Улучшение загрузки CSS для лучшей производительности
(function() {
  // Функция для загрузки CSS асинхронно
  function loadCSS(href, before, media) {
    var doc = window.document;
    var ss = doc.createElement("link");
    var ref;
    if (before) {
      ref = before;
    } else {
      var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
      ref = refs[refs.length - 1];
    }
    
    var sheets = doc.styleSheets;
    ss.rel = "stylesheet";
    ss.href = href;
    ss.media = "only x";
    
    function ready(cb) {
      if (doc.body) cb();
      else if (doc.addEventListener) doc.addEventListener("DOMContentLoaded", cb);
    }
    
    ready(function() {
      ref.parentNode.insertBefore(ss, (before ? ref : ref.nextSibling));
    });
    
    var onloadcssdefined = function(cb) {
      var resolvedHref = ss.href;
      var i = sheets.length;
      while (i--) {
        if (sheets[i].href === resolvedHref) {
          return cb();
        }
      }
      setTimeout(function() {
        onloadcssdefined(cb);
      });
    };
    
    function loadCB() {
      if (ss.addEventListener) {
        ss.removeEventListener("load", loadCB);
      }
      ss.media = media || "all";
    }
    
    if (ss.addEventListener) {
      ss.addEventListener("load", loadCB);
    }
    ss.onloadcssdefined = onloadcssdefined;
    onloadcssdefined(loadCB);
    return ss;
  }
  
  // Применяем улучшения для всех preload CSS
  var preloadLinks = document.querySelectorAll('link[rel="preload"][as="style"]');
  preloadLinks.forEach(function(link) {
    link.addEventListener('load', function() {
      this.rel = 'stylesheet';
    });
  });
  
  // Убираем класс loading после загрузки CSS
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      document.body.classList.remove('loading');
    }, 100);
  });
})();
</script>

<!-- Оптимизированная загрузка скриптов с приоритизацией -->
<script defer src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js' 
        onload="this.classList.add('script-loaded')" 
        onerror="this.classList.add('script-error')"
        crossorigin="anonymous"></script>
<script type="module"
        src="{% static 'js/main.js' %}?v=38"
        onload="this.classList.add('script-loaded')"
        onerror="this.classList.add('script-error')"
        crossorigin="anonymous"></script>

<!-- UI fallback helpers -->
<script>
/* Fallback: глобальные функции, если основной JS не заинициализирован */
(function(){
  var dlog = window.dlog || function(){
    if(window.console && console.debug){
      try{ console.debug.apply(console, arguments); }catch(_){ console.log.apply(console, arguments); }
    }
  };
  window.dlog = dlog;

  // UI debugging disabled for production
  function getCookie(name){
    var m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); 
    var result = m?decodeURIComponent(m.pop()):'';
    return result;
  }
  if(typeof window.QtyInc!=='function'){
    window.QtyInc=function(selector){
      var input=typeof selector==='string'?document.querySelector(selector):selector;
      if(!input){ return; }
      var v=parseInt(input.value||'1',10)||1; input.value=Math.max(1,v+1);
      try{ if(window.trackEvent){ var pid=(document.querySelector('[data-add-to-cart]')||{}).getAttribute&&document.querySelector('[data-add-to-cart]').getAttribute('data-add-to-cart'); if(pid){ window.trackEvent('CustomizeProduct',{content_ids:[String(pid)], content_type:'product', action:'inc_qty'}); } } }catch(_){ }
    };
  }
  if(typeof window.QtyDec!=='function'){
    window.QtyDec=function(selector){
      var input=typeof selector==='string'?document.querySelector(selector):selector;
      if(!input){ return; }
      var v=parseInt(input.value||'1',10)||1; input.value=Math.max(1,v-1);
      try{ if(window.trackEvent){ var pid=(document.querySelector('[data-add-to-cart]')||{}).getAttribute&&document.querySelector('[data-add-to-cart]').getAttribute('data-add-to-cart'); if(pid){ window.trackEvent('CustomizeProduct',{content_ids:[String(pid)], content_type:'product', action:'dec_qty'}); } } }catch(_){ }
    };
  }
  if(typeof window.CartRemoveKey!=='function'){
    window.CartRemoveKey=function(key, el){
      dlog('CartRemoveKey called with key:', key);
      
      // Получаем CSRF токен из мета-тега или cookie
      var csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                     document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || 
                     getCookie('csrftoken');
      
      var body=new URLSearchParams({key:key});
      dlog('Request body:', body.toString());
      
      fetch('/cart/remove/',{
        method:'POST',
        headers:{
          'X-CSRFToken': csrfToken,
          'X-Requested-With':'XMLHttpRequest',
          'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: body
      }).then(function(r){
        dlog('Response status:', r.status);
        if(!r.ok) {
          throw new Error('Network response was not ok: ' + r.status);
        }
        return r.json();
      }).then(function(d){
        dlog('Response data:', d);
        if(d&&d.ok){
          try{ if(window.updateCartBadge) window.updateCartBadge(d.count); }catch(_){ }
          if(el){
            var row=el.closest('[data-cart-row]')||el.closest('.d-flex');
            if(row&&row.parentElement) row.parentElement.removeChild(row);
          }
          var miniPromise = null;
          try{ if(window.refreshMiniCart) miniPromise = window.refreshMiniCart(); }catch(_){ }
          var reopen = function(){ try{ if(window.openMiniCart){ window.openMiniCart({skipRefresh:true}); } }catch(_){ } };
          if(miniPromise && miniPromise.finally){
            miniPromise.then(reopen).catch(reopen).finally(function(){
              try{ if(window.refreshCartSummary) window.refreshCartSummary(); }catch(_){ }
            });
          } else {
            try{ if(window.refreshCartSummary) window.refreshCartSummary(); }catch(_){ }
            reopen();
          }
          if(document.getElementById('cart-list')) location.reload();
          try{ if(window.trackEvent){ window.trackEvent('RemoveFromCart', {content_ids:[String(key.split(':')[0])], content_type:'product'}); } }catch(_){ }
        } else {
          console.error('Cart remove failed:', d);
          alert('Помилка при видаленні товару: ' + (d.error || 'Невідома помилка'));
        }
      }).catch(function(error){
        console.error('Cart remove error:', error);
        alert('Помилка при видаленні товару: ' + error.message);
      });
    };
  }
  if(typeof window.CartRemove!=='function'){
    window.CartRemove=function(pid,size,el){ return window.CartRemoveKey(String(pid)+':'+(size||''),el); };
  }
  
  if(typeof window.cleanCart!=='function'){
    window.cleanCart=function(){
      if(confirm('Ви впевнені, що хочете очистити кошик?')){
        var csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                       document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || 
                       getCookie('csrftoken');
        
        fetch('/cart/clear/',{
          method:'POST',
          headers:{
            'X-CSRFToken': csrfToken,
            'X-Requested-With':'XMLHttpRequest',
            'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'
          }
        }).then(function(r){
          if(!r.ok) {
            throw new Error('Network response was not ok');
          }
          return r.json();
        }).then(function(d){
          if(d&&d.ok){
            location.reload();
          } else {
            console.error('Clear cart failed:', d);
          }
        }).catch(function(error){
          console.error('Clear cart error:', error);
          alert('Помилка при очищенні кошика. Спробуйте ще раз.');
        });
      }
    };
  }
  if(typeof window.AddToCart!=='function'){
    window.AddToCart=function(btn){
      var productId = btn.getAttribute('data-add-to-cart');
      var sizeInput = document.querySelector('input[name="size"]:checked');
      var size = (sizeInput ? sizeInput.value : 'S') || 'S';
      var wrap=btn.closest('[data-qty]') || document;
      var qtyInput = wrap.querySelector('input[type="number"]#qty') || wrap.querySelector('[data-qty] input[type="number"]') || document.querySelector('#qty') || (btn.parentElement?btn.parentElement.querySelector('input[type="number"]'):null);
      var qty = Math.max(1, parseInt(qtyInput && qtyInput.value ? qtyInput.value : '1', 10));
      
      // Получаем выбранный цвет
      var colorVariantId = null;
      var activeColorSwatch = document.querySelector('#color-picker .color-swatch.active');
      if(activeColorSwatch) {
        colorVariantId = activeColorSwatch.getAttribute('data-variant');
      }
      
      // Получаем CSRF токен
      var csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                     document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || 
                     getCookie('csrftoken');
      
      var body = new URLSearchParams({product_id:String(productId), size:String(size).toUpperCase(), qty:String(qty)});
      if(colorVariantId) {
        body.append('color_variant_id', colorVariantId);
      }
      
      fetch('/cart/add/',{
        method:'POST',
        headers:{
          'X-CSRFToken': csrfToken,
          'X-Requested-With':'XMLHttpRequest',
          'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'
        },
        body: body
      }).then(function(r){
        if(!r.ok) {
          throw new Error('Network response was not ok');
        }
        return r.json();
      }).then(function(d){
        if(d&&d.ok){
          try{
            if(window.updateCartBadge) window.updateCartBadge(d.count);
            if(window.refreshMiniCart) window.refreshMiniCart();
            if(window.openMiniCart) window.openMiniCart();
          }catch(_){}
          try{ if(window.fbq){ fbq('track','AddToCart',{content_ids:[String(productId)], content_type:'product'}); } }catch(_){}
        } else {
          console.error('Add to cart failed:', d);
        }
      }).catch(function(error){
        console.error('Add to cart error:', error);
        alert('Помилка при додаванні товару до кошика. Спробуйте ще раз.');
      });
      return false;
    };
  }
})();

// Применяем CSS переменные для комбинированных цветов в корзине и заказах
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.swatch[data-secondary]:not([data-secondary=""])').forEach(function(swatch) {
    var primary = swatch.getAttribute('data-primary');
    var secondary = swatch.getAttribute('data-secondary');
    
    if (secondary && secondary !== '') {
      swatch.style.setProperty('--primary-color', primary);
      swatch.style.setProperty('--secondary-color', secondary);
    }
  });
});
</script>

<!-- Модальное окно с информацией о баллах -->
<div class="modal fade" id="pointsInfoModal" tabindex="-1" aria-labelledby="pointsInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content points-info-modal">
      <div class="modal-header">
        <div class="modal-title-section">
          <div class="modal-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          </div>
          <div class="modal-title-content">
            <h5 class="modal-title" id="pointsInfoModalLabel">Система балів</h5>
            <p class="modal-subtitle">Як працюють бали за покупки</p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="points-info-content">
          <div class="product-points-info">
            <div class="product-points-badge">
              <span class="points-amount" id="modalPointsAmount">0</span>
              <span class="points-label">балів за цей товар</span>
            </div>
            <div class="product-title" id="modalProductTitle">Назва товару</div>
          </div>
          
          <div class="points-explanation">
            <div class="explanation-item">
              <div class="explanation-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="explanation-text">
                <strong>Нарахування балів:</strong> Бали нараховуються автоматично після підтвердження замовлення
              </div>
            </div>
            
            <div class="explanation-item">
              <div class="explanation-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
                </svg>
              </div>
              <div class="explanation-text">
                <strong>Використання балів:</strong> Зареєстровані користувачі можуть витратити бали у кабінеті
              </div>
            </div>
            
            <div class="explanation-item">
              <div class="explanation-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </div>
              <div class="explanation-text">
                <strong>Можливості:</strong> Обмін на промокоди або пожертвування на ЗСУ
              </div>
            </div>
          </div>
          
          <div class="points-actions">
            {% if user.is_authenticated %}
              <a href="{% url 'buy_with_points' %}" class="btn btn-primary points-action-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Перейти до балів
              </a>
            {% else %}
              <a href="{% url 'login' %}" class="btn btn-outline-primary points-action-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
                </svg>
                Увійти для накопичення балів
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Обработчик для модального окна с информацией о баллах
  const pointsInfoModal = document.getElementById('pointsInfoModal');
  if (pointsInfoModal) {
    pointsInfoModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const productTitle = button.getAttribute('data-product-title');
      const pointsAmount = button.getAttribute('data-points-amount');
      
      // Обновляем содержимое модального окна
      document.getElementById('modalProductTitle').textContent = productTitle;
      document.getElementById('modalPointsAmount').textContent = pointsAmount;
    });
  }
});
</script>

<style>
.points-info-modal .modal-content {
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 16px;
}

.points-info-modal .modal-header {
  border-bottom: 1px solid rgba(255,255,255,0.1);
  padding: 1.5rem;
}

.modal-title-section {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.modal-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, var(--accent-color), #7c3aed);
  border-radius: 12px;
  color: white;
}

.modal-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
}

.modal-subtitle {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin: 0;
}

.points-info-modal .modal-body {
  padding: 1.5rem;
}

.product-points-info {
  text-align: center;
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(124, 58, 237, 0.05));
  border-radius: 12px;
  border: 1px solid rgba(124, 58, 237, 0.2);
}

.product-points-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.points-amount {
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent-color);
}

.points-label {
  font-size: 1rem;
  color: var(--text-secondary);
}

.product-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--text-primary);
}

.points-explanation {
  margin-bottom: 2rem;
}

.explanation-item {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.explanation-item:last-child {
  margin-bottom: 0;
}

.explanation-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
  border-radius: 8px;
  color: #10b981;
  flex-shrink: 0;
}

.explanation-text {
  font-size: 1rem;
  color: var(--text-secondary);
  line-height: 1.5;
}

.explanation-text strong {
  color: var(--text-primary);
}

.points-actions {
  text-align: center;
}

.points-action-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border-radius: 12px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.3s ease;
}

.points-action-btn:hover {
  transform: translateY(-1px);
  text-decoration: none;
}

.btn-primary.points-action-btn {
  background: linear-gradient(135deg, var(--accent-color), #7c3aed);
  border: none;
  color: white;
}

.btn-primary.points-action-btn:hover {
  box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
  color: white;
}

.btn-outline-primary.points-action-btn {
  border: 1px solid var(--accent-color);
  color: var(--accent-color);
  background: transparent;
}

.btn-outline-primary.points-action-btn:hover {
  background: var(--accent-color);
  color: white;
  box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
}

@media (max-width: 768px) {
  .points-info-modal .modal-dialog {
    margin: 1rem;
  }
  
  .modal-title-section {
    flex-direction: column;
    text-align: center;
    gap: 0.75rem;
  }
  
  .explanation-item {
    flex-direction: column;
    text-align: center;
    gap: 0.75rem;
  }
}
</style>

{% block extra_js %}{% endblock %}

<!-- JavaScript для управления видимостью favorites -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  function toggleFavoritesVisibility() {
    // Десктопный мини-профиль
    const favoritesItem = document.getElementById('favorites-menu-item');
    // Мобильная нижняя навигация
    const favoritesMobileBottomNav = document.getElementById('favorites-mobile-bottom-nav');
    
    
    if (window.innerWidth <= 991) {
      // Скрываем на мобильных - агрессивно
      
      if (favoritesItem) {
        favoritesItem.style.setProperty('display', 'none', 'important');
        favoritesItem.style.setProperty('visibility', 'hidden', 'important');
        favoritesItem.style.setProperty('opacity', '0', 'important');
        favoritesItem.style.setProperty('height', '0', 'important');
        favoritesItem.style.setProperty('overflow', 'hidden', 'important');
        favoritesItem.style.setProperty('position', 'absolute', 'important');
        favoritesItem.style.setProperty('left', '-9999px', 'important');
      }
      
      if (favoritesMobileBottomNav) {
        favoritesMobileBottomNav.style.setProperty('display', 'none', 'important');
        favoritesMobileBottomNav.style.setProperty('visibility', 'hidden', 'important');
        favoritesMobileBottomNav.style.setProperty('opacity', '0', 'important');
        favoritesMobileBottomNav.style.setProperty('height', '0', 'important');
        favoritesMobileBottomNav.style.setProperty('overflow', 'hidden', 'important');
        favoritesMobileBottomNav.style.setProperty('position', 'absolute', 'important');
        favoritesMobileBottomNav.style.setProperty('left', '-9999px', 'important');
      }
    } else {
      // Показываем на десктопе
      
      if (favoritesItem) {
        favoritesItem.style.setProperty('display', 'flex', 'important');
        favoritesItem.style.setProperty('visibility', 'visible', 'important');
        favoritesItem.style.setProperty('opacity', '1', 'important');
        favoritesItem.style.setProperty('height', 'auto', 'important');
        favoritesItem.style.setProperty('overflow', 'visible', 'important');
        favoritesItem.style.setProperty('position', 'static', 'important');
        favoritesItem.style.setProperty('left', 'auto', 'important');
      }
      
      if (favoritesMobileBottomNav) {
        favoritesMobileBottomNav.style.setProperty('display', 'none', 'important');
      }
    }
  }
  
  // Применяем при загрузке
  setTimeout(toggleFavoritesVisibility, 100);
  
  // Обновляем при изменении размера окна
  window.addEventListener('resize', function() {
    setTimeout(toggleFavoritesVisibility, 50);
  });
});
</script>

{% comment %}
<!-- Analytics and Performance Monitoring - ОТКЛЮЧЕНО -->
{% include 'partials/analytics.html' %}
{% endcomment %}

{% comment %}
<!-- Service Worker for PWA - ОТКЛЮЧЕН -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(function(registration) {
      })
      .catch(function(registrationError) {
      });
  });
}
</script>
{% endcomment %}

</body></html>
