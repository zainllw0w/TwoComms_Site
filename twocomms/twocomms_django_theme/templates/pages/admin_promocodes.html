{% load static %}

<!-- CSS для стилей промокодов в стиле дропшипинга -->
<link rel="stylesheet" href="{% static 'css/dropshipper.css' %}?v=20251027promo" media="all">

<div class="ds-shell" style="padding-top: 0;">
  <!-- Sidebar навигация -->
  <aside class="ds-sidebar" style="top: 0; min-height: auto;">
    <div class="ds-sidebar__inner">
      <div class="ds-sidebar__brand">
        <div class="ds-sidebar__logo">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="#8b5cf6">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        </div>
        <div>
          <div class="ds-sidebar__title">Промокоди</div>
          <div class="ds-sidebar__subtitle">Панель керування</div>
      </div>
    </div>
    
      <nav class="ds-sidebar__nav">
        <a href="?section=promocodes&tab=promocodes" class="ds-sidebar__link {% if promo_tab == 'promocodes' or not promo_tab %}is-active{% endif %}">
          <span class="ds-sidebar__icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
          </span>
          <span class="ds-sidebar__label">
            Промокоди
            <span class="ds-sidebar__badge">{{ total_promocodes|default:0 }}</span>
          </span>
        </a>

        <a href="?section=promocodes&tab=groups" class="ds-sidebar__link {% if promo_tab == 'groups' %}is-active{% endif %}">
          <span class="ds-sidebar__icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
          </span>
          <span class="ds-sidebar__label">
            Групи
            <span class="ds-sidebar__badge">{{ total_groups|default:0 }}</span>
          </span>
        </a>

        <a href="?section=promocodes&tab=stats" class="ds-sidebar__link {% if promo_tab == 'stats' %}is-active{% endif %}">
          <span class="ds-sidebar__icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
          </span>
          <span class="ds-sidebar__label">
            Статистика
          </span>
        </a>
      </nav>

      <!-- Краткая статистика в сайдбаре -->
      <div class="ds-sidebar__stats">
        <div class="ds-sidebar__stat">
          <div class="ds-sidebar__stat-value">{{ active_promocodes|default:0 }}</div>
          <div class="ds-sidebar__stat-label">Активних</div>
    </div>
        <div class="ds-sidebar__stat">
          <div class="ds-sidebar__stat-value">{{ total_usages|default:0 }}</div>
          <div class="ds-sidebar__stat-label">Використань</div>
        </div>
      </div>
    </div>
  </aside>
    
  <!-- Main контент -->
  <main class="ds-main">
    
    <!-- ==================== ТАБ: ПРОМОКОДИ ==================== -->
    {% if promo_tab == 'promocodes' or not promo_tab %}
    <section class="ds-tab-panel is-active">
      <div class="ds-container">
        <!-- Hero секция -->
        <section class="ds-hero" style="min-height: auto; padding: 2rem 0;">
          <div class="ds-hero__background">
            <span class="ds-hero__blur ds-hero__blur--left"></span>
            <span class="ds-hero__blur ds-hero__blur--right"></span>
            <span class="ds-hero__glow"></span>
          </div>
          <div class="ds-hero__body">
            <div class="ds-hero__main">
              <span class="ds-eyebrow ds-eyebrow--accent">
                <i class="fas fa-star"></i>
                Управління промокодами
              </span>
              <h1 class="ds-hero__title" style="font-size: 2.5rem;">Промокоди та знижки</h1>
              <p class="ds-hero__lead">
                Створюйте гнучкі системи знижок для ваших клієнтів. Групові акції, ваучери та індивідуальні пропозиції.
              </p>
              <div class="ds-actions ds-actions--hero">
                <button type="button" class="ds-btn ds-btn--primary" data-bs-toggle="modal" data-bs-target="#createPromoModal">
                  <i class="fas fa-plus"></i>
                  <span>Створити промокод</span>
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Фильтры -->
        <div class="ds-filters">
          <div class="ds-filter-pills">
            <a href="?section=promocodes&tab=promocodes&view=all" class="ds-pill {% if view_type == 'all' or not view_type %}is-active{% endif %}">
              Всі <span class="ds-pill__count">{{ total_promocodes|default:0 }}</span>
            </a>
            <a href="?section=promocodes&tab=promocodes&view=grouped" class="ds-pill {% if view_type == 'grouped' %}is-active{% endif %}">
              Групові
            </a>
            <a href="?section=promocodes&tab=promocodes&view=vouchers" class="ds-pill {% if view_type == 'vouchers' %}is-active{% endif %}">
              Ваучери <span class="ds-pill__count">{{ total_vouchers|default:0 }}</span>
            </a>
            <a href="?section=promocodes&tab=promocodes&view=regular" class="ds-pill {% if view_type == 'regular' %}is-active{% endif %}">
              Звичайні
            </a>
          </div>
          
          <!-- Фільтр по групах -->
          <div class="ds-group-filter">
            <label for="groupFilter" class="ds-group-filter__label">
              <i class="fas fa-layer-group"></i> Фільтр по групах:
            </label>
            <select id="groupFilter" class="ds-group-filter__select">
              <option value="">Всі групи</option>
              <option value="no-group">Без групи</option>
              {% for group in groups %}
                <option value="{{ group.id }}" data-color="{{ group.id }}">{{ group.name }} ({{ group.codes_count }})</option>
              {% endfor %}
            </select>
            <button type="button" id="clearGroupFilter" class="ds-group-filter__clear" title="Очистити фільтр" style="display: none;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <!-- Швидкий пошук -->
          <div class="ds-search-box">
            <i class="fas fa-search ds-search-icon"></i>
            <input type="text" id="promoSearch" class="ds-search-input" placeholder="Швидкий пошук промокодів...">
            <button type="button" id="clearSearch" class="ds-search-clear" style="display: none;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <!-- Сортування -->
          <div class="ds-sort-box">
            <label for="promoSort" class="ds-sort-label">
              <i class="fas fa-sort"></i> Сортувати:
            </label>
            <select id="promoSort" class="ds-sort-select">
              <option value="newest">Нові спочатку</option>
              <option value="oldest">Старі спочатку</option>
              <option value="discount-high">Знижка (висока → низька)</option>
              <option value="discount-low">Знижка (низька → висока)</option>
              <option value="usage-high">Використання (багато → мало)</option>
              <option value="usage-low">Використання (мало → багато)</option>
              <option value="code-az">Код (A → Z)</option>
              <option value="code-za">Код (Z → A)</option>
            </select>
          </div>
  </div>

  <!-- Список промокодов -->
        <div class="ds-grid ds-fade-in-grid">
    {% if promocodes %}
      {% for promo in promocodes %}
            <article class="ds-promo-card ds-fade-in-item {% if not promo.is_active %}is-inactive{% endif %}" 
                     draggable="true" 
                     data-promo-id="{{ promo.id }}"
                     data-group-id="{{ promo.group.id|default:'' }}"
                     ondragstart="handlePromoDragStart(event)"
                     ondragend="handlePromoDragEnd(event)">
              <div class="ds-promo-card__header">
                <div class="ds-promo-card__code">
                  <code>{{ promo.code }}</code>
                  {% if promo.promo_type == 'voucher' %}
                    <span class="ds-badge ds-badge--voucher">Ваучер</span>
                  {% elif promo.promo_type == 'grouped' %}
                    <span class="ds-badge ds-badge--grouped">Груповий</span>
                  {% endif %}
            </div>
                <div class="ds-promo-card__status">
                  <span class="ds-status-dot {% if promo.is_active %}is-active{% else %}is-inactive{% endif %}"></span>
                </div>
              </div>

              {% if promo.description %}
              <p class="ds-promo-card__description">{{ promo.description|truncatewords:15 }}</p>
              {% endif %}

              <div class="ds-promo-card__stats">
                <div class="ds-stat-item">
                  <div class="ds-stat-item__label">Знижка</div>
                  <div class="ds-stat-item__value">{{ promo.get_discount_display }}</div>
                </div>
                <div class="ds-stat-item">
                  <div class="ds-stat-item__label">Використань</div>
                  <div class="ds-stat-item__value">
                    {{ promo.current_uses }}{% if promo.max_uses > 0 %}/{{ promo.max_uses }}{% else %}/∞{% endif %}
                  </div>
                </div>
            </div>

              {% if promo.group %}
              <div class="ds-promo-card__group">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3z"/>
                  </svg>
                {{ promo.group.name }}
              </div>
              {% endif %}

              <div class="ds-promo-card__actions">
                <button type="button" class="ds-action-btn ds-action-btn--edit" title="Редагувати" onclick="openEditPromoModal({{ promo.id }})">
                  <i class="fas fa-edit"></i>
                </button>
                <a href="{% url 'admin_promocode_toggle' promo.id %}" class="ds-action-btn ds-action-btn--toggle" title="{% if promo.is_active %}Деактивувати{% else %}Активувати{% endif %}">
                  <i class="fas fa-{% if promo.is_active %}pause{% else %}play{% endif %}"></i>
                </a>
                <button type="button" class="ds-action-btn ds-action-btn--delete" title="Видалити" onclick="confirmDelete('promo', {{ promo.id }}, '{{ promo.code }}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </article>
            {% endfor %}
                {% else %}
            <div class="ds-empty-state">
              <div class="ds-empty-state__icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
              </div>
              <h3 class="ds-empty-state__title">Немає промокодів</h3>
              <p class="ds-empty-state__text">Створіть перший промокод для ваших клієнтів</p>
              <button type="button" class="ds-btn ds-btn--primary" data-bs-toggle="modal" data-bs-target="#createPromoModal">
                <i class="fas fa-plus"></i>
                <span>Створити промокод</span>
              </button>
            </div>
                {% endif %}
              </div>
            </div>
    </section>
    {% endif %}

    <!-- ==================== ТАБ: ГРУПИ ==================== -->
    {% if promo_tab == 'groups' %}
    <section class="ds-tab-panel is-active">
      <div class="ds-container">
        <!-- Hero -->
        <section class="ds-hero" style="min-height: auto; padding: 2rem 0;">
          <div class="ds-hero__background">
            <span class="ds-hero__blur ds-hero__blur--left"></span>
            <span class="ds-hero__blur ds-hero__blur--right"></span>
          </div>
          <div class="ds-hero__body">
            <div class="ds-hero__main">
              <span class="ds-eyebrow ds-eyebrow--accent">
                <i class="fas fa-users"></i>
                Групи промокодів
              </span>
              <h1 class="ds-hero__title" style="font-size: 2.5rem;">Організація акцій</h1>
              <p class="ds-hero__lead">
                Групуйте промокоди за кампаніями. Встановлюйте обмеження "один на аккаунт" для рекламних акцій.
              </p>
              <div class="ds-actions ds-actions--hero">
                <button type="button" class="ds-btn ds-btn--primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                  <i class="fas fa-plus"></i>
                  <span>Створити групу</span>
                </button>
            </div>
            </div>
          </div>
        </section>

        <!-- Список групп -->
        <div class="ds-grid">
          {% if groups %}
            {% for group in groups %}
            <article class="ds-group-card {% if not group.is_active %}is-inactive{% endif %} promo-drop-zone" 
                     data-group-id="{{ group.id }}"
                     ondragover="handleGroupDragOver(event)"
                     ondragleave="handleGroupDragLeave(event)"
                     ondrop="handleGroupDrop(event)">
              <div class="ds-group-card__header">
                <h3 class="ds-group-card__title">
                  {{ group.name }}
                  {% if group.one_per_account %}
                    <span class="ds-badge ds-badge--info">1 на акаунт</span>
                {% endif %}
                </h3>
                <span class="ds-status-dot {% if group.is_active %}is-active{% else %}is-inactive{% endif %}"></span>
              </div>
              
              {% if group.description %}
              <p class="ds-group-card__description">{{ group.description|truncatewords:20 }}</p>
              {% endif %}

              <div class="ds-group-card__metrics">
                <div class="ds-metric">
                  <div class="ds-metric__value">{{ group.codes_count }}</div>
                  <div class="ds-metric__label">Промокодів</div>
                  </div>
                <div class="ds-metric">
                  <div class="ds-metric__value">{{ group.active_codes_count }}</div>
                  <div class="ds-metric__label">Активних</div>
                </div>
                <div class="ds-metric">
                  <div class="ds-metric__value">{{ group.total_usages|default:0 }}</div>
                  <div class="ds-metric__label">Використань</div>
              </div>
            </div>
            
              <div class="ds-group-card__actions">
                <a href="?section=promocodes&tab=promocodes&group={{ group.id }}" class="ds-action-btn ds-action-btn--view" title="Переглянути промокоди">
                  <i class="fas fa-eye"></i>
                </a>
                <button type="button" class="ds-action-btn ds-action-btn--edit" title="Редагувати" onclick="openEditGroupModal({{ group.id }})">
                  <i class="fas fa-edit"></i>
                </button>
                <a href="{% url 'admin_promo_group_delete' group.id %}" class="ds-action-btn ds-action-btn--delete" title="Видалити" onclick="return confirm('Видалити групу?')">
                  <i class="fas fa-trash"></i>
                </a>
            </div>
            </article>
            {% endfor %}
                {% else %}
            <div class="ds-empty-state">
              <div class="ds-empty-state__icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3z"/>
              </svg>
            </div>
              <h3 class="ds-empty-state__title">Немає груп</h3>
              <p class="ds-empty-state__text">Створіть групу для організації промокодів</p>
              <button type="button" class="ds-btn ds-btn--primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                <i class="fas fa-plus"></i>
                <span>Створити групу</span>
              </button>
          </div>
                {% endif %}
              </div>
      </div>
    </section>
              {% endif %}

    <!-- ==================== ТАБ: СТАТИСТИКА ==================== -->
    {% if promo_tab == 'stats' %}
    <section class="ds-tab-panel is-active">
      <div class="ds-container">
        <!-- Hero -->
        <section class="ds-hero" style="min-height: auto; padding: 2rem 0;">
          <div class="ds-hero__background">
            <span class="ds-hero__blur ds-hero__blur--left"></span>
            <span class="ds-hero__blur ds-hero__blur--right"></span>
                  </div>
          <div class="ds-hero__body">
            <div class="ds-hero__main">
              <span class="ds-eyebrow ds-eyebrow--accent">
                <i class="fas fa-chart-line"></i>
                Аналітика
              </span>
              <h1 class="ds-hero__title" style="font-size: 2.5rem;">Статистика використання</h1>
              <p class="ds-hero__lead">
                Детальний аналіз ефективності промокодів та груп
              </p>
            </div>
            
            <!-- Dark Mode Toggle -->
            <button type="button" id="darkModeToggle" class="ds-dark-mode-toggle" title="Перемкнути тему">
              <i class="fas fa-moon" id="darkModeIcon"></i>
            </button>
            
            <!-- Кнопки експорту -->
            <div class="ds-export-actions">
              <button type="button" class="ds-export-btn ds-export-btn--csv" onclick="exportStats('csv')">
                <i class="fas fa-file-csv"></i> Експорт CSV
              </button>
              <button type="button" class="ds-export-btn ds-export-btn--excel" onclick="exportStats('excel')">
                <i class="fas fa-file-excel"></i> Експорт Excel
              </button>
              <button type="button" class="ds-export-btn ds-export-btn--pdf" onclick="exportStats('pdf')">
                <i class="fas fa-file-pdf"></i> Експорт PDF
              </button>
            </div>
            
            <!-- Фільтри по датах -->
            <div class="ds-date-filters">
              <div class="ds-date-filter-pills">
                <button type="button" class="ds-date-pill is-active" data-period="all">
                  <i class="fas fa-infinity"></i> Весь час
                </button>
                <button type="button" class="ds-date-pill" data-period="today">
                  <i class="fas fa-calendar-day"></i> Сьогодні
                </button>
                <button type="button" class="ds-date-pill" data-period="week">
                  <i class="fas fa-calendar-week"></i> Тиждень
                </button>
                <button type="button" class="ds-date-pill" data-period="month">
                  <i class="fas fa-calendar-alt"></i> Місяць
                </button>
                <button type="button" class="ds-date-pill" data-period="custom">
                  <i class="fas fa-calendar-range"></i> Кастомний
                </button>
              </div>
              
              <!-- Datepicker для кастомного періоду -->
              <div id="customDateRange" class="ds-custom-date-range" style="display: none;">
                <div class="ds-date-inputs">
                  <div class="ds-date-input-group">
                    <label for="dateFrom">Від:</label>
                    <input type="date" id="dateFrom" class="ds-date-input">
                  </div>
                  <div class="ds-date-input-group">
                    <label for="dateTo">До:</label>
                    <input type="date" id="dateTo" class="ds-date-input">
                  </div>
                  <button type="button" id="applyCustomDates" class="ds-btn ds-btn--apply">
                    <i class="fas fa-check"></i> Застосувати
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Общая статистика -->
        <div class="ds-stats-overview">
          <div class="ds-overview-card">
            <div class="ds-overview-card__icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="ds-overview-card__value">{{ total_usages|default:0 }}</div>
            <div class="ds-overview-card__label">Всього використань</div>
          </div>
          <div class="ds-overview-card">
            <div class="ds-overview-card__icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="ds-overview-card__value">{{ unique_users|default:0 }}</div>
            <div class="ds-overview-card__label">Унікальних користувачів</div>
          </div>
          <div class="ds-overview-card ds-overview-card--success">
            <div class="ds-overview-card__icon">
              <i class="fas fa-percentage"></i>
            </div>
            <div class="ds-overview-card__value">{{ conversion_rate|default:0 }}%</div>
            <div class="ds-overview-card__label">Конверсія промокодів</div>
            <div class="ds-overview-card__meta">
              {{ used_promocodes_count }}/{{ total_promocodes }} використано
            </div>
          </div>
          <div class="ds-overview-card ds-overview-card--warning">
            <div class="ds-overview-card__icon">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="ds-overview-card__value">{{ total_savings|floatformat:2 }} ₴</div>
            <div class="ds-overview-card__label">Загальна економія</div>
            <div class="ds-overview-card__meta">
              Фіксовані знижки
            </div>
          </div>
        </div>
        
        <!-- Розширена статистика -->
        <div class="ds-stats-extended">
          <div class="ds-stat-card">
            <div class="ds-stat-card__header">
              <i class="fas fa-tag"></i>
              <h3>Середні знижки</h3>
            </div>
            <div class="ds-stat-card__body">
              <div class="ds-stat-row">
                <span class="ds-stat-label">Відсоткові промокоди:</span>
                <span class="ds-stat-value">{{ avg_discount_percent|floatformat:1 }}%</span>
              </div>
              <div class="ds-stat-row">
                <span class="ds-stat-label">Фіксовані промокоди:</span>
                <span class="ds-stat-value">{{ avg_discount_fixed|floatformat:2 }} ₴</span>
              </div>
              <div class="ds-stat-row">
                <span class="ds-stat-label">Середнє використань/промокод:</span>
                <span class="ds-stat-value">{{ avg_usages_per_promo|floatformat:2 }}</span>
              </div>
            </div>
          </div>
          
          <div class="ds-stat-card ds-stat-card--highlight">
            <div class="ds-stat-card__header">
              <i class="fas fa-crown"></i>
              <h3>Лідери</h3>
            </div>
            <div class="ds-stat-card__body">
              {% if most_popular_promo %}
                <div class="ds-stat-row ds-stat-row--large">
                  <span class="ds-stat-label">Найпопулярніший промокод:</span>
                  <span class="ds-stat-value"><code>{{ most_popular_promo.code }}</code></span>
                </div>
                <div class="ds-stat-row ds-stat-row--muted">
                  <span class="ds-stat-label">Використань:</span>
                  <span class="ds-stat-value">{{ most_popular_promo.usages.count }}</span>
                </div>
              {% endif %}
              
              {% if most_successful_group %}
                <div class="ds-stat-row ds-stat-row--large" style="margin-top: 1rem;">
                  <span class="ds-stat-label">Найуспішніша група:</span>
                  <span class="ds-stat-value">{{ most_successful_group.name }}</span>
                </div>
              {% endif %}
            </div>
            </div>
          </div>

        <!-- Графіки -->
        <div class="ds-charts-grid">
          <!-- Line Chart: Використання по датах -->
          <div class="ds-chart-card">
            <div class="ds-chart-card__header">
              <h3><i class="fas fa-chart-line"></i> Використання по датах</h3>
              <span class="ds-chart-card__subtitle">Останні 30 днів</span>
            </div>
            <div class="ds-chart-card__body">
              <canvas id="usageLineChart"></canvas>
            </div>
          </div>
          
          <!-- Bar Chart: TOP-10 промокодів -->
          <div class="ds-chart-card">
            <div class="ds-chart-card__header">
              <h3><i class="fas fa-chart-bar"></i> ТОП-10 промокодів</h3>
              <span class="ds-chart-card__subtitle">За кількістю використань</span>
            </div>
            <div class="ds-chart-card__body">
              <canvas id="topPromosBarChart"></canvas>
          </div>
        </div>

          <!-- Pie Chart: Розподіл по групах -->
          <div class="ds-chart-card">
            <div class="ds-chart-card__header">
              <h3><i class="fas fa-chart-pie"></i> Розподіл по групах</h3>
              <span class="ds-chart-card__subtitle">Використання промокодів</span>
            </div>
            <div class="ds-chart-card__body">
              <canvas id="groupsPieChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Топ промокодов -->
        <div class="ds-section">
          <h2 class="ds-section__title">
            <i class="fas fa-trophy"></i>
            Топ-10 промокодів
          </h2>
          <div class="ds-leaderboard">
            {% for promo in top_promos %}
            <div class="ds-leader-item">
              <div class="ds-leader-rank">#{{ forloop.counter }}</div>
              <div class="ds-leader-info">
                <div class="ds-leader-name"><code>{{ promo.code }}</code></div>
                <div class="ds-leader-meta">{{ promo.get_discount_display }}</div>
              </div>
              <div class="ds-leader-value">{{ promo.usage_count }}</div>
            </div>
            {% empty %}
            <p class="ds-no-data">Немає даних</p>
            {% endfor %}
          </div>
        </div>

        <!-- Топ групп -->
        {% if top_groups %}
        <div class="ds-section">
          <h2 class="ds-section__title">
            <i class="fas fa-users"></i>
            Топ-10 груп
          </h2>
          <div class="ds-leaderboard">
            {% for group in top_groups %}
            <div class="ds-leader-item">
              <div class="ds-leader-rank">#{{ forloop.counter }}</div>
              <div class="ds-leader-info">
                <div class="ds-leader-name">{{ group.name }}</div>
              </div>
              <div class="ds-leader-value">{{ group.usage_count }}</div>
      </div>
      {% endfor %}
          </div>
        </div>
            {% endif %}

        <!-- Последние использования -->
        <div class="ds-section">
          <h2 class="ds-section__title">
            <i class="fas fa-clock"></i>
            Останні 50 використань
          </h2>
          <div class="ds-usage-log">
            {% for usage in recent_usages %}
            <div class="ds-usage-row">
              <div class="ds-usage-date">{{ usage.used_at|date:"d.m.Y H:i" }}</div>
              <div class="ds-usage-user">{{ usage.user.username }}</div>
              <div class="ds-usage-code"><code>{{ usage.promo_code.code }}</code></div>
              <div class="ds-usage-group">
                {% if usage.group %}{{ usage.group.name }}{% else %}—{% endif %}
        </div>
      </div>
            {% empty %}
            <p class="ds-no-data">Немає використань</p>
      {% endfor %}
        </div>
      </div>
      </div>
    </section>
    {% endif %}

  </main>
  </div>

<!-- ==================== МОДАЛЬНІ ВІКНА ==================== -->

<!-- Modal: Створення промокода -->
<div class="modal fade" id="createPromoModal" tabindex="-1" aria-labelledby="createPromoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-fullscreen-md-down">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title" id="createPromoModalLabel" style="color: white; font-weight: 600;">
          <i class="fas fa-plus-circle"></i> Створити промокод
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
      <div class="modal-body" style="padding: 2rem;">
        <form id="createPromoForm" class="needs-validation" novalidate>
          {% csrf_token %}
          
          <div class="row g-3">
            <!-- Код промокода -->
            <div class="col-md-6">
              <label for="promo_code" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-tag"></i> Код промокода
              </label>
              <input type="text" 
                     class="form-control" 
                     id="promo_code" 
                     name="code" 
                     placeholder="SALE2025 (залиште порожнім для автогенерації)" 
                     pattern="[A-Z0-9_-]+"
                     style="border: 1px solid var(--ds-border);">
              <div class="form-text" style="color: var(--ds-text-muted);">
                Тільки великі літери, цифри, дефіс та підкреслення
              </div>
              <div class="invalid-feedback">Введіть коректний код промокода</div>
            </div>

            <!-- Тип промокода -->
            <div class="col-md-6">
              <label for="promo_type" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-shapes"></i> Тип промокода
              </label>
              <select class="form-select" id="promo_type" name="promo_type" required style="border: 1px solid var(--ds-border);">
                <option value="regular">Звичайний промокод</option>
                <option value="auction">Аукціон/Реклама</option>
                <option value="voucher">Ваучер (фіксована сума)</option>
              </select>
              <div class="invalid-feedback">Оберіть тип промокода</div>
            </div>

            <!-- Знижка (%) -->
            <div class="col-md-6">
              <label for="promo_discount" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-percent"></i> Знижка (%)
              </label>
              <input type="number" 
                     class="form-control" 
                     id="promo_discount" 
                     name="discount" 
                     min="0" 
                     max="100" 
                     step="0.01"
                     placeholder="10"
                     style="border: 1px solid var(--ds-border);">
              <div class="invalid-feedback">Введіть знижку від 0 до 100</div>
            </div>

            <!-- Фіксована сума -->
            <div class="col-md-6">
              <label for="promo_fixed_amount" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-money-bill-wave"></i> Фіксована сума (₴)
              </label>
              <input type="number" 
                     class="form-control" 
                     id="promo_fixed_amount" 
                     name="fixed_amount" 
                     min="0" 
                     step="0.01"
                     placeholder="100"
                     style="border: 1px solid var(--ds-border);">
              <div class="form-text" style="color: var(--ds-text-muted);">
                Для ваучерів вказуйте фіксовану суму
              </div>
            </div>

            <!-- Група -->
            <div class="col-md-6">
              <label for="promo_group" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-layer-group"></i> Група
              </label>
              <select class="form-select" id="promo_group" name="group" style="border: 1px solid var(--ds-border);">
                <option value="">Без групи</option>
                {% for group in groups %}
                  <option value="{{ group.id }}">{{ group.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Мінімальна сума замовлення -->
            <div class="col-md-6">
              <label for="promo_min_order" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-shopping-cart"></i> Мінімальна сума замовлення (₴)
              </label>
              <input type="number" 
                     class="form-control" 
                     id="promo_min_order" 
                     name="min_order_amount" 
                     min="0" 
                     step="0.01"
                     placeholder="0"
                     style="border: 1px solid var(--ds-border);">
            </div>

            <!-- Кількість використань -->
            <div class="col-md-6">
              <label for="promo_uses" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-hashtag"></i> Кількість використань
              </label>
              <input type="number" 
                     class="form-control" 
                     id="promo_uses" 
                     name="usage_limit" 
                     min="0"
                     placeholder="0 (необмежено)"
                     style="border: 1px solid var(--ds-border);">
            </div>

            <!-- Один раз на користувача -->
            <div class="col-md-6">
              <div class="form-check" style="margin-top: 2rem;">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="promo_one_time" 
                       name="one_time_per_user"
                       style="border: 1px solid var(--ds-border);">
                <label class="form-check-label" for="promo_one_time" style="color: var(--ds-text);">
                  <i class="fas fa-user-check"></i> Один раз на користувача
                </label>
              </div>
            </div>

            <!-- Дата початку -->
            <div class="col-md-6">
              <label for="promo_valid_from" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-calendar-alt"></i> Діє з
              </label>
              <input type="datetime-local" 
                     class="form-control" 
                     id="promo_valid_from" 
                     name="valid_from"
                     style="border: 1px solid var(--ds-border);">
            </div>

            <!-- Дата закінчення -->
            <div class="col-md-6">
              <label for="promo_valid_until" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-calendar-times"></i> Діє до
              </label>
              <input type="datetime-local" 
                     class="form-control" 
                     id="promo_valid_until" 
                     name="valid_until"
                     style="border: 1px solid var(--ds-border);">
            </div>

            <!-- Опис -->
            <div class="col-12">
              <label for="promo_description" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-align-left"></i> Опис
              </label>
              <textarea class="form-control" 
                        id="promo_description" 
                        name="description" 
                        rows="3"
                        placeholder="Опис промокода для внутрішнього використання"
                        style="border: 1px solid var(--ds-border);"></textarea>
            </div>

            <!-- Активний -->
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="promo_is_active" 
                       name="is_active"
                       checked
                       style="border: 1px solid var(--ds-border);">
                <label class="form-check-label" for="promo_is_active" style="color: var(--ds-text);">
                  <i class="fas fa-check-circle"></i> Активний промокод
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); background: var(--ds-bg-soft);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="submit" form="createPromoForm" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
          <i class="fas fa-save"></i> Створити промокод
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Редагування промокода -->
<div class="modal fade" id="editPromoModal" tabindex="-1" aria-labelledby="editPromoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-fullscreen-md-down">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title" id="editPromoModalLabel" style="color: white; font-weight: 600;">
          <i class="fas fa-edit"></i> Редагувати промокод
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="editPromoModalBody" style="padding: 2rem;">
        <!-- Контент завантажується через AJAX -->
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Завантаження...</span>
          </div>
          <p class="mt-3" style="color: var(--ds-text-muted);">Завантаження даних промокода...</p>
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); background: var(--ds-bg-soft);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="submit" id="editPromoSubmitBtn" form="editPromoForm" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;" disabled>
          <i class="fas fa-save"></i> Зберегти зміни
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Створення групи -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h5 class="modal-title" id="createGroupModalLabel" style="color: white; font-weight: 600;">
          <i class="fas fa-plus-circle"></i> Створити групу промокодів
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 2rem;">
        <form id="createGroupForm" class="needs-validation" novalidate>
          {% csrf_token %}
          
          <!-- Назва групи -->
          <div class="mb-3">
            <label for="group_name" class="form-label" style="color: var(--ds-text); font-weight: 500;">
              <i class="fas fa-tag"></i> Назва групи
            </label>
            <input type="text" 
                   class="form-control" 
                   id="group_name" 
                   name="name" 
                   placeholder="Instagram Реклама"
                   required
                   style="border: 1px solid var(--ds-border);">
            <div class="invalid-feedback">Введіть назву групи</div>
          </div>

          <!-- Опис -->
          <div class="mb-3">
            <label for="group_description" class="form-label" style="color: var(--ds-text); font-weight: 500;">
              <i class="fas fa-align-left"></i> Опис
            </label>
            <textarea class="form-control" 
                      id="group_description" 
                      name="description" 
                      rows="3"
                      placeholder="Промокоди для рекламної кампанії в Instagram"
                      style="border: 1px solid var(--ds-border);"></textarea>
          </div>

          <!-- Один на аккаунт -->
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" 
                     type="checkbox" 
                     id="group_one_per_account" 
                     name="one_per_account"
                     style="border: 1px solid var(--ds-border);">
              <label class="form-check-label" for="group_one_per_account" style="color: var(--ds-text);">
                <i class="fas fa-user-lock"></i> Один промокод з групи на акаунт
              </label>
              <div class="form-text" style="color: var(--ds-text-muted);">
                Користувач зможе використати тільки один промокод з цієї групи
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); background: var(--ds-bg-soft);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="submit" form="createGroupForm" class="btn btn-primary" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none;">
          <i class="fas fa-save"></i> Створити групу
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Редагування групи -->
<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h5 class="modal-title" id="editGroupModalLabel" style="color: white; font-weight: 600;">
          <i class="fas fa-edit"></i> Редагувати групу
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="editGroupModalBody" style="padding: 2rem;">
        <!-- Контент завантажується через AJAX -->
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Завантаження...</span>
          </div>
          <p class="mt-3" style="color: var(--ds-text-muted);">Завантаження даних групи...</p>
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); background: var(--ds-bg-soft);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="submit" id="editGroupSubmitBtn" form="editGroupForm" class="btn btn-primary" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none;" disabled>
          <i class="fas fa-save"></i> Зберегти зміни
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
        <h5 class="modal-title" style="color: white; font-weight: 600;">
          <i class="fas fa-exclamation-triangle"></i> Підтвердження видалення
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 2rem;">
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <i class="fas fa-trash-alt" style="font-size: 3rem; color: #ef4444;"></i>
        </div>
        <p style="text-align: center; font-size: 1.1rem; margin-bottom: 0.5rem; font-weight: 600;" id="confirmDeleteTitle">
          Ви впевнені?
        </p>
        <p style="text-align: center; color: var(--ds-text-muted); margin-bottom: 1.5rem;" id="confirmDeleteMessage">
          Ця дія незворотна
        </p>
        <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444;">
          <strong style="color: #ef4444;">Увага!</strong> Після видалення відновити дані буде неможливо.
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); padding: 1rem 2rem;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 0.75rem 1.5rem;">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger" style="padding: 0.75rem 1.5rem;">
          <i class="fas fa-trash"></i> Так, видалити
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="promoToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="promoToastBody" style="color: white;">
        <!-- Повідомлення -->
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<style>
/* Background styling для всієї панелі */
.ds-shell {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  min-height: 100vh;
  position: relative;
}

.ds-shell::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.2) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.2) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.ds-shell > * {
  position: relative;
  z-index: 1;
}

.ds-container {
  background: transparent !important;
}

/* Sidebar glassmorphism */
.ds-sidebar {
  background: rgba(255, 255, 255, 0.1) !important;
  backdrop-filter: blur(20px);
  border-right: 1px solid rgba(255, 255, 255, 0.2);
}

/* Overview cards на градієнті */
.ds-overview-card {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
}

/* Stat cards */
.ds-stat-card, .ds-chart-card {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
}

/* Dark mode override */
body.dark-mode .ds-shell {
  background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%) !important;
}

body.dark-mode .ds-shell::before {
  background: 
    radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
}

body.dark-mode .ds-sidebar {
  background: rgba(26, 32, 44, 0.8) !important;
  border-right-color: rgba(255, 255, 255, 0.1);
}

body.dark-mode .ds-promo-card,
body.dark-mode .ds-group-card,
body.dark-mode .ds-stat-card,
body.dark-mode .ds-chart-card,
body.dark-mode .ds-overview-card {
  background: rgba(45, 55, 72, 0.95);
  border-color: rgba(255, 255, 255, 0.1);
}

/* Дополнительные стили для промокодов */
.ds-filters {
  margin: 2rem 0;
}

.ds-filter-pills {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.ds-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.6rem 1.2rem;
  background: var(--ds-bg-elevated);
  border: 1px solid var(--ds-border);
  border-radius: var(--ds-radius-sm);
  color: var(--ds-text-muted);
  text-decoration: none;
  font-weight: 500;
  transition: all var(--ds-transition);
}

.ds-pill:hover {
  border-color: var(--ds-border-strong);
  color: var(--ds-text);
  transform: translateY(-2px);
}

.ds-pill.is-active {
  background: var(--ds-primary);
  border-color: var(--ds-primary);
  color: white;
}

.ds-pill__count {
  padding: 0.2rem 0.5rem;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  font-size: 0.85rem;
}

.ds-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 1.5rem;
  margin: 2rem 0;
}

/* Промо карточка */
.ds-promo-card, .ds-group-card {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: var(--ds-radius-lg);
  padding: 1.5rem;
  backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
  transition: all var(--ds-transition);
}

.ds-promo-card:hover, .ds-group-card:hover {
  border-color: rgba(102, 126, 234, 0.5);
  transform: translateY(-4px);
  box-shadow: 0 12px 48px rgba(102, 126, 234, 0.3);
  background: rgba(255, 255, 255, 1);
}

.ds-promo-card.is-inactive, .ds-group-card.is-inactive {
  opacity: 0.6;
}

.ds-promo-card__header, .ds-group-card__header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
}

.ds-promo-card__code {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.ds-promo-card__code code {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--ds-primary);
  font-family: 'Courier New', monospace;
  padding: 0.25rem 0.5rem;
  background: rgba(139, 92, 246, 0.1);
  border-radius: 6px;
}

.ds-badge {
  padding: 0.3rem 0.75rem;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.ds-badge--voucher {
  background: rgba(249, 115, 22, 0.15);
  color: var(--ds-accent);
}

.ds-badge--grouped {
  background: rgba(59, 130, 246, 0.15);
  color: #3b82f6;
}

.ds-badge--info {
  background: rgba(16, 185, 129, 0.15);
  color: var(--ds-success);
}

.ds-status-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}

.ds-status-dot.is-active {
  background: var(--ds-success);
  box-shadow: 0 0 12px rgba(16, 185, 129, 0.5);
}

.ds-status-dot.is-inactive {
  background: var(--ds-danger);
  box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
}

.ds-promo-card__description, .ds-group-card__description {
  color: var(--ds-text-muted);
  font-size: 0.9rem;
  margin-bottom: 1rem;
  line-height: 1.6;
}

.ds-promo-card__stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.02);
  border-radius: var(--ds-radius-sm);
  margin-bottom: 1rem;
}

.ds-stat-item {
  text-align: center;
}

.ds-stat-item__label {
  font-size: 0.75rem;
  color: var(--ds-text-soft);
  margin-bottom: 0.25rem;
}

.ds-stat-item__value {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--ds-text);
}

.ds-promo-card__group {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 0.9rem;
  background: rgba(59, 130, 246, 0.1);
  color: #3b82f6;
  border-radius: var(--ds-radius-sm);
  font-size: 0.85rem;
  margin-bottom: 1rem;
}

.ds-promo-card__actions, .ds-group-card__actions {
  display: flex;
  gap: 0.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--ds-border);
}

.ds-action-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0.7rem;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid var(--ds-border);
  border-radius: var(--ds-radius-sm);
  color: var(--ds-text-muted);
  text-decoration: none;
  transition: all var(--ds-transition);
}

.ds-action-btn:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: var(--ds-border-strong);
  color: var(--ds-text);
  transform: translateY(-2px);
}

.ds-action-btn--edit:hover {
  background: rgba(16, 185, 129, 0.15);
  border-color: var(--ds-success);
  color: var(--ds-success);
}

.ds-action-btn--delete:hover {
  background: rgba(239, 68, 68, 0.15);
  border-color: var(--ds-danger);
  color: var(--ds-danger);
}

.ds-action-btn--view:hover {
  background: rgba(59, 130, 246, 0.15);
  border-color: #3b82f6;
  color: #3b82f6;
}

.ds-action-btn--toggle:hover {
  background: rgba(249, 115, 22, 0.15);
  border-color: var(--ds-accent);
  color: var(--ds-accent);
}

/* Группы */
.ds-group-card__title {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--ds-text);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.ds-group-card__metrics {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 1rem;
}

.ds-metric {
  text-align: center;
  padding: 0.75rem;
  background: rgba(255, 255, 255, 0.02);
  border-radius: var(--ds-radius-sm);
}

.ds-metric__value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--ds-text);
  line-height: 1;
}

.ds-metric__label {
  font-size: 0.75rem;
  color: var(--ds-text-soft);
  margin-top: 0.25rem;
}

/* Статистика */
.ds-stats-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin: 2rem 0;
}

.ds-overview-card {
  background: var(--ds-panel);
  border: 1px solid var(--ds-border);
  border-radius: var(--ds-radius-lg);
  padding: 2rem;
  text-align: center;
  backdrop-filter: blur(20px);
}

.ds-overview-card__icon {
  font-size: 2rem;
  color: var(--ds-primary);
  margin-bottom: 1rem;
}

.ds-overview-card__value {
  font-size: 3rem;
  font-weight: 700;
  color: var(--ds-text);
  line-height: 1;
}

.ds-overview-card__label {
  color: var(--ds-text-muted);
  margin-top: 0.5rem;
  font-size: 0.9rem;
}

.ds-overview-card__meta {
  color: var(--ds-text-muted);
  margin-top: 0.5rem;
  font-size: 0.8rem;
  opacity: 0.7;
}

/* Overview card variants */
.ds-overview-card--success {
  border-color: rgba(76, 175, 80, 0.3);
  background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(76, 175, 80, 0.1) 100%);
}

.ds-overview-card--success .ds-overview-card__icon {
  color: #4caf50;
}

.ds-overview-card--warning {
  border-color: rgba(255, 193, 7, 0.3);
  background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(255, 193, 7, 0.1) 100%);
}

.ds-overview-card--warning .ds-overview-card__icon {
  color: #ffc107;
}

/* Extended stats */
.ds-stats-extended {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.ds-stat-card {
  background: var(--ds-panel);
  border: 1px solid var(--ds-border);
  border-radius: var(--ds-radius-lg);
  padding: 1.5rem;
  backdrop-filter: blur(20px);
  transition: all 0.3s ease;
}

.ds-stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  border-color: var(--ds-primary);
}

.ds-stat-card--highlight {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
  border-color: var(--ds-primary);
}

.ds-stat-card__header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--ds-border);
}

.ds-stat-card__header i {
  color: var(--ds-primary);
  font-size: 1.2rem;
}

.ds-stat-card__header h3 {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--ds-text);
}

.ds-stat-card__body {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.ds-stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.ds-stat-row:last-child {
  border-bottom: none;
}

.ds-stat-row--large {
  padding: 0.75rem 0;
}

.ds-stat-row--muted {
  opacity: 0.7;
  font-size: 0.9rem;
}

.ds-stat-label {
  color: var(--ds-text-muted);
  font-size: 0.9rem;
}

.ds-stat-value {
  font-weight: 600;
  color: var(--ds-text);
  font-size: 1rem;
}

.ds-stat-row--large .ds-stat-value {
  font-size: 1.1rem;
  color: var(--ds-primary);
}

/* Charts */
.ds-charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.ds-chart-card {
  background: var(--ds-panel);
  border: 1px solid var(--ds-border);
  border-radius: var(--ds-radius-lg);
  padding: 1.5rem;
  backdrop-filter: blur(20px);
  transition: all 0.3s ease;
}

.ds-chart-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  border-color: var(--ds-primary);
}

.ds-chart-card__header {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--ds-border);
}

.ds-chart-card__header h3 {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--ds-text);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.ds-chart-card__header i {
  color: var(--ds-primary);
}

.ds-chart-card__subtitle {
  font-size: 0.85rem;
  color: var(--ds-text-muted);
  opacity: 0.7;
}

.ds-chart-card__body {
  position: relative;
  min-height: 250px;
}

.ds-chart-card__body canvas {
  width: 100% !important;
  height: 100% !important;
  max-height: 300px;
}

/* Адаптивність для графіків */
@media (max-width: 767.98px) {
  .ds-charts-grid {
    grid-template-columns: 1fr;
  }
  
  .ds-chart-card__body {
    min-height: 200px;
  }
}

/* Dark Mode Toggle */
.ds-dark-mode-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
  transition: all 0.3s ease;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.ds-dark-mode-toggle:hover {
  transform: scale(1.1) rotate(15deg);
  box-shadow: 0 6px 24px rgba(102, 126, 234, 0.6);
}

.ds-dark-mode-toggle:active {
  transform: scale(0.95);
}

/* Dark Mode Variables */
:root {
  --ds-bg: #f8f9fa;
  --ds-bg-soft: #f1f3f4;
  --ds-text: #1a202c;
  --ds-text-muted: #718096;
  --ds-card-bg: #ffffff;
  --ds-border: #e2e8f0;
  --ds-panel: rgba(255, 255, 255, 0.9);
  --ds-primary: #667eea;
  --ds-radius-lg: 16px;
}

body.dark-mode {
  --ds-bg: #1a202c;
  --ds-bg-soft: #2d3748;
  --ds-text: #f7fafc;
  --ds-text-muted: #a0aec0;
  --ds-card-bg: #2d3748;
  --ds-border: #4a5568;
  --ds-panel: rgba(45, 55, 72, 0.9);
}

body.dark-mode .ds-container {
  background: transparent !important;
}

body.dark-mode .ds-hero {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

body.dark-mode .modal-content {
  background: rgba(45, 55, 72, 0.98) !important;
  border-color: rgba(255, 255, 255, 0.1) !important;
  backdrop-filter: blur(20px);
}

body.dark-mode .form-control,
body.dark-mode .form-select,
body.dark-mode .ds-date-input {
  background: rgba(26, 32, 44, 0.8) !important;
  border-color: rgba(255, 255, 255, 0.1) !important;
  color: var(--ds-text) !important;
}

body.dark-mode .ds-dark-mode-toggle {
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
}

/* Search Box */
.ds-search-box {
  position: relative;
  margin-top: 1rem;
}

.ds-search-icon {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--ds-text-muted);
  font-size: 1rem;
}

.ds-search-input {
  width: 100%;
  padding: 0.75rem 3rem 0.75rem 3rem;
  border: 2px solid var(--ds-border);
  border-radius: 12px;
  background: var(--ds-card-bg);
  color: var(--ds-text);
  font-size: 0.95rem;
  transition: all 0.2s ease;
}

.ds-search-input:focus {
  outline: none;
  border-color: var(--ds-primary);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.ds-search-clear {
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--ds-text-muted);
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 50%;
  transition: all 0.2s ease;
}

.ds-search-clear:hover {
  background: var(--ds-bg-soft);
  color: var(--ds-text);
}

/* Highlight search results */
.promo-highlight {
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  color: white;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  font-weight: 600;
}

/* Sort Box */
.ds-sort-box {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-top: 1rem;
}

.ds-sort-label {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--ds-text);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 0;
}

.ds-sort-select {
  flex: 1;
  padding: 0.75rem 1rem;
  border: 2px solid var(--ds-border);
  border-radius: 8px;
  background: var(--ds-card-bg);
  color: var(--ds-text);
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.ds-sort-select:focus {
  outline: none;
  border-color: var(--ds-primary);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

@media (max-width: 767.98px) {
  .ds-sort-box {
    flex-direction: column;
    align-items: stretch;
  }
}

/* Fade-in animations */
.ds-fade-in-item {
  animation: fadeInUp 0.6s ease forwards;
  opacity: 0;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.ds-fade-in-grid .ds-fade-in-item:nth-child(1) { animation-delay: 0.05s; }
.ds-fade-in-grid .ds-fade-in-item:nth-child(2) { animation-delay: 0.1s; }
.ds-fade-in-grid .ds-fade-in-item:nth-child(3) { animation-delay: 0.15s; }
.ds-fade-in-grid .ds-fade-in-item:nth-child(4) { animation-delay: 0.2s; }
.ds-fade-in-grid .ds-fade-in-item:nth-child(5) { animation-delay: 0.25s; }
.ds-fade-in-grid .ds-fade-in-item:nth-child(6) { animation-delay: 0.3s; }
.ds-fade-in-grid .ds-fade-in-item:nth-child(n+7) { animation-delay: 0.35s; }

/* Smooth transitions */
.ds-promo-card,
.ds-group-card,
.ds-stat-card,
.ds-chart-card {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Export Actions */
.ds-export-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}

.ds-export-btn {
  padding: 0.75rem 1.5rem;
  border: 2px solid var(--ds-border);
  border-radius: 8px;
  background: var(--ds-card-bg);
  color: var(--ds-text);
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.ds-export-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.ds-export-btn--csv {
  border-color: #10b981;
  color: #10b981;
}

.ds-export-btn--csv:hover {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border-color: #10b981;
}

.ds-export-btn--excel {
  border-color: #3b82f6;
  color: #3b82f6;
}

.ds-export-btn--excel:hover {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color: white;
  border-color: #3b82f6;
}

.ds-export-btn--pdf {
  border-color: #ef4444;
  color: #ef4444;
}

.ds-export-btn--pdf:hover {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
  border-color: #ef4444;
}

@media (max-width: 767.98px) {
  .ds-export-actions {
    flex-direction: column;
  }
  
  .ds-export-btn {
    width: 100%;
    justify-content: center;
  }
}

/* Date Filters */
.ds-date-filters {
  margin-top: 1.5rem;
}

.ds-date-filter-pills {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.ds-date-pill {
  padding: 0.75rem 1.5rem;
  border: 2px solid var(--ds-border);
  border-radius: 12px;
  background: var(--ds-card-bg);
  color: var(--ds-text);
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  white-space: nowrap;
}

.ds-date-pill:hover {
  border-color: var(--ds-primary);
  background: var(--ds-bg-soft);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.ds-date-pill.is-active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: var(--ds-primary);
  color: white;
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
}

.ds-date-pill i {
  font-size: 1rem;
}

/* Custom Date Range */
.ds-custom-date-range {
  margin-top: 1rem;
  animation: slideDown 0.3s ease;
}

.ds-date-inputs {
  display: flex;
  gap: 1rem;
  align-items: flex-end;
  flex-wrap: wrap;
}

.ds-date-input-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.ds-date-input-group label {
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--ds-text-muted);
}

.ds-date-input {
  padding: 0.75rem 1rem;
  border: 2px solid var(--ds-border);
  border-radius: 8px;
  background: var(--ds-card-bg);
  color: var(--ds-text);
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s ease;
  min-width: 160px;
}

.ds-date-input:focus {
  outline: none;
  border-color: var(--ds-primary);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.ds-btn--apply {
  padding: 0.75rem 1.5rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.ds-btn--apply:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
}

.ds-btn--apply:active {
  transform: translateY(0);
}

/* Responsive для date filters */
@media (max-width: 767.98px) {
  .ds-date-filter-pills {
    flex-direction: column;
  }
  
  .ds-date-pill {
    width: 100%;
    justify-content: center;
  }
  
  .ds-date-inputs {
    flex-direction: column;
    width: 100%;
  }
  
  .ds-date-input-group {
    width: 100%;
  }
  
  .ds-date-input {
    width: 100%;
  }
  
  .ds-btn--apply {
    width: 100%;
    justify-content: center;
  }
}

.ds-section {
  background: var(--ds-panel);
  border: 1px solid var(--ds-border);
  border-radius: var(--ds-radius-lg);
  padding: 2rem;
  margin-bottom: 2rem;
  backdrop-filter: blur(20px);
}

.ds-section__title {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--ds-text);
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.ds-section__title i {
  color: var(--ds-primary);
}

.ds-leaderboard {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.ds-leader-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid var(--ds-border);
  border-radius: var(--ds-radius-sm);
  transition: all var(--ds-transition);
}

.ds-leader-item:hover {
  background: rgba(255, 255, 255, 0.04);
  border-color: var(--ds-border-strong);
  transform: translateX(4px);
}

.ds-leader-rank {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: var(--ds-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: white;
  flex-shrink: 0;
}

.ds-leader-item:nth-child(1) .ds-leader-rank {
  background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
  color: #000;
}

.ds-leader-item:nth-child(2) .ds-leader-rank {
  background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
  color: #000;
}

.ds-leader-item:nth-child(3) .ds-leader-rank {
  background: linear-gradient(135deg, #cd7f32 0%, #d4a574 100%);
}

.ds-leader-info {
  flex: 1;
}

.ds-leader-name {
  font-weight: 600;
  color: var(--ds-text);
}

.ds-leader-name code {
  background: rgba(139, 92, 246, 0.1);
  color: var(--ds-primary);
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
}

.ds-leader-meta {
  font-size: 0.85rem;
  color: var(--ds-text-soft);
  margin-top: 0.25rem;
}

.ds-leader-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--ds-text);
}

.ds-usage-log {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.ds-usage-row {
  display: grid;
  grid-template-columns: 150px 200px 150px 1fr;
  gap: 1rem;
  padding: 0.75rem 1rem;
  background: rgba(255, 255, 255, 0.02);
  border-radius: var(--ds-radius-sm);
  color: var(--ds-text-muted);
  font-size: 0.9rem;
  transition: all var(--ds-transition);
}

.ds-usage-row:hover {
  background: rgba(255, 255, 255, 0.04);
}

.ds-usage-code code {
  background: rgba(139, 92, 246, 0.1);
  color: var(--ds-primary);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
}

.ds-no-data {
  text-align: center;
  color: var(--ds-text-soft);
  padding: 2rem;
  font-style: italic;
}

/* Empty state */
.ds-empty-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 4rem 2rem;
  background: var(--ds-panel);
  border: 2px dashed var(--ds-border);
  border-radius: var(--ds-radius-lg);
}

.ds-empty-state__icon {
  opacity: 0.3;
  margin-bottom: 1.5rem;
  color: var(--ds-primary);
}

.ds-empty-state__title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--ds-text);
  margin-bottom: 0.5rem;
}

.ds-empty-state__text {
  color: var(--ds-text-muted);
  margin-bottom: 2rem;
}

/* Sidebar стили */
.ds-sidebar__stats {
  padding-top: 1.5rem;
  margin-top: auto;
  border-top: 1px solid var(--ds-border);
}

.ds-sidebar__stat {
  text-align: center;
  padding: 0.75rem;
}

.ds-sidebar__stat:not(:last-child) {
  margin-bottom: 0.5rem;
}

.ds-sidebar__stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--ds-text);
  line-height: 1;
}

.ds-sidebar__stat-label {
  font-size: 0.75rem;
  color: var(--ds-text-soft);
  margin-top: 0.25rem;
}

.ds-sidebar__badge {
  padding: 0.2rem 0.5rem;
  background: var(--ds-primary-soft);
  color: var(--ds-primary);
  border-radius: 8px;
  font-size: 0.75rem;
  margin-left: 0.5rem;
  font-weight: 600;
}

.ds-sidebar__link.is-active .ds-sidebar__badge {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

/* ==================== RESPONSIVE STYLES ==================== */

/* Mobile optimizations (< 768px) */
@media (max-width: 767.98px) {
  /* Модальні вікна - fullscreen на мобільних */
  .modal-fullscreen-md-down .modal-body {
    padding: 1rem !important;
  }
  
  .modal-fullscreen-md-down .modal-header,
  .modal-fullscreen-md-down .modal-footer {
    padding: 0.75rem 1rem !important;
  }
  
  .modal-fullscreen-md-down .modal-title {
    font-size: 1.1rem !important;
  }
  
  /* Форми в модалках */
  .modal-fullscreen-md-down .form-label {
    font-size: 0.9rem !important;
    margin-bottom: 0.3rem !important;
  }
  
  .modal-fullscreen-md-down .form-control,
  .modal-fullscreen-md-down .form-select {
    font-size: 0.95rem !important;
    padding: 0.5rem !important;
  }
  
  .modal-fullscreen-md-down .btn {
    padding: 0.6rem 1rem !important;
    font-size: 0.95rem !important;
  }
  
  /* Toast на мобільних - зверху по центру */
  .toast-container {
    top: 1rem !important;
    left: 50% !important;
    right: auto !important;
    transform: translateX(-50%) !important;
    width: 90% !important;
    max-width: 400px !important;
  }
  
  /* Sidebar та main content */
  .ds-sidebar {
    position: relative !important;
    width: 100% !important;
    min-height: auto !important;
  }
  
  .ds-main {
    padding: 1rem !important;
  }
  
  /* Promo cards на мобільних */
  .ds-promo-card {
    padding: 1rem !important;
  }
  
  .ds-promo-card__header {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 0.5rem !important;
  }
  
  .ds-promo-card__code {
    font-size: 1.1rem !important;
  }
  
  .ds-promo-card__actions {
    width: 100% !important;
    justify-content: space-around !important;
    margin-top: 0.5rem !important;
  }
  
  /* Hero section на мобільних */
  .ds-hero__title {
    font-size: 1.8rem !important;
  }
  
  .ds-hero__lead {
    font-size: 0.95rem !important;
  }
  
  /* Фільтри */
  .ds-filter-pills {
    flex-direction: column !important;
    gap: 0.5rem !important;
  }
  
  .ds-pill {
    width: 100% !important;
    justify-content: center !important;
  }
}

/* Tablet optimizations (768px - 991px) */
@media (min-width: 768px) and (max-width: 991.98px) {
  .modal-lg {
    max-width: 90% !important;
  }
  
  .ds-promo-card {
    padding: 1.25rem !important;
  }
  
  .ds-hero__title {
    font-size: 2rem !important;
  }
}

/* Large desktop optimizations (> 1200px) */
@media (min-width: 1200px) {
  .modal-lg {
    max-width: 900px !important;
  }
  
  .ds-container {
    max-width: 1400px !important;
  }
}

/* Small mobile (< 576px) - extra optimizations */
@media (max-width: 575.98px) {
  .modal-fullscreen-md-down .row.g-3 {
    gap: 0.75rem !important;
  }
  
  .modal-fullscreen-md-down .col-md-6 {
    padding: 0 !important;
  }
  
  .ds-action-btn {
    padding: 0.4rem !important;
    font-size: 0.9rem !important;
  }
  
  .ds-btn {
    width: 100% !important;
    margin-bottom: 0.5rem !important;
  }
  
  .ds-sidebar__nav {
    flex-direction: column !important;
  }
  
  .ds-sidebar__link {
    justify-content: flex-start !important;
    padding: 0.75rem !important;
  }
}

/* Print styles */
@media print {
  .modal,
  .toast-container,
  .ds-sidebar,
  .ds-actions {
    display: none !important;
  }
  
  .ds-main {
    padding: 0 !important;
  }
}

/* ==================== DRAG & DROP STYLES ==================== */

/* Промокод при перетягуванні */
.ds-promo-card[draggable="true"] {
  cursor: move;
  transition: all 0.2s ease;
}

.ds-promo-card[draggable="true"]:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.ds-promo-card.is-dragging {
  opacity: 0.4 !important;
  transform: scale(0.95);
  cursor: grabbing;
}

/* Drop zone highlight */
.promo-drop-zone {
  transition: all 0.3s ease;
  position: relative;
}

.promo-drop-zone.is-drag-over {
  transform: scale(1.05);
  box-shadow: 0 0 0 3px var(--ds-primary), 0 8px 24px rgba(102, 126, 234, 0.4);
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
}

.promo-drop-zone.is-drag-over::after {
  content: 'Відпустіть промокод тут';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--ds-primary);
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 12px;
  font-weight: 600;
  font-size: 0.9rem;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
  pointer-events: none;
  z-index: 10;
  white-space: nowrap;
}

/* Анімація успішного drop */
.drop-success {
  animation: dropSuccess 1s ease;
}

@keyframes dropSuccess {
  0% {
    transform: scale(1);
  }
  25% {
    transform: scale(1.1);
    box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.3);
  }
  50% {
    transform: scale(0.95);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
  }
}

/* Drag hint icon */
.ds-promo-card[draggable="true"]::before {
  content: '⋮⋮';
  position: absolute;
  left: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--ds-text-muted);
  font-size: 1.2rem;
  opacity: 0;
  transition: opacity 0.2s;
  pointer-events: none;
}

.ds-promo-card[draggable="true"]:hover::before {
  opacity: 0.5;
}

/* Mobile drag optimizations */
@media (max-width: 767.98px) {
  .ds-promo-card[draggable="true"]::before {
    opacity: 0.3;
  }
  
  .promo-drop-zone.is-drag-over::after {
    font-size: 0.8rem;
    padding: 0.5rem 1rem;
  }
}

/* ==================== GROUP COLOR INDICATORS ==================== */

/* Маркер кольору групи на картці промокода */
.promo-group-marker {
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  border-radius: 12px 0 0 12px;
  transition: all 0.3s ease;
  z-index: 1;
}

.ds-promo-card:hover .promo-group-marker {
  width: 6px;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
}

/* Маркер кольору на картці групи */
.group-color-marker {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 0.75rem;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.ds-group-card:hover .group-color-marker {
  transform: scale(1.3);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
}

/* Анімація pulse для активних груп */
@keyframes colorPulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.7;
    transform: scale(1.1);
  }
}

.ds-group-card.is-drag-over .group-color-marker {
  animation: colorPulse 1s infinite;
}

/* Підсвічування промокодів при hover на групі */
.ds-promo-card[data-group-id]:hover .promo-group-marker {
  animation: colorPulse 2s infinite;
}

/* Легенда кольорів (для майбутнього використання) */
.group-color-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin: 1rem 0;
  padding: 1rem;
  background: var(--ds-bg-soft);
  border-radius: 12px;
}

.group-color-legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: var(--ds-card-bg);
  border-radius: 8px;
  font-size: 0.85rem;
  color: var(--ds-text);
  transition: all 0.2s ease;
  cursor: pointer;
}

.group-color-legend-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.group-color-legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Адаптивність для маркерів */
@media (max-width: 767.98px) {
  .promo-group-marker {
    width: 3px;
  }
  
  .ds-promo-card:hover .promo-group-marker {
    width: 4px;
  }
  
  .group-color-marker {
    width: 6px;
    height: 6px;
  }
}

/* ==================== COUNTER ANIMATIONS ==================== */

/* Анімація оновлення лічильника */
@keyframes counterUpdate {
  0% {
    transform: scale(1);
    color: var(--ds-text);
  }
  50% {
    transform: scale(1.2);
    color: var(--ds-primary);
  }
  100% {
    transform: scale(1);
    color: var(--ds-text);
  }
}

/* Анімація pulse для badge */
@keyframes badgePulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.15);
    box-shadow: 0 0 12px var(--ds-primary);
  }
  100% {
    transform: scale(1);
  }
}

/* Підсвічування метрик при hover */
.ds-metric__value {
  transition: all 0.3s ease;
}

.ds-metric:hover .ds-metric__value {
  color: var(--ds-primary);
  transform: scale(1.1);
}

.ds-sidebar__badge {
  transition: all 0.3s ease;
}

/* ==================== GROUP FILTER ==================== */

.ds-group-filter {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-left: auto;
  padding: 0.5rem 1rem;
  background: var(--ds-card-bg);
  border-radius: 12px;
  border: 1px solid var(--ds-border);
}

.ds-group-filter__label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--ds-text);
  margin: 0;
  white-space: nowrap;
}

.ds-group-filter__label i {
  color: var(--ds-primary);
}

.ds-group-filter__select {
  padding: 0.5rem 2.5rem 0.5rem 1rem;
  border: 1px solid var(--ds-border);
  border-radius: 8px;
  background: var(--ds-bg-soft);
  color: var(--ds-text);
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  min-width: 200px;
}

.ds-group-filter__select:hover {
  border-color: var(--ds-primary);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.ds-group-filter__select:focus {
  outline: none;
  border-color: var(--ds-primary);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

.ds-group-filter__clear {
  padding: 0.5rem;
  border: none;
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
}

.ds-group-filter__clear:hover {
  background: #ef4444;
  color: white;
  transform: scale(1.1);
}

/* Промокоди фільтрації - приховані */
.ds-promo-card.is-filtered-out {
  display: none !important;
}

/* Індикатор кількості знайдених */
.ds-filter-results {
  margin-top: 1rem;
  padding: 0.75rem 1rem;
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
  border-radius: 12px;
  border-left: 4px solid var(--ds-primary);
  font-size: 0.9rem;
  color: var(--ds-text);
  font-weight: 500;
  display: none;
}

.ds-filter-results.is-active {
  display: block;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive для фільтра */
@media (max-width: 767.98px) {
  .ds-filters {
    flex-direction: column;
    gap: 1rem;
  }
  
  .ds-group-filter {
    width: 100%;
    margin-left: 0;
  }
  
  .ds-group-filter__select {
    flex: 1;
    min-width: auto;
  }
}

@media (max-width: 575.98px) {
  .ds-group-filter {
    flex-wrap: wrap;
  }
  
  .ds-group-filter__label {
    width: 100%;
  }
  
  .ds-group-filter__select {
    flex: 1;
  }
}
</style>

<script>
// ==================== ПРОМОКОДИ: AJAX & MODALS ====================

// Допоміжна функція: показати toast повідомлення
function showToast(message, type = 'success') {
  const toastEl = document.getElementById('promoToast');
  const toastBody = document.getElementById('promoToastBody');
  
  // Встановити колір залежно від типу
  const colors = {
    success: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    error: 'linear-gradient(135deg, #f5576c 0%, #c0392b 100%)',
    warning: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    info: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
  };
  
  toastEl.style.background = colors[type] || colors.success;
  toastBody.textContent = message;
  
  const toast = new bootstrap.Toast(toastEl, {
    animation: true,
    autohide: true,
    delay: 4000
  });
  toast.show();
}

// Допоміжна функція: отримати CSRF токен
function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// ==================== СТВОРЕННЯ ПРОМОКОДА ====================

document.getElementById('createPromoForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Валідація Bootstrap
  if (!this.checkValidity()) {
    e.stopPropagation();
    this.classList.add('was-validated');
    return;
  }
  
  const formData = new FormData(this);
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  
  // Показати індикатор завантаження
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Створення...';
  
  try {
    const response = await fetch('{% url "admin_promocode_create" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('✅ Промокод успішно створено!', 'success');
      
      // Закрити модалку
      const modal = bootstrap.Modal.getInstance(document.getElementById('createPromoModal'));
      modal.hide();
      
      // Очистити форму
      this.reset();
      this.classList.remove('was-validated');
      
      // Перезавантажити сторінку для оновлення списку
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      showToast('❌ Помилка: ' + (data.error || 'Невідома помилка'), 'error');
      
      // Показати помилки полів
      if (data.errors) {
        Object.keys(data.errors).forEach(field => {
          const input = this.querySelector(`[name="${field}"]`);
          if (input) {
            input.classList.add('is-invalid');
            const feedback = input.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
              feedback.textContent = data.errors[field][0];
            }
          }
        });
      }
    }
  } catch (error) {
    console.error('Помилка створення промокода:', error);
    showToast('❌ Помилка з\'єднання з сервером', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;
  }
});

// ==================== РЕДАГУВАННЯ ПРОМОКОДА ====================

async function openEditPromoModal(promoId) {
  const modal = new bootstrap.Modal(document.getElementById('editPromoModal'));
  const modalBody = document.getElementById('editPromoModalBody');
  const submitBtn = document.getElementById('editPromoSubmitBtn');
  
  // Показати skeleton loader
  modalBody.innerHTML = `
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Завантаження...</span>
      </div>
      <p class="mt-3" style="color: var(--ds-text-muted);">Завантаження даних промокода...</p>
    </div>
  `;
  
  submitBtn.disabled = true;
  modal.show();
  
  try {
    const response = await fetch(`/admin-panel/promocode/${promoId}/get-form/`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    if (!response.ok) throw new Error('Помилка завантаження');
    
    const data = await response.json();
    
    if (data.success) {
      // Заповнити форму даними
      modalBody.innerHTML = `
        <form id="editPromoForm" class="needs-validation" novalidate>
          ${document.querySelector('[name=csrfmiddlewaretoken]').outerHTML}
          <input type="hidden" name="promo_id" value="${promoId}">
          
          <div class="row g-3">
            <!-- Аналогічні поля як у createPromoForm -->
            <div class="col-md-6">
              <label for="edit_promo_code" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-tag"></i> Код промокода
              </label>
              <input type="text" class="form-control" id="edit_promo_code" name="code" 
                     value="${data.promo.code || ''}" pattern="[A-Z0-9_-]+" required
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_type" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-shapes"></i> Тип промокода
              </label>
              <select class="form-select" id="edit_promo_type" name="promo_type" required style="border: 1px solid var(--ds-border);">
                <option value="regular" ${data.promo.promo_type === 'regular' ? 'selected' : ''}>Звичайний промокод</option>
                <option value="auction" ${data.promo.promo_type === 'auction' ? 'selected' : ''}>Аукціон/Реклама</option>
                <option value="voucher" ${data.promo.promo_type === 'voucher' ? 'selected' : ''}>Ваучер</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_discount" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-percent"></i> Знижка (%)
              </label>
              <input type="number" class="form-control" id="edit_promo_discount" name="discount" 
                     value="${data.promo.discount || ''}" min="0" max="100" step="0.01"
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_fixed_amount" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-money-bill-wave"></i> Фіксована сума (₴)
              </label>
              <input type="number" class="form-control" id="edit_promo_fixed_amount" name="fixed_amount" 
                     value="${data.promo.fixed_amount || ''}" min="0" step="0.01"
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_group" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-layer-group"></i> Група
              </label>
              <select class="form-select" id="edit_promo_group" name="group" style="border: 1px solid var(--ds-border);">
                <option value="">Без групи</option>
                ${data.groups.map(g => `<option value="${g.id}" ${g.id === data.promo.group_id ? 'selected' : ''}>${g.name}</option>`).join('')}
              </select>
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_min_order" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-shopping-cart"></i> Мінімальна сума замовлення (₴)
              </label>
              <input type="number" class="form-control" id="edit_promo_min_order" name="min_order_amount" 
                     value="${data.promo.min_order_amount || ''}" min="0" step="0.01"
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_uses" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-hashtag"></i> Кількість використань
              </label>
              <input type="number" class="form-control" id="edit_promo_uses" name="usage_limit" 
                     value="${data.promo.usage_limit || ''}" min="0"
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <div class="form-check" style="margin-top: 2rem;">
                <input class="form-check-input" type="checkbox" id="edit_promo_one_time" name="one_time_per_user"
                       ${data.promo.one_time_per_user ? 'checked' : ''} style="border: 1px solid var(--ds-border);">
                <label class="form-check-label" for="edit_promo_one_time" style="color: var(--ds-text);">
                  <i class="fas fa-user-check"></i> Один раз на користувача
                </label>
              </div>
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_valid_from" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-calendar-alt"></i> Діє з
              </label>
              <input type="datetime-local" class="form-control" id="edit_promo_valid_from" name="valid_from"
                     value="${data.promo.valid_from || ''}" style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_valid_until" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-calendar-times"></i> Діє до
              </label>
              <input type="datetime-local" class="form-control" id="edit_promo_valid_until" name="valid_until"
                     value="${data.promo.valid_until || ''}" style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-12">
              <label for="edit_promo_description" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-align-left"></i> Опис
              </label>
              <textarea class="form-control" id="edit_promo_description" name="description" rows="3"
                        style="border: 1px solid var(--ds-border);">${data.promo.description || ''}</textarea>
            </div>
            
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="edit_promo_is_active" name="is_active"
                       ${data.promo.is_active ? 'checked' : ''} style="border: 1px solid var(--ds-border);">
                <label class="form-check-label" for="edit_promo_is_active" style="color: var(--ds-text);">
                  <i class="fas fa-check-circle"></i> Активний промокод
                </label>
              </div>
            </div>
          </div>
        </form>
      `;
      
      submitBtn.disabled = false;
      
      // Додати обробник submit для editPromoForm
      document.getElementById('editPromoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
          e.stopPropagation();
          this.classList.add('was-validated');
          return;
        }
        
        const formData = new FormData(this);
        submitBtn.disabled = true;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Збереження...';
        
        try {
          const response = await fetch(`/admin-panel/promocode/${promoId}/edit-ajax/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCSRFToken(),
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            showToast('✅ Промокод успішно оновлено!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPromoModal'));
            modal.hide();
            setTimeout(() => window.location.reload(), 1000);
          } else {
            showToast('❌ Помилка: ' + (result.error || 'Невідома помилка'), 'error');
          }
        } catch (error) {
          console.error('Помилка оновлення промокода:', error);
          showToast('❌ Помилка з\'єднання', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });
      
    } else {
      throw new Error(data.error || 'Помилка завантаження даних');
    }
  } catch (error) {
    console.error('Помилка завантаження форми:', error);
    modalBody.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> Помилка завантаження даних промокода
      </div>
    `;
    showToast('❌ Не вдалося завантажити дані', 'error');
  }
}

// ==================== СТВОРЕННЯ ГРУПИ ====================

document.getElementById('createGroupForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!this.checkValidity()) {
    e.stopPropagation();
    this.classList.add('was-validated');
    return;
  }
  
  const formData = new FormData(this);
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Створення...';
  
  try {
    const response = await fetch('{% url "admin_promo_group_create" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('✅ Групу успішно створено!', 'success');
      const modal = bootstrap.Modal.getInstance(document.getElementById('createGroupModal'));
      modal.hide();
      this.reset();
      this.classList.remove('was-validated');
      setTimeout(() => window.location.reload(), 1000);
    } else {
      showToast('❌ Помилка: ' + (data.error || 'Невідома помилка'), 'error');
    }
  } catch (error) {
    console.error('Помилка створення групи:', error);
    showToast('❌ Помилка з\'єднання з сервером', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;
  }
});

// ==================== РЕДАГУВАННЯ ГРУПИ ====================

async function openEditGroupModal(groupId) {
  const modal = new bootstrap.Modal(document.getElementById('editGroupModal'));
  const modalBody = document.getElementById('editGroupModalBody');
  const submitBtn = document.getElementById('editGroupSubmitBtn');
  
  modalBody.innerHTML = `
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Завантаження...</span>
      </div>
      <p class="mt-3" style="color: var(--ds-text-muted);">Завантаження даних групи...</p>
    </div>
  `;
  
  submitBtn.disabled = true;
  modal.show();
  
  try {
    const response = await fetch(`/admin-panel/promo-group/${groupId}/get-form/`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    if (!response.ok) throw new Error('Помилка завантаження');
    
    const data = await response.json();
    
    if (data.success) {
      modalBody.innerHTML = `
        <form id="editGroupForm" class="needs-validation" novalidate>
          ${document.querySelector('[name=csrfmiddlewaretoken]').outerHTML}
          <input type="hidden" name="group_id" value="${groupId}">
          
          <div class="mb-3">
            <label for="edit_group_name" class="form-label" style="color: var(--ds-text); font-weight: 500;">
              <i class="fas fa-tag"></i> Назва групи
            </label>
            <input type="text" class="form-control" id="edit_group_name" name="name" 
                   value="${data.group.name || ''}" required style="border: 1px solid var(--ds-border);">
            <div class="invalid-feedback">Введіть назву групи</div>
          </div>
          
          <div class="mb-3">
            <label for="edit_group_description" class="form-label" style="color: var(--ds-text); font-weight: 500;">
              <i class="fas fa-align-left"></i> Опис
            </label>
            <textarea class="form-control" id="edit_group_description" name="description" rows="3"
                      style="border: 1px solid var(--ds-border);">${data.group.description || ''}</textarea>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="edit_group_one_per_account" name="one_per_account"
                     ${data.group.one_per_account ? 'checked' : ''} style="border: 1px solid var(--ds-border);">
              <label class="form-check-label" for="edit_group_one_per_account" style="color: var(--ds-text);">
                <i class="fas fa-user-lock"></i> Один промокод з групи на акаунт
              </label>
              <div class="form-text" style="color: var(--ds-text-muted);">
                Користувач зможе використати тільки один промокод з цієї групи
              </div>
            </div>
          </div>
          
          ${data.promocodes.length > 0 ? `
            <div class="mb-3">
              <label class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-list"></i> Промокоди в групі (${data.promocodes.length})
              </label>
              <div class="list-group">
                ${data.promocodes.map(p => `
                  <div class="list-group-item d-flex justify-content-between align-items-center" 
                       style="background: var(--ds-bg-soft); border: 1px solid var(--ds-border);">
                    <div>
                      <strong style="color: var(--ds-primary);">${p.code}</strong>
                      <span class="badge ${p.is_active ? 'bg-success' : 'bg-secondary'} ms-2">
                        ${p.is_active ? 'Активний' : 'Неактивний'}
                      </span>
                    </div>
                    <small style="color: var(--ds-text-muted);">
                      Використань: ${p.times_used}${p.usage_limit ? '/' + p.usage_limit : ''}
                    </small>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : '<p style="color: var(--ds-text-muted);"><i>Немає промокодів у цій групі</i></p>'}
        </form>
      `;
      
      submitBtn.disabled = false;
      
      document.getElementById('editGroupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
          e.stopPropagation();
          this.classList.add('was-validated');
          return;
        }
        
        const formData = new FormData(this);
        submitBtn.disabled = true;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Збереження...';
        
        try {
          const response = await fetch(`/admin-panel/promo-group/${groupId}/edit-ajax/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCSRFToken(),
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            showToast('✅ Групу успішно оновлено!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editGroupModal'));
            modal.hide();
            setTimeout(() => window.location.reload(), 1000);
          } else {
            showToast('❌ Помилка: ' + (result.error || 'Невідома помилка'), 'error');
          }
        } catch (error) {
          console.error('Помилка оновлення групи:', error);
          showToast('❌ Помилка з\'єднання', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });
      
    } else {
      throw new Error(data.error || 'Помилка завантаження даних');
    }
  } catch (error) {
    console.error('Помилка завантаження форми групи:', error);
    modalBody.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> Помилка завантаження даних групи
      </div>
    `;
    showToast('❌ Не вдалося завантажити дані', 'error');
  }
}

// ==================== ОЧИЩЕННЯ ФОРМ ПРИ ЗАКРИТТІ МОДАЛОК ====================

document.getElementById('createPromoModal').addEventListener('hidden.bs.modal', function () {
  const form = document.getElementById('createPromoForm');
  form.reset();
  form.classList.remove('was-validated');
});

document.getElementById('createGroupModal').addEventListener('hidden.bs.modal', function () {
  const form = document.getElementById('createGroupForm');
  form.reset();
  form.classList.remove('was-validated');
});

// ==================== DRAG & DROP ПРОМОКОДІВ ====================

let draggedPromoId = null;
let draggedPromoEl = null;

function handlePromoDragStart(event) {
  draggedPromoId = event.target.dataset.promoId;
  draggedPromoEl = event.target;
  
  event.target.style.opacity = '0.4';
  event.target.classList.add('is-dragging');
  
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/html', event.target.innerHTML);
  
  console.log('Drag start:', draggedPromoId);
}

function handlePromoDragEnd(event) {
  event.target.style.opacity = '1';
  event.target.classList.remove('is-dragging');
  
  // Прибрати highlight з усіх drop zones
  document.querySelectorAll('.promo-drop-zone').forEach(zone => {
    zone.classList.remove('is-drag-over');
  });
}

function handleGroupDragOver(event) {
  if (event.preventDefault) {
    event.preventDefault(); // Дозволяє drop
  }
  
  event.dataTransfer.dropEffect = 'move';
  event.currentTarget.classList.add('is-drag-over');
  
  return false;
}

function handleGroupDragLeave(event) {
  event.currentTarget.classList.remove('is-drag-over');
}

async function handleGroupDrop(event) {
  if (event.stopPropagation) {
    event.stopPropagation(); // Зупиняємо поширення події
  }
  
  event.preventDefault();
  event.currentTarget.classList.remove('is-drag-over');
  
  const targetGroupId = event.currentTarget.dataset.groupId;
  const currentGroupId = draggedPromoEl.dataset.groupId;
  
  // Якщо промокод вже в цій групі - нічого не робимо
  if (targetGroupId === currentGroupId) {
    showToast('Промокод вже в цій групі', 'info');
    return false;
  }
  
  console.log(`Moving promo ${draggedPromoId} to group ${targetGroupId}`);
  
  try {
    const response = await fetch(`/admin-panel/promocode/${draggedPromoId}/change-group/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        group_id: targetGroupId
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast(`✅ Промокод переміщено до групи "${data.group_name}"`, 'success');
      
      // Оновити групу в DOM
      draggedPromoEl.dataset.groupId = targetGroupId;
      
      // Оновити кольоровий маркер
      const oldMarker = draggedPromoEl.querySelector('.promo-group-marker');
      if (oldMarker) {
        oldMarker.remove();
      }
      
      const newColor = getGroupColor(parseInt(targetGroupId));
      const newMarker = document.createElement('div');
      newMarker.className = 'promo-group-marker';
      newMarker.style.background = newColor;
      newMarker.title = 'Група: ' + data.group_name;
      draggedPromoEl.prepend(newMarker);
      
      // Оновити відображення групи в картці промокода
      const groupEl = draggedPromoEl.querySelector('.ds-promo-card__group');
      if (groupEl) {
        groupEl.innerHTML = `
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3z"/>
          </svg>
          ${data.group_name}
        `;
      } else if (data.group_name) {
        // Додати елемент групи якщо його не було
        const actionsEl = draggedPromoEl.querySelector('.ds-promo-card__actions');
        if (actionsEl) {
          const groupHtml = `
            <div class="ds-promo-card__group">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3z"/>
              </svg>
              ${data.group_name}
            </div>
          `;
          actionsEl.insertAdjacentHTML('beforebegin', groupHtml);
        }
      }
      
      // Оновити лічильник промокодів в групі
      updateGroupCounter(targetGroupId);
      if (currentGroupId && currentGroupId !== '') {
        updateGroupCounter(currentGroupId);
      }
      
      // Анімація успіху
      draggedPromoEl.classList.add('drop-success');
      setTimeout(() => {
        draggedPromoEl.classList.remove('drop-success');
      }, 1000);
      
    } else {
      showToast(`❌ Помилка: ${data.error}`, 'error');
    }
  } catch (error) {
    console.error('Error moving promo:', error);
    showToast('❌ Помилка переміщення промокода', 'error');
  }
  
  return false;
}

// ==================== ВІЗУАЛЬНА ІНДИКАЦІЯ ГРУП ====================

// Генерація кольору на основі ID групи (детермінований)
function getGroupColor(groupId) {
  const colors = [
    '#667eea', // Purple
    '#f093fb', // Pink
    '#4facfe', // Blue
    '#43e97b', // Green
    '#fa709a', // Rose
    '#feca57', // Yellow
    '#ff6b6b', // Red
    '#4ecdc4', // Teal
    '#a29bfe', // Lavender
    '#fd79a8', // Hot Pink
    '#fdcb6e', // Orange
    '#00b894', // Emerald
  ];
  
  return colors[groupId % colors.length];
}

// Застосувати кольори до груп та промокодів
function applyGroupColors() {
  // Додати кольорові індикатори до group cards
  document.querySelectorAll('.ds-group-card[data-group-id]').forEach(card => {
    const groupId = parseInt(card.dataset.groupId);
    const color = getGroupColor(groupId);
    
    // Додати кольоровий маркер
    if (!card.querySelector('.group-color-marker')) {
      const marker = document.createElement('div');
      marker.className = 'group-color-marker';
      marker.style.background = color;
      card.querySelector('.ds-group-card__header').prepend(marker);
    }
  });
  
  // Додати кольорові маркери до promo cards
  document.querySelectorAll('.ds-promo-card[data-group-id]').forEach(card => {
    const groupId = card.dataset.groupId;
    if (groupId && groupId !== '') {
      const color = getGroupColor(parseInt(groupId));
      
      // Додати кольоровий маркер якщо його ще немає
      if (!card.querySelector('.promo-group-marker')) {
        const marker = document.createElement('div');
        marker.className = 'promo-group-marker';
        marker.style.background = color;
        marker.title = 'Група: ' + (card.querySelector('.ds-promo-card__group')?.textContent.trim() || '');
        card.prepend(marker);
      }
    }
  });
}

// Ініціалізувати кольори при завантаженні
document.addEventListener('DOMContentLoaded', applyGroupColors);

// ==================== ЛІЧИЛЬНИК ПРОМОКОДІВ В ГРУПІ ====================

// Оновити лічильник промокодів в групі реального часу
function updateGroupCounter(groupId) {
  const groupCard = document.querySelector(`.ds-group-card[data-group-id="${groupId}"]`);
  if (!groupCard) return;
  
  // Порахувати промокоди в цій групі
  const totalPromos = document.querySelectorAll(`.ds-promo-card[data-group-id="${groupId}"]`).length;
  const activePromos = document.querySelectorAll(`.ds-promo-card[data-group-id="${groupId}"]:not(.is-inactive)`).length;
  
  // Оновити відображення
  const totalCounter = groupCard.querySelector('.ds-metric:first-child .ds-metric__value');
  const activeCounter = groupCard.querySelector('.ds-metric:nth-child(2) .ds-metric__value');
  
  if (totalCounter) {
    const oldValue = parseInt(totalCounter.textContent);
    totalCounter.textContent = totalPromos;
    
    // Анімація при зміні
    if (oldValue !== totalPromos) {
      totalCounter.style.animation = 'none';
      setTimeout(() => {
        totalCounter.style.animation = 'counterUpdate 0.5s ease';
      }, 10);
    }
  }
  
  if (activeCounter) {
    const oldValue = parseInt(activeCounter.textContent);
    activeCounter.textContent = activePromos;
    
    // Анімація при зміні
    if (oldValue !== activePromos) {
      activeCounter.style.animation = 'none';
      setTimeout(() => {
        activeCounter.style.animation = 'counterUpdate 0.5s ease';
      }, 10);
    }
  }
  
  // Оновити badge в sidebar з загальною кількістю
  updateSidebarBadges();
}

// Оновити badges в sidebar
function updateSidebarBadges() {
  const totalPromos = document.querySelectorAll('.ds-promo-card').length;
  const totalGroups = document.querySelectorAll('.ds-group-card').length;
  
  const promosBadge = document.querySelector('.ds-sidebar__link[href*="tab=promocodes"] .ds-sidebar__badge');
  const groupsBadge = document.querySelector('.ds-sidebar__link[href*="tab=groups"] .ds-sidebar__badge');
  
  if (promosBadge) {
    promosBadge.textContent = totalPromos;
    promosBadge.style.animation = 'badgePulse 0.5s ease';
  }
  
  if (groupsBadge) {
    groupsBadge.textContent = totalGroups;
  }
}

// ==================== ФІЛЬТР ПО ГРУПАХ ====================

const groupFilterSelect = document.getElementById('groupFilter');
const clearGroupFilterBtn = document.getElementById('clearGroupFilter');

if (groupFilterSelect) {
  // Фільтрація промокодів
  groupFilterSelect.addEventListener('change', function() {
    const selectedGroup = this.value;
    const promoCards = document.querySelectorAll('.ds-promo-card');
    let visibleCount = 0;
    
    promoCards.forEach(card => {
      const cardGroupId = card.dataset.groupId;
      
      if (selectedGroup === '') {
        // Показати всі
        card.classList.remove('is-filtered-out');
        visibleCount++;
      } else if (selectedGroup === 'no-group') {
        // Показати тільки без групи
        if (!cardGroupId || cardGroupId === '') {
          card.classList.remove('is-filtered-out');
          visibleCount++;
        } else {
          card.classList.add('is-filtered-out');
        }
      } else {
        // Показати тільки з вибраною групою
        if (cardGroupId === selectedGroup) {
          card.classList.remove('is-filtered-out');
          visibleCount++;
        } else {
          card.classList.add('is-filtered-out');
        }
      }
    });
    
    // Показати/приховати кнопку очищення
    if (selectedGroup !== '') {
      clearGroupFilterBtn.style.display = 'flex';
      
      // Показати результати фільтрації
      showFilterResults(visibleCount, promoCards.length, selectedGroup);
    } else {
      clearGroupFilterBtn.style.display = 'none';
      hideFilterResults();
    }
    
    // Анімація для видимих карток
    document.querySelectorAll('.ds-promo-card:not(.is-filtered-out)').forEach((card, index) => {
      card.style.animation = 'none';
      setTimeout(() => {
        card.style.animation = `fadeIn 0.3s ease ${index * 0.05}s both`;
      }, 10);
    });
  });
  
  // Очистити фільтр
  if (clearGroupFilterBtn) {
    clearGroupFilterBtn.addEventListener('click', function() {
      groupFilterSelect.value = '';
      groupFilterSelect.dispatchEvent(new Event('change'));
    });
  }
}

// Показати результати фільтрації
function showFilterResults(visible, total, groupValue) {
  let resultsDiv = document.querySelector('.ds-filter-results');
  
  if (!resultsDiv) {
    resultsDiv = document.createElement('div');
    resultsDiv.className = 'ds-filter-results';
    document.querySelector('.ds-filters').after(resultsDiv);
  }
  
  const groupName = groupValue === 'no-group' 
    ? 'Без групи' 
    : document.querySelector(`#groupFilter option[value="${groupValue}"]`)?.textContent || '';
  
  resultsDiv.innerHTML = `
    <i class="fas fa-filter"></i> 
    Фільтр активний: <strong>${groupName}</strong> 
    <span style="margin-left: 0.5rem; opacity: 0.7;">
      (знайдено ${visible} з ${total})
    </span>
  `;
  resultsDiv.classList.add('is-active');
}

// Приховати результати фільтрації
function hideFilterResults() {
  const resultsDiv = document.querySelector('.ds-filter-results');
  if (resultsDiv) {
    resultsDiv.classList.remove('is-active');
  }
}

// Додати fade-in анімацію
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;
document.head.appendChild(style);

console.log('✅ Promo Modals & AJAX initialized successfully!');
console.log('✅ Drag & Drop functionality enabled!');
console.log('✅ Group color indicators applied!');
console.log('✅ Real-time group counters active!');
console.log('✅ Group filter ready!');
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ==================== ГРАФІКИ CHART.JS ====================

// Конфігурація кольорів
const chartColors = {
  primary: 'rgb(102, 126, 234)',
  secondary: 'rgb(118, 75, 162)',
  success: 'rgb(76, 175, 80)',
  warning: 'rgb(255, 193, 7)',
  danger: 'rgb(239, 68, 68)',
  info: 'rgb(79, 172, 254)',
};

// Градієнти
function createGradient(ctx, color1, color2) {
  const gradient = ctx.createLinearGradient(0, 0, 0, 300);
  gradient.addColorStop(0, color1);
  gradient.addColorStop(1, color2);
  return gradient;
}

// Перевірка чи є секція Statistics активною
const isStatsTab = document.querySelector('.ds-charts-grid');

if (isStatsTab) {
  // ===== 1. LINE CHART: Використання по датах =====
  const usageLineCtx = document.getElementById('usageLineChart');
  if (usageLineCtx) {
    // Генеруємо дані для останніх 30 днів
    const last30Days = [];
    const usageData = [];
    const today = new Date();
    
    for (let i = 29; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      last30Days.push(date.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' }));
      // Тут має бути реальна статистика з backend
      usageData.push(Math.floor(Math.random() * 20) + 5);
    }
    
    const gradient = createGradient(usageLineCtx.getContext('2d'), 'rgba(102, 126, 234, 0.5)', 'rgba(102, 126, 234, 0.1)');
    
    new Chart(usageLineCtx, {
      type: 'line',
      data: {
        labels: last30Days,
        datasets: [{
          label: 'Використання',
          data: usageData,
          borderColor: chartColors.primary,
          backgroundColor: gradient,
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: chartColors.primary,
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleColor: '#fff',
            bodyColor: '#fff',
            cornerRadius: 8,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)',
            },
            ticks: {
              precision: 0
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  }
  
  // ===== 2. BAR CHART: TOP-10 промокодів =====
  const topPromosBarCtx = document.getElementById('topPromosBarChart');
  if (topPromosBarCtx) {
    // Дані з backend (top_promos)
    const topPromoLabels = [
      {% for promo in top_promos %}
        '{{ promo.code }}'{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    
    const topPromoValues = [
      {% for promo in top_promos %}
        {{ promo.usage_count }}{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    
    // Генеруємо кольори для кожного промокода
    const barColors = topPromoLabels.map((_, index) => {
      const colors = [
        chartColors.primary,
        chartColors.secondary,
        chartColors.success,
        chartColors.info,
        chartColors.warning,
      ];
      return colors[index % colors.length];
    });
    
    new Chart(topPromosBarCtx, {
      type: 'bar',
      data: {
        labels: topPromoLabels,
        datasets: [{
          label: 'Використань',
          data: topPromoValues,
          backgroundColor: barColors.map(c => c + '80'),
          borderColor: barColors,
          borderWidth: 2,
          borderRadius: 8,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            cornerRadius: 8,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)',
            },
            ticks: {
              precision: 0
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  }
  
  // ===== 3. PIE CHART: Розподіл по групах =====
  const groupsPieCtx = document.getElementById('groupsPieChart');
  if (groupsPieCtx) {
    // Дані з backend (top_groups)
    const groupLabels = [
      {% for group in top_groups %}
        '{{ group.name }}'{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    
    const groupValues = [
      {% for group in top_groups %}
        {{ group.usage_count }}{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    
    // Генеруємо 12 кольорів (як в групах)
    const pieColors = groupLabels.map((_, index) => {
      return getGroupColor(index + 1);
    });
    
    new Chart(groupsPieCtx, {
      type: 'doughnut',
      data: {
        labels: groupLabels,
        datasets: [{
          data: groupValues,
          backgroundColor: pieColors.map(c => c + '80'),
          borderColor: pieColors,
          borderWidth: 2,
          hoverOffset: 10,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              usePointStyle: true,
              pointStyle: 'circle',
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return ` ${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }
  
  console.log('✅ Chart.js graphs initialized!');
}

// ==================== ФІЛЬТРИ ПО ДАТАХ ====================

const datePills = document.querySelectorAll('.ds-date-pill');
const customDateRange = document.getElementById('customDateRange');
const dateFromInput = document.getElementById('dateFrom');
const dateToInput = document.getElementById('dateTo');
const applyCustomDatesBtn = document.getElementById('applyCustomDates');

let currentPeriod = 'all';
let customDates = null;

// Обробка кліків на date pills
datePills.forEach(pill => {
  pill.addEventListener('click', function() {
    // Деактивувати всі pills
    datePills.forEach(p => p.classList.remove('is-active'));
    
    // Активувати поточний
    this.classList.add('is-active');
    
    const period = this.dataset.period;
    currentPeriod = period;
    
    // Показати/приховати custom date range
    if (period === 'custom') {
      customDateRange.style.display = 'block';
      
      // Встановити дефолтні дати (поточний місяць)
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      
      dateFromInput.valueAsDate = firstDay;
      dateToInput.valueAsDate = today;
    } else {
      customDateRange.style.display = 'none';
      customDates = null;
      
      // Застосувати фільтр
      applyDateFilter(period);
    }
  });
});

// Застосувати custom dates
if (applyCustomDatesBtn) {
  applyCustomDatesBtn.addEventListener('click', function() {
    const dateFrom = dateFromInput.value;
    const dateTo = dateToInput.value;
    
    if (!dateFrom || !dateTo) {
      showToast('Будь ласка, оберіть обидві дати', 'warning');
      return;
    }
    
    if (new Date(dateFrom) > new Date(dateTo)) {
      showToast('Дата початку не може бути пізніше дати кінця', 'error');
      return;
    }
    
    customDates = { from: dateFrom, to: dateTo };
    applyDateFilter('custom', customDates);
    
    showToast(`Фільтр застосовано: ${formatDate(dateFrom)} - ${formatDate(dateTo)}`, 'success');
  });
}

// Функція застосування фільтра
function applyDateFilter(period, customDates = null) {
  console.log(`Applying date filter: ${period}`, customDates);
  
  // Тут має бути AJAX запит на backend для отримання відфільтрованих даних
  // Поки що просто оновлюємо графіки з наявними даними
  
  // Приклад: фільтрувати дані по періоду
  const { startDate, endDate } = getDateRange(period, customDates);
  
  console.log(`Date range: ${startDate} - ${endDate}`);
  
  // Показати індикатор активного фільтра
  showActiveFilterIndicator(period, customDates);
  
  // TODO: Оновити графіки з новими даними
  // refreshCharts(startDate, endDate);
}

// Отримати діапазон дат для періоду
function getDateRange(period, customDates = null) {
  const today = new Date();
  let startDate, endDate = today;
  
  switch (period) {
    case 'today':
      startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      break;
    case 'week':
      startDate = new Date(today);
      startDate.setDate(today.getDate() - 7);
      break;
    case 'month':
      startDate = new Date(today);
      startDate.setMonth(today.getMonth() - 1);
      break;
    case 'custom':
      if (customDates) {
        startDate = new Date(customDates.from);
        endDate = new Date(customDates.to);
      }
      break;
    default: // 'all'
      startDate = new Date(0); // Unix epoch
      break;
  }
  
  return { startDate, endDate };
}

// Показати індикатор активного фільтра
function showActiveFilterIndicator(period, customDates = null) {
  let indicatorText = '';
  
  switch (period) {
    case 'today':
      indicatorText = 'Сьогодні';
      break;
    case 'week':
      indicatorText = 'Останній тиждень';
      break;
    case 'month':
      indicatorText = 'Останній місяць';
      break;
    case 'custom':
      if (customDates) {
        indicatorText = `${formatDate(customDates.from)} - ${formatDate(customDates.to)}`;
      }
      break;
    default:
      indicatorText = 'Весь час';
      break;
  }
  
  // Оновити заголовок секції
  const heroLead = document.querySelector('.ds-hero__lead');
  if (heroLead && period !== 'all') {
    heroLead.innerHTML = `
      Детальний аналіз ефективності промокодів та груп
      <br><small style="color: var(--ds-primary); font-weight: 600;">
        <i class="fas fa-filter"></i> Період: ${indicatorText}
      </small>
    `;
  } else if (heroLead) {
    heroLead.textContent = 'Детальний аналіз ефективності промокодів та груп';
  }
}

// Форматувати дату
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('uk-UA', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric' 
  });
}

console.log('✅ Date filters initialized!');

// ==================== ЕКСПОРТ СТАТИСТИКИ ====================

function exportStats(format) {
  showToast(`Експорт ${format.toUpperCase()}...`, 'info');
  
  // Параметри експорту
  const params = new URLSearchParams({
    format: format,
    period: currentPeriod,
  });
  
  // Додати кастомні дати якщо є
  if (currentPeriod === 'custom' && customDates) {
    params.append('date_from', customDates.from);
    params.append('date_to', customDates.to);
  }
  
  // Створити посилання на завантаження
  const url = `/admin-panel/promo-export/?${params.toString()}`;
  
  // Створити тимчасове посилання та клікнути
  const link = document.createElement('a');
  link.href = url;
  link.download = `promo_stats_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : format}`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Показати успіх через секунду
  setTimeout(() => {
    showToast(`✅ ${format.toUpperCase()} файл завантажено!`, 'success');
  }, 1000);
}

console.log('✅ Export functions ready!');

// ==================== BOOTSTRAP TOOLTIPS ====================

// Ініціалізувати всі tooltips
document.addEventListener('DOMContentLoaded', function() {
  // Bootstrap 5 tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], [title]'));
  tooltipTriggerList.forEach(function (tooltipTriggerEl) {
    // Додати data-bs-toggle якщо є title але немає атрибута
    if (tooltipTriggerEl.hasAttribute('title') && !tooltipTriggerEl.hasAttribute('data-bs-toggle')) {
      tooltipTriggerEl.setAttribute('data-bs-toggle', 'tooltip');
    }
    
    // Ініціалізувати tooltip
    new bootstrap.Tooltip(tooltipTriggerEl, {
      placement: 'top',
      trigger: 'hover',
      delay: { show: 300, hide: 100 },
      animation: true,
    });
  });
  
  console.log(`✅ ${tooltipTriggerList.length} tooltips initialized!`);
});

// ==================== DARK MODE ====================

const darkModeToggle = document.getElementById('darkModeToggle');
const darkModeIcon = document.getElementById('darkModeIcon');

// Перевірити збережену тему
const savedTheme = localStorage.getItem('promoTheme');
if (savedTheme === 'dark') {
  document.body.classList.add('dark-mode');
  darkModeIcon.classList.remove('fa-moon');
  darkModeIcon.classList.add('fa-sun');
}

// Перемикач теми
if (darkModeToggle) {
  darkModeToggle.addEventListener('click', function() {
    document.body.classList.toggle('dark-mode');
    
    const isDark = document.body.classList.contains('dark-mode');
    
    // Змінити іконку
    if (isDark) {
      darkModeIcon.classList.remove('fa-moon');
      darkModeIcon.classList.add('fa-sun');
      localStorage.setItem('promoTheme', 'dark');
      showToast('🌙 Темний режим активовано', 'info');
    } else {
      darkModeIcon.classList.remove('fa-sun');
      darkModeIcon.classList.add('fa-moon');
      localStorage.setItem('promoTheme', 'light');
      showToast('☀️ Світлий режим активовано', 'info');
    }
    
    // Анімація перемикання
    darkModeToggle.style.animation = 'spin 0.5s ease';
    setTimeout(() => {
      darkModeToggle.style.animation = '';
    }, 500);
  });
}

// Анімація обертання
const spinStyle = document.createElement('style');
spinStyle.textContent = `
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(spinStyle);

console.log('✅ Dark mode initialized!');

// ==================== CONFIRM DELETE ====================

let deleteTarget = null;

function confirmDelete(type, id, name) {
  deleteTarget = { type, id, name };
  
  const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
  const title = document.getElementById('confirmDeleteTitle');
  const message = document.getElementById('confirmDeleteMessage');
  
  if (type === 'promo') {
    title.textContent = `Видалити промокод "${name}"?`;
    message.textContent = `Промокод "${name}" та всі пов'язані дані будуть видалені назавжди.`;
  } else if (type === 'group') {
    title.textContent = `Видалити групу "${name}"?`;
    message.textContent = `Група "${name}" буде видалена. Промокоди в групі залишаться.`;
  }
  
  modal.show();
}

document.getElementById('confirmDeleteBtn')?.addEventListener('click', function() {
  if (!deleteTarget) return;
  
  const { type, id } = deleteTarget;
  let url = '';
  
  if (type === 'promo') {
    url = `/admin-panel/promocode/${id}/delete/`;
  } else if (type === 'group') {
    url = `/admin-panel/promo-group/${id}/delete/`;
  }
  
  // Показати loading
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Видалення...';
  
  // Редірект на URL видалення
  window.location.href = url;
});

console.log('✅ Confirm delete initialized!');

// ==================== ШВИДКИЙ ПОШУК ====================

const searchInput = document.getElementById('promoSearch');
const clearSearchBtn = document.getElementById('clearSearch');
let searchTimeout;

if (searchInput) {
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const searchTerm = this.value.toLowerCase().trim();
    
    // Debounce для продуктивності
    searchTimeout = setTimeout(() => {
      filterPromos(searchTerm);
      
      // Показати/приховати кнопку очищення
      if (searchTerm) {
        clearSearchBtn.style.display = 'flex';
      } else {
        clearSearchBtn.style.display = 'none';
      }
    }, 300);
  });
}

if (clearSearchBtn) {
  clearSearchBtn.addEventListener('click', function() {
    searchInput.value = '';
    filterPromos('');
    this.style.display = 'none';
    searchInput.focus();
  });
}

function filterPromos(searchTerm) {
  const promoCards = document.querySelectorAll('.ds-promo-card');
  let visibleCount = 0;
  
  promoCards.forEach(card => {
    // Отримати текст для пошуку
    const code = card.querySelector('.ds-promo-card__code')?.textContent.toLowerCase() || '';
    const desc = card.querySelector('.ds-promo-card__desc')?.textContent.toLowerCase() || '';
    const discount = card.querySelector('.ds-promo-card__value')?.textContent.toLowerCase() || '';
    
    const searchableText = `${code} ${desc} ${discount}`;
    
    if (!searchTerm || searchableText.includes(searchTerm)) {
      card.style.display = '';
      visibleCount++;
      
      // Highlight matches
      if (searchTerm) {
        highlightText(card, searchTerm);
      } else {
        removeHighlight(card);
      }
    } else {
      card.style.display = 'none';
      removeHighlight(card);
    }
  });
  
  // Показати результати
  if (searchTerm) {
    showToast(`Знайдено: ${visibleCount} з ${promoCards.length}`, 'info');
  }
  
  // Оновити sidebar
  updateSidebarBadges();
}

function highlightText(element, searchTerm) {
  const codeEl = element.querySelector('.ds-promo-card__code');
  if (codeEl && !codeEl.querySelector('.promo-highlight')) {
    const originalText = codeEl.textContent;
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    codeEl.innerHTML = originalText.replace(regex, '<span class="promo-highlight">$1</span>');
  }
}

function removeHighlight(element) {
  const codeEl = element.querySelector('.ds-promo-card__code');
  if (codeEl) {
    const highlightEl = codeEl.querySelector('.promo-highlight');
    if (highlightEl) {
      codeEl.textContent = codeEl.textContent;
    }
  }
}

console.log('✅ Search initialized!');

// ==================== СОРТУВАННЯ ====================

const sortSelect = document.getElementById('promoSort');

if (sortSelect) {
  sortSelect.addEventListener('change', function() {
    const sortType = this.value;
    sortPromos(sortType);
    showToast(`Сортування: ${this.options[this.selectedIndex].text}`, 'info');
  });
}

function sortPromos(sortType) {
  const grid = document.querySelector('.ds-grid');
  const promoCards = Array.from(document.querySelectorAll('.ds-promo-card'));
  
  promoCards.sort((a, b) => {
    switch (sortType) {
      case 'newest':
        // За датою створення (нові → старі)
        return parseInt(b.dataset.promoId) - parseInt(a.dataset.promoId);
      
      case 'oldest':
        // За датою створення (старі → нові)
        return parseInt(a.dataset.promoId) - parseInt(b.dataset.promoId);
      
      case 'discount-high':
      case 'discount-low': {
        // За знижкою
        const aDiscount = parseFloat(a.querySelector('.ds-promo-card__value')?.textContent) || 0;
        const bDiscount = parseFloat(b.querySelector('.ds-promo-card__value')?.textContent) || 0;
        return sortType === 'discount-high' ? bDiscount - aDiscount : aDiscount - bDiscount;
      }
      
      case 'usage-high':
      case 'usage-low': {
        // За використанням
        const aUsage = parseInt(a.querySelector('.ds-stat__value')?.textContent) || 0;
        const bUsage = parseInt(b.querySelector('.ds-stat__value')?.textContent) || 0;
        return sortType === 'usage-high' ? bUsage - aUsage : aUsage - bUsage;
      }
      
      case 'code-az':
      case 'code-za': {
        // За кодом
        const aCode = a.querySelector('.ds-promo-card__code')?.textContent || '';
        const bCode = b.querySelector('.ds-promo-card__code')?.textContent || '';
        return sortType === 'code-az' 
          ? aCode.localeCompare(bCode) 
          : bCode.localeCompare(aCode);
      }
      
      default:
        return 0;
    }
  });
  
  // Пере-додати картки в новому порядку
  promoCards.forEach(card => grid.appendChild(card));
  
  // Анімація
  promoCards.forEach((card, index) => {
    card.style.animation = 'none';
    setTimeout(() => {
      card.style.animation = '';
    }, 10);
  });
}

console.log('✅ Sorting initialized!');
</script>
