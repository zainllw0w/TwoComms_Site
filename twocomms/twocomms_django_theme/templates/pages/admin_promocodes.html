{% load static %}

<!-- CSS для стилів промокодів - темна тема по умолчанию -->
<link rel="stylesheet" href="{% static 'css/promocodes.css' %}?v=20250209" media="all">

<div class="promocodes-admin-wrapper" style="width: 100%; display: flex; gap: 2rem; min-height: 600px;">
  <!-- Sidebar навигация -->
  <aside class="ds-sidebar" style="position: relative; top: 0; min-height: auto; width: 280px; flex-shrink: 0;">
    <div class="ds-sidebar__inner">
      <div class="ds-sidebar__brand">
        <div class="ds-sidebar__logo">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="#8b5cf6">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        </div>
        <div>
          <div class="ds-sidebar__title">Промокоди</div>
          <div class="ds-sidebar__subtitle">Панель керування</div>
      </div>
    </div>
    
      <nav class="ds-sidebar__nav">
        <a href="?section=promocodes&tab=promocodes" class="ds-sidebar__link {% if promo_tab == 'promocodes' or not promo_tab %}is-active{% endif %}">
          <span class="ds-sidebar__icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
          </span>
          <span class="ds-sidebar__label">
            Промокоди
            <span class="ds-sidebar__badge">{{ total_promocodes|default:0 }}</span>
          </span>
        </a>

        <a href="?section=promocodes&tab=groups" class="ds-sidebar__link {% if promo_tab == 'groups' %}is-active{% endif %}">
          <span class="ds-sidebar__icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
          </span>
          <span class="ds-sidebar__label">
            Групи
            <span class="ds-sidebar__badge">{{ total_groups|default:0 }}</span>
          </span>
        </a>

        <a href="?section=promocodes&tab=stats" class="ds-sidebar__link {% if promo_tab == 'stats' %}is-active{% endif %}">
          <span class="ds-sidebar__icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
          </span>
          <span class="ds-sidebar__label">
            Статистика
          </span>
        </a>
      </nav>

      <!-- Краткая статистика в сайдбаре -->
      <div class="ds-sidebar__stats">
        <div class="ds-sidebar__stat">
          <div class="ds-sidebar__stat-value">{{ active_promocodes|default:0 }}</div>
          <div class="ds-sidebar__stat-label">Активних</div>
    </div>
        <div class="ds-sidebar__stat">
          <div class="ds-sidebar__stat-value">{{ total_usages|default:0 }}</div>
          <div class="ds-sidebar__stat-label">Використань</div>
        </div>
      </div>
    </div>
  </aside>
    
  <!-- Main контент -->
  <main class="ds-main" style="flex: 1; min-width: 0;">
    
    <!-- ==================== ТАБ: ПРОМОКОДИ ==================== -->
    {% if promo_tab == 'promocodes' or not promo_tab %}
    <section class="ds-tab-panel is-active">
      <div class="ds-container">
        <!-- Hero секция -->
        <section class="ds-hero" style="min-height: auto; padding: 2rem 0;">
          <div class="ds-hero__background">
            <span class="ds-hero__blur ds-hero__blur--left"></span>
            <span class="ds-hero__blur ds-hero__blur--right"></span>
            <span class="ds-hero__glow"></span>
          </div>
          <div class="ds-hero__body">
            <div class="ds-hero__main">
              <span class="ds-eyebrow ds-eyebrow--accent">
                <i class="fas fa-star"></i>
                Управління промокодами
              </span>
              <h1 class="ds-hero__title" style="font-size: 2.5rem;">Промокоди та знижки</h1>
              <p class="ds-hero__lead">
                Створюйте гнучкі системи знижок для ваших клієнтів. Групові акції, ваучери та індивідуальні пропозиції.
              </p>
              <div class="ds-actions ds-actions--hero">
                <button type="button" class="ds-btn ds-btn--primary" data-bs-toggle="modal" data-bs-target="#createPromoModal">
                  <i class="fas fa-plus"></i>
                  <span>Створити промокод</span>
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Фильтры -->
        <div class="ds-filters">
          <div class="ds-filter-pills">
            <a href="?section=promocodes&tab=promocodes&view=all" class="ds-pill {% if view_type == 'all' or not view_type %}is-active{% endif %}">
              Всі <span class="ds-pill__count">{{ total_promocodes|default:0 }}</span>
            </a>
            <a href="?section=promocodes&tab=promocodes&view=grouped" class="ds-pill {% if view_type == 'grouped' %}is-active{% endif %}">
              Групові
            </a>
            <a href="?section=promocodes&tab=promocodes&view=vouchers" class="ds-pill {% if view_type == 'vouchers' %}is-active{% endif %}">
              Ваучери <span class="ds-pill__count">{{ total_vouchers|default:0 }}</span>
            </a>
            <a href="?section=promocodes&tab=promocodes&view=regular" class="ds-pill {% if view_type == 'regular' %}is-active{% endif %}">
              Звичайні
            </a>
          </div>
          
          <!-- Фільтр по групах -->
          <div class="ds-group-filter">
            <label for="groupFilter" class="ds-group-filter__label">
              <i class="fas fa-layer-group"></i> Фільтр по групах:
            </label>
            <select id="groupFilter" class="ds-group-filter__select">
              <option value="" {% if not current_group_id %}selected{% endif %}>Всі групи</option>
              <option value="no-group" {% if current_group_id == 'no-group' %}selected{% endif %}>Без групи</option>
              {% for group in groups %}
                <option value="{{ group.id }}" data-color="{{ group.id }}" {% if current_group_id == group.id %}selected{% endif %}>
                  {{ group.name }} ({{ group.codes_count }})
                </option>
              {% endfor %}
            </select>
            <button type="button" id="clearGroupFilter" class="ds-group-filter__clear" title="Очистити фільтр" style="display: none;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <!-- Швидкий пошук -->
          <div class="ds-search-box">
            <i class="fas fa-search ds-search-icon"></i>
            <input type="text" id="promoSearch" class="ds-search-input" placeholder="Швидкий пошук промокодів...">
            <button type="button" id="clearSearch" class="ds-search-clear" style="display: none;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <!-- Сортування -->
          <div class="ds-sort-box">
            <label for="promoSort" class="ds-sort-label">
              <i class="fas fa-sort"></i> Сортувати:
            </label>
            <select id="promoSort" class="ds-sort-select">
              <option value="newest">Нові спочатку</option>
              <option value="oldest">Старі спочатку</option>
              <option value="discount-high">Знижка (висока → низька)</option>
              <option value="discount-low">Знижка (низька → висока)</option>
              <option value="usage-high">Використання (багато → мало)</option>
              <option value="usage-low">Використання (мало → багато)</option>
              <option value="code-az">Код (A → Z)</option>
              <option value="code-za">Код (Z → A)</option>
            </select>
          </div>
  </div>

  <!-- Split view: Промокоди та групи для зручного drag & drop -->
        <div class="promo-workspace">
          <!-- Промокоди (ліворуч) -->
          <div class="promo-workspace__codes">
            <div class="ds-grid ds-fade-in-grid">
              {% if promocodes %}
                {% for promo in promocodes %}
                  <article class="ds-promo-card ds-fade-in-item {% if not promo.is_active %}is-inactive{% endif %}" 
                           draggable="true" 
                           data-promo-id="{{ promo.id }}"
                           data-group-id="{{ promo.group.id|default:'' }}"
                           data-code="{{ promo.code }}"
                           data-discount-value="{{ promo.discount_value }}"
                           data-discount-type="{{ promo.discount_type }}"
                           data-current-uses="{{ promo.current_uses }}"
                           data-max-uses="{{ promo.max_uses }}"
                           ondragstart="handlePromoDragStart(event)"
                           ondragend="handlePromoDragEnd(event)">
                    <div class="ds-promo-card__header">
                      <div class="ds-promo-card__code">
                        <code>{{ promo.code }}</code>
                        {% if promo.promo_type == 'voucher' %}
                          <span class="ds-badge ds-badge--voucher">Ваучер</span>
                        {% elif promo.promo_type == 'grouped' %}
                          <span class="ds-badge ds-badge--grouped">Груповий</span>
                        {% endif %}
                      </div>
                      <div class="ds-promo-card__status">
                        <span class="ds-status-dot {% if promo.is_active %}is-active{% else %}is-inactive{% endif %}"></span>
                      </div>
                    </div>

                    {% if promo.description %}
                    <p class="ds-promo-card__description">{{ promo.description|truncatewords:15 }}</p>
                    {% endif %}

                    <div class="ds-promo-card__stats">
                      <div class="ds-stat-item">
                        <div class="ds-stat-item__label">Знижка</div>
                        <div class="ds-stat-item__value">{{ promo.get_discount_display }}</div>
                      </div>
                      <div class="ds-stat-item">
                        <div class="ds-stat-item__label">Використань</div>
                        <div class="ds-stat-item__value">
                          {{ promo.current_uses }}{% if promo.max_uses > 0 %}/{{ promo.max_uses }}{% else %}/∞{% endif %}
                        </div>
                      </div>
                    </div>

                    {% if promo.group %}
                    <div class="ds-promo-card__group">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3z"/>
                      </svg>
                      {{ promo.group.name }}
                    </div>
                    {% endif %}

                    <div class="ds-promo-card__actions">
                      <button type="button" class="ds-action-btn ds-action-btn--edit" title="Редагувати" data-action="edit-promo" data-promo-id="{{ promo.id }}">
                        <i class="fas fa-edit"></i>
                      </button>
                      <a href="{% url 'admin_promocode_toggle' promo.id %}" class="ds-action-btn ds-action-btn--toggle" title="{% if promo.is_active %}Деактивувати{% else %}Активувати{% endif %}">
                        <i class="fas fa-{% if promo.is_active %}pause{% else %}play{% endif %}"></i>
                      </a>
                      <button type="button" class="ds-action-btn ds-action-btn--delete" title="Видалити" data-action="delete-promo" data-promo-id="{{ promo.id }}" data-promo-code="{{ promo.code }}">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </article>
                {% endfor %}
              {% else %}
                <div class="ds-empty-state">
                  <div class="ds-empty-state__icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                  </div>
                  <h3 class="ds-empty-state__title">Немає промокодів</h3>
                  <p class="ds-empty-state__text">Створіть перший промокод для ваших клієнтів</p>
                  <button type="button" class="ds-btn ds-btn--primary" data-bs-toggle="modal" data-bs-target="#createPromoModal">
                    <i class="fas fa-plus"></i>
                    <span>Створити промокод</span>
                  </button>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Групи (праворуч) для drag & drop -->
          <aside class="promo-workspace__groups ds-groups-sidebar" id="groupsSidebar">
            <div class="ds-groups-sidebar__header">
              <h3 class="ds-groups-sidebar__title">
                <i class="fas fa-layer-group"></i>
                Групи
              </h3>
              <button type="button" class="ds-btn ds-btn--secondary ds-btn--icon" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            
            <div class="ds-groups-sidebar__body">
              <p class="ds-groups-sidebar__hint">
                <i class="fas fa-info-circle"></i>
                Перетягніть промокод на групу, щоб швидко змінити її
              </p>

              <!-- Зона "Без групи" -->
              <div class="ds-group-drop-zone promo-drop-zone" 
                   data-group-id=""
                   ondragover="handleGroupDragOver(event)"
                   ondragleave="handleGroupDragLeave(event)"
                   ondrop="handleGroupDrop(event)">
                <div class="ds-group-drop-zone__icon">
                  <i class="fas fa-inbox"></i>
                </div>
                <div class="ds-group-drop-zone__content">
                  <div class="ds-group-drop-zone__title">Без групи</div>
                  <div class="ds-group-drop-zone__count" id="noGroupCount">
                    Скиньте сюди, щоб прибрати з групи
                  </div>
                </div>
              </div>

              <!-- Список груп -->
              {% if groups %}
                {% for group in groups %}
                  <div class="ds-group-drop-zone promo-drop-zone{% if not group.is_active %} is-inactive{% endif %}" 
                       data-group-id="{{ group.id }}"
                       ondragover="handleGroupDragOver(event)"
                       ondragleave="handleGroupDragLeave(event)"
                       ondrop="handleGroupDrop(event)">
                    <div class="ds-group-drop-zone__icon">
                      <i class="fas fa-users"></i>
                    </div>
                    <div class="ds-group-drop-zone__content">
                      <div class="ds-group-drop-zone__title">
                        {{ group.name }}
                        {% if group.one_per_account %}
                          <span class="ds-badge ds-badge--info ds-badge--micro">1 на акаунт</span>
                        {% endif %}
                      </div>
                      <div class="ds-group-drop-zone__count">
                        {{ group.codes_count }} промокодів
                      </div>
                    </div>
                    <div class="ds-group-drop-zone__actions">
                      <button type="button" class="ds-action-btn ds-action-btn--view" title="Переглянути" onclick="window.location.href='?section=promocodes&tab=promocodes&group={{ group.id }}'">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button type="button" class="ds-action-btn ds-action-btn--edit" title="Редагувати" data-action="edit-group" data-group-id="{{ group.id }}">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <p class="ds-no-data ds-no-data--compact">Немає груп. Створіть першу групу.</p>
              {% endif %}
            </div>
          </aside>
        </div>
      </div>
    </section>
    {% endif %}

    <!-- ==================== ТАБ: ГРУПИ ==================== -->
    {% if promo_tab == 'groups' %}
    <section class="ds-tab-panel is-active">
      <div class="ds-container">
        <!-- Hero -->
        <section class="ds-hero" style="min-height: auto; padding: 2rem 0;">
          <div class="ds-hero__background">
            <span class="ds-hero__blur ds-hero__blur--left"></span>
            <span class="ds-hero__blur ds-hero__blur--right"></span>
          </div>
          <div class="ds-hero__body">
            <div class="ds-hero__main">
              <span class="ds-eyebrow ds-eyebrow--accent">
                <i class="fas fa-users"></i>
                Групи промокодів
              </span>
              <h1 class="ds-hero__title" style="font-size: 2.5rem;">Організація акцій</h1>
              <p class="ds-hero__lead">
                Групуйте промокоди за кампаніями. Встановлюйте обмеження "один на аккаунт" для рекламних акцій.
              </p>
              <div class="ds-actions ds-actions--hero">
                <button type="button" class="ds-btn ds-btn--primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                  <i class="fas fa-plus"></i>
                  <span>Створити групу</span>
                </button>
            </div>
            </div>
          </div>
        </section>

        <!-- Список групп -->
        <div class="ds-grid">
          {% if groups %}
            {% for group in groups %}
            <article class="ds-group-card {% if not group.is_active %}is-inactive{% endif %} promo-drop-zone" 
                     data-group-id="{{ group.id }}"
                     ondragover="handleGroupDragOver(event)"
                     ondragleave="handleGroupDragLeave(event)"
                     ondrop="handleGroupDrop(event)">
              <div class="ds-group-card__header">
                <h3 class="ds-group-card__title">
                  {{ group.name }}
                  {% if group.one_per_account %}
                    <span class="ds-badge ds-badge--info">1 на акаунт</span>
                {% endif %}
                </h3>
                <span class="ds-status-dot {% if group.is_active %}is-active{% else %}is-inactive{% endif %}"></span>
              </div>
              
              {% if group.description %}
              <p class="ds-group-card__description">{{ group.description|truncatewords:20 }}</p>
              {% endif %}

              <div class="ds-group-card__metrics">
                <div class="ds-metric">
                  <div class="ds-metric__value">{{ group.codes_count }}</div>
                  <div class="ds-metric__label">Промокодів</div>
                  </div>
                <div class="ds-metric">
                  <div class="ds-metric__value">{{ group.active_codes_count }}</div>
                  <div class="ds-metric__label">Активних</div>
                </div>
                <div class="ds-metric">
                  <div class="ds-metric__value">{{ group.total_usages|default:0 }}</div>
                  <div class="ds-metric__label">Використань</div>
              </div>
            </div>
            
              <div class="ds-group-card__actions">
                <a href="?section=promocodes&tab=promocodes&group={{ group.id }}" class="ds-action-btn ds-action-btn--view" title="Переглянути промокоди">
                  <i class="fas fa-eye"></i>
                </a>
                <button type="button" class="ds-action-btn ds-action-btn--edit" title="Редагувати" data-action="edit-group" data-group-id="{{ group.id }}">
                  <i class="fas fa-edit"></i>
                </button>
                <a href="{% url 'admin_promo_group_delete' group.id %}" class="ds-action-btn ds-action-btn--delete" title="Видалити" onclick="return confirm('Видалити групу?')">
                  <i class="fas fa-trash"></i>
                </a>
            </div>
            </article>
            {% endfor %}
                {% else %}
            <div class="ds-empty-state">
              <div class="ds-empty-state__icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3z"/>
              </svg>
            </div>
              <h3 class="ds-empty-state__title">Немає груп</h3>
              <p class="ds-empty-state__text">Створіть групу для організації промокодів</p>
              <button type="button" class="ds-btn ds-btn--primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                <i class="fas fa-plus"></i>
                <span>Створити групу</span>
              </button>
          </div>
                {% endif %}
              </div>
      </div>
    </section>
              {% endif %}

    <!-- ==================== ТАБ: СТАТИСТИКА ==================== -->
    {% if promo_tab == 'stats' %}
    <section class="ds-tab-panel is-active">
      <div class="ds-container">
        <!-- Hero -->
        <section class="ds-hero" style="min-height: auto; padding: 2rem 0;">
          <div class="ds-hero__background">
            <span class="ds-hero__blur ds-hero__blur--left"></span>
            <span class="ds-hero__blur ds-hero__blur--right"></span>
                  </div>
          <div class="ds-hero__body">
            <div class="ds-hero__main">
              <span class="ds-eyebrow ds-eyebrow--accent">
                <i class="fas fa-chart-line"></i>
                Аналітика
              </span>
              <h1 class="ds-hero__title" style="font-size: 2.5rem;">Статистика використання</h1>
              <p class="ds-hero__lead">
                Детальний аналіз ефективності промокодів та груп
              </p>
            </div>
            
            <!-- Dark Mode Toggle -->
            <button type="button" id="darkModeToggle" class="ds-dark-mode-toggle" title="Перемкнути тему">
              <i class="fas fa-moon" id="darkModeIcon"></i>
            </button>
            
            <!-- Кнопки експорту -->
            <div class="ds-export-actions">
              <button type="button" class="ds-export-btn ds-export-btn--csv" onclick="exportStats('csv')">
                <i class="fas fa-file-csv"></i> Експорт CSV
              </button>
              <button type="button" class="ds-export-btn ds-export-btn--excel" onclick="exportStats('excel')">
                <i class="fas fa-file-excel"></i> Експорт Excel
              </button>
              <button type="button" class="ds-export-btn ds-export-btn--pdf" onclick="exportStats('pdf')">
                <i class="fas fa-file-pdf"></i> Експорт PDF
              </button>
            </div>
            
            <!-- Фільтри по датах -->
            <div class="ds-date-filters">
              <div class="ds-date-filter-pills">
                <button type="button" class="ds-date-pill is-active" data-period="all">
                  <i class="fas fa-infinity"></i> Весь час
                </button>
                <button type="button" class="ds-date-pill" data-period="today">
                  <i class="fas fa-calendar-day"></i> Сьогодні
                </button>
                <button type="button" class="ds-date-pill" data-period="week">
                  <i class="fas fa-calendar-week"></i> Тиждень
                </button>
                <button type="button" class="ds-date-pill" data-period="month">
                  <i class="fas fa-calendar-alt"></i> Місяць
                </button>
                <button type="button" class="ds-date-pill" data-period="custom">
                  <i class="fas fa-calendar-range"></i> Кастомний
                </button>
              </div>
              
              <!-- Datepicker для кастомного періоду -->
              <div id="customDateRange" class="ds-custom-date-range" style="display: none;">
                <div class="ds-date-inputs">
                  <div class="ds-date-input-group">
                    <label for="dateFrom">Від:</label>
                    <input type="date" id="dateFrom" class="ds-date-input">
                  </div>
                  <div class="ds-date-input-group">
                    <label for="dateTo">До:</label>
                    <input type="date" id="dateTo" class="ds-date-input">
                  </div>
                  <button type="button" id="applyCustomDates" class="ds-btn ds-btn--apply">
                    <i class="fas fa-check"></i> Застосувати
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Общая статистика -->
        <div class="ds-stats-overview">
          <div class="ds-overview-card">
            <div class="ds-overview-card__icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="ds-overview-card__value">{{ total_usages|default:0 }}</div>
            <div class="ds-overview-card__label">Всього використань</div>
          </div>
          <div class="ds-overview-card">
            <div class="ds-overview-card__icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="ds-overview-card__value">{{ unique_users|default:0 }}</div>
            <div class="ds-overview-card__label">Унікальних користувачів</div>
          </div>
          <div class="ds-overview-card ds-overview-card--success">
            <div class="ds-overview-card__icon">
              <i class="fas fa-percentage"></i>
            </div>
            <div class="ds-overview-card__value">{{ conversion_rate|default:0 }}%</div>
            <div class="ds-overview-card__label">Конверсія промокодів</div>
            <div class="ds-overview-card__meta">
              {{ used_promocodes_count }}/{{ total_promocodes }} використано
            </div>
          </div>
          <div class="ds-overview-card ds-overview-card--warning">
            <div class="ds-overview-card__icon">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="ds-overview-card__value">{{ total_savings|floatformat:2 }} ₴</div>
            <div class="ds-overview-card__label">Загальна економія</div>
            <div class="ds-overview-card__meta">
              Фіксовані знижки
            </div>
          </div>
        </div>
        
        <!-- Розширена статистика -->
        <div class="ds-stats-extended">
          <div class="ds-stat-card">
            <div class="ds-stat-card__header">
              <i class="fas fa-tag"></i>
              <h3>Середні знижки</h3>
            </div>
            <div class="ds-stat-card__body">
              <div class="ds-stat-row">
                <span class="ds-stat-label">Відсоткові промокоди:</span>
                <span class="ds-stat-value">{{ avg_discount_percent|floatformat:1 }}%</span>
              </div>
              <div class="ds-stat-row">
                <span class="ds-stat-label">Фіксовані промокоди:</span>
                <span class="ds-stat-value">{{ avg_discount_fixed|floatformat:2 }} ₴</span>
              </div>
              <div class="ds-stat-row">
                <span class="ds-stat-label">Середнє використань/промокод:</span>
                <span class="ds-stat-value">{{ avg_usages_per_promo|floatformat:2 }}</span>
              </div>
            </div>
          </div>
          
          <div class="ds-stat-card ds-stat-card--highlight">
            <div class="ds-stat-card__header">
              <i class="fas fa-crown"></i>
              <h3>Лідери</h3>
            </div>
            <div class="ds-stat-card__body">
              {% if most_popular_promo %}
                <div class="ds-stat-row ds-stat-row--large">
                  <span class="ds-stat-label">Найпопулярніший промокод:</span>
                  <span class="ds-stat-value"><code>{{ most_popular_promo.code }}</code></span>
                </div>
                <div class="ds-stat-row ds-stat-row--muted">
                  <span class="ds-stat-label">Використань:</span>
                  <span class="ds-stat-value">{{ most_popular_promo.usages.count }}</span>
                </div>
              {% endif %}
              
              {% if most_successful_group %}
                <div class="ds-stat-row ds-stat-row--large" style="margin-top: 1rem;">
                  <span class="ds-stat-label">Найуспішніша група:</span>
                  <span class="ds-stat-value">{{ most_successful_group.name }}</span>
                </div>
              {% endif %}
            </div>
            </div>
          </div>

        <!-- Графіки -->
        <div class="ds-charts-grid">
          <!-- Line Chart: Використання по датах -->
          <div class="ds-chart-card">
            <div class="ds-chart-card__header">
              <h3><i class="fas fa-chart-line"></i> Використання по датах</h3>
              <span class="ds-chart-card__subtitle">Останні 30 днів</span>
            </div>
            <div class="ds-chart-card__body">
              <canvas id="usageLineChart"></canvas>
            </div>
          </div>
          
          <!-- Bar Chart: TOP-10 промокодів -->
          <div class="ds-chart-card">
            <div class="ds-chart-card__header">
              <h3><i class="fas fa-chart-bar"></i> ТОП-10 промокодів</h3>
              <span class="ds-chart-card__subtitle">За кількістю використань</span>
            </div>
            <div class="ds-chart-card__body">
              <canvas id="topPromosBarChart"></canvas>
          </div>
        </div>

          <!-- Pie Chart: Розподіл по групах -->
          <div class="ds-chart-card">
            <div class="ds-chart-card__header">
              <h3><i class="fas fa-chart-pie"></i> Розподіл по групах</h3>
              <span class="ds-chart-card__subtitle">Використання промокодів</span>
            </div>
            <div class="ds-chart-card__body">
              <canvas id="groupsPieChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Топ промокодов -->
        <div class="ds-section">
          <h2 class="ds-section__title">
            <i class="fas fa-trophy"></i>
            Топ-10 промокодів
          </h2>
          <div class="ds-leaderboard">
            {% for promo in top_promos %}
            <div class="ds-leader-item">
              <div class="ds-leader-rank">#{{ forloop.counter }}</div>
              <div class="ds-leader-info">
                <div class="ds-leader-name"><code>{{ promo.code }}</code></div>
                <div class="ds-leader-meta">{{ promo.get_discount_display }}</div>
              </div>
              <div class="ds-leader-value">{{ promo.usage_count|default:0 }}</div>
            </div>
            {% empty %}
            <p class="ds-no-data">Немає даних</p>
            {% endfor %}
          </div>
        </div>

        <!-- Топ групп -->
        {% if top_groups %}
        <div class="ds-section">
          <h2 class="ds-section__title">
            <i class="fas fa-users"></i>
            Топ-10 груп
          </h2>
          <div class="ds-leaderboard">
            {% for group in top_groups %}
            <div class="ds-leader-item">
              <div class="ds-leader-rank">#{{ forloop.counter }}</div>
              <div class="ds-leader-info">
                <div class="ds-leader-name">{{ group.name }}</div>
              </div>
              <div class="ds-leader-value">{{ group.usage_count|default:0 }}</div>
      </div>
      {% endfor %}
          </div>
        </div>
            {% endif %}

        <!-- Последние использования -->
        <div class="ds-section">
          <h2 class="ds-section__title">
            <i class="fas fa-clock"></i>
            Останні 50 використань
          </h2>
          <div class="ds-usage-log">
            {% for usage in recent_usages %}
            <div class="ds-usage-row">
              <div class="ds-usage-date">{{ usage.used_at|date:"d.m.Y H:i" }}</div>
              <div class="ds-usage-user">{{ usage.user.username }}</div>
              <div class="ds-usage-code"><code>{{ usage.promo_code.code }}</code></div>
              <div class="ds-usage-group">
                {% if usage.group %}{{ usage.group.name }}{% else %}—{% endif %}
        </div>
      </div>
            {% empty %}
            <p class="ds-no-data">Немає використань</p>
      {% endfor %}
        </div>
      </div>
      </div>
    </section>
    {% endif %}

  </main>
  </div>

<!-- ==================== МОДАЛЬНІ ВІКНА ==================== -->

<!-- Modal: Створення промокода -->
<div class="modal fade" id="createPromoModal" tabindex="-1" aria-labelledby="createPromoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-fullscreen-md-down">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title" id="createPromoModalLabel" style="color: white; font-weight: 600;">
          <i class="fas fa-plus-circle"></i> Створити промокод
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
      <div class="modal-body" style="padding: 2rem;">
        <form id="createPromoForm" class="needs-validation" novalidate>
          {% csrf_token %}
          
          <div class="row g-3">
            <!-- Код промокода -->
            <div class="col-md-6">
              <label for="promo_code" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-tag"></i> Код промокода
              </label>
              <input type="text" 
                     class="form-control" 
                     id="promo_code" 
                     name="code" 
                     placeholder="SALE2025 (залиште порожнім для автогенерації)" 
                     pattern="[A-Z0-9_-]+"
                     style="border: 1px solid var(--ds-border);">
              <div class="form-text" style="color: var(--ds-text-muted);">
                Тільки великі літери, цифри, дефіс та підкреслення
              </div>
              <div class="invalid-feedback">Введіть коректний код промокода</div>
            </div>

            <!-- Тип промокода -->
            <div class="col-md-6">
              <label for="promo_type" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-shapes"></i> Тип промокода
              </label>
              <select class="form-select" id="promo_type" name="promo_type" required style="border: 1px solid var(--ds-border);">
                <option value="regular">Звичайний промокод</option>
                <option value="grouped">Груповий промокод</option>
                <option value="voucher">Ваучер (фіксована сума)</option>
              </select>
              <div class="invalid-feedback">Оберіть тип промокода</div>
            </div>

            <!-- Знижка (%) -->
            <div class="col-md-6">
              <label for="promo_discount" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-percent"></i> Знижка (%)
              </label>
              <input type="number" 
                     class="form-control" 
                     id="promo_discount" 
                     name="discount" 
                     min="0" 
                     max="100" 
                     step="0.01"
                     placeholder="10"
                     style="border: 1px solid var(--ds-border);">
              <div class="invalid-feedback">Введіть знижку від 0 до 100</div>
            </div>

            <!-- Фіксована сума -->
            <div class="col-md-6">
              <label for="promo_fixed_amount" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-money-bill-wave"></i> Фіксована сума (₴)
              </label>
              <input type="number" 
                     class="form-control" 
                     id="promo_fixed_amount" 
                     name="fixed_amount" 
                     min="0" 
                     step="0.01"
                     placeholder="100"
                     style="border: 1px solid var(--ds-border);">
              <div class="form-text" style="color: var(--ds-text-muted);">
                Для ваучерів вказуйте фіксовану суму
              </div>
            </div>

            <!-- Група -->
            <div class="col-md-6">
              <label for="promo_group" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-layer-group"></i> Група
              </label>
              <select class="form-select" id="promo_group" name="group" style="border: 1px solid var(--ds-border);">
                <option value="">Без групи</option>
                {% for group in groups %}
                  <option value="{{ group.id }}">{{ group.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Мінімальна сума замовлення -->
            <div class="col-md-6">
              <label for="promo_min_order" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-shopping-cart"></i> Мінімальна сума замовлення (₴)
              </label>
              <input type="number" 
                     class="form-control" 
                     id="promo_min_order" 
                     name="min_order_amount" 
                     min="0" 
                     step="0.01"
                     placeholder="0"
                     style="border: 1px solid var(--ds-border);">
            </div>

            <!-- Кількість використань -->
            <div class="col-md-6">
              <label for="promo_uses" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-hashtag"></i> Кількість використань
              </label>
              <input type="number" 
                     class="form-control" 
                     id="promo_uses" 
                     name="usage_limit" 
                     min="0"
                     placeholder="0 (необмежено)"
                     style="border: 1px solid var(--ds-border);">
            </div>

            <!-- Один раз на користувача -->
            <div class="col-md-6">
              <div class="form-check" style="margin-top: 2rem;">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="promo_one_time" 
                       name="one_time_per_user"
                       style="border: 1px solid var(--ds-border);">
                <label class="form-check-label" for="promo_one_time" style="color: var(--ds-text);">
                  <i class="fas fa-user-check"></i> Один раз на користувача
                </label>
              </div>
            </div>

            <!-- Дата початку -->
            <div class="col-md-6">
              <label for="promo_valid_from" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-calendar-alt"></i> Діє з
              </label>
              <input type="datetime-local" 
                     class="form-control" 
                     id="promo_valid_from" 
                     name="valid_from"
                     style="border: 1px solid var(--ds-border);">
            </div>

            <!-- Дата закінчення -->
            <div class="col-md-6">
              <label for="promo_valid_until" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-calendar-times"></i> Діє до
              </label>
              <input type="datetime-local" 
                     class="form-control" 
                     id="promo_valid_until" 
                     name="valid_until"
                     style="border: 1px solid var(--ds-border);">
            </div>

            <!-- Опис -->
            <div class="col-12">
              <label for="promo_description" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-align-left"></i> Опис
              </label>
              <textarea class="form-control" 
                        id="promo_description" 
                        name="description" 
                        rows="3"
                        placeholder="Опис промокода для внутрішнього використання"
                        style="border: 1px solid var(--ds-border);"></textarea>
            </div>

            <!-- Активний -->
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="promo_is_active" 
                       name="is_active"
                       checked
                       style="border: 1px solid var(--ds-border);">
                <label class="form-check-label" for="promo_is_active" style="color: var(--ds-text);">
                  <i class="fas fa-check-circle"></i> Активний промокод
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); background: var(--ds-bg-soft);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="submit" form="createPromoForm" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
          <i class="fas fa-save"></i> Створити промокод
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Редагування промокода -->
<div class="modal fade" id="editPromoModal" tabindex="-1" aria-labelledby="editPromoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-fullscreen-md-down">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title" id="editPromoModalLabel" style="color: white; font-weight: 600;">
          <i class="fas fa-edit"></i> Редагувати промокод
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="editPromoModalBody" style="padding: 2rem;">
        <!-- Контент завантажується через AJAX -->
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Завантаження...</span>
          </div>
          <p class="mt-3" style="color: var(--ds-text-muted);">Завантаження даних промокода...</p>
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); background: var(--ds-bg-soft);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="submit" id="editPromoSubmitBtn" form="editPromoForm" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;" disabled>
          <i class="fas fa-save"></i> Зберегти зміни
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Створення групи -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h5 class="modal-title" id="createGroupModalLabel" style="color: white; font-weight: 600;">
          <i class="fas fa-plus-circle"></i> Створити групу промокодів
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 2rem;">
        <form id="createGroupForm" class="needs-validation" novalidate>
          {% csrf_token %}
          
          <!-- Назва групи -->
          <div class="mb-3">
            <label for="group_name" class="form-label" style="color: var(--ds-text); font-weight: 500;">
              <i class="fas fa-tag"></i> Назва групи
            </label>
            <input type="text" 
                   class="form-control" 
                   id="group_name" 
                   name="name" 
                   placeholder="Instagram Реклама"
                   required
                   style="border: 1px solid var(--ds-border);">
            <div class="invalid-feedback">Введіть назву групи</div>
          </div>

          <!-- Опис -->
          <div class="mb-3">
            <label for="group_description" class="form-label" style="color: var(--ds-text); font-weight: 500;">
              <i class="fas fa-align-left"></i> Опис
            </label>
            <textarea class="form-control" 
                      id="group_description" 
                      name="description" 
                      rows="3"
                      placeholder="Промокоди для рекламної кампанії в Instagram"
                      style="border: 1px solid var(--ds-border);"></textarea>
          </div>

          <!-- Один на аккаунт -->
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" 
                     type="checkbox" 
                     id="group_one_per_account" 
                     name="one_per_account"
                     style="border: 1px solid var(--ds-border);">
              <label class="form-check-label" for="group_one_per_account" style="color: var(--ds-text);">
                <i class="fas fa-user-lock"></i> Один промокод з групи на акаунт
              </label>
              <div class="form-text" style="color: var(--ds-text-muted);">
                Користувач зможе використати тільки один промокод з цієї групи
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); background: var(--ds-bg-soft);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="submit" form="createGroupForm" class="btn btn-primary" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none;">
          <i class="fas fa-save"></i> Створити групу
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Редагування групи -->
<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h5 class="modal-title" id="editGroupModalLabel" style="color: white; font-weight: 600;">
          <i class="fas fa-edit"></i> Редагувати групу
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="editGroupModalBody" style="padding: 2rem;">
        <!-- Контент завантажується через AJAX -->
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Завантаження...</span>
          </div>
          <p class="mt-3" style="color: var(--ds-text-muted);">Завантаження даних групи...</p>
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); background: var(--ds-bg-soft);">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="submit" id="editGroupSubmitBtn" form="editGroupForm" class="btn btn-primary" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none;" disabled>
          <i class="fas fa-save"></i> Зберегти зміни
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border: 1px solid var(--ds-border); background: var(--ds-card-bg);">
      <div class="modal-header" style="border-bottom: 1px solid var(--ds-border); background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
        <h5 class="modal-title" style="color: white; font-weight: 600;">
          <i class="fas fa-exclamation-triangle"></i> Підтвердження видалення
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 2rem;">
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <i class="fas fa-trash-alt" style="font-size: 3rem; color: #ef4444;"></i>
        </div>
        <p style="text-align: center; font-size: 1.1rem; margin-bottom: 0.5rem; font-weight: 600;" id="confirmDeleteTitle">
          Ви впевнені?
        </p>
        <p style="text-align: center; color: var(--ds-text-muted); margin-bottom: 1.5rem;" id="confirmDeleteMessage">
          Ця дія незворотна
        </p>
        <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444;">
          <strong style="color: #ef4444;">Увага!</strong> Після видалення відновити дані буде неможливо.
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid var(--ds-border); padding: 1rem 2rem;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 0.75rem 1.5rem;">
          <i class="fas fa-times"></i> Скасувати
        </button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger" style="padding: 0.75rem 1.5rem;">
          <i class="fas fa-trash"></i> Так, видалити
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="promoToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="promoToastBody" style="color: white;">
        <!-- Повідомлення -->
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Стили перенесены в promocodes.css -->
<!-- Все стили теперь в отдельном файле promocodes.css для лучшей организации и поддержки -->

<!-- Данные для графиков в JSON формате -->
{% if promo_tab == 'stats' %}
<script type="application/json" id="topPromosData">
{
  "labels": [
    {% if top_promos %}{% for promo in top_promos %}"{{ promo.code|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}
  ],
  "values": [
    {% if top_promos %}{% for promo in top_promos %}{{ promo.usage_count|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}
  ]
}
</script>

<script type="application/json" id="topGroupsData">
{
  "labels": [
    {% if top_groups %}{% for group in top_groups %}"{{ group.name|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}
  ],
  "values": [
    {% if top_groups %}{% for group in top_groups %}{{ group.usage_count|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}
  ]
}
</script>
{% endif %}

<script>
/* eslint-disable */
// ==================== ПРОМОКОДИ: AJAX & MODALS ====================

// Допоміжна функція: показати toast повідомлення
function showToast(message, type = 'success') {
  const toastEl = document.getElementById('promoToast');
  const toastBody = document.getElementById('promoToastBody');
  
  // Встановити колір залежно від типу
  const colors = {
    success: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    error: 'linear-gradient(135deg, #f5576c 0%, #c0392b 100%)',
    warning: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    info: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
  };
  
  toastEl.style.background = colors[type] || colors.success;
  toastBody.textContent = message;
  
  const toast = new bootstrap.Toast(toastEl, {
    animation: true,
    autohide: true,
    delay: 5000
  });
  
  toast.show();
}

// Допоміжна функція: отримати CSRF токен
function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// ==================== ОБРОБНИКИ КНОПОК ====================

// Обробники для кнопок з data-атрибутами
document.addEventListener('click', function(e) {
  const target = e.target.closest('[data-action]');
  if (!target) return;
  
  const action = target.dataset.action;
  
  if (action === 'edit-promo') {
    const promoId = target.dataset.promoId;
    if (promoId) {
      openEditPromoModal(parseInt(promoId));
    }
  } else if (action === 'delete-promo') {
    const promoId = target.dataset.promoId;
    const promoCode = target.dataset.promoCode;
    if (promoId && promoCode) {
      confirmDelete('promo', parseInt(promoId), promoCode);
    }
  } else if (action === 'edit-group') {
    const groupId = target.dataset.groupId;
    if (groupId) {
      openEditGroupModal(parseInt(groupId));
    }
  }
});

// ==================== СТВОРЕННЯ ПРОМОКОДА ====================

function setupPromoTypeBehavior(form) {
  if (!form) return;
  const typeSelect = form.querySelector('[name="promo_type"]');
  const percentInput = form.querySelector('[name="discount"]');
  const fixedInput = form.querySelector('[name="fixed_amount"]');

  if (!typeSelect || !percentInput || !fixedInput) return;

  const toggle = () => {
    const isVoucher = typeSelect.value === 'voucher';

    percentInput.disabled = isVoucher;
    percentInput.required = !isVoucher;
    if (isVoucher) {
      percentInput.value = '';
      percentInput.classList.remove('is-invalid');
    }

    fixedInput.disabled = !isVoucher;
    fixedInput.required = isVoucher;
    if (!isVoucher) {
      fixedInput.value = '';
      fixedInput.classList.remove('is-invalid');
    }
  };

  typeSelect.addEventListener('change', toggle);
  toggle();
}

const createPromoForm = document.getElementById('createPromoForm');
if (createPromoForm) {
  setupPromoTypeBehavior(createPromoForm);

  createPromoForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  this.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
  
  // Валідація Bootstrap
  if (!this.checkValidity()) {
    e.stopPropagation();
    this.classList.add('was-validated');
    return;
  }
  
  const formData = new FormData(this);
  const submitBtn = document.querySelector('button[form="createPromoForm"]');
  const originalBtnText = submitBtn ? submitBtn.innerHTML : '';
  
  // Показати індикатор завантаження
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Створення...';
  }
  
  try {
    const response = await fetch('{% url "admin_promocode_create" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('✅ Промокод успішно створено!', 'success');
      
      // Закрити модалку
      const modal = bootstrap.Modal.getInstance(document.getElementById('createPromoModal'));
      modal.hide();
      
      // Очистити форму
      this.reset();
      this.classList.remove('was-validated');
      
      // Перезавантажити сторінку для оновлення списку
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } else {
      showToast('❌ Помилка: ' + (data.error || 'Невідома помилка'), 'error');
      
      // Показати помилки полів
      if (data.errors) {
        Object.entries(data.errors).forEach(([field, messages]) => {
          let targetField = field;
          if (field === 'discount_value') {
            const typeSelect = this.querySelector('[name="promo_type"]');
            const currentType = typeSelect ? typeSelect.value : 'regular';
            targetField = currentType === 'voucher' ? 'fixed_amount' : 'discount';
          } else if (field === 'max_uses') {
            targetField = 'usage_limit';
          }

          const input = this.querySelector(`[name="${targetField}"]`);
          if (input) {
            input.classList.add('is-invalid');
            let feedback = null;
            if (input.parentElement) {
              feedback = input.parentElement.querySelector('.invalid-feedback');
            }
            if (!feedback) {
              feedback = input.nextElementSibling;
            }
            if (feedback && messages.length) {
              feedback.textContent = messages[0];
            }
          }
        });
      }
    }
  } catch (error) {
    console.error('Помилка створення промокода:', error);
    showToast('❌ Помилка з\'єднання з сервером', 'error');
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    }
  }
});
}

// ==================== РЕДАГУВАННЯ ПРОМОКОДА ====================

async function openEditPromoModal(promoId) {
  const modal = new bootstrap.Modal(document.getElementById('editPromoModal'));
  const modalBody = document.getElementById('editPromoModalBody');
  const submitBtn = document.getElementById('editPromoSubmitBtn');
  
  // Показати skeleton loader
  modalBody.innerHTML = `
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Завантаження...</span>
      </div>
      <p class="mt-3" style="color: var(--ds-text-muted);">Завантаження даних промокода...</p>
    </div>
  `;
  
  submitBtn.disabled = true;
  modal.show();
  
  try {
    const response = await fetch(`/admin-panel/promocode/${promoId}/get-form/`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    if (!response.ok) throw new Error('Помилка завантаження');
    
    const data = await response.json();
    
    if (data.success) {
      // Заповнити форму даними
      modalBody.innerHTML = `
        <form id="editPromoForm" class="needs-validation" novalidate>
          ${document.querySelector('[name=csrfmiddlewaretoken]').outerHTML}
          <input type="hidden" name="promo_id" value="${promoId}">
          
          <div class="row g-3">
            <!-- Аналогічні поля як у createPromoForm -->
            <div class="col-md-6">
              <label for="edit_promo_code" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-tag"></i> Код промокода
              </label>
              <input type="text" class="form-control" id="edit_promo_code" name="code" 
                     value="${data.promo.code || ''}" pattern="[A-Z0-9_-]+" required
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_type" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-shapes"></i> Тип промокода
              </label>
              <select class="form-select" id="edit_promo_type" name="promo_type" required style="border: 1px solid var(--ds-border);">
                <option value="regular" ${data.promo.promo_type === 'regular' ? 'selected' : ''}>Звичайний промокод</option>
                <option value="grouped" ${data.promo.promo_type === 'grouped' ? 'selected' : ''}>Груповий промокод</option>
                <option value="voucher" ${data.promo.promo_type === 'voucher' ? 'selected' : ''}>Ваучер</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_discount" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-percent"></i> Знижка (%)
              </label>
              <input type="number" class="form-control" id="edit_promo_discount" name="discount" 
                     value="${data.promo.discount || ''}" min="0" max="100" step="0.01"
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_fixed_amount" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-money-bill-wave"></i> Фіксована сума (₴)
              </label>
              <input type="number" class="form-control" id="edit_promo_fixed_amount" name="fixed_amount" 
                     value="${data.promo.fixed_amount || ''}" min="0" step="0.01"
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_group" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-layer-group"></i> Група
              </label>
              <select class="form-select" id="edit_promo_group" name="group" style="border: 1px solid var(--ds-border);">
                <option value="">Без групи</option>
                ${data.groups.map(g => `<option value="${g.id}" ${g.id === data.promo.group_id ? 'selected' : ''}>${g.name}</option>`).join('')}
              </select>
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_min_order" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-shopping-cart"></i> Мінімальна сума замовлення (₴)
              </label>
              <input type="number" class="form-control" id="edit_promo_min_order" name="min_order_amount" 
                     value="${data.promo.min_order_amount || ''}" min="0" step="0.01"
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_uses" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-hashtag"></i> Кількість використань
              </label>
              <input type="number" class="form-control" id="edit_promo_uses" name="usage_limit" 
                     value="${data.promo.usage_limit || ''}" min="0"
                     style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <div class="form-check" style="margin-top: 2rem;">
                <input class="form-check-input" type="checkbox" id="edit_promo_one_time" name="one_time_per_user"
                       ${data.promo.one_time_per_user ? 'checked' : ''} style="border: 1px solid var(--ds-border);">
                <label class="form-check-label" for="edit_promo_one_time" style="color: var(--ds-text);">
                  <i class="fas fa-user-check"></i> Один раз на користувача
                </label>
              </div>
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_valid_from" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-calendar-alt"></i> Діє з
              </label>
              <input type="datetime-local" class="form-control" id="edit_promo_valid_from" name="valid_from"
                     value="${data.promo.valid_from || ''}" style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-md-6">
              <label for="edit_promo_valid_until" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-calendar-times"></i> Діє до
              </label>
              <input type="datetime-local" class="form-control" id="edit_promo_valid_until" name="valid_until"
                     value="${data.promo.valid_until || ''}" style="border: 1px solid var(--ds-border);">
            </div>
            
            <div class="col-12">
              <label for="edit_promo_description" class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-align-left"></i> Опис
              </label>
              <textarea class="form-control" id="edit_promo_description" name="description" rows="3"
                        style="border: 1px solid var(--ds-border);">${data.promo.description || ''}</textarea>
            </div>
            
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="edit_promo_is_active" name="is_active"
                       ${data.promo.is_active ? 'checked' : ''} style="border: 1px solid var(--ds-border);">
                <label class="form-check-label" for="edit_promo_is_active" style="color: var(--ds-text);">
                  <i class="fas fa-check-circle"></i> Активний промокод
                </label>
              </div>
            </div>
          </div>
        </form>
      `;
      
      setupPromoTypeBehavior(document.getElementById('editPromoForm'));

      submitBtn.disabled = false;
      
      // Додати обробник submit для editPromoForm
      document.getElementById('editPromoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        this.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        
        if (!this.checkValidity()) {
          e.stopPropagation();
          this.classList.add('was-validated');
          return;
        }
        
        const formData = new FormData(this);
        submitBtn.disabled = true;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Збереження...';
        
        try {
          const response = await fetch(`/admin-panel/promocode/${promoId}/edit-ajax/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCSRFToken(),
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            showToast('✅ Промокод успішно оновлено!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPromoModal'));
            modal.hide();
            setTimeout(() => window.location.reload(), 1000);
          } else {
            showToast('❌ Помилка: ' + (result.error || 'Невідома помилка'), 'error');
            if (result.errors) {
              Object.entries(result.errors).forEach(([field, messages]) => {
                let targetField = field;
                if (field === 'discount_value') {
                  const typeSelect = this.querySelector('[name="promo_type"]');
                  const currentType = typeSelect ? typeSelect.value : 'regular';
                  targetField = currentType === 'voucher' ? 'fixed_amount' : 'discount';
                } else if (field === 'max_uses') {
                  targetField = 'usage_limit';
                }
                const input = this.querySelector(`[name="${targetField}"]`);
                if (input) {
                  input.classList.add('is-invalid');
                  let feedback = null;
                  if (input.parentElement) {
                    feedback = input.parentElement.querySelector('.invalid-feedback');
                  }
                  if (!feedback) {
                    feedback = input.nextElementSibling;
                  }
                  if (feedback && messages.length) {
                    feedback.textContent = messages[0];
                  }
                }
              });
            }
          }
        } catch (error) {
          console.error('Помилка оновлення промокода:', error);
          showToast('❌ Помилка з\'єднання', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });
      
    } else {
      throw new Error(data.error || 'Помилка завантаження даних');
    }
  } catch (error) {
    console.error('Помилка завантаження форми:', error);
    modalBody.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> Помилка завантаження даних промокода
      </div>
    `;
    showToast('❌ Не вдалося завантажити дані', 'error');
  }
}

// ==================== СТВОРЕННЯ ГРУПИ ====================

const createGroupForm = document.getElementById('createGroupForm');
if (createGroupForm) {
  createGroupForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!this.checkValidity()) {
    e.stopPropagation();
    this.classList.add('was-validated');
    return;
  }
  
  const formData = new FormData(this);
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalBtnText = submitBtn.innerHTML;
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Створення...';
  
  try {
    const response = await fetch('{% url "admin_promo_group_create" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCSRFToken(),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('✅ Групу успішно створено!', 'success');
      const modal = bootstrap.Modal.getInstance(document.getElementById('createGroupModal'));
      modal.hide();
      this.reset();
      this.classList.remove('was-validated');
      setTimeout(() => window.location.reload(), 1000);
    } else {
      showToast('❌ Помилка: ' + (data.error || 'Невідома помилка'), 'error');
    }
  } catch (error) {
    console.error('Помилка створення групи:', error);
    showToast('❌ Помилка з\'єднання з сервером', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;
  }
});
}

// ==================== РЕДАГУВАННЯ ГРУПИ ====================

async function openEditGroupModal(groupId) {
  const modal = new bootstrap.Modal(document.getElementById('editGroupModal'));
  const modalBody = document.getElementById('editGroupModalBody');
  const submitBtn = document.getElementById('editGroupSubmitBtn');
  
  modalBody.innerHTML = `
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Завантаження...</span>
      </div>
      <p class="mt-3" style="color: var(--ds-text-muted);">Завантаження даних групи...</p>
    </div>
  `;
  
  submitBtn.disabled = true;
  modal.show();
  
  try {
    const response = await fetch(`/admin-panel/promo-group/${groupId}/get-form/`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    });
    
    if (!response.ok) throw new Error('Помилка завантаження');
    
    const data = await response.json();
    
    if (data.success) {
      modalBody.innerHTML = `
        <form id="editGroupForm" class="needs-validation" novalidate>
          ${document.querySelector('[name=csrfmiddlewaretoken]').outerHTML}
          <input type="hidden" name="group_id" value="${groupId}">
          
          <div class="mb-3">
            <label for="edit_group_name" class="form-label" style="color: var(--ds-text); font-weight: 500;">
              <i class="fas fa-tag"></i> Назва групи
            </label>
            <input type="text" class="form-control" id="edit_group_name" name="name" 
                   value="${data.group.name || ''}" required style="border: 1px solid var(--ds-border);">
            <div class="invalid-feedback">Введіть назву групи</div>
          </div>
          
          <div class="mb-3">
            <label for="edit_group_description" class="form-label" style="color: var(--ds-text); font-weight: 500;">
              <i class="fas fa-align-left"></i> Опис
            </label>
            <textarea class="form-control" id="edit_group_description" name="description" rows="3"
                      style="border: 1px solid var(--ds-border);">${data.group.description || ''}</textarea>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="edit_group_one_per_account" name="one_per_account"
                     ${data.group.one_per_account ? 'checked' : ''} style="border: 1px solid var(--ds-border);">
              <label class="form-check-label" for="edit_group_one_per_account" style="color: var(--ds-text);">
                <i class="fas fa-user-lock"></i> Один промокод з групи на акаунт
              </label>
              <div class="form-text" style="color: var(--ds-text-muted);">
                Користувач зможе використати тільки один промокод з цієї групи
              </div>
            </div>
          </div>
          
          ${data.promocodes.length > 0 ? `
            <div class="mb-3">
              <label class="form-label" style="color: var(--ds-text); font-weight: 500;">
                <i class="fas fa-list"></i> Промокоди в групі (${data.promocodes.length})
              </label>
              <div class="list-group">
                ${data.promocodes.map(p => `
                  <div class="list-group-item d-flex justify-content-between align-items-center" 
                       style="background: var(--ds-bg-soft); border: 1px solid var(--ds-border);">
                    <div>
                      <strong style="color: var(--ds-primary);">${p.code}</strong>
                      <span class="badge ${p.is_active ? 'bg-success' : 'bg-secondary'} ms-2">
                        ${p.is_active ? 'Активний' : 'Неактивний'}
                      </span>
                    </div>
                    <small style="color: var(--ds-text-muted);">
                      Використань: ${p.times_used}${p.usage_limit ? '/' + p.usage_limit : ''}
                    </small>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : '<p style="color: var(--ds-text-muted);"><i>Немає промокодів у цій групі</i></p>'}
        </form>
      `;
      
      submitBtn.disabled = false;
      
      document.getElementById('editGroupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
          e.stopPropagation();
          this.classList.add('was-validated');
          return;
        }
        
        const formData = new FormData(this);
        submitBtn.disabled = true;
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Збереження...';
        
        try {
          const response = await fetch(`/admin-panel/promo-group/${groupId}/edit-ajax/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCSRFToken(),
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            showToast('✅ Групу успішно оновлено!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editGroupModal'));
            modal.hide();
            setTimeout(() => window.location.reload(), 1000);
          } else {
            showToast('❌ Помилка: ' + (result.error || 'Невідома помилка'), 'error');
          }
        } catch (error) {
          console.error('Помилка оновлення групи:', error);
          showToast('❌ Помилка з\'єднання', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });
      
    } else {
      throw new Error(data.error || 'Помилка завантаження даних');
    }
  } catch (error) {
    console.error('Помилка завантаження форми групи:', error);
    modalBody.innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> Помилка завантаження даних групи
      </div>
    `;
    showToast('❌ Не вдалося завантажити дані', 'error');
  }
}

// ==================== ОЧИЩЕННЯ ФОРМ ПРИ ЗАКРИТТІ МОДАЛОК ====================

const createPromoModalEl = document.getElementById('createPromoModal');
if (createPromoModalEl) {
  createPromoModalEl.addEventListener('hidden.bs.modal', function () {
  const form = document.getElementById('createPromoForm');
    if (form) {
  form.reset();
  form.classList.remove('was-validated');
    }
});
}

const createGroupModalEl = document.getElementById('createGroupModal');
if (createGroupModalEl) {
  createGroupModalEl.addEventListener('hidden.bs.modal', function () {
  const form = document.getElementById('createGroupForm');
    if (form) {
  form.reset();
  form.classList.remove('was-validated');
    }
});
}

// ==================== DRAG & DROP ПРОМОКОДІВ ====================

let draggedPromoId = null;
let draggedPromoEl = null;

function handlePromoDragStart(event) {
  draggedPromoId = event.target.dataset.promoId;
  draggedPromoEl = event.target;
  
  event.target.style.opacity = '0.4';
  event.target.classList.add('is-dragging');
  
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/html', event.target.innerHTML);
  
  console.log('Drag start:', draggedPromoId);
}

function handlePromoDragEnd(event) {
  event.target.style.opacity = '1';
  event.target.classList.remove('is-dragging');
  
  // Прибрати highlight з усіх drop zones
  document.querySelectorAll('.promo-drop-zone').forEach(zone => {
    zone.classList.remove('is-drag-over');
  });
}

function handleGroupDragOver(event) {
  if (event.preventDefault) {
    event.preventDefault(); // Дозволяє drop
  }
  
  event.dataTransfer.dropEffect = 'move';
  event.currentTarget.classList.add('is-drag-over');
  
  return false;
}

function handleGroupDragLeave(event) {
  event.currentTarget.classList.remove('is-drag-over');
}

async function handleGroupDrop(event) {
  if (event.stopPropagation) {
    event.stopPropagation(); // Зупиняємо поширення події
  }
  
  event.preventDefault();
  event.currentTarget.classList.remove('is-drag-over');
  
  const targetGroupId = event.currentTarget.dataset.groupId;
  const currentGroupId = draggedPromoEl.dataset.groupId;
  
  // Якщо промокод вже в цій групі - нічого не робимо
  if (targetGroupId === currentGroupId) {
    showToast('Промокод вже в цій групі', 'info');
    return false;
  }
  
  console.log(`Moving promo ${draggedPromoId} to group ${targetGroupId}`);
  
  try {
    const response = await fetch(`/admin-panel/promocode/${draggedPromoId}/change-group/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken(),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        group_id: targetGroupId
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast(`✅ Промокод переміщено до групи "${data.group_name}"`, 'success');
      
      // Оновити групу в DOM
      draggedPromoEl.dataset.groupId = targetGroupId;
      
      // Оновити кольоровий маркер
      const oldMarker = draggedPromoEl.querySelector('.promo-group-marker');
      if (oldMarker) {
        oldMarker.remove();
      }
      
      if (targetGroupId) {
        const newColor = getGroupColor(parseInt(targetGroupId));
        const newMarker = document.createElement('div');
        newMarker.className = 'promo-group-marker';
        newMarker.style.background = newColor;
        newMarker.title = 'Група: ' + data.group_name;
        draggedPromoEl.prepend(newMarker);
      }
      
      // Оновити відображення групи в картці промокода
      const groupEl = draggedPromoEl.querySelector('.ds-promo-card__group');
      const actionsEl = draggedPromoEl.querySelector('.ds-promo-card__actions');
      
      if (targetGroupId && data.group_name) {
        // Якщо перемістили в групу
        if (groupEl) {
          groupEl.innerHTML = `
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3z"/>
            </svg>
            ${data.group_name}
          `;
        } else if (actionsEl) {
          // Додати елемент групи якщо його не було
          const groupHtml = `
            <div class="ds-promo-card__group">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3z"/>
              </svg>
              ${data.group_name}
            </div>
          `;
          actionsEl.insertAdjacentHTML('beforebegin', groupHtml);
        }
      } else {
        // Якщо прибрали з групи (переміщено в "Без групи")
        if (groupEl) {
          groupEl.remove();
        }
      }
      
      // Оновити лічильник промокодів в групах
      updateGroupCounters();
      
      // Анімація успіху
      draggedPromoEl.classList.add('drop-success');
      setTimeout(() => {
        draggedPromoEl.classList.remove('drop-success');
      }, 1000);
      
    } else {
      showToast(`❌ Помилка: ${data.error}`, 'error');
    }
  } catch (error) {
    console.error('Error moving promo:', error);
    showToast('❌ Помилка переміщення промокода', 'error');
  }
  
  return false;
}

// ==================== ВІЗУАЛЬНА ІНДИКАЦІЯ ГРУП ====================

// Генерація кольору на основі ID групи (детермінований)
function getGroupColor(groupId) {
  const colors = [
    '#667eea', // Purple
    '#f093fb', // Pink
    '#4facfe', // Blue
    '#43e97b', // Green
    '#fa709a', // Rose
    '#feca57', // Yellow
    '#ff6b6b', // Red
    '#4ecdc4', // Teal
    '#a29bfe', // Lavender
    '#fd79a8', // Hot Pink
    '#fdcb6e', // Orange
    '#00b894', // Emerald
  ];
  
  return colors[groupId % colors.length];
}

// Застосувати кольори до груп та промокодів
function applyGroupColors() {
  // Додати кольорові індикатори до group cards
  document.querySelectorAll('.ds-group-card[data-group-id]').forEach(card => {
    const groupId = parseInt(card.dataset.groupId);
    const color = getGroupColor(groupId);
    
    // Додати кольоровий маркер
    if (!card.querySelector('.group-color-marker')) {
      const marker = document.createElement('div');
      marker.className = 'group-color-marker';
      marker.style.background = color;
      const header = card.querySelector('.ds-group-card__header');
      if (header) {
        header.prepend(marker);
      }
    }
  });
  
  // Додати кольорові маркери до promo cards
  document.querySelectorAll('.ds-promo-card[data-group-id]').forEach(card => {
    const groupId = card.dataset.groupId;
    if (groupId && groupId !== '') {
      const color = getGroupColor(parseInt(groupId));
      
      // Додати кольоровий маркер якщо його ще немає
      if (!card.querySelector('.promo-group-marker')) {
        const marker = document.createElement('div');
        marker.className = 'promo-group-marker';
        marker.style.background = color;
        card.prepend(marker);
      }
    }
  });
}

// Ініціалізувати кольори та лічильники при завантаженні
document.addEventListener('DOMContentLoaded', function() {
  applyGroupColors();
  updateGroupCounters();
});

// ==================== ЛІЧИЛЬНИК ПРОМОКОДІВ В ГРУПІ ====================

// Оновити лічильник промокодів в групі та відповідні зони дропа
function updateGroupCounter(groupId) {
  const normalizedId = groupId === undefined || groupId === null ? '' : groupId.toString();
  const isUngrouped = normalizedId === '';
  const selector = isUngrouped
    ? '.ds-promo-card[data-group-id=""], .ds-promo-card:not([data-group-id])'
    : `.ds-promo-card[data-group-id="${normalizedId}"]`;
  
  const promoCards = document.querySelectorAll(selector);
  const totalPromos = promoCards.length;
  const activePromos = Array.from(promoCards).filter(card => !card.classList.contains('is-inactive')).length;
  
  if (!isUngrouped) {
    const groupCard = document.querySelector(`.ds-group-card[data-group-id="${normalizedId}"]`);
    if (groupCard) {
      const totalCounter = groupCard.querySelector('.ds-metric:first-child .ds-metric__value');
      const activeCounter = groupCard.querySelector('.ds-metric:nth-child(2) .ds-metric__value');
      
      if (totalCounter) {
        const oldValue = parseInt(totalCounter.textContent, 10);
        totalCounter.textContent = totalPromos;
        
        if (oldValue !== totalPromos) {
          totalCounter.style.animation = 'none';
          setTimeout(() => {
            totalCounter.style.animation = 'counterUpdate 0.5s ease';
          }, 10);
        }
      }
      
      if (activeCounter) {
        const oldValue = parseInt(activeCounter.textContent, 10);
        activeCounter.textContent = activePromos;
        
        if (oldValue !== activePromos) {
          activeCounter.style.animation = 'none';
          setTimeout(() => {
            activeCounter.style.animation = 'counterUpdate 0.5s ease';
          }, 10);
        }
      }
    }
  }
  
  const dropZone = document.querySelector(`.ds-group-drop-zone[data-group-id="${normalizedId}"]`);
  if (dropZone) {
    const countEl = dropZone.querySelector('.ds-group-drop-zone__count');
    if (countEl) {
      const label = totalPromos === 1 ? '1 промокод' : `${totalPromos} промокодів`;
      countEl.textContent = isUngrouped ? `${label} без групи` : label;
    }
  }
  
  if (isUngrouped) {
    const noGroupCountEl = document.getElementById('noGroupCount');
    if (noGroupCountEl) {
      const label = totalPromos === 1 ? '1 промокод без групи' : `${totalPromos} промокодів без групи`;
      noGroupCountEl.textContent = label;
    }
  }
  
  return { totalPromos, activePromos };
}

// Оновити badges в sidebar
function updateSidebarBadges() {
  const totalPromos = document.querySelectorAll('.ds-promo-card').length;
  const totalGroups = document.querySelectorAll('.ds-group-card').length;
  
  const promosBadge = document.querySelector('.ds-sidebar__link[href*="tab=promocodes"] .ds-sidebar__badge');
  const groupsBadge = document.querySelector('.ds-sidebar__link[href*="tab=groups"] .ds-sidebar__badge');
  
  if (promosBadge) {
    promosBadge.textContent = totalPromos;
    promosBadge.style.animation = 'badgePulse 0.5s ease';
  }
  
  if (groupsBadge) {
    groupsBadge.textContent = totalGroups;
  }
}

// Оновити всі лічильники груп у sidebar
function updateGroupCounters() {
  // Оновити лічильник "Без групи"
  const noGroupCount = document.querySelectorAll('.ds-promo-card[data-group-id=""]').length;
  const noGroupCountEl = document.getElementById('noGroupCount');
  if (noGroupCountEl) {
    noGroupCountEl.textContent = `${noGroupCount} промокодів`;
  }
  
  // Оновити лічильники всіх груп у sidebar
  document.querySelectorAll('.ds-group-drop-zone[data-group-id]').forEach(dropZone => {
    const groupId = dropZone.dataset.groupId;
    if (!groupId) return; // Пропустити "Без групи"
    
    const count = document.querySelectorAll(`.ds-promo-card[data-group-id="${groupId}"]`).length;
    const countEl = dropZone.querySelector('.ds-group-drop-zone__count');
    if (countEl) {
      countEl.textContent = `${count} промокодів`;
    }
  });
  
  // Оновити sidebar badges
  updateSidebarBadges();
}

// ==================== ФІЛЬТР ПО ГРУПАХ ====================

const groupFilterSelect = document.getElementById('groupFilter');
const clearGroupFilterBtn = document.getElementById('clearGroupFilter');

if (groupFilterSelect) {
  // Фільтрація промокодів
  groupFilterSelect.addEventListener('change', function() {
    const selectedGroup = this.value;
    const promoCards = document.querySelectorAll('.ds-promo-card');
    let visibleCount = 0;
    
    promoCards.forEach(card => {
      const cardGroupId = card.dataset.groupId;
      
      if (selectedGroup === '') {
        // Показати всі
        card.classList.remove('is-filtered-out');
        visibleCount++;
      } else if (selectedGroup === 'no-group') {
        // Показати тільки без групи
        if (!cardGroupId || cardGroupId === '') {
          card.classList.remove('is-filtered-out');
          visibleCount++;
        } else {
          card.classList.add('is-filtered-out');
        }
      } else {
        // Показати тільки з вибраною групою
        if (cardGroupId === selectedGroup) {
          card.classList.remove('is-filtered-out');
          visibleCount++;
        } else {
          card.classList.add('is-filtered-out');
        }
      }
    });
    
    // Показати/приховати кнопку очищення
    if (selectedGroup !== '') {
      clearGroupFilterBtn.style.display = 'flex';
      
      // Показати результати фільтрації
      showFilterResults(visibleCount, promoCards.length, selectedGroup);
    } else {
      clearGroupFilterBtn.style.display = 'none';
      hideFilterResults();
    }
    
    // Анімація для видимих карток
    document.querySelectorAll('.ds-promo-card:not(.is-filtered-out)').forEach((card, index) => {
      card.style.animation = 'none';
      setTimeout(() => {
        card.style.animation = `fadeIn 0.3s ease ${index * 0.05}s both`;
      }, 10);
    });
  });
  
  // Очистити фільтр
  if (clearGroupFilterBtn) {
    clearGroupFilterBtn.addEventListener('click', function() {
      groupFilterSelect.value = '';
      groupFilterSelect.dispatchEvent(new Event('change'));
    });
  }

  if (groupFilterSelect.value) {
    groupFilterSelect.dispatchEvent(new Event('change'));
  }
}

// Показати результати фільтрації
function showFilterResults(visible, total, groupValue) {
  let resultsDiv = document.querySelector('.ds-filter-results');
  
  if (!resultsDiv) {
    resultsDiv = document.createElement('div');
    resultsDiv.className = 'ds-filter-results';
    const filtersEl = document.querySelector('.ds-filters');
    if (filtersEl) {
      filtersEl.after(resultsDiv);
    }
  }
  
  let groupName = '';
  if (groupValue === 'no-group') {
    groupName = 'Без групи';
  } else {
    const optionEl = document.querySelector(`#groupFilter option[value="${groupValue}"]`);
    groupName = optionEl ? optionEl.textContent.trim() : '';
  }
  
  resultsDiv.innerHTML = `
    <i class="fas fa-filter"></i> 
    Фільтр активний: <strong>${groupName}</strong> 
    <span style="margin-left: 0.5rem; opacity: 0.7;">
      (знайдено ${visible} з ${total})
    </span>
  `;
  resultsDiv.classList.add('is-active');
}

// Приховати результати фільтрації
function hideFilterResults() {
  const resultsDiv = document.querySelector('.ds-filter-results');
  if (resultsDiv) {
    resultsDiv.classList.remove('is-active');
  }
}

// Додати fade-in анімацію
const style = document.createElement('style');
style.textContent = `
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;
document.head.appendChild(style);

console.log('✅ Promo Modals & AJAX initialized successfully!');
console.log('✅ Drag & Drop functionality enabled!');
console.log('✅ Group color indicators applied!');
console.log('✅ Real-time group counters active!');
console.log('✅ Group filter ready!');
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ==================== ГРАФІКИ CHART.JS ====================

// Конфігурація кольорів
const chartColors = {
  primary: 'rgb(102, 126, 234)',
  secondary: 'rgb(118, 75, 162)',
  success: 'rgb(76, 175, 80)',
  warning: 'rgb(255, 193, 7)',
  danger: 'rgb(239, 68, 68)',
  info: 'rgb(79, 172, 254)',
};

// Градієнти
function createGradient(ctx, color1, color2) {
  const gradient = ctx.createLinearGradient(0, 0, 0, 300);
  gradient.addColorStop(0, color1);
  gradient.addColorStop(1, color2);
  return gradient;
}

// Перевірка чи є секція Statistics активною

if (isStatsTab) {
  // ===== 1. LINE CHART: Використання по датах =====
  const usageLineCtx = document.getElementById('usageLineChart');
  if (usageLineCtx) {
    // Генеруємо дані для останніх 30 днів
    const last30Days = [];
    const usageData = [];
    const today = new Date();
    
    for (let i = 29; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      last30Days.push(date.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' }));
      // Тут має бути реальна статистика з backend
      usageData.push(Math.floor(Math.random() * 20) + 5);
    }
    
    const gradient = createGradient(usageLineCtx.getContext('2d'), 'rgba(102, 126, 234, 0.5)', 'rgba(102, 126, 234, 0.1)');
    
    new Chart(usageLineCtx, {
      type: 'line',
      data: {
        labels: last30Days,
        datasets: [{
          label: 'Використання',
          data: usageData,
          borderColor: chartColors.primary,
          backgroundColor: gradient,
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: chartColors.primary,
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleColor: '#fff',
            bodyColor: '#fff',
            cornerRadius: 8,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)',
            },
            ticks: {
              precision: 0
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  }
  
  // ===== 2. BAR CHART: TOP-10 промокодів =====
  const topPromosBarCtx = document.getElementById('topPromosBarChart');
  if (topPromosBarCtx) {
    // Дані з backend (top_promos)
    const topPromosDataScript = document.getElementById('topPromosData');
    let topPromoLabels = [];
    let topPromoValues = [];
    
    if (topPromosDataScript) {
      try {
        const data = JSON.parse(topPromosDataScript.textContent);
        topPromoLabels = data.labels || [];
        topPromoValues = data.values || [];
      } catch (e) {
        console.error('Error parsing top promos data:', e);
      }
    }
    
    // Генеруємо кольори для кожного промокода
    const barColors = topPromoLabels.map((_, index) => {
      const colors = [
        chartColors.primary,
        chartColors.secondary,
        chartColors.success,
        chartColors.info,
        chartColors.warning,
      ];
      return colors[index % colors.length];
    });
    
    new Chart(topPromosBarCtx, {
      type: 'bar',
      data: {
        labels: topPromoLabels,
        datasets: [{
          label: 'Використань',
          data: topPromoValues,
          backgroundColor: barColors.map(c => c + '80'),
          borderColor: barColors,
          borderWidth: 2,
          borderRadius: 8,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            cornerRadius: 8,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)',
            },
            ticks: {
              precision: 0
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
  }
  
  // ===== 3. PIE CHART: Розподіл по групах =====
  const groupsPieCtx = document.getElementById('groupsPieChart');
  if (groupsPieCtx) {
    // Дані з backend (top_groups)
    const topGroupsDataScript = document.getElementById('topGroupsData');
    let groupLabels = [];
    let groupValues = [];
    
    if (topGroupsDataScript) {
      try {
        const data = JSON.parse(topGroupsDataScript.textContent);
        groupLabels = data.labels || [];
        groupValues = data.values || [];
      } catch (e) {
        console.error('Error parsing top groups data:', e);
      }
    }
    
    // Генеруємо 12 кольорів (як в групах)
    const pieColors = groupLabels.map((_, index) => {
      return getGroupColor(index + 1);
    });
    
    new Chart(groupsPieCtx, {
      type: 'doughnut',
      data: {
        labels: groupLabels,
        datasets: [{
          data: groupValues,
          backgroundColor: pieColors.map(c => c + '80'),
          borderColor: pieColors,
          borderWidth: 2,
          hoverOffset: 10,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              usePointStyle: true,
              pointStyle: 'circle',
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return ` ${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }
  
  console.log('✅ Chart.js graphs initialized!');
}

// ==================== ФІЛЬТРИ ПО ДАТАХ ====================

const customDateRange = document.getElementById('customDateRange');
const dateFromInput = document.getElementById('dateFrom');
const dateToInput = document.getElementById('dateTo');
const applyCustomDatesBtn = document.getElementById('applyCustomDates');

let currentPeriod = 'all';
let customDates = null;

// Обробка кліків на date pills
datePills.forEach(pill => {
  pill.addEventListener('click', function() {
    // Деактивувати всі pills
    datePills.forEach(p => p.classList.remove('is-active'));
    
    // Активувати поточний
    this.classList.add('is-active');
    
    const period = this.dataset.period;
    currentPeriod = period;
    
    // Показати/приховати custom date range
    if (period === 'custom') {
      customDateRange.style.display = 'block';
      
      // Встановити дефолтні дати (поточний місяць)
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      
      dateFromInput.valueAsDate = firstDay;
      dateToInput.valueAsDate = today;
    } else {
      customDateRange.style.display = 'none';
      customDates = null;
      
      // Застосувати фільтр
      applyDateFilter(period);
    }
  });
});

// Застосувати custom dates
if (applyCustomDatesBtn) {
  applyCustomDatesBtn.addEventListener('click', function() {
    const dateFrom = dateFromInput.value;
    const dateTo = dateToInput.value;
    
    if (!dateFrom || !dateTo) {
      showToast('Будь ласка, оберіть обидві дати', 'warning');
      return;
    }
    
    if (new Date(dateFrom) > new Date(dateTo)) {
      showToast('Дата початку не може бути пізніше дати кінця', 'error');
      return;
    }
    
    customDates = { from: dateFrom, to: dateTo };
    applyDateFilter('custom', customDates);
    
    showToast(`Фільтр застосовано: ${formatDate(dateFrom)} - ${formatDate(dateTo)}`, 'success');
  });
}

// Функція застосування фільтра
function applyDateFilter(period, customDates = null) {
  console.log(`Applying date filter: ${period}`, customDates);
  
  // Тут має бути AJAX запит на backend для отримання відфільтрованих даних
  // Поки що просто оновлюємо графіки з наявними даними
  
  // Приклад: фільтрувати дані по періоду
  const { startDate, endDate } = getDateRange(period, customDates);
  
  console.log(`Date range: ${startDate} - ${endDate}`);
  
  // Показати індикатор активного фільтра
  showActiveFilterIndicator(period, customDates);
  
  // TODO: Оновити графіки з новими даними
  // refreshCharts(startDate, endDate);
}

// Отримати діапазон дат для періоду
function getDateRange(period, customDates = null) {
  const today = new Date();
  let startDate, endDate = today;
  
  switch (period) {
    case 'today':
      startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      break;
    case 'week':
      startDate = new Date(today);
      startDate.setDate(today.getDate() - 7);
      break;
    case 'month':
      startDate = new Date(today);
      startDate.setMonth(today.getMonth() - 1);
      break;
    case 'custom':
      if (customDates) {
        startDate = new Date(customDates.from);
        endDate = new Date(customDates.to);
      }
      break;
    default: // 'all'
      startDate = new Date(0); // Unix epoch
      break;
  }
  
  return { startDate, endDate };
}

// Показати індикатор активного фільтра
function showActiveFilterIndicator(period, customDates = null) {
  let indicatorText = '';
  
  switch (period) {
    case 'today':
      indicatorText = 'Сьогодні';
      break;
    case 'week':
      indicatorText = 'Останній тиждень';
      break;
    case 'month':
      indicatorText = 'Останній місяць';
      break;
    case 'custom':
      if (customDates) {
        indicatorText = `${formatDate(customDates.from)} - ${formatDate(customDates.to)}`;
      }
      break;
    default:
      indicatorText = 'Весь час';
      break;
  }
  
  // Оновити заголовок секції
  if (heroLead && period !== 'all') {
    heroLead.innerHTML = `
      Детальний аналіз ефективності промокодів та груп
      <br><small style="color: var(--ds-primary); font-weight: 600;">
        <i class="fas fa-filter"></i> Період: ${indicatorText}
      </small>
    `;
  } else if (heroLead) {
    heroLead.textContent = 'Детальний аналіз ефективності промокодів та груп';
  }
}

// Форматувати дату
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('uk-UA', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric' 
  });
}

console.log('✅ Date filters initialized!');

// ==================== ЕКСПОРТ СТАТИСТИКИ ====================

function exportStats(format) {
  showToast(`Експорт ${format.toUpperCase()}...`, 'info');
  
  // Параметри експорту
  const params = new URLSearchParams({
    format: format,
    period: currentPeriod,
  });
  
  // Додати кастомні дати якщо є
  if (currentPeriod === 'custom' && customDates) {
    params.append('date_from', customDates.from);
    params.append('date_to', customDates.to);
  }
  
  // Створити посилання на завантаження
  const url = `/admin-panel/promo-export/?${params.toString()}`;
  
  // Створити тимчасове посилання та клікнути
  const link = document.createElement('a');
  link.href = url;
  link.download = `promo_stats_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : format}`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Показати успіх через секунду
  setTimeout(() => {
    showToast(`✅ ${format.toUpperCase()} файл завантажено!`, 'success');
  }, 1000);
}

console.log('✅ Export functions ready!');

// ==================== BOOTSTRAP TOOLTIPS ====================

// Ініціалізувати всі tooltips
document.addEventListener('DOMContentLoaded', function() {
  // Bootstrap 5 tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], [title]'));
  tooltipTriggerList.forEach(function (tooltipTriggerEl) {
    // Додати data-bs-toggle якщо є title але немає атрибута
    if (tooltipTriggerEl.hasAttribute('title') && !tooltipTriggerEl.hasAttribute('data-bs-toggle')) {
      tooltipTriggerEl.setAttribute('data-bs-toggle', 'tooltip');
    }
    
    // Ініціалізувати tooltip
    new bootstrap.Tooltip(tooltipTriggerEl, {
      placement: 'top',
      trigger: 'hover',
      delay: { show: 300, hide: 100 },
      animation: true,
    });
  });
  
  console.log(`✅ ${tooltipTriggerList.length} tooltips initialized!`);
});

// ==================== DARK MODE ====================

const darkModeToggle = document.getElementById('darkModeToggle');
const darkModeIcon = document.getElementById('darkModeIcon');

// Перевірити збережену тему
const savedTheme = localStorage.getItem('promoTheme');
if (savedTheme === 'dark') {
  document.body.classList.add('dark-mode');
  darkModeIcon.classList.remove('fa-moon');
  darkModeIcon.classList.add('fa-sun');
}

// Перемикач теми
if (darkModeToggle) {
  darkModeToggle.addEventListener('click', function() {
    document.body.classList.toggle('dark-mode');
    
    const isDark = document.body.classList.contains('dark-mode');
    
    // Змінити іконку
    if (isDark) {
      darkModeIcon.classList.remove('fa-moon');
      darkModeIcon.classList.add('fa-sun');
      localStorage.setItem('promoTheme', 'dark');
      showToast('🌙 Темний режим активовано', 'info');
    } else {
      darkModeIcon.classList.remove('fa-sun');
      darkModeIcon.classList.add('fa-moon');
      localStorage.setItem('promoTheme', 'light');
      showToast('☀️ Світлий режим активовано', 'info');
    }
    
    // Анімація перемикання
    darkModeToggle.style.animation = 'spin 0.5s ease';
    setTimeout(() => {
      darkModeToggle.style.animation = '';
    }, 500);
  });
}

// Анімація обертання
const spinStyle = document.createElement('style');
spinStyle.textContent = `
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(spinStyle);

console.log('✅ Dark mode initialized!');

// ==================== CONFIRM DELETE ====================

let deleteTarget = null;

function confirmDelete(type, id, name) {
  deleteTarget = { type, id, name };
  
  const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
  const title = document.getElementById('confirmDeleteTitle');
  const message = document.getElementById('confirmDeleteMessage');
  
  if (type === 'promo') {
    title.textContent = `Видалити промокод "${name}"?`;
    message.textContent = `Промокод "${name}" та всі пов'язані дані будуть видалені назавжди.`;
  } else if (type === 'group') {
    title.textContent = `Видалити групу "${name}"?`;
    message.textContent = `Група "${name}" буде видалена. Промокоди в групі залишаться.`;
  }
  
  modal.show();
}

const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
if (confirmDeleteBtn) {
  confirmDeleteBtn.addEventListener('click', function() {
  if (!deleteTarget) return;
  
  const { type, id } = deleteTarget;
  let url = '';
  
  if (type === 'promo') {
    url = `/admin-panel/promocode/${id}/delete/`;
  } else if (type === 'group') {
    url = `/admin-panel/promo-group/${id}/delete/`;
  }
  
  // Показати loading
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Видалення...';
  
  // Редірект на URL видалення
  window.location.href = url;
  });
}

console.log('✅ Confirm delete initialized!');

// ==================== ШВИДКИЙ ПОШУК ====================

const searchInput = document.getElementById('promoSearch');
const clearSearchBtn = document.getElementById('clearSearch');
let searchTimeout;

if (searchInput) {
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const searchTerm = this.value.toLowerCase().trim();
    
    // Debounce для продуктивності
    searchTimeout = setTimeout(() => {
      filterPromos(searchTerm);
      
      // Показати/приховати кнопку очищення
      if (searchTerm) {
        clearSearchBtn.style.display = 'flex';
      } else {
        clearSearchBtn.style.display = 'none';
      }
    }, 300);
  });
}

if (clearSearchBtn) {
  clearSearchBtn.addEventListener('click', function() {
    searchInput.value = '';
    filterPromos('');
    this.style.display = 'none';
    searchInput.focus();
  });
}

function filterPromos(searchTerm) {
  let visibleCount = 0;
  
  promoCards.forEach(card => {
    // Отримати текст для пошуку
    
    const searchableText = `${code} ${desc} ${discount}`;
    
    if (!searchTerm || searchableText.includes(searchTerm)) {
      card.style.display = '';
      visibleCount++;
      
      // Highlight matches
      if (searchTerm) {
        highlightText(card, searchTerm);
      } else {
        removeHighlight(card);
      }
    } else {
      card.style.display = 'none';
      removeHighlight(card);
    }
  });
  
  // Показати результати
  if (searchTerm) {
    showToast(`Знайдено: ${visibleCount} з ${promoCards.length}`, 'info');
  }
  
  // Оновити sidebar
  updateSidebarBadges();
}

function highlightText(element, searchTerm) {
  if (codeEl && !codeEl.querySelector('.promo-highlight')) {
    const originalText = codeEl.textContent;
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    codeEl.innerHTML = originalText.replace(regex, '<span class="promo-highlight">$1</span>');
  }
}

function removeHighlight(element) {
  if (codeEl) {
    const highlightEl = codeEl.querySelector('.promo-highlight');
    if (highlightEl) {
      codeEl.textContent = codeEl.textContent;
    }
  }
}

console.log('✅ Search initialized!');

// ==================== СОРТУВАННЯ ====================

const sortSelect = document.getElementById('promoSort');

if (sortSelect) {
  sortSelect.addEventListener('change', function() {
    const sortType = this.value;
    sortPromos(sortType);
    showToast(`Сортування: ${this.options[this.selectedIndex].text}`, 'info');
  });
}

function sortPromos(sortType) {
  const grid = document.querySelector('.ds-grid');
  if (!grid) return;
  
  const promoCards = Array.from(document.querySelectorAll('.ds-promo-card'));
  if (promoCards.length === 0) return;
  
  promoCards.sort((a, b) => {
    switch (sortType) {
      case 'newest':
        // За датою створення (нові → старі)
        return parseInt(b.dataset.promoId) - parseInt(a.dataset.promoId);
      
      case 'oldest':
        // За датою створення (старі → нові)
        return parseInt(a.dataset.promoId) - parseInt(b.dataset.promoId);
      
      case 'discount-high':
      case 'discount-low': {
        // За знижкою
        const aDiscount = parseFloat(a.dataset.discountValue || '0');
        const bDiscount = parseFloat(b.dataset.discountValue || '0');
        return sortType === 'discount-high' ? bDiscount - aDiscount : aDiscount - bDiscount;
      }
      
      case 'usage-high':
      case 'usage-low': {
        // За використанням
        const aUsage = parseInt(a.dataset.currentUses || '0', 10);
        const bUsage = parseInt(b.dataset.currentUses || '0', 10);
        return sortType === 'usage-high' ? bUsage - aUsage : aUsage - bUsage;
      }
      
      case 'code-az':
      case 'code-za': {
        // За кодом
        const aCode = (a.dataset.code || '').toUpperCase();
        const bCode = (b.dataset.code || '').toUpperCase();
        return sortType === 'code-az' 
          ? aCode.localeCompare(bCode) 
          : bCode.localeCompare(aCode);
      }
      
      default:
        return 0;
    }
  });
  
  // Очистити grid
  grid.innerHTML = '';
  
  // Пере-додати картки в новому порядку
  promoCards.forEach(card => grid.appendChild(card));
  
  // Анімація
  promoCards.forEach((card, index) => {
    card.style.animation = 'none';
    setTimeout(() => {
      card.style.animation = '';
    }, 10);
  });
}

console.log('✅ Sorting initialized!');
/* eslint-enable */
</script>
