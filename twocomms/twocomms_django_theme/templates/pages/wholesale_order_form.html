{% extends "base.html" %}
{% load static %}
{% load math_filters %}

{% block title %}Формування оптового замовлення - TwoComms{% endblock %}

{% block extra_css %}
<style>
:root {
    --tc-text: rgba(255, 255, 255, 0.95);
}
.order-form-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    background: var(--tc-bg);
    min-height: 100vh;
    position: relative;
}

.order-form-container::before {
    content: '';
    position: fixed;
    inset: 0;
    z-index: -1;
    background: 
        radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.2) 0%, transparent 60%),
        radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.2) 0%, transparent 60%),
        radial-gradient(circle at 40% 40%, rgba(236, 72, 153, 0.15) 0%, transparent 60%),
        radial-gradient(circle at 60% 60%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
    animation: gradientShift 25s ease infinite;
}

.order-form-container::after {
    content: '';
    position: fixed;
    inset: 0;
    z-index: -1;
    background: 
        linear-gradient(45deg, transparent 30%, rgba(139, 92, 246, 0.03) 50%, transparent 70%),
        linear-gradient(-45deg, transparent 30%, rgba(59, 130, 246, 0.03) 50%, transparent 70%);
    animation: shimmer 15s ease infinite;
}

@keyframes gradientShift {
    0%, 100% { 
        opacity: 1; 
        transform: scale(1) rotate(0deg);
    }
    33% { 
        opacity: 0.8; 
        transform: scale(1.05) rotate(1deg);
    }
    66% { 
        opacity: 0.9; 
        transform: scale(0.95) rotate(-1deg);
    }
}

@keyframes shimmer {
    0%, 100% { 
        opacity: 0.3; 
        transform: translateX(-100%) translateY(-100%);
    }
    50% { 
        opacity: 0.6; 
        transform: translateX(100%) translateY(100%);
    }
}

/* Header Section */
.order-form-header {
    background: linear-gradient(135deg, 
        rgba(139, 92, 246, 0.1) 0%,
        rgba(59, 130, 246, 0.08) 50%,
        rgba(236, 72, 153, 0.06) 100%
    );
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    backdrop-filter: blur(20px);
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.3),
        0 8px 25px rgba(139, 92, 246, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.order-form-title {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #8b5cf6, #3b82f6, #ec4899);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
    text-align: center;
}

.order-form-subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
    text-align: center;
    margin-bottom: 0;
}

/* Company Form Section */
.company-form-section {
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.08) 0%,
        rgba(255, 255, 255, 0.04) 50%,
        rgba(255, 255, 255, 0.02) 100%
    );
    border: 1px solid rgba(139, 92, 246, 0.15);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    backdrop-filter: blur(20px);
    box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.2),
        0 4px 15px rgba(139, 92, 246, 0.05);
}

.section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-title::before {
    content: '';
    width: 4px;
    height: 24px;
    background: linear-gradient(135deg, #8b5cf6, #3b82f6);
    border-radius: 2px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-label {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 600;
    font-size: 0.95rem;
}

.form-label .required {
    color: #ef4444;
    margin-left: 0.25rem;
}

.form-input {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    color: rgba(255, 255, 255, 0.95);
    font-size: 1rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.form-input:focus {
    outline: none;
    border-color: rgba(139, 92, 246, 0.5);
    background: rgba(255, 255, 255, 0.08);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.form-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

.save-button {
    background: linear-gradient(135deg, #8b5cf6, #3b82f6);
    border: none;
    border-radius: 12px;
    padding: 0.875rem 2rem;
    color: white;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 auto;
}

.save-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
}

.save-button:active {
    transform: translateY(0);
}

/* Statistics Section */
.stats-section {
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.08) 0%,
        rgba(255, 255, 255, 0.04) 50%,
        rgba(255, 255, 255, 0.02) 100%
    );
    border: 1px solid rgba(139, 92, 246, 0.15);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    backdrop-filter: blur(20px);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.stat-card {
    background: linear-gradient(135deg, 
        rgba(139, 92, 246, 0.1) 0%,
        rgba(59, 130, 246, 0.05) 50%,
        rgba(236, 72, 153, 0.05) 100%
    );
    border: 1px solid rgba(139, 92, 246, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
}

.stat-value {
    font-size: 2rem;
    font-weight: 800;
    background: linear-gradient(135deg, #8b5cf6, #3b82f6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    font-weight: 600;
}

/* Management Grid Layout (exactly like admin store management) */
.management-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    margin-bottom: 30px;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
    padding: 0 20px;
}

.management-column {
    background: rgba(20, 22, 27, 0.85);
    backdrop-filter: blur(25px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 24px;
    padding: 10px;
    box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(139, 92, 246, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    height: 800px;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.management-column::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, 
        rgba(139, 92, 246, 0.6) 0%, 
        rgba(59, 130, 246, 0.6) 50%, 
        rgba(236, 72, 153, 0.6) 100%);
    border-radius: 24px 24px 0 0;
}

.column-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.column-icon {
    width: 24px;
    height: 24px;
    color: #667eea;
}

.column-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--tc-text);
    margin: 0;
}

.order-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
}

/* Category Filter */
.category-filter {
    margin-bottom: 5px;
}

.filter-select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    background: rgba(20, 22, 27, 0.6);
    color: var(--tc-text);
    font-size: 1rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.filter-select:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    background: rgba(20, 22, 27, 0.8);
}

/* Products Scroll Container */
.products-scroll-container {
    flex: 1;
    overflow-y: auto;
    padding-right: 8px;
    margin-right: -8px;
    padding: 0 8px 0 0;
    min-height: 0;
}

.products-scroll-container::-webkit-scrollbar {
    width: 6px;
}

.products-scroll-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

.products-scroll-container::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.6);
    border-radius: 3px;
}

.products-scroll-container::-webkit-scrollbar-thumb:hover {
    background: rgba(139, 92, 246, 0.8);
}

/* Product Cards */
.product-card {
    background: rgba(20, 22, 27, 0.7);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    padding: 8px;
    margin-bottom: 4px;
    box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.2),
        0 0 0 1px rgba(139, 92, 246, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    height: 80px;
}

.product-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(139, 92, 246, 0.1), 
        transparent);
    transition: left 0.6s ease;
}

.product-card:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 
        0 12px 30px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(139, 92, 246, 0.3),
        0 0 20px rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.4);
    background: rgba(20, 22, 27, 0.85);
}

.product-card:hover::before {
    left: 100%;
}

.product-card.dragging {
    opacity: 0.7;
    transform: rotate(3deg) scale(1.05);
    z-index: 1000;
    cursor: grabbing;
    box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.5),
        0 0 0 2px rgba(139, 92, 246, 0.6);
}

.product-card-content {
    display: flex;
    align-items: center;
    gap: 10px;
    height: 64px;
    width: 100%;
}

.product-image-container {
    flex-shrink: 0;
    width: 64px;
    height: 64px;
    border-radius: 8px;
    overflow: hidden;
    background: rgba(24, 26, 32, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 2px;
    min-width: 0;
    height: 64px;
}


.product-title-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    flex-wrap: wrap;
}

.product-category {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.65rem;
    font-weight: 500;
}

.product-name {
    color: rgba(255, 255, 255, 0.95);
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 140px;
}

.product-colors {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
    flex-wrap: wrap;
}

.color-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.color-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.3);
    display: inline-block;
    flex-shrink: 0;
    box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.2);
}

.color-name {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.6rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 80px;
}

.color-more {
    font-size: 0.55rem;
    color: rgba(232, 233, 236, 0.6);
    margin-left: 2px;
}

.product-price {
    color: #8b5cf6;
    font-weight: 700;
    font-size: 0.85rem;
    text-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
}

/* Order Form */
.order-form {
    background: rgba(20, 22, 27, 0.6);
    backdrop-filter: blur(10px);
    border: 2px dashed rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}

.form-group {
    margin-bottom: 15px;
}

.form-label {
    display: block;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 5px;
    font-size: 0.9rem;
}

.form-input {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    background: rgba(20, 22, 27, 0.6);
    color: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
}

.form-input:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    background: rgba(20, 22, 27, 0.8);
}

.form-select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    font-size: 0.9rem;
    background: rgba(20, 22, 27, 0.6);
    color: rgba(255, 255, 255, 0.95);
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.form-select:focus {
    outline: none;
    border-color: #8b5cf6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
    background: rgba(20, 22, 27, 0.8);
}

.add-to-order-btn {
    width: 100%;
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    border: 1px solid rgba(139, 92, 246, 0.3);
    padding: 12px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.add-to-order-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
}

.add-to-order-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Drop Zone */
.drop-zone {
    background: rgba(20, 22, 27, 0.6);
    backdrop-filter: blur(10px);
    border: 2px dashed rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    color: #718096;
    transition: all 0.3s ease;
    margin-bottom: 15px;
}

.drop-zone.drag-over {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
    color: #667eea;
}

.drop-zone-text {
    font-size: 1rem;
    margin-bottom: 8px;
}

.drop-zone-subtext {
    font-size: 0.8rem;
    opacity: 0.7;
}

/* Order Items Scroll Container */
.order-items-scroll-container {
    flex: 1;
    overflow-y: auto;
    padding-right: 8px;
    margin-right: -8px;
    min-height: 0;
}

.order-items-scroll-container::-webkit-scrollbar {
    width: 6px;
}

.order-items-scroll-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

.order-items-scroll-container::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.6);
    border-radius: 3px;
}

.order-items-scroll-container::-webkit-scrollbar-thumb:hover {
    background: rgba(139, 92, 246, 0.8);
}

/* Order Items */
.order-item {
    background: rgba(20, 22, 27, 0.7);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    padding: 10px;
    margin-bottom: 10px;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.25),
        0 0 0 1px rgba(139, 92, 246, 0.1);
    border-left: 3px solid #8b5cf6;
    position: relative;
    transition: all 0.3s ease;
    height: 75px;
    display: flex;
    align-items: center;
}

.order-item:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(139, 92, 246, 0.2);
    border-left-color: #7c3aed;
}

.order-item-content {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    height: 100%;
}

.order-item-image {
    flex-shrink: 0;
    width: 50px;
    height: 50px;
    align-self: center;
}

.order-product-image {
    width: 100%;
    height: 100%;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.order-item-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 3px;
    min-width: 0;
    height: 50px;
}

.order-item-title {
    font-weight: 600;
    color: var(--tc-text);
    font-size: 0.6rem;
    line-height: 1.1;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.order-item-specs-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.5rem;
    color: rgba(255, 255, 255, 0.6);
    flex-wrap: wrap;
}

.order-item-color-section {
    display: flex;
    align-items: center;
    gap: 2px;
}

.order-item-color-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: inline-block;
}

.order-item-size {
    background: rgba(139, 92, 246, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.5rem;
    white-space: nowrap;
    margin: 1px 0;
}

.order-item-quantity {
    background: rgba(16, 185, 129, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.5rem;
    white-space: nowrap;
    margin: 1px 0;
}

.order-item-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
    height: 55px;
    justify-content: space-between;
}

.remove-item-btn {
    background: rgba(239, 68, 68, 0.2);
    border: none;
    border-radius: 4px;
    padding: 4px;
    color: #ef4444;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-item-btn:hover {
    background: rgba(239, 68, 68, 0.3);
    transform: scale(1.1);
}

.order-item-prices {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
}

.order-item-cost {
    font-size: 0.55rem;
    color: #ef4444;
    font-weight: 600;
    background: rgba(239, 68, 68, 0.1);
    padding: 1px 2px;
    border-radius: 2px;
    border: 1px solid rgba(239, 68, 68, 0.2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.order-item-selling {
    font-size: 0.55rem;
    color: #10b981;
    font-weight: 600;
    background: rgba(16, 185, 129, 0.1);
    padding: 1px 2px;
    border-radius: 2px;
    border: 1px solid rgba(16, 185, 129, 0.2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Order Actions */
.order-actions {
    margin-top: 15px;
    display: flex;
    gap: 8px;
    padding: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.action-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.8rem;
}

.generate-invoice-btn {
    background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
    color: white;
}

.generate-invoice-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(237, 137, 54, 0.3);
}

.generate-invoice-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Order Statistics */
.order-statistics {
    margin-top: 15px;
    padding: 15px;
    background: rgba(20, 22, 27, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.statistics-header h4 {
    color: var(--tc-text);
    font-size: 0.9rem;
    font-weight: 600;
    margin: 0 0 10px 0;
}

.statistics-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.total-sum {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: rgba(139, 92, 246, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(139, 92, 246, 0.2);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.total-sum.highlight {
    background: rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.4);
    box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
    transform: scale(1.02);
}

.total-sum.highlight::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.2), transparent);
    animation: highlight-slide 1.5s ease-in-out;
}

@keyframes highlight-slide {
    0% { left: -100%; }
    50% { left: 0%; }
    100% { left: 100%; }
}

.sum-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.8rem;
    font-weight: 500;
}

.sum-value {
    color: #8b5cf6;
    font-size: 1rem;
    font-weight: 700;
}

.progress-info {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.4;
}

.progress-info .warning {
    color: #f59e0b;
}

.progress-info .success {
    color: #10b981;
}

/* Discount Scales */
.discount-scales {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.scale-container {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.scale-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.scale-bar {
    display: flex;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.scale-segment {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all 0.3s ease;
}

.scale-segment.active {
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    transform: scale(1.05);
}

.scale-segment.progress {
    background: linear-gradient(90deg, currentColor 0%, rgba(255, 255, 255, 0.3) 100%) !important;
}

.scale-segment.completed {
    background: #10b981;
    opacity: 0.8;
}

.scale-segment .progress-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: #10b981;
    border-radius: 3px;
    transition: width 0.3s ease;
    z-index: 1;
}

.segment-label {
    color: white;
    font-size: 0.6rem;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    z-index: 1;
}

.scale-prices {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
}

.price-item {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.6rem;
    font-weight: 500;
    text-align: center;
    flex: 1;
}

/* Generated Invoices Section */
.generated-invoices-section {
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.08) 0%,
        rgba(255, 255, 255, 0.04) 50%,
        rgba(255, 255, 255, 0.02) 100%
    );
    border: 1px solid rgba(139, 92, 246, 0.15);
    border-radius: 16px;
    padding: 2rem;
    backdrop-filter: blur(20px);
}

.invoices-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
}

.invoice-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(139, 92, 246, 0.1);
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.invoice-item:hover {
    background: rgba(139, 92, 246, 0.1);
    border-color: rgba(139, 92, 246, 0.3);
}

.invoice-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.invoice-name {
    color: rgba(255, 255, 255, 0.95);
    font-weight: 600;
}

.invoice-date {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
}

.download-button {
    background: linear-gradient(135deg, #8b5cf6, #3b82f6);
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.download-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    text-decoration: none;
    color: white;
}

/* Responsive Design */
@media (max-width: 768px) {
    .order-form-container {
        padding: 1rem;
    }
    
    .order-form-title {
        font-size: 2rem;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .two-column-layout {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .order-form-header,
    .company-form-section,
    .stats-section,
    .column,
    .generated-invoices-section {
        padding: 1.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="order-form-container">
    <!-- Header Section -->
    <div class="order-form-header">
        <h1 class="order-form-title">Формування оптового замовлення</h1>
        <p class="order-form-subtitle">Заповніть форму для створення оптового замовлення та генерації накладної</p>
    </div>

    <!-- Company Information Form -->
    <div class="company-form-section">
        <h2 class="section-title">Інформація про компанію</h2>
        <form id="company-form">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="company-name">
                        Назва компанії/магазину/ФОП
                        <span class="required">*</span>
                    </label>
                    <input type="text" id="company-name" name="company_name" class="form-input" 
                           placeholder="Введіть назву компанії або ФОП" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="delivery-address">
                        Адреса доставки
                        <span class="required">*</span>
                    </label>
                    <textarea id="delivery-address" name="delivery_address" class="form-input form-textarea" 
                              placeholder="Введіть повну адресу доставки" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="phone-number">
                        Номер телефону для зв'язку
                        <span class="required">*</span>
                    </label>
                    <input type="tel" id="phone-number" name="phone_number" class="form-input" 
                           placeholder="+380 XX XXX XX XX" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="store-link">
                        Посилання на магазин (онлайн)
                    </label>
                    <input type="url" id="store-link" name="store_link" class="form-input" 
                           placeholder="https://your-store.com (необов'язково)">
                </div>
            </div>
            
            <button type="submit" class="save-button">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                </svg>
                Зберегти інформацію
            </button>
        </form>
    </div>

    <!-- Statistics Section -->
    <div class="stats-section">
        <h2 class="section-title">Статистика оптових закупок</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ wholesale_stats.total_products }}</div>
                <div class="stat-label">Всього товарів</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ wholesale_stats.tshirt_count }}</div>
                <div class="stat-label">Футболки</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ wholesale_stats.hoodie_count }}</div>
                <div class="stat-label">Худі</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ wholesale_stats.min_order_value }}₴</div>
                <div class="stat-label">Мін. замовлення</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ wholesale_stats.max_savings_percent }}%</div>
                <div class="stat-label">Макс. економія</div>
            </div>
        </div>
    </div>

    <!-- Management Grid Layout (exactly like admin store management) -->
    <div class="management-grid">
        <!-- Колонка 1: Все товары -->
        <div class="management-column">
            <div class="column-header">
                <svg class="column-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <h3 class="column-title">Всі товари</h3>
            </div>
            
            <!-- Фильтр по категориям -->
            <div class="category-filter">
                <select class="filter-select" id="categoryFilter">
                    <option value="">Всі категорії</option>
                    <option value="tshirts">Футболки</option>
                    <option value="hoodies">Худі</option>
                </select>
            </div>
            
            <!-- Список товаров -->
            <div id="productsList" class="products-scroll-container">
                {% for product in tshirt_products %}
                    <div class="product-card" 
                         data-product-id="{{ product.id }}" 
                         data-category-id="tshirts"
                         data-product-type="tshirt"
                         draggable="true">
                        <div class="product-card-content">
                            <div class="product-image-container">
                                {% if product.main_image %}
                                    <img src="{{ product.main_image.url }}" alt="{{ product.title }}" class="product-image">
                                {% else %}
                                    <div class="product-image" style="background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #718096;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                        </svg>
                                    </div>
                                {% endif %}
                            </div>
                                <div class="product-info">
                                <div class="product-title-row">
                                    <span class="product-category">Футболки</span>
                                    <span class="product-name">{{ product.title }}</span>
                                </div>
                                <div class="product-colors">
                                    {% for color_variant in product.color_variants.all|slice:":3" %}
                                        <span class="color-item">
                                            <span class="color-dot" data-color="{{ color_variant.color.primary_hex }}"></span>
                                            <span class="color-name">{{ color_variant.color.name|default:"Чорний" }}</span>
                                        </span>
                                    {% empty %}
                                        <span class="color-item">
                                            <span class="color-dot" data-color="#000000"></span>
                                            <span class="color-name">Чорний</span>
                                        </span>
                                    {% endfor %}
                                    {% if product.color_variants.count > 3 %}
                                        <span class="color-more">+{{ product.color_variants.count|add:"-3" }}</span>
                                    {% endif %}
                                </div>
                                <div class="product-price">Опт: {{ tshirt_prices.wholesale.4 }}₴ - {{ tshirt_prices.wholesale.0 }}₴</div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                
                {% for product in hoodie_products %}
                    <div class="product-card" 
                         data-product-id="{{ product.id }}" 
                         data-category-id="hoodies"
                         data-product-type="hoodie"
                         draggable="true">
                        <div class="product-card-content">
                            <div class="product-image-container">
                                {% if product.main_image %}
                                    <img src="{{ product.main_image.url }}" alt="{{ product.title }}" class="product-image">
                                {% else %}
                                    <div class="product-image" style="background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #718096;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                        </svg>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="product-info">
                                <div class="product-title-row">
                                    <span class="product-category">Худі</span>
                                    <span class="product-name">{{ product.title }} [фліс]</span>
                                </div>
                                <div class="product-colors">
                                    <span class="color-item">
                                        <span class="color-dot" data-color="#000000"></span>
                                        <span class="color-name">Чорний</span>
                                    </span>
                                </div>
                                <div class="product-price">Опт: {{ hoodie_prices.wholesale.4 }}₴ - {{ hoodie_prices.wholesale.0 }}₴</div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Колонка 2: Формирование накладной -->
        <div class="management-column order-column">
            <div class="column-header">
                <svg class="column-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                <h3 class="column-title">Формування накладної</h3>
            </div>
            
            <div class="order-content">
                <!-- Форма добавления товара -->
                <div class="order-form" id="orderForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Розмір</label>
                        <select class="form-select" id="productSize" required>
                            <option value="">Оберіть розмір</option>
                            <option value="all">Всі ростовки (S-XL)</option>
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Колір</label>
                        <select class="form-select" id="productColor">
                            <option value="default">Чорний (дефолт)</option>
                        </select>
                    </div>
                    
                    
                    <div class="form-group">
                        <label class="form-label">Кількість</label>
                        <input type="number" class="form-input" id="quantity" min="1" value="1">
                    </div>
                    
                    <button class="add-to-order-btn" id="addToOrderBtn">Додати в накладну</button>
                </div>
                
                <!-- Зона для перетаскивания -->
                <div class="drop-zone" id="orderDropZone">
                    <div class="drop-zone-text">Перетягніть товар</div>
                    <div class="drop-zone-subtext">або клікніть на товар</div>
                </div>
                
                <!-- Список товаров в заказе -->
                <div id="orderItems" class="order-items-scroll-container" style="margin-top: 15px;">
                    <!-- Items will be added here dynamically -->
                </div>
            </div>
            
            <!-- Кнопка формирования накладной -->
            <div class="order-actions">
                <button class="action-btn generate-invoice-btn" id="generateInvoiceBtn">
                    Сформувати накладну
                </button>
            </div>
            
            <!-- Статистика заказа -->
            <div class="order-statistics" id="orderStatistics">
                <div class="statistics-header">
                    <h4>Статистика замовлення</h4>
                </div>
                
                <div class="statistics-content">
                    <div class="total-sum">
                        <span class="sum-label">Сума накладної:</span>
                        <span class="sum-value" id="totalSum">0₴</span>
                    </div>
                    
                    <div class="progress-info" id="progressInfo">
                        <!-- Динамически заполняется -->
                    </div>
                    
                    <!-- Шкалы скидок -->
                    <div class="discount-scales">
                        <div class="scale-container">
                            <div class="scale-label">Футболки</div>
                            <div class="scale-bar" id="tshirtScale">
                                <div class="scale-segment" data-range="1-7" data-price="{{ tshirt_prices.wholesale.0 }}" style="background: #ef4444;">
                                    <span class="segment-label">1-7</span>
                                </div>
                                <div class="scale-segment" data-range="8-15" data-price="{{ tshirt_prices.wholesale.0 }}" style="background: #10b981;">
                                    <span class="segment-label">8-15</span>
                                </div>
                                <div class="scale-segment" data-range="16-31" data-price="{{ tshirt_prices.wholesale.1 }}" style="background: #10b981;">
                                    <span class="segment-label">16-31</span>
                                </div>
                                <div class="scale-segment" data-range="32-63" data-price="{{ tshirt_prices.wholesale.2 }}" style="background: #10b981;">
                                    <span class="segment-label">32-63</span>
                                </div>
                                <div class="scale-segment" data-range="64-99" data-price="{{ tshirt_prices.wholesale.3 }}" style="background: #10b981;">
                                    <span class="segment-label">64-99</span>
                                </div>
                                <div class="scale-segment" data-range="100+" data-price="{{ tshirt_prices.wholesale.4 }}" style="background: #10b981;">
                                    <span class="segment-label">100+</span>
                                </div>
                            </div>
                            <div class="scale-prices">
                                <span class="price-item">{{ tshirt_prices.wholesale.0 }}₴</span>
                                <span class="price-item">{{ tshirt_prices.wholesale.1 }}₴</span>
                                <span class="price-item">{{ tshirt_prices.wholesale.2 }}₴</span>
                                <span class="price-item">{{ tshirt_prices.wholesale.3 }}₴</span>
                                <span class="price-item">{{ tshirt_prices.wholesale.4 }}₴</span>
                            </div>
                        </div>
                        
                        <div class="scale-container">
                            <div class="scale-label">Худі</div>
                            <div class="scale-bar" id="hoodieScale">
                                <div class="scale-segment" data-range="1-7" data-price="{{ hoodie_prices.wholesale.0 }}" style="background: #ef4444;">
                                    <span class="segment-label">1-7</span>
                                </div>
                                <div class="scale-segment" data-range="8-15" data-price="{{ hoodie_prices.wholesale.0 }}" style="background: #10b981;">
                                    <span class="segment-label">8-15</span>
                                </div>
                                <div class="scale-segment" data-range="16-31" data-price="{{ hoodie_prices.wholesale.1 }}" style="background: #10b981;">
                                    <span class="segment-label">16-31</span>
                                </div>
                                <div class="scale-segment" data-range="32-63" data-price="{{ hoodie_prices.wholesale.2 }}" style="background: #10b981;">
                                    <span class="segment-label">32-63</span>
                                </div>
                                <div class="scale-segment" data-range="64-99" data-price="{{ hoodie_prices.wholesale.3 }}" style="background: #10b981;">
                                    <span class="segment-label">64-99</span>
                                </div>
                                <div class="scale-segment" data-range="100+" data-price="{{ hoodie_prices.wholesale.4 }}" style="background: #10b981;">
                                    <span class="segment-label">100+</span>
                                </div>
                            </div>
                            <div class="scale-prices">
                                <span class="price-item">{{ hoodie_prices.wholesale.0 }}₴</span>
                                <span class="price-item">{{ hoodie_prices.wholesale.1 }}₴</span>
                                <span class="price-item">{{ hoodie_prices.wholesale.2 }}₴</span>
                                <span class="price-item">{{ hoodie_prices.wholesale.3 }}₴</span>
                                <span class="price-item">{{ hoodie_prices.wholesale.4 }}₴</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generated Invoices Section -->
    <div class="generated-invoices-section">
        <h2 class="section-title">Сформовані накладні</h2>
        <div class="invoices-list" id="invoices-list">
            <!-- Invoices will be dynamically added here -->
            <div style="color: rgba(255, 255, 255, 0.6); text-align: center; padding: 2rem;">
                Поки що немає сформованих накладних
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables for wholesale order management
let currentProduct = null;
let currentOrderId = null;
let orderItems = [];
let tshirtPrices = {
    drop: {{ tshirt_prices.drop }},
    wholesale: [{{ tshirt_prices.wholesale.0 }}, {{ tshirt_prices.wholesale.1 }}, {{ tshirt_prices.wholesale.2 }}, {{ tshirt_prices.wholesale.3 }}, {{ tshirt_prices.wholesale.4 }}]
};
let hoodiePrices = {
    drop: {{ hoodie_prices.drop }},
    wholesale: [{{ hoodie_prices.wholesale.0 }}, {{ hoodie_prices.wholesale.1 }}, {{ hoodie_prices.wholesale.2 }}, {{ hoodie_prices.wholesale.3 }}, {{ hoodie_prices.wholesale.4 }}]
};

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    initializeCompanyForm();
    initializeDragAndDrop();
    initializeCategoryFilter();
    initializeProductClick();
    initializeOrderForm();
    initializeColorDots();
    loadOrderData(); // Load saved data
    updateOrderStatistics(); // Initialize statistics on page load
});

// Company form handling
function initializeCompanyForm() {
    const companyForm = document.getElementById('company-form');
    const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');
    const invoicesList = document.getElementById('invoices-list');
    
    // Handle company form submission
    companyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(companyForm);
        const companyData = Object.fromEntries(formData.entries());
        
        // Store company data in localStorage
        localStorage.setItem('wholesaleCompanyData', JSON.stringify(companyData));
        saveOrderData(); // Save complete order data
        
        // Enable invoice generation button
        generateInvoiceBtn.disabled = false;
        
        // Show success message
        showNotification('Інформація про компанію збережена!', 'success');
    });
    
    // Handle invoice generation
    generateInvoiceBtn.addEventListener('click', function() {
        const companyData = localStorage.getItem('wholesaleCompanyData');
        
        if (!companyData) {
            showNotification('Спочатку заповніть інформацію про компанію', 'error');
            return;
        }
        
        if (orderItems.length === 0) {
            showNotification('Додайте товари до накладної', 'error');
            return;
        }
        
        // Simulate invoice generation
        generateInvoiceBtn.disabled = true;
        generateInvoiceBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="animate-spin">
                <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
            </svg>
            Формування накладної...
        `;
        
        setTimeout(() => {
            // Create mock invoice
            const invoice = {
                id: Date.now(),
                name: `Накладна_${new Date().toLocaleDateString('uk-UA').replace(/\./g, '_')}_${Math.random().toString(36).substr(2, 5).toUpperCase()}.xlsx`,
                date: new Date().toLocaleDateString('uk-UA'),
                company: JSON.parse(companyData).company_name
            };
            
            // Add invoice to list
            addInvoiceToList(invoice);
            
            // Clear order items
            orderItems = [];
            document.getElementById('orderItems').innerHTML = '';
            
            // Reset button
            generateInvoiceBtn.disabled = false;
            generateInvoiceBtn.innerHTML = `Сформувати накладну`;
            
            showNotification('Накладна успішно сформована!', 'success');
        }, 2000);
    });
    
    // Check if company data exists on page load
    const existingCompanyData = localStorage.getItem('wholesaleCompanyData');
    if (existingCompanyData) {
        const data = JSON.parse(existingCompanyData);
        
        // Fill form with existing data
        document.getElementById('company-name').value = data.company_name || '';
        document.getElementById('delivery-address').value = data.delivery_address || '';
        document.getElementById('phone-number').value = data.phone_number || '';
        document.getElementById('store-link').value = data.store_link || '';
        
        // Enable invoice generation
        generateInvoiceBtn.disabled = false;
    }
}

// Drag and Drop functionality (exactly like admin store management)
function initializeDragAndDrop() {
    const productCards = document.querySelectorAll('.product-card');
    const dropZone = document.getElementById('orderDropZone');
    
    productCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleDrop);
    dropZone.addEventListener('dragleave', handleDragLeave);
}

function handleDragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.setData('text/plain', e.target.dataset.productId);
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.target.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.target.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.target.classList.remove('drag-over');
    
    const productId = e.dataTransfer.getData('text/plain');
    const productCard = document.querySelector(`[data-product-id="${productId}"]`);
    
    if (productCard) {
        currentProduct = {
            id: productId,
            type: productCard.dataset.productType,
            title: productCard.querySelector('.product-name').textContent,
            image: productCard.querySelector('.product-image').src || '',
            category: productCard.querySelector('.product-category').textContent
        };
        
        showOrderForm();
    }
}

// Category filter functionality
function initializeCategoryFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    const productCards = document.querySelectorAll('.product-card');
    
    categoryFilter.addEventListener('change', function() {
        const selectedCategory = this.value;
        
        productCards.forEach(card => {
            if (selectedCategory === '' || card.dataset.categoryId === selectedCategory) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
}

// Product click functionality
function initializeProductClick() {
    const productCards = document.querySelectorAll('.product-card');
    
    productCards.forEach(card => {
        card.addEventListener('click', function() {
            currentProduct = {
                id: this.dataset.productId,
                type: this.dataset.productType,
                title: this.querySelector('.product-name').textContent,
                image: this.querySelector('.product-image').src || '',
                category: this.querySelector('.product-category').textContent
            };
            
            showOrderForm();
        });
    });
}

// Order form functionality
function initializeOrderForm() {
    const addToOrderBtn = document.getElementById('addToOrderBtn');
    
    addToOrderBtn.addEventListener('click', function() {
        addToOrder();
    });
    
    // Handle size change
    const sizeSelect = document.getElementById('productSize');
    sizeSelect.addEventListener('change', function() {
        const quantityInput = document.getElementById('quantity');
        if (this.value === 'all') {
            quantityInput.value = '4';
            quantityInput.disabled = true;
            quantityInput.style.opacity = '0.6';
        } else {
            quantityInput.disabled = false;
            quantityInput.style.opacity = '1';
            if (quantityInput.value === '4') {
                quantityInput.value = '1';
            }
        }
        updatePriceDisplay();
    });
    
    // Handle quantity change
    const quantityInput = document.getElementById('quantity');
    quantityInput.addEventListener('input', function() {
        updatePriceDisplay();
    });
}

function showOrderForm() {
    const orderForm = document.getElementById('orderForm');
    const dropZone = document.getElementById('orderDropZone');
    
    if (currentProduct) {
        orderForm.style.display = 'block';
        dropZone.style.display = 'none';
        
        // Populate form with product data
        const colorSelect = document.getElementById('productColor');
        colorSelect.innerHTML = '';
        
        if (currentProduct.type === 'tshirt') {
            // Add available colors for t-shirts
            const productCard = document.querySelector(`[data-product-id="${currentProduct.id}"]`);
            if (productCard) {
                const colorItems = productCard.querySelectorAll('.color-item');
                colorItems.forEach((colorItem, index) => {
                    const colorName = colorItem.querySelector('.color-name').textContent;
                    const colorDot = colorItem.querySelector('.color-dot');
                    const colorHex = colorDot ? colorDot.getAttribute('data-color') : '#000000';
                    
                    const option = document.createElement('option');
                    option.value = colorHex;
                    option.textContent = colorName;
                    if (index === 0) option.selected = true;
                    colorSelect.appendChild(option);
                });
            } else {
                colorSelect.innerHTML = '<option value="#000000">Чорний</option>';
            }
        } else {
            // For hoodies, only black
            colorSelect.innerHTML = '<option value="#000000">Чорний</option>';
        }
        
        // Set default values
        document.getElementById('productSize').value = '';
        document.getElementById('quantity').value = '1';
        document.getElementById('quantity').disabled = false;
        document.getElementById('quantity').style.opacity = '1';
        
        updatePriceDisplay();
    }
}

function updatePriceDisplay() {
    if (!currentProduct) return;
    
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    
    // Update price based on quantity (only wholesale prices, minimum 8 items)
    let price = 0;
    if (quantity >= 8) { // Only calculate price for wholesale quantities (8+)
        if (currentProduct.type === 'tshirt') {
            // Determine wholesale price based on quantity
            if (quantity >= 100) price = tshirtPrices.wholesale[4];
            else if (quantity >= 64) price = tshirtPrices.wholesale[3];
            else if (quantity >= 32) price = tshirtPrices.wholesale[2];
            else if (quantity >= 16) price = tshirtPrices.wholesale[1];
            else price = tshirtPrices.wholesale[0]; // 8-15 items
        } else if (currentProduct.type === 'hoodie') {
            // Determine wholesale price based on quantity
            if (quantity >= 100) price = hoodiePrices.wholesale[4];
            else if (quantity >= 64) price = hoodiePrices.wholesale[3];
            else if (quantity >= 32) price = hoodiePrices.wholesale[2];
            else if (quantity >= 16) price = hoodiePrices.wholesale[1];
            else price = hoodiePrices.wholesale[0]; // 8-15 items
        }
    }
    }
    
    // Update button text to show price
    const addBtn = document.getElementById('addToOrderBtn');
    addBtn.textContent = `Додати в накладну (${price * quantity}₴)`;
}

function addToOrder() {
    if (!currentProduct) return;
    
    const size = document.getElementById('productSize').value;
    const color = document.getElementById('productColor').value;
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    
    if (!size) {
        showNotification('Оберіть розмір', 'error');
        return;
    }
    
    // Check minimum wholesale quantity
    if (quantity < 8) {
        showNotification('Мінімальна оптова кількість: 8 штук', 'error');
        return;
    }
    
    // Calculate price (only wholesale, minimum 8 items)
    let price = 0;
    if (currentProduct.type === 'tshirt') {
        if (quantity >= 100) price = tshirtPrices.wholesale[4];
        else if (quantity >= 64) price = tshirtPrices.wholesale[3];
        else if (quantity >= 32) price = tshirtPrices.wholesale[2];
        else if (quantity >= 16) price = tshirtPrices.wholesale[1];
        else price = tshirtPrices.wholesale[0]; // 8-15 items
    } else if (currentProduct.type === 'hoodie') {
        if (quantity >= 100) price = hoodiePrices.wholesale[4];
        else if (quantity >= 64) price = hoodiePrices.wholesale[3];
        else if (quantity >= 32) price = hoodiePrices.wholesale[2];
        else if (quantity >= 16) price = hoodiePrices.wholesale[1];
        else price = hoodiePrices.wholesale[0]; // 8-15 items
    }
    
    // Create order item
    const orderItem = {
        id: Date.now(),
        product: currentProduct,
        size: size === 'all' ? 'Всі ростовки (S-XL)' : size,
        color: color === 'default' ? 'Чорний' : color,
        quantity: quantity,
        price: price,
        total: price * quantity
    };
    
    orderItems.push(orderItem);
    
    // Add to UI
    addOrderItemToUI(orderItem);
    
    // Update statistics
    updateOrderStatistics();
    saveOrderData(); // Save to localStorage
    
    // Reset form fields but keep form open
    document.getElementById('quantity').value = '8'; // Reset to minimum wholesale quantity
    updatePriceDisplay(); // Update price display
    
    showNotification('Товар додано до накладної', 'success');
}

function addOrderItemToUI(orderItem) {
    const orderItemsContainer = document.getElementById('orderItems');
    
    const orderItemElement = document.createElement('div');
    orderItemElement.className = 'order-item';
    orderItemElement.dataset.itemId = orderItem.id;
    
    orderItemElement.innerHTML = `
        <div class="order-item-content">
            <div class="order-item-image">
                ${orderItem.product.image ? 
                    `<img src="${orderItem.product.image}" alt="${orderItem.product.title}" class="order-product-image">` :
                    `<div class="order-product-image" style="background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #718096;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                    </div>`
                }
            </div>
            
            <div class="order-item-info">
                <div class="order-item-title">${orderItem.product.title}</div>
                
                <div class="order-item-specs-row">
                    <div class="order-item-color-section">
                        <span class="order-item-color-text">${orderItem.color}</span>
                        <span class="order-item-color-dot" data-color="#000000"></span>
                    </div>
                    
                    <div class="order-item-size">${orderItem.size}</div>
                    
                    <div class="order-item-quantity">${orderItem.quantity} шт.</div>
                </div>
            </div>
            
            <div class="order-item-actions">
                <button class="remove-item-btn" onclick="removeOrderItem(${orderItem.id})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </button>
                
                <div class="order-item-prices">
                    <div class="order-item-cost">Опт</div>
                    <div class="order-item-selling">${orderItem.total}₴</div>
                </div>
            </div>
        </div>
    `;
    
    orderItemsContainer.appendChild(orderItemElement);
}

function removeOrderItem(itemId) {
    orderItems = orderItems.filter(item => item.id !== itemId);
    
    const orderItemElement = document.querySelector(`[data-item-id="${itemId}"]`);
    if (orderItemElement) {
        orderItemElement.remove();
    }
    
    // Update statistics
    updateOrderStatistics();
    saveOrderData(); // Save to localStorage
    
    showNotification('Товар видалено з накладної', 'success');
}

function hideOrderForm() {
    const orderForm = document.getElementById('orderForm');
    const dropZone = document.getElementById('orderDropZone');
    
    orderForm.style.display = 'none';
    dropZone.style.display = 'block';
    
    currentProduct = null;
}

function updateOrderStatistics() {
    const statisticsDiv = document.getElementById('orderStatistics');
    const totalSumSpan = document.getElementById('totalSum');
    const progressInfoDiv = document.getElementById('progressInfo');
    
    // Statistics always visible
    statisticsDiv.style.display = 'block';
    
    // Calculate total sum
    const totalSum = orderItems.reduce((sum, item) => sum + item.total, 0);
    totalSumSpan.textContent = `${totalSum}₴`;
    
    // Add highlight animation to total sum
    const totalSumDiv = totalSumSpan.closest('.total-sum');
    totalSumDiv.classList.add('highlight');
    setTimeout(() => {
        totalSumDiv.classList.remove('highlight');
    }, 1500);
    
    // Calculate quantities by type
    const tshirtQuantity = orderItems
        .filter(item => item.product.type === 'tshirt')
        .reduce((sum, item) => sum + item.quantity, 0);
    
    const hoodieQuantity = orderItems
        .filter(item => item.product.type === 'hoodie')
        .reduce((sum, item) => sum + item.quantity, 0);
    
    // Generate progress info
    let progressInfo = '';
    
    if (orderItems.length === 0) {
        progressInfo = '<div style="color: rgba(255, 255, 255, 0.5); font-style: italic;">Додайте товари до накладної</div>';
    } else {
        // T-shirt progress
        if (tshirtQuantity > 0) {
            if (tshirtQuantity < 8) {
                const needed = 8 - tshirtQuantity;
                progressInfo += `<div class="warning">Не вистачає ${needed} футболок до мінімального опту (8 шт.)</div>`;
            } else {
                progressInfo += `<div class="success">Футболки: ${tshirtQuantity} шт. (оптова ціна)</div>`;
            }
            
            // Next discount level
            const nextLevel = getNextDiscountLevel(tshirtQuantity, 'tshirt');
            if (nextLevel) {
                progressInfo += `<div>До наступної скидки потрібно ще ${nextLevel.needed} футболок (${nextLevel.price}₴)</div>`;
            }
        }
        
        // Hoodie progress
        if (hoodieQuantity > 0) {
            if (hoodieQuantity < 8) {
                const needed = 8 - hoodieQuantity;
                progressInfo += `<div class="warning">Не вистачає ${needed} худі до мінімального опту (8 шт.)</div>`;
            } else {
                progressInfo += `<div class="success">Худі: ${hoodieQuantity} шт. (оптова ціна)</div>`;
            }
            
            // Next discount level
            const nextLevel = getNextDiscountLevel(hoodieQuantity, 'hoodie');
            if (nextLevel) {
                progressInfo += `<div>До наступної скидки потрібно ще ${nextLevel.needed} худі (${nextLevel.price}₴)</div>`;
            }
        }
    }
    
    progressInfoDiv.innerHTML = progressInfo;
    
    // Update discount scales
    updateDiscountScales(tshirtQuantity, hoodieQuantity);
}

function getNextDiscountLevel(currentQuantity, type) {
    const prices = type === 'tshirt' ? tshirtPrices.wholesale : hoodiePrices.wholesale;
    
    if (currentQuantity < 8) {
        return { needed: 8 - currentQuantity, price: prices[0] };
    } else if (currentQuantity < 16) {
        return { needed: 16 - currentQuantity, price: prices[1] };
    } else if (currentQuantity < 32) {
        return { needed: 32 - currentQuantity, price: prices[2] };
    } else if (currentQuantity < 64) {
        return { needed: 64 - currentQuantity, price: prices[3] };
    } else if (currentQuantity < 100) {
        return { needed: 100 - currentQuantity, price: prices[4] };
    }
    
    return null; // Already at maximum discount
}

function updateDiscountScales(tshirtQuantity, hoodieQuantity) {
    updateScale('tshirtScale', tshirtQuantity);
    updateScale('hoodieScale', hoodieQuantity);
}

function updateScale(scaleId, quantity) {
    const scale = document.getElementById(scaleId);
    if (!scale) return;
    
    const segments = scale.querySelectorAll('.scale-segment');
    
    segments.forEach((segment, index) => {
        segment.classList.remove('active', 'progress', 'completed');
        
        const range = segment.dataset.range;
        const [min, max] = parseRange(range);
        
        if (quantity < 8) {
            // Below minimum wholesale - show red for 1-7 tier, gray for others
            if (min === 1 && max === 7) {
                segment.classList.add('active');
                segment.style.backgroundColor = '#ef4444'; // Red for insufficient quantity
                
                // Show progress within 1-7 tier
                const tierSize = 7 - 1 + 1;
                const currentProgress = Math.min(quantity, tierSize);
                const progressPercent = (currentProgress / tierSize) * 100;
                
                let progressFill = segment.querySelector('.progress-fill');
                if (!progressFill) {
                    progressFill = document.createElement('div');
                    progressFill.className = 'progress-fill';
                    progressFill.style.position = 'absolute';
                    progressFill.style.top = '0';
                    progressFill.style.left = '0';
                    progressFill.style.height = '100%';
                    progressFill.style.backgroundColor = '#ef4444';
                    progressFill.style.borderRadius = '3px';
                    progressFill.style.transition = 'width 0.3s ease';
                    progressFill.style.zIndex = '1';
                    segment.style.position = 'relative';
                    segment.appendChild(progressFill);
                }
                progressFill.style.width = `${progressPercent}%`;
            } else {
                // Future tiers - gray
                segment.style.backgroundColor = '#374151';
            }
        } else if (quantity >= min && (max === null || quantity <= max)) {
            // Current tier - show progress
            segment.classList.add('active');
            
            // Calculate progress within current tier
            const tierSize = (max === null ? 100 : max) - min + 1;
            const currentProgress = Math.min(quantity - min + 1, tierSize);
            const progressPercent = (currentProgress / tierSize) * 100;
            
            // Create or update progress fill
            let progressFill = segment.querySelector('.progress-fill');
            if (!progressFill) {
                progressFill = document.createElement('div');
                progressFill.className = 'progress-fill';
                progressFill.style.position = 'absolute';
                progressFill.style.top = '0';
                progressFill.style.left = '0';
                progressFill.style.height = '100%';
                progressFill.style.backgroundColor = '#10b981';
                progressFill.style.borderRadius = '3px';
                progressFill.style.transition = 'width 0.3s ease';
                progressFill.style.zIndex = '1';
                segment.style.position = 'relative';
                segment.appendChild(progressFill);
            }
            progressFill.style.width = `${progressPercent}%`;
            
        } else if (quantity > max) {
            // Completed tier
            segment.classList.add('completed');
            segment.style.backgroundColor = '#10b981';
        } else {
            // Future tier
            segment.style.backgroundColor = '#374151';
        }
    });
}

function parseRange(range) {
    if (range.includes('+')) {
        return [parseInt(range.replace('+', '')), null];
    }
    const [min, max] = range.split('-').map(Number);
    return [min, max];
}

// LocalStorage functions
function saveOrderData() {
    const orderData = {
        orderItems: orderItems,
        companyData: {
            companyName: document.getElementById('companyName').value,
            deliveryAddress: document.getElementById('deliveryAddress').value,
            contactPhone: document.getElementById('contactPhone').value,
            storeLink: document.getElementById('storeLink').value
        },
        timestamp: Date.now()
    };
    localStorage.setItem('wholesaleOrderData', JSON.stringify(orderData));
}

function loadOrderData() {
    const savedData = localStorage.getItem('wholesaleOrderData');
    if (savedData) {
        try {
            const orderData = JSON.parse(savedData);
            
            // Load company data
            if (orderData.companyData) {
                document.getElementById('companyName').value = orderData.companyData.companyName || '';
                document.getElementById('deliveryAddress').value = orderData.companyData.deliveryAddress || '';
                document.getElementById('contactPhone').value = orderData.companyData.contactPhone || '';
                document.getElementById('storeLink').value = orderData.companyData.storeLink || '';
            }
            
            // Load order items
            if (orderData.orderItems && orderData.orderItems.length > 0) {
                orderItems = orderData.orderItems;
                
                // Clear existing items
                const orderItemsContainer = document.getElementById('orderItems');
                orderItemsContainer.innerHTML = '';
                
                // Rebuild order items UI
                orderItems.forEach(item => {
                    addOrderItemToUI(item);
                });
            }
        } catch (e) {
            console.error('Error loading saved order data:', e);
        }
    }
}

function clearOrderData() {
    localStorage.removeItem('wholesaleOrderData');
}

// Color dots initialization
function initializeColorDots() {
    const colorDots = document.querySelectorAll('.color-dot[data-color]');
    colorDots.forEach(dot => {
        const color = dot.getAttribute('data-color');
        if (color) {
            dot.style.backgroundColor = color;
        }
    });
}

// Invoice list management
function addInvoiceToList(invoice) {
    const invoicesList = document.getElementById('invoices-list');
    const emptyMessage = invoicesList.querySelector('div[style*="text-align: center"]');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    const invoiceItem = document.createElement('div');
    invoiceItem.className = 'invoice-item';
    invoiceItem.innerHTML = `
        <div class="invoice-info">
            <div class="invoice-name">${invoice.name}</div>
            <div class="invoice-date">${invoice.date} - ${invoice.company}</div>
        </div>
        <a href="#" class="download-button" onclick="downloadInvoice('${invoice.id}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"/>
            </svg>
            Скачати
        </a>
    `;
    
    invoicesList.appendChild(invoiceItem);
}

// Global function for downloading invoices
function downloadInvoice(invoiceId) {
    showNotification('Функція скачування буде реалізована наступним етапом', 'info');
}

// Notification system
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
