{% extends "base.html" %}
{% load static %}

{% block title %}–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ ‚Äî TwoComms{% endblock %}

{% block content %}
<section class="order-success-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="order-success-card">
          <div class="order-success-header">
            <div class="success-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </div>
            <h1 class="order-success-title">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ!</h1>
            <div class="order-number">
              <span class="order-number-label">–ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</span>
              <span class="order-number-value">{{ order_number }}</span>
            </div>
          </div>
          
          <div class="order-success-content">
            <div class="success-message">
              <h3>–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –æ–±—Ä–æ–±–∫—É</h3>
              <p>–ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ —É—Ç–æ—á–Ω–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏.</p>
            </div>
            
            <div class="order-details">
              <h4>–î–µ—Ç–∞–ª—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</h4>
              <div class="order-info">
                <div class="info-row">
                  <span class="info-label">–ü–Ü–ë:</span>
                  <span class="info-value">{{ order.full_name }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                  <span class="info-value">{{ order.phone }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–ú—ñ—Å—Ç–æ:</span>
                  <span class="info-value">{{ order.city }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü:</span>
                  <span class="info-value">{{ order.np_office }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–°—É–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</span>
                  <span class="info-value">{{ order.total_sum }} –≥—Ä–Ω</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç–∏:</span>
                  <span class="info-value">{% if order.payment_status == 'paid' %}<span class="badge bg-success">–û–ø–ª–∞—á–µ–Ω–æ</span>{% else %}{{ order.get_payment_status_display|default:order.payment_status }}{% endif %}</span>
                </div>
              </div>
            </div>
            
            {% if user.is_authenticated %}
            <div class="auth-suggestion">
              <div class="auth-suggestion-content">
                <h4>‚úÖ –î—è–∫—É—î–º–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!</h4>
                <p>–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ü–µ —Ç–∞ —ñ–Ω—à—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —É –≤–∞—à–æ–º—É –æ—Å–æ–±–∏—Å—Ç–æ–º—É –∫–∞–±—ñ–Ω–µ—Ç—ñ.</p>
                <div class="auth-buttons">
                  <a href="{% url 'my_orders' %}" class="btn btn-primary">–ú–æ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
                </div>
              </div>
            </div>
            {% else %}
            <div class="auth-suggestion">
              <div class="auth-suggestion-content">
                <h4>üîê –°—Ç–≤–æ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ</h4>
                <p>–ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å –∞–±–æ —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É, —â–æ–±:</p>
                <ul class="auth-benefits">
                  <li>üìä –ù–∞–∫–æ–ø–∏—á—É–≤–∞—Ç–∏ –±–∞–ª–∏ –∑–∞ –ø–æ–∫—É–ø–∫–∏</li>
                  <li>üìà –í—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω—å</li>
                  <li>üíæ –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ–∫—É–ø–æ–∫</li>
                  <li>üéÅ –û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</li>
                </ul>
                <div class="auth-buttons">
                  <a href="{% url 'login' %}" class="btn btn-primary">–£–≤—ñ–π—Ç–∏</a>
                  <a href="{% url 'register' %}" class="btn btn-outline-primary">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</a>
                </div>
                <div class="auth-note">
                  <small>–Ø–∫—â–æ –≤–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä—É—î—Ç–µ—Å—å, —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏–≤'—è–∂–µ—Ç—å—Å—è –¥–æ –≤–∞—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É</small>
                </div>
              </div>
            </div>
            {% endif %}
            
            <div class="order-success-actions">
              <a href="{% url 'home' %}" class="btn btn-cta">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –Ω–∞ –≥–æ–ª–æ–≤–Ω—É</a>
              <a href="{% url 'catalog' %}" class="btn btn-outline-light">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<div id="purchase-payload"
     data-order-id="{{ order.id }}"
     data-order-number="{{ order.order_number }}"
     data-value="{{ order.total_sum|floatformat:2 }}"
     data-currency="UAH"
     data-full-name="{{ order.full_name }}"
     data-phone="{{ order.phone }}"
     data-city="{{ order.city }}"
     {% if user.is_authenticated and user.userprofile.email %}data-email="{{ user.userprofile.email }}"{% endif %}
     data-contents='[{% for item in order.items.all %}{"id":"{{ item.product.id }}","quantity":{{ item.qty }},"price":{{ item.unit_price|floatformat:2 }},"name":"{{ item.title|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'>
</div>

<script>
(function() {
  'use strict';
  
  try {
    var el = document.getElementById('purchase-payload');
    if (!el) return;
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º –±—ã–ª –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω event –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
    var orderId = el.dataset.orderId;
    var storageKey = 'gtm_purchase_' + orderId;
    
    if (sessionStorage.getItem(storageKey)) {
      console.log('GTM Purchase event already sent for order:', orderId);
      return;
    }
    
    // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
    var orderNumber = el.dataset.orderNumber || '';
    var value = parseFloat(el.dataset.value || '0');
    var currency = el.dataset.currency || 'UAH';
    var fullName = el.dataset.fullName || '';
    var phone = el.dataset.phone || '';
    var city = el.dataset.city || '';
    var email = el.dataset.email || '';
    var contents = [];
    
    try {
      contents = JSON.parse(el.dataset.contents || '[]');
    } catch(e) {
      console.error('Error parsing contents:', e);
      contents = [];
    }
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è GTM
    var purchaseData = {
      event: 'purchase',
      ecommerce: {
        transaction_id: orderNumber,
        value: value,
        currency: currency,
        items: contents.map(function(item) {
          return {
            item_id: item.id,
            item_name: item.name || 'Product ' + item.id,
            quantity: item.quantity,
            price: item.price || 0
          };
        })
      }
    };
    
    // Enhanced Conversions –¥–∞–Ω–Ω—ã–µ
    var userData = {};
    
    // –†–∞–∑–±–∏–≤–∞–µ–º –§–ò–û –Ω–∞ —á–∞—Å—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (fullName) {
      var nameParts = fullName.trim().split(/\s+/);
      if (nameParts.length >= 2) {
        userData.first_name = nameParts[0];
        userData.last_name = nameParts[nameParts.length - 1];
      } else {
        userData.first_name = fullName;
      }
    }
    
    if (phone) {
      userData.phone_number = phone;
    }
    
    if (email) {
      userData.email = email;
    }
    
    if (city) {
      userData.address = {
        city: city
      };
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º userData –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ
    if (Object.keys(userData).length > 0) {
      purchaseData.user_data = userData;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º dataLayer –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    window.dataLayer = window.dataLayer || [];
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ GTM
    window.dataLayer.push(purchaseData);
    
    console.log('GTM Purchase event sent:', purchaseData);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥ —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    sessionStorage.setItem(storageKey, 'true');
    
    // Meta Pixel (Facebook Pixel) Purchase —Å Advanced Matching
    if (window.fbq) {
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Advanced Matching
      var fbUserData = {};
      
      if (email) {
        fbUserData.em = email.toLowerCase(); // Email
      }
      if (phone) {
        fbUserData.ph = phone.replace(/\D/g, ''); // Phone (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
      }
      if (fullName) {
        var nameParts = fullName.trim().split(/\s+/);
        if (nameParts.length >= 1) {
          fbUserData.fn = nameParts[0].toLowerCase(); // First Name
        }
        if (nameParts.length >= 2) {
          fbUserData.ln = nameParts[nameParts.length - 1].toLowerCase(); // Last Name
        }
      }
      if (city) {
        fbUserData.ct = city.toLowerCase(); // City
      }
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Purchase event —Å Advanced Matching
      fbq('track', 'Purchase', {
        value: value,
        currency: currency,
        contents: contents.map(function(item) {
          return {
            id: item.id,
            quantity: item.quantity
          };
        }),
        content_type: 'product'
      }, fbUserData);
      
      console.log('Meta Pixel Purchase event sent with Advanced Matching:', fbUserData);
  }
    
  } catch(e) {
    console.error('Error in purchase tracking:', e);
  }
})();
</script>
{% endblock %}
