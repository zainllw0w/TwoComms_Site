{% extends 'base.html' %}{% load static %}
{% block title %}–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ ‚Äî TwoComms{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="card glass">
        <div class="card-header">
          <h4>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤</h4>
        </div>
        <div class="card-body">
          
          <!-- –§–æ—Ä–º–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ -->
          <div class="mb-4">
            <h5>üì§ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞</h5>
            <form method="post" enctype="multipart/form-data" id="testUploadForm">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
                <input type="file" name="test_file" class="form-control" accept="image/*" required>
              </div>
              <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª</button>
            </form>
            <div id="uploadResult" class="mt-3"></div>
          </div>

          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö -->
          <div class="mb-4">
            <h5>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Django</h5>
            <div id="settingsInfo" class="alert alert-info">
              –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...
            </div>
          </div>

          <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–∞—Ö -->
          <div class="mb-4">
            <h5>üìÅ –§–∞–π–ª—ã –≤ –º–µ–¥–∏–∞-–ø–∞–ø–∫–µ</h5>
            <div id="filesInfo" class="alert alert-info">
              –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...
            </div>
          </div>

          <!-- –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º -->
          <div class="mb-4">
            <h5>üîó –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º</h5>
            <div id="accessTest" class="alert alert-info">
              –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤...
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    loadDebugInfo();
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('testUploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const resultDiv = document.getElementById('uploadResult');
        
        resultDiv.innerHTML = '<div class="alert alert-warning">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        fetch('/debug/media/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = `<div class="alert alert-success">
                    ‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!<br>
                    –ü—É—Ç—å: ${data.file_path}<br>
                    URL: ${data.file_url}<br>
                    –†–∞–∑–º–µ—Ä: ${data.file_size} –±–∞–π—Ç
                </div>`;
                loadDebugInfo(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">
                    ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error}
                </div>`;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = `<div class="alert alert-danger">
                ‚ùå –û—à–∏–±–∫–∞: ${error.message}
            </div>`;
        });
    });
});

function loadDebugInfo() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
    fetch('/debug/media/')
        .then(response => response.json())
        .then(data => {
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const settingsDiv = document.getElementById('settingsInfo');
            settingsDiv.innerHTML = `
                <strong>MEDIA_URL:</strong> ${data.MEDIA_URL}<br>
                <strong>MEDIA_ROOT:</strong> ${data.MEDIA_ROOT}<br>
                <strong>DEBUG:</strong> ${data.DEBUG}<br>
                <strong>BASE_DIR:</strong> ${data.BASE_DIR}<br>
                <strong>–ü–∞–ø–∫–∞ –º–µ–¥–∏–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:</strong> ${data.media_root_exists ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}<br>
                <strong>–ü—Ä–∞–≤–∞ –ø–∞–ø–∫–∏ –º–µ–¥–∏–∞:</strong> ${data.media_root_permissions || 'N/A'}
            `;
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–∞—Ö
            const filesDiv = document.getElementById('filesInfo');
            let filesHtml = '<div class="row">';
            
            for (const [folder, info] of Object.entries(data.subfolders)) {
                filesHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <strong>${folder}</strong> 
                                ${info.exists ? '‚úÖ' : '‚ùå'}
                            </div>
                            <div class="card-body">
                                <small>–ü—Ä–∞–≤–∞: ${info.permissions || 'N/A'}</small><br>
                                <small>–§–∞–π–ª–æ–≤: ${info.contents.length}</small>
                                ${info.contents.length > 0 ? `<br><small>–§–∞–π–ª—ã: ${info.contents.slice(0, 3).join(', ')}${info.contents.length > 3 ? '...' : ''}</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            filesHtml += '</div>';
            filesDiv.innerHTML = filesHtml;
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º
            const accessDiv = document.getElementById('accessTest');
            if (data.recent_files.length > 0) {
                let accessHtml = '<div class="row">';
                data.recent_files.slice(0, 6).forEach(file => {
                    accessHtml += `
                        <div class="col-md-4 mb-2">
                            <div class="card">
                                <div class="card-body p-2">
                                    <small><strong>${file.folder}/${file.file}</strong></small><br>
                                    <small>–†–∞–∑–º–µ—Ä: ${file.size} –±–∞–π—Ç</small><br>
                                    <small>–ü—Ä–∞–≤–∞: ${file.permissions}</small><br>
                                    <a href="${file.url}" target="_blank" class="btn btn-sm btn-outline-primary">–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞</a>
                                </div>
                            </div>
                        </div>
                    `;
                });
                accessHtml += '</div>';
                accessDiv.innerHTML = accessHtml;
            } else {
                accessDiv.innerHTML = '<div class="alert alert-warning">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>';
            }
        })
        .catch(error => {
            document.getElementById('settingsInfo').innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
        });
}
</script>
{% endblock %}
