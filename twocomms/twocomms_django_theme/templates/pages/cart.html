{% extends 'base.html' %}
{% load static %}
{% load math_filters %}
{% load responsive_images %}

{% block title %}Кошик — TwoComms{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Анимация искр для всей страницы -->
<div class="cart-page-sparks">
  <div class="cart-page-spark cart-page-spark-1"></div>
  <div class="cart-page-spark cart-page-spark-2"></div>
  <div class="cart-page-spark cart-page-spark-3"></div>
  <div class="cart-page-spark cart-page-spark-4"></div>
  <div class="cart-page-spark cart-page-spark-5"></div>
  <div class="cart-page-spark cart-page-spark-6"></div>
</div>

<div class="cart-page-container">
  <!-- Заголовок страницы -->
  <div class="cart-page-header">
    <div class="cart-page-header-icon">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
      </svg>
    </div>
    <div class="cart-page-header-content">
      <h1 class="cart-page-title">Кошик</h1>
      <p class="cart-page-subtitle">Ваші вибрані товари</p>
    </div>
    {% if items %}
    <button type="button" class="cart-clear-btn" onclick="cleanCart()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
      </svg>
      Очистити
    </button>
    {% endif %}
  </div>

  <!-- Сообщения -->
  {% if messages %}
    {% for message in messages %}
      <div class="cart-message cart-message-{{ message.tags }}">
        <div class="cart-message-icon">
          {% if message.tags == 'success' %}
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          {% elif message.tags == 'error' %}
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          {% else %}
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
            </svg>
          {% endif %}
        </div>
        <div class="cart-message-text">{{ message }}</div>
        <button type="button" class="cart-message-close" onclick="this.parentElement.remove()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="cart-page-content">
    <!-- Основная часть корзины -->
    <div class="cart-main-section">
      {% if items %}
        <div class="cart-items-background">
          <div class="cart-items-pattern"></div>
        </div>
        <div class="cart-items-container" id="cart-list">
          {% for it in items %}
            <div class="cart-item" data-cart-row data-key="{{ it.key }}">
              <!-- Анимация искр для товара -->
              <div class="cart-item-sparks">
                <div class="cart-item-spark cart-item-spark-1"></div>
                <div class="cart-item-spark cart-item-spark-2"></div>
                <div class="cart-item-spark cart-item-spark-3"></div>
              </div>
              
              <div class="cart-item-image">
                {% if it.color_variant and it.color_variant.images.exists %}
                  <img src="{{ it.color_variant.images.first.image.url }}" 
                       alt="{{ it.product.title }} - товар у кошику TwoComms" 
                       class="cart-item-img"
                       width="80" height="80">
                {% elif it.product.main_image %}
                  <img src="{{ it.product.main_image.url }}" 
                       alt="{{ it.product.title }} - товар у кошику TwoComms" 
                       class="cart-item-img"
                       width="80" height="80">
                {% else %}
                  {% static 'img/placeholder.jpg' as ph_url %}
                  <img src="{{ ph_url }}" 
                       alt="{{ it.product.title }} - товар у кошику TwoComms" 
                       class="cart-item-img"
                       width="80" height="80">
                {% endif %}
                <div class="cart-item-image-glow"></div>
              </div>
              
              <div class="cart-item-info">
                <h3 class="cart-item-title">{{ it.product.title }}</h3>
                <div class="cart-item-details">
                  <div class="cart-item-detail">
                    <span class="cart-item-label">Розмір:</span>
                    <span class="cart-item-value">{{ it.size }}</span>
                  </div>
                  <div class="cart-item-detail">
                    <span class="cart-item-label">Кількість:</span>
                    <span class="cart-item-value">{{ it.qty }}</span>
                  </div>
                  {% if it.color_variant %}
                  <div class="cart-item-detail">
                    <span class="cart-item-label">Колір:</span>
                    <div class="cart-item-color d-flex align-items-center gap-2">
                      {% with p=it.color_variant.color.primary_hex s=it.color_variant.color.secondary_hex %}
                      <span class="cart-item-swatch swatch"
                            data-primary="{{ p }}"
                            data-secondary="{{ s|default:'' }}">
                      </span>
                      {% endwith %}
                      <span class="cart-item-color-name">{{ it.color_label|default:'—' }}</span>
                    </div>
                  </div>
                  {% endif %}
                </div>
                <div class="cart-item-price">
                  <span class="cart-item-price-label">Ціна:</span>
                  <span class="cart-item-price-value">{{ it.unit_price }} грн</span>
                </div>
                <!-- Информация о баллах -->
                <div class="cart-item-points">
                  <div class="cart-item-points-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                  </div>
                  <span class="cart-item-points-text">
                    {% if it.product.points_reward %}
                      Заробите {{ it.product.points_reward|multiply:it.qty }} балів
                    {% else %}
                      Бали не нараховуються
                    {% endif %}
                  </span>
                </div>
              </div>
              
              <div class="cart-item-actions">
                <div class="cart-item-total">
                  <span class="cart-item-total-label">Разом:</span>
                  <span class="cart-item-total-value">{{ it.line_total }} грн</span>
                </div>
                <button type="button" class="cart-item-remove-btn" onclick="CartRemoveKey('{{ it.key }}', this); return false;" data-key="{{ it.key }}" onmouseenter="console.log('Mouse enter button:', '{{ it.key }}')" onmouseleave="console.log('Mouse leave button:', '{{ it.key }}')">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                  Видалити
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="cart-empty">
          <div class="cart-empty-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
          </div>
          <h2 class="cart-empty-title">Кошик порожній</h2>
          <p class="cart-empty-text">Додайте товари до кошика, щоб зробити замовлення</p>
          <a href="{% url 'home' %}" class="cart-empty-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            Перейти до покупок
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Боковая панель -->
    <div class="cart-sidebar">
      {% if request.user.is_authenticated %}
        <!-- Карточка: Доставка для авторизованных -->
        <div class="cart-sidebar-card">
          <div class="cart-sidebar-card-header">
            <div class="cart-sidebar-card-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
              </svg>
            </div>
            <h3 class="cart-sidebar-card-title">Доставка</h3>
          </div>
          
          {% with prof=request.user.userprofile %}
          <form method="post" class="cart-sidebar-form" id="deliveryForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="form_type" value="update_profile" id="form_type_input">
            
            <div class="cart-form-group">
              <label class="cart-form-label">ПІБ *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="full_name" class="cart-form-input" placeholder="Прізвище Ім'я По батькові"
                       value="{{ prof.full_name|default:'' }}" required>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Телефон *</label>
              <div class="cart-form-input-wrapper">
                <input type="tel" name="phone" class="cart-form-input" placeholder="+380XXXXXXXXX"
                       value="{{ prof.phone|default:'' }}" required>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Місто *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="city" class="cart-form-input" placeholder="Київ"
                       value="{{ prof.city|default:'' }}" required>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Відділення / Поштомат НП *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="np_office" class="cart-form-input" placeholder="№ відділення або адреса поштомата"
                       value="{{ prof.np_office|default:'' }}" required>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Тип оплати *</label>
              <div class="cart-form-input-wrapper">
                <select name="pay_type" class="cart-form-select" id="pay_type_auth" required aria-label="Тип оплати">
                  <option value="">Оберіть тип оплати</option>
                  <option value="partial" {% if prof.pay_type == 'partial' %}selected{% endif %}>Часткова передоплата</option>
                  <option value="full" {% if prof.pay_type == 'full' %}selected{% endif %}>Повна передоплата</option>
                </select>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <button type="submit" class="cart-form-save-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              Зберегти зміни
            </button>
          </form>
          {% endwith %}
        </div>
      {% else %}
        <!-- Карточка: Доставка для гостей -->
        <div class="cart-sidebar-card">
          <div class="cart-sidebar-card-header">
            <div class="cart-sidebar-card-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
              </svg>
            </div>
            <h3 class="cart-sidebar-card-title">Доставка</h3>
            <a href="{% url 'login' %}" class="cart-auth-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
              </svg>
              Авторизація
            </a>
          </div>
          
          <div class="cart-sidebar-card-hint">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
            </svg>
            Щоб не вводити дані кожного разу — авторизуйтесь і накопичуйте бали.
          </div>
          
          <form method="post" class="cart-sidebar-form" id="guest-form">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="guest_order">
            
            <div class="cart-form-group">
              <label class="cart-form-label">ПІБ *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="full_name" class="cart-form-input" placeholder="Прізвище Ім'я По батькові" required>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.full_name.errors %}
                <div class="cart-form-error">{{ guest_form.full_name.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Телефон *</label>
              <div class="cart-form-input-wrapper">
                <input type="tel" name="phone" class="cart-form-input" placeholder="+380XXXXXXXXX" required>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.phone.errors %}
                <div class="cart-form-error">{{ guest_form.phone.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Місто *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="city" class="cart-form-input" placeholder="Київ" required>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.city.errors %}
                <div class="cart-form-error">{{ guest_form.city.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Відділення / Поштомат НП *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="np_office" class="cart-form-input" placeholder="№ відділення або адреса поштомата" required>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.np_office.errors %}
                <div class="cart-form-error">{{ guest_form.np_office.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Тип оплати *</label>
              <div class="cart-form-input-wrapper">
                <select name="pay_type" class="cart-form-select" id="pay_type_guest" required aria-label="Тип оплати">
                  <option value="">Оберіть тип оплати</option>
                  <option value="partial">Часткова передоплата</option>
                  <option value="full">Повна передоплата</option>
                </select>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.pay_type.errors %}
                <div class="cart-form-error">{{ guest_form.pay_type.errors.0 }}</div>
              {% endif %}
            </div>
          </form>
        </div>
      {% endif %}

      <!-- Карточка: Промокод -->
      <div class="cart-sidebar-card">
        <div class="cart-sidebar-card-header">
          <div class="cart-sidebar-card-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
            </svg>
          </div>
          <h3 class="cart-sidebar-card-title">Промокод</h3>
          {% if applied_promo %}
            <span class="cart-promo-badge">Застосовано</span>
          {% endif %}
        </div>
        
        {% if applied_promo %}
          <div class="cart-promo-applied">
            <div class="cart-promo-applied-content">
              <div class="cart-promo-applied-code">{{ applied_promo.code }}</div>
              <div class="cart-promo-applied-discount">Знижка: {{ applied_promo.discount }} грн</div>
            </div>
            <button type="button" class="cart-promo-remove-btn" onclick="removePromoCode()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
        {% else %}
          <div class="cart-promo-input-group">
            <div class="cart-promo-input-wrapper">
              <input type="text" id="promo-code-input" class="cart-promo-input" placeholder="Введіть код промокоду" maxlength="20">
              <div class="cart-promo-input-glow"></div>
            </div>
            <button type="button" class="cart-promo-apply-btn" onclick="applyPromoCode()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            </button>
          </div>
          <div id="promo-message" class="cart-promo-message"></div>
        {% endif %}
      </div>

      <!-- Карточка: Оформление заказа -->
      <div class="cart-checkout-card">
        <div class="cart-checkout-header">
          <div class="cart-checkout-header-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div class="cart-checkout-header-content">
            <h3 class="cart-checkout-title">Оформлення замовлення</h3>
            <p class="cart-checkout-subtitle">Підсумок вашого замовлення</p>
          </div>
        </div>
        
        <div class="cart-checkout-summary">
          <div class="cart-summary-row">
            <span class="cart-summary-label">Товари ({{ items|length }}):</span>
            <span class="cart-summary-value">{{ grand_total }} грн</span>
          </div>
          
          {% if applied_promo %}
          <div class="cart-summary-row cart-summary-discount">
            <span class="cart-summary-label">
              <div class="cart-discount-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                Знижка промокоду
              </div>
            </span>
            <span class="cart-summary-value">-{{ applied_promo.discount }} грн</span>
          </div>
          {% endif %}
          
          <div class="cart-summary-row cart-summary-total">
            <span class="cart-summary-label">До сплати:</span>
            <span class="cart-summary-value">{{ grand_total }} грн</span>
          </div>
        </div>
        
        <!-- Информация о баллах -->
        <div class="cart-points-summary">
          <div class="cart-points-header">
            <div class="cart-points-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </div>
            <span class="cart-points-title">Бали за замовлення</span>
          </div>
          
          {% if request.user.is_authenticated %}
            {% if total_points > 0 %}
              <div class="cart-points-earned">
                <span class="cart-points-amount">+{{ total_points }} балів</span>
                <span class="cart-points-description">буде нараховано після отримання товару</span>
              </div>
            {% else %}
              <div class="cart-points-none">
                <span class="cart-points-text">Бали не нараховуються</span>
              </div>
            {% endif %}
          {% else %}
            <div class="cart-points-guest">
              <div class="cart-points-guest-info">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
                <span>Для отримання балів потрібно авторизуватися</span>
              </div>
              <a href="{% url 'login' %}" class="cart-points-login-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
                </svg>
                Авторизуватися
              </a>
            </div>
          {% endif %}
        </div>
        
        <div class="cart-delivery-info">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
          </svg>
          Доставка оплачується згідно тарифів перевізника.
        </div>

<div class="cart-checkout-actions">
  <!-- Monobank онлайн оплата -->
  <div class="cart-monobank-container" data-mono-status-scope>
    <button type="button" id="monobank-pay-btn" class="cart-monobank-btn" data-monobank-pay-trigger="cart">
      <span class="cart-monobank-logo" aria-hidden="true">
        <span class="mono">mono</span><span class="dot">·</span><span class="pay">pay</span>
      </span>
      <span class="cart-monobank-details">
        <span class="cart-monobank-text">Онлайн оплата карткою</span>
        <span class="cart-monobank-badges" aria-hidden="true">
          <span class="cart-monobank-badge cart-monobank-badge-gpay" role="presentation">
            <span class="badge-symbol">G</span>
            <span class="badge-text">Pay</span>
          </span>
          <span class="cart-monobank-badge cart-monobank-badge-apple" role="presentation">
            <span class="badge-symbol" aria-hidden="true"></span>
            <span class="badge-text">Pay</span>
          </span>
        </span>
      </span>
      <span class="cart-monobank-spinner" aria-hidden="true"></span>
    </button>
    <div id="monobank-pay-status" class="cart-monobank-status text-secondary" data-mono-checkout-status role="status" aria-live="polite"></div>
  </div>



          {% if request.user.is_authenticated %}
            <button type="submit" form="deliveryForm" class="cart-checkout-btn" id="placeOrderBtn">
              <div class="cart-checkout-btn-content">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span>Оформити замовлення</span>
              </div>
              <div class="cart-checkout-btn-glow"></div>
            </button>
          {% else %}
            <button type="submit" form="guest-form" class="cart-checkout-btn cart-checkout-btn-guest">
              <div class="cart-checkout-btn-content">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27л-5 4.87 1.18 6.88L12 17.77л-6.18 3.25Л7 14.14 2 9.27л6.91-1.01L12 2z"/>
                </svg>
                <span>Замовити як гість</span>
              </div>
              <div class="cart-checkout-btn-glow"></div>
            </button>
          {% endif %}
          <div class="cart-checkout-note text-secondary mt-3">
            Після оформлення замовлення менеджер зв'яжеться з вами за вказаним номером телефону, щоб підтвердити деталі та узгодити доставку.
          </div>
        </div>


      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
// Валидация форм, промокоды и удаление строк перенесены в main.js
document.addEventListener('DOMContentLoaded', function() {
    const guestForm = document.getElementById('guest-form');
    const deliveryForm = document.getElementById('deliveryForm');
    
    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Изменяем form_type на "order_create" при клике на "Оформити замовлення"
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    if (placeOrderBtn && deliveryForm) {
        placeOrderBtn.addEventListener('click', function() {
            const formTypeInput = document.getElementById('form_type_input');
            if (formTypeInput) {
                formTypeInput.value = 'order_create';
            }
            
            // Track StartPayment event
            try{
              var payloadEl = document.getElementById('checkout-payload');
              if(payloadEl && window.trackEvent){
                var value = parseFloat(payloadEl.dataset.value || '0');
                var currency = payloadEl.dataset.currency || 'UAH';
                var numItems = parseInt(payloadEl.dataset.numItems || '0', 10);
                var paymentMethod = document.querySelector('input[name="pay_type"]:checked')?.value || 'unknown';
                
                window.trackEvent('StartPayment', {
                  value: value,
                  currency: currency,
                  num_items: numItems,
                  payment_method: paymentMethod,
                  content_type: 'product'
                });
              }
            }catch(_){}
        });
    }
    
    // Функция для валидации формы
    function setupFormValidation(form) {
        if (!form) return;
        
        // Подсветка полей с ошибками
        const errorFields = form.querySelectorAll('.cart-form-error');
        errorFields.forEach(function(errorDiv) {
            const field = errorDiv.previousElementSibling?.querySelector('input, select');
            if (field) {
                field.classList.add('cart-form-input-error');
            }
        });
        
        // Валидация в реальном времени
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(function(input) {
            input.addEventListener('blur', function() {
                validateField(this);
            });
            
            input.addEventListener('input', function() {
                // Убираем красную подсветку при вводе
                if (this.classList.contains('cart-form-input-error')) {
                    this.classList.remove('cart-form-input-error');
                    const errorDiv = this.parentNode.parentNode.querySelector('.cart-form-error');
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                }
            });
        });
        
        // Валидация при отправке формы
        form.addEventListener('submit', function(e) {
            let isValid = true;
            let firstErrorField = null;
            
            inputs.forEach(function(input) {
                if (!validateField(input)) {
                    isValid = false;
                    if (!firstErrorField) {
                        firstErrorField = input;
                    }
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                // Показываем сообщение об ошибке
                showError('Будь ласка, виправте помилки в формі');
                
                // Прокручиваем к первому полю с ошибкой
                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    firstErrorField.focus();
                }
            }
        });
    }
    
    // Настраиваем подсветку серверных ошибок, остальная логика в main.js
    (function highlightServerErrors(){
      [guestForm, deliveryForm].forEach(function(form){
        if(!form) return; form.querySelectorAll('.cart-form-error').forEach(function(err){
          var field = err.previousElementSibling && err.previousElementSibling.querySelector('input, select');
          if(field){ field.classList.add('cart-form-input-error'); }
        });
      });
    })();
    
    function validateField(field) {
        const value = field.value.trim();
        let isValid = true;
        let errorMessage = '';
        
        // Убираем старые ошибки
        field.classList.remove('cart-form-input-error');
        const existingError = field.parentNode.parentNode.querySelector('.cart-form-error');
        if (existingError) {
            existingError.style.display = 'none';
        }
        
        // Проверяем обязательные поля
        if (field.hasAttribute('required') && !value) {
            isValid = false;
            errorMessage = 'Це поле обов\'язкове';
        } else if (value) {
            // Специфичные проверки
            if (field.name === 'full_name') {
                if (value.length < 3) {
                    isValid = false;
                    errorMessage = 'ПІБ повинно містити мінімум 3 символи';
                } else if (!/[а-яёіїєґa-z]/i.test(value)) {
                    isValid = false;
                    errorMessage = 'ПІБ повинно містити літери';
                }
            } else if (field.name === 'phone') {
                const phoneClean = value.replace(/[^\d+]/g, '');
                if (!phoneClean.startsWith('+380')) {
                    isValid = false;
                    errorMessage = 'Телефон повинен починатися з +380';
                } else if (phoneClean.length !== 13) {
                    isValid = false;
                    errorMessage = 'Телефон повинен містити 13 символів';
                }
            } else if (field.name === 'city') {
                if (value.length < 2) {
                    isValid = false;
                    errorMessage = 'Назва міста повинна містити мінімум 2 символи';
                }
            } else if (field.name === 'np_office') {
                if (value.length < 1) {
                    isValid = false;
                    errorMessage = 'Введіть адресу відділення';
                }
            }
        }
        
        // Показываем ошибку если есть
        if (!isValid) {
            field.classList.add('cart-form-input-error');
            showFieldError(field, errorMessage);
        }
        
        return isValid;
    }
    
    function showFieldError(field, message) {
        // Убираем старую ошибку
        const existingError = field.parentNode.parentNode.querySelector('.cart-form-error');
        if (existingError) {
            existingError.textContent = message;
            existingError.style.display = 'block';
        } else {
            // Создаем новую ошибку
            const errorDiv = document.createElement('div');
            errorDiv.className = 'cart-form-error';
            errorDiv.textContent = message;
            field.parentNode.parentNode.appendChild(errorDiv);
        }
    }
    
    function showError(message) {
        // Показываем общее сообщение об ошибке
        const errorAlert = document.createElement('div');
        errorAlert.className = 'cart-message cart-message-error';
        errorAlert.innerHTML = `
          <div class="cart-message-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div class="cart-message-text">${message}</div>
          <button type="button" class="cart-message-close" onclick="this.parentElement.remove()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        `;
        
        const container = document.querySelector('.cart-page-container');
        container.insertBefore(errorAlert, container.firstChild);
        
        // Убираем через 5 секунд
        setTimeout(function() {
            errorAlert.remove();
        }, 5000);
    }
});
</script>
{% if items %}
<div id="checkout-payload"
     data-value="{{ grand_total }}"
     data-currency="UAH"
     data-num-items="{{ items|length }}"
     data-ids='[{% for it in items %}"{{ it.product.id }}"{% if not forloop.last %},{% endif %}{% endfor %}]'
     data-contents='[{% for it in items %}{"id":"{{ it.product.id }}","quantity":{{ it.qty }},"item_price":{{ it.unit_price }}}{% if not forloop.last %},{% endif %}{% endfor %}]'
     style="display:none"></div>

<!-- Монобанк функціональність -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    var el = document.getElementById('checkout-payload');
    if(!el) return;
    var payload = (function(){
      var contents=[]; try{ contents = JSON.parse(el.dataset.contents||'[]'); }catch(_){ contents=[]; }
      var ids=[]; try{ ids = JSON.parse(el.dataset.ids||'[]'); }catch(_){ ids=[]; }
      var value = parseFloat(el.dataset.value||'0');
      var currency = el.dataset.currency||'UAH';
      var numItems = parseInt(el.dataset.numItems||String(contents.length)||'0',10) || contents.length;
      return { contents: contents, content_ids: ids, content_type: 'product', value: value, currency: currency, num_items: numItems };
    })();
    document.querySelectorAll('.cart-checkout-btn').forEach(function(btn){
      if(btn._icBound) return; btn._icBound = true;
      btn.addEventListener('click', function(){
        try{ if(window.trackEvent){ window.trackEvent('InitiateCheckout', payload); } }catch(_){ }
        try{ if(window.trackEvent){ window.trackEvent('Lead', {lead_type:'checkout', value: payload && payload.value, currency: payload && payload.currency, num_items: payload && payload.num_items}); } }catch(_){ }
      }, {passive:true});
    });
  }catch(_){ }
});
</script>

{% endif %}
{% endblock %}

{% endblock %}
