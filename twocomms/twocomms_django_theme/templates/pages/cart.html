{% extends 'base.html' %}
{% load static %}
{% load math_filters %}
{% load responsive_images %}

{% block title %}Кошик — TwoComms{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Анимация искр для всей страницы -->
<div class="cart-page-sparks">
  <div class="cart-page-spark cart-page-spark-1"></div>
  <div class="cart-page-spark cart-page-spark-2"></div>
  <div class="cart-page-spark cart-page-spark-3"></div>
  <div class="cart-page-spark cart-page-spark-4"></div>
  <div class="cart-page-spark cart-page-spark-5"></div>
  <div class="cart-page-spark cart-page-spark-6"></div>
</div>

<div class="cart-page-container">
  <!-- Заголовок страницы -->
  <div class="cart-page-header">
    <div class="cart-page-header-icon">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
      </svg>
    </div>
    <div class="cart-page-header-content">
      <h1 class="cart-page-title">Кошик</h1>
      <p class="cart-page-subtitle">Ваші вибрані товари</p>
    </div>
    {% if items %}
    <button type="button" class="cart-clear-btn" onclick="cleanCart()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
      </svg>
      Очистити
    </button>
    {% endif %}
  </div>

  <!-- Сообщения -->
  {% if messages %}
    {% for message in messages %}
      <div class="cart-message cart-message-{{ message.tags }}">
        <div class="cart-message-icon">
          {% if message.tags == 'success' %}
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          {% elif message.tags == 'error' %}
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          {% else %}
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
            </svg>
          {% endif %}
        </div>
        <div class="cart-message-text">{{ message }}</div>
        <button type="button" class="cart-message-close" onclick="this.parentElement.remove()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="cart-page-content">
    <!-- Основная часть корзины -->
    <div class="cart-main-section">
      {% if items %}
        <div class="cart-items-background">
          <div class="cart-items-pattern"></div>
        </div>
        <div class="cart-items-container" id="cart-list">
          {% for it in items %}
            <div class="cart-item" data-cart-row data-key="{{ it.key }}">
              <!-- Анимация искр для товара -->
              <div class="cart-item-sparks">
                <div class="cart-item-spark cart-item-spark-1"></div>
                <div class="cart-item-spark cart-item-spark-2"></div>
                <div class="cart-item-spark cart-item-spark-3"></div>
              </div>
              
              <div class="cart-item-image">
                {% if it.color_variant and it.color_variant.images.exists %}
                  <img src="{{ it.color_variant.images.first.image.url }}" 
                       alt="{{ it.product.title }} - товар у кошику TwoComms" 
                       class="cart-item-img"
                       width="80" height="80">
                {% elif it.product.main_image %}
                  <img src="{{ it.product.main_image.url }}" 
                       alt="{{ it.product.title }} - товар у кошику TwoComms" 
                       class="cart-item-img"
                       width="80" height="80">
                {% else %}
                  {% static 'img/placeholder.jpg' as ph_url %}
                  <img src="{{ ph_url }}" 
                       alt="{{ it.product.title }} - товар у кошику TwoComms" 
                       class="cart-item-img"
                       width="80" height="80">
                {% endif %}
                <div class="cart-item-image-glow"></div>
              </div>
              
              <div class="cart-item-info">
                <h3 class="cart-item-title">{{ it.product.title }}</h3>
                <div class="cart-item-details">
                  <div class="cart-item-detail">
                    <span class="cart-item-label">Розмір:</span>
                    <span class="cart-item-value">{{ it.size }}</span>
                  </div>
                  <div class="cart-item-detail">
                    <span class="cart-item-label">Кількість:</span>
                    <span class="cart-item-value">{{ it.qty }}</span>
                  </div>
                  {% if it.color_variant %}
                  <div class="cart-item-detail">
                    <span class="cart-item-label">Колір:</span>
                    <div class="cart-item-color d-flex align-items-center gap-2">
                      {% with p=it.color_variant.color.primary_hex s=it.color_variant.color.secondary_hex %}
                      <span class="cart-item-swatch swatch"
                            data-primary="{{ p }}"
                            data-secondary="{{ s|default:'' }}">
                      </span>
                      {% endwith %}
                      <span class="cart-item-color-name">{{ it.color_label|default:'—' }}</span>
                    </div>
                  </div>
                  {% endif %}
                </div>
                <div class="cart-item-price">
                  <span class="cart-item-price-label">Ціна:</span>
                  <span class="cart-item-price-value">{{ it.unit_price }} грн</span>
                </div>
                <!-- Информация о баллах -->
                <div class="cart-item-points">
                  <div class="cart-item-points-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                  </div>
                  <span class="cart-item-points-text">
                    {% if it.product.points_reward %}
                      Заробите {{ it.product.points_reward|multiply:it.qty }} балів
                    {% else %}
                      Бали не нараховуються
                    {% endif %}
                  </span>
                </div>
              </div>
              
              <div class="cart-item-actions">
                <div class="cart-item-total">
                  <span class="cart-item-total-label">Разом:</span>
                  <span class="cart-item-total-value">{{ it.line_total }} грн</span>
                </div>
                <button type="button" class="cart-item-remove-btn" onclick="CartRemoveKey('{{ it.key }}', this); return false;" data-key="{{ it.key }}" onmouseenter="console.log('Mouse enter button:', '{{ it.key }}')" onmouseleave="console.log('Mouse leave button:', '{{ it.key }}')">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                  Видалити
                </button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="cart-empty">
          <div class="cart-empty-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
          </div>
          <h2 class="cart-empty-title">Кошик порожній</h2>
          <p class="cart-empty-text">Додайте товари до кошика, щоб зробити замовлення</p>
          <a href="{% url 'home' %}" class="cart-empty-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            Перейти до покупок
          </a>
        </div>
      {% endif %}
    </div>

    <!-- Боковая панель -->
    <div class="cart-sidebar">
      {% if request.user.is_authenticated %}
        <!-- Карточка: Доставка для авторизованных -->
        <div class="cart-sidebar-card">
          <div class="cart-sidebar-card-header">
            <div class="cart-sidebar-card-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
              </svg>
            </div>
            <h3 class="cart-sidebar-card-title">Доставка</h3>
          </div>
          
          {% with prof=request.user.userprofile %}
          <form method="post" class="cart-sidebar-form" id="deliveryForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="form_type" value="update_profile" id="form_type_input">
            
            <div class="cart-form-group">
              <label class="cart-form-label">ПІБ *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="full_name" class="cart-form-input" placeholder="Прізвище Ім'я По батькові"
                       value="{{ prof.full_name|default:'' }}" required>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Телефон *</label>
              <div class="cart-form-input-wrapper">
                <input type="tel" name="phone" class="cart-form-input" placeholder="+380XXXXXXXXX"
                       value="{{ prof.phone|default:'' }}" required>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Місто *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="city" class="cart-form-input" placeholder="Київ"
                       value="{{ prof.city|default:'' }}" required>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Відділення / Поштомат НП *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="np_office" class="cart-form-input" placeholder="№ відділення або адреса поштомата"
                       value="{{ prof.np_office|default:'' }}" required>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Тип оплати *</label>
              <div class="cart-form-input-wrapper">
                <select name="pay_type" class="cart-form-select" id="pay_type_auth" required aria-label="Тип оплати">
                  <option value="">Оберіть тип оплати</option>
                  <option value="online_full" {% if prof.pay_type == 'online_full' or prof.pay_type == 'full' %}selected{% endif %}>Онлайн оплата (повна сума)</option>
                  <option value="prepay_200" {% if prof.pay_type == 'prepay_200' or prof.pay_type == 'partial' %}selected{% endif %}>Передплата 200 грн (решта при отриманні)</option>
                </select>
                <div class="cart-form-input-glow"></div>
              </div>
            </div>
            
            <!-- Кнопка консультации -->
            <div class="cart-form-group">
              <button type="button" class="btn-contact-manager" id="contactManagerBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                  <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                  <path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
                </svg>
                💬 Потрібна консультація?
              </button>
            </div>
            
            <button type="submit" class="cart-form-save-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
              Зберегти зміни
            </button>
          </form>
          {% endwith %}
        </div>
      {% else %}
        <!-- Карточка: Доставка для гостей -->
        <div class="cart-sidebar-card">
          <div class="cart-sidebar-card-header">
            <div class="cart-sidebar-card-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
              </svg>
            </div>
            <h3 class="cart-sidebar-card-title">Доставка</h3>
            <a href="{% url 'login' %}" class="cart-auth-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
              </svg>
              Авторизація
            </a>
          </div>
          
          <div class="cart-sidebar-card-hint">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
            </svg>
            Щоб не вводити дані кожного разу — авторизуйтесь і накопичуйте бали.
          </div>
          
          <form method="post" class="cart-sidebar-form" id="guest-form">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="guest_order">
            
            <div class="cart-form-group">
              <label class="cart-form-label">ПІБ *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="full_name" class="cart-form-input" placeholder="Прізвище Ім'я По батькові" required>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.full_name.errors %}
                <div class="cart-form-error">{{ guest_form.full_name.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Телефон *</label>
              <div class="cart-form-input-wrapper">
                <input type="tel" name="phone" class="cart-form-input" placeholder="+380XXXXXXXXX" required>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.phone.errors %}
                <div class="cart-form-error">{{ guest_form.phone.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Місто *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="city" class="cart-form-input" placeholder="Київ" required>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.city.errors %}
                <div class="cart-form-error">{{ guest_form.city.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Відділення / Поштомат НП *</label>
              <div class="cart-form-input-wrapper">
                <input type="text" name="np_office" class="cart-form-input" placeholder="№ відділення або адреса поштомата" required>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.np_office.errors %}
                <div class="cart-form-error">{{ guest_form.np_office.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="cart-form-group">
              <label class="cart-form-label">Тип оплати *</label>
              <div class="cart-form-input-wrapper">
                <select name="pay_type" class="cart-form-select" id="pay_type_guest" required aria-label="Тип оплати">
                  <option value="">Оберіть тип оплати</option>
                  <option value="online_full">Онлайн оплата (повна сума)</option>
                  <option value="prepay_200">Передплата 200 грн (решта при отриманні)</option>
                </select>
                <div class="cart-form-input-glow"></div>
              </div>
              {% if guest_form.pay_type.errors %}
                <div class="cart-form-error">{{ guest_form.pay_type.errors.0 }}</div>
              {% endif %}
            </div>
            
            <!-- Кнопка консультации -->
            <div class="cart-form-group">
              <button type="button" class="btn-contact-manager" id="contactManagerBtnGuest">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                  <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                  <path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
                </svg>
                💬 Потрібна консультація?
              </button>
            </div>
          </form>
        </div>
      {% endif %}

      <!-- Карточка: Промокод -->
      <div class="cart-sidebar-card">
        <div class="cart-sidebar-card-header">
          <div class="cart-sidebar-card-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
            </svg>
          </div>
          <h3 class="cart-sidebar-card-title">Промокод</h3>
          {% if applied_promo %}
            <span class="cart-promo-badge">Застосовано</span>
          {% endif %}
        </div>
        
        {% if applied_promo %}
          <div class="cart-promo-applied">
            <div class="cart-promo-applied-content">
              <div class="cart-promo-applied-code">{{ applied_promo.code }}</div>
              <div class="cart-promo-applied-discount">Знижка: {{ applied_promo.discount }} грн</div>
            </div>
            <button type="button" class="cart-promo-remove-btn" onclick="removePromoCode()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
        {% else %}
          <div class="cart-promo-input-group">
            <div class="cart-promo-input-wrapper">
              <input type="text" id="promo-code-input" class="cart-promo-input" placeholder="Введіть код промокоду" maxlength="20">
              <div class="cart-promo-input-glow"></div>
            </div>
            <button type="button" class="cart-promo-apply-btn" onclick="applyPromoCode()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            </button>
          </div>
          <div id="promo-message" class="cart-promo-message"></div>
        {% endif %}
      </div>

      <!-- Карточка: Оформление заказа -->
      <div class="cart-checkout-card">
        <div class="cart-checkout-header">
          <div class="cart-checkout-header-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div class="cart-checkout-header-content">
            <h3 class="cart-checkout-title">Оформлення замовлення</h3>
            <p class="cart-checkout-subtitle">Підсумок вашого замовлення</p>
          </div>
        </div>
        
        <div class="cart-checkout-summary">
          <div class="cart-summary-row">
            <span class="cart-summary-label">Товари ({{ items|length }}):</span>
            <span class="cart-summary-value">{{ grand_total }} грн</span>
          </div>
          
          {% if applied_promo %}
          <div class="cart-summary-row cart-summary-discount">
            <span class="cart-summary-label">
              <div class="cart-discount-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                Знижка промокоду
              </div>
            </span>
            <span class="cart-summary-value">-{{ applied_promo.discount }} грн</span>
          </div>
          {% endif %}
          
          <div class="cart-summary-row cart-summary-total" id="pay-now-row">
            <span class="cart-summary-label" id="pay-now-label">До сплати:</span>
            <span class="cart-summary-value"
                  id="pay-now-amount"
                  data-total="{{ grand_total|floatformat:'2' }}"
                  data-prepay="200">{{ grand_total }} грн</span>
          </div>
          <div class="cart-summary-row cart-summary-prepay d-none" id="prepay-remaining-row">
            <span class="cart-summary-label">Залишок при отриманні:</span>
            <span class="cart-summary-value" id="prepay-remaining-amount">{{ grand_total }} грн</span>
          </div>
          <p class="cart-summary-note d-none" id="prepay-note">
            Це додаткова передоплата для вас — решту сплатите при отриманні.
          </p>
        </div>
        
        <!-- Информация о баллах -->
        <div class="cart-points-summary">
          <div class="cart-points-header">
            <div class="cart-points-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </div>
            <span class="cart-points-title">Бали за замовлення</span>
          </div>
          
          {% if request.user.is_authenticated %}
            {% if total_points > 0 %}
              <div class="cart-points-earned">
                <span class="cart-points-amount">+{{ total_points }} балів</span>
                <span class="cart-points-description">буде нараховано після отримання товару</span>
              </div>
            {% else %}
              <div class="cart-points-none">
                <span class="cart-points-text">Бали не нараховуються</span>
              </div>
            {% endif %}
          {% else %}
            <div class="cart-points-guest">
              <div class="cart-points-guest-info">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
                <span>Для отримання балів потрібно авторизуватися</span>
              </div>
              <a href="{% url 'login' %}" class="cart-points-login-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
                </svg>
                Авторизуватися
              </a>
            </div>
          {% endif %}
        </div>
        
        <div class="cart-delivery-info">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
          </svg>
          Доставка оплачується згідно тарифів перевізника.
        </div>

<div class="cart-checkout-actions">
  <!-- Monobank онлайн оплата -->
  <div class="cart-monobank-container" data-mono-status-scope>
    <button type="button" id="monobank-pay-btn" class="cart-monobank-btn" data-monobank-pay-trigger="cart">
      <span class="cart-monobank-logo" aria-hidden="true">
        <span class="mono">mono</span><span class="dot">·</span><span class="pay">pay</span>
      </span>
      <span class="cart-monobank-details">
        <span class="cart-monobank-text">Онлайн оплата карткою</span>
        <span class="cart-monobank-badges" aria-hidden="true">
          <span class="cart-monobank-badge cart-monobank-badge-gpay" role="presentation">
            <span class="badge-symbol">G</span>
            <span class="badge-text">Pay</span>
          </span>
          <span class="cart-monobank-badge cart-monobank-badge-apple" role="presentation">
            <span class="badge-symbol" aria-hidden="true"></span>
            <span class="badge-text">Pay</span>
          </span>
        </span>
      </span>
      <span class="cart-monobank-spinner" aria-hidden="true"></span>
    </button>
    <div id="monobank-pay-status" class="cart-monobank-status text-secondary" data-mono-checkout-status role="status" aria-live="polite"></div>
  </div>



          {% if request.user.is_authenticated %}
            <button type="button" class="cart-checkout-btn" id="placeOrderBtn" data-monobank-pay-trigger="cart">
              <div class="cart-checkout-btn-content">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span>Оформити замовлення</span>
              </div>
              <div class="cart-checkout-btn-glow"></div>
            </button>
          {% else %}
            <button type="button" class="cart-checkout-btn cart-checkout-btn-guest" id="guestOrderBtn" data-monobank-pay-trigger="cart">
              <div class="cart-checkout-btn-content">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27л-5 4.87 1.18 6.88L12 17.77л-6.18 3.25Л7 14.14 2 9.27л6.91-1.01L12 2z"/>
                </svg>
                <span>Замовити як гість</span>
              </div>
              <div class="cart-checkout-btn-glow"></div>
            </button>
          {% endif %}
          <div class="cart-checkout-note text-secondary mt-3">
            Після оформлення замовлення менеджер зв'яжеться з вами за вказаним номером телефону, щоб підтвердити деталі та узгодити доставку.
          </div>
        </div>


      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block modals %}
<!-- Модальное окно консультации (ВНЕ main контейнера для правильного позиционирования!) -->
<div id="contactManagerModal" class="contact-modal-overlay" aria-hidden="true" role="dialog" aria-labelledby="contactModalTitle">
  <div class="contact-modal-container">
    <div class="contact-modal-header">
      <h3 id="contactModalTitle">💬 Безкоштовна консультація</h3>
      <button type="button" class="contact-modal-close" aria-label="Закрити">&times;</button>
    </div>
    <div class="contact-modal-body">
      <p style="margin-bottom: 1.5rem; color: #64748b; text-align: center;">Залиште свої контактні дані, і наш менеджер зв'яжеться з вами найближчим часом для консультації</p>
      <form id="contactManagerForm">
        {% csrf_token %}
        
        <div class="contact-modal-form-group">
          <label class="contact-modal-label" for="contactModalFullName">
            ПІБ <span style="color: #e53e3e;">*</span>
          </label>
          <input 
            type="text" 
            id="contactModalFullName" 
            name="full_name" 
            class="contact-modal-input" 
            placeholder="Введіть ваше ПІБ" 
            required
            minlength="3"
          >
        </div>
        
        <div class="contact-modal-form-group">
          <label class="contact-modal-label" for="contactModalPhone">
            Телефон <span style="color: #e53e3e;">*</span>
          </label>
          <input 
            type="tel" 
            id="contactModalPhone" 
            name="phone" 
            class="contact-modal-input" 
            placeholder="+380 XX XXX XX XX" 
            required
            pattern="[+]?[0-9\s\-\(\)]+"
          >
        </div>
        
        <div class="contact-modal-form-group">
          <label class="contact-modal-label" for="contactModalTelegram">
            Telegram
          </label>
          <input 
            type="text" 
            id="contactModalTelegram" 
            name="telegram" 
            class="contact-modal-input" 
            placeholder="@username або номер телефону"
          >
          <div class="contact-modal-help-text">Опціонально, але допоможе зв'язатися швидше</div>
        </div>
        
        <div class="contact-modal-form-group">
          <label class="contact-modal-label" for="contactModalWhatsApp">
            WhatsApp
          </label>
          <input 
            type="tel" 
            id="contactModalWhatsApp" 
            name="whatsapp" 
            class="contact-modal-input" 
            placeholder="+380 XX XXX XX XX"
            pattern="[+]?[0-9\s\-\(\)]+"
          >
          <div class="contact-modal-help-text">Опціонально</div>
        </div>
        
        <button type="submit" class="contact-modal-submit-btn">
          📲 Зв'язатися зі мною
        </button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Валидация форм, промокоды и удаление строк перенесены в main.js
function initCartPage() {
    const guestForm = document.getElementById('guest-form');
    const deliveryForm = document.getElementById('deliveryForm');
    
    // ==================== ДИНАМИЧЕСКИЕ КНОПКИ (ПРИОРИТЕТ #1) ====================
    // ВАЖНО: Этот код ДОЛЖЕН выполниться первым, поэтому он в самом начале!
    try {
      console.log('🚀 Initializing dynamic button text...');
      
      // Находим кнопку (либо для авторизованных, либо для гостей)
    const placeOrderBtn = document.getElementById('placeOrderBtn');
      const guestOrderBtn = document.getElementById('guestOrderBtn');
      const activeOrderBtn = placeOrderBtn || guestOrderBtn;
      
      // Находим селект pay_type (либо auth, либо guest)
      const payTypeAuthSelect = document.getElementById('pay_type_auth');
      const payTypeGuestSelect = document.getElementById('pay_type_guest');
      const activePayTypeSelect = payTypeAuthSelect || payTypeGuestSelect;
      
      console.log('🔍 Cart button initialization:', {
        placeOrderBtn: !!placeOrderBtn,
        guestOrderBtn: !!guestOrderBtn,
        activeOrderBtn: !!activeOrderBtn,
        payTypeAuthSelect: !!payTypeAuthSelect,
        payTypeGuestSelect: !!payTypeGuestSelect,
        activePayTypeSelect: !!activePayTypeSelect
      });
      
      const payNowAmountEl = document.getElementById('pay-now-amount');
      const payNowLabelEl = document.getElementById('pay-now-label');
      const prepayRemainingRow = document.getElementById('prepay-remaining-row');
      const prepayRemainingAmountEl = document.getElementById('prepay-remaining-amount');
      const prepayNoteEl = document.getElementById('prepay-note');
      const parseNumeric = (raw) => {
        if (raw == null) {
          return NaN;
        }
        const cleaned = String(raw)
          .replace(/\u00A0/g, '')
          .replace(/\s/g, '')
          .replace(',', '.');
        const parsed = Number.parseFloat(cleaned);
        return Number.isFinite(parsed) ? parsed : NaN;
      };
      
      const paymentSummary = {
        total: payNowAmountEl ? parseNumeric(payNowAmountEl.dataset.total || '0') : 0,
        prepay: payNowAmountEl ? parseNumeric(payNowAmountEl.dataset.prepay || '200') : 200
      };
      
      if (!Number.isFinite(paymentSummary.total)) {
        paymentSummary.total = 0;
      }
      if (!Number.isFinite(paymentSummary.prepay) || paymentSummary.prepay <= 0) {
        paymentSummary.prepay = 200;
      }
      
      function formatUAH(amount) {
        const normalized = Number.isFinite(amount) ? amount : 0;
        const opts = (Math.abs(normalized % 1) < 1e-9)
          ? {minimumFractionDigits: 0, maximumFractionDigits: 0}
          : {minimumFractionDigits: 2, maximumFractionDigits: 2};
        return normalized.toLocaleString('uk-UA', opts) + ' грн';
      }
      
      function updatePaymentSummary(payType) {
        if (!payNowAmountEl) {
          return;
        }
        
        const isPrepay = payType === 'prepay_200';
        const payNow = isPrepay ? Math.min(paymentSummary.prepay, paymentSummary.total || paymentSummary.prepay) : paymentSummary.total;
        const remaining = Math.max((paymentSummary.total || 0) - (paymentSummary.prepay || 0), 0);
        
        if (payNowLabelEl) {
          payNowLabelEl.textContent = isPrepay ? 'До сплати зараз:' : 'До сплати:';
        }
        payNowAmountEl.textContent = formatUAH(payNow);
        
        if (prepayRemainingRow) {
          if (isPrepay) {
            prepayRemainingRow.classList.remove('d-none');
            if (prepayRemainingAmountEl) {
              prepayRemainingAmountEl.textContent = formatUAH(remaining);
            }
          } else {
            prepayRemainingRow.classList.add('d-none');
          }
        }
        
        if (prepayNoteEl) {
          prepayNoteEl.classList.toggle('d-none', !isPrepay);
        }
      }

      function updateOrderButtonText(payType) {
        const btn = activeOrderBtn;
        if (!btn) {
          console.error('❌ Button not found!');
          return;
        }
        
        const btnTextSpan = btn.querySelector('span');
        if (!btnTextSpan) {
          console.error('❌ Button span not found!');
          return;
        }
        
        console.log('🔄 Updating button text for pay_type:', payType);
        
        let newText = '';
        switch(payType) {
          case 'online_full':
            newText = 'Перейти до оплати';
            break;
          case 'prepay_200':
            newText = 'Внести передплату 200 грн';
            break;
          default:
            newText = placeOrderBtn ? 'Оформити замовлення' : 'Замовити як гість';
        }
        
        btnTextSpan.textContent = newText;
        console.log('✅ Button text updated to:', newText);
        updatePaymentSummary(payType);
      }

      // Обработчик изменения pay_type
      if (activePayTypeSelect) {
        activePayTypeSelect.addEventListener('change', function() {
          console.log('📝 Pay type changed to:', this.value);
          updateOrderButtonText(this.value);
        });
        
        // Устанавливаем начальное значение при загрузке
        if (activePayTypeSelect.value) {
          console.log('🎬 Initial pay_type:', activePayTypeSelect.value);
          updateOrderButtonText(activePayTypeSelect.value);
        } else {
          console.log('⚠️ No initial pay_type selected');
          updatePaymentSummary('online_full');
        }
      } else {
        console.error('❌ Pay type select not found!');
        updatePaymentSummary('online_full');
            }
      console.log('✅ Dynamic button text initialized successfully!');
    } catch (error) {
      console.error('❌ Error initializing dynamic button text:', error);
    }
    // ==================== END ДИНАМИЧЕСКИЕ КНОПКИ ====================
    
    // Функция для валидации формы
    function setupFormValidation(form) {
        if (!form) return;
        
        // Подсветка полей с ошибками
        const errorFields = form.querySelectorAll('.cart-form-error');
        errorFields.forEach(function(errorDiv) {
            const field = errorDiv.previousElementSibling?.querySelector('input, select');
            if (field) {
                field.classList.add('cart-form-input-error');
            }
        });
        
        // Валидация в реальном времени
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(function(input) {
            input.addEventListener('blur', function() {
                validateField(this);
            });
            
            input.addEventListener('input', function() {
                // Убираем красную подсветку при вводе
                if (this.classList.contains('cart-form-input-error')) {
                    this.classList.remove('cart-form-input-error');
                    const errorDiv = this.parentNode.parentNode.querySelector('.cart-form-error');
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                }
            });
        });
        
        // Валидация при отправке формы
        form.addEventListener('submit', function(e) {
            let isValid = true;
            let firstErrorField = null;
            
            inputs.forEach(function(input) {
                if (!validateField(input)) {
                    isValid = false;
                    if (!firstErrorField) {
                        firstErrorField = input;
                    }
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                // Показываем сообщение об ошибке
                showError('Будь ласка, виправте помилки в формі');
                
                // Прокручиваем к первому полю с ошибкой
                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    firstErrorField.focus();
                }
            }
        });
    }
    
    // Настраиваем подсветку серверных ошибок, остальная логика в main.js
    (function highlightServerErrors(){
      [guestForm, deliveryForm].forEach(function(form){
        if(!form) return; form.querySelectorAll('.cart-form-error').forEach(function(err){
          var field = err.previousElementSibling && err.previousElementSibling.querySelector('input, select');
          if(field){ field.classList.add('cart-form-input-error'); }
        });
      });
    })();
    
    function validateField(field) {
        const value = field.value.trim();
        let isValid = true;
        let errorMessage = '';
        
        // Убираем старые ошибки
        field.classList.remove('cart-form-input-error');
        const existingError = field.parentNode.parentNode.querySelector('.cart-form-error');
        if (existingError) {
            existingError.style.display = 'none';
        }
        
        // Проверяем обязательные поля
        if (field.hasAttribute('required') && !value) {
            isValid = false;
            errorMessage = 'Це поле обов\'язкове';
        } else if (value) {
            // Специфичные проверки
            if (field.name === 'full_name') {
                if (value.length < 3) {
                    isValid = false;
                    errorMessage = 'ПІБ повинно містити мінімум 3 символи';
                } else if (!/[а-яёіїєґa-z]/i.test(value)) {
                    isValid = false;
                    errorMessage = 'ПІБ повинно містити літери';
                }
            } else if (field.name === 'phone') {
                const phoneClean = value.replace(/[^\d+]/g, '');
                if (!phoneClean.startsWith('+380')) {
                    isValid = false;
                    errorMessage = 'Телефон повинен починатися з +380';
                } else if (phoneClean.length !== 13) {
                    isValid = false;
                    errorMessage = 'Телефон повинен містити 13 символів';
                }
            } else if (field.name === 'city') {
                if (value.length < 2) {
                    isValid = false;
                    errorMessage = 'Назва міста повинна містити мінімум 2 символи';
                }
            } else if (field.name === 'np_office') {
                if (value.length < 1) {
                    isValid = false;
                    errorMessage = 'Введіть адресу відділення';
                }
            }
        }
        
        // Показываем ошибку если есть
        if (!isValid) {
            field.classList.add('cart-form-input-error');
            showFieldError(field, errorMessage);
        }
        
        return isValid;
    }
    
    function showFieldError(field, message) {
        // Убираем старую ошибку
        const existingError = field.parentNode.parentNode.querySelector('.cart-form-error');
        if (existingError) {
            existingError.textContent = message;
            existingError.style.display = 'block';
        } else {
            // Создаем новую ошибку
            const errorDiv = document.createElement('div');
            errorDiv.className = 'cart-form-error';
            errorDiv.textContent = message;
            field.parentNode.parentNode.appendChild(errorDiv);
        }
    }
    
    function showError(message) {
        // Показываем общее сообщение об ошибке
        const errorAlert = document.createElement('div');
        errorAlert.className = 'cart-message cart-message-error';
        errorAlert.innerHTML = `
          <div class="cart-message-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div class="cart-message-text">${message}</div>
          <button type="button" class="cart-message-close" onclick="this.parentElement.remove()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        `;
        
        const container = document.querySelector('.cart-page-container');
        container.insertBefore(errorAlert, container.firstChild);
        
        // Убираем через 5 секунд
        setTimeout(function() {
            errorAlert.remove();
        }, 5000);
    }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCartPage);
} else {
  initCartPage();
}
</script>
{% if items %}
<div id="checkout-payload"
     data-value="{{ grand_total }}"
     data-currency="UAH"
     data-num-items="{{ items|length }}"
     data-ids='[{% for it in items %}"{{ it.product.id }}"{% if not forloop.last %},{% endif %}{% endfor %}]'
     data-contents='[{% for it in items %}{"id":"{{ it.product.id }}","quantity":{{ it.qty }},"item_price":{{ it.unit_price }}}{% if not forloop.last %},{% endif %}{% endfor %}]'
     style="display:none"></div>

<!-- Монобанк функціональність -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    var el = document.getElementById('checkout-payload');
    if(!el) return;
    var payload = (function(){
      var contents=[]; try{ contents = JSON.parse(el.dataset.contents||'[]'); }catch(_){ contents=[]; }
      var ids=[]; try{ ids = JSON.parse(el.dataset.ids||'[]'); }catch(_){ ids=[]; }
      var value = parseFloat(el.dataset.value||'0');
      var currency = el.dataset.currency||'UAH';
      var numItems = parseInt(el.dataset.numItems||String(contents.length)||'0',10) || contents.length;
      return { contents: contents, content_ids: ids, content_type: 'product', value: value, currency: currency, num_items: numItems };
    })();
    document.querySelectorAll('.cart-checkout-btn').forEach(function(btn){
      if(btn._icBound) return; btn._icBound = true;
      btn.addEventListener('click', function(){
        try{ if(window.trackEvent){ window.trackEvent('InitiateCheckout', payload); } }catch(_){ }
        try{ if(window.trackEvent){ window.trackEvent('Lead', {lead_type:'checkout', value: payload && payload.value, currency: payload && payload.currency, num_items: payload && payload.num_items}); } }catch(_){ }
      }, {passive:true});
    });
  }catch(_){ }
});
</script>

{% endif %}

<!-- Модальное окно авторизации для использования промокодов -->
<div class="modal fade" id="promoAuthModal" tabindex="-1" aria-labelledby="promoAuthModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 16px; border: none; overflow: hidden;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--accent-color), #7c3aed); color: #fff; border: none; padding: 1.5rem;">
        <div class="d-flex align-items-center gap-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: rgba(255, 255, 255, 0.2);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
            </svg>
          </div>
          <div>
            <h5 class="modal-title fw-bold mb-0" id="promoAuthModalLabel">Використання промокоду</h5>
            <div class="small opacity-90">Авторизуйтесь для застосування знижки</div>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрити"></button>
      </div>
      <div class="modal-body" style="padding: 2rem;">
        <div class="mb-4 p-3 rounded-3" style="background: #f8f9fa;">
          <div class="d-flex gap-2 align-items-start">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--accent-color)" style="flex-shrink: 0; margin-top: 2px;">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
            </svg>
            <div class="small text-secondary">
              <strong>Промокоди доступні тільки для зареєстрованих користувачів.</strong><br>
              Це дозволяє відстежувати використання та запобігати зловживанням.
            </div>
          </div>
        </div>
        
        <div class="d-grid gap-3">
          <a href="{% url 'social:begin' 'google-oauth2' %}?next={{ request.path }}" class="btn btn-lg d-flex align-items-center justify-content-center gap-2" style="background: #fff; border: 2px solid #e9ecef; color: #212529; border-radius: 12px; padding: 0.875rem;">
            <img src="{% static 'img/google.svg' %}" alt="Google" width="20" height="20">
            <span class="fw-semibold">Увійти через Google</span>
          </a>
          
          <div class="text-center text-secondary small">або</div>
          
          <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-lg d-flex align-items-center justify-content-center gap-2" style="background: linear-gradient(135deg, var(--accent-color), #7c3aed); color: #fff; border: none; border-radius: 12px; padding: 0.875rem;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
            </svg>
            <span class="fw-semibold">Увійти в акаунт</span>
          </a>
          
          <div class="text-center">
            <span class="text-secondary small">Ще немає акаунту?</span>
            <a href="{% url 'register' %}?next={{ request.path }}" class="text-decoration-none fw-semibold small">Зареєструватись</a>
          </div>
        </div>
        
        <div class="mt-4 p-3 rounded-3" style="background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(124,58,237,0.1)); border: 1px solid rgba(124,58,237,0.2);">
          <div class="d-flex gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="var(--accent-color)" style="flex-shrink: 0; margin-top: 2px;">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <div class="small">
              <strong class="d-block mb-1">Переваги реєстрації:</strong>
              <ul class="mb-0 ps-3">
                <li>Накопичуйте бали за покупки</li>
                <li>Отримуйте ексклюзивні промокоди</li>
                <li>Швидке оформлення наступних замовлень</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript для обработки промокодів з перевіркою авторизації -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Оригинальная функция applyPromoCode (если существует в main.js, переопределяем)
  window.applyPromoCodeOriginal = window.applyPromoCode;
  
  window.applyPromoCode = function() {
    const promoInput = document.getElementById('promo-code-input');
    const promoMessage = document.getElementById('promo-message');
    
    if (!promoInput || !promoMessage) {
      console.error('Promo code elements not found');
      return;
    }
    
    const code = promoInput.value.trim();
    
    if (!code) {
      promoMessage.textContent = 'Введіть код промокоду';
      promoMessage.className = 'cart-promo-message cart-promo-message-error';
      promoMessage.style.display = 'block';
      return;
    }
    
    // Отправляем запрос на применение промокода
    fetch('{% url "apply_promo_code" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: 'promo_code=' + encodeURIComponent(code)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success || data.ok) {
        // Успешно применен промокод
        promoMessage.textContent = data.message || 'Промокод застосовано!';
        promoMessage.className = 'cart-promo-message cart-promo-message-success';
        promoMessage.style.display = 'block';
        
        // Перезагружаем страницу для обновления корзины
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else if (data.auth_required) {
        // Требуется авторизация - показываем модальное окно
        promoMessage.textContent = data.message || data.error;
        promoMessage.className = 'cart-promo-message cart-promo-message-info';
        promoMessage.style.display = 'block';
        
        // Показываем модальное окно авторизации
        const modal = new bootstrap.Modal(document.getElementById('promoAuthModal'));
        modal.show();
      } else {
        // Ошибка применения промокода
        promoMessage.textContent = data.error || data.message || 'Помилка застосування промокоду';
        promoMessage.className = 'cart-promo-message cart-promo-message-error';
        promoMessage.style.display = 'block';
      }
    })
    .catch(error => {
      console.error('Error applying promo code:', error);
      promoMessage.textContent = 'Помилка з\'єднання. Спробуйте ще раз.';
      promoMessage.className = 'cart-promo-message cart-promo-message-error';
      promoMessage.style.display = 'block';
    });
  };
  
  // Функция удаления промокода (если нужна)
  window.removePromoCodeOriginal = window.removePromoCode;
  
  window.removePromoCode = function() {
    const promoMessage = document.getElementById('promo-message');
    
    fetch('{% url "remove_promo_code" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success || data.ok) {
        // Перезагружаем страницу
        window.location.reload();
      } else {
        if (promoMessage) {
          promoMessage.textContent = data.error || 'Помилка видалення промокоду';
          promoMessage.className = 'cart-promo-message cart-promo-message-error';
          promoMessage.style.display = 'block';
        }
      }
    })
    .catch(error => {
      console.error('Error removing promo code:', error);
      if (promoMessage) {
        promoMessage.textContent = 'Помилка з\'єднання';
        promoMessage.className = 'cart-promo-message cart-promo-message-error';
        promoMessage.style.display = 'block';
      }
    });
  };
  
  // ==================== МОДАЛЬНОЕ ОКНО КОНСУЛЬТАЦИИ (КАК В DROPSHIPPER) ====================
  const contactBtns = document.querySelectorAll('#contactManagerBtn, #contactManagerBtnGuest');
  const modal = document.getElementById('contactManagerModal');
  const modalClose = document.querySelector('.contact-modal-close');
  const modalForm = document.getElementById('contactManagerForm');
  
  // Функция открытия модального окна с анимацией
  function openContactModal() {
    // Автозаполнение из формы доставки
    const isAuth = document.getElementById('pay_type_auth') !== null;
    
    if (isAuth) {
      const fullNameInput = document.querySelector('[name="full_name"]');
      const phoneInput = document.querySelector('[name="phone"]');
      
      if (fullNameInput && fullNameInput.value) {
        document.getElementById('contactModalFullName').value = fullNameInput.value;
      }
      if (phoneInput && phoneInput.value) {
        document.getElementById('contactModalPhone').value = phoneInput.value;
      }
    } else {
      // Для гостей из guest-form
      const guestForm = document.getElementById('guest-form');
      if (guestForm) {
        const fullNameInput = guestForm.querySelector('[name="full_name"]');
        const phoneInput = guestForm.querySelector('[name="phone"]');
        
        if (fullNameInput && fullNameInput.value) {
          document.getElementById('contactModalFullName').value = fullNameInput.value;
        }
        if (phoneInput && phoneInput.value) {
          document.getElementById('contactModalPhone').value = phoneInput.value;
        }
      }
    }
    
    // КРИТИЧНО: Добавляем класс на body который убирает position: relative у контейнеров
    // Это позволяет модальному окну с position: fixed позиционироваться относительно viewport
    document.body.classList.add('contact-modal-open');
    
    // Показываем модальное окно
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Добавляем класс для анимации (после небольшой задержки для срабатывания CSS transition)
    setTimeout(() => {
      modal.classList.add('modal-active');
    }, 10);
  }
  
  // Функция закрытия модального окна с анимацией
  function closeContactModal() {
    // Убираем класс для анимации закрытия
    modal.classList.remove('modal-active');
    
    // КРИТИЧНО: Убираем класс с body чтобы вернуть position: relative контейнерам
    document.body.classList.remove('contact-modal-open');
    
    // Ждем завершения анимации (300ms) перед скрытием
    setTimeout(() => {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }, 300);
  }
  
  // Открытие модалки
  contactBtns.forEach(btn => {
    btn.addEventListener('click', openContactModal);
  });
  
  // Закрытие модалки
  if (modalClose) {
    modalClose.addEventListener('click', closeContactModal);
  }
  
  // Закрытие по клику вне модалки
  window.addEventListener('click', function(event) {
    if (event.target === modal) {
      closeContactModal();
    }
  });
  
  // Отправка формы связи с менеджером
  if (modalForm) {
    modalForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(modalForm);
      const submitBtn = modalForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Відправляємо...';
      
      fetch('{% url "contact_manager" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('✅ Дякуємо! Менеджер зв\'яжеться з вами найближчим часом.');
          closeContactModal();
          modalForm.reset();
        } else {
          alert('❌ Помилка: ' + (data.error || 'Спробуйте ще раз'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('❌ Помилка з\'єднання. Спробуйте ще раз.');
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      });
    });
  }
});
</script>

<!-- Стили для кнопки связи с менеджером и модального окна -->
<style>
.btn-contact-manager {
  width: 100%;
  padding: 14px 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-contact-manager:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-contact-manager:active {
  transform: translateY(0);
}

/* Модальное окно */
/* ========== МОДАЛЬНОЕ ОКНО КОНСУЛЬТАЦИИ (ТЕМНЫЙ ДИЗАЙН КАК DROPSHIPPER) ========== */

/* КРИТИЧНО: Убираем position: relative у ВСЕХ контейнеров когда модальное окно открыто */
/* Это позволяет модальному окну с position: fixed позиционироваться относительно viewport, а не контейнера */
body.contact-modal-open,
body.contact-modal-open .cart-page-container,
body.contact-modal-open .cart-container,
body.contact-modal-open main,
body.contact-modal-open .container,
body.contact-modal-open .container-fluid,
body.contact-modal-open .container-xxl,
body.contact-modal-open [class*="container"] {
  position: static !important;
}

/* Убираем псевдоэлементы которые могут использовать position: fixed */
body.contact-modal-open .cart-page-container::before,
body.contact-modal-open .cart-page-container::after,
body.contact-modal-open .cart-container::before,
body.contact-modal-open .cart-container::after {
  display: none !important;
}

.contact-modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(10px);
  z-index: 10000;
  align-items: center;
  justify-content: center;
  padding: 20px;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.contact-modal-overlay.modal-active {
  opacity: 1;
}

.contact-modal-container {
  position: relative;
  background: linear-gradient(135deg, rgba(20,22,27,.98), rgba(14,16,22,.98));
  border: 1px solid rgba(255,255,255,.1);
  border-radius: 20px;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 
    0 25px 60px rgba(0,0,0,.6),
    0 0 80px rgba(139, 92, 246, 0.15),
    inset 0 1px 0 rgba(255,255,255,.05);
  color: #e5e7eb;
  transform: scale(0.8);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.contact-modal-overlay.modal-active .contact-modal-container {
  transform: scale(1);
  opacity: 1;
}

/* Кастомный скроллбар */
.contact-modal-container::-webkit-scrollbar {
  width: 8px;
}

.contact-modal-container::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

.contact-modal-container::-webkit-scrollbar-thumb {
  background: rgba(139, 92, 246, 0.5);
  border-radius: 10px;
}

.contact-modal-container::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 92, 246, 0.7);
}

.contact-modal-header {
  padding: 30px 30px 20px;
  border-bottom: 1px solid rgba(255,255,255,.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(180deg, rgba(139, 92, 246, 0.08) 0%, transparent 100%);
}

.contact-modal-header h3 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
  color: #e5e7eb;
  text-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
}

.contact-modal-close {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  color: rgba(255, 255, 255, 0.6);
}

.contact-modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  transform: rotate(90deg);
  border-color: rgba(139, 92, 246, 0.5);
  box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
}

.contact-modal-body {
  padding: 30px;
}

.contact-modal-body > p {
  margin-bottom: 1.5rem;
  color: rgba(255, 255, 255, 0.6);
  text-align: center;
  font-size: 14px;
  line-height: 1.6;
}

.contact-modal-form-group {
  margin-bottom: 20px;
}

.contact-modal-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 12px;
}

.contact-modal-label span {
  color: #ef4444;
}

.contact-modal-input {
  width: 100%;
  padding: 14px 18px;
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  font-size: 15px;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.05);
  color: #e5e7eb;
  font-family: inherit;
}

.contact-modal-input:focus {
  outline: none;
  border-color: rgba(139, 92, 246, 0.6);
  background: rgba(255, 255, 255, 0.08);
  box-shadow: 
    0 0 0 3px rgba(139, 92, 246, 0.15),
    0 0 20px rgba(139, 92, 246, 0.2);
  transform: translateY(-1px);
}

.contact-modal-input::placeholder {
  color: rgba(255, 255, 255, 0.35);
}

.contact-modal-help-text {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.45);
  margin-top: 6px;
  font-style: italic;
}

.contact-modal-submit-btn {
  width: 100%;
  padding: 16px 24px;
  background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 
    0 4px 15px rgba(139, 92, 246, 0.4),
    0 0 30px rgba(139, 92, 246, 0.2);
  margin-top: 10px;
  position: relative;
  overflow: hidden;
}

.contact-modal-submit-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.contact-modal-submit-btn:hover::before {
  left: 100%;
}

.contact-modal-submit-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 
    0 8px 25px rgba(139, 92, 246, 0.5),
    0 0 40px rgba(139, 92, 246, 0.3);
}

.contact-modal-submit-btn:active:not(:disabled) {
  transform: translateY(0);
}

.contact-modal-submit-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Адаптивность */
@media (max-width: 768px) {
  .contact-modal-container {
    border-radius: 20px 20px 0 0;
    max-height: 85vh;
    max-width: 100%;
  }
  
  .contact-modal-header {
    padding: 20px 20px 15px;
  }
  
  .contact-modal-header h3 {
    font-size: 20px;
  }
  
  .contact-modal-body {
    padding: 20px;
  }
  
  .contact-modal-input {
    padding: 12px 16px;
  }
  
  .contact-modal-submit-btn {
    padding: 14px 20px;
  }
}
</style>

{% endblock %}
