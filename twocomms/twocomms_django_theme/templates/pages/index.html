{% extends "base.html" %}{% load static %}{% load cache %}

{% block title %}TwoComms — Стріт & Мілітарі Одяг | Головна{% endblock %}

{% block description %}TwoComms - магазин стріт & мілітарі одягу з ексклюзивним дизайном. Футболки, худі, лонгсліви з характером. Якісний одяг для сучасного стилю. Швидка доставка по Україні.{% endblock %}

{% block keywords %}стріт одяг, мілітарі одяг, футболки, худі, лонгсліви, TwoComms, ексклюзивний дизайн, якісний одяг, одяг з характером, стріт стиль, мілітарі стиль{% endblock %}

{% block og_type %}website{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "TwoComms",
  "url": "{{ request.scheme }}://{{ request.get_host }}",
  "description": "Магазин стріт & мілітарі одягу з ексклюзивним дизайном",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "{{ request.scheme }}://{{ request.get_host }}/search/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
{% endblock %}

{% block content %}
<section class="hero-section mb-4 mb-md-5 reveal">
  <div class="hero-container">
    <!-- Фоновый логотип -->
    <div class="hero-logo-bg">
      <img src="{% static 'img/logo.svg' %}" alt="TwoComms - Стріт & Мілітарі Одяг" class="hero-logo-image">
    </div>
    
    <!-- Основной контент -->
    <div class="hero-content">
      <div class="hero-text-section">
        <h1 class="hero-title">
          <span class="hero-title-main">Стріт & мілітарі</span>
          <span class="hero-title-accent">одяг</span>
        </h1>
        <p class="hero-subtitle">Футболки, худі, лонгсліви. Дизайн з характером.</p>
        <div class="hero-actions">
          <a class="hero-btn-primary" href="{% url 'catalog' %}">
            <span>Перейти в каталог</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </a>
          <div class="hero-badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <span>Ексклюзивний дизайн</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Декоративные элементы -->
    <div class="hero-decoration">
      <div class="hero-glow"></div>
      <div class="hero-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
      </div>
    </div>
  </div>
</section>
{% if featured %}
<section class="mb-4 mb-md-5 reveal" id="featured-section">
  <!-- Компактный блок рекомендаций в стиле категорий -->
  <div class="featured-unified-block">
    <!-- Фоновые эффекты -->
    <div class="featured-bg-unified">
      <div class="featured-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
      </div>
      <div class="featured-glow"></div>
      <div class="featured-gradient-1"></div>
      <div class="featured-gradient-2"></div>
      <div class="featured-floating-logos">
              <div class="floating-logo logo-1">
                <img src="{% static 'img/logo.svg' %}" alt="TwoComms логотип" width="14" height="14">
              </div>
              <div class="floating-logo logo-2">
                <img src="{% static 'img/logo.svg' %}" alt="TwoComms логотип" width="12" height="12">
              </div>
              <div class="floating-logo logo-3">
                <img src="{% static 'img/logo.svg' %}" alt="TwoComms логотип" width="16" height="16">
              </div>
      </div>
    </div>
    
    <!-- Заголовок с кнопкой сворачивания -->
    <div class="featured-header-unified">
      <div class="d-flex justify-content-between align-items-center">
        <div class="featured-title-compact">
          <div class="title-with-star-icon">
            <div class="featured-badge-compact">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <span>Рекомендовано</span>
            </div>
            <div class="featured-subtitle-compact">Найкращий вибір тижня</div>
          </div>
          <div class="featured-accent-line"></div>
        </div>
        
        <!-- Кнопка сворачивания в центре -->
        <button class="featured-toggle-btn" id="featuredToggle" aria-label="Свернуть/развернуть рекомендации" aria-expanded="false" aria-controls="featured-content">
          <div class="toggle-btn-content">
            <span class="toggle-text">Сховати</span>
            <div class="toggle-icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 10l5 5 5-5z"/>
              </svg>
            </div>
          </div>
        </button>
        
        <div class="featured-spacer"></div>
      </div>
    </div>
    
    <!-- Скрываемый контент -->
    <div class="featured-content-unified" id="featured-content">
      <div class="featured-card-compact">
        <div class="featured-image-compact">
                  <img
                    src="{% if featured.display_image %}{{ featured.display_image.url }}{% else %}{% static 'img/placeholder.jpg' %}{% endif %}"
                    class="featured-img"
                    alt="{{ featured.title }} - {{ featured.category.name }} TwoComms"
                  >
          {% if featured.has_discount and featured.discount_percent %}
            <div class="featured-discount-compact">-{{ featured.discount_percent }}%</div>
          {% endif %}
        </div>
        
        <div class="featured-info-compact">
          <div class="featured-category-compact">{{ featured.category.name }}</div>
          <h3 class="featured-title-compact-text">{{ featured.title }}</h3>
          <div class="featured-price-compact">
            <span class="featured-price-current-compact">{{ featured.final_price }} грн</span>
            {% if featured.has_discount %}
              <span class="featured-price-old-compact">{{ featured.price }} грн</span>
            {% endif %}
          </div>
          <a href="{% url 'product' featured.slug %}" class="featured-btn-compact">
            <span>Переглянути</span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}
{% cache 300 categories_block %}
<section class="mb-4 mb-md-5 reveal categories-section">
  <!-- Единый блок категорий без разделения -->
  <div class="categories-unified-block">
    <!-- Фоновые эффекты для всего блока -->
    <div class="categories-bg-unified">
      <div class="dark-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
      </div>
      <div class="dark-glow"></div>
      <div class="dark-gradient-1"></div>
      <div class="dark-gradient-2"></div>
      <div class="floating-logos">
        <div class="floating-logo logo-1">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="16" height="16">
        </div>
        <div class="floating-logo logo-2">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="14" height="14">
        </div>
        <div class="floating-logo logo-3">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="18" height="18">
        </div>
        <div class="floating-logo logo-4">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="12" height="12">
        </div>
        <div class="floating-logo logo-5">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="15" height="15">
        </div>
      </div>
    </div>
    
    <!-- Заголовок с кнопкой сворачивания -->
    <div class="categories-header-unified">
      <div class="d-flex justify-content-between align-items-center">
        <div class="categories-title-compact">
          <div class="title-with-catalog-icon">
            <h2 class="categories-title-text">Категорії</h2>
            <a href="{% url 'catalog' %}" class="catalog-icon-mobile" aria-label="Перейти в каталог">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
              </svg>
            </a>
          </div>
          <div class="title-accent-line"></div>
        </div>
        
        <!-- Кнопка сворачивания в центре -->
        <button class="categories-toggle-btn" id="categoriesToggle" aria-label="Свернуть/развернуть категории">
          <div class="toggle-btn-content">
            <div class="toggle-icon">
              <svg class="toggle-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
              </svg>
            </div>
            <span class="toggle-text">Свернуть</span>
          </div>
          <div class="toggle-btn-glow"></div>
          <div class="toggle-btn-ripple"></div>
        </button>
        
        <a href="{% url 'catalog' %}" class="catalog-link-compact">
          <span class="catalog-text">Весь каталог</span>
          <svg class="catalog-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
          </svg>
        </a>
      </div>
    </div>

    <!-- Контейнер категорий (без отдельного фона) -->
    <div class="categories-content-unified" id="categoriesContainer">
      <div class="categories-grid-compact">
        <!-- Категории товаров -->
        {% for c in categories %}
        <a href="{% url 'catalog_by_cat' c.slug %}" class="category-card-compact" title="{{ c.name }}">
          <div class="card-bg-dark">
            <div class="card-glow-dark"></div>
            <div class="card-ripple-dark"></div>
          </div>
          <div class="card-content-compact">
            <div class="card-icon-compact">
              {% if c.icon %}
                <img src="{{ c.icon.url }}" width="24" height="24" alt="{{ c.name }}">
              {% else %}
                <img src="{% static 'img/icons/default.svg' %}" width="24" height="24" alt="{{ c.name }}">
              {% endif %}
            </div>
            <div class="card-text-compact">
              <span class="card-title-compact">{{ c.name }}</span>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
</section>
{% endcache %}
<section class="mb-4 mb-md-5 reveal" id="new-products-section">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <h2 class="h5 mb-0">Новинки</h2>
  </div>
  
  <div class="row g-3 g-md-4 row-cols-2 row-cols-md-3 row-cols-lg-4" data-stagger-grid id="products-container">
    {% for p in products %}
    <div class="product-card-wrap stagger-item reveal-stagger">
      {% include "partials/product_card.html" with p=p stagger=True %}
      {% if p.colors_preview %}
      <div class="product-card-dots">
        <span class="text-secondary small me-1">Кольори:</span>
        <div class="d-flex align-items-center gap-1">
          {% for v in p.colors_preview %}
            <span class="color-dot" title="{{ v.primary_hex }}{% if v.secondary_hex %}+{{ v.secondary_hex }}{% endif %}" style="--c1: {{ v.primary_hex }}; --c2: {{ v.secondary_hex|default:'' }};"></span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% empty %}
    <div class="text-secondary small">Немає товарів.</div>
    {% endfor %}
  </div>
  
  {% if has_more_products %}
  <div class="text-center mt-4" id="load-more-container">
    <button class="btn btn-outline-primary" id="load-more-btn" data-page="2">
      <span class="btn-text">Показати ще</span>
      <span class="btn-spinner d-none">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Завантаження...
      </span>
    </button>
  </div>
  {% endif %}
  
  <!-- Селектор страниц -->
  <div class="text-center mt-3" id="page-selector-container">
    <div class="d-flex justify-content-center align-items-center gap-3">
      <span class="text-muted small">Сторінка:</span>
      <select class="form-select form-select-sm" id="page-selector" style="width: auto;">
        <option value="1" selected>1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
      <span class="text-muted small">з <span id="total-pages">5</span></span>
    </div>
  </div>
</section>

<script>
  // ===== ФУНКЦИОНАЛЬНОСТЬ ЗАГРУЗКИ ДОПОЛНИТЕЛЬНЫХ ТОВАРОВ =====
  document.addEventListener('DOMContentLoaded', function() {
    const loadMoreBtn = document.getElementById('load-more-btn');
    const productsContainer = document.getElementById('products-container');
    const loadMoreContainer = document.getElementById('load-more-container');
    const pageSelector = document.getElementById('page-selector');
    const totalPagesSpan = document.getElementById('total-pages');
    
    if (!loadMoreBtn || !productsContainer || !pageSelector) return;
    
    // Функция для загрузки страницы
    function loadPage(pageNumber) {
      const btnText = loadMoreBtn.querySelector('.btn-text');
      const btnSpinner = loadMoreBtn.querySelector('.btn-spinner');
      
      // Показываем спиннер
      btnText.classList.add('d-none');
      btnSpinner.classList.remove('d-none');
      loadMoreBtn.disabled = true;
      
      // Отправляем AJAX запрос
      fetch(`/load-more-products/?page=${pageNumber}`)
        .then(response => response.json())
        .then(data => {
          if (data.html && data.html.trim() !== '') {
            // Добавляем новые товары в контейнер
            productsContainer.insertAdjacentHTML('beforeend', data.html);
            
            // Обновляем селектор страниц
            updatePageSelector(pageNumber, data.has_more);
            
            // Запускаем анимацию появления для новых карточек
            animateNewCards();
            // После добавления контента — пересчёт высот
            setTimeout(()=>{ try{ equalizeCardHeights(); }catch(_){}} , 200);
            
            // Если больше нет товаров, скрываем кнопку
            if (!data.has_more) {
              loadMoreContainer.style.display = 'none';
            }
          }
        })
        .catch(error => {
          console.error('Помилка завантаження товарів:', error);
        })
        .finally(() => {
          // Скрываем спиннер
          btnText.classList.remove('d-none');
          btnSpinner.classList.add('d-none');
          loadMoreBtn.disabled = false;
        });
    }
    
    // Функция для обновления селектора страниц
    function updatePageSelector(currentPage, hasMore) {
      const totalProducts = parseInt('{{ total_products|default:40 }}', 10) || 40;
      const totalPages = Math.ceil(totalProducts / 8);
      totalPagesSpan.textContent = totalPages;
      
      // Обновляем опции селектора
      pageSelector.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        if (i === currentPage) {
          option.selected = true;
        }
        pageSelector.appendChild(option);
      }
      
      // Обновляем data-page для кнопки
      loadMoreBtn.setAttribute('data-page', currentPage + 1);
    }
    
    // Функция для анимации новых карточек
    function animateNewCards() {
      const allCards = productsContainer.querySelectorAll('.product-card-wrap');
      const newCards = Array.from(allCards).slice(-8);
      
      newCards.forEach((card, index) => {
        // Убираем классы анимации
        card.classList.remove('reveal-stagger', 'stagger-item', 'reveal-fast', 'reveal');
        
        // Убираем классы анимации у дочерних элементов
        const childCards = card.querySelectorAll('.card');
        childCards.forEach(childCard => {
          childCard.classList.remove('reveal-stagger', 'stagger-item', 'reveal-fast', 'reveal');
        });
        
        // Устанавливаем начальное состояние для анимации
        card.style.opacity = '0';
        card.style.transform = 'translateY(24px) scale(0.94)';
        card.style.filter = 'blur(10px)';
        card.style.transition = 'none';
        
        // Запускаем анимацию с задержкой
        setTimeout(() => {
          card.style.transition = 'all 560ms cubic-bezier(0.2, 0.8, 0.2, 1)';
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0) scale(1)';
            card.style.filter = 'blur(0)';
          }, 50);
        }, index * 120);
      });
    }
    
    // Обработчик кнопки "Показать еще"
    loadMoreBtn.addEventListener('click', function() {
      const currentPage = parseInt(this.getAttribute('data-page'));
      loadPage(currentPage);
    });
    
    // Обработчик селектора страниц
    pageSelector.addEventListener('change', function() {
      const selectedPage = parseInt(this.value);
      loadPage(selectedPage);
    });
    
    // Инициализация селектора
    updatePageSelector(1, true);
  });
  
  // Collapsible Featured: перенесено в main.js (удалён дублирующий inline-скрипт)
</script>
{% endblock %}