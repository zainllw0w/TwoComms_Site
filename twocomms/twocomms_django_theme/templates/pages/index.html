{% extends "base.html" %}{% load static %}{% block title %}TwoComms — Головна{% endblock %}{% block content %}
<section class="hero-section mb-4 mb-md-5 reveal">
  <div class="hero-container">
    <!-- Фоновый логотип -->
    <div class="hero-logo-bg">
      <img src="{% static 'img/logo.svg' %}" alt="TWO COMMS" class="hero-logo-image">
    </div>
    
    <!-- Основной контент -->
    <div class="hero-content">
      <div class="hero-text-section">
        <h1 class="hero-title">
          <span class="hero-title-main">Стріт & мілітарі</span>
          <span class="hero-title-accent">одяг</span>
        </h1>
        <p class="hero-subtitle">Футболки, худі, лонгсліви. Дизайн з характером.</p>
        <div class="hero-actions">
          <a class="hero-btn-primary" href="{% url 'catalog' %}">
            <span>Перейти в каталог</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </a>
          <div class="hero-badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <span>Ексклюзивний дизайн</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Декоративные элементы -->
    <div class="hero-decoration">
      <div class="hero-glow"></div>
      <div class="hero-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
      </div>
    </div>
  </div>
</section>
{% if featured %}
<section class="mb-4 mb-md-5 reveal" id="featured-section">
  <!-- Заголовок-кнопка управления блоком -->
  <div class="featured-header-btn" id="featured-toggle">
    <div class="featured-header-content">
      <div class="featured-badge">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        Рекомендовано
      </div>
      <div class="featured-subtitle">Найкращий вибір тижня</div>
      <div class="featured-toggle-hint">
        <span class="toggle-hint-text">Сховати</span>
        <svg class="toggle-hint-icon" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
          <path d="M7 10l5 5 5-5z"/>
        </svg>
      </div>
    </div>
  </div>
  
  <!-- Скрываемый контент -->
  <div class="featured-section" id="featured-content">
    
    <div class="featured-card">
      <div class="featured-image-container">
        <div class="featured-image-wrapper">
                      <img
              src="{% if featured.display_image %}{{ featured.display_image.url }}{% else %}{% static 'img/placeholder.jpg' %}{% endif %}"
              class="featured-image"
              alt="{{ featured.title }}"
            >
          <div class="featured-overlay">
            <div class="featured-overlay-content">
              <div class="featured-category">{{ featured.category.name }}</div>
              {% if featured_variants %}
                <div class="featured-colors">
                  <span class="featured-colors-label">Доступні кольори:</span>
                  <div class="featured-color-dots">
                    {% for v in featured_variants %}
                      <span class="featured-color-dot" title="{{ v.primary_hex }}{% if v.secondary_hex %}+{{ v.secondary_hex }}{% endif %}" style="--c1: {{ v.primary_hex }}; --c2: {{ v.secondary_hex|default:'' }};"></span>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      
      <div class="featured-content">
        <div class="featured-title-section">
          <h3 class="featured-title">{{ featured.title }}</h3>
          <div class="featured-description">{{ featured.description|default:'Ексклюзивний дизайн з найкращих матеріалів'|truncatechars:150 }}</div>
        </div>
        
        <div class="featured-price-section">
          <div class="featured-price-info">
            {% if featured.has_discount and featured.discount_percent %}
              <div class="featured-discount-badge">-{{ featured.discount_percent }}%</div>
            {% endif %}
            <div class="featured-price">
              <span class="featured-price-current">{{ featured.final_price }} грн</span>
              {% if featured.has_discount %}
                <span class="featured-price-old">{{ featured.price }} грн</span>
              {% endif %}
            </div>
          </div>
          
          <div class="featured-actions">
            <a href="{% url 'product' featured.slug %}" class="featured-btn-primary">
              <span>Переглянути</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
              </svg>
            </a>
            <div class="featured-exclusive-badge">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.57L19 8l-9 9z"/>
              </svg>
              Ексклюзив
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}
<section class="mb-4 mb-md-5 reveal categories-section">
  <!-- Единый блок категорий без разделения -->
  <div class="categories-unified-block">
    <!-- Фоновые эффекты для всего блока -->
    <div class="categories-bg-unified">
      <div class="dark-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
      </div>
      <div class="dark-glow"></div>
      <div class="dark-gradient-1"></div>
      <div class="dark-gradient-2"></div>
      <div class="floating-logos">
        <div class="floating-logo logo-1">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="16" height="16">
        </div>
        <div class="floating-logo logo-2">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="14" height="14">
        </div>
        <div class="floating-logo logo-3">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="18" height="18">
        </div>
        <div class="floating-logo logo-4">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="12" height="12">
        </div>
        <div class="floating-logo logo-5">
          <img src="{% static 'img/logo.svg' %}" alt="Logo" width="15" height="15">
        </div>
      </div>
    </div>
    
    <!-- Заголовок с кнопкой сворачивания -->
    <div class="categories-header-unified">
      <div class="d-flex justify-content-between align-items-center">
        <div class="categories-title-compact">
          <div class="title-with-catalog-icon">
            <h2 class="categories-title-text">Категорії</h2>
            <a href="{% url 'catalog' %}" class="catalog-icon-mobile" aria-label="Перейти в каталог">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
              </svg>
            </a>
          </div>
          <div class="title-accent-line"></div>
        </div>
        
        <!-- Кнопка сворачивания в центре -->
        <button class="categories-toggle-btn" id="categoriesToggle" aria-label="Свернуть/развернуть категории">
          <div class="toggle-btn-content">
            <div class="toggle-icon">
              <svg class="toggle-arrow" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
              </svg>
            </div>
            <span class="toggle-text">Свернуть</span>
          </div>
          <div class="toggle-btn-glow"></div>
          <div class="toggle-btn-ripple"></div>
        </button>
        
        <a href="{% url 'catalog' %}" class="catalog-link-compact">
          <span class="catalog-text">Весь каталог</span>
          <svg class="catalog-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
          </svg>
        </a>
      </div>
    </div>

    <!-- Контейнер категорий (без отдельного фона) -->
    <div class="categories-content-unified" id="categoriesContainer">
      <div class="categories-grid-compact">
        <!-- Категории товаров -->
        {% for c in categories %}
        <a href="{% url 'catalog_by_cat' c.slug %}" class="category-card-compact" title="{{ c.name }}">
          <div class="card-bg-dark">
            <div class="card-glow-dark"></div>
            <div class="card-ripple-dark"></div>
          </div>
          <div class="card-content-compact">
            <div class="card-icon-compact">
              {% if c.icon %}
                <img src="{{ c.icon.url }}" width="24" height="24" alt="{{ c.name }}">
              {% else %}
                <img src="{% static 'img/icons/default.svg' %}" width="24" height="24" alt="{{ c.name }}">
              {% endif %}
            </div>
            <div class="card-text-compact">
              <span class="card-title-compact">{{ c.name }}</span>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
</section>
<section class="mb-4 mb-md-5 reveal" id="new-products-section">
  <div class="d-flex justify-content-between align-items-end mb-3">
    <h2 class="h5 mb-0">Новинки</h2>
  </div>
  
  <div class="row g-3 g-md-4 row-cols-2 row-cols-md-3 row-cols-lg-4" id="products-container">
    {% for p in products %}
    <div class="product-card-wrap stagger-item reveal-stagger">
      {% include "partials/product_card.html" with p=p stagger=True %}
      {% if p.colors_preview %}
      <div class="product-card-dots">
        <span class="text-secondary small me-1">Кольори:</span>
        <div class="d-flex align-items-center gap-1">
          {% for v in p.colors_preview %}
            <span class="color-dot" title="{{ v.primary_hex }}{% if v.secondary_hex %}+{{ v.secondary_hex }}{% endif %}" style="--c1: {{ v.primary_hex }}; --c2: {{ v.secondary_hex|default:'' }};"></span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% empty %}
    <div class="text-secondary small">Немає товарів.</div>
    {% endfor %}
  </div>
  
  <!-- Отладочная информация -->
  <script>
    let initialPage = {{ current_page }};
    console.log('has_more_products:', {{ has_more_products|yesno:"true,false" }});
    console.log('initial_page:', initialPage);
  </script>
  
  <!-- ВРЕМЕННО: Принудительно показываем кнопку для тестирования -->
  <div class="text-center mt-4" id="load-more-container">
    <button class="btn btn-outline-primary" id="load-more-btn" data-page="2">
      <span class="btn-text">Показать еще (стр. 2)</span>
      <span class="btn-spinner d-none">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Загрузка...
      </span>
    </button>
  </div>
  
  <!-- Отладочная информация -->
  <div class="text-center mt-2">
    <small class="text-muted">
      has_more_products: {{ has_more_products|yesno:"true,false" }} | 
      current_page: {{ current_page }} |
      {% if has_more_products %}Кнопка должна быть видна{% else %}Кнопка скрыта{% endif %}
    </small>
  </div>
  
  <!-- ТЕСТОВАЯ КНОПКА -->
  <div class="text-center mt-2">
    <button class="btn btn-warning btn-sm" id="test-btn">
      ТЕСТ: Добавить карточку
    </button>
  </div>
</section>

<script>
// Функция для выравнивания карточек товаров по высоте
function equalizeCardHeights() {
  // Находим все ряды с карточками товаров
  const rows = document.querySelectorAll('.row[data-stagger-grid]');
  
  rows.forEach(row => {
    // Находим все карточки в этом ряду
    const cards = row.querySelectorAll('.card.product');
    
    if (cards.length > 0) {
      // Сбрасываем высоту всех карточек
      cards.forEach(card => {
        card.style.height = 'auto';
        card.style.minHeight = 'auto';
        card.style.maxHeight = 'none';
      });
      
      // Небольшая задержка для пересчета размеров
      setTimeout(() => {
        // Находим максимальную высоту среди карточек
        let maxHeight = 0;
        cards.forEach(card => {
          const cardHeight = card.offsetHeight;
          if (cardHeight > maxHeight) {
            maxHeight = cardHeight;
          }
        });
        
        // Устанавливаем высоту для всех карточек равной максимальной
        cards.forEach(card => {
          card.style.height = maxHeight + 'px';
          card.style.minHeight = maxHeight + 'px';
          card.style.maxHeight = maxHeight + 'px';
        });
      }, 50);
    }
  });
}

// Выполняем выравнивание при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  // Небольшая задержка для полной загрузки изображений
  setTimeout(equalizeCardHeights, 100);
  
  // Повторно выравниваем после загрузки всех изображений
  window.addEventListener('load', equalizeCardHeights);
  
  // Выравниваем при изменении размера окна
  window.addEventListener('resize', equalizeCardHeights);
});

// Выравниваем карточки каждые 2 секунды для динамического контента
setInterval(equalizeCardHeights, 2000);

  // ===== ФУНКЦИОНАЛЬНОСТЬ ЗАГРУЗКИ ДОПОЛНИТЕЛЬНЫХ ТОВАРОВ =====
  document.addEventListener('DOMContentLoaded', function() {
    console.log('=== НАЧАЛО ИНИЦИАЛИЗАЦИИ КНОПКИ ПОКАЗАТЬ ЕЩЕ ===');
    console.log('DOM загружен, ищем элементы...');
    
    const loadMoreBtn = document.getElementById('load-more-btn');
    const productsContainer = document.getElementById('products-container');
    const loadMoreContainer = document.getElementById('load-more-container');
    
    console.log('loadMoreBtn:', loadMoreBtn);
    console.log('productsContainer:', productsContainer);
    console.log('loadMoreContainer:', loadMoreContainer);
    
    if (!loadMoreBtn) {
      console.error('КНОПКА НЕ НАЙДЕНА!');
      return;
    }
    
    if (!productsContainer) {
      console.error('КОНТЕЙНЕР ТОВАРОВ НЕ НАЙДЕН!');
      return;
    }
    
    console.log('✅ Все элементы найдены, добавляем обработчик события');
    console.log('Кнопка видима:', loadMoreBtn.offsetParent !== null);
    console.log('Кнопка отображается:', loadMoreBtn.style.display !== 'none');
    
    // Добавляем тестовую кнопку
    const testBtn = document.getElementById('test-btn');
    if (testBtn) {
      testBtn.addEventListener('click', function() {
        console.log('ТЕСТОВАЯ КНОПКА НАЖАТА!');
        const testCard = document.createElement('div');
        testCard.className = 'product-card-wrap';
        testCard.innerHTML = '<div class="card product"><div class="card-body"><h5>ТЕСТОВАЯ КАРТОЧКА</h5><p>Это тестовая карточка для проверки</p></div></div>';
        productsContainer.appendChild(testCard);
        console.log('Тестовая карточка добавлена');
      });
    }
    
    loadMoreBtn.addEventListener('click', function() {
      console.log('Кнопка "Показать еще" нажата!');
      const button = this;
      let currentPage = parseInt(button.getAttribute('data-page'));
      const btnText = button.querySelector('.btn-text');
      const btnSpinner = button.querySelector('.btn-spinner');
      
      console.log('Текущая страница:', currentPage);
      
      // Показываем спиннер
      btnText.classList.add('d-none');
      btnSpinner.classList.remove('d-none');
      button.disabled = true;
      
      // Отправляем AJAX запрос
      console.log('Загружаем страницу:', currentPage);
      fetch(`/load-more-products/?page=${currentPage}`)
        .then(response => {
          console.log('Ответ сервера:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Данные от сервера:', data);
          if (data.html && data.html.trim() !== '') {
            console.log('HTML не пустой, добавляем товары');
            console.log('HTML длина:', data.html.length);
            console.log('HTML превью:', data.html.substring(0, 200));
            
            // Добавляем новые товары в контейнер
            productsContainer.insertAdjacentHTML('beforeend', data.html);
            
            console.log('HTML добавлен в контейнер');
            
            // Обновляем номер страницы
            button.setAttribute('data-page', currentPage + 1);
            console.log('Обновлен data-page на:', currentPage + 1);
            
            // Обновляем отладочную информацию на странице
            const debugInfo = document.querySelector('.text-muted');
            if (debugInfo) {
              debugInfo.textContent = `has_more_products: true | current_page: ${currentPage} | Кнопка должна быть видна`;
            }
            
            // Обновляем текст кнопки
            if (btnText) {
              btnText.textContent = `Показать еще (стр. ${currentPage})`;
            }
            
            // Обновляем переменную в консоли для отладки
            let newCurrentPage = currentPage + 1;
            console.log('current_page обновлен на:', newCurrentPage);
            
            // Если больше нет товаров, скрываем кнопку
            if (!data.has_more) {
              loadMoreContainer.style.display = 'none';
            }
            
            // Запускаем оригинальную анимацию как в начале
            const allCards = productsContainer.querySelectorAll('.product-card-wrap');
            const newCards = Array.from(allCards).slice(-8); // Берем последние 8 карточек (новые)
            
            console.log('Найдено новых карточек:', newCards.length);
            console.log('Всего карточек в контейнере:', allCards.length);
            
            // Просто показываем карточки без анимации
            console.log('Показываем новые карточки...');
            newCards.forEach((card, index) => {
              console.log(`Обрабатываем карточку ${index + 1}:`, card);
              
              // Убираем все классы анимации
              card.classList.remove('stagger-item', 'reveal-stagger');
              
              // Принудительно делаем карточку видимой
              card.style.opacity = '1';
              card.style.transform = 'none';
              card.style.filter = 'none';
              card.style.transition = 'none';
              
              console.log(`Карточка ${index + 1} принудительно показана`);
              
              // Показываем цвета
              const colorDots = card.querySelector('.product-card-dots');
              if(colorDots) {
                colorDots.style.opacity = '1';
                console.log(`Цвета карточки ${index + 1} показаны`);
              }
            });
          } else {
            console.log('HTML пустой или нет товаров');
            // Если HTML пустой, скрываем кнопку
            loadMoreContainer.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Ошибка загрузки товаров:', error);
          // Показываем сообщение об ошибке
          const errorDiv = document.createElement('div');
          errorDiv.className = 'alert alert-warning mt-3';
          errorDiv.textContent = 'Произошла ошибка при загрузке товаров. Попробуйте еще раз.';
          loadMoreContainer.appendChild(errorDiv);
        })
        .finally(() => {
          // Скрываем спиннер
          btnText.classList.remove('d-none');
          btnSpinner.classList.add('d-none');
          button.disabled = false;
        });
    });
  });
</script>
{% endblock %}