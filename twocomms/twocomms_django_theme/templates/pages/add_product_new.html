{% extends 'base.html' %}{% load static %}
{% block title %}Додати товар — TwoComms{% endblock %}
{% block content %}

<div class="container-fluid">
  <div class="row">
    <!-- Боковая панель с навигацией -->
    <div class="col-lg-3 col-xl-2 mb-4">
      <div class="card glass border-0">
        <div class="card-body p-3">
          <div class="d-flex align-items-center mb-4">
            <div class="position-relative me-3">
              <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-plus text-white"></i>
              </div>
              <div class="position-absolute top-0 end-0 bg-success rounded-circle" style="width: 12px; height: 12px; border: 2px solid var(--tc-bg);"></div>
            </div>
            <div>
              <h6 class="mb-0 fw-bold">Додавання товару</h6>
              <small class="text-muted">Новий товар</small>
            </div>
          </div>
          
          <div class="nav flex-column nav-pills" id="edit-tabs" role="tablist">
            <button class="nav-link active d-flex align-items-center mb-2" id="basic-tab" data-bs-toggle="pill" data-bs-target="#basic" type="button">
              <i class="fas fa-info-circle me-2"></i>
              <span>Основна інформація</span>
            </button>
            <button class="nav-link d-flex align-items-center mb-2" id="colors-tab" data-bs-toggle="pill" data-bs-target="#colors" type="button">
              <i class="fas fa-palette me-2"></i>
              <span>Кольори</span>
              <span class="badge bg-primary ms-auto" id="colors-count">0</span>
            </button>
            <button class="nav-link d-flex align-items-center mb-2" id="images-tab" data-bs-toggle="pill" data-bs-target="#images" type="button">
              <i class="fas fa-images me-2"></i>
              <span>Зображення</span>
              <span class="badge bg-primary ms-auto" id="images-count">0</span>
            </button>
            <button class="nav-link d-flex align-items-center mb-2" id="preview-tab" data-bs-toggle="pill" data-bs-target="#preview" type="button">
              <i class="fas fa-eye me-2"></i>
              <span>Попередній перегляд</span>
            </button>
          </div>
          
          <hr class="my-3">
          
          <div class="d-grid gap-2">
            <button type="submit" form="product-form" class="btn btn-cta btn-sm">
              <i class="fas fa-save me-1"></i>Створити товар
            </button>
            <a href="/admin-panel/?section=catalogs" class="btn btn-outline-light btn-sm">
              <i class="fas fa-arrow-left me-1"></i>Назад до каталогу
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Основной контент -->
    <div class="col-lg-9 col-xl-10">
      <div class="tab-content" id="edit-tabs-content">
        
        <!-- Основная информация -->
        <div class="tab-pane fade show active" id="basic" role="tabpanel">
          <div class="card glass border-0">
            <div class="card-header bg-transparent border-0 pb-0">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <div class="position-relative me-3">
                    <div class="bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                      <i class="fas fa-info-circle text-white fa-lg"></i>
                    </div>
                    <div class="position-absolute top-0 end-0 bg-success rounded-circle" style="width: 16px; height: 16px; border: 3px solid var(--tc-bg); box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                  </div>
                  <div>
                    <h5 class="mb-1 fw-bold">Основна інформація</h5>
                    <p class="text-muted mb-0 small">Введіть основні параметри товару</p>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-warning">
                    <i class="fas fa-plus me-1"></i>Новий
                  </span>
                </div>
              </div>
            </div>
            
            <div class="card-body p-4">
              <form method="post" enctype="multipart/form-data" id="product-form">
                {% csrf_token %}
                <input type="hidden" name="form_type" value="product">

                {% if form.non_field_errors %}
                  <div class="alert alert-danger border-0">
                    <div class="d-flex align-items-center">
                      <div class="alert-icon me-3">
                        <i class="fas fa-exclamation-triangle fa-lg"></i>
                      </div>
                      <div>
                        <strong>Помилка!</strong> {{ form.non_field_errors }}
                      </div>
                    </div>
                  </div>
                {% endif %}
                
                {% for field in form %}
                  {% for err in field.errors %}
                    <div class="alert alert-danger border-0 small">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-times-circle me-2"></i>
                        <strong>{{ field.label }}:</strong> {{ err }}
                      </div>
                    </div>
                  {% endfor %}
                {% endfor %}

                <!-- Основная информация - новая структура -->
                <div class="product-info-grid">
                  
                  <!-- Категория и название -->
                  <div class="info-row">
                  <div class="info-group category">
                    <label class="form-label">
                      <i class="fas fa-folder me-2"></i>Категорія
                    </label>
                    {{ form.category }}
                      <div class="form-hint">
                        <i class="fas fa-sitemap me-1"></i>Оберіть категорію товару
                      </div>
                    </div>
                    <div class="info-group main-title">
                      <label class="form-label">
                        <i class="fas fa-tag me-2"></i>Назва товару
                      </label>
                      {{ form.title }}
                    <div class="form-hint">
                      <i class="fas fa-lightbulb me-1"></i>Унікальна назва товару
                    </div>
                  </div>
                  <div class="info-group featured">
                      <label class="form-label">
                        <i class="fas fa-star me-2"></i>Рекомендований товар
                      </label>
                      <div class="featured-toggle">
                        <div class="form-check form-switch">
                          {{ form.featured }}
                          <label class="form-check-label" for="{{ form.featured.id_for_label }}">
                            <span class="toggle-label">Рекомендувати клієнтам</span>
                          </label>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="info-row">
                  <div class="info-group">
                    <label class="form-label">
                      <i class="fas fa-toggle-on me-2"></i>Статус публікації
                    </label>
                    {{ form.status }}
                    <div class="form-hint">
                      <i class="fas fa-info-circle me-1"></i>Оберіть, чи це чернетка, на модерації, чи вже опублікований товар.
                    </div>
                  </div>
                  <div class="info-group">
                    <label class="form-label">
                      <i class="fas fa-sort-amount-up-alt me-2"></i>Пріоритет показу
                    </label>
                    {{ form.priority }}
                    <div class="form-hint">
                      <i class="fas fa-lightbulb me-1"></i>Чим більше значення, тим вище товар у списках. За замовчуванням 0.
                    </div>
                  </div>
                </div>

                <!-- Цена, балы и скидка -->
                <div class="info-row pricing-section">
                  <div class="info-group price">
                    <label class="form-label">
                      <i class="fas fa-hryvnia me-2"></i>Ціна (грн)
                      </label>
                      {{ form.price }}
                      <div class="form-hint">
                        <i class="fas fa-money-bill me-1"></i>Основна ціна товару
                      </div>
                    </div>
                    <div class="info-group points">
                      <label class="form-label">
                        <i class="fas fa-star me-2"></i>Бали за покупку
                      </label>
                      {{ form.points_reward }}
                      <div class="form-hint">
                        <i class="fas fa-gift me-1"></i>Нагорода за покупку
                      </div>
                    </div>
                    <div class="info-group discount">
                      <label class="form-label">
                        <i class="fas fa-percentage me-2"></i>Знижка (%)
                      </label>
                      {{ form.discount_percent }}
                      <div class="form-hint">
                        <i class="fas fa-tags me-1"></i>Залиште порожнім для відсутності знижки
                      </div>
                    </div>
                  </div>

                  <!-- Опис -->
                  <div class="info-row description">
                    <div class="info-group">
                      <label class="form-label">
                        <i class="fas fa-align-left me-2"></i>Короткий опис
                      </label>
                      {{ form.short_description }}
                      <div class="form-hint d-flex align-items-center justify-content-between">
                        <span><i class="fas fa-lightbulb me-1"></i>До 300 символів. Використовується у списках товарів.</span>
                        <button type="button" class="btn btn-outline-light btn-sm" id="copy-full-to-short">
                          <i class="fas fa-level-down-alt me-1"></i>Заповнити з повного
                        </button>
                      </div>
                    </div>
                    <div class="info-group full-width">
                      <label class="form-label">
                        <i class="fas fa-align-justify me-2"></i>Повний опис
                      </label>
                      {{ form.full_description }}
                      <div class="form-hint">
                        <i class="fas fa-edit me-1"></i>Детальний опис товару, допускається HTML-розмітка.
                      </div>
                    </div>
                  </div>

                  <!-- Главное изображение -->
                  <div class="info-row image-upload">
                    <div class="info-group image-input">
                      <label class="form-label">
                        <i class="fas fa-image me-2"></i>Головне зображення
                      </label>
                      {{ form.main_image }}
                      <div class="form-hint">
                        <i class="fas fa-upload me-1"></i>Основне зображення товару (автоматично з першого кольору, якщо не вибрано)
                      </div>
                    </div>
                  </div>

                  <!-- URL slug -->
                  <div class="info-row">
                    <div class="info-group url-slug">
                      <label class="form-label">
                        <i class="fas fa-link me-2"></i>URL slug
                      </label>
                      {{ form.slug }}
                      <div class="form-hint">
                        <i class="fas fa-magic me-1"></i>Автоматично генерується з назви
                      </div>
                    </div>
                  </div>

                  <!-- Кнопка сохранения -->
                  <div class="text-center mt-4">
                    <button type="submit" class="btn btn-cta btn-lg">
                      <i class="fas fa-save me-1"></i>Створити товар
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Управление цветами -->
        <div class="tab-pane fade" id="colors" role="tabpanel">
          <div class="card glass border-0">
            <div class="card-header bg-transparent border-0 pb-0">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <div class="position-relative me-3">
                    <div class="bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: linear-gradient(135deg, #e91e63, #ff5722);">
                      <i class="fas fa-palette text-white fa-lg"></i>
                    </div>
                    <div class="position-absolute top-0 end-0 bg-success rounded-circle" style="width: 16px; height: 16px; border: 3px solid var(--tc-bg); box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                  </div>
                  <div>
                    <h5 class="mb-1 fw-bold">Кольори товару</h5>
                    <p class="text-muted mb-0 small">Додавайте та керуйте кольоровими варіантами</p>
                  </div>
                </div>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addColorModal">
                  <i class="fas fa-plus me-1"></i>Додати колір
                </button>
              </div>
            </div>
            
            <div class="card-body">
              <div id="colors-container">
                <div class="text-center py-5">
                  <div class="mb-4">
                    <div class="position-relative d-inline-block">
                      <div class="bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(233, 30, 99, 0.2), rgba(255, 87, 34, 0.2));">
                        <i class="fas fa-palette fa-2x text-muted"></i>
                      </div>
                      <div class="position-absolute top-0 end-0 bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; border: 3px solid var(--tc-bg);">
                        <i class="fas fa-exclamation-triangle fa-xs text-dark"></i>
                      </div>
                    </div>
                  </div>
                  <h6 class="text-muted mb-2 fw-semibold">Поки що немає доданих кольорів</h6>
                  <p class="text-muted small mb-4">Додайте кольорові варіанти для вашого товару</p>
                  <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addColorModal">
                    <i class="fas fa-plus me-1"></i>Додати перший колір
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Дополнительные изображения -->
        <div class="tab-pane fade" id="images" role="tabpanel">
          <div class="card glass border-0">
            <div class="card-header bg-transparent border-0 pb-0">
              <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <div class="position-relative me-3">
                    <div class="bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: linear-gradient(135deg, #4caf50, #8bc34a);">
                      <i class="fas fa-images text-white fa-lg"></i>
                    </div>
                    <div class="position-absolute top-0 end-0 bg-success rounded-circle" style="width: 16px; height: 16px; border: 3px solid var(--tc-bg); box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                  </div>
                  <div>
                    <h5 class="mb-1 fw-bold">Додаткові зображення</h5>
                    <p class="text-muted mb-0 small">Керуйте галереєю зображень товару</p>
                  </div>
                </div>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addImageModal">
                  <i class="fas fa-plus me-1"></i>Додати зображення
                </button>
              </div>
            </div>
            
            <div class="card-body">
              <div id="images-container">
                <div class="text-center py-5">
                  <div class="mb-4">
                    <div class="position-relative d-inline-block">
                      <div class="bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(139, 195, 74, 0.2));">
                        <i class="fas fa-images fa-2x text-muted"></i>
                      </div>
                      <div class="position-absolute top-0 end-0 bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; border: 3px solid var(--tc-bg);">
                        <i class="fas fa-exclamation-triangle fa-xs text-dark"></i>
                      </div>
                    </div>
                  </div>
                  <h6 class="text-muted mb-2 fw-semibold">Поки що немає додаткових зображень</h6>
                  <p class="text-muted small mb-4">Додайте зображення для створення галереї</p>
                  <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addImageModal">
                    <i class="fas fa-plus me-1"></i>Додати перше зображення
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Предварительный просмотр -->
        <div class="tab-pane fade" id="preview" role="tabpanel">
          <div class="card glass border-0">
            <div class="card-header bg-transparent border-0 pb-0">
              <div class="d-flex align-items-center">
                <div class="position-relative me-3">
                  <div class="bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: linear-gradient(135deg, #ff9800, #ff5722);">
                    <i class="fas fa-eye text-white fa-lg"></i>
                  </div>
                  <div class="position-absolute top-0 end-0 bg-success rounded-circle" style="width: 16px; height: 16px; border: 3px solid var(--tc-bg); box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                </div>
                <div>
                  <h5 class="mb-1 fw-bold">Попередній перегляд</h5>
                  <p class="text-muted mb-0 small">Як буде виглядати товар на сайті</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="text-center py-5">
                <div class="mb-4">
                  <div class="position-relative d-inline-block">
                    <div class="bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(255, 87, 34, 0.2));">
                      <i class="fas fa-eye fa-2x text-muted"></i>
                    </div>
                    <div class="position-absolute top-0 end-0 bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; border: 3px solid var(--tc-bg);">
                      <i class="fas fa-exclamation-triangle fa-xs text-dark"></i>
                    </div>
                  </div>
                </div>
                <h6 class="text-muted mb-2 fw-semibold">Спочатку створіть товар</h6>
                <p class="text-muted small mb-4">Після створення товару ви зможете побачити попередній перегляд</p>
                <button class="btn btn-outline-primary" onclick="document.getElementById('basic-tab').click()">
                  <i class="fas fa-arrow-left me-1"></i>Повернутися до створення
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно добавления цвета -->
<div class="modal fade" id="addColorModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark border-0">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-palette me-2"></i>Додати новий колір
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" enctype="multipart/form-data" id="color-form">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="color">
        <div class="modal-body">
          
          <!-- Выбор типа цвета -->
          <div class="color-type-selector mb-4">
            <label class="form-label fw-semibold mb-3">
              <i class="fas fa-paint-brush me-2"></i>Тип кольору
            </label>
            <div class="color-type-options">
              <div class="color-type-option active" data-type="single">
                <div class="color-type-icon">
                  <i class="fas fa-circle"></i>
                </div>
                <span>Один колір</span>
              </div>
              <div class="color-type-option" data-type="combined">
                <div class="color-type-icon">
                  <i class="fas fa-layer-group"></i>
                </div>
                <span>Комбінований</span>
              </div>
            </div>
          </div>

          <!-- Название цвета -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              <i class="fas fa-tag me-2"></i>Назва кольору
            </label>
            <input type="text" name="color_name" class="form-control" placeholder="Наприклад: Червоний, Синій, Чорний+Жовтий" required>
            <div class="form-hint">
              <i class="fas fa-lightbulb me-1"></i>Опишіть колір для зручності
            </div>
          </div>

          <!-- Выбор цвета -->
          <div class="color-selection-section mb-4">
            <label class="form-label fw-semibold mb-3">
              <i class="fas fa-palette me-2"></i>Вибір кольору
            </label>
            
            <!-- Переключатель: существующие/новые цвета -->
            <div class="color-mode-selector mb-3">
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="color_mode" id="existing_colors" value="existing" checked>
                <label class="btn btn-outline-primary" for="existing_colors">
                  <i class="fas fa-database me-2"></i>Існуючі кольори
                </label>
                
                <input type="radio" class="btn-check" name="color_mode" id="new_colors" value="new">
                <label class="btn btn-outline-primary" for="new_colors">
                  <i class="fas fa-plus me-2"></i>Нові кольори
                </label>
              </div>
            </div>

            <!-- Существующие цвета -->
            <div class="existing-colors-section" id="existingColorsSection">
              <label class="form-label small">Виберіть існуючий колір</label>
              <select class="form-control" id="existingColorSelect">
                <option value="">Оберіть колір...</option>
              </select>
            </div>

            <!-- Новые цвета с color picker -->
            <div class="new-colors-section" id="newColorsSection" style="display: none;">
              
              <!-- Основной цвет -->
              <div class="primary-color-section mb-3">
                <label class="form-label small">Основний колір</label>
                <div class="color-picker-container">
                  <input type="color" id="primaryColorPicker" class="color-picker" value="#000000">
                  <input type="text" id="primaryHexInput" class="form-control hex-input" placeholder="#000000" value="#000000">
                </div>
                <input type="hidden" name="primary_hex" id="primaryHex" value="#000000">
              </div>

              <!-- Дополнительный цвет (для комбинированных) -->
              <div class="secondary-color-section mb-3" style="display: none;">
                <label class="form-label small">Додатковий колір</label>
                <div class="color-picker-container">
                  <input type="color" id="secondaryColorPicker" class="color-picker" value="#FFFF00">
                  <input type="text" id="secondaryHexInput" class="form-control hex-input" placeholder="#FFFF00" value="#FFFF00">
                </div>
                <input type="hidden" name="secondary_hex" id="secondaryHex" value="">
              </div>
            </div>

            <!-- Предварительный просмотр -->
            <div class="color-preview mb-3">
              <label class="form-label small">Попередній перегляд</label>
              <div class="preview-container">
                <div class="color-preview-item" id="colorPreview">
                  <div class="preview-circle combined-preview" id="combinedPreview"></div>
                </div>
                <div class="preview-text" id="previewText">Чорний</div>
              </div>
            </div>
          </div>

          <!-- Загрузка изображений -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              <i class="fas fa-images me-2"></i>Зображення кольору
            </label>
            <div class="image-upload-area">
              <div class="upload-instructions mb-3">
                <div class="form-hint">
                  <i class="fas fa-info-circle me-1"></i>Можна завантажити кілька зображень для каруселі
                </div>
              </div>
              
              <!-- Поле для загрузки изображений -->
              <div class="file-upload-container mb-3">
                <input type="file" name="color_images" class="form-control" accept="image/*" multiple required>
                <div class="form-hint">
                  <i class="fas fa-upload me-1"></i>Оберіть одне або кілька зображень
                </div>
              </div>
              
              <!-- Предварительный просмотр загруженных изображений -->
              <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
                <label class="form-label small">Попередній перегляд зображень:</label>
                <div class="image-preview-grid" id="imagePreviewGrid">
                  <!-- Здесь будут отображаться превью изображений -->
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Скасувати</button>
          <button type="submit" class="btn btn-cta">
            <i class="fas fa-plus me-1"></i>Додати колір
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Модальное окно добавления изображения -->
<div class="modal fade" id="addImageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark border-0">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold">
          <i class="fas fa-image me-2"></i>Додати зображення
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" enctype="multipart/form-data" id="image-form">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="image">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Додаткове зображення</label>
            <input type="file" name="additional_image" class="form-control" accept="image/*" required>
            <div class="form-text">Додайте зображення для галереї товару</div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Скасувати</button>
          <button type="submit" class="btn btn-cta">
            <i class="fas fa-plus me-1"></i>Додати зображення
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentProductId = null;
    let colorsCount = 0;
    let imagesCount = 0;

    const shortDescriptionField = document.getElementById('{{ form.short_description.id_for_label }}');
    const fullDescriptionField = document.getElementById('{{ form.full_description.id_for_label }}');
    const copyDescriptionBtn = document.getElementById('copy-full-to-short');

    if (copyDescriptionBtn && shortDescriptionField && fullDescriptionField) {
        copyDescriptionBtn.addEventListener('click', () => {
            shortDescriptionField.value = fullDescriptionField.value;
            shortDescriptionField.dispatchEvent(new Event('input', { bubbles: true }));
            showNotification('Короткий опис оновлено з повного опису.', 'success');
        });
    }

    // Функция создания товара
    function createProduct() {
        if (currentProductId) {
            return Promise.resolve({ success: true, product_id: currentProductId });
        }
        
        const productForm = document.getElementById('product-form');
        const formData = new FormData(productForm);
        
        // Отладочная информация
        
        return fetch(productForm.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                return { success: true, message: 'Товар успішно створено!' };
            }
        })
        .then(data => {
            if (data.success && data.product_id) {
                currentProductId = data.product_id;
                
                // Обновляем интерфейс
                document.querySelector('.badge.bg-warning').innerHTML = '<i class="fas fa-hashtag me-1"></i>' + data.product_id;
                document.querySelector('.badge.bg-warning').className = 'badge bg-success';
                
                showNotification('Товар успішно створено!', 'success');
            } else {
                console.error('Product creation failed:', data);
                
                // Выводим детальные ошибки валидации
                let errorMessage = 'Помилка створення товару:\n';
                if (data.errors) {
                    for (const [field, errors] of Object.entries(data.errors)) {
                        if (Array.isArray(errors)) {
                            errorMessage += `\n${field}: ${errors.join(', ')}`;
                        } else {
                            errorMessage += `\n${field}: ${errors}`;
                        }
                    }
                } else if (data.message) {
                    errorMessage = data.message;
                } else {
                    errorMessage = 'Невідома помилка';
                }
                
                showNotification(errorMessage, 'error');
            }
            return data;
        });
    }

    // Обработка формы товара
    const productForm = document.getElementById('product-form');
    
    productForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = productForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Створюємо...';
        submitBtn.disabled = true;
        
        createProduct()
        .then(data => {
            if (data.success) {
                submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>Створено!';
                submitBtn.classList.remove('btn-cta');
                submitBtn.classList.add('btn-success');
                
                // Активируем вкладку с цветами
                document.getElementById('colors-tab').click();
            } else {
                submitBtn.innerHTML = '<i class="fas fa-times me-1"></i>Помилка!';
                submitBtn.classList.remove('btn-cta');
                submitBtn.classList.add('btn-danger');
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-danger');
                    submitBtn.classList.add('btn-cta');
                    submitBtn.disabled = false;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitBtn.innerHTML = '<i class="fas fa-times me-1"></i>Помилка!';
            submitBtn.classList.remove('btn-cta');
            submitBtn.classList.add('btn-danger');
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.classList.remove('btn-danger');
                submitBtn.classList.add('btn-cta');
                submitBtn.disabled = false;
            }, 2000);
        });
    });

    // Функциональность выбора цветов
    const colorTypeOptions = document.querySelectorAll('.color-type-option');
    const secondaryColorSection = document.querySelector('.secondary-color-section');
    const primaryHex = document.getElementById('primaryHex');
    const secondaryHex = document.getElementById('secondaryHex');
    const combinedPreview = document.getElementById('combinedPreview');
    const previewText = document.getElementById('previewText');
    
    // Элементы для режимов цвета
    const existingColorsSection = document.getElementById('existingColorsSection');
    const newColorsSection = document.getElementById('newColorsSection');
    const existingColorSelect = document.getElementById('existingColorSelect');
    const primaryColorPicker = document.getElementById('primaryColorPicker');
    const secondaryColorPicker = document.getElementById('secondaryColorPicker');
    const primaryHexInput = document.getElementById('primaryHexInput');
    const secondaryHexInput = document.getElementById('secondaryHexInput');

    // Словарь названий цветов
    const colorNames = {
        '#000000': 'Чорний',
        '#FFFFFF': 'Білий',
        '#FF0000': 'Червоний',
        '#00FF00': 'Зелений',
        '#0000FF': 'Синій',
        '#FFFF00': 'Жовтий',
        '#FF00FF': 'Пурпурний',
        '#00FFFF': 'Блакитний',
        '#FFA500': 'Помаранчевий',
        '#800080': 'Фіолетовий',
        '#FFC0CB': 'Рожевий',
        '#A52A2A': 'Коричневий',
        '#808080': 'Сірий',
        '#FFD700': 'Золотий',
        '#C0C0C0': 'Срібний'
    };

    // Загрузка существующих цветов
    function loadExistingColors() {
        fetch('/api/colors/')
            .then(response => response.json())
            .then(colors => {
                existingColorSelect.innerHTML = '<option value="">Оберіть колір...</option>';
                colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color.id;
                    option.textContent = color.name;
                    option.dataset.primary = color.primary_hex;
                    option.dataset.secondary = color.secondary_hex || '';
                    existingColorSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Ошибка загрузки цветов:', error);
                // Если API недоступен, добавляем заглушки
                const fallbackColors = [
                    { id: 1, name: 'Чорний', primary_hex: '#000000', secondary_hex: '' },
                    { id: 2, name: 'Білий', primary_hex: '#FFFFFF', secondary_hex: '' },
                    { id: 3, name: 'Червоний', primary_hex: '#FF0000', secondary_hex: '' },
                    { id: 4, name: 'Чорний+Жовтий', primary_hex: '#000000', secondary_hex: '#FFFF00' }
                ];
                existingColorSelect.innerHTML = '<option value="">Оберіть колір...</option>';
                fallbackColors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color.id;
                    option.textContent = color.name;
                    option.dataset.primary = color.primary_hex;
                    option.dataset.secondary = color.secondary_hex || '';
                    existingColorSelect.appendChild(option);
                });
            });
    }

    // Переключение режимов цвета
    document.querySelectorAll('input[name="color_mode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'existing') {
                existingColorsSection.style.display = 'block';
                newColorsSection.style.display = 'none';
            } else {
                existingColorsSection.style.display = 'none';
                newColorsSection.style.display = 'block';
            }
        });
    });

    // Выбор существующего цвета
    existingColorSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            primaryHex.value = selectedOption.dataset.primary;
            secondaryHex.value = selectedOption.dataset.secondary || '';
            updatePreview();
        }
    });

    // Color picker для основного цвета
    primaryColorPicker.addEventListener('input', function() {
        const color = this.value;
        primaryHex.value = color;
        primaryHexInput.value = color;
        updatePreview();
    });

    // Color picker для дополнительного цвета
    secondaryColorPicker.addEventListener('input', function() {
        const color = this.value;
        secondaryHex.value = color;
        secondaryHexInput.value = color;
        updatePreview();
    });

    // Ввод HEX кода для основного цвета
    primaryHexInput.addEventListener('input', function() {
        const color = this.value;
        if (/^#[0-9A-F]{6}$/i.test(color)) {
            primaryHex.value = color;
            primaryColorPicker.value = color;
            updatePreview();
        }
    });

    // Ввод HEX кода для дополнительного цвета
    secondaryHexInput.addEventListener('input', function() {
        const color = this.value;
        if (/^#[0-9A-F]{6}$/i.test(color)) {
            secondaryHex.value = color;
            secondaryColorPicker.value = color;
            updatePreview();
        }
    });

    // Переключение типа цвета
    colorTypeOptions.forEach(option => {
        option.addEventListener('click', function() {
            colorTypeOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            
            const type = this.dataset.type;
            if (type === 'combined') {
                secondaryColorSection.style.display = 'block';
                updatePreview();
            } else {
                secondaryColorSection.style.display = 'none';
                secondaryHex.value = '';
                secondaryHexInput.value = '';
                updatePreview();
            }
        });
    });

    // Обновление предварительного просмотра
    function updatePreview() {
        const primaryColor = primaryHex.value;
        const secondaryColor = secondaryHex.value;
        const isCombined = document.querySelector('.color-type-option.active').dataset.type === 'combined';
        
        // Обновляем CSS переменные для комбинированного превью
        combinedPreview.style.setProperty('--primary-color', primaryColor);
        combinedPreview.style.setProperty('--secondary-color', secondaryColor);
        
        if (isCombined && secondaryColor) {
            const primaryName = colorNames[primaryColor] || primaryColor;
            const secondaryName = colorNames[secondaryColor] || secondaryColor;
            previewText.textContent = `${primaryName}+${secondaryName}`;
        } else {
            const primaryName = colorNames[primaryColor] || primaryColor;
            previewText.textContent = primaryName;
        }
    }

    // Обработка множественной загрузки изображений
    const colorImageInput = document.querySelector('input[name="color_images"]');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreviewGrid = document.getElementById('imagePreviewGrid');
    let selectedImages = [];

    colorImageInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        selectedImages = files;
        
        
        if (files.length > 0) {
            imagePreviewContainer.style.display = 'block';
            imagePreviewGrid.innerHTML = '';
            
            files.forEach((file, index) => {
                
                // Проверяем, что это изображение
                if (!file.type.startsWith('image/')) {
                    console.warn(`File ${file.name} is not an image`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-image" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="image-number">${index + 1}</div>
                    `;
                    imagePreviewGrid.appendChild(previewItem);
                    
                    // Обработчик удаления изображения
                    previewItem.querySelector('.remove-image').addEventListener('click', function() {
                        const indexToRemove = parseInt(this.dataset.index);
                        selectedImages.splice(indexToRemove, 1);
                        previewItem.remove();
                        
                        // Обновляем номера изображений
                        document.querySelectorAll('.image-number').forEach((num, i) => {
                            num.textContent = i + 1;
                        });
                        
                        // Если нет изображений, скрываем контейнер
                        if (selectedImages.length === 0) {
                            imagePreviewContainer.style.display = 'none';
                        }
                    });
                };
                
                reader.onerror = function(e) {
                    console.error(`Error reading file ${index + 1}:`, e);
                };
                
                reader.readAsDataURL(file);
            });
        } else {
            imagePreviewContainer.style.display = 'none';
        }
    });

    // Автогенерация slug из названия
    const titleInput = document.querySelector('input[name="title"]');
    const slugInput = document.querySelector('input[name="slug"]');
    
    if (titleInput && slugInput) {
        titleInput.addEventListener('input', function() {
            const title = this.value;
            const slug = title
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '') // Удаляем спецсимволы
                .replace(/\s+/g, '-') // Заменяем пробелы на дефисы
                .replace(/-+/g, '-') // Убираем множественные дефисы
                .trim();
            slugInput.value = slug;
        });
    }

    // Инициализация
    loadExistingColors();

    // Обработка формы цветов
    const colorForm = document.getElementById('color-form');
    
    colorForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = colorForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Додаємо...';
        submitBtn.disabled = true;
        
        // Сначала создаем товар, если он еще не создан
        createProduct()
        .then(data => {
            if (!data.success) {
                throw new Error('Не удалось создать товар');
            }
            
            const formData = new FormData(colorForm);
            formData.append('product_id', currentProductId);
            
            // Отладочная информация для формы цвета
            
            return fetch(colorForm.action || window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>Додано!';
                submitBtn.classList.remove('btn-cta');
                submitBtn.classList.add('btn-success');
                
                colorsCount++;
                document.getElementById('colors-count').textContent = colorsCount;
                
                // Добавляем цвет в контейнер
                addColorToContainer(data.color);
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-cta');
                    submitBtn.disabled = false;
                    bootstrap.Modal.getInstance(document.getElementById('addColorModal')).hide();
                    colorForm.reset();
                    imagePreviewContainer.style.display = 'none';
                }, 1500);
            } else {
                console.error('Color creation failed:', data);
                submitBtn.innerHTML = '<i class="fas fa-times me-1"></i>Помилка!';
                submitBtn.classList.remove('btn-cta');
                submitBtn.classList.add('btn-danger');
                showNotification('Помилка додавання кольору: ' + (data.message || 'Невідома помилка'), 'error');
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-danger');
                    submitBtn.classList.add('btn-cta');
                    submitBtn.disabled = false;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitBtn.innerHTML = '<i class="fas fa-times me-1"></i>Помилка!';
            submitBtn.classList.remove('btn-cta');
            submitBtn.classList.add('btn-danger');
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.classList.remove('btn-danger');
                submitBtn.classList.add('btn-cta');
                submitBtn.disabled = false;
            }, 2000);
        });
    });

    // Обработка формы изображений
    const imageForm = document.getElementById('image-form');
    
    imageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = imageForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Додаємо...';
        submitBtn.disabled = true;
        
        // Сначала создаем товар, если он еще не создан
        createProduct()
        .then(data => {
            if (!data.success) {
                throw new Error('Не удалось создать товар');
            }
            
            const formData = new FormData(imageForm);
            formData.append('product_id', currentProductId);
            
            return fetch(imageForm.action || window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>Додано!';
                submitBtn.classList.remove('btn-cta');
                submitBtn.classList.add('btn-success');
                
                imagesCount++;
                document.getElementById('images-count').textContent = imagesCount;
                
                // Добавляем изображение в контейнер
                addImageToContainer(data.image);
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-cta');
                    submitBtn.disabled = false;
                    bootstrap.Modal.getInstance(document.getElementById('addImageModal')).hide();
                    imageForm.reset();
                }, 1500);
            } else {
                submitBtn.innerHTML = '<i class="fas fa-times me-1"></i>Помилка!';
                submitBtn.classList.remove('btn-cta');
                submitBtn.classList.add('btn-danger');
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-danger');
                    submitBtn.classList.add('btn-cta');
                    submitBtn.disabled = false;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitBtn.innerHTML = '<i class="fas fa-times me-1"></i>Помилка!';
            submitBtn.classList.remove('btn-cta');
            submitBtn.classList.add('btn-danger');
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.classList.remove('btn-danger');
                submitBtn.classList.add('btn-cta');
                submitBtn.disabled = false;
            }, 2000);
        });
    });

    // Функция добавления цвета в контейнер
    function addColorToContainer(colorData) {
        const colorsContainer = document.getElementById('colors-container');
        
        // Если это первый цвет, заменяем пустое состояние
        if (colorsCount === 1) {
            colorsContainer.innerHTML = '<div class="row g-3" id="colors-grid"></div>';
        }
        
        const colorsGrid = document.getElementById('colors-grid');
        const colorCard = document.createElement('div');
        colorCard.className = 'col-md-6 col-lg-4 col-xl-3';
        colorCard.innerHTML = `
            <div class="card bg-dark border-0 h-100">
                <div class="position-relative">
                    <img src="${colorData.image_url}" class="card-img-top" alt="${colorData.name}" style="height: 180px; object-fit: cover;">
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-primary">${colorData.name}</span>
                    </div>
                </div>
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title mb-2">${colorData.name}</h6>
                    <div class="mt-auto">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="removeColor(${colorData.id})">
                                <i class="fas fa-trash me-1"></i>Видалити
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        colorsGrid.appendChild(colorCard);
    }

    // Функция добавления изображения в контейнер
    function addImageToContainer(imageData) {
        const imagesContainer = document.getElementById('images-container');
        
        // Если это первое изображение, заменяем пустое состояние
        if (imagesCount === 1) {
            imagesContainer.innerHTML = '<div class="row g-3" id="images-grid"></div>';
        }
        
        const imagesGrid = document.getElementById('images-grid');
        const imageCard = document.createElement('div');
        imageCard.className = 'col-md-6 col-lg-4 col-xl-3';
        imageCard.innerHTML = `
            <div class="card bg-dark border-0 h-100">
                <img src="${imageData.image_url}" class="card-img-top" alt="Додаткове зображення" style="height: 180px; object-fit: cover;">
                <div class="card-body d-flex flex-column">
                    <div class="mt-auto">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="removeImage(${imageData.id})">
                                <i class="fas fa-trash me-1"></i>Видалити
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        imagesGrid.appendChild(imageCard);
    }

    // Функция показа уведомлений
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // Глобальные функции для удаления
    window.removeColor = function(colorId) {
        if (confirm('Видалити цей колір?')) {
            // Здесь можно добавить AJAX запрос для удаления
            colorsCount--;
            document.getElementById('colors-count').textContent = colorsCount;
            showNotification('Колір видалено!', 'success');
        }
    };

    window.removeImage = function(imageId) {
        if (confirm('Видалити це зображення?')) {
            // Здесь можно добавить AJAX запрос для удаления
            imagesCount--;
            document.getElementById('images-count').textContent = imagesCount;
            showNotification('Зображення видалено!', 'success');
        }
    };
});
</script>

{% endblock %}
