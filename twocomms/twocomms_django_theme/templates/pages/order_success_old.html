{% extends "base.html" %}
{% load static %}

{% block title %}–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ ‚Äî TwoComms{% endblock %}

{% block content %}
<section class="order-success-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div class="order-success-card">
          <div class="order-success-header">
            <div class="success-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </div>
            <h1 class="order-success-title">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ!</h1>
            <div class="order-number">
              <span class="order-number-label">–ù–æ–º–µ—Ä –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</span>
              <span class="order-number-value">{{ order_number }}</span>
            </div>
          </div>
          
          <div class="order-success-content">
            {% if order.payment_status == 'paid' %}
            <div class="success-message">
              <h3>‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø—ñ—à–Ω–æ –ø—Ä–æ–π—à–ª–∞!</h3>
              <p>–î—è–∫—É—î–º–æ –∑–∞ –ø–æ–∫—É–ø–∫—É! –í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ–ø–ª–∞—á–µ–Ω–æ —á–µ—Ä–µ–∑ Monobank —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –æ–±—Ä–æ–±–∫—É. –ú–∏ —Ä–æ–∑–ø–æ—á–Ω–µ–º–æ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫—É –≤–∞—à–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º.</p>
            </div>
            {% elif order.payment_status == 'prepaid' %}
            <div class="success-message">
              <h3>‚úÖ –ü–µ—Ä–µ–¥–ø–ª–∞—Ç–∞ –≤–Ω–µ—Å–µ–Ω–∞!</h3>
              <p>–î—è–∫—É—î–º–æ! –í–∏ –≤–Ω–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–ø–ª–∞—Ç—É {{ order.get_prepayment_amount }} –≥—Ä–Ω. –ó–∞–ª–∏—à–æ–∫ <strong>{{ order.get_remaining_amount }} –≥—Ä–Ω</strong> –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç–∏ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –ø–æ—Å–∏–ª–∫–∏ –Ω–∞ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—ñ –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏.</p>
              <p>–ú–∏ —Ä–æ–∑–ø–æ—á–Ω–µ–º–æ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫—É –≤–∞—à–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º –≤—ñ–¥–ø—Ä–∞–≤–∏–º–æ –π–æ–≥–æ –Ω–∞ –≤–∫–∞–∑–∞–Ω–µ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è.</p>
            </div>
            {% else %}
            <div class="success-message">
              <h3>–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –æ–±—Ä–æ–±–∫—É</h3>
              <p>–ú–µ–Ω–µ–¥–∂–µ—Ä –∑–≤'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ —É—Ç–æ—á–Ω–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏.</p>
            </div>
            {% endif %}
            
            <div class="order-details">
              <h4>–î–µ—Ç–∞–ª—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</h4>
              <div class="order-info">
                <div class="info-row">
                  <span class="info-label">–ü–Ü–ë:</span>
                  <span class="info-value">{{ order.full_name }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                  <span class="info-value">{{ order.phone }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–ú—ñ—Å—Ç–æ:</span>
                  <span class="info-value">{{ order.city }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü:</span>
                  <span class="info-value">{{ order.np_office }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–¢–∏–ø –æ–ø–ª–∞—Ç–∏:</span>
                  <span class="info-value">
                    {% if order.pay_type == 'prepay_200' %}
                      –ü–µ—Ä–µ–¥–ø–ª–∞—Ç–∞ 200 –≥—Ä–Ω
                    {% elif order.pay_type == 'online_full' or order.pay_type == 'full' %}
                      –û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞ (–ø–æ–≤–Ω–∞ —Å—É–º–∞)
                    {% elif order.pay_type == 'cod' %}
                      –û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ
                    {% else %}
                      {{ order.get_pay_type_display|default:order.pay_type }}
                    {% endif %}
                  </span>
                </div>
                <div class="info-row">
                  <span class="info-label">–°—É–º–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</span>
                  <span class="info-value">{{ order.total_sum }} –≥—Ä–Ω</span>
                </div>
                {% if order.pay_type == 'prepay_200' and order.payment_status == 'prepaid' %}
                <div class="info-row">
                  <span class="info-label">–í–Ω–µ—Å–µ–Ω–∞ –ø–µ—Ä–µ–¥–ø–ª–∞—Ç–∞:</span>
                  <span class="info-value" style="color: #10b981; font-weight: 600;">{{ order.get_prepayment_amount }} –≥—Ä–Ω ‚úÖ</span>
                </div>
                <div class="info-row">
                  <span class="info-label">–ó–∞–ª–∏—à–æ–∫ (–ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ):</span>
                  <span class="info-value" style="font-weight: 600;">{{ order.get_remaining_amount }} –≥—Ä–Ω</span>
                </div>
                {% endif %}
                <div class="info-row">
                  <span class="info-label">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç–∏:</span>
                  <span class="info-value">
                    {% if order.payment_status == 'paid' %}
                      <span class="badge bg-success">–û–ø–ª–∞—á–µ–Ω–æ –ø–æ–≤–Ω—ñ—Å—Ç—é</span>
                    {% elif order.payment_status == 'prepaid' %}
                      <span class="badge bg-info">–í–Ω–µ—Å–µ–Ω–∞ –ø–µ—Ä–µ–¥–ø–ª–∞—Ç–∞</span>
                    {% else %}
                      {{ order.get_payment_status_display|default:order.payment_status }}
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>
            
            {% if user.is_authenticated %}
            <div class="auth-suggestion">
              <div class="auth-suggestion-content">
                <h4>‚úÖ –î—è–∫—É—î–º–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!</h4>
                <p>–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ü–µ —Ç–∞ —ñ–Ω—à—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —É –≤–∞—à–æ–º—É –æ—Å–æ–±–∏—Å—Ç–æ–º—É –∫–∞–±—ñ–Ω–µ—Ç—ñ.</p>
                <div class="auth-buttons">
                  <a href="{% url 'my_orders' %}" class="btn btn-primary">–ú–æ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
                </div>
              </div>
            </div>
            {% else %}
            <div class="auth-suggestion">
              <div class="auth-suggestion-content">
                <h4>üîê –°—Ç–≤–æ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ</h4>
                <p>–ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å –∞–±–æ —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É, —â–æ–±:</p>
                <ul class="auth-benefits">
                  <li>üìä –ù–∞–∫–æ–ø–∏—á—É–≤–∞—Ç–∏ –±–∞–ª–∏ –∑–∞ –ø–æ–∫—É–ø–∫–∏</li>
                  <li>üìà –í—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω—å</li>
                  <li>üíæ –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ–∫—É–ø–æ–∫</li>
                  <li>üéÅ –û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</li>
                </ul>
                <div class="auth-buttons">
                  <a href="{% url 'login' %}" class="btn btn-primary">–£–≤—ñ–π—Ç–∏</a>
                  <a href="{% url 'register' %}" class="btn btn-outline-primary">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</a>
                </div>
                <div class="auth-note">
                  <small>–Ø–∫—â–æ –≤–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä—É—î—Ç–µ—Å—å, —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏–≤'—è–∂–µ—Ç—å—Å—è –¥–æ –≤–∞—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É</small>
                </div>
              </div>
            </div>
            {% endif %}
            
            <div class="order-success-actions">
              <a href="{% url 'home' %}" class="btn btn-cta">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –Ω–∞ –≥–æ–ª–æ–≤–Ω—É</a>
              <a href="{% url 'catalog' %}" class="btn btn-outline-light">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<div id="purchase-payload"
     data-order-id="{{ order.id }}"
     data-order-number="{{ order.order_number }}"
     data-value="{{ order.total_sum|floatformat:2 }}"
     data-currency="UAH"
     data-payment-status="{{ order.payment_status }}"
     data-full-name="{{ order.full_name }}"
     data-phone="{{ order.phone }}"
     data-city="{{ order.city }}"
     {% if user.is_authenticated and user.userprofile.email %}data-email="{{ user.userprofile.email }}"{% endif %}
     data-contents='[{% for item in order.items.all %}{"id":"{{ item.product.id }}","quantity":{{ item.qty }},"price":{{ item.unit_price|floatformat:2 }},"name":"{{ item.title|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}]'>
</div>

<script>
(function() {
  'use strict';
  
  try {
    var el = document.getElementById('purchase-payload');
    if (!el) return;
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
    var paymentStatus = el.dataset.paymentStatus || 'unpaid';
    var isPaid = paymentStatus === 'paid';
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º –±—ã–ª –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω event –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
    var orderId = el.dataset.orderId;
    var eventType = isPaid ? 'purchase' : 'lead';
    var storageKey = 'gtm_' + eventType + '_' + orderId;
    
    if (sessionStorage.getItem(storageKey)) {
      console.log('GTM ' + eventType + ' event already sent for order:', orderId);
      return;
    }
    
    // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
    var orderNumber = el.dataset.orderNumber || '';
    var value = parseFloat(el.dataset.value || '0');
    var currency = el.dataset.currency || 'UAH';
    var fullName = el.dataset.fullName || '';
    var phone = el.dataset.phone || '';
    var city = el.dataset.city || '';
    var email = el.dataset.email || '';
    var contents = [];
    
    try {
      contents = JSON.parse(el.dataset.contents || '[]');
    } catch(e) {
      console.error('Error parsing contents:', e);
      contents = [];
    }
    
    // Enhanced Conversions / Advanced Matching –¥–∞–Ω–Ω—ã–µ (–æ–±—â–∏–µ –¥–ª—è GTM –∏ FB)
    var userData = {};
    
    // –†–∞–∑–±–∏–≤–∞–µ–º –§–ò–û –Ω–∞ —á–∞—Å—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (fullName) {
      var nameParts = fullName.trim().split(/\s+/);
      if (nameParts.length >= 2) {
        userData.first_name = nameParts[0];
        userData.last_name = nameParts[nameParts.length - 1];
      } else {
        userData.first_name = fullName;
      }
    }
    
    if (phone) {
      userData.phone_number = phone;
    }
    
    if (email) {
      userData.email = email;
    }
    
    if (city) {
      userData.address = {
        city: city
      };
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º dataLayer –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    window.dataLayer = window.dataLayer || [];
    
    // –†–ê–ó–î–ï–õ–Ø–ï–ú –õ–û–ì–ò–ö–£: Purchase vs Lead
    if (isPaid) {
      // ========================================
      // –û–ü–õ–ê–ß–ï–ù–ù–´–ô –ó–ê–ö–ê–ó ‚Üí PURCHASE
      // ========================================
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è GTM Purchase
      var purchaseData = {
        event: 'purchase',
        ecommerce: {
          transaction_id: orderNumber,
          value: value,
          currency: currency,
          items: contents.map(function(item) {
            return {
              item_id: item.id,
              item_name: item.name || 'Product ' + item.id,
              quantity: item.quantity,
              price: item.price || 0
            };
          })
        }
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º userData –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ
      if (Object.keys(userData).length > 0) {
        purchaseData.user_data = userData;
      }
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ Purchase –≤ GTM
    window.dataLayer.push(purchaseData);
      console.log('‚úÖ GTM Purchase event sent (PAID):', purchaseData);
    
    // Meta Pixel (Facebook Pixel) Purchase —Å Advanced Matching
    if (window.fbq) {
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Advanced Matching
      var fbUserData = {};
      
      if (email) {
          fbUserData.em = email.toLowerCase();
      }
      if (phone) {
          fbUserData.ph = phone.replace(/\D/g, ''); // —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
      }
      if (fullName) {
        var nameParts = fullName.trim().split(/\s+/);
        if (nameParts.length >= 1) {
            fbUserData.fn = nameParts[0].toLowerCase();
        }
        if (nameParts.length >= 2) {
            fbUserData.ln = nameParts[nameParts.length - 1].toLowerCase();
        }
      }
      if (city) {
          fbUserData.ct = city.toLowerCase();
      }
      
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º event_id –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
      var eventId = '{{ order.get_facebook_event_id }}';
      
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Purchase event —Å eventID –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
      fbq('track', 'Purchase', {
        value: value,
        currency: currency,
        contents: contents.map(function(item) {
          return {
            id: item.id,
            quantity: item.quantity
          };
        }),
        content_type: 'product'
      }, {
        eventID: eventId,
        // Advanced Matching
        em: fbUserData.em,
        ph: fbUserData.ph,
        fn: fbUserData.fn,
        ln: fbUserData.ln,
        ct: fbUserData.ct
      });
      
        console.log('‚úÖ Meta Pixel Purchase event sent (PAID) with eventID:', eventId, 'and Advanced Matching:', fbUserData);
  }
      
    } else {
      // ========================================
      // –ù–ï–û–ü–õ–ê–ß–ï–ù–ù–´–ô –ó–ê–ö–ê–ó ‚Üí LEAD
      // ========================================
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è GTM Lead
      var leadData = {
        event: 'lead',
        lead_data: {
          order_id: orderNumber,
          value: value,
          currency: currency,
          payment_status: paymentStatus
        }
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º userData –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ
      if (Object.keys(userData).length > 0) {
        leadData.user_data = userData;
      }
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ Lead –≤ GTM
      window.dataLayer.push(leadData);
      console.log('üìã GTM Lead event sent (UNPAID):', leadData);
      
      // Meta Pixel (Facebook Pixel) Lead —Å Advanced Matching
      if (window.fbq) {
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Advanced Matching
        var fbUserData = {};
        
        if (email) {
          fbUserData.em = email.toLowerCase();
        }
        if (phone) {
          fbUserData.ph = phone.replace(/\D/g, '');
        }
        if (fullName) {
          var nameParts = fullName.trim().split(/\s+/);
          if (nameParts.length >= 1) {
            fbUserData.fn = nameParts[0].toLowerCase();
          }
          if (nameParts.length >= 2) {
            fbUserData.ln = nameParts[nameParts.length - 1].toLowerCase();
          }
        }
        if (city) {
          fbUserData.ct = city.toLowerCase();
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º event_id –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–¥–æ–±–∞–≤–ª—è–µ–º _lead –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏)
        var leadEventId = '{{ order.get_facebook_event_id }}_lead';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Lead event —Å eventID
        fbq('track', 'Lead', {
          value: value,
          currency: currency,
          content_name: 'Order ' + orderNumber,
          content_category: 'order_lead'
        }, {
          eventID: leadEventId,
          // Advanced Matching
          em: fbUserData.em,
          ph: fbUserData.ph,
          fn: fbUserData.fn,
          ln: fbUserData.ln,
          ct: fbUserData.ct
        });
        
        console.log('üìã Meta Pixel Lead event sent (UNPAID) with eventID:', leadEventId, 'and Advanced Matching:', fbUserData);
      }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥ —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    sessionStorage.setItem(storageKey, 'true');
    
  } catch(e) {
    console.error('Error in conversion tracking:', e);
  }
})();
</script>
{% endblock %}
