{% extends "base.html" %}
{% load static %}

{% block title %}–¢–µ—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π - TwoComms{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card bg-elevate border-0 rounded-4 shadow-lg">
        <div class="card-body p-4 p-md-5">
          
          <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
          <div class="text-center mb-4">
            <h1 class="display-5 fw-bold mb-3">üß™ –¢–µ—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π</h1>
            <p class="text-muted">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ TikTok Events Manager –∏ Facebook Events Manager</p>
          </div>
          
          <!-- –°—Ç–∞—Ç—É—Å Test Event Code -->
          {% if ttq_test_code %}
          <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
            <svg class="bi flex-shrink-0 me-2" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
            </svg>
            <div>
              <strong>Test Mode –∞–∫—Ç–∏–≤–µ–Ω!</strong><br>
              TikTok Test Event Code: <code>{{ ttq_test_code }}</code><br>
              <small>–°–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤—ã–µ –∏ –ø–æ—è–≤—è—Ç—Å—è –≤ TikTok Events Manager</small>
            </div>
          </div>
          {% else %}
          <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
            <svg class="bi flex-shrink-0 me-2" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            <div>
              <strong>Test Mode –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω</strong><br>
              –î–æ–±–∞–≤—å—Ç–µ <code>?ttq_test=YOUR_TEST_CODE</code> –∫ URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è<br>
              –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è <code>TIKTOK_TEST_EVENT_CODE</code>
            </div>
          </div>
          {% endif %}
          
          <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
          <div class="mb-4">
            <h3 class="h5 mb-3">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
            <ol class="mb-0">
              <li>–û—Ç–∫—Ä–æ–π—Ç–µ <strong>TikTok Events Manager</strong> ‚Üí <strong>Test Events</strong></li>
              <li>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à <strong>Test Event Code</strong></li>
              <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è"</strong> –Ω–∏–∂–µ</li>
              <li>–°–æ–±—ã—Ç–∏—è –ø–æ—è–≤—è—Ç—Å—è –≤ TikTok Events Manager –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!</li>
            </ol>
          </div>
          
          <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π -->
          <div class="mb-4">
            <h3 class="h5 mb-3">üéØ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏—è</h3>
            
            <div class="d-grid gap-2 mb-3">
              <button type="button" class="btn btn-primary btn-lg" onclick="sendAllEvents()">
                üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
              </button>
            </div>
            
            <div class="row g-2">
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-primary w-100" onclick="sendEvent('PageView')">
                  üìÑ PageView
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-primary w-100" onclick="sendEvent('ViewContent')">
                  üëÅÔ∏è ViewContent
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-success w-100" onclick="sendEvent('AddToCart')">
                  üõí AddToCart
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-success w-100" onclick="sendEvent('AddToWishlist')">
                  ‚ù§Ô∏è AddToWishlist
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-warning w-100" onclick="sendEvent('InitiateCheckout')">
                  üí≥ InitiateCheckout
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-warning w-100" onclick="sendEvent('StartPayment')">
                  üí∞ StartPayment
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-danger w-100" onclick="sendEvent('Purchase')">
                  ‚úÖ Purchase
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-info w-100" onclick="sendEvent('Search')">
                  üîç Search
                </button>
              </div>
            </div>
          </div>
          
          <!-- –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π -->
          <div class="mb-4">
            <h3 class="h5 mb-3">üìä –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h3>
            <div id="event-log" class="bg-dark rounded-3 p-3" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
              <div class="text-muted">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...</div>
            </div>
          </div>
          
          <!-- –°—Ç–∞—Ç—É—Å –ø–∏–∫—Å–µ–ª–µ–π -->
          <div class="mb-4">
            <h3 class="h5 mb-3">üîç –°—Ç–∞—Ç—É—Å –ø–∏–∫—Å–µ–ª–µ–π</h3>
            <div id="pixel-status" class="row g-2">
              <div class="col-md-6">
                <div class="card bg-dark border-0">
                  <div class="card-body">
                    <h6 class="card-title">TikTok Pixel</h6>
                    <div id="ttq-status" class="text-muted">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-dark border-0">
                  <div class="card-body">
                    <h6 class="card-title">Meta Pixel</h6>
                    <div id="fbq-status" class="text-muted">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
  const testProduct = {
    id: 'TC-999-test-001-M',
    name: '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä TwoComms',
    category: '–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è',
    price: 599,
    quantity: 1
  };
  
  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
  function logEvent(eventName, status, details) {
    const log = document.getElementById('event-log');
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!log) {
      console.warn('[Test Analytics] event-log element not found, logging to console instead');
      console.log(`[${status}] ${eventName}${details ? ': ' + details : ''}`);
      return;
    }
    
    const time = new Date().toLocaleTimeString('uk-UA');
    const statusIcon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
    const statusColor = status === 'success' ? 'text-success' : status === 'error' ? 'text-danger' : 'text-warning';
    
    const logEntry = document.createElement('div');
    logEntry.className = `mb-2 ${statusColor}`;
    logEntry.innerHTML = `<strong>${statusIcon} [${time}]</strong> ${eventName}${details ? ': ' + details : ''}`;
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ firstChild –∏ classList
    if (log.firstChild && log.firstChild.classList && log.firstChild.classList.contains('text-muted')) {
      log.firstChild.remove();
    }
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞
    if (log.firstChild) {
      log.insertBefore(logEntry, log.firstChild);
    } else {
      log.appendChild(logEntry);
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
    while (log.children.length > 20) {
      log.removeChild(log.lastChild);
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–∏–∫—Å–µ–ª–µ–π
  function checkPixelStatus() {
    // TikTok Pixel
    if (window.ttq && typeof window.ttq.track === 'function') {
      const ttqStatus = document.getElementById('ttq-status');
      ttqStatus.innerHTML = '<span class="text-success">‚úì –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</span>';
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º test_event_code
      if (window.ttq._o && window.ttq._o[Object.keys(window.ttq._o)[0]]) {
        const testCode = window.ttq._o[Object.keys(window.ttq._o)[0]].test_event_code;
        if (testCode) {
          ttqStatus.innerHTML += '<br><small class="text-info">Test Code: ' + testCode + '</small>';
        }
      }
    } else {
      document.getElementById('ttq-status').innerHTML = '<span class="text-danger">‚úó –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω</span>';
    }
    
    // Meta Pixel
    if (window.fbq && typeof window.fbq === 'function') {
      document.getElementById('fbq-status').innerHTML = '<span class="text-success">‚úì –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</span>';
    } else {
      document.getElementById('fbq-status').innerHTML = '<span class="text-danger">‚úó –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω</span>';
    }
  }
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
  function sendEvent(eventName) {
    logEvent(eventName, 'pending', '–û—Ç–ø—Ä–∞–≤–∫–∞...');
    
    try {
      let payload = {};
      
      switch(eventName) {
        case 'PageView':
          // PageView —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –Ω–æ –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞
          if (window.trackEvent) {
            window.trackEvent('PageView', {});
          }
          break;
          
        case 'ViewContent':
          if (window.trackEvent) {
            window.trackEvent('ViewContent', {
              content_ids: [testProduct.id],
              content_name: testProduct.name,
              content_type: 'product',
              content_category: testProduct.category,
              value: testProduct.price,
              currency: 'UAH',
              contents: [{
                id: testProduct.id,
                quantity: testProduct.quantity,
                item_price: testProduct.price
              }]
            });
          }
          break;
          
        case 'AddToCart':
          if (window.trackEvent) {
            window.trackEvent('AddToCart', {
              content_ids: [testProduct.id],
              content_type: 'product',
              value: testProduct.price,
              currency: 'UAH',
              num_items: testProduct.quantity,
              contents: [{
                id: testProduct.id,
                quantity: testProduct.quantity,
                item_price: testProduct.price
              }]
            });
          }
          break;
          
        case 'AddToWishlist':
          if (window.trackEvent) {
            window.trackEvent('AddToWishlist', {
              content_ids: [testProduct.id],
              content_type: 'product',
              value: testProduct.price,
              currency: 'UAH',
              num_items: testProduct.quantity,
              contents: [{
                id: testProduct.id,
                quantity: testProduct.quantity,
                item_price: testProduct.price
              }]
            });
          }
          break;
          
        case 'InitiateCheckout':
          if (window.trackEvent) {
            window.trackEvent('InitiateCheckout', {
              content_ids: [testProduct.id],
              content_type: 'product',
              value: testProduct.price,
              currency: 'UAH',
              num_items: testProduct.quantity,
              contents: [{
                id: testProduct.id,
                quantity: testProduct.quantity,
                item_price: testProduct.price
              }]
            });
          }
          break;
          
        case 'StartPayment':
          if (window.trackEvent) {
            window.trackEvent('StartPayment', {
              content_ids: [testProduct.id],
              content_type: 'product',
              value: testProduct.price,
              currency: 'UAH',
              num_items: testProduct.quantity,
              payment_method: 'test',
              contents: [{
                id: testProduct.id,
                quantity: testProduct.quantity,
                item_price: testProduct.price
              }]
            });
          }
          break;
          
        case 'Purchase':
          if (window.trackEvent) {
            window.trackEvent('Purchase', {
              content_ids: [testProduct.id],
              content_type: 'product',
              value: testProduct.price,
              currency: 'UAH',
              contents: [{
                id: testProduct.id,
                quantity: testProduct.quantity,
                item_price: testProduct.price
              }]
            });
          }
          break;
          
        case 'Search':
          if (window.trackEvent) {
            window.trackEvent('Search', {
              search_string: '—Ç–µ—Å—Ç –ø–æ–∏—Å–∫',
              content_ids: [testProduct.id],
              value: testProduct.price,
              currency: 'UAH',
              contents: [{
                id: testProduct.id,
                item_price: testProduct.price
              }]
            });
          }
          break;
      }
      
      logEvent(eventName, 'success', '–°–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
      
    } catch (error) {
      logEvent(eventName, 'error', error.message);
    }
  }
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
  function sendAllEvents() {
    const events = [
      { name: 'PageView', delay: 0 },
      { name: 'ViewContent', delay: 500 },
      { name: 'AddToCart', delay: 1000 },
      { name: 'AddToWishlist', delay: 1500 },
      { name: 'InitiateCheckout', delay: 2000 },
      { name: 'StartPayment', delay: 2500 },
      { name: 'Purchase', delay: 3000 },
      { name: 'Search', delay: 3500 }
    ];
    
    logEvent('ALL_EVENTS', 'pending', '–ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π...');
    
    events.forEach(function(event) {
      setTimeout(function() {
        sendEvent(event.name);
      }, event.delay);
    });
    
    setTimeout(function() {
      logEvent('ALL_EVENTS', 'success', '–í—Å–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!');
    }, 4000);
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–∏–∫—Å–µ–ª–µ–π —Å—Ä–∞–∑—É –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
  setTimeout(checkPixelStatus, 1000);
  setTimeout(checkPixelStatus, 3000);
  
  // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –û–¢–ü–†–ê–í–ö–ê –í–°–ï–• –°–û–ë–´–¢–ò–ô –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
  // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –≤ TikTok Events Manager —Å—Ä–∞–∑—É
  setTimeout(function() {
    logEvent('AUTO_SEND', 'pending', '–ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π...');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
    const autoEvents = [
      { name: 'PageView', delay: 500 },
      { name: 'ViewContent', delay: 1000 },
      { name: 'AddToCart', delay: 1500 },
      { name: 'AddToWishlist', delay: 2000 },
      { name: 'InitiateCheckout', delay: 2500 },
      { name: 'StartPayment', delay: 3000 },
      { name: 'Purchase', delay: 3500 },
      { name: 'Search', delay: 4000 }
    ];
    
    autoEvents.forEach(function(event) {
      setTimeout(function() {
        sendEvent(event.name);
      }, event.delay);
    });
    
    setTimeout(function() {
      logEvent('AUTO_SEND', 'success', '–í—Å–µ —Å–æ–±—ã—Ç–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ TikTok Events Manager.');
    }, 4500);
  }, 3000); // –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã —á—Ç–æ–±—ã –ø–∏–∫—Å–µ–ª–∏ —Ç–æ—á–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
  
})();
</script>

<style>
#event-log {
  background-color: #1a1a1a !important;
  color: #00ff00;
  border: 1px solid #333;
}

#event-log div {
  white-space: pre-wrap;
  word-wrap: break-word;
}

.btn:hover {
  transform: translateY(-2px);
  transition: transform 0.2s;
}
</style>
{% endblock %}

