{% extends 'base.html' %}
{% load static %}

{% block title %}Адмін-панель — TwoComms{% endblock %}

{% block content %}
{% csrf_token %}
<div class="admin-panel">
  <!-- Заголовок админ-панели -->
        <div class="admin-header">
        <div class="admin-header-content">
          <h1 class="admin-title">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            Адмін-панель
          </h1>
          <button onclick="testAjax()" class="btn btn-primary">Тест AJAX</button>
      <div class="admin-nav">
        <a href="?section=stats" class="admin-nav-item {% if section == 'stats' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
          </svg>
          Статистика
        </a>
        <a href="?section=orders" class="admin-nav-item {% if section == 'orders' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          Замовлення
        </a>
        <a href="?section=users" class="admin-nav-item {% if section == 'users' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-1.7 2.26V15h-1.5v-6h1.5v1.5l1.7-2.26c.47-.63 1.21-1 2.01-1h1.54c.8 0 1.54.37 2.01 1L21.5 15H20v6h2zM12.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6.5h1.5V22h4z"/>
          </svg>
          Користувачі
        </a>
        <a href="?section=catalogs" class="admin-nav-item {% if section == 'catalogs' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          Каталоги
        </a>
      </div>
    </div>
  </div>

  <!-- Контент секции -->
  <div class="admin-content">
    {% if section == 'stats' %}
      <!-- Статистика -->
      <div class="stats-section">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ stats.orders_today|default:0 }}</div>
              <div class="stat-label">Замовлень сьогодні</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ stats.revenue|default:0 }} грн</div>
              <div class="stat-label">Виручка сьогодні</div>
            </div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-1.7 2.26V15h-1.5v-6h1.5v1.5l1.7-2.26c.47-.63 1.21-1 2.01-1h1.54c.8 0 1.54.37 2.01 1L21.5 15H20v6h2z"/>
              </svg>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ stats.users|default:0 }}</div>
              <div class="stat-label">Користувачів</div>
            </div>
          </div>
        </div>
      </div>

    {% elif section == 'orders' %}
      <!-- Управление заказами -->
      <div class="orders-admin-section">
        <!-- Фильтры и статистика -->
        <div class="orders-filters">
          <div class="filter-stats">
            <div class="filter-stat-item" onclick="filterOrders('all', 'all')">
              <div class="filter-stat-number">{{ stats.total }}</div>
              <div class="filter-stat-label">Всі замовлення</div>
            </div>
            <div class="filter-stat-item" onclick="filterOrders('new', 'all')">
              <div class="filter-stat-number">{{ stats.processing }}</div>
              <div class="filter-stat-label">В обробці</div>
            </div>
            <div class="filter-stat-item" onclick="filterOrders('all', 'checking')">
              <div class="filter-stat-number">{{ stats.checking_payments }}</div>
              <div class="filter-stat-label">Очікують підтвердження</div>
            </div>
            <div class="filter-stat-item" onclick="filterOrders('all', 'paid')">
              <div class="filter-stat-number">{{ stats.paid }}</div>
              <div class="filter-stat-label">Оплачені</div>
            </div>
            <div class="filter-stat-item" onclick="filterOrders('all', 'partial')">
              <div class="filter-stat-number">{{ stats.partial_paid }}</div>
              <div class="filter-stat-label">Частково оплачені</div>
            </div>
            <div class="filter-stat-item" onclick="filterOrders('all', 'unpaid')">
              <div class="filter-stat-number">{{ stats.unpaid }}</div>
              <div class="filter-stat-label">Не оплачені</div>
            </div>
          </div>
          
          <div class="filter-controls">
            <select class="filter-select" onchange="filterOrders(this.value, '{{ payment_filter }}')">
              <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Всі статуси</option>
              <option value="new" {% if status_filter == 'new' %}selected{% endif %}>В обробці</option>
              <option value="prep" {% if status_filter == 'prep' %}selected{% endif %}>Готується до відправлення</option>
              <option value="ship" {% if status_filter == 'ship' %}selected{% endif %}>Відправлено</option>
              <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Отримано</option>
              <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Скасовано</option>
            </select>
            
            <select class="filter-select" onchange="filterOrders('{{ status_filter }}', this.value)">
              <option value="all" {% if payment_filter == 'all' %}selected{% endif %}>Всі оплати</option>
              <option value="unpaid" {% if payment_filter == 'unpaid' %}selected{% endif %}>Не оплачено</option>
              <option value="checking" {% if payment_filter == 'checking' %}selected{% endif %}>На перевірці</option>
              <option value="partial" {% if payment_filter == 'partial' %}selected{% endif %}>Внесена передплата</option>
              <option value="paid" {% if payment_filter == 'paid' %}selected{% endif %}>Оплачено повністю</option>
            </select>
          </div>
        </div>

        <!-- Список заказов -->
        <div class="orders-list">
          {% for o in orders %}
            <div class="admin-order-card" data-order-id="{{ o.id }}">
              <!-- Анимация искр -->
              <div class="order-sparks">
                <div class="order-spark order-spark-1"></div>
                <div class="order-spark order-spark-2"></div>
                <div class="order-spark order-spark-3"></div>
              </div>
              
              <!-- Заголовок заказа -->
              <div class="order-header">
                <div class="order-header-row">
                  <div class="order-number-container">
                    <button class="order-number-btn" onclick="copyOrderNumber('{{ o.order_number }}')" data-order-number="{{ o.order_number }}">
                      <div class="order-number-glow"></div>
                      <div class="order-number-content">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <span class="order-number-text">#{{ o.order_number }}</span>
                        <svg class="copy-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                      </div>
                    </button>
                  </div>
                  
                  <div class="order-customer-info">
                    <div class="customer-details">
                      <div class="customer-name">{{ o.full_name }}</div>
                      <div class="customer-phone">{{ o.phone }}</div>
                      <div class="customer-email">{{ o.user.email|default:"Гість" }}</div>
                    </div>
                    <div class="order-date-info">
                      <div class="order-date">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                        </svg>
                        {{ o.created|date:"d.m.Y о H:i" }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Компактная информация о доставке -->
              <div class="order-delivery-compact">
                <div class="delivery-compact-item">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                  </svg>
                  <span>{{ o.city }}, {{ o.np_office }}</span>
                </div>
                <div class="delivery-item" data-field="ttn">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/>
                  </svg>
                  <span class="ttn-info">
                    {% if o.tracking_number %}
                      {{ o.tracking_number }}
                    {% else %}
                      <span class="ttn-pending">ТТН очікується</span>
                    {% endif %}
                  </span>
                </div>
              </div>

              <!-- Сумма заказа -->
              <div class="order-total-section">
                <div class="order-total-card">
                  <div class="total-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                  </div>
                  <div class="total-content">
                    <div class="total-label">Сума замовлення</div>
                    <div class="total-amount">{{ o.total_sum }} грн</div>
                  </div>
        </div>
      </div>

              <!-- Этапы статуса заказа (кликабельные для админа) -->
              <div class="order-status-track admin-status-track">
                <div class="status-step {% if o.status == 'new' %}active{% elif o.status in 'prep,ship,done' %}completed{% endif %}" onclick="updateOrderStatus('{{ o.id }}', 'new')">
                  <div class="status-step-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                  </div>
                  <div class="status-step-label">В обробці</div>
                </div>
                
                <div class="status-connector {% if o.status in 'prep,ship,done' %}completed{% endif %}"></div>
                
                <div class="status-step {% if o.status == 'prep' %}active{% elif o.status in 'ship,done' %}completed{% endif %}" onclick="updateOrderStatus('{{ o.id }}', 'prep')">
                  <div class="status-step-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                    </svg>
                  </div>
                  <div class="status-step-label">Готується</div>
                </div>
                
                <div class="status-connector {% if o.status in 'ship,done' %}completed{% endif %}"></div>
                
                <div class="status-step {% if o.status == 'ship' %}active{% elif o.status == 'done' %}completed{% endif %}" onclick="updateOrderStatus('{{ o.id }}', 'ship')">
                  <div class="status-step-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                    </svg>
                  </div>
                  <div class="status-step-label">Відправлено</div>
                </div>
                
                <div class="status-connector {% if o.status == 'done' %}completed{% endif %}"></div>
                
                <div class="status-step {% if o.status == 'done' %}active{% endif %}" onclick="updateOrderStatus('{{ o.id }}', 'done')">
                  <div class="status-step-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
        </div>
                  <div class="status-step-label">Отримано</div>
        </div>
      </div>

              <!-- Статус оплаты (селект) -->
              <div class="order-payment-status">
                <div class="payment-status-header">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  <span>Статус оплати</span>
                </div>
                <select class="payment-status-select" onchange="updatePaymentStatus('{{ o.id }}', this.value)" data-original-value="{{ o.payment_status }}">
                  <option value="unpaid" {% if o.payment_status == 'unpaid' %}selected{% endif %}>Не оплачено</option>
                  <option value="checking" {% if o.payment_status == 'checking' %}selected{% endif %}>На перевірці</option>
                  <option value="partial" {% if o.payment_status == 'partial' %}selected{% endif %}>Внесена передплата</option>
                  <option value="paid" {% if o.payment_status == 'paid' %}selected{% endif %}>Оплачено повністю</option>
                </select>
              </div>

              <!-- Скриншот оплаты (сворачиваемый) -->
              {% if o.payment_screenshot %}
                <div class="payment-screenshot-collapsible">
                  <div class="screenshot-header" onclick="toggleScreenshot('{{ o.id }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                    <span>Скріншот оплати</span>
                    {% if o.payment_status == 'checking' %}
                      <span class="screenshot-status checking">Очікує перевірки</span>
                    {% elif o.payment_status == 'paid' %}
                      <span class="screenshot-status approved">Підтверджено</span>
                    {% elif o.payment_status == 'partial' %}
                      <span class="screenshot-status partial">Часткова оплата</span>
                    {% else %}
                      <span class="screenshot-status unpaid">Не оплачено</span>
                    {% endif %}
                    <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M7 10l5 5 5-5z"/>
                    </svg>
                  </div>
                  <div class="screenshot-content" id="screenshot-{{ o.id }}" style="display: none;">
                    <div class="screenshot-container">
                      <img src="{{ o.payment_screenshot.url }}" alt="Скріншот оплати" class="payment-screenshot">
                      {% if o.payment_status == 'checking' %}
                        <div class="screenshot-actions">
                          <button class="btn-approve" onclick="approvePayment('{{ o.id }}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                            Підтвердити оплату
                          </button>
                          <button class="btn-reject" onclick="rejectPayment('{{ o.id }}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                            Відхилити оплату
                          </button>
                        </div>
                      {% else %}
                        <div class="screenshot-info">
                          <div class="info-item">
                            <span class="info-label">Статус:</span>
                            <span class="info-value">
                              {% if o.payment_status == 'paid' %}
                                ✅ Оплачено повністю
                              {% elif o.payment_status == 'partial' %}
                                ⚠️ Внесена передплата
                              {% else %}
                                ❌ Не оплачено
                              {% endif %}
                            </span>
                          </div>
                          <div class="info-item">
                            <span class="info-label">Завантажено:</span>
                            <span class="info-value">{{ o.created|date:"d.m.Y о H:i" }}</span>
                          </div>
                        </div>
                      {% endif %}
        </div>
                  </div>
                </div>
              {% endif %}

              <!-- Товары в заказе -->
              <div class="order-items-section">
                <div class="order-items-header">
                  <div class="order-items-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    Товари в замовленні ({{ o.items.count }})
        </div>
      </div>
                
                <div class="order-items-list">
                  {% for item in o.items.all %}
                    <div class="order-item-card">
                      <div class="order-item-image">
                        {% if item.color_variant and item.color_variant.images.exists %}
                          <img src="{{ item.color_variant.images.first.image.url }}" alt="{{ item.product.title }}" class="order-item-img">
                        {% elif item.product.images.exists %}
                          <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.title }}" class="order-item-img">
                        {% else %}
                          <div class="order-item-placeholder">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                            </svg>
                          </div>
                        {% endif %}
                      </div>
                      
                      <div class="order-item-content">
                        <div class="order-item-main">
                          <div class="order-item-title">{{ item.product.title }}</div>
                          <div class="order-item-specs">
                            {% if item.size %}
                            <div class="order-item-spec">
                              <span class="spec-label">Розмір:</span>
                              <span class="spec-value">{{ item.size }}</span>
                            </div>
                            {% endif %}
                            <div class="order-item-spec">
                              <span class="spec-label">Кількість:</span>
                              <span class="spec-value">{{ item.qty }} шт</span>
                            </div>
                            {% if item.color_variant %}
                            <div class="order-item-spec">
                              <span class="spec-label">Колір:</span>
                              <span class="spec-value">{{ item.color_variant.name }}</span>
                            </div>
                            {% endif %}
                          </div>
                        </div>
                        
                        <div class="order-item-price">
                          <div class="price-item">
                            <span class="price-label">Ціна за шт:</span>
                            <span class="price-value">{{ item.unit_price }} грн</span>
                          </div>
                          <div class="price-item total">
                            <span class="price-label">Всього:</span>
                            <span class="price-value">{{ item.line_total }} грн</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% empty %}
            <div class="orders-empty">
              <div class="orders-empty-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
              </div>
              <h2 class="orders-empty-title">Замовлень не знайдено</h2>
              <p class="orders-empty-text">Спробуйте змінити фільтри</p>
            </div>
                {% endfor %}
        </div>
      </div>

    {% elif section == 'users' %}
      <!-- Управление пользователями -->
      <div class="users-section">
        <div class="users-list">
          {% for user_data in user_data %}
            <div class="user-card">
              <div class="user-info">
                <div class="user-avatar">
                  {% if user_data.profile.avatar %}
                    <img src="{{ user_data.profile.avatar.url }}" alt="{{ user_data.user.username }}">
              {% else %}
                    <div class="default-avatar">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                      </svg>
                    </div>
                  {% endif %}
                </div>
                <div class="user-details">
                  <div class="user-name">{{ user_data.user.username }}</div>
                  <div class="user-email">{{ user_data.user.email|default:"Email не вказано" }}</div>
                  <div class="user-phone">{{ user_data.profile.phone|default:"Телефон не вказано" }}</div>
                  <div class="user-points">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    {{ user_data.points.points|default:0 }} балів
                  </div>
                </div>
              </div>
              <div class="user-actions">
                <form method="POST" action="{% url 'admin_update_user' %}">
                  {% csrf_token %}
                  <input type="hidden" name="user_id" value="{{ user_data.user.id }}">
                  <div class="form-check">
                    <input type="checkbox" name="is_staff" id="staff_{{ user_data.user.id }}" 
                           {% if user_data.user.is_staff %}checked{% endif %} class="form-check-input">
                    <label for="staff_{{ user_data.user.id }}">Адміністратор</label>
                  </div>
                  {% if request.user.is_superuser %}
                    <div class="form-check">
                      <input type="checkbox" name="is_superuser" id="super_{{ user_data.user.id }}" 
                             {% if user_data.user.is_superuser %}checked{% endif %} class="form-check-input">
                      <label for="super_{{ user_data.user.id }}">Суперкористувач</label>
                    </div>
              {% endif %}
                  <div class="points-adjustment">
                    <input type="number" name="points_adjustment" placeholder="Коригування балів" class="form-control">
                    <input type="text" name="points_reason" placeholder="Причина" class="form-control">
                  </div>
                  <button type="submit" class="btn btn-primary">Зберегти</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

    {% elif section == 'catalogs' %}
      <!-- Управление каталогами -->
      <div class="catalogs-section">
        <div class="catalogs-grid">
          <div class="catalog-section">
            <h3>Категорії</h3>
            <div class="catalog-list">
              {% for category in categories %}
                <div class="catalog-item">
                  <div class="catalog-info">
                    <div class="catalog-name">{{ category.name }}</div>
                    <div class="catalog-description">{{ category.description|default:"Опис відсутній" }}</div>
                  </div>
                  <div class="catalog-actions">
                    <button class="btn btn-sm btn-outline-primary">Редагувати</button>
                    <button class="btn btn-sm btn-outline-danger">Видалити</button>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
          
          <div class="catalog-section">
            <h3>Товари</h3>
            <div class="catalog-list">
              {% for product in products %}
                <div class="catalog-item">
                  <div class="catalog-info">
                    <div class="catalog-name">{{ product.name }}</div>
                    <div class="catalog-description">{{ product.description|default:"Опис відсутній" }}</div>
                    <div class="catalog-price">{{ product.price }} грн</div>
                  </div>
                  <div class="catalog-actions">
                    <button class="btn btn-sm btn-outline-primary">Редагувати</button>
                    <button class="btn btn-sm btn-outline-danger">Видалити</button>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
// Функции для админ-панели
function filterOrders(status, payment) {
  const currentUrl = new URL(window.location);
  currentUrl.searchParams.set('section', 'orders');
  currentUrl.searchParams.set('status', status);
  currentUrl.searchParams.set('payment', payment);
  window.location.href = currentUrl.toString();
}

function updateOrderStatus(orderId, newStatus) {
  console.log('updateOrderStatus called with:', orderId, newStatus); // Отладка
  
  // Проверяем CSRF токен
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (!csrfToken) {
    console.error('CSRF token not found!');
    showNotification('Помилка: CSRF токен не знайдено', 'error');
    return;
  }
  console.log('CSRF token found:', csrfToken.value); // Отладка
  
  const statusText = {
    'new': 'В обробці',
    'prep': 'Готується до відправлення', 
    'ship': 'Відправлено',
    'done': 'Отримано',
    'cancelled': 'Скасовано'
  };
  
  // Если статус "Відправлено", запрашиваем ТТН
  if (newStatus === 'ship') {
    const ttn = prompt('Введіть номер ТТН Нової Пошти:');
    if (ttn === null) {
      // Пользователь отменил
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
      return;
    }
    if (!ttn.trim()) {
      showNotification('Помилка: Номер ТТН не може бути порожнім', 'error');
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
      return;
    }
    
    if (confirm(`Змінити статус замовлення на "${statusText[newStatus]}" з ТТН: ${ttn.trim()}?`)) {
      // Отправляем запрос с ТТН
      const formData = new FormData();
      formData.append('order_id', orderId);
      formData.append('status', newStatus);
      formData.append('tracking_number', ttn.trim());
      formData.append('csrfmiddlewaretoken', csrfToken.value);
      
      console.log('Sending request with TTN:', ttn.trim()); // Отладка
      
      fetch('{% url "admin_update_order_status" %}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        console.log('Response status:', response.status); // Отладка
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data); // Отладка
        if (data.success) {
          showNotification(data.message, 'success');
          // Обновляем селект в интерфейсе
          const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
          if (select) {
            select.value = newStatus;
          }
          // Обновляем отображение ТТН
          const ttnElement = document.querySelector(`[data-order-id="${orderId}"] .delivery-item[data-field="ttn"]`);
          if (ttnElement) {
            ttnElement.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/>
            </svg>
            <span>ТТН: ${ttn.trim()}</span>`;
          }
        } else {
          showNotification('Помилка: ' + data.error, 'error');
          // Возвращаем предыдущее значение
          const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
          if (select) {
            select.value = select.getAttribute('data-original-value');
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Помилка оновлення статусу', 'error');
        // Возвращаем предыдущее значение
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
        if (select) {
          select.value = select.getAttribute('data-original-value');
        }
      });
      return;
    } else {
      // Пользователь отменил
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
      return;
    }
  }
  
  if (confirm(`Змінити статус замовлення на "${statusText[newStatus]}"?`)) {
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('status', newStatus);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    console.log('Sending request to:', '{% url "admin_update_order_status" %}'); // Отладка
    console.log('FormData:', formData); // Отладка
    
    fetch('{% url "admin_update_order_status" %}', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      console.log('Response status:', response.status); // Отладка
      return response.json();
    })
    .then(data => {
      console.log('Response data:', data); // Отладка
      if (data.success) {
        showNotification(data.message, 'success');
        // Обновляем селект в интерфейсе
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
        if (select) {
          select.value = newStatus;
        }
      } else {
        showNotification('Помилка: ' + data.error, 'error');
        // Возвращаем предыдущее значение
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
        if (select) {
          select.value = select.getAttribute('data-original-value');
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка оновлення статусу', 'error');
      // Возвращаем предыдущее значение
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
    });
  } else {
    // Возвращаем предыдущее значение если пользователь отменил
    const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
    if (select) {
      select.value = select.getAttribute('data-original-value');
    }
  }
}

function updatePaymentStatus(orderId, newPaymentStatus) {
  const paymentStatusText = {
    'unpaid': 'Не оплачено',
    'checking': 'На перевірці',
    'partial': 'Внесена передплата',
    'paid': 'Оплачено повністю'
  };
  
  if (confirm(`Змінити статус оплати на "${paymentStatusText[newPaymentStatus]}"?`)) {
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('payment_status', newPaymentStatus);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "admin_update_payment_status" %}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        // Обновляем селект в интерфейсе
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updatePaymentStatus"]`);
        if (select) {
          select.value = newPaymentStatus;
        }
      } else {
        showNotification('Помилка: ' + data.error, 'error');
        // Возвращаем предыдущее значение
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updatePaymentStatus"]`);
        if (select) {
          select.value = select.getAttribute('data-original-value');
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка оновлення статусу оплати', 'error');
      // Возвращаем предыдущее значение
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updatePaymentStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
    });
  } else {
    // Возвращаем предыдущее значение если пользователь отменил
    const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updatePaymentStatus"]`);
    if (select) {
      select.value = select.getAttribute('data-original-value');
    }
  }
}

function copyOrderNumber(orderNumber) {
  navigator.clipboard.writeText(orderNumber).then(function() {
    showNotification('Номер замовлення скопійовано!', 'success');
  }).catch(function(err) {
    console.error('Ошибка копирования:', err);
    showNotification('Помилка копіювання', 'error');
  });
}

function approvePayment(orderId) {
  if (confirm('Підтвердити оплату для цього замовлення?')) {
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('action', 'approve');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "admin_approve_payment" %}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        // Обновляем статус в интерфейсе
        const statusSelect = document.querySelector(`[data-order-id="${orderId}"] .status-select[onchange*="updatePaymentStatus"]`);
        if (statusSelect) {
          statusSelect.value = data.new_status;
        }
        // Скрываем секцию скриншота
        const screenshotSection = document.querySelector(`[data-order-id="${orderId}"] .payment-screenshot-section`);
        if (screenshotSection) {
          screenshotSection.style.display = 'none';
        }
      } else {
        showNotification('Помилка: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка підтвердження оплати', 'error');
    });
  }
}

function rejectPayment(orderId) {
  if (confirm('Відхилити оплату для цього замовлення?')) {
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('action', 'reject');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "admin_approve_payment" %}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        // Обновляем статус в интерфейсе
        const statusSelect = document.querySelector(`[data-order-id="${orderId}"] .status-select[onchange*="updatePaymentStatus"]`);
        if (statusSelect) {
          statusSelect.value = data.new_status;
        }
        // Скрываем секцию скриншота
        const screenshotSection = document.querySelector(`[data-order-id="${orderId}"] .payment-screenshot-section`);
        if (screenshotSection) {
          screenshotSection.style.display = 'none';
        }
      } else {
        showNotification('Помилка: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка відхилення оплати', 'error');
    });
  }
}

function testAjax() {
  console.log('Testing AJAX...');
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (!csrfToken) {
    console.error('CSRF token not found!');
    alert('CSRF токен не знайдено!');
    return;
  }
  
  const formData = new FormData();
  formData.append('csrfmiddlewaretoken', csrfToken.value);
  
  fetch('{% url "test_ajax" %}', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    alert(`AJAX тест: ${data.message}\nКористувач: ${data.user}\nStaff: ${data.is_staff}`);
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Помилка AJAX: ' + error.message);
  });
}

function toggleScreenshot(orderId) {
  const content = document.getElementById(`screenshot-${orderId}`);
  const header = content.previousElementSibling;
  const toggleIcon = header.querySelector('.toggle-icon');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggleIcon.style.transform = 'rotate(180deg)';
  } else {
    content.style.display = 'none';
    toggleIcon.style.transform = 'rotate(0deg)';
  }
}

function showNotification(message, type) {
  // Создаем уведомление
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;
  
  // Добавляем в DOM
  document.body.appendChild(notification);
  
  // Показываем с анимацией
  setTimeout(() => {
    notification.classList.add('show');
  }, 100);
  
  // Удаляем через 3 секунды
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}
</script>

{% endblock %}
