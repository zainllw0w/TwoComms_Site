{% extends 'base.html' %}
{% load static %}

{% block title %}Адмін-панель — TwoComms{% endblock %}

{% block extra_css %}
<style>
  .order-actions-inline {
    margin-left: auto;
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }

  .order-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    border: 1px solid transparent;
    background: rgba(239, 68, 68, 0.12);
    color: #f87171;
    font-size: 0.875rem;
    transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
  }

  .order-action-btn.danger:hover {
    background: rgba(239, 68, 68, 0.22);
    color: #fca5a5;
    transform: translateY(-1px);
  }

  .order-action-btn svg {
    flex-shrink: 0;
  }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="admin-panel">
  <!-- Заголовок админ-панели -->
        <div class="admin-header">
        <div class="admin-header-content">
          <h1 class="admin-title">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            Адмін-панель
          </h1>
      <div class="admin-nav">
        <a href="?section=stats" class="admin-nav-item {% if section == 'stats' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
          </svg>
          Статистика
        </a>
        <a href="?section=orders" class="admin-nav-item {% if section == 'orders' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          Замовлення
        </a>
        <a href="?section=users" class="admin-nav-item {% if section == 'users' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-1.7 2.26V15h-1.5v-6h1.5v1.5l1.7-2.26c.47-.63 1.21-1 2.01-1h1.54c.8 0 1.54.37 2.01 1L21.5 15H20v6h2zM12.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6.5h1.5V22h4z"/>
          </svg>
          Користувачі
        </a>
        <a href="?section=catalogs" class="admin-nav-item {% if section == 'catalogs' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          Каталоги
        </a>
        <a href="?section=promocodes" class="admin-nav-item {% if section == 'promocodes' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          Промокоди
        </a>
        <a href="?section=offline_stores" class="admin-nav-item {% if section == 'offline_stores' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          Оффлайн магазини
        </a>
        <a href="?section=print_proposals" class="admin-nav-item {% if section == 'print_proposals' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 15v4H5v-4H3v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4h-2zM11 8.414V20h2V8.414l3.293 3.293 1.414-1.414L12 4.586 6.293 10.293l1.414 1.414L11 8.414z"/>
          </svg>
          Запропоновані принти
        </a>
        <a href="?section=collaboration" class="admin-nav-item {% if section == 'collaboration' %}active{% endif %}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a5 5 0 015 5v1h1a4 4 0 110 8h-1v1a5 5 0 11-10 0v-1H6a4 4 0 110-8h1V7a5 5 0 015-5z"/>
          </svg>
          Співпраця
        </a>
    </div>
  </div>
  </div>

  <!-- Контент секции -->
  <div class="admin-content">
    {% if section == 'stats' %}
      <!-- Статистика -->
      <div class="stats-section">
        <!-- Фильтры по времени -->
        <div class="stats-filters">
          <div class="stats-filters-header">
            <h3 class="stats-filters-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              Період: {{ stats.period_name }}
            </h3>
            <div class="stats-period-buttons">
              <a href="?section=stats&period=today" class="period-btn {% if stats.period == 'today' %}active{% endif %}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                Сьогодні
              </a>
              <a href="?section=stats&period=week" class="period-btn {% if stats.period == 'week' %}active{% endif %}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                Тиждень
              </a>
              <a href="?section=stats&period=month" class="period-btn {% if stats.period == 'month' %}active{% endif %}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                Місяць
              </a>
              <a href="?section=stats&period=all_time" class="period-btn {% if stats.period == 'all_time' %}active{% endif %}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Весь час
              </a>
            </div>
          </div>
        </div>
        <!-- Сайт статистика -->
        <div class="stats-category">
          <h2 class="stats-category-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            Сайт
          </h2>
          <div class="stats-grid">
            <div class="stat-card working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.online_users|default:0 }}</div>
                <div class="stat-label">Онлайн зараз</div>
              </div>
            </div>
            
            <div class="stat-card working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-1.7 2.26V15h-1.5v-6h1.5v1.5l1.7-2.26c.47-.63 1.21-1 2.01-1h1.54c.8 0 1.54.37 2.01 1L21.5 15H20v6h2z"/></svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.sessions_period|default:0 }}</div>
                <div class="stat-label">Унікальних за {{ stats.period_name|lower }}</div>
              </div>
            </div>
            
            <div class="stat-card working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.page_views_period|default:0 }}</div>
                <div class="stat-label">Переглядів за {{ stats.period_name|lower }}</div>
              </div>
            </div>
            
            <div class="stat-card working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.bounce_rate|default:0 }}%</div>
                <div class="stat-label">Показник відмов</div>
              </div>
            </div>
            
            <div class="stat-card working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M13 7h8v2h-8zm0 4h8v2h-8zm0 4h8v2h-8zM3 17h6v2H3zm0-4h6v2H3zm0-4h6v2H3z"/></svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.avg_session_duration|default:0 }}с</div>
                <div class="stat-label">Середня тривалість сесії</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.new_users_today|default:0 }}</div>
                <div class="stat-label">Нових користувачів за {{ stats.period_name|lower }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Продажи статистика -->
        <div class="stats-category">
          <h2 class="stats-category-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
            Продажі
          </h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.orders_count|default:0 }}</div>
                <div class="stat-label">Замовлень за {{ stats.period_name|lower }}</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.revenue_today|default:0 }} грн</div>
                <div class="stat-label">Виручка за {{ stats.period_name|lower }}</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.avg_order_value|default:0 }} грн</div>
                <div class="stat-label">Середній чек</div>
              </div>
            </div>
            
            <div class="stat-card not-working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-1.7 2.26V15h-1.5v-6h1.5v1.5l1.7-2.26c.47-.63 1.21-1 2.01-1h1.54c.8 0 1.54.37 2.01 1L21.5 15H20v6h2z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.conversion_rate|default:0 }}%</div>
                <div class="stat-label">Конверсія <span class="not-working-badge">Не працює</span></div>
              </div>
            </div>
            
            <div class="stat-card not-working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M13 7h8v2h-8zm0 4h8v2h-8zm0 4h8v2h-8zM3 17h6v2H3zm0-4h6v2H3zm0-4h6v2H3z"/></svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.products_sold_today|default:0 }}</div>
                <div class="stat-label">Товарів продано <span class="not-working-badge">Не працює</span></div>
              </div>
            </div>
            
            <div class="stat-card not-working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.abandoned_carts|default:0 }}</div>
                <div class="stat-label">Покинутих кошиків <span class="not-working-badge">Не працює</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Користувачі статистика -->
        <div class="stats-category">
          <h2 class="stats-category-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-1.7 2.26V15h-1.5v-6h1.5v1.5l1.7-2.26c.47-.63 1.21-1 2.01-1h1.54c.8 0 1.54.37 2.01 1L21.5 15H20v6h2z"/>
            </svg>
            Користувачі
          </h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-1.7 2.26V15h-1.5v-6h1.5v1.5l1.7-2.26c.47-.63 1.21-1 2.01-1h1.54c.8 0 1.54.37 2.01 1L21.5 15H20v6h2z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.total_users|default:0 }}</div>
                <div class="stat-label">Всього користувачів</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.active_users_period|default:0 }}</div>
                <div class="stat-label">Активних за {{ stats.period_name|lower }}</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.registered_today|default:0 }}</div>
                <div class="stat-label">Зареєстровано сьогодні</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.users_with_points|default:0 }}</div>
                <div class="stat-label">З нарахованими балами</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M13 7h8v2h-8zm0 4h8v2h-8zm0 4h8v2h-8zM3 17h6v2H3zm0-4h6v2H3zm0-4h6v2H3z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.total_points_earned|default:0 }}</div>
                <div class="stat-label">Всього балів нараховано</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.promocodes_used_today|default:0 }}</div>
                <div class="stat-label">Промокодів використано</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Контент статистика -->
        <div class="stats-category">
          <h2 class="stats-category-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
            </svg>
            Контент
          </h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.total_products|default:0 }}</div>
                <div class="stat-label">Всього товарів</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.total_categories|default:0 }}</div>
                <div class="stat-label">Категорій</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 15v4H5v-4H3v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4h-2zM11 8.414V20h2V8.414l3.293 3.293 1.414-1.414L12 4.586 6.293 10.293l1.414 1.414L11 8.414z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.print_proposals_pending|default:0 }}</div>
                <div class="stat-label">Принтів на розгляді</div>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.favorites_count|default:0 }}</div>
                <div class="stat-label">В обраному</div>
              </div>
            </div>
            
            <div class="stat-card not-working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M13 7h8v2h-8zm0 4h8v2h-8zm0 4h8v2h-8zM3 17h6v2H3zm0-4h6v2H3zm0-4h6v2H3z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.reviews_count|default:0 }}</div>
                <div class="stat-label">Відгуків <span class="not-working-badge">Не працює</span></div>
              </div>
            </div>
            
            <div class="stat-card not-working">
              <div class="stat-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ stats.avg_rating|default:0 }}/5</div>
                <div class="stat-label">Середня оцінка <span class="not-working-badge">Не працює</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

    {% elif section == 'orders' %}
      <!-- Управление заказами -->
      <div class="orders-admin-section">
        <!-- Заголовок с информацией о фильтрации -->
        {% if user_id_filter %}
          <div class="user-filter-info">
            <div class="user-filter-header">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <span>
                {% if user_filter_info %}
                  Замовлення користувача: {{ user_filter_info.username }} {% if user_filter_info.full_name %}({{ user_filter_info.full_name }}){% endif %}
                    {% else %}
                  Замовлення користувача ID: {{ user_id_filter }}
                    {% endif %}
              </span>
              <a href="?section=orders" class="clear-user-filter">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
                Показати всі замовлення
              </a>
                  </div>
          </div>
        {% endif %}
        
        <!-- Фильтры и статистика -->
        <div class="orders-filters">
          <div class="filter-stats">
            <!-- Статусы заказов с счетчиками -->
            <div class="filter-stat-item status-all" onclick="filterOrders('all', 'all')">
              <div class="filter-stat-number">{{ total_orders|default:0 }}</div>
              <div class="filter-stat-label">Всі замовлення</div>
            </div>
            <div class="filter-stat-item status-new" onclick="filterOrders('new', 'all')">
              <div class="filter-stat-number">{{ status_counts.new|default:0 }}</div>
              <div class="filter-stat-label">В обробці</div>
            </div>
            <div class="filter-stat-item status-prep" onclick="filterOrders('prep', 'all')">
              <div class="filter-stat-number">{{ status_counts.prep|default:0 }}</div>
              <div class="filter-stat-label">Готується до відправлення</div>
            </div>
            <div class="filter-stat-item status-ship" onclick="filterOrders('ship', 'all')">
              <div class="filter-stat-number">{{ status_counts.ship|default:0 }}</div>
              <div class="filter-stat-label">Відправлено</div>
            </div>
            <div class="filter-stat-item status-done" onclick="filterOrders('done', 'all')">
              <div class="filter-stat-number">{{ status_counts.done|default:0 }}</div>
              <div class="filter-stat-label">Отримано</div>
            </div>
            <div class="filter-stat-item status-cancelled" onclick="filterOrders('cancelled', 'all')">
              <div class="filter-stat-number">{{ status_counts.cancelled|default:0 }}</div>
              <div class="filter-stat-label">Скасовано</div>
            </div>
          </div>
          
          <!-- Статусы оплаты с счетчиками -->
          <div class="filter-stats payment-stats">
            <div class="filter-stat-item payment-unpaid" onclick="filterOrders('all', 'unpaid')">
              <div class="filter-stat-number">{{ payment_status_counts.unpaid|default:0 }}</div>
              <div class="filter-stat-label">Не оплачено</div>
            </div>
            <div class="filter-stat-item payment-checking" onclick="filterOrders('all', 'checking')">
              <div class="filter-stat-number">{{ payment_status_counts.checking|default:0 }}</div>
              <div class="filter-stat-label">На перевірці</div>
            </div>
            <div class="filter-stat-item payment-partial" onclick="filterOrders('all', 'partial')">
              <div class="filter-stat-number">{{ payment_status_counts.partial|default:0 }}</div>
              <div class="filter-stat-label">Частково оплачено</div>
            </div>
            <div class="filter-stat-item payment-paid" onclick="filterOrders('all', 'paid')">
              <div class="filter-stat-number">{{ payment_status_counts.paid|default:0 }}</div>
              <div class="filter-stat-label">Оплачено</div>
            </div>
          </div>
          
          <div class="filter-controls">
            <select class="filter-select" onchange="filterOrders(this.value, '{{ payment_filter }}')">
              <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Всі статуси</option>
              <option value="new" {% if status_filter == 'new' %}selected{% endif %}>В обробці</option>
              <option value="prep" {% if status_filter == 'prep' %}selected{% endif %}>Готується до відправлення</option>
              <option value="ship" {% if status_filter == 'ship' %}selected{% endif %}>Відправлено</option>
              <option value="done" {% if status_filter == 'done' %}selected{% endif %}>Отримано</option>
              <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Скасовано</option>
            </select>
            
            <select class="filter-select" onchange="filterOrders('{{ status_filter }}', this.value)">
              <option value="all" {% if payment_filter == 'all' %}selected{% endif %}>Всі оплати</option>
              <option value="unpaid" {% if payment_filter == 'unpaid' %}selected{% endif %}>Не оплачено</option>
              <option value="checking" {% if payment_filter == 'checking' %}selected{% endif %}>На перевірці</option>
              <option value="partial" {% if payment_filter == 'partial' %}selected{% endif %}>Внесена передплата</option>
              <option value="paid" {% if payment_filter == 'paid' %}selected{% endif %}>Оплачено повністю</option>
            </select>
          </div>
        </div>

        <!-- Список заказов -->
        <div class="orders-list">
          {% for o in orders %}
            <div class="admin-order-card" data-order-id="{{ o.id }}">
              <!-- Анимация искр -->
              <div class="order-sparks">
                <div class="order-spark order-spark-1"></div>
                <div class="order-spark order-spark-2"></div>
                <div class="order-spark order-spark-3"></div>
              </div>
              
              <!-- Заголовок заказа -->
              <div class="order-header">
                <div class="order-header-row">
                  <div class="order-number-container">
                    <button class="order-number-btn" onclick="copyOrderNumber('{{ o.order_number }}')" data-order-number="{{ o.order_number }}">
                      <div class="order-number-glow"></div>
                      <div class="order-number-content">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <span class="order-number-text">#{{ o.order_number }}</span>
                        <svg class="copy-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                      </div>
                    </button>
                  </div>
                  
                  <div class="order-customer-info">
                    <div class="customer-details">
                      <div class="customer-name">{{ o.full_name }}</div>
                      <div class="customer-phone">{{ o.phone }}</div>
                      <div class="customer-email">{{ o.user.email|default:"Гість" }}</div>
                    </div>
                    <div class="order-date-info">
                      <div class="order-date">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                        </svg>
                        {{ o.created|date:"d.m.Y о H:i" }}
                      </div>
                    </div>
                    <div class="order-actions-inline">
                      <form method="post" action="{% url 'admin_order_delete' o.id %}" data-order-delete-form data-order-id="{{ o.id }}" data-order-number="{{ o.order_number }}">
                        {% csrf_token %}
                        <button type="submit" class="order-action-btn danger" title="Видалити замовлення">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                          </svg>
                          <span>Видалити</span>
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Компактная информация о доставке -->
              <div class="order-delivery-compact">
                <div class="delivery-compact-item">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                  </svg>
                  <span>{{ o.city }}, {{ o.np_office }}</span>
                </div>
                <div class="delivery-item" data-field="ttn">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/>
                  </svg>
                  <span class="ttn-info">
                    {% if o.tracking_number %}
                      {{ o.tracking_number }}
                    {% else %}
                      <span class="ttn-pending">ТТН очікується</span>
                    {% endif %}
                  </span>
                </div>
              </div>

              <!-- Сумма заказа -->
              <div class="order-total-section">
                <div class="order-total-card">
                  <div class="total-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                  </div>
                  <div class="total-content">
                    <div class="total-label">Сума замовлення</div>
                    <div class="total-amount">{{ o.total_sum }} грн</div>
                  </div>
        </div>
      </div>

              {% if o.payment_provider %}
              <div class="payment-meta-card">
                <div class="payment-meta-header">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-.88 14.88-3.76-3.77 1.41-1.41 2.35 2.36 5.29-5.29 1.41 1.41-6.7 6.7z"/>
                  </svg>
                  <span>Оплата</span>
                </div>
                <div class="payment-meta-grid">
                  <div class="info-item">
                    <span class="info-label">Сервіс:</span>
                    <span class="info-value">{{ o.payment_provider|capfirst }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Invoice ID:</span>
                    <span class="info-value">{{ o.payment_invoice_id|default:'—' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Статус Monobank:</span>
                    <span class="info-value">{{ o.payment_payload.last_status|default:'немає даних' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Оновлено:</span>
                    <span class="info-value">
                      {% if o.payment_payload.last_update_at %}
                        {{ o.payment_payload.last_update_at|date:"d.m.Y H:i" }}
                      {% else %}
                        —
                      {% endif %}
                    </span>
                  </div>
                </div>
                {% if o.payment_payload.history %}
                <div class="payment-history">
                  {% for entry in o.payment_payload.history|slice:":5" %}
                    <div class="payment-history-item">
                      <span class="history-status">{{ entry.status|default:'—' }}</span>
                      <span class="history-time">
                        {% if entry.received_at %}
                          {{ entry.received_at|date:"d.m.Y H:i" }}
                        {% else %}
                          —
                        {% endif %}
                      </span>
                      {% if entry.data.modifiedDate %}
                        <span class="history-modified">{{ entry.data.modifiedDate }}</span>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              {% endif %}

              <!-- Этапы статуса заказа (кликабельные для админа) -->
              <div class="order-status-track admin-status-track">
                <div class="status-step {% if o.status == 'new' %}active{% elif o.status in 'prep,ship,done' %}completed{% endif %}" onclick="updateOrderStatus('{{ o.id }}', 'new')">
                  <div class="status-step-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                  </div>
                  <div class="status-step-label">В обробці</div>
                </div>
                
                <div class="status-connector {% if o.status in 'prep,ship,done' %}completed{% endif %}"></div>
                
                <div class="status-step {% if o.status == 'prep' %}active{% elif o.status in 'ship,done' %}completed{% endif %}" onclick="updateOrderStatus('{{ o.id }}', 'prep')">
                  <div class="status-step-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                    </svg>
                  </div>
                  <div class="status-step-label">Готується</div>
                </div>
                
                <div class="status-connector {% if o.status in 'ship,done' %}completed{% endif %}"></div>
                
                <div class="status-step {% if o.status == 'ship' %}active{% elif o.status == 'done' %}completed{% endif %}" onclick="updateOrderStatus('{{ o.id }}', 'ship')">
                  <div class="status-step-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                    </svg>
                  </div>
                  <div class="status-step-label">Відправлено</div>
                </div>
                
                <div class="status-connector {% if o.status == 'done' %}completed{% endif %}"></div>
                
                <div class="status-step {% if o.status == 'done' %}active{% endif %}" onclick="updateOrderStatus('{{ o.id }}', 'done')">
                  <div class="status-step-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
        </div>
                  <div class="status-step-label">Отримано</div>
        </div>
      </div>

              <!-- Статус оплаты (селект) -->
              <div class="order-payment-status">
                <div class="payment-status-header">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  <span>Статус оплати</span>
                </div>
                <select class="payment-status-select" onchange="updatePaymentStatus('{{ o.id }}', this.value)" data-original-value="{{ o.payment_status }}">
                  <option value="unpaid" {% if o.payment_status == 'unpaid' %}selected{% endif %}>Не оплачено</option>
                  <option value="checking" {% if o.payment_status == 'checking' %}selected{% endif %}>На перевірці</option>
                  <option value="partial" {% if o.payment_status == 'partial' %}selected{% endif %}>Внесена передплата</option>
                  <option value="paid" {% if o.payment_status == 'paid' %}selected{% endif %}>Оплачено повністю</option>
                </select>
              </div>

              <!-- Скриншот оплаты (сворачиваемый) -->
              {% if o.payment_screenshot %}
                <div class="payment-screenshot-collapsible">
                  <div class="screenshot-header" onclick="toggleScreenshot('{{ o.id }}')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                    <span>Скріншот оплати</span>
                    {% if o.payment_status == 'checking' %}
                      <span class="screenshot-status checking">Очікує перевірки</span>
                    {% elif o.payment_status == 'paid' %}
                      <span class="screenshot-status approved">Підтверджено</span>
                    {% elif o.payment_status == 'partial' %}
                      <span class="screenshot-status partial">Часткова оплата</span>
                    {% else %}
                      <span class="screenshot-status unpaid">Не оплачено</span>
                    {% endif %}
                    <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M7 10l5 5 5-5z"/>
                    </svg>
                  </div>
                  <div class="screenshot-content" id="screenshot-{{ o.id }}" style="display: none;">
                    <div class="screenshot-container">
                      <img src="{{ o.payment_screenshot.url }}" alt="Скріншот оплати" class="payment-screenshot">
                      {% if o.payment_status == 'checking' %}
                        <div class="screenshot-actions">
                          <button class="btn-approve" onclick="approvePayment('{{ o.id }}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                            </svg>
                            Підтвердити оплату
                          </button>
                          <button class="btn-reject" onclick="rejectPayment('{{ o.id }}')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                            Відхилити оплату
                          </button>
                        </div>
                      {% else %}
                        <div class="screenshot-info">
                          <div class="info-item">
                            <span class="info-label">Статус:</span>
                            <span class="info-value">
                              {% if o.payment_status == 'paid' %}
                                Оплачено повністю
                              {% elif o.payment_status == 'partial' %}
                                Внесена передплата
                              {% else %}
                                Не оплачено
                              {% endif %}
                            </span>
                          </div>
                          <div class="info-item">
                            <span class="info-label">Завантажено:</span>
                            <span class="info-value">{{ o.created|date:"d.m.Y о H:i" }}</span>
                          </div>
                        </div>
                      {% endif %}
        </div>
                  </div>
                </div>
              {% endif %}

              <!-- Товары в заказе -->
              <div class="order-items-section">
                <div class="order-items-header">
                  <div class="order-items-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    Товари в замовленні ({{ o.items.count }})
        </div>
      </div>
                
                <div class="order-items-list">
                  {% for item in o.items.all %}
                    <div class="order-item-card">
                      <div class="order-item-image">
                        {% with img=item.product_image %}
                          {% if img %}
                            <img src="{{ img.url }}" alt="{{ item.product.title }}" class="order-item-img">
                          {% else %}
                            <div class="order-item-placeholder">
                              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5л3.5-4.5з"/>
                              </svg>
                            </div>
                          {% endif %}
                        {% endwith %}
                      </div>
                      
                      <div class="order-item-content">
                        <div class="order-item-main">
                          <div class="order-item-title">{{ item.product.title }}</div>
                          <div class="order-item-specs">
                            {% if item.size %}
                            <div class="order-item-spec">
                              <span class="spec-label">Розмір:</span>
                              <span class="spec-value">{{ item.size }}</span>
                            </div>
                            {% endif %}
                            <div class="order-item-spec">
                              <span class="spec-label">Кількість:</span>
                              <span class="spec-value">{{ item.qty }} шт</span>
                            </div>
                            {% if item.color_name %}
                            <div class="order-item-spec">
                              <span class="spec-label">Колір:</span>
                              <span class="spec-value">{{ item.color_name }}</span>
                            </div>
                            {% endif %}
                          </div>
                        </div>
                        
                        <div class="order-item-price">
                          <div class="price-item">
                            <span class="price-label">Ціна за шт:</span>
                            <span class="price-value">{{ item.unit_price }} грн</span>
                          </div>
                          <div class="price-item total">
                            <span class="price-label">Всього:</span>
                            <span class="price-value">{{ item.line_total }} грн</span>
                          </div>
                        </div>
                      </div>
                    </div>
              {% endfor %}
        </div>
      </div>
        </div>
              {% empty %}
            <div class="orders-empty">
              <div class="orders-empty-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
              </div>
              <h2 class="orders-empty-title">Замовлень не знайдено</h2>
              <p class="orders-empty-text">Спробуйте змінити фільтри</p>
            </div>
              {% endfor %}
        </div>
      </div>

    {% elif section == 'users' %}
      <!-- Управление пользователями -->
      <div class="users-admin-section">
        <!-- Заголовок секции -->
        <div class="section-header">
          <div class="section-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01 1l-1.7 2.26V15h-1.5v-6h1.5v1.5l1.7-2.26c.47-.63 1.21-1 2.01-1h1.54c.8 0 1.54.37 2.01 1L21.5 15H20v6h2z"/>
            </svg>
        </div>
          <h2 class="section-title">Управління користувачами</h2>
          
          <!-- Поиск по пользователям -->
          <div class="users-search-section">
            <div class="search-container">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="search-icon">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
              <input type="text" 
                     id="users-search" 
                     class="users-search-input" 
                     placeholder="Пошук за ім'ям або логіном..."
                     oninput="filterUsers(this.value)"
                     onkeyup="if(this.value === '') filterUsers('')">
              <button type="button" 
                      class="search-clear-btn" 
                      onclick="clearUserSearch()"
                      title="Очистити пошук">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
              </button>
                  </div>
          </div>
          
          <div class="section-stats">
            <div class="stat-badge">
              <span class="stat-number" id="users-count">{{ user_data|length }}</span>
              <span class="stat-label">Користувачів</span>
            </div>
          </div>
        </div>

        <!-- Список пользователей -->
        <div class="users-grid">
          {% for user in user_data %}
            <div class="user-card" data-user-id="{{ user.user.id }}">
              <!-- Анимация искр -->
              <div class="user-sparks">
                <div class="user-spark user-spark-1"></div>
                <div class="user-spark user-spark-2"></div>
                <div class="user-spark user-spark-3"></div>
              </div>

                <!-- Основная информация о пользователе -->
                <div class="user-header">
                  <div class="user-avatar-section">
                    <div class="user-avatar">
                      {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" alt="{{ user.user.username }}" class="avatar-image">
                      {% else %}
                        <div class="default-avatar">
                          <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                          </svg>
                        </div>
                      {% endif %}
                      <div class="user-status-badge {% if user.user.is_superuser %}superuser{% elif user.user.is_staff %}staff{% else %}user{% endif %}">
                        {% if user.user.is_superuser %}
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                          </svg>
                        {% elif user.user.is_staff %}
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                          </svg>
                        {% else %}
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                          </svg>
                        {% endif %}
                      </div>
                    </div>
                    
                    <div class="user-info-main">
                      <div class="user-name">{{ user.user.username }}</div>
                      <div class="user-email">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                        {{ user.user.email|default:"Email не вказано" }}
                      </div>
                      {% if user.profile.phone %}
                        <div class="user-phone">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                          </svg>
                          {{ user.profile.phone }}
                        </div>
                      {% endif %}
                      {% if user.profile.full_name %}
                        <div class="user-full-name">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                          </svg>
                          {{ user.profile.full_name }}
                        </div>
                      {% endif %}
                      
                      {% if user.profile.telegram %}
                        <div class="user-telegram">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-.86.2-1.3l15.97-6.16c.73-.33 1.43.18 1.15 1.3l-2.72 12.81c-.19.91-.74 1.13-1.5.71L12.6 16.3l-1.99 1.93c-.23.23-.42.42-.83.42z"/>
                          </svg>
                          {{ user.profile.telegram }}
                        </div>
                      {% endif %}
                      
                      {% if user.profile.instagram %}
                        <div class="user-instagram">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                          </svg>
                          {{ user.profile.instagram }}
                        </div>
                      {% endif %}
                      
                      <!-- УБД статус -->
                      <div class="user-ubd-status">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        {% if user.profile.is_ubd %}
                          <span class="ubd-status">УБД</span>
                        {% else %}
                          Не УБД
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Статистика пользователя (компактная) -->
                <div class="user-stats-compact">
                  <div class="stat-item-compact">
                    <div class="stat-icon-compact">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7V9h10v2zm0-4H7V7h10v2z"/>
                      </svg>
                    </div>
                    <div class="stat-content-compact">
                                              <div class="stat-value-compact">{{ user.total_orders }}</div>
                      <div class="stat-label-compact">Замовлень</div>
                    </div>
                  </div>
                  
                  <div class="stat-item-compact">
                    <div class="stat-icon-compact">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                      </svg>
                    </div>
                    <div class="stat-content-compact">
                                              <div class="stat-value-compact">{{ user.total_spent|floatformat:0 }}</div>
                      <div class="stat-label-compact">грн (всі платежі)</div>
                    </div>
                  </div>
                  
                  <div class="stat-item-compact">
                    <div class="stat-icon-compact">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                    </div>
                    <div class="stat-content-compact">
                                              <div class="stat-value-compact">{{ user.points.points|default:0 }}</div>
                      <div class="stat-label-compact">Балів зараз</div>
                    </div>
                  </div>
                  
                  <div class="stat-item-compact">
                    <div class="stat-icon-compact">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                      </svg>
                    </div>
                    <div class="stat-content-compact">
                                              <div class="stat-value-compact">{{ user.points_spent|default:0 }}</div>
                      <div class="stat-label-compact">Балів витрачено</div>
                    </div>
                  </div>
                </div>
                
                <!-- Управління балами -->
                <div class="points-control-section">
                  <div class="section-header">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <h4>Управління балами</h4>
                  </div>
                  
                  <div class="points-display">
                    <div class="points-display-icon">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                    </div>
                    <div class="points-display-content">
                                              <div class="points-display-value">{{ user.points.points|default:0 }}</div>
                      <div class="points-display-label">Поточні бали</div>
                    </div>
                  </div>
                  
                  <form method="POST" action="{% url 'admin_update_user' %}" class="points-form">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" value="{{ user.user.id }}">
                    <div class="points-input-group">
                      <label for="points_adjustment">Змінити бали:</label>
                      <div class="points-input-wrapper">
                        <input type="number" name="points_adjustment" id="points_adjustment" 
                               class="points-input" placeholder="+100 або -50" required>
                        <input type="text" name="points_reason" 
                               placeholder="Причина коригування" 
                               class="reason-input">
                      </div>
                    </div>
                    
                    <button type="submit" class="save-btn points-save-btn">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                      </svg>
                      Зберегти зміни
                    </button>
                  </form>
                </div>

              <!-- Детальная информация -->
              <div class="user-details-expanded">
                <!-- Статусы заказов -->
                <div class="orders-status-section">
                  <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7V9h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    Статуси замовлень
                  </h4>
                  <div class="status-grid">
                    <div class="status-item new clickable" onclick="filterUserOrders('{{ user.user.id }}', 'status', 'new')" data-user-id="{{ user.user.id }}" data-status="new">
                      <div class="status-number">{{ user.order_status_counts.new|default:0 }}</div>
                      <div class="status-label">В обробці</div>
                    </div>
                    <div class="status-item prep clickable" onclick="filterUserOrders('{{ user.user.id }}', 'status', 'prep')">
                      <div class="status-number">{{ user.order_status_counts.prep|default:0 }}</div>
                      <div class="status-label">Готується</div>
                    </div>
                    <div class="status-item ship clickable" onclick="filterUserOrders('{{ user.user.id }}', 'status', 'ship')">
                      <div class="status-number">{{ user.order_status_counts.ship|default:0 }}</div>
                      <div class="status-label">Відправлено</div>
                    </div>
                    <div class="status-item done clickable" onclick="filterUserOrders('{{ user.user.id }}', 'status', 'done')">
                      <div class="status-number">{{ user.order_status_counts.done|default:0 }}</div>
                      <div class="status-label">Отримано</div>
                    </div>
                    <div class="status-item cancelled clickable" onclick="filterUserOrders('{{ user.user.id }}', 'status', 'cancelled')">
                      <div class="status-number">{{ user.order_status_counts.cancelled|default:0 }}</div>
                      <div class="status-label">Скасовано</div>
                    </div>
                  </div>
                </div>

                <!-- Статусы оплаты -->
                <div class="payment-status-section">
                  <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Статуси оплати
                  </h4>
                  <div class="payment-grid">
                    <div class="payment-item unpaid clickable" onclick="filterUserOrders('{{ user.user.id }}', 'payment_status', 'unpaid')">
                      <div class="payment-number">{{ user.payment_status_counts.unpaid|default:0 }}</div>
                      <div class="payment-label">Не оплачено</div>
                    </div>
                    <div class="payment-item checking clickable" onclick="filterUserOrders('{{ user.user.id }}', 'status', 'checking')">
                      <div class="payment-number">{{ user.payment_status_counts.checking|default:0 }}</div>
                      <div class="payment-label">На перевірці</div>
                    </div>
                    <div class="payment-item partial clickable" onclick="filterUserOrders('{{ user.user.id }}', 'payment_status', 'partial')">
                      <div class="payment-number">{{ user.payment_status_counts.partial|default:0 }}</div>
                      <div class="payment-label">Частково</div>
                    </div>
                    <div class="payment-item paid clickable" onclick="filterUserOrders('{{ user.user.id }}', 'payment_status', 'paid')">
                      <div class="payment-number">{{ user.payment_status_counts.paid|default:0 }}</div>
                      <div class="payment-label">Оплачено</div>
                    </div>
                  </div>
                </div>

                <!-- Промокоды -->
                <div class="promocodes-section">
                  <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
                    </svg>
                    Промокоди ({{ user.promocodes|length|default:0 }})
                  </h4>
                  
                  <!-- Выданные промокоды -->
                  {% if user.promocodes %}
                    <div class="promocodes-subsection">
                      <h5>Видані промокоди</h5>
                      <div class="promocodes-grid">
                        {% for promocode in user.promocodes %}
                          <div class="promocode-item">
                            <div class="promocode-code">{{ promocode.code }}</div>
                            <div class="promocode-discount">{{ promocode.discount }}% знижка</div>
                            <div class="promocode-status {% if promocode.is_used %}used{% else %}active{% endif %}">
                              {% if promocode.is_used %}Використано{% else %}Активний{% endif %}
                            </div>
                            <div class="promocode-actions">
                              <button class="promocode-btn remove" data-action="remove-promocode" data-id="{{ promocode.id }}">
                                Видалити
                              </button>
                            </div>
                          </div>
              {% endfor %}
        </div>
      </div>
                  {% endif %}
                  
                  <!-- Использованные промокоды -->
                  {% if user.used_promocodes %}
                    <div class="promocodes-subsection">
                      <h5>Використані промокоди</h5>
                      <div class="promocodes-grid">
                        {% for promocode in user.used_promocodes %}
                          <div class="promocode-item used">
                            <div class="promocode-code">{{ promocode.code }}</div>
                            <div class="promocode-discount">{{ promocode.discount }}% знижка</div>
                            <div class="promocode-status used">
                              Використано в замовленні {{ promocode.used_in_order }}
                            </div>
                            <div class="promocode-date">
                              {{ promocode.used_date|date:"d.m.Y" }}
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}
                  
                  {% if not user.promocodes and not user.used_promocodes %}
                    <p style="color: #9ca3af; text-align: center; margin: 1rem 0;">У користувача немає промокодів</p>
                  {% endif %}
                  
                                        <button class="promocode-btn give" onclick="givePromocode('{{ user.user.id }}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 0.5rem;">
                      <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Дати промокод
                  </button>
                </div>

                <!-- Информация о доставке -->
                <div class="delivery-section">
                  <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h4c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                    </svg>
                    Інформація про доставку
                  </h4>
                  <div class="delivery-info">
                    <div class="delivery-item">
                      <div class="delivery-label">Місто</div>
                                              <div class="delivery-value {% if not user.profile.city %}empty{% endif %}">
                          {{ user.profile.city|default:"Не вказано" }}
                        </div>
                    </div>
                    <div class="delivery-item">
                      <div class="delivery-label">Відділення НП</div>
                                              <div class="delivery-value {% if not user.profile.np_office %}empty{% endif %}">
                          {{ user.profile.np_office|default:"Не вказано" }}
                        </div>
                    </div>
                    <div class="delivery-item">
                      <div class="delivery-label">Тип оплати</div>
                                              <div class="delivery-value {% if not user.profile.pay_type %}empty{% endif %}">
                          {% if user.profile.pay_type == 'partial' %}
                            Часткова передоплата
                          {% elif user.profile.pay_type == 'full' %}
                            Повна передоплата
                          {% else %}
                            Не вказано
                          {% endif %}
                        </div>
                    </div>

                  </div>
                </div>



                <!-- Управление пользователем -->
                <div class="user-controls">
                  <form method="POST" action="{% url 'admin_update_user' %}" class="user-control-form">
                    {% csrf_token %}
                                            <input type="hidden" name="user_id" value="{{ user.user.id }}">
                    
                    <div class="control-section">
                      <h5>Права доступу</h5>
                      <div class="control-group">
                        <label class="control-checkbox">
                          <input type="checkbox" name="is_staff" 
                                 {% if user.user.is_staff %}checked{% endif %}>
                          <span class="checkmark"></span>
                          <span class="label-text">Адміністратор</span>
                        </label>
                        
                        {% if request.user.is_superuser %}
                          <label class="control-checkbox">
                            <input type="checkbox" name="is_superuser" 
                                   {% if user.user.is_superuser %}checked{% endif %}>
                            <span class="checkmark"></span>
                            <span class="label-text">Суперкористувач</span>
                          </label>
                        {% endif %}
                      </div>
                    </div>

                    <button type="submit" class="save-btn">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                      </svg>
                      Зберегти зміни
                    </button>
                    </form>
                            </div>
                            </div>
                          </div>
          {% endfor %}
        </div>
      </div>

    {% elif section == 'catalogs' %}
      <!-- Управление каталогами -->
      <div class="catalogs-admin-section">
        <!-- Заголовок секции -->
        <div class="section-header">
          <div class="section-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
            </svg>
          </div>
          <div class="section-title">Управління каталогами</div>
          <div class="section-stats">
            <div class="stat-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <span id="categories-count">{{ categories|length }}</span>
            </div>
            <div class="stat-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7V9h10v2zm0-4H7V7h10v2z"/>
              </svg>
              <span id="products-count">{{ products|length }}</span>
            </div>
          </div>
        </div>

        <!-- Поиск и фильтры -->
        <div class="catalogs-search-section">
          <div class="search-container">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <input type="text" id="catalogs-search" class="catalogs-search-input" 
                   placeholder="Пошук по назві товару або категорії..." 
                   oninput="filterCatalogs(this.value)">
            <button class="search-clear-btn" onclick="clearCatalogsSearch()" style="display: none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Категории -->
        <div class="categories-admin-section">
          <div class="subsection-header">
            <h3>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Категорії ({{ categories|length }})
            </h3>
            <a href="{% url 'add_category' %}" class="btn-create-category-new">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
              Додати категорію
            </a>
          </div>
          
          <div class="categories-grid">
            {% for category in categories %}
              <div class="category-card" data-category-name="{{ category.name|lower }}">
                <div class="category-sparks">
                  <div class="category-spark category-spark-1"></div>
                  <div class="category-spark category-spark-2"></div>
                  <div class="category-spark category-spark-3"></div>
                </div>
                
                <div class="category-header">
                  <div class="category-icon">
                    {% if category.icon %}
                      <img src="{{ category.icon.url }}" alt="{{ category.name }}" class="category-icon-img">
                    {% else %}
                      <div class="category-icon-placeholder">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                      </div>
                    {% endif %}
                  </div>
                  <div class="category-info">
                    <div class="category-name">{{ category.name }}</div>
                    <div class="category-order">Порядок: {{ category.order|default:0 }}</div>
                    <div class="category-slug">Slug: {{ category.slug }}</div>
                  </div>
                </div>
                
                <div class="category-stats">
                  <div class="category-stat">
                    <div class="stat-number">{{ category.products.count }}</div>
                    <div class="stat-label">Товарів</div>
                  </div>
                </div>
                
                <div class="category-actions">
                  <a href="{% url 'admin_category_edit' category.id %}" class="action-btn edit">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    Редагувати
                  </a>
                  <button class="action-btn delete" data-action="delete-category" data-id="{{ category.id }}" data-name="{{ category.name }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    Видалити
                  </button>
                </div>
              </div>
            {% empty %}
              <div class="empty-state">
                <div class="empty-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                </div>
                <h4>Категорії відсутні</h4>
                <p>Створіть першу категорію для організації товарів</p>
                <a href="{% url 'add_category' %}" class="btn-create-category-empty">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                  </svg>
                  Додати категорію
                </a>
                        </div>
                      {% endfor %}
                    </div>
        </div>

        <!-- Товары -->
        <div class="products-admin-section">
          <div class="subsection-header">
            <h3>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7V9h10v2zm0-4H7V7h10v2z"/>
              </svg>
              Товари ({{ products|length }})
            </h3>
            <a href="{% url 'admin_product_new' %}" class="add-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
              Додати товар
            </a>
          </div>
          
          <div class="products-grid">
            {% for product in products %}
              <div class="product-card" data-product-name="{{ product.title|lower }}" data-category-name="{{ product.category.name|lower }}">
                <div class="product-sparks">
                  <div class="product-spark product-spark-1"></div>
                  <div class="product-spark product-spark-2"></div>
                  <div class="product-spark product-spark-3"></div>
                </div>
                
                <div class="product-header">
                  <div class="product-image">
                    {% if product.display_image %}
                      <img src="{{ product.display_image.url }}" alt="{{ product.title }}" class="product-img">
                    {% else %}
                      <div class="product-image-placeholder">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                      </div>
                    {% endif %}
                  </div>
                  <div class="product-info">
                    <div class="product-title">{{ product.title }}</div>
                    <div class="product-category">{{ product.category.name }}</div>
                  </div>
                </div>
                
                <div class="product-details">
                  <div class="product-price">
                    {% if product.has_discount %}
                      <span class="price-old">{{ product.price }} грн</span>
                      <span class="price-new">{{ product.final_price }} грн</span>
                      <span class="discount-badge">-{{ product.discount_percent }}%</span>
                    {% else %}
                      <span class="price-current">{{ product.price }} грн</span>
                    {% endif %}
                  </div>
                  
                  <div class="product-features">
                    {% if product.featured %}
                      <span class="feature-badge featured">Рекомендований</span>
                    {% endif %}
                    {% if product.points_reward > 0 %}
                      <span class="feature-badge points">+{{ product.points_reward }} балів</span>
                    {% endif %}
                  </div>
                </div>
                
                <div class="product-stats">
                  <div class="product-stat">
                    <div class="stat-number">{{ product.color_variants.count|default:0 }}</div>
                    <div class="stat-label">Кольорів</div>
                  </div>
                  <div class="product-stat">
                    <div class="stat-number">{{ product.images.count|default:0 }}</div>
                    <div class="stat-label">Фото</div>
                  </div>
                </div>
                
                <div class="product-actions">
                  <a href="{% url 'admin_product_edit_unified' product.id %}" class="action-btn edit">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    Редагувати
                  </a>
                  <button class="action-btn delete" data-action="delete-product" data-id="{{ product.id }}" data-name="{{ product.title }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    Видалити
                  </button>
                </div>
              </div>
            {% empty %}
              <div class="empty-state">
                <div class="empty-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7V9h10v2zm0-4H7V7h10v2z"/>
                  </svg>
                </div>
                <h4>Товари відсутні</h4>
                <p>Створіть перший товар для поповнення каталогу</p>
                <a href="{% url 'admin_product_new' %}" class="btn btn-primary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                  </svg>
                  Додати товар
                </a>
              </div>
                {% endfor %}
          </div>
        </div>
      </div>
    {% elif section == 'promocodes' %}
      <!-- Управление промокодами -->
      <div class="promocodes-admin-section">
        <!-- Заголовок секции -->
        <div class="section-header">
          <div class="section-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div class="section-title">Управління промокодами</div>
          <div class="section-stats">
            <div class="stat-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <span id="promocodes-count">{{ total_promocodes|default:0 }}</span>
            </div>
            <div class="stat-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="active-promocodes-count">{{ active_promocodes|default:0 }}</span>
            </div>
          </div>
        </div>

        <!-- Поиск -->
        <div class="promocodes-search-section">
          <div class="search-container">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <input type="text" id="promocodes-search" class="promocodes-search-input" 
                   placeholder="Пошук по коду промокоду..." 
                   oninput="filterPromocodes(this.value)">
            <button class="search-clear-btn" onclick="clearPromocodesSearch()" style="display: none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Список промокодов -->
        <div class="promocodes-list-section">
          <div class="subsection-header">
            <h3>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              Промокоди ({{ total_promocodes|default:0 }})
            </h3>
            <a href="{% url 'admin_promocode_create' %}" class="add-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
              Додати промокод
            </a>
          </div>
          
          <div class="promocodes-grid">
            {% for promocode in promocodes %}
              <div class="promocode-card" data-promocode-code="{{ promocode.code|lower }}">
                <div class="promocode-sparks">
                  <div class="promocode-spark promocode-spark-1"></div>
                  <div class="promocode-spark promocode-spark-2"></div>
                  <div class="promocode-spark promocode-spark-3"></div>
                </div>
                
                <div class="promocode-header">
                  <div class="promocode-code">{{ promocode.code }}</div>
                  <div class="promocode-status {% if promocode.is_active %}active{% else %}inactive{% endif %}">
                    {% if promocode.is_active %}Активний{% else %}Неактивний{% endif %}
                  </div>
                </div>
                
                <div class="promocode-details">
                  <div class="promocode-type">
                    <span class="type-badge {% if promocode.discount_type == 'percentage' %}percentage{% else %}fixed{% endif %}">
                      {% if promocode.discount_type == 'percentage' %}
                        {{ promocode.discount_value }}%
              {% else %}
                        {{ promocode.discount_value }} грн
              {% endif %}
                    </span>
        </div>
                  
                  <div class="promocode-usage">
                    <div class="usage-info">
                      <span class="usage-label">Використань:</span>
                      <span class="usage-value">{{ promocode.current_uses }}</span>
                    </div>
                    {% if promocode.max_uses > 0 %}
                      <div class="usage-info">
                        <span class="usage-label">Максимум:</span>
                        <span class="usage-value">{{ promocode.max_uses }}</span>
      </div>
    {% endif %}
  </div>
</div>
                
                <div class="promocode-stats">
                  <div class="promocode-stat">
                    <div class="stat-number">{{ promocode.get_purchases_count }}</div>
                    <div class="stat-label">Покупок</div>
                  </div>
                  <div class="promocode-stat">
                    <div class="stat-number">{{ promocode.created_at|date:"d.m.Y" }}</div>
                    <div class="stat-label">Створено</div>
                  </div>
                </div>
                
                <div class="promocode-actions">
                  <a href="{% url 'admin_promocode_edit' promocode.id %}" class="action-btn edit">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    Редагувати
                  </a>
                  <button class="action-btn toggle" data-action="toggle-promocode" data-id="{{ promocode.id }}" data-code="{{ promocode.code }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    {% if promocode.is_active %}Деактивувати{% else %}Активувати{% endif %}
                  </button>
                  <button class="action-btn delete" data-action="delete-promocode" data-id="{{ promocode.id }}" data-code="{{ promocode.code }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    Видалити
                  </button>
                </div>
              </div>
            {% empty %}
              <div class="empty-state">
                <div class="empty-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                </div>
                <h4>Промокоди відсутні</h4>
                <p>Створіть перший промокод для залучення клієнтів</p>
                <a href="{% url 'admin_promocode_create' %}" class="btn btn-primary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                  </svg>
                  Додати промокод
                </a>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

    {% elif section == 'offline_stores' %}
      <!-- Управление оффлайн магазинами -->
      <div class="offline-stores-admin-section">
        <!-- Заголовок секции -->
        <div class="section-header">
          <div class="section-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div class="section-title">Управління оффлайн магазинами</div>
          <div class="section-stats">
            <div class="stat-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <span id="stores-count">{{ total_stores|default:0 }}</span>
            </div>
            <div class="stat-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="active-stores-count">{{ active_stores|default:0 }}</span>
            </div>
          </div>
        </div>

        <!-- Поиск -->
        <div class="offline-stores-search-section">
          <div class="search-container">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <input type="text" id="offline-stores-search" class="offline-stores-search-input" 
                   placeholder="Пошук по назві магазину..." 
                   oninput="filterOfflineStores(this.value)">
            <button class="search-clear-btn" onclick="clearOfflineStoresSearch()" style="display: none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Список оффлайн магазинов -->
        <div class="offline-stores-list-section">
          <div class="subsection-header">
            <h3>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              Оффлайн магазини ({{ total_stores|default:0 }})
            </h3>
            <a href="{% url 'admin_offline_store_create' %}" class="add-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
              Додати магазин
            </a>
          </div>
          
          <div class="offline-stores-grid">
            {% for store in stores %}
              <div class="offline-store-card" data-store-name="{{ store.name|lower }}">
                <div class="offline-store-sparks">
                  <div class="offline-store-spark offline-store-spark-1"></div>
                  <div class="offline-store-spark offline-store-spark-2"></div>
                  <div class="offline-store-spark offline-store-spark-3"></div>
                </div>
                
                <div class="offline-store-header">
                  <div class="offline-store-name">{{ store.name }}</div>
                  <div class="offline-store-status {% if store.is_active %}active{% else %}inactive{% endif %}">
                    {% if store.is_active %}Активний{% else %}Неактивний{% endif %}
                  </div>
                </div>
                
                <div class="offline-store-details">
                  <div class="offline-store-address">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>
                    <span>{{ store.address }}</span>
                  </div>
                  
                  {% if store.phone %}
                    <div class="offline-store-phone">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                      </svg>
                      <span>{{ store.phone }}</span>
                    </div>
                  {% endif %}
                  
                  {% if store.working_hours %}
                    <div class="offline-store-hours">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
                        <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                      </svg>
                      <span>{{ store.working_hours }}</span>
                    </div>
                  {% endif %}
                </div>
                
                <div class="offline-store-stats">
                  <div class="offline-store-stat">
                    <div class="stat-number">{{ store.order }}</div>
                    <div class="stat-label">Порядок</div>
                  </div>
                  <div class="offline-store-stat">
                    <div class="stat-number">{{ store.created_at|date:"d.m.Y" }}</div>
                    <div class="stat-label">Створено</div>
                  </div>
                </div>
                
                <div class="offline-store-actions">
                  <a href="{% url 'admin_store_management' store.id %}" class="action-btn manage">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Управління
                  </a>
                  <a href="{% url 'admin_offline_store_edit' store.id %}" class="action-btn edit">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Налаштування
                  </a>
                  <button class="action-btn toggle" data-action="toggle-store" data-id="{{ store.id }}" data-name="{{ store.name }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    {% if store.is_active %}Деактивувати{% else %}Активувати{% endif %}
                  </button>
                  <button class="action-btn delete" data-action="delete-store" data-id="{{ store.id }}" data-name="{{ store.name }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    Видалити
                  </button>
                </div>
              </div>
            {% empty %}
              <div class="empty-state">
                <div class="empty-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                </div>
                <h4>Оффлайн магазини відсутні</h4>
                <p>Створіть перший оффлайн магазин для розширення мережі</p>
                <a href="{% url 'admin_offline_store_create' %}" class="btn btn-primary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                  </svg>
                  Додати магазин
                </a>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

    {% elif section == 'print_proposals' %}
      <!-- Управление запропонованими принтами -->
      <div class="print-proposals-admin-section">
        <!-- Заголовок секции -->
        <div class="section-header">
          <div class="section-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 15v4H5v-4H3v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4h-2zM11 8.414V20h2V8.414l3.293 3.293 1.414-1.414L12 4.586 6.293 10.293l1.414 1.414L11 8.414z"/>
            </svg>
          </div>
          <div class="section-title">Запропоновані принти</div>
          <div class="section-stats">
            <div class="stat-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <span id="proposals-count">{{ total_proposals|default:0 }}</span>
            </div>
            <div class="stat-badge">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="pending-proposals-count">{{ pending_proposals|default:0 }}</span>
            </div>
          </div>
        </div>

        <!-- Поиск -->
        <div class="print-proposals-search-section">
          <div class="search-container">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <input type="text" id="print-proposals-search" class="print-proposals-search-input" 
                   placeholder="Пошук по користувачу або опису..." 
                   oninput="filterPrintProposals(this.value)">
            <button class="search-clear-btn" onclick="clearPrintProposalsSearch()" style="display: none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Список запропонованих принтов -->
        <div class="print-proposals-list-section">
          <div class="subsection-header">
            <h3>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 15v4H5v-4H3v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4h-2zM11 8.414V20h2V8.414l3.293 3.293 1.414-1.414L12 4.586 6.293 10.293l1.414 1.414L11 8.414z"/>
              </svg>
              Запропоновані принти ({{ total_proposals|default:0 }})
            </h3>
          </div>
          
          <div class="print-proposals-grid">
            {% for proposal in print_proposals %}
              <div class="print-proposal-card" data-proposal-id="{{ proposal.id }}" data-user-name="{{ proposal.user.username|lower }}" data-description="{{ proposal.description|lower }}">
                <div class="print-proposal-sparks">
                  <div class="print-proposal-spark print-proposal-spark-1"></div>
                  <div class="print-proposal-spark print-proposal-spark-2"></div>
                  <div class="print-proposal-spark print-proposal-spark-3"></div>
                </div>
                
                <div class="print-proposal-header">
                  <div class="print-proposal-user">
                    <div class="user-avatar">
                      {% if proposal.user.userprofile.avatar %}
                        <img src="{{ proposal.user.userprofile.avatar.url }}" alt="{{ proposal.user.username }}">
                      {% else %}
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                      {% endif %}
                    </div>
                    <div class="user-info">
                      <div class="user-name">{{ proposal.user.username }}</div>
                      {% if proposal.user.userprofile.full_name %}
                        <div class="user-full-name">{{ proposal.user.userprofile.full_name }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="print-proposal-status status-{{ proposal.status }}">
                    {% if proposal.status == 'pending' %}
                      <span class="status-badge pending">На розгляді</span>
                    {% elif proposal.status == 'approved' %}
                      <span class="status-badge approved">Схвалено</span>
                    {% else %}
                      <span class="status-badge rejected">Відхилено</span>
                    {% endif %}
                  </div>
                </div>
                
                <div class="print-proposal-image">
                  {% if proposal.image %}
                    <img src="{{ proposal.image.url }}" alt="Принт від {{ proposal.user.username }}">
                  {% elif proposal.link_url %}
                    <div class="link-preview">
                      <div class="link-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M10.59 13.41c.41.39.41 1.03 0 1.42-.39.39-1.03.39-1.42 0a5.003 5.003 0 0 1 0-7.07l3.54-3.54a5.003 5.003 0 0 1 7.07 0 5.003 5.003 0 0 1 0 7.07l-1.49 1.49c.01-.82-.12-1.64-.4-2.42l.47-.48a2.982 2.982 0 0 0 0-4.24 2.982 2.982 0 0 0-4.24 0l-3.53 3.53a2.982 2.982 0 0 0 0 4.24zm2.82-4.24c.39-.39 1.03-.39 1.42 0a5.003 5.003 0 0 1 0 7.07l-3.54 3.54a5.003 5.003 0 0 1-7.07 0 5.003 5.003 0 0 1 0-7.07l1.49-1.49c-.01.82.12 1.64.4 2.42l-.47.48a2.982 2.982 0 0 0 0 4.24 2.982 2.982 0 0 0 4.24 0l3.53-3.53a2.982 2.982 0 0 0 0-4.24z"/>
                        </svg>
                      </div>
                      <div class="link-info">
                        <div class="link-label">Посилання на зображення:</div>
                        <a href="{{ proposal.link_url }}" target="_blank" class="link-url">{{ proposal.link_url }}</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="no-content">
                      <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                      </svg>
                      <span>Зображення не надано</span>
                    </div>
                  {% endif %}
                </div>
                
                {% if proposal.description %}
                  <div class="print-proposal-description">
                    <div class="description-label">Опис:</div>
                    <div class="description-text">{{ proposal.description }}</div>
                  </div>
                {% endif %}
                
                <div class="print-proposal-contact">
                  {% if proposal.user.userprofile.telegram %}
                    <div class="contact-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                      </svg>
                      <a href="https://t.me/{{ proposal.user.userprofile.telegram }}" target="_blank">@{{ proposal.user.userprofile.telegram }}</a>
                    </div>
                  {% endif %}
                  {% if proposal.user.userprofile.instagram %}
                    <div class="contact-item">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                      </svg>
                      <a href="https://instagram.com/{{ proposal.user.userprofile.instagram }}" target="_blank">@{{ proposal.user.userprofile.instagram }}</a>
                    </div>
                  {% endif %}
                </div>
                
                <div class="print-proposal-stats">
                  <div class="proposal-stat">
                    <div class="stat-number">{{ proposal.created_at|date:"d.m.Y" }}</div>
                    <div class="stat-label">Створено</div>
                  </div>
                  {% if proposal.awarded_points > 0 %}
                    <div class="proposal-stat">
                      <div class="stat-number">{{ proposal.awarded_points }}</div>
                      <div class="stat-label">Балів</div>
                    </div>
                  {% endif %}
                  {% if proposal.awarded_promocode %}
                    <div class="proposal-stat">
                      <div class="stat-number">{{ proposal.awarded_promocode.discount_amount }}₴</div>
                      <div class="stat-label">Промокод</div>
                    </div>
                  {% endif %}
                </div>
                
                <div class="print-proposal-actions">
                  {% if proposal.status == 'pending' %}
                    <button class="action-btn approve" data-action="proposal-status" data-id="{{ proposal.id }}" data-status="approved">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                      </svg>
                      Схвалити
                    </button>
                    <button class="action-btn reject" data-action="proposal-status" data-id="{{ proposal.id }}" data-status="rejected">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                      </svg>
                      Відхилити
                    </button>
                  {% endif %}
                  <button class="action-btn award-points" data-action="award-points" data-id="{{ proposal.id }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Бали
                  </button>
                  <button class="action-btn award-promocode" data-action="award-promocode" data-id="{{ proposal.id }}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Промокод
                  </button>
                </div>
              </div>
            {% empty %}
              <div class="empty-state">
                <div class="empty-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 15v4H5v-4H3v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4h-2zM11 8.414V20h2V8.414l3.293 3.293 1.414-1.414L12 4.586 6.293 10.293l1.414 1.414L11 8.414z"/>
                  </svg>
                </div>
                <h4>Запропоновані принти відсутні</h4>
                <p>Користувачі ще не запропонували принти</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

    {% elif section == 'collaboration' %}
      <div class="row g-3">
        <div class="col-md-6">
          <div class="p-3 rounded" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1)">
            <h3>Дропшипери</h3>
            <div style="opacity:.7">Блок у розробці</div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-3 rounded" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1)">
            <h3>Оптовики — накладні</h3>
            {% if invoices %}
            <div class="list-group">
              {% for inv in invoices %}
              <div class="list-group-item d-flex justify-content-between align-items-center" style="background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08)">
                <div>
                  <div><strong>{{ inv.invoice_number }}</strong> · {{ inv.company_name }}</div>
                  <div class="small text-muted">Статус: {{ inv.get_status_display }}</div>
                  <div class="small text-muted">Оплата: 
                    <span class="badge 
                      {% if inv.payment_status == 'not_paid' %}bg-secondary
                      {% elif inv.payment_status == 'pending' %}bg-warning
                      {% elif inv.payment_status == 'paid' %}bg-success
                      {% elif inv.payment_status == 'failed' %}bg-danger
                      {% else %}bg-dark{% endif %}">
                      {% if inv.payment_status == 'not_paid' %}Не оплачена
                      {% elif inv.payment_status == 'pending' %}Очікує оплати
                      {% elif inv.payment_status == 'paid' %}Оплачена
                      {% elif inv.payment_status == 'failed' %}Помилка оплати
                      {% else %}{{ inv.payment_status }}{% endif %}
                    </span>
                  </div>
                  {% if inv.file_path %}
                    <div class="small"><a href="{% url 'download_invoice_file' inv.id %}" class="link-primary">Скачати файл</a></div>
                  {% endif %}
                </div>
                <div class="d-flex gap-2 flex-wrap">
                  <!-- Кнопка одобрения накладной -->
                  {% if not inv.is_approved %}
                    <form onsubmit="return toggleInvoiceApproval(event, {{ inv.id }}, true)"><button class="btn btn-sm btn-outline-success" type="submit">Одобрити для оплаты</button></form>
                  {% else %}
                    <form onsubmit="return toggleInvoiceApproval(event, {{ inv.id }}, false)"><button class="btn btn-sm btn-outline-warning" type="submit">Отменить одобрение</button></form>
                  {% endif %}
                  
                  <!-- Кнопки статуса оплаты -->
                  {% if inv.payment_status != 'paid' %}
                    <form onsubmit="return toggleInvoicePayment(event, {{ inv.id }}, 'paid')"><button class="btn btn-sm btn-outline-success" type="submit">Відмітити як оплачену</button></form>
                  {% endif %}
                  {% if inv.payment_status != 'not_paid' %}
                    <form onsubmit="return toggleInvoicePayment(event, {{ inv.id }}, 'not_paid')"><button class="btn btn-sm btn-outline-secondary" type="submit">Скинути оплату</button></form>
                  {% endif %}
                  
                  {% if inv.status == 'pending' %}
                    <form onsubmit="return updateInvoiceStatus(event, {{ inv.id }}, 'processing')"><button class="btn btn-sm btn-outline-warning" type="submit">Прийнято в обробку</button></form>
                  {% endif %}
                  {% if inv.status == 'processing' %}
                    <form onsubmit="return updateInvoiceStatus(event, {{ inv.id }}, 'shipped')"><button class="btn btn-sm btn-outline-success" type="submit">Готується до відправки</button></form>
                  {% endif %}
                  {% if inv.status == 'shipped' %}
                    <form onsubmit="return updateInvoiceStatus(event, {{ inv.id }}, 'delivered')"><button class="btn btn-sm btn-outline-primary" type="submit">Товари відправлені</button></form>
                  {% endif %}
                  {% if inv.status in 'pending,processing,shipped' %}
                    <form onsubmit="return updateInvoiceStatus(event, {{ inv.id }}, 'cancelled')"><button class="btn btn-sm btn-outline-danger" type="submit">Скасувати</button></form>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">Накладних поки немає</div>
            {% endif %}
          </div>
        </div>
      </div>
      <script>
      async function updateInvoiceStatus(e,id,status){ e.preventDefault(); const res = await fetch(`/admin-panel/invoices/update-status/${id}/`,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},body:JSON.stringify({status})}); if(res.ok){ location.reload(); } else { alert('Помилка оновлення статусу'); } return false; }
      async function toggleInvoiceApproval(e,id,approved){ e.preventDefault(); const res = await fetch(`/admin-panel/invoices/toggle-approval/${id}/`,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},body:JSON.stringify({is_approved:approved})}); if(res.ok){ location.reload(); } else { alert('Помилка оновлення одобрения'); } return false; }

async function toggleInvoicePayment(e,id,status){ e.preventDefault(); const res = await fetch(`/admin-panel/invoices/toggle-payment/${id}/`,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},body:JSON.stringify({payment_status:status})}); if(res.ok){ location.reload(); } else { alert('Помилка оновлення статусу оплати'); } return false; }
      function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`);if(v.length===2) return v.pop().split(';').shift();}
      </script>
    {% endif %}
  </div>
</div>

<script>
/* Функции для админ-панели */

/* Функция фильтрации пользователей по имени или логину */
function filterUsers(searchTerm) {
  // Фильтрация пользователей
  
  const userCards = document.querySelectorAll('.user-card');
  const usersCount = document.getElementById('users-count');
  let visibleCount = 0;
  
  searchTerm = searchTerm.toLowerCase().trim();
  
  
  userCards.forEach((card, index) => {
    const username = card.querySelector('.user-name')?.textContent?.toLowerCase() || '';
    const fullName = card.querySelector('.user-full-name')?.textContent?.toLowerCase() || '';
    const email = card.querySelector('.user-email')?.textContent?.toLowerCase() || '';
    
    
    const isVisible = username.includes(searchTerm) || 
                     fullName.includes(searchTerm) || 
                     email.includes(searchTerm);
    
    if (isVisible) {
      card.style.display = 'block';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });
  
  
  // Обновляем счетчик видимых пользователей
  if (usersCount) {
    usersCount.textContent = visibleCount;
  }
  
  /* Показываем уведомление о результатах поиска */
  if (searchTerm) {
    showNotification(`Знайдено ${visibleCount} користувачів`, 'info');
  }
}

/* Функция очистки поиска пользователей */
function clearUserSearch() {
  const searchInput = document.getElementById('users-search');
  if (searchInput) {
    searchInput.value = '';
    filterUsers('');
    searchInput.focus();
  }
}

function filterOrders(status, payment) {
  
  const currentUrl = new URL(window.location);
  currentUrl.searchParams.set('section', 'orders');
  
  /* Устанавливаем фильтры только если они не 'all' */
  if (status !== 'all') {
    currentUrl.searchParams.set('status', status);
  } else {
    currentUrl.searchParams.delete('status');
  }
  
  if (payment !== 'all') {
    currentUrl.searchParams.set('payment', payment);
  } else {
    currentUrl.searchParams.delete('payment');
  }
  
  window.location.href = currentUrl.toString();
}

document.addEventListener('DOMContentLoaded', function(){
  const deleteForms = document.querySelectorAll('[data-order-delete-form]');
  deleteForms.forEach(function(form){
    form.addEventListener('submit', function(event){
      event.preventDefault();
      const orderNumber = form.getAttribute('data-order-number');
      const confirmText = orderNumber ? `Видалити замовлення #${orderNumber}?` : 'Видалити це замовлення?';
      if(!window.confirm(confirmText)) return;

      const formData = new FormData(form);
      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
        .then(function(response){
          if(!response.ok) return response.json().then(function(data){ throw new Error(data.error || 'Помилка видалення'); });
          return response.json();
        })
        .then(function(data){
          if(data.ok){
            const card = form.closest('.admin-order-card');
            if(card){ card.remove(); }
          } else {
            alert(data.error || 'Не вдалося видалити замовлення.');
          }
        })
        .catch(function(err){
          alert(err.message || 'Сталася помилка під час видалення замовлення.');
        });
    });
  });
});

/* Функция для фильтрации заказов конкретного пользователя */
function filterUserOrders(userId, filterType, filterValue) {
  
  const currentUrl = new URL(window.location);
  currentUrl.searchParams.set('section', 'orders');
  currentUrl.searchParams.set('user_id', userId);
  currentUrl.searchParams.set(filterType, filterValue);
  
  
  window.location.href = currentUrl.toString();
}

/* Функции для управления каталогами */

/* Функция фильтрации каталогов */
function filterCatalogs(searchTerm) {
  
  const categoryCards = document.querySelectorAll('.category-card');
  const productCards = document.querySelectorAll('.product-card');
  const categoriesCount = document.getElementById('categories-count');
  const productsCount = document.getElementById('products-count');
  
  let visibleCategories = 0;
  let visibleProducts = 0;
  
  searchTerm = searchTerm.toLowerCase().trim();
  
  /* Показываем/скрываем кнопку очистки поиска */
  const clearBtn = document.querySelector('.search-clear-btn');
  if (clearBtn) {
    clearBtn.style.display = searchTerm ? 'block' : 'none';
  }
  
  /* Фильтруем категории */
  categoryCards.forEach(card => {
    const categoryName = card.getAttribute('data-category-name') || '';
    const isVisible = categoryName.includes(searchTerm);
    
    if (isVisible) {
      card.style.display = 'block';
      visibleCategories++;
    } else {
      card.style.display = 'none';
    }
  });
  
  /* Фильтруем товары */
  productCards.forEach(card => {
    const productName = card.getAttribute('data-product-name') || '';
    const categoryName = card.getAttribute('data-category-name') || '';
    const isVisible = productName.includes(searchTerm) || categoryName.includes(searchTerm);
    
    if (isVisible) {
      card.style.display = 'block';
      visibleProducts++;
    } else {
      card.style.display = 'none';
    }
  });
  
  /* Обновляем счетчики */
  if (categoriesCount) {
    categoriesCount.textContent = visibleCategories;
  }
  if (productsCount) {
    productsCount.textContent = visibleProducts;
  }
  
  /* Показываем уведомление о результатах поиска */
  if (searchTerm) {
    showNotification(`Знайдено ${visibleCategories} категорій та ${visibleProducts} товарів`, 'info');
  }
}

/* Функция очистки поиска каталогов */
function clearCatalogsSearch() {
  const searchInput = document.getElementById('catalogs-search');
  if (searchInput) {
    searchInput.value = '';
    filterCatalogs('');
    searchInput.focus();
  }
}

/* Функция удаления категории */
function deleteCategory(categoryId, categoryName) {
  if (confirm(`Ви впевнені, що хочете видалити категорію "${categoryName}"? Це також видалить всі товари в цій категорії!`)) {
    /* Перенаправляем на страницу удаления */
    window.location.href = `/admin-panel/category/${categoryId}/delete/`;
  }
}

/* Функция удаления товара */
function deleteProduct(productId, productName) {
  if (confirm(`Ви впевнені, що хочете видалити товар "${productName}"?`)) {
    /* Перенаправляем на страницу удаления */
    window.location.href = `/admin-panel/product/${productId}/delete/`;
  }
}

function updateOrderStatus(orderId, newStatus) {
  
  /* Проверяем CSRF токен */
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (!csrfToken) {
    console.error('CSRF token not found!');
    showNotification('Помилка: CSRF токен не знайдено', 'error');
    return;
  }
  
  const statusText = {
    'new': 'В обробці',
    'prep': 'Готується до відправлення', 
    'ship': 'Відправлено',
    'done': 'Отримано',
    'cancelled': 'Скасовано'
  };
  
  /* Если статус "Відправлено", запрашиваем ТТН */
  if (newStatus === 'ship') {
    const ttn = prompt('Введіть номер ТТН Нової Пошти:');
    if (ttn === null) {
      /* Пользователь отменил */
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
      return;
    }
    if (!ttn.trim()) {
      showNotification('Помилка: Номер ТТН не може бути порожнім', 'error');
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
      return;
    }
    
    if (confirm(`Змінити статус замовлення на "${statusText[newStatus]}" з ТТН: ${ttn.trim()}?`)) {
      /* Отправляем запрос с ТТН */
      const formData = new FormData();
      formData.append('order_id', orderId);
      formData.append('status', newStatus);
      formData.append('tracking_number', ttn.trim());
      formData.append('csrfmiddlewaretoken', csrfToken.value);
      
      
      fetch('{% url "admin_update_order_status" %}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showNotification(data.message, 'success');
          /* Обновляем селект в интерфейсе */
          const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
          if (select) {
            select.value = newStatus;
          }
          /* Обновляем отображение ТТН */
          const ttnElement = document.querySelector(`[data-order-id="${orderId}"] .delivery-item[data-field="ttn"]`);
          if (ttnElement) {
            ttnElement.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/>
            </svg>
            <span>ТТН: ${ttn.trim()}</span>`;
          }
        } else {
          showNotification('Помилка: ' + data.error, 'error');
          /* Возвращаем предыдущее значение */
          const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
          if (select) {
            select.value = select.getAttribute('data-original-value');
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('Помилка оновлення статусу', 'error');
        /* Возвращаем предыдущее значение */
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
        if (select) {
          select.value = select.getAttribute('data-original-value');
        }
      });
      return;
    } else {
      /* Пользователь отменил */
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
      return;
    }
  }
  
  if (confirm(`Змінити статус замовлення на "${statusText[newStatus]}"?`)) {
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('status', newStatus);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    
    fetch('{% url "admin_update_order_status" %}', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      return response.json();
    })
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        /* Обновляем селект в интерфейсе */
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
        if (select) {
          select.value = newStatus;
        }
      } else {
        showNotification('Помилка: ' + data.error, 'error');
        /* Возвращаем предыдущее значение */
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
        if (select) {
          select.value = select.getAttribute('data-original-value');
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка оновлення статусу', 'error');
      /* Возвращаем предыдущее значение */
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
    });
  } else {
    /* Возвращаем предыдущее значение если пользователь отменил */
    const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updateOrderStatus"]`);
    if (select) {
      select.value = select.getAttribute('data-original-value');
    }
  }
}

function updatePaymentStatus(orderId, newPaymentStatus) {
  const paymentStatusText = {
    'unpaid': 'Не оплачено',
    'checking': 'На перевірці',
    'partial': 'Внесена передплата',
    'paid': 'Оплачено повністю'
  };
  
  if (confirm(`Змінити статус оплати на "${paymentStatusText[newPaymentStatus]}"?`)) {
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('payment_status', newPaymentStatus);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "admin_update_payment_status" %}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        /* Обновляем селект в интерфейсе */
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updatePaymentStatus"]`);
        if (select) {
          select.value = newPaymentStatus;
        }
      } else {
        showNotification('Помилка: ' + data.error, 'error');
        /* Возвращаем предыдущее значение */
        const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updatePaymentStatus"]`);
        if (select) {
          select.value = select.getAttribute('data-original-value');
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка оновлення статусу оплати', 'error');
      /* Возвращаем предыдущее значение */
      const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updatePaymentStatus"]`);
      if (select) {
        select.value = select.getAttribute('data-original-value');
      }
    });
  } else {
    /* Возвращаем предыдущее значение если пользователь отменил */
    const select = document.querySelector(`[data-order-id="${orderId}"] select[onchange*="updatePaymentStatus"]`);
    if (select) {
      select.value = select.getAttribute('data-original-value');
    }
  }
}

function copyOrderNumber(orderNumber) {
  navigator.clipboard.writeText(orderNumber).then(function() {
    showNotification('Номер замовлення скопійовано!', 'success');
  }).catch(function(err) {
    console.error('Ошибка копирования:', err);
    showNotification('Помилка копіювання', 'error');
  });
}

function approvePayment(orderId) {
  if (confirm('Підтвердити оплату для цього замовлення?')) {
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('action', 'approve');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "admin_approve_payment" %}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        /* Обновляем статус в интерфейсе */
        const statusSelect = document.querySelector(`[data-order-id="${orderId}"] .status-select[onchange*="updatePaymentStatus"]`);
        if (statusSelect) {
          statusSelect.value = data.new_status;
        }
        /* Скрываем секцию скриншота */
        const screenshotSection = document.querySelector(`[data-order-id="${orderId}"] .payment-screenshot-section`);
        if (screenshotSection) {
          screenshotSection.style.display = 'none';
        }
      } else {
        showNotification('Помилка: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка підтвердження оплати', 'error');
    });
  }
}

function rejectPayment(orderId) {
  if (confirm('Відхилити оплату для цього замовлення?')) {
    const formData = new FormData();
    formData.append('order_id', orderId);
    formData.append('action', 'reject');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "admin_approve_payment" %}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        /* Обновляем статус в интерфейсе */
        const statusSelect = document.querySelector(`[data-order-id="${orderId}"] .status-select[onchange*="updatePaymentStatus"]`);
        if (statusSelect) {
          statusSelect.value = data.new_status;
        }
        /* Скрываем секцию скриншота */
        const screenshotSection = document.querySelector(`[data-order-id="${orderId}"] .payment-screenshot-section`);
        if (screenshotSection) {
          screenshotSection.style.display = 'none';
        }
      } else {
        showNotification('Помилка: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка відхилення оплати', 'error');
    });
  }
}



function toggleScreenshot(orderId) {
  const content = document.getElementById(`screenshot-${orderId}`);
  const header = content.previousElementSibling;
  const toggleIcon = header.querySelector('.toggle-icon');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    toggleIcon.style.transform = 'rotate(180deg)';
  } else {
    content.style.display = 'none';
    toggleIcon.style.transform = 'rotate(0deg)';
  }
}

function showNotification(message, type) {
  /* Создаем уведомление */
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.textContent = message;
  
  /* Добавляем в DOM */
  document.body.appendChild(notification);
  
  /* Показываем с анимацией */
  setTimeout(() => {
    notification.classList.add('show');
  }, 100);
  
  /* Удаляем через 3 секунды */
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

/* ===== ФУНКЦИИ ДЛЯ ПРОМОКОДОВ ===== */

/* Функция фильтрации промокодов */
function filterPromocodes(searchTerm) {
  const promocodeCards = document.querySelectorAll('.promocode-card');
  const promocodesCount = document.getElementById('promocodes-count');
  const activePromocodesCount = document.getElementById('active-promocodes-count');
  let visibleCount = 0;
  let visibleActiveCount = 0;
  
  searchTerm = searchTerm.toLowerCase().trim();
  
  promocodeCards.forEach((card) => {
    const code = card.getAttribute('data-promocode-code') || '';
    const isVisible = code.includes(searchTerm);
    
    if (isVisible) {
      card.style.display = 'block';
      visibleCount++;
      /* Проверяем, активен ли промокод */
      const statusElement = card.querySelector('.promocode-status');
      if (statusElement && statusElement.classList.contains('active')) {
        visibleActiveCount++;
      }
    } else {
      card.style.display = 'none';
    }
  });
  
  /* Обновляем счетчики */
  if (promocodesCount) promocodesCount.textContent = visibleCount;
  if (activePromocodesCount) activePromocodesCount.textContent = visibleActiveCount;
  
  /* Показываем/скрываем кнопку очистки */
  const clearBtn = document.querySelector('.promocodes-search-section .search-clear-btn');
  if (clearBtn) {
    clearBtn.style.display = searchTerm ? 'block' : 'none';
  }
  
  /* Показываем уведомление о результатах поиска */
  if (searchTerm) {
    showNotification(`Знайдено ${visibleCount} промокодів`, 'info');
  }
}

/* Функция очистки поиска промокодов */
function clearPromocodesSearch() {
  const searchInput = document.getElementById('promocodes-search');
  if (searchInput) {
    searchInput.value = '';
    filterPromocodes('');
    searchInput.focus();
  }
}

/* Функция переключения статуса промокода */
function togglePromocode(promocodeId, promocodeCode) {
  if (confirm(`Змінити статус промокоду "${promocodeCode}"?`)) {
    window.location.href = `/admin-panel/promocode/${promocodeId}/toggle/`;
  }
}

/* Функция удаления промокода */
function deletePromocode(promocodeId, promocodeCode) {
  if (confirm(`Ви впевнені, що хочете видалити промокод "${promocodeCode}"?`)) {
    window.location.href = `/admin-panel/promocode/${promocodeId}/delete/`;
  }
}

/* ===== ФУНКЦИИ ДЛЯ ОФФЛАЙН МАГАЗИНОВ ===== */

/* Функция фильтрации оффлайн магазинов */
function filterOfflineStores(searchTerm) {
  const storeCards = document.querySelectorAll('.offline-store-card');
  const storesCount = document.getElementById('stores-count');
  const activeStoresCount = document.getElementById('active-stores-count');
  let visibleCount = 0;
  let visibleActiveCount = 0;
  
  searchTerm = searchTerm.toLowerCase().trim();
  
  storeCards.forEach((card) => {
    const name = card.getAttribute('data-store-name') || '';
    const isVisible = name.includes(searchTerm);
    
    if (isVisible) {
      card.style.display = 'block';
      visibleCount++;
      /* Проверяем, активен ли магазин */
      const statusElement = card.querySelector('.offline-store-status');
      if (statusElement && statusElement.classList.contains('active')) {
        visibleActiveCount++;
      }
    } else {
      card.style.display = 'none';
    }
  });
  
  /* Обновляем счетчики */
  if (storesCount) storesCount.textContent = visibleCount;
  if (activeStoresCount) activeStoresCount.textContent = visibleActiveCount;
  
  /* Показываем/скрываем кнопку очистки */
  const clearBtn = document.querySelector('.offline-stores-search-section .search-clear-btn');
  if (clearBtn) {
    clearBtn.style.display = searchTerm ? 'block' : 'none';
  }
  
  /* Показываем уведомление о результатах поиска */
  if (searchTerm) {
    showNotification(`Знайдено ${visibleCount} магазинів`, 'info');
  }
}

/* Функция очистки поиска оффлайн магазинов */
function clearOfflineStoresSearch() {
  const searchInput = document.getElementById('offline-stores-search');
  if (searchInput) {
    searchInput.value = '';
    filterOfflineStores('');
    searchInput.focus();
  }
}

/* Функция переключения статуса оффлайн магазина */
function toggleOfflineStore(storeId, storeName) {
  if (confirm(`Змінити статус магазину "${storeName}"?`)) {
    window.location.href = `/admin-panel/offline-store/${storeId}/toggle/`;
  }
}

/* Функция удаления оффлайн магазина */
function deleteOfflineStore(storeId, storeName) {
  if (confirm(`Ви впевнені, що хочете видалити магазин "${storeName}"?`)) {
    window.location.href = `/admin-panel/offline-store/${storeId}/delete/`;
  }
}

/* ===== ФУНКЦИИ ДЛЯ ЗАПРОПОНОВАНИХ ПРИНТОВ ===== */

/* Функция фильтрации запропонованих принтів */
function filterPrintProposals(searchTerm) {
  const proposalCards = document.querySelectorAll('.print-proposal-card');
  const proposalsCount = document.getElementById('proposals-count');
  const pendingProposalsCount = document.getElementById('pending-proposals-count');
  let visibleCount = 0;
  let visiblePendingCount = 0;
  
  searchTerm = searchTerm.toLowerCase().trim();
  
  proposalCards.forEach((card) => {
    const userName = card.getAttribute('data-user-name') || '';
    const description = card.getAttribute('data-description') || '';
    const isVisible = userName.includes(searchTerm) || description.includes(searchTerm);
    
    if (isVisible) {
      card.style.display = 'block';
      visibleCount++;
      /* Проверяем, находится ли принт на рассмотрении */
      const statusElement = card.querySelector('.status-badge');
      if (statusElement && statusElement.classList.contains('pending')) {
        visiblePendingCount++;
      }
    } else {
      card.style.display = 'none';
    }
  });
  
  /* Обновляем счетчики */
  if (proposalsCount) proposalsCount.textContent = visibleCount;
  if (pendingProposalsCount) pendingProposalsCount.textContent = visiblePendingCount;
  
  /* Показываем/скрываем кнопку очистки */
  const clearBtn = document.querySelector('.print-proposals-search-section .search-clear-btn');
  if (clearBtn) {
    clearBtn.style.display = searchTerm ? 'block' : 'none';
  }
  
  /* Показываем уведомление о результатах поиска */
  if (searchTerm) {
    showNotification(`Знайдено ${visibleCount} принтів`, 'info');
  }
}

/* Функция очистки поиска запропонованих принтів */
function clearPrintProposalsSearch() {
  const searchInput = document.getElementById('print-proposals-search');
  if (searchInput) {
    searchInput.value = '';
    filterPrintProposals('');
    searchInput.focus();
  }
}

/* Функция обновления статуса принта */
function updateProposalStatus(proposalId, status) {
  const action = status === 'approved' ? 'схвалити' : 'відхилити';
  if (confirm(`Ви впевнені, що хочете ${action} цей принт?`)) {
    const formData = new FormData();
    formData.append('proposal_id', proposalId);
    formData.append('status', status);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('/admin-panel/print-proposal/update-status/', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        /* Обновляем статус в интерфейсе */
        const statusElement = document.querySelector(`[data-proposal-id="${proposalId}"] .status-badge`);
        if (statusElement) {
          statusElement.textContent = data.new_status_text;
          statusElement.className = `status-badge ${status}`;
        }
        /* Обновляем счетчики */
        filterPrintProposals(document.getElementById('print-proposals-search').value);
      } else {
        showNotification('Помилка: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка оновлення статусу', 'error');
    });
  }
}

/* Функция награждения баллами */
function awardPoints(proposalId) {
  const points = prompt('Введіть кількість балів для нагородження:');
  if (points && !isNaN(points) && parseInt(points) > 0) {
    const formData = new FormData();
    formData.append('proposal_id', proposalId);
    formData.append('points', points);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('/admin-panel/print-proposal/award-points/', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        /* Обновляем интерфейс */
        location.reload();
      } else {
        showNotification('Помилка: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка нагородження балів', 'error');
    });
  }
}

/* Функция награждения промокодом */
function awardPromocode(proposalId) {
  const amount = prompt('Введіть суму промокоду в гривнях:');
  if (amount && !isNaN(amount) && parseInt(amount) > 0) {
    const formData = new FormData();
    formData.append('proposal_id', proposalId);
    formData.append('amount', amount);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('/admin-panel/print-proposal/award-promocode/', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showNotification(data.message, 'success');
        /* Обновляем интерфейс */
        location.reload();
      } else {
        showNotification('Помилка: ' + data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('Помилка нагородження промокодом', 'error');
    });
  }
}

/* Функция для принудительного обновления данных при переключении периодов */
document.addEventListener('DOMContentLoaded', function() {
  // Находим все кнопки периодов
  const periodButtons = document.querySelectorAll('.period-btn');
  
  periodButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      // Добавляем параметр для принудительного обновления
      const url = new URL(this.href);
      url.searchParams.set('_t', Date.now());
      this.href = url.toString();
      
      // Показываем индикатор загрузки
      const loadingIndicator = document.createElement('div');
      loadingIndicator.innerHTML = 'Завантаження...';
      loadingIndicator.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px;
        border-radius: 8px;
        z-index: 9999;
        font-size: 16px;
      `;
      document.body.appendChild(loadingIndicator);
      
      // Удаляем индикатор через 2 секунды
      setTimeout(() => {
        if (loadingIndicator.parentNode) {
          loadingIndicator.parentNode.removeChild(loadingIndicator);
        }
      }, 2000);
    });
  });
});
</script>

{% endblock %}
