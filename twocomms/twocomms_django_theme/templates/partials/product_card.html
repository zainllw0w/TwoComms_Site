{% load static %}
{% load responsive_images %}
{# form_filters удалён #}
{% with animate=animate|default_if_none:True %}
<div
  class="card product h-100 hover-raise glass {% if animate %}{% if stagger %}reveal-stagger stagger-item{% else %}reveal-fast{% endif %}{% else %}no-reveal{% endif %}"
  data-product-id="{{ p.id }}" data-product-title="{{ p.title|escapejs }}" data-product-price="{{ p.final_price }}"
  data-product-category="{{ p.category.name|default_if_none:''|escapejs }}">
  <div class="ratio ratio-product rounded-top-4 overflow-hidden bg-elevate position-relative">

    {% if p.display_image %}
    {% if eager|default_if_none:False %}
    {% optimized_image p.display_image.url p.title "w-100 h-100 object-fit-cover product-main-image" 1080 1350 loading='eager' fetchpriority='high' sizes='(max-width: 576px) 90vw, (max-width: 992px) 45vw, (max-width: 1400px) 30vw, 18vw' %}
    {% else %}
    {% optimized_image p.display_image.url p.title "w-100 h-100 object-fit-cover product-main-image" 1080 1350 fetchpriority='low' sizes='(max-width: 576px) 90vw, (max-width: 992px) 45vw, (max-width: 1400px) 30vw, 18vw' %}
    {% endif %}
    {% elif p.main_image %}
    {% if eager|default_if_none:False %}
    {% optimized_image p.main_image.url p.title "w-100 h-100 object-fit-cover product-main-image" 1080 1350 loading='eager' fetchpriority='high' sizes='(max-width: 576px) 90vw, (max-width: 992px) 45vw, (max-width: 1400px) 30vw, 18vw' %}
    {% else %}
    {% optimized_image p.main_image.url p.title "w-100 h-100 object-fit-cover product-main-image" 1080 1350 fetchpriority='low' sizes='(max-width: 576px) 90vw, (max-width: 992px) 45vw, (max-width: 1400px) 30vw, 18vw' %}
    {% endif %}
    {% else %}
    {% if eager|default_if_none:False %}
    {% optimized_image 'img/placeholder.jpg' p.title "w-100 h-100 object-fit-cover product-main-image" 1080 1350 loading='eager' fetchpriority='high' %}
    {% else %}
    {% optimized_image 'img/placeholder.jpg' p.title "w-100 h-100 object-fit-cover product-main-image" 1080 1350 %}
    {% endif %}
    {% endif %}
    <!-- Кнопка избранного -->
    <button type="button" class="favorite-btn" data-product-id="{{ p.id }}"
      onclick="event.stopPropagation(); toggleFavorite(this.getAttribute('data-product-id'), this);"
      aria-label="Додати до обраних">
      <div class="favorite-btn-icon">
        <svg class="favorite-icon-empty" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
        </svg>
        <svg class="favorite-icon-filled" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
        </svg>
      </div>
      <div class="favorite-btn-glow"></div>
    </button>
  </div>
  <div class="card-body d-flex flex-column">
    <div class="small text-secondary">{{ p.category.name }}</div>
    <a href="{% url 'product' p.slug %}"
      class="stretched-link text-decoration-none fw-semibold text-body product-title">{{ p.title }}</a>
    <div class="d-flex align-items-center gap-2 price-row">
      <div class="fw-semibold price-text" data-price="{{ p.final_price }} грн">{{ p.final_price }} грн</div>
      {% if p.has_discount %}
      <div class="text-secondary text-decoration-line-through small price-text">{{ p.price }} ₴</div>
      {% else %}
      <div class="text-secondary text-decoration-line-through small price-text placeholder-element">0 ₴</div>
      {% endif %}
      {% if p.has_discount and p.discount_percent %}
      <span class="badge text-bg-danger discount-badge">-{{ p.discount_percent }}%</span>
      {% else %}
      <span class="badge text-bg-danger discount-badge placeholder-element">-0%</span>
      {% endif %}
    </div>

    <!-- Баллы за покупку с кнопкой информации -->
    <div class="points-reward-card mt-auto position-relative">
      {% if p.points_reward > 0 %}
      <div class="d-flex align-items-center justify-content-center gap-1">
        <div class="points-icon-small">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
          </svg>
        </div>
        <span class="points-text-small">{{ p.points_reward }} балів</span>
      </div>
      <!-- Кнопка информации о баллах - поверх блока с баллами -->
      <button type="button" class="points-info-overlay-btn" data-bs-toggle="modal" data-bs-target="#pointsInfoModal"
        data-product-title="{{ p.title }}" data-points-amount="{{ p.points_reward }}" onclick="event.stopPropagation();"
        aria-label="Дізнатись про бали">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
        </svg>
      </button>
      {% else %}
      <div class="d-flex align-items-center justify-content-center gap-1">
        <div class="points-icon-small" style="visibility: hidden;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
          </svg>
        </div>
        <span class="points-text-small text-secondary">Переглянути</span>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endwith %}
