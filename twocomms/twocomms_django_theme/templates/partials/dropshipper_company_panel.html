{% load static %}
<div class="ds-company-panel" data-company-panel>
  <header class="ds-company-panel__header" data-animate>
    <span class="ds-company-panel__badge" data-fade>
      <i class="fas fa-crown" aria-hidden="true"></i>
      –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–º–ø–∞–Ω—ñ—ó
    </span>
    <h1 class="ds-company-panel__title" data-fade data-delay="80">–ê–∫—Ç—É–∞–ª—ñ–∑—É–π—Ç–µ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –±—Ä–µ–Ω–¥—É</h1>
    <p class="ds-company-panel__subtitle" data-fade data-delay="140">
      –î–∞–Ω—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è —Ä–∞—Ö—É–Ω–∫—ñ–≤, –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω—å —Ç–∞ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏. –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏, —â–æ–± –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –±–µ–∑ –∑–∞—Ç—Ä–∏–º–æ–∫.
    </p>
  </header>

  <form method="post"
        enctype="multipart/form-data"
        class="ds-company-form"
        id="ds-company-form"
        data-company-form
        action="{% url 'orders:dropshipper_company' %}">
    {% csrf_token %}
    <div class="ds-company-form__layout">
      <section class="ds-company-form__section">
        <header class="ds-company-form__section-header">
          <span class="ds-company-form__section-badge">
            <i class="fas fa-id-card" aria-hidden="true"></i>
            –û—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ
          </span>
          <h2 class="ds-company-form__section-title">–ü—Ä–µ–¥—Å—Ç–∞–≤—Ç–µ –±—Ä–µ–Ω–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º</h2>
          <p class="ds-company-form__section-text">
            –ù–∞–∑–≤–∞ —Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ–π–Ω—ñ –¥–∞–Ω—ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ —Ç–∞ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—ñ–¥ —á–∞—Å –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
          </p>
        </header>
        <div class="ds-company-form__grid">
          <label class="ds-input">
            <span class="ds-input__label">–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó / –§–û–ü *</span>
            {{ form.company_name }}
            <span class="ds-field-error" data-field-error="company_name" hidden></span>
          </label>
          <label class="ds-input">
            <span class="ds-input__label">–Ñ–î–†–ü–û–£ / –Ü–ü–ù</span>
            {{ form.company_number }}
            <span class="ds-field-error" data-field-error="company_number" hidden></span>
          </label>
          <label class="ds-input ds-input--file">
            <span class="ds-input__label">–õ–æ–≥–æ—Ç–∏–ø / –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±—Ä–µ–Ω–¥—É</span>
            {{ form.avatar }}
            <span class="ds-field-hint">–§–æ—Ä–º–∞—Ç–∏: JPG, PNG –¥–æ 5 –ú–ë</span>
            <span class="ds-field-error" data-field-error="avatar" hidden></span>
          </label>
        </div>
      </section>

      <section class="ds-company-form__section">
        <header class="ds-company-form__section-header">
          <span class="ds-company-form__section-badge">
            <i class="fas fa-headset" aria-hidden="true"></i>
            –ö–æ–Ω—Ç–∞–∫—Ç–∏
          </span>
          <h2 class="ds-company-form__section-title">–Ø–∫ –∑ –≤–∞–º–∏ –∑–≤‚Äô—è–∑–∞—Ç–∏—Å—è</h2>
          <p class="ds-company-form__section-text">
            –ê–∫—Ç—É–∞–ª—å–Ω—ñ –∫–æ–Ω—Ç–∞–∫—Ç–∏ –¥–æ–ø–æ–º–∞–≥–∞—é—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –∫–æ–æ—Ä–¥–∏–Ω—É–≤–∞—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –≤–∞—à–∏–º –∫–ª—ñ—î–Ω—Ç–∞–º —à–≤–∏–¥—à–µ.
          </p>
        </header>
        <div class="ds-company-form__grid">
          <label class="ds-input">
            <span class="ds-input__label">–û—Ñ—ñ—Ü—ñ–π–Ω–∏–π e-mail</span>
            {{ form.email }}
            <span class="ds-field-error" data-field-error="email" hidden></span>
          </label>
          <label class="ds-input">
            <span class="ds-input__label">–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—å *</span>
            {{ form.phone }}
            <span class="ds-field-error" data-field-error="phone" hidden></span>
          </label>
          <label class="ds-input">
            <span class="ds-input__label">–°–∞–π—Ç / –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</span>
            {{ form.website }}
            <span class="ds-field-error" data-field-error="website" hidden></span>
          </label>
          <label class="ds-input">
            <span class="ds-input__label">Instagram</span>
            {{ form.instagram }}
            <span class="ds-field-error" data-field-error="instagram" hidden></span>
          </label>
          <div class="ds-input">
            <span class="ds-input__label">Telegram username</span>
            <div style="display: flex; align-items: stretch; gap: 10px;">
              {{ form.telegram }}
              <div class="telegram-button-container" style="flex-shrink: 0; display: flex; align-items: center;">
                {% if user.userprofile.telegram_id %}
                  <button type="button" class="ds-btn" disabled style="
                    background: linear-gradient(135deg, #10b981, #059669);
                    border: none;
                    color: white;
                    border-radius: 10px;
                    padding: 10px 16px;
                    font-weight: 700;
                    font-size: 0.85rem;
                    cursor: not-allowed;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    opacity: 0.7;
                    white-space: nowrap;
                    height: 100%;
                  ">
                    <i class="fas fa-check-circle"></i>
                    <span>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</span>
                  </button>
                {% else %}
                  <button type="button" class="ds-btn telegram-confirm-btn" onclick="confirmDropshipperTelegram()" style="
                    background: linear-gradient(135deg, #8b5cf6, #6366f1);
                    border: none;
                    color: white;
                    border-radius: 10px;
                    padding: 10px 16px;
                    font-weight: 700;
                    font-size: 0.85rem;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    white-space: nowrap;
                    height: 100%;
                  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(139,92,246,.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <i class="fab fa-telegram"></i>
                    <span>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</span>
                  </button>
                {% endif %}
              </div>
            </div>
            <span class="ds-field-error" data-field-error="telegram" hidden></span>
          </div>
        </div>
        
        {# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ –æ Telegram #}
        <div class="ds-telegram-link-block" style="
          background: linear-gradient(135deg, rgba(139,92,246,.12), rgba(99,102,241,.08));
          border: 1px solid rgba(139,92,246,.25);
          border-radius: 12px;
          padding: 20px;
          margin-top: 20px;
        ">
          <div style="display: flex; align-items: flex-start; gap: 16px;">
            <div style="
              width: 48px;
              height: 48px;
              background: linear-gradient(135deg, #8b5cf6, #6366f1);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.5rem;
              flex-shrink: 0;
            ">
              <i class="fab fa-telegram" style="color: white;"></i>
            </div>
            <div style="flex: 1;">
              <h3 style="
                color: #e5e7eb;
                font-size: 1.1rem;
                font-weight: 700;
                margin: 0 0 8px 0;
              ">
                üì± –û—Ç—Ä–∏–º—É–π—Ç–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ Telegram
              </h3>
              <p style="
                color: rgba(229,231,235,.7);
                font-size: 0.95rem;
                line-height: 1.6;
                margin: 0 0 16px 0;
              ">
                –ü—Ä–∏–≤'—è–∂—ñ—Ç—å —Å–≤—ñ–π Telegram, —â–æ–± –º–∏—Ç—Ç—î–≤–æ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, –∑–º—ñ–Ω—É —Å—Ç–∞—Ç—É—Å—ñ–≤, –æ–ø–ª–∞—Ç–∏ —Ç–∞ —ñ–Ω—à—ñ –≤–∞–∂–ª–∏–≤—ñ –ø–æ–¥—ñ—ó.
              </p>
              <div style="
                background: rgba(245,158,11,.15);
                border: 1px solid rgba(245,158,11,.3);
                border-radius: 8px;
                padding: 12px;
              ">
                <p style="
                  color: rgba(229,231,235,.85);
                  font-size: 0.9rem;
                  line-height: 1.5;
                  margin: 0;
                ">
                  <strong style="color: #fbbf24;">üìù –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:</strong><br>
                  1Ô∏è‚É£ –í–≤–µ–¥—ñ—Ç—å –≤–∞—à Telegram username –≤–∏—â–µ (–∑ @ –∞–±–æ –±–µ–∑)<br>
                  2Ô∏è‚É£ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏" –ø—Ä–∞–≤–æ—Ä—É—á –≤—ñ–¥ –ø–æ–ª—è<br>
                  3Ô∏è‚É£ –ù–∞–ø–∏—à—ñ—Ç—å –±–æ—Ç—É <strong>–±—É–¥—å-—è–∫–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ—Ç—è–≥–æ–º 5 —Ö–≤–∏–ª–∏–Ω</strong><br>
                  4Ô∏è‚É£ –ì–æ—Ç–æ–≤–æ! –í–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="ds-company-form__section ds-company-form__section--accent">
        <header class="ds-company-form__section-header">
          <span class="ds-company-form__section-badge">
            <i class="fas fa-credit-card" aria-hidden="true"></i>
            –í–∏–ø–ª–∞—Ç–∏
          </span>
          <h2 class="ds-company-form__section-title">–†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–∫–∞–∑—ñ–≤</h2>
          <p class="ds-company-form__section-text">
            –í–∫–∞–∂—ñ—Ç—å IBAN –∞–±–æ –∫–∞—Ä—Ç—É –±–∞–Ω–∫—É, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–∏–ø–ª–∞—Ç. –ú–∏ –∑–±–µ—Ä–µ–∂–µ–º–æ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ —É —à–∏—Ñ—Ä–æ–≤–∞–Ω–æ–º—É –≤–∏–≥–ª—è–¥—ñ.
          </p>
        </header>
        <div class="ds-company-form__grid ds-company-form__grid--single">
          <label class="ds-input ds-input--full">
            <span class="ds-input__label">–†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –≤–∏–ø–ª–∞—Ç</span>
            {{ form.payment_details }}
            <span class="ds-field-error" data-field-error="payment_details" hidden></span>
          </label>
        </div>
      </section>
    </div>

    <div class="ds-company-form__footer">
      <div class="ds-company-form__status" data-company-success hidden>
        <i class="fas fa-check-circle" aria-hidden="true"></i>
        <span>–î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ</span>
      </div>
      <button type="submit" class="ds-btn ds-btn--primary" data-company-submit>
        <i class="fas fa-floppy-disk" aria-hidden="true"></i>
        <span>–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏</span>
      </button>
    </div>
  </form>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Telegram –¥—Ä–æ–ø—à–∏–ø–µ—Ä–∞
function confirmDropshipperTelegram() {
  const telegramInput = document.querySelector('input[name="telegram"]');
  let telegramUsername = telegramInput.value.trim();
  
  if (!telegramUsername) {
    alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à Telegram username');
    return;
  }
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º @ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
  if (!telegramUsername.startsWith('@')) {
    telegramUsername = '@' + telegramUsername;
    telegramInput.value = telegramUsername;
  }
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram –±–æ—Ç–∞
  const botUrl = 'https://t.me/twocommsbot?start=' + encodeURIComponent(telegramUsername);
  window.open(botUrl, '_blank');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
  alert('–í—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è Telegram –±–æ—Ç. –ù–∞–ø–∏—à—ñ—Ç—å –±—É–¥—å-—è–∫–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø—Ä–æ—Ç—è–≥–æ–º 5 —Ö–≤–∏–ª–∏–Ω. –°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  showDropshipperTelegramLoadingIndicator();
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (csrfToken) {
    startDropshipperTelegramStatusCheck();
  } else {
    hideDropshipperTelegramLoadingIndicator();
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Telegram
function checkDropshipperTelegramStatus() {
  fetch('/accounts/telegram/status/', {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'same-origin'
  })
  .then(response => response.json())
  .then(data => {
    if (data.telegram_confirmed) {
      // Telegram –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
      hideDropshipperTelegramLoadingIndicator();
      updateDropshipperTelegramButton(true);
      stopDropshipperTelegramStatusCheck();
    }
  })
  .catch(error => {
    console.error('Error checking Telegram status:', error);
  });
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
let dropshipperTelegramCheckInterval;
function startDropshipperTelegramStatusCheck() {
  checkDropshipperTelegramStatus();
  dropshipperTelegramCheckInterval = setInterval(checkDropshipperTelegramStatus, 5000); // –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
  setTimeout(stopDropshipperTelegramStatusCheck, 5 * 60 * 1000);
}

function stopDropshipperTelegramStatusCheck() {
  if (dropshipperTelegramCheckInterval) {
    clearInterval(dropshipperTelegramCheckInterval);
    dropshipperTelegramCheckInterval = null;
    hideDropshipperTelegramLoadingIndicator();
  }
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
function showDropshipperTelegramLoadingIndicator() {
  const buttonContainer = document.querySelector('.telegram-button-container');
  if (buttonContainer) {
    const existingBtn = buttonContainer.querySelector('.telegram-confirm-btn');
    if (existingBtn) {
      existingBtn.innerHTML = `
        <svg class="spinner" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10" stroke-width="4" stroke-opacity="0.25"/>
          <path d="M12 2a10 10 0 0 1 10 10" stroke-width="4" stroke-linecap="round"/>
        </svg>
        <span>–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è...</span>
      `;
      existingBtn.disabled = true;
      existingBtn.style.opacity = '0.7';
      existingBtn.style.cursor = 'not-allowed';
    }
  }
}

function hideDropshipperTelegramLoadingIndicator() {
  const buttonContainer = document.querySelector('.telegram-button-container');
  if (buttonContainer) {
    const existingBtn = buttonContainer.querySelector('.telegram-confirm-btn');
    if (existingBtn && !existingBtn.classList.contains('confirmed')) {
      existingBtn.innerHTML = `
        <i class="fab fa-telegram"></i>
        <span>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ Telegram</span>
      `;
      existingBtn.disabled = false;
      existingBtn.style.opacity = '1';
      existingBtn.style.cursor = 'pointer';
    }
  }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
function updateDropshipperTelegramButton(confirmed) {
  const buttonContainer = document.querySelector('.telegram-button-container');
  if (buttonContainer && confirmed) {
    buttonContainer.innerHTML = `
      <button type="button" class="ds-btn" disabled style="
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        color: white;
        border-radius: 10px;
        padding: 12px 20px;
        font-weight: 700;
        font-size: 0.95rem;
        cursor: not-allowed;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        opacity: 0.7;
      ">
        <i class="fas fa-check-circle"></i>
        <span>Telegram –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</span>
      </button>
    `;
  }
}

// –°—Ç–∏–ª–∏ –¥–ª—è spinner
const style = document.createElement('style');
style.textContent = `
  .spinner {
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);
</script>
