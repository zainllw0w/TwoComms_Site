<div class="ds-container">
  <section class="ds-section ds-orders-hero" data-animate>
    <header class="ds-section__header">
      <div>
        <h1 class="ds-section__title">Замовлення ваших клієнтів</h1>
        <p class="ds-section__subtitle">
          Контролюйте статуси, оплату та склад замовлення. Усе необхідне для роботи з клієнтами — в одній таблиці.
        </p>
      </div>
      <div class="ds-actions">
        <button type="button" class="ds-btn ds-btn--primary js-open-order-modal">
          <i class="fas fa-plus" aria-hidden="true"></i>
          <span>Нове замовлення</span>
        </button>
        <a href="{% url 'orders:dropshipper_dashboard' %}" class="ds-btn ds-btn--ghost" data-tab-link="main">
          <i class="fas fa-home" aria-hidden="true"></i>
          <span>На головну</span>
        </a>
      </div>
    </header>

    <form method="get" class="ds-orders-filter">
      <label class="ds-orders-filter__label" for="order-status">Статус</label>
      <div class="ds-select">
        <select id="order-status" name="status" onchange="this.form.submit()">
          <option value="">Усі замовлення</option>
          {% for value, label in status_choices %}
            <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      {% if selected_status %}
        <a href="{% url 'orders:dropshipper_orders' %}" class="ds-link ds-link--reset">Скинути</a>
      {% endif %}
    </form>
  </section>

  <section class="ds-section ds-orders-list" data-animate>
    {% if page_obj and page_obj.object_list %}
      <div class="ds-orders-table">
        {% for order in page_obj %}
          <article class="ds-order-entry" data-fade style="
            background: linear-gradient(135deg, rgba(20,22,27,.95), rgba(14,16,22,.95));
            border: 1px solid rgba(255,255,255,.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,.3);
          ">
            <header class="ds-order-entry__header" style="
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              margin-bottom: 20px;
              padding-bottom: 20px;
              border-bottom: 1px solid rgba(255,255,255,.08);
            ">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <span class="ds-pill ds-pill--ghost" style="
                    background: rgba(139,92,246,.15);
                    border: 1px solid rgba(139,92,246,.3);
                    color: #a78bfa;
                    padding: 6px 12px;
                    border-radius: 8px;
                    font-size: 0.85rem;
                    font-weight: 600;
                  ">
                    <i class="fas fa-hashtag" aria-hidden="true"></i>
                    {{ order.order_number }}
                  </span>
                  {% if order.status == 'draft' %}
                    <span style="
                      background: rgba(234,179,8,.15);
                      border: 1px solid rgba(234,179,8,.3);
                      color: #fbbf24;
                      padding: 4px 10px;
                      border-radius: 6px;
                      font-size: 0.75rem;
                      font-weight: 600;
                    ">
                      <i class="fas fa-clock" aria-hidden="true"></i>
                      Потребує підтвердження
                    </span>
                  {% endif %}
                </div>
                <h2 style="margin: 0 0 8px; font-size: 1.3rem; font-weight: 700; color: #e5e7eb;">
                  {{ order.client_name|default:"Без назви" }}
                </h2>
                <p style="margin: 0; font-size: 0.9rem; color: rgba(229,231,235,.6);">
                  <i class="fas fa-calendar" aria-hidden="true"></i>
                  {{ order.created_at|date:"d.m.Y H:i" }}
                  {% if order.tracking_number %}
                    · <i class="fas fa-truck" aria-hidden="true"></i>
                    TTN: <strong style="color: #10b981;">{{ order.tracking_number }}</strong>
                  {% endif %}
                </p>
              </div>
              <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                <span class="ds-status" style="
                  {% if order.status == 'delivered' %}
                    background: linear-gradient(135deg, rgba(16,185,129,.2), rgba(5,150,105,.2));
                    border: 1px solid rgba(16,185,129,.4);
                    color: #10b981;
                  {% elif order.status == 'cancelled' %}
                    background: linear-gradient(135deg, rgba(239,68,68,.2), rgba(220,38,38,.2));
                    border: 1px solid rgba(239,68,68,.4);
                    color: #ef4444;
                  {% elif order.status == 'shipped' %}
                    background: linear-gradient(135deg, rgba(59,130,246,.2), rgba(37,99,235,.2));
                    border: 1px solid rgba(59,130,246,.4);
                    color: #3b82f6;
                  {% else %}
                    background: linear-gradient(135deg, rgba(139,92,246,.2), rgba(124,58,237,.2));
                    border: 1px solid rgba(139,92,246,.4);
                    color: #8b5cf6;
                  {% endif %}
                  padding: 8px 16px;
                  border-radius: 10px;
                  font-size: 0.85rem;
                  font-weight: 700;
                  text-align: center;
                ">
                  <i class="fas {% if order.status == 'delivered' %}fa-check-circle{% elif order.status == 'cancelled' %}fa-times-circle{% elif order.status == 'shipped' %}fa-truck{% else %}fa-hourglass-half{% endif %}" aria-hidden="true"></i>
                  {{ order.get_status_display }}
                </span>
                <span class="ds-payment-status" style="
                  {% if order.payment_status == 'paid' %}
                    background: rgba(16,185,129,.15);
                    border: 1px solid rgba(16,185,129,.3);
                    color: #10b981;
                  {% else %}
                    background: rgba(234,179,8,.15);
                    border: 1px solid rgba(234,179,8,.3);
                    color: #fbbf24;
                  {% endif %}
                  padding: 6px 12px;
                  border-radius: 8px;
                  font-size: 0.8rem;
                  font-weight: 600;
                ">
                  <i class="fas fa-credit-card" aria-hidden="true"></i>
                  {{ order.get_payment_status_display }}
                </span>
              </div>
            </header>

            <div class="ds-order-entry__body">
              <div class="ds-order-entry__col">
                <span class="ds-order-entry__label">Контакти клієнта</span>
                <div class="ds-order-entry__value">
                  <i class="fas fa-phone" aria-hidden="true"></i>
                  <span>{{ order.client_phone|default:"—" }}</span>
                </div>
                {% if order.client_np_address %}
                  <div class="ds-order-entry__value">
                    <i class="fas fa-location-dot" aria-hidden="true"></i>
                    <span>{{ order.client_np_address }}</span>
                  </div>
                {% endif %}
              </div>

              <div class="ds-order-entry__col">
                <span class="ds-order-entry__label">Фінанси</span>
                <div class="ds-order-entry__metrics">
                  <div>
                    <small>Сума продажу</small>
                    <strong>{{ order.total_selling_price|floatformat:0 }} грн</strong>
                  </div>
                  <div>
                    <small>Собівартість</small>
                    <strong>{{ order.total_drop_price|floatformat:0 }} грн</strong>
                  </div>
                  <div>
                    <small>Прибуток</small>
                    <strong>{{ order.profit|floatformat:0 }} грн</strong>
                  </div>
                </div>
              </div>

              <div class="ds-order-entry__col">
                <span class="ds-order-entry__label">Дії</span>
                <div class="ds-order-entry__actions">
                  <div class="ds-order-status-actions">
                    {% if order.status == 'draft' %}
                      <button type="button" class="ds-btn ds-btn--sm ds-btn--primary" 
                              data-order-status-update data-order-id="{{ order.id }}" data-new-status="pending">
                        <i class="fas fa-paper-plane" aria-hidden="true"></i>
                        Підтвердити
                      </button>
                    {% elif order.status == 'pending' %}
                      <button type="button" class="ds-btn ds-btn--sm ds-btn--success" 
                              data-order-status-update data-order-id="{{ order.id }}" data-new-status="confirmed">
                        <i class="fas fa-check" aria-hidden="true"></i>
                        Підтвердити
                      </button>
                    {% elif order.status == 'confirmed' %}
                      <button type="button" class="ds-btn ds-btn--sm ds-btn--info" 
                              data-order-status-update data-order-id="{{ order.id }}" data-new-status="processing">
                        <i class="fas fa-cog" aria-hidden="true"></i>
                        В обробку
                      </button>
                    {% elif order.status == 'processing' %}
                      <button type="button" class="ds-btn ds-btn--sm ds-btn--warning" 
                              data-order-status-update data-order-id="{{ order.id }}" data-new-status="shipped">
                        <i class="fas fa-truck" aria-hidden="true"></i>
                        Відправити
                      </button>
                    {% elif order.status == 'shipped' %}
                      <button type="button" class="ds-btn ds-btn--sm ds-btn--success" 
                              data-order-status-update data-order-id="{{ order.id }}" data-new-status="delivered">
                        <i class="fas fa-check-circle" aria-hidden="true"></i>
                        Доставлено
                      </button>
                    {% endif %}
                    
                    {% if order.status != 'delivered' and order.status != 'cancelled' %}
                      <button type="button" class="ds-btn ds-btn--sm ds-btn--danger" 
                              data-order-status-update data-order-id="{{ order.id }}" data-new-status="cancelled">
                        <i class="fas fa-times" aria-hidden="true"></i>
                        Скасувати
                      </button>
                    {% endif %}
                  </div>
                  
                  <a href="{% url 'orders:dropshipper_statistics' %}?order={{ order.id }}" class="ds-link ds-link--arrow" data-tab-link="statistics">
                    До статистики
                    <i class="fas fa-arrow-right" aria-hidden="true"></i>
                  </a>
                  
                  {% if order.status == 'delivered' and order.payment_status != 'paid' %}
                    <span class="ds-tag ds-tag--warning">Очікує виплати</span>
                  {% endif %}
                </div>
              </div>
            </div>

            {% if order.items.all %}
              <details class="ds-order-entry__items">
                <summary>
                  <span>
                    <i class="fas fa-box-open" aria-hidden="true"></i>
                    {{ order.items.count }} позицій у замовленні
                  </span>
                  <i class="fas fa-chevron-down" aria-hidden="true"></i>
                </summary>
                <ul>
                  {% for item in order.items.all %}
                    <li>
                      <span>{{ item.product.title }}</span>
                      <span class="ds-order-entry__item-qty">×{{ item.quantity }}</span>
                      <span class="ds-order-entry__item-price">{{ item.total_selling_price|floatformat:0 }} грн</span>
                    </li>
                  {% endfor %}
                </ul>
              </details>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="ds-empty">
        <i class="fas fa-inbox" aria-hidden="true"></i>
        <h3 class="ds-empty__title">Замовлень поки немає</h3>
        <p class="ds-empty__text">Створіть перше замовлення — система проведе вас крок за кроком.</p>
        <button type="button" class="ds-btn ds-btn--primary js-open-order-modal">
          <i class="fas fa-plus" aria-hidden="true"></i>
          <span>Створити замовлення</span>
        </button>
      </div>
    {% endif %}
  </section>

  {% if page_obj.paginator.num_pages > 1 %}
    <nav class="ds-pagination" aria-label="Пагінація замовлень">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if selected_status %}&status={{ selected_status }}{% endif %}"
           class="ds-pagination__link">
          <i class="fas fa-chevron-left" aria-hidden="true"></i>
          Попередня
        </a>
      {% else %}
        <span class="ds-pagination__link ds-pagination__link--disabled">
          <i class="fas fa-chevron-left" aria-hidden="true"></i>
          Попередня
        </span>
      {% endif %}

      <span class="ds-pagination__current">Сторінка {{ page_obj.number }} з {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if selected_status %}&status={{ selected_status }}{% endif %}"
           class="ds-pagination__link">
          <i class="fas fa-chevron-right" aria-hidden="true"></i>
          Наступна
        </a>
      {% else %}
        <span class="ds-pagination__link ds-pagination__link--disabled">
          <i class="fas fa-chevron-right" aria-hidden="true"></i>
          Наступна
        </span>
      {% endif %}
    </nav>
  {% endif %}
</div>
