{% load static %}

{# Диспетчер - UTM Analytics & Tracking #}
<div class="dispatcher-section">
  
  {# Header with Period Filter #}
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h2 style="font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, #8b5cf6, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 10px;">
        <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
      </svg>
      Диспетчер UTM-аналітики
    </h2>
    
    {# Period Filter #}
    <div style="display: flex; gap: 8px;">
      {% for p in periods %}
        <a href="?section=dispatcher&period={{ p.value }}" 
           class="period-btn {% if period == p.value %}active{% endif %}"
           style="padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; text-decoration: none; {% if period == p.value %}background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white;{% else %}background: rgba(255,255,255,.05); color: rgba(229,231,235,.6);{% endif %}">
          {{ p.label }}
        </a>
      {% endfor %}
    </div>
  </div>

  {# General Stats Cards #}
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="background: linear-gradient(145deg, rgba(139,92,246,.15), rgba(99,102,241,.15)); border: 1px solid rgba(139,92,246,.3); border-radius: 16px; padding: 24px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(139,92,246,.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
      <div style="font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, #8b5cf6, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">{{ general_stats.total_sessions }}</div>
      <div style="font-size: 0.9rem; color: rgba(229,231,235,.6); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Всього сесій</div>
    </div>
    
    <div style="background: linear-gradient(145deg, rgba(139,92,246,.15), rgba(99,102,241,.15)); border: 1px solid rgba(139,92,246,.3); border-radius: 16px; padding: 24px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(139,92,246,.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
      <div style="font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, #10b981, #059669); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">{{ general_stats.total_conversions }}</div>
      <div style="font-size: 0.9rem; color: rgba(229,231,235,.6); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Конверсій</div>
      <div style="font-size: 0.8rem; color: #34d399; margin-top: 4px;">{{ general_stats.conversion_rate }}%</div>
    </div>
    
    <div style="background: linear-gradient(145deg, rgba(139,92,246,.15), rgba(99,102,241,.15)); border: 1px solid rgba(139,92,246,.3); border-radius: 16px; padding: 24px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(139,92,246,.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
      <div style="font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, #f59e0b, #d97706); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">{{ general_stats.total_revenue|floatformat:0 }} ₴</div>
      <div style="font-size: 0.9rem; color: rgba(229,231,235,.6); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Дохід</div>
      <div style="font-size: 0.8rem; color: rgba(229,231,235,.5); margin-top: 4px;">Середній чек: {{ general_stats.avg_order_value|floatformat:0 }} ₴</div>
    </div>
    
    <div style="background: linear-gradient(145deg, rgba(139,92,246,.15), rgba(99,102,241,.15)); border: 1px solid rgba(139,92,246,.3); border-radius: 16px; padding: 24px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(139,92,246,.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
      <div style="font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, #ec4899, #db2777); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">{{ general_stats.unique_visitors }}</div>
      <div style="font-size: 0.9rem; color: rgba(229,231,235,.6); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Унікальні відвідувачі</div>
    </div>
  </div>

  {# Conversion Funnel #}
  <div style="background: linear-gradient(145deg, rgba(24,26,31,.98), rgba(18,20,24,.98)); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; padding: 30px; margin-bottom: 30px;">
    <h3 style="font-size: 1.5rem; font-weight: 700; color: #e5e7eb; margin-bottom: 20px;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
      </svg>
      Воронка конверсій
    </h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
      <div style="text-align: center; padding: 16px; background: rgba(139,92,246,.1); border-radius: 12px;">
        <div style="font-size: 2rem; font-weight: 700; color: #a78bfa;">{{ funnel_stats.total }}</div>
        <div style="font-size: 0.85rem; color: rgba(229,231,235,.6); margin-top: 4px;">Сесії</div>
        <div style="font-size: 0.75rem; color: rgba(229,231,235,.4); margin-top: 2px;">100%</div>
      </div>
      
      <div style="text-align: center; padding: 16px; background: rgba(59,130,246,.1); border-radius: 12px;">
        <div style="font-size: 2rem; font-weight: 700; color: #60a5fa;">{{ funnel_stats.product_views }}</div>
        <div style="font-size: 0.85rem; color: rgba(229,231,235,.6); margin-top: 4px;">Перегляди товарів</div>
        <div style="font-size: 0.75rem; color: #60a5fa; margin-top: 2px;">{{ funnel_stats.product_views_rate }}%</div>
      </div>
      
      <div style="text-align: center; padding: 16px; background: rgba(16,185,129,.1); border-radius: 12px;">
        <div style="font-size: 2rem; font-weight: 700; color: #34d399;">{{ funnel_stats.add_to_cart }}</div>
        <div style="font-size: 0.85rem; color: rgba(229,231,235,.6); margin-top: 4px;">В кошик</div>
        <div style="font-size: 0.75rem; color: #34d399; margin-top: 2px;">{{ funnel_stats.add_to_cart_rate }}%</div>
      </div>
      
      <div style="text-align: center; padding: 16px; background: rgba(245,158,11,.1); border-radius: 12px;">
        <div style="font-size: 2rem; font-weight: 700; color: #fbbf24;">{{ funnel_stats.initiate_checkout }}</div>
        <div style="font-size: 0.85rem; color: rgba(229,231,235,.6); margin-top: 4px;">Оформлення</div>
        <div style="font-size: 0.75rem; color: #fbbf24; margin-top: 2px;">{{ funnel_stats.checkout_rate }}%</div>
      </div>
      
      <div style="text-align: center; padding: 16px; background: rgba(236,72,153,.1); border-radius: 12px;">
        <div style="font-size: 2rem; font-weight: 700; color: #f472b6;">{{ funnel_stats.leads }}</div>
        <div style="font-size: 0.85rem; color: rgba(229,231,235,.6); margin-top: 4px;">Ліди</div>
        <div style="font-size: 0.75rem; color: #f472b6; margin-top: 2px;">{{ funnel_stats.lead_rate }}%</div>
      </div>
      
      <div style="text-align: center; padding: 16px; background: rgba(16,185,129,.15); border-radius: 12px;">
        <div style="font-size: 2rem; font-weight: 700; color: #10b981;">{{ funnel_stats.purchases }}</div>
        <div style="font-size: 0.85rem; color: rgba(229,231,235,.6); margin-top: 4px;">Покупки</div>
        <div style="font-size: 0.75rem; color: #10b981; margin-top: 2px;">{{ funnel_stats.purchase_rate }}%</div>
      </div>
    </div>
  </div>

  {# Sources Stats Table #}
  <div style="background: linear-gradient(145deg, rgba(24,26,31,.98), rgba(18,20,24,.98)); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; padding: 30px; margin-bottom: 30px;">
    <h3 style="font-size: 1.5rem; font-weight: 700; color: #e5e7eb; margin-bottom: 20px;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
      </svg>
      Джерела трафіку (Top 20)
    </h3>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid rgba(255,255,255,.1);">
            <th style="padding: 12px; text-align: left; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Джерело</th>
            <th style="padding: 12px; text-align: center; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Сесії</th>
            <th style="padding: 12px; text-align: center; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Конверсії</th>
            <th style="padding: 12px; text-align: center; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">CR%</th>
            <th style="padding: 12px; text-align: right; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Дохід</th>
            <th style="padding: 12px; text-align: right; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Сер. чек</th>
          </tr>
        </thead>
        <tbody>
          {% for source in sources_stats %}
            <tr style="border-bottom: 1px solid rgba(255,255,255,.05); transition: background 0.2s;" onmouseover="this.style.background='rgba(139,92,246,.05)'" onmouseout="this.style.background='transparent'">
              <td style="padding: 12px; font-weight: 600; color: #a78bfa;">{{ source.utm_source }}</td>
              <td style="padding: 12px; text-align: center; color: #e5e7eb;">{{ source.sessions }}</td>
              <td style="padding: 12px; text-align: center; color: #34d399;">{{ source.conversions }}</td>
              <td style="padding: 12px; text-align: center; {% if source.conversion_rate >= 5 %}color: #10b981;{% elif source.conversion_rate >= 2 %}color: #fbbf24;{% else %}color: #f87171;{% endif %}">{{ source.conversion_rate }}%</td>
              <td style="padding: 12px; text-align: right; color: #60a5fa;">{{ source.revenue|floatformat:0 }} ₴</td>
              <td style="padding: 12px; text-align: right; color: rgba(229,231,235,.7);">{{ source.avg_order_value|floatformat:0 }} ₴</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" style="padding: 24px; text-align: center; color: rgba(229,231,235,.4);">Немає даних за вибраний період</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {# Campaigns Stats #}
  <div style="background: linear-gradient(145deg, rgba(24,26,31,.98), rgba(18,20,24,.98)); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; padding: 30px; margin-bottom: 30px;">
    <h3 style="font-size: 1.5rem; font-weight: 700; color: #e5e7eb; margin-bottom: 20px;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
      </svg>
      Кампанії (Top 20)
    </h3>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid rgba(255,255,255,.1);">
            <th style="padding: 12px; text-align: left; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Кампанія</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Джерело</th>
            <th style="padding: 12px; text-align: center; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Сесії</th>
            <th style="padding: 12px; text-align: center; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Конверсії</th>
            <th style="padding: 12px; text-align: center; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">CR%</th>
            <th style="padding: 12px; text-align: right; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Дохід</th>
          </tr>
        </thead>
        <tbody>
          {% for campaign in campaigns_stats %}
            <tr style="border-bottom: 1px solid rgba(255,255,255,.05); transition: background 0.2s;" onmouseover="this.style.background='rgba(139,92,246,.05)'" onmouseout="this.style.background='transparent'">
              <td style="padding: 12px; font-weight: 600; color: #60a5fa;">{{ campaign.utm_campaign }}</td>
              <td style="padding: 12px; color: rgba(229,231,235,.6);">{{ campaign.utm_source }}</td>
              <td style="padding: 12px; text-align: center; color: #e5e7eb;">{{ campaign.sessions }}</td>
              <td style="padding: 12px; text-align: center; color: #34d399;">{{ campaign.conversions }}</td>
              <td style="padding: 12px; text-align: center; {% if campaign.conversion_rate >= 5 %}color: #10b981;{% elif campaign.conversion_rate >= 2 %}color: #fbbf24;{% else %}color: #f87171;{% endif %}">{{ campaign.conversion_rate }}%</td>
              <td style="padding: 12px; text-align: right; color: #60a5fa;">{{ campaign.revenue|floatformat:0 }} ₴</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" style="padding: 24px; text-align: center; color: rgba(229,231,235,.4);">Немає даних за вибраний період</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {# Two columns: Device Stats & Geo Stats #}
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
    {# Device Stats #}
    <div style="background: linear-gradient(145deg, rgba(24,26,31,.98), rgba(18,20,24,.98)); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; padding: 30px;">
      <h3 style="font-size: 1.3rem; font-weight: 700; color: #e5e7eb; margin-bottom: 20px;">Пристрої</h3>
      
      {% for device in device_stats %}
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #e5e7eb; font-weight: 600;">{{ device.device_type }}</span>
            <span style="color: #a78bfa;">{{ device.sessions }} ({{ device.conversion_rate }}%)</span>
          </div>
          <div style="background: rgba(255,255,255,.05); border-radius: 8px; height: 8px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, #8b5cf6, #6366f1); height: 100%; border-radius: 8px; width: {% widthratio device.sessions 100 100 %}%;"></div>
          </div>
        </div>
      {% empty %}
        <p style="color: rgba(229,231,235,.4); text-align: center;">Немає даних</p>
      {% endfor %}
    </div>

    {# Geo Stats - Countries #}
    <div style="background: linear-gradient(145deg, rgba(24,26,31,.98), rgba(18,20,24,.98)); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; padding: 30px;">
      <h3 style="font-size: 1.3rem; font-weight: 700; color: #e5e7eb; margin-bottom: 20px;">Географія (Країни)</h3>
      
      {% for country in geo_stats.countries|slice:":5" %}
        <div style="margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #e5e7eb; font-weight: 600;">{{ country.country }}</span>
            <span style="color: #34d399;">{{ country.sessions }} ({{ country.conversion_rate }}%)</span>
          </div>
          <div style="background: rgba(255,255,255,.05); border-radius: 8px; height: 8px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; border-radius: 8px; width: {% widthratio country.sessions 100 100 %}%;"></div>
          </div>
        </div>
      {% empty %}
        <p style="color: rgba(229,231,235,.4); text-align: center;">Немає даних</p>
      {% endfor %}
    </div>
  </div>

  {# Recent Sessions #}
  <div style="background: linear-gradient(145deg, rgba(24,26,31,.98), rgba(18,20,24,.98)); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; padding: 30px;">
    <h3 style="font-size: 1.5rem; font-weight: 700; color: #e5e7eb; margin-bottom: 20px;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>
      Останні сесії
    </h3>
    
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid rgba(255,255,255,.1);">
            <th style="padding: 12px; text-align: left; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Дата</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Джерело</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Кампанія</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Пристрій</th>
            <th style="padding: 12px; text-align: left; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Локація</th>
            <th style="padding: 12px; text-align: center; font-weight: 600; color: rgba(229,231,235,.6); font-size: 0.85rem; text-transform: uppercase;">Конверсія</th>
          </tr>
        </thead>
        <tbody>
          {% for session in recent_sessions|slice:":30" %}
            <tr style="border-bottom: 1px solid rgba(255,255,255,.05); transition: background 0.2s;" onmouseover="this.style.background='rgba(139,92,246,.05)'" onmouseout="this.style.background='transparent'">
              <td style="padding: 12px; color: rgba(229,231,235,.6); font-size: 0.85rem;">{{ session.first_seen|date:"d.m.Y H:i" }}</td>
              <td style="padding: 12px; color: #a78bfa; font-weight: 600;">{{ session.utm_source|default:"direct" }}</td>
              <td style="padding: 12px; color: #60a5fa;">{{ session.utm_campaign|default:"—" }}</td>
              <td style="padding: 12px; color: rgba(229,231,235,.6);">{{ session.device_type|default:"unknown" }}</td>
              <td style="padding: 12px; color: rgba(229,231,235,.6);">{{ session.city|default:"—" }}, {{ session.country|default:"—" }}</td>
              <td style="padding: 12px; text-align: center;">
                {% if session.is_converted %}
                  <span style="color: #10b981; font-weight: 600;">✓ {{ session.conversion_type }}</span>
                {% else %}
                  <span style="color: rgba(229,231,235,.3);">—</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" style="padding: 24px; text-align: center; color: rgba(229,231,235,.4);">Немає даних за вибраний період</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
