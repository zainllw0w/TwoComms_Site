{% load static %}

{# –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è –°–ø—ñ–≤–ø—Ä–∞—Ü—è —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º #}

<style>
.collab-mode-switcher {
  display: flex;
  background: rgba(255,255,255,.05);
  border-radius: 16px;
  padding: 6px;
  margin-bottom: 30px;
  gap: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
}
.collab-mode-btn {
  flex: 1;
  padding: 16px 24px;
  border-radius: 12px;
  border: none;
  font-weight: 800;
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  background: transparent;
  color: rgba(229,231,235,.5);
  position: relative;
  overflow: hidden;
}
.collab-mode-btn.active {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  color: white;
  box-shadow: 0 8px 24px rgba(139,92,246,.4);
  transform: translateY(-2px);
}
.collab-mode-btn:not(.active):hover {
  background: rgba(255,255,255,.08);
  color: rgba(229,231,235,.8);
}
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,.8);
  backdrop-filter: blur(8px);
  z-index: 99998;
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-overlay.active {
  display: flex;
}
.edit-modal {
  background: linear-gradient(145deg, rgba(24,26,31,.98), rgba(18,20,24,.98));
  border: 1px solid rgba(139,92,246,.3);
  border-radius: 20px;
  padding: 32px;
  max-width: 800px;
  width: 90vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 60px rgba(0,0,0,.8);
  position: relative;
}
.form-group {
  margin-bottom: 20px;
}
.form-label {
  display: block;
  font-size: 0.85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: rgba(229,231,235,.6);
  margin-bottom: 8px;
}
.form-input, .form-select {
  width: 100%;
  padding: 12px 16px;
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.15);
  border-radius: 10px;
  color: #e5e7eb;
  font-size: 0.95rem;
  transition: all 0.2s;
}
.form-input:focus, .form-select:focus {
  outline: none;
  border-color: rgba(139,92,246,.5);
  background: rgba(255,255,255,.08);
  box-shadow: 0 0 0 3px rgba(139,92,246,.1);
}
</style>

{# –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ - –°–í–ï–†–•–£ #}
<div class="collab-mode-switcher">
  <button class="collab-mode-btn active" id="mode-dropship" onclick="switchCollabMode('dropship')">
    <i class="fas fa-shipping-fast"></i> –î—Ä–æ–ø—à–∏–ø—ñ–Ω–≥
    <small style="display: block; font-size: 0.8rem; font-weight: 600; margin-top: 4px; opacity: 0.8;">{{ dropship_orders|length }} –∑–∞–º–æ–≤–ª–µ–Ω—å</small>
  </button>
  <button class="collab-mode-btn" id="mode-wholesale" onclick="switchCollabMode('wholesale')">
    <i class="fas fa-file-invoice"></i> –û–ø—Ç–æ–≤—ñ –Ω–∞–∫–ª–∞–¥–Ω—ñ
    <small style="display: block; font-size: 0.8rem; font-weight: 600; margin-top: 4px; opacity: 0.8;">{{ invoices|length }} –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö</small>
  </button>
</div>

{# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –¥—Ä–æ–ø—à–∏–ø–∏–Ω–≥–∞ #}
<div id="dropship-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
  <div style="background: linear-gradient(145deg, rgba(139,92,246,.15), rgba(99,102,241,.15)); border: 1px solid rgba(139,92,246,.3); border-radius: 16px; padding: 24px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(139,92,246,.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
    <div style="font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, #8b5cf6, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">{{ total_dropship_orders|default:0 }}</div>
    <div style="font-size: 0.9rem; color: rgba(229,231,235,.6); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">–í—Å—å–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω—å</div>
  </div>
  <div style="background: linear-gradient(145deg, rgba(139,92,246,.15), rgba(99,102,241,.15)); border: 1px solid rgba(139,92,246,.3); border-radius: 16px; padding: 24px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(139,92,246,.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
    <div style="font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, #8b5cf6, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">{{ pending_orders|default:0 }}</div>
    <div style="font-size: 0.9rem; color: rgba(229,231,235,.6); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">–û—á—ñ–∫—É—é—Ç—å –æ–±—Ä–æ–±–∫–∏</div>
  </div>
  <div style="background: linear-gradient(145deg, rgba(139,92,246,.15), rgba(99,102,241,.15)); border: 1px solid rgba(139,92,246,.3); border-radius: 16px; padding: 24px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(139,92,246,.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
    <div style="font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, #8b5cf6, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">{{ total_dropship_revenue|floatformat:0 }} –≥—Ä–Ω</div>
    <div style="font-size: 0.9rem; color: rgba(229,231,235,.6); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">–ó–∞–≥–∞–ª—å–Ω–∏–π –æ–±–æ—Ä–æ—Ç</div>
  </div>
  <div style="background: linear-gradient(145deg, rgba(139,92,246,.15), rgba(99,102,241,.15)); border: 1px solid rgba(139,92,246,.3); border-radius: 16px; padding: 24px; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(139,92,246,.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
    <div style="font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, #8b5cf6, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">{{ total_dropship_profit|floatformat:0 }} –≥—Ä–Ω</div>
    <div style="font-size: 0.9rem; color: rgba(229,231,235,.6); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫</div>
  </div>
</div>

{# –ö–æ–Ω—Ç–µ–Ω—Ç –¥—Ä–æ–ø—à–∏–ø–∏–Ω–≥–∞ #}
<div id="collab-content-dropship">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h2 style="font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #8b5cf6, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –¥—Ä–æ–ø—à–∏–ø–µ—Ä—ñ–≤</h2>
    
    {# –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã #}
    <div style="display: flex; gap: 12px;">
      <input type="text" id="dropship-search" placeholder="–ü–æ—à—É–∫..." style="padding: 10px 16px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.15); border-radius: 10px; color: #e5e7eb; width: 250px;" oninput="filterDropshipOrders(this.value)">
      <select id="status-filter" style="padding: 10px 16px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.15); border-radius: 10px; color: #e5e7eb;" onchange="filterDropshipOrders(document.getElementById('dropship-search').value)">
        <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
        <option value="draft">üìù –ß–µ—Ä–Ω–µ—Ç–∫–∞</option>
        <option value="pending">‚è≥ –û—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</option>
        <option value="awaiting_payment">üí∞ –û—á—ñ–∫—É—î –æ–ø–ª–∞—Ç–∏</option>
        <option value="confirmed">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</option>
        <option value="processing">‚öôÔ∏è –í –æ–±—Ä–æ–±—Ü—ñ</option>
        <option value="awaiting_shipment">üìã –û—á—ñ–∫—É—î –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</option>
        <option value="shipped">üöö –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
        <option value="delivered_awaiting_pickup">üì¨ –ù–∞ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—ñ</option>
        <option value="received">‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ</option>
        <option value="refused">‚Ü©Ô∏è –í—ñ–¥–º–æ–≤–∞</option>
        <option value="cancelled">‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ</option>
      </select>
    </div>
  </div>

  <div id="dropship-orders-list">
    {% if dropship_orders %}
      {% for order in dropship_orders %}
        <div class="dropship-order-card" data-order-id="{{ order.id }}" data-status="{{ order.status }}" data-search-text="{{ order.order_number }} {{ order.dropshipper.username }} {{ order.client_name }} {{ order.client_phone }}" style="background: linear-gradient(145deg, rgba(24,26,31,.98), rgba(18,20,24,.98)); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; padding: 24px; margin-bottom: 20px; transition: all 0.3s;" onmouseover="this.style.borderColor='rgba(139,92,246,.4)'; this.style.transform='translateX(4px)'; this.style.boxShadow='0 8px 24px rgba(139,92,246,.2)'" onmouseout="this.style.borderColor='rgba(255,255,255,.1)'; this.style.transform='translateX(0)'; this.style.boxShadow='none'">
          
          {# –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–∫–∞–∑–∞ #}
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 16px;">
              <h3 style="margin: 0; font-size: 1.4rem; font-weight: 800; color: #e5e7eb;">#{{ order.order_number }}</h3>
              {% if order.status == 'draft' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(251,191,36,.2); color: #fbbf24; border: 1px solid rgba(251,191,36,.3);">üìù –ß–µ—Ä–Ω–µ—Ç–∫–∞</span>
              {% elif order.status == 'pending' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(139,92,246,.2); color: #a78bfa; border: 1px solid rgba(139,92,246,.3);">‚è≥ –û—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</span>
              {% elif order.status == 'awaiting_payment' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(245,158,11,.2); color: #fbbf24; border: 1px solid rgba(245,158,11,.3);">üí∞ –û—á—ñ–∫—É—î –æ–ø–ª–∞—Ç–∏</span>
              {% elif order.status == 'confirmed' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(59,130,246,.2); color: #60a5fa; border: 1px solid rgba(59,130,246,.3);">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</span>
              {% elif order.status == 'processing' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(99,102,241,.2); color: #a5b4fc; border: 1px solid rgba(99,102,241,.3);">‚öôÔ∏è –í –æ–±—Ä–æ–±—Ü—ñ</span>
              {% elif order.status == 'awaiting_shipment' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(14,165,233,.2); color: #38bdf8; border: 1px solid rgba(14,165,233,.3);">üìã –û—á—ñ–∫—É—î –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</span>
              {% elif order.status == 'shipped' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(6,182,212,.2); color: #22d3ee; border: 1px solid rgba(6,182,212,.3);">üöö –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
              {% elif order.status == 'delivered_awaiting_pickup' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(20,184,166,.2); color: #2dd4bf; border: 1px solid rgba(20,184,166,.3);">üì¨ –ù–∞ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—ñ</span>
              {% elif order.status == 'received' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(16,185,129,.2); color: #34d399; border: 1px solid rgba(16,185,129,.3);">‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ</span>
              {% elif order.status == 'refused' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(251,146,60,.2); color: #fb923c; border: 1px solid rgba(251,146,60,.3);">‚Ü©Ô∏è –í—ñ–¥–º–æ–≤–∞</span>
              {% elif order.status == 'delivered' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(16,185,129,.2); color: #34d399; border: 1px solid rgba(16,185,129,.3);">üì¶ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</span>
              {% elif order.status == 'cancelled' %}<span style="padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; background: rgba(239,68,68,.2); color: #f87171; border: 1px solid rgba(239,68,68,.3);">‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ</span>{% endif %}
              <span style="font-size: 0.85rem; color: rgba(229,231,235,.5);"><i class="far fa-clock"></i> {{ order.created_at|date:"d.m.Y H:i" }}</span>
            </div>
            
            {# –î–µ–π—Å—Ç–≤–∏—è #}
            <div style="display: flex; gap: 8px;">
              <button data-order-id="{{ order.id }}" onclick="openEditModal(this.dataset.orderId)" style="padding: 8px 16px; border-radius: 8px; background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139,92,246,.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <i class="fas fa-edit"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
              </button>
              <button 
                data-order-id="{{ order.id }}" 
                data-order-number="{{ order.order_number }}" 
                data-is-delivered="{% if order.status == 'delivered' %}true{% else %}false{% endif %}"
                onclick="handleDeleteOrder(this)"
                style="padding: 8px 16px; border-radius: 8px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" 
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(239,68,68,.4)'" 
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>

          {# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è #}
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(229,231,235,.5); margin-bottom: 6px;">–î—Ä–æ–ø—à–∏–ø–µ—Ä</div>
              <div style="font-weight: 700; color: #a78bfa; font-size: 1.05rem;">{% if order.dropshipper.userprofile.company_name %}{{ order.dropshipper.userprofile.company_name }}{% else %}{{ order.dropshipper.username }}{% endif %}</div>
              {% if order.dropshipper.userprofile.phone %}<div style="font-size: 0.9rem; color: rgba(229,231,235,.6); margin-top: 4px;">üìû {{ order.dropshipper.userprofile.phone }}</div>{% endif %}
            </div>
            
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(229,231,235,.5); margin-bottom: 6px;">–ö–ª—ñ—î–Ω—Ç</div>
              <div style="font-weight: 700; color: #e5e7eb; font-size: 1.05rem;">{{ order.client_name|default:"‚Äî" }}</div>
              {% if order.client_phone %}<div style="font-size: 0.9rem; color: rgba(229,231,235,.6); margin-top: 4px;">üìû {{ order.client_phone }}</div>{% endif %}
            </div>
            
            {% if order.tracking_number %}
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(229,231,235,.5); margin-bottom: 6px;">–¢–¢–ù</div>
              <div style="font-weight: 800; color: #22d3ee; font-size: 1.1rem; font-family: monospace;">{{ order.tracking_number }}</div>
            </div>
            {% endif %}
          </div>

          {# –§–∏–Ω–∞–Ω—Å—ã #}
          <div style="display: flex; gap: 24px; padding: 16px; background: rgba(0,0,0,.3); border-radius: 12px; margin-top: 16px;">
            <div style="flex: 1;">
              <div style="font-size: 0.75rem; text-transform: uppercase; color: rgba(229,231,235,.5); margin-bottom: 4px;">–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É</div>
              <div style="font-size: 1.3rem; font-weight: 800; color: #60a5fa;">{{ order.total_selling_price }} –≥—Ä–Ω</div>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.75rem; text-transform: uppercase; color: rgba(229,231,235,.5); margin-bottom: 4px;">–¶—ñ–Ω–∞ –¥—Ä–æ–ø–∞</div>
              <div style="font-size: 1.3rem; font-weight: 800; color: rgba(229,231,235,.8);">{{ order.total_drop_price }} –≥—Ä–Ω</div>
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.75rem; text-transform: uppercase; color: rgba(229,231,235,.5); margin-bottom: 4px;">–ü—Ä–∏–±—É—Ç–æ–∫</div>
              <div style="font-size: 1.3rem; font-weight: 800; color: #34d399;">+{{ order.profit }} –≥—Ä–Ω</div>
            </div>
          </div>
          
          {# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ #}
          <div style="display: flex; gap: 16px; padding: 14px 16px; background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(99,102,241,.1)); border: 1px solid rgba(139,92,246,.25); border-radius: 12px; margin-top: 12px; align-items: center;">
            <div style="font-size: 1.5rem;">
              {% if order.payment_method == 'prepaid' %}üí≥
              {% elif order.payment_method == 'cod' %}üì¶
              {% else %}ü§ù{% endif %}
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.75rem; text-transform: uppercase; color: rgba(229,231,235,.5); margin-bottom: 4px;">–°–ø–æ—Å—ñ–± –æ–ø–ª–∞—Ç–∏</div>
              <div style="font-weight: 700; color: #e5e7eb;">
                {% if order.payment_method == 'prepaid' %}üí≥ –¢–æ–≤–∞—Ä –æ–ø–ª–∞—á–µ–Ω–æ
                {% elif order.payment_method == 'cod' %}üì¶ –ù–∞–∫–ª–∞–¥–Ω–∏–π –ø–ª–∞—Ç—ñ–∂
                {% elif order.payment_method == 'delegation' %}ü§ù –ü–æ–≤–Ω–µ –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è
                {% else %}{{ order.get_payment_method_display }}{% endif %}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 0.75rem; text-transform: uppercase; color: rgba(229,231,235,.5); margin-bottom: 4px;">–î—Ä–æ–ø—à–∏–ø–µ—Ä —Å–ø–ª–∞—á—É—î</div>
              {% if order.dropshipper_payment_required == 0 %}
              <div style="font-size: 1.2rem; font-weight: 800; color: #34d399;">{{ order.dropshipper_payment_required|floatformat:0 }} –≥—Ä–Ω</div>
              {% else %}
              <div style="font-size: 1.2rem; font-weight: 800; color: #a78bfa;">{{ order.dropshipper_payment_required|floatformat:0 }} –≥—Ä–Ω</div>
              {% endif %}
            </div>
          </div>
          
          {# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º #}
          <div style="margin-top: 16px; padding: 16px; background: rgba(0,0,0,.2); border-radius: 12px; border: 1px solid rgba(255,255,255,.08);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-weight: 700; color: #e5e7eb; font-size: 1rem;">
                <i class="fas fa-tasks"></i> –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è–º
              </div>
              {% if order.shipment_status %}
              <button data-order-id="{{ order.id }}" onclick="checkNPStatus(this.dataset.orderId)" style="padding: 6px 12px; border-radius: 6px; background: rgba(6,182,212,.15); color: #22d3ee; border: 1px solid rgba(6,182,212,.3); font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(6,182,212,.25)'" onmouseout="this.style.background='rgba(6,182,212,.15)'">
                <i class="fas fa-sync-alt"></i> –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –ù–ü
              </button>
              {% endif %}
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
              <div>
                <label style="display: block; font-size: 0.75rem; text-transform: uppercase; color: rgba(229,231,235,.5); margin-bottom: 6px;">–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</label>
                <select id="status-select-{{ order.id }}" style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.15); border-radius: 8px; color: #e5e7eb; font-weight: 600;">
                  <option value="draft" {% if order.status == 'draft' %}selected{% endif %}>üìù –ß–µ—Ä–Ω–µ—Ç–∫–∞</option>
                  <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>‚è≥ –û—á—ñ–∫—É—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</option>
                  <option value="awaiting_payment" {% if order.status == 'awaiting_payment' %}selected{% endif %}>üí∞ –û—á—ñ–∫—É—î –æ–ø–ª–∞—Ç–∏</option>
                  <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</option>
                  <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>‚öôÔ∏è –í –æ–±—Ä–æ–±—Ü—ñ</option>
                  <option value="awaiting_shipment" {% if order.status == 'awaiting_shipment' %}selected{% endif %}>üìã –û—á—ñ–∫—É—î –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</option>
                  <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>üöö –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                  <option value="delivered_awaiting_pickup" {% if order.status == 'delivered_awaiting_pickup' %}selected{% endif %}>üì¨ –ù–∞ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—ñ</option>
                  <option value="received" {% if order.status == 'received' %}selected{% endif %}>‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ</option>
                  <option value="refused" {% if order.status == 'refused' %}selected{% endif %}>‚Ü©Ô∏è –í—ñ–¥–º–æ–≤–∞</option>
                  <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ</option>
                </select>
              </div>
              
              <div id="ttn-field-{{ order.id }}" {% if order.status == 'shipped' or order.status == 'delivered_awaiting_pickup' or order.status == 'received' %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                <label style="display: block; font-size: 0.75rem; text-transform: uppercase; color: rgba(229,231,235,.5); margin-bottom: 6px;">–¢–¢–ù –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</label>
                <input type="text" id="ttn-input-{{ order.id }}" value="{% if order.tracking_number %}{{ order.tracking_number }}{% endif %}" placeholder="20450012345678" style="width: 100%; padding: 10px 12px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.15); border-radius: 8px; color: #e5e7eb; font-weight: 600; font-family: monospace;">
              </div>
              
              <button data-order-id="{{ order.id }}" onclick="updateOrderStatus(this.dataset.orderId)" style="padding: 12px 24px; border-radius: 8px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16,185,129,.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <i class="fas fa-save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏
              </button>
            </div>
            
            {% if order.shipment_status %}
            <div style="margin-top: 12px; padding: 10px 12px; background: rgba(6,182,212,.1); border: 1px solid rgba(6,182,212,.2); border-radius: 8px;">
              <div style="font-size: 0.75rem; text-transform: uppercase; color: rgba(34,211,238,.8); margin-bottom: 4px;">
                –°—Ç–∞—Ç—É—Å –ù–ü {% if order.shipment_status_updated %}(–æ–Ω–æ–≤–ª–µ–Ω–æ {{ order.shipment_status_updated|date:"d.m.Y H:i" }}){% endif %}
              </div>
              <div style="font-weight: 700; color: #22d3ee;">{{ order.shipment_status }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div style="text-align: center; padding: 80px 20px; color: rgba(229,231,235,.5);">
        <i class="fas fa-inbox" style="font-size: 5rem; margin-bottom: 20px; opacity: 0.2;"></i>
        <div style="font-size: 1.4rem; font-weight: 700; margin-bottom: 8px;">–ó–∞–º–æ–≤–ª–µ–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>
        <div style="font-size: 1rem;">–ö–æ–ª–∏ –¥—Ä–æ–ø—à–∏–ø–µ—Ä–∏ —Å—Ç–≤–æ—Ä—è—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, –≤–æ–Ω–∏ –∑'—è–≤–ª—è—Ç—å—Å—è —Ç—É—Ç</div>
      </div>
    {% endif %}
  </div>
</div>

{# –ö–æ–Ω—Ç–µ–Ω—Ç –æ–ø—Ç–æ–≤—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö #}
<div id="collab-content-wholesale" style="display: none;">
  <h2 style="font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #8b5cf6, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0 0 24px;">–û–ø—Ç–æ–≤—ñ –Ω–∞–∫–ª–∞–¥–Ω—ñ</h2>
  
  {% if invoices %}
    {% for inv in invoices %}
      <div style="background: linear-gradient(145deg, rgba(24,26,31,.98), rgba(18,20,24,.98)); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <h3 style="margin: 0 0 8px; font-size: 1.3rem; font-weight: 800; color: #e5e7eb;">{{ inv.invoice_number }}</h3>
            <div style="color: rgba(229,231,235,.7); margin-bottom: 8px;">{{ inv.company_name }}</div>
            {% if inv.file_path %}
              <a href="{% url 'download_invoice_file' inv.id %}" style="color: #60a5fa; text-decoration: none; font-weight: 600; font-size: 0.9rem;"><i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç–∏ —Ñ–∞–π–ª</a>
            {% endif %}
          </div>
          
          <div style="display: flex; gap: 8px;">
            <button data-invoice-id="{{ inv.id }}" data-status="processing" onclick="updateInvoiceStatusInline(this.dataset.invoiceId, this.dataset.status)" style="padding: 8px 16px; border-radius: 8px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; font-weight: 700; font-size: 0.85rem; cursor: pointer;">–í –æ–±—Ä–æ–±–∫—É</button>
            <button data-invoice-id="{{ inv.id }}" data-status="shipped" onclick="updateInvoiceStatusInline(this.dataset.invoiceId, this.dataset.status)" style="padding: 8px 16px; border-radius: 8px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; font-weight: 700; font-size: 0.85rem; cursor: pointer;">–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div style="text-align: center; padding: 80px 20px; color: rgba(229,231,235,.5);">
      <i class="fas fa-file-invoice" style="font-size: 5rem; margin-bottom: 20px; opacity: 0.2;"></i>
      <div style="font-size: 1.4rem; font-weight: 700;">–ù–∞–∫–ª–∞–¥–Ω–∏—Ö –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>
    </div>
  {% endif %}
</div>

{# –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è #}
<div class="modal-overlay" id="edit-modal-overlay" onclick="if(event.target === this) closeEditModal()">
  <div class="edit-modal">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 style="margin: 0; font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #8b5cf6, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
      <button onclick="closeEditModal()" style="width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(239,68,68,.2); color: #f87171; cursor: pointer; font-size: 1.2rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,.3)'" onmouseout="this.style.background='rgba(239,68,68,.2)'">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form id="edit-order-form">
      <input type="hidden" id="edit-order-id">
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="form-group">
          <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
          <select id="edit-status" class="form-select">
            <option value="draft">–ß–µ—Ä–Ω–µ—Ç–∫–∞</option>
            <option value="pending">–û—á—ñ–∫—É—î</option>
            <option value="confirmed">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</option>
            <option value="processing">–í –æ–±—Ä–æ–±—Ü—ñ</option>
            <option value="shipped">–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
            <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
            <option value="cancelled">–°–∫–∞—Å–æ–≤–∞–Ω–æ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">–¢–¢–ù –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</label>
          <input type="text" id="edit-ttn" class="form-input" placeholder="20450123456789">
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">–Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞</label>
        <input type="text" id="edit-client-name" class="form-input">
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
          <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª—ñ—î–Ω—Ç–∞</label>
          <input type="tel" id="edit-client-phone" class="form-input">
        </div>
        
        <div class="form-group">
          <label class="form-label">–ê–¥—Ä–µ—Å–∞ –ù–ü</label>
          <input type="text" id="edit-client-address" class="form-input">
        </div>
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 32px;">
        <button type="submit" style="flex: 1; padding: 14px; border-radius: 10px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16,185,129,.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
          <i class="fas fa-save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏
        </button>
        <button type="button" onclick="closeEditModal()" style="flex: 0.3; padding: 14px; border-radius: 10px; background: rgba(255,255,255,.05); color: rgba(229,231,235,.8); border: 1px solid rgba(255,255,255,.15); font-weight: 700; font-size: 1rem; cursor: pointer;">
          –°–∫–∞—Å—É–≤–∞—Ç–∏
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
function switchCollabMode(mode) {
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
  document.querySelectorAll('.collab-mode-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById('mode-' + mode).classList.add('active');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
  document.getElementById('dropship-stats').style.display = mode === 'dropship' ? 'grid' : 'none';
  document.getElementById('collab-content-dropship').style.display = mode === 'dropship' ? 'block' : 'none';
  document.getElementById('collab-content-wholesale').style.display = mode === 'wholesale' ? 'block' : 'none';
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤
function filterDropshipOrders(searchText) {
  const statusFilter = document.getElementById('status-filter').value;
  const cards = document.querySelectorAll('.dropship-order-card');
  
  cards.forEach(card => {
    const cardSearchText = card.getAttribute('data-search-text').toLowerCase();
    const cardStatus = card.getAttribute('data-status');
    
    const matchesSearch = !searchText || cardSearchText.includes(searchText.toLowerCase());
    const matchesStatus = !statusFilter || cardStatus === statusFilter;
    
    card.style.display = (matchesSearch && matchesStatus) ? 'block' : 'none';
  });
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function openEditModal(orderId) {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
  fetch(`/admin-panel/dropship/get-order/${orderId}/`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('edit-order-id').value = data.id;
      document.getElementById('edit-status').value = data.status;
      document.getElementById('edit-ttn').value = data.tracking_number || '';
      document.getElementById('edit-client-name').value = data.client_name || '';
      document.getElementById('edit-client-phone').value = data.client_phone || '';
      document.getElementById('edit-client-address').value = data.client_np_address || '';
      
      document.getElementById('edit-modal-overlay').classList.add('active');
    })
    .catch(err => {
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
      console.error(err);
    });
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeEditModal() {
  document.getElementById('edit-modal-overlay').classList.remove('active');
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
document.getElementById('edit-order-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const orderId = document.getElementById('edit-order-id').value;
  const formData = {
    status: document.getElementById('edit-status').value,
    tracking_number: document.getElementById('edit-ttn').value,
    client_name: document.getElementById('edit-client-name').value,
    client_phone: document.getElementById('edit-client-phone').value,
    client_np_address: document.getElementById('edit-client-address').value,
  };
  
  try {
    const res = await fetch(`/admin-panel/dropship/update-order/${orderId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(formData)
    });
    
    if (res.ok) {
      location.reload();
    } else {
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
    }
  } catch(err) {
    alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
    console.error(err);
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
function handleDeleteOrder(button) {
  const orderId = button.dataset.orderId;
  const orderNumber = button.dataset.orderNumber;
  const isDelivered = button.dataset.isDelivered === 'true';
  
  let confirmMessage;
  if (isDelivered) {
    confirmMessage = '‚ö†Ô∏è –£–í–ê–ì–ê! –¶–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∂–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ.\n\n–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?\n\n–¶–µ –º–æ–∂–µ –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–∞ –≤–∏–ø–ª–∞—Ç–∏ –¥—Ä–æ–ø—à–∏–ø–µ—Ä—É.';
  } else {
    confirmMessage = `–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ${orderNumber}?`;
  }
  
  if (confirm(confirmMessage)) {
    deleteOrder(orderId);
  }
}

// –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑
async function deleteOrder(orderId) {
  try {
    const res = await fetch(`/admin-panel/dropship/delete-order/${orderId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    if (res.ok) {
      location.reload();
    } else {
      alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
    }
  } catch(err) {
    alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
    console.error(err);
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞–∫–ª–∞–¥–Ω–æ–π
async function updateInvoiceStatusInline(id, status) {
  try {
    const res = await fetch(`/admin-panel/invoices/update-status/${id}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({status})
    });
    
    if (res.ok) {
      location.reload();
    } else {
      alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è');
    }
  } catch(err) {
    alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è');
  }
}

function getCookie(name) {
  const v = `; ${document.cookie}`.split(`; ${name}=`);
  if (v.length === 2) return v.pop().split(';').shift();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
async function updateOrderStatus(orderId) {
  console.log('üîß updateOrderStatus called for order:', orderId);
  
  const statusSelect = document.getElementById(`status-select-${orderId}`);
  const ttnInput = document.getElementById(`ttn-input-${orderId}`);
  
  if (!statusSelect) {
    console.error('‚ùå Status select not found for order:', orderId);
    alert('‚ùå –ü–æ–º–∏–ª–∫–∞: –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ —Å—Ç–∞—Ç—É—Å—É');
    return;
  }
  
  const newStatus = statusSelect.value;
  const ttnValue = ttnInput ? ttnInput.value.trim() : '';
  
  console.log('üìä New status:', newStatus, 'TTN:', ttnValue);
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è: –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "shipped" - —Ç—Ä–µ–±—É–µ–º –¢–¢–ù
  if (newStatus === 'shipped' && !ttnValue) {
    alert('‚ùå –î–ª—è —Å—Ç–∞—Ç—É—Å—É "–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ" –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ –¢–¢–ù –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏!');
    return;
  }
  
  const csrfToken = getCookie('csrftoken');
  console.log('üîë CSRF Token:', csrfToken ? 'OK' : 'MISSING');
  
  try {
    console.log('üì° Sending request to:', `/orders/admin/dropship/update-status/${orderId}/`);
    
    const res = await fetch(`/orders/admin/dropship/update-status/${orderId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        status: newStatus,
        tracking_number: ttnValue
      })
    });
    
    console.log('üì• Response status:', res.status, res.statusText);
    
    const data = await res.json();
    console.log('üì¶ Response data:', data);
    
    if (res.ok && data.success) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      showNotification('‚úÖ –°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
      setTimeout(() => location.reload(), 1000);
    } else {
      console.error('‚ùå Error response:', data);
      alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
    }
  } catch(err) {
    console.error('‚ùå Exception caught:', err);
    alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è: ' + err.message);
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ù–ü
async function checkNPStatus(orderId) {
  const button = event.target.closest('button');
  const originalHTML = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...';
  
  try {
    const res = await fetch(`/orders/admin/dropship/check-np/${orderId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      showNotification('‚úÖ ' + data.message, 'success');
      setTimeout(() => location.reload(), 1500);
    } else {
      alert('‚ùå ' + (data.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å'));
      button.disabled = false;
      button.innerHTML = originalHTML;
    }
  } catch(err) {
    console.error('Error:', err);
    alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è');
    button.disabled = false;
    button.innerHTML = originalHTML;
  }
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 24px;
    background: ${type === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'};
    color: white;
    border-radius: 12px;
    font-weight: 700;
    box-shadow: 0 8px 24px rgba(0,0,0,.3);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ –¢–¢–ù –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
document.addEventListener('change', function(e) {
  if (e.target.id && e.target.id.startsWith('status-select-')) {
    const orderId = e.target.id.replace('status-select-', '');
    const ttnField = document.getElementById(`ttn-field-${orderId}`);
    const selectedStatus = e.target.value;
    
    if (selectedStatus === 'shipped' || selectedStatus === 'delivered_awaiting_pickup' || selectedStatus === 'received') {
      ttnField.style.display = 'block';
    } else {
      ttnField.style.display = 'none';
    }
  }
});
</script>

