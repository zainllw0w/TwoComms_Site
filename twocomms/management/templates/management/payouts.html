{% extends "management/base.html" %}

{% block title %}Виплати{% endblock %}

{% block content %}
<div class="clients-panel payouts-panel">
    <div class="panel-header">
        <div>
            <p class="eyebrow">Фінанси</p>
            <h2>Виплати</h2>
        </div>
        <div class="panel-actions">
            <a class="btn-ghost" href="{% url 'management_home' %}">← До панелі</a>
        </div>
    </div>

    <div class="payouts-grid">
        <section class="balance-card" aria-label="Баланс">
            <div class="balance-card__glow" aria-hidden="true"></div>
            <div class="balance-card__head">
                <div>
                    <div class="balance-card__kicker">Баланс</div>
                    <div class="balance-card__value">{{ balance|floatformat:2 }} <span class="uah">грн</span></div>
                </div>
                <div class="balance-card__status">
                    {% if active_request %}
                        <span class="status-chip status-{{ active_request.status }}">{{ active_request.get_status_display }}</span>
                    {% else %}
                        <span class="status-chip status-none">Немає активних запитів</span>
                    {% endif %}
                </div>
            </div>

            <div class="balance-card__meta">
                <div class="balance-metric">
                    <div class="balance-metric__label">Доступно до виведення</div>
                    <div class="balance-metric__value">{{ available|floatformat:2 }} грн</div>
                </div>
                <div class="balance-metric">
                    <div class="balance-metric__label">Заморожено</div>
                    <div class="balance-metric__value">{{ frozen_amount|floatformat:2 }} грн</div>
                </div>
                <div class="balance-metric">
                    <div class="balance-metric__label">В обробці</div>
                    <div class="balance-metric__value">{{ reserved_amount|floatformat:2 }} грн</div>
                </div>
            </div>

            <div class="balance-card__actions">
                <button type="button" class="btn-primary" id="payout-request-btn"
                        data-url="{% url 'management_payouts_request_api' %}"
                        {% if not available or available <= 0 or active_request %}disabled{% endif %}>
                    Запросити виплату
                </button>
                <div class="balance-card__hint" id="payout-request-hint" role="status" aria-live="polite"></div>
            </div>
        </section>

        <aside class="payouts-side" aria-label="Інформація">
            <div class="payout-note payout-note--attention">
                <div class="payout-note__title">Важливо</div>
                <div class="payout-note__text">Кошти заморожуються на 14 днів, тому що покупець має право повернути товар протягом 14 днів за умовами законодавства України (захист прав споживачів).</div>
            </div>
            <div class="payout-note">
                <div class="payout-note__title">Графік</div>
                <div class="payout-note__text">Виплата ставки здійснюється з 1 по 5 число кожного місяця.</div>
            </div>
            <div class="payout-note">
                <div class="payout-note__title">Картка</div>
                <div class="payout-note__text">У профілі вказана картка {{ card_mask }}, на неї будуть зараховуватися виплати. Якщо хочете змінити — змініть до запиту.</div>
            </div>
        </aside>
    </div>

    <section class="payouts-stats" aria-label="Статистика">
        <div class="payouts-stats__grid">
            <div class="stat-card">
                <div class="stat-card__label">Статус / посада</div>
                <div class="stat-card__value">{{ position }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__label">Днів працює</div>
                <div class="stat-card__value">{% if days_worked is not None %}{{ days_worked }}{% else %}—{% endif %}</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__label">Угод (оплачених)</div>
                <div class="stat-card__value">{{ deals_count|default:0 }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__label">Ставка</div>
                <div class="stat-card__value">{{ base_salary|default:0 }} грн</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__label">% с продаж</div>
                <div class="stat-card__value">{{ commission_percent|default:0 }}%</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__label">Дата першої угоди</div>
                <div class="stat-card__value">{% if first_deal_at %}{{ first_deal_at|date:"d.m.Y" }}{% else %}—{% endif %}</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__label">Дата останньої виплати</div>
                <div class="stat-card__value">{% if last_payout_at %}{{ last_payout_at|date:"d.m.Y" }}{% else %}—{% endif %}</div>
            </div>
            <div class="stat-card">
                <div class="stat-card__label">Всього отримано виплат</div>
                <div class="stat-card__value">{{ total_received|floatformat:2 }} грн</div>
            </div>
        </div>
    </section>

    <section class="payouts-history" aria-label="Історія виплат">
        <div class="panel-subhead">
            <div>
                <p class="eyebrow">Історія</p>
                <h3>Запити та виплати</h3>
            </div>
        </div>

        <div class="table-shell">
            <table class="nexus-table">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Сума</th>
                        <th>Статус</th>
                        <th>Причина</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in history %}
                    <tr>
                        <td>{{ req.created_at|date:"d.m.Y H:i" }}</td>
                        <td>{{ req.amount|floatformat:2 }} грн</td>
                        <td><span class="status-chip status-{{ req.status }}">{{ req.get_status_display }}</span></td>
                        <td>{% if req.status == 'rejected' %}{{ req.rejection_reason|default:"—" }}{% else %}—{% endif %}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="table-empty">Поки немає запитів</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    {% csrf_token %}
</div>

<script>
(function() {
    const btn = document.getElementById('payout-request-btn');
    const hint = document.getElementById('payout-request-hint');
    if (!btn) return;

    const getCookie = (name) => {
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
    };

    const setHint = (msg, kind) => {
        if (!hint) return;
        hint.textContent = msg || '';
        hint.dataset.kind = kind || '';
    };

    btn.addEventListener('click', async () => {
        if (btn.disabled) return;
        const url = btn.dataset.url;
        if (!url) return;

        btn.disabled = true;
        btn.dataset.loading = '1';
        setHint('Надсилаємо запит…', 'info');

        try {
            const resp = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({}),
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
                setHint((data && data.error) ? data.error : 'Не вдалося надіслати запит.', 'err');
                btn.disabled = false;
                btn.dataset.loading = '';
                return;
            }

            setHint('Запит створено. Оновлюємо…', 'ok');
            setTimeout(() => window.location.reload(), 650);
        } catch (e) {
            setHint('Мережа недоступна. Спробуйте пізніше.', 'err');
            btn.disabled = false;
            btn.dataset.loading = '';
        }
    });
})();
</script>
{% endblock %}
