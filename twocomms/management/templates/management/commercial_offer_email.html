{% extends "management/base.html" %}

{% block title %}–ö–ü –Ω–∞ e-mail{% endblock %}

{% block content %}
<div class="clients-panel offer-panel">
    <div class="panel-header">
        <div>
            <p class="eyebrow">–ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è</p>
            <h2>–ö–ü –Ω–∞ e-mail</h2>
        </div>
        <div class="panel-actions">
            <a class="btn-ghost" href="{% url 'management_home' %}">‚Üê –î–æ –ø–∞–Ω–µ–ª—ñ</a>
        </div>
    </div>

    <div id="offer-alert-stack"></div>

    {% if sent_success %}
        <div class="offer-alert offer-alert-success">–ö–ü —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ.</div>
    {% endif %}

    {% if send_error %}
        <div class="offer-alert offer-alert-danger">{{ send_error }}</div>
    {% endif %}

    {% if form.non_field_errors %}
        <div class="offer-alert offer-alert-danger">{{ form.non_field_errors.0 }}</div>
    {% endif %}

    <div class="offer-grid">
        <form method="post" class="offer-form" id="offer-form" action="{% url 'management_commercial_offer_email' %}">
            {% csrf_token %}
            <input type="hidden" name="confirm_resend" id="confirm_resend" value="0">

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–û—Ç—Ä–∏–º—É–≤–∞—á</p>
                        <h3 class="offer-card-title">–ö—É–¥–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ</h3>
                    </div>
                </div>
                <div class="field-grid offer-fields">
                    <div class="field field-span-2">
                        <label for="recipient_email">Email</label>
                        <input type="email"
                               id="recipient_email"
                               name="recipient_email"
                               value="{{ form.recipient_email.value|default_if_none:'' }}"
                               placeholder="brand@example.com"
                               autocomplete="email"
                               required>
                        <div class="offer-dup-hint" id="offer-email-dup-hint" hidden></div>
                        {% if form.recipient_email.errors %}
                            <div class="offer-error">{{ form.recipient_email.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="field field-span-2">
                        <label for="recipient_name">–Ü–º º—è –∞–±–æ –∫–æ–º–ø–∞–Ω—ñ—è (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                        <input type="text"
                               id="recipient_name"
                               name="recipient_name"
                               value="{{ form.recipient_name.value|default_if_none:'' }}"
                               placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: Brand / –û–ª–µ–∫—Å–∞–Ω–¥—Ä"
                               autocomplete="organization">
                        {% if form.recipient_name.errors %}
                            <div class="offer-error">{{ form.recipient_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–®–∞–±–ª–æ–Ω</p>
                        <h3 class="offer-card-title">–†–µ–∂–∏–º, –∫–æ–Ω—Ç–µ–Ω—Ç —ñ —Ç–µ–º–∞</h3>
                    </div>
                </div>

                <div class="field-grid offer-fields">
                    <div class="field">
                        <label for="mode">–†–µ–∂–∏–º</label>
                        <select id="mode" name="mode">
                            {% with mode_val=form.mode.value|default:"VISUAL" %}
                                <option value="LIGHT" {% if mode_val == "LIGHT" %}selected{% endif %}>LIGHT ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –¥–æ—Å—Ç–∞–≤–ª—é–≤–∞–Ω—ñ—Å—Ç—å</option>
                                <option value="VISUAL" {% if mode_val == "VISUAL" %}selected{% endif %}>VISUAL ‚Äî –∫—Ä–∞—Å–∏–≤–∏–π HTML (Safe Dark)</option>
                            {% endwith %}
                        </select>
                        <div class="offer-field-hint">Light ‚Äî –º–∞–π–∂–µ plain-text. Visual ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π –±—Ä–µ–Ω–¥–æ–≤–∞–Ω–∏–π –ª–∏—Å—Ç.</div>
                        {% if form.mode.errors %}
                            <div class="offer-error">{{ form.mode.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field">
                        <label for="segment_mode">–°–µ–≥–º–µ–Ω—Ç</label>
                        <select id="segment_mode" name="segment_mode">
                            {% with seg_val=form.segment_mode.value|default:"NEUTRAL" %}
                                <option value="NEUTRAL" {% if seg_val == "NEUTRAL" %}selected{% endif %}>NEUTRAL ‚Äî —Å–ø–æ–∫—ñ–π–Ω—ñ —Ö—ñ—Ç–∏</option>
                                <option value="EDGY" {% if seg_val == "EDGY" %}selected{% endif %}>EDGY ‚Äî –¥–µ—Ä–∑–∫—ñ —Ö—ñ—Ç–∏</option>
                            {% endwith %}
                        </select>
                        <div class="offer-field-hint">–í–ø–ª–∏–≤–∞—î –Ω–∞ –ø—ñ–¥–±—ñ—Ä–∫—É —Ç–æ–≤–∞—Ä—ñ–≤ —É –ª–∏—Å—Ç—ñ.</div>
                        {% if form.segment_mode.errors %}
                            <div class="offer-error">{{ form.segment_mode.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2">
                        <label for="subject_preset">–¢–µ–º–∞ –ª–∏—Å—Ç–∞</label>
                        <select id="subject_preset" name="subject_preset">
                            {% with subject_val=form.subject_preset.value|default:"PRESET_1" %}
                                <option value="PRESET_1" {% if subject_val == "PRESET_1" %}selected{% endif %}>TwoComms: –¢–µ—Å—Ç-—Ä–æ—Å—Ç–æ–≤–∫–∞ 14 –¥–Ω—ñ–≤‚Ä¶</option>
                                <option value="PRESET_2" {% if subject_val == "PRESET_2" %}selected{% endif %}>–û–ø—Ç –≤—ñ–¥ 8 —à—Ç / –î—Ä–æ–ø—à–∏–ø‚Ä¶</option>
                                <option value="PRESET_3" {% if subject_val == "PRESET_3" %}selected{% endif %}>üì¶ –¢–µ—Å—Ç-–¥—Ä–∞–π–≤ 14 –¥–Ω—ñ–≤‚Ä¶</option>
                                <option value="CUSTOM" {% if subject_val == "CUSTOM" %}selected{% endif %}>Custom</option>
                            {% endwith %}
                        </select>
                        {% if form.subject_preset.errors %}
                            <div class="offer-error">{{ form.subject_preset.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2" id="subject_custom_wrap" {% if form.subject_preset.value != "CUSTOM" %}hidden{% endif %}>
                        <label for="subject_custom">Custom —Ç–µ–º–∞</label>
                        <input type="text"
                               id="subject_custom"
                               name="subject_custom"
                               value="{{ form.subject_custom.value|default_if_none:'' }}"
                               placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤–æ—é —Ç–µ–º—É –ª–∏—Å—Ç–∞">
                        {% if form.subject_custom.errors %}
                            <div class="offer-error">{{ form.subject_custom.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="offer-unit">
                    <div class="offer-unit-head">
                        <div class="offer-unit-title">–ü—Ä–∏–∫–ª–∞–¥ —é–Ω—ñ—Ç-–µ–∫–æ–Ω–æ–º—ñ–∫–∏</div>
                        <div class="offer-unit-sub">–¶–µ –ø—Ä–∏–∫–ª–∞–¥ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É. –†–æ–∑–¥—Ä—ñ–±–Ω—É —Ü—ñ–Ω—É –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç–µ –≤–∏.</div>
                    </div>
                    <div class="field-grid offer-unit-grid">
                        <div class="field">
                            <label for="tee_entry">–§—É—Ç–±–æ–ª–∫–∞ ‚Äî –≤—Ö—ñ–¥ (–≥—Ä–Ω)</label>
                            <input type="number"
                                   id="tee_entry"
                                   name="tee_entry"
                                   value="{{ form.tee_entry.value|default_if_none:'' }}"
                                   placeholder="–ù–∞–ø—Ä. 250"
                                   inputmode="numeric">
                            {% if form.tee_entry.errors %}
                                <div class="offer-error">{{ form.tee_entry.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field">
                            <label for="tee_retail_example">–§—É—Ç–±–æ–ª–∫–∞ ‚Äî —Ä–æ–∑–¥—Ä—ñ–± (–ø—Ä–∏–∫–ª–∞–¥, –≥—Ä–Ω)</label>
                            <input type="number"
                                   id="tee_retail_example"
                                   name="tee_retail_example"
                                   value="{{ form.tee_retail_example.value|default_if_none:'' }}"
                                   placeholder="–ù–∞–ø—Ä. 690"
                                   inputmode="numeric">
                            <div class="offer-profit-line">–†—ñ–∑–Ω–∏—Ü—è*: <span class="offer-profit" id="tee_profit_display">‚Äî</span> –≥—Ä–Ω</div>
                            {% if form.tee_retail_example.errors %}
                                <div class="offer-error">{{ form.tee_retail_example.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field">
                            <label for="hoodie_entry">–•—É–¥—ñ ‚Äî –≤—Ö—ñ–¥ (–≥—Ä–Ω)</label>
                            <input type="number"
                                   id="hoodie_entry"
                                   name="hoodie_entry"
                                   value="{{ form.hoodie_entry.value|default_if_none:'' }}"
                                   placeholder="–ù–∞–ø—Ä. 520"
                                   inputmode="numeric">
                            {% if form.hoodie_entry.errors %}
                                <div class="offer-error">{{ form.hoodie_entry.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field">
                            <label for="hoodie_retail_example">–•—É–¥—ñ ‚Äî —Ä–æ–∑–¥—Ä—ñ–± (–ø—Ä–∏–∫–ª–∞–¥, –≥—Ä–Ω)</label>
                            <input type="number"
                                   id="hoodie_retail_example"
                                   name="hoodie_retail_example"
                                   value="{{ form.hoodie_retail_example.value|default_if_none:'' }}"
                                   placeholder="–ù–∞–ø—Ä. 1490"
                                   inputmode="numeric">
                            <div class="offer-profit-line">–†—ñ–∑–Ω–∏—Ü—è*: <span class="offer-profit" id="hoodie_profit_display">‚Äî</span> –≥—Ä–Ω</div>
                            {% if form.hoodie_retail_example.errors %}
                                <div class="offer-error">{{ form.hoodie_retail_example.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫</p>
                        <h3 class="offer-card-title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
                    </div>
                </div>

                <div class="offer-toggle-row">
                    <label class="offer-switch" aria-label="–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞">
                        <input type="checkbox" id="show_manager" name="show_manager" {% if form.show_manager.value %}checked{% endif %}>
                        <span class="offer-switch-track"></span>
                    </label>
                    <div class="offer-toggle-meta">
                        <div class="offer-toggle-title">–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —É –ª–∏—Å—Ç—ñ</div>
                        <div class="offer-toggle-sub">–Ø–∫—â–æ –≤–∏–º–∫–Ω—É—Ç–∏ ‚Äî –ª–∏—Å—Ç –±—É–¥–µ –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤.</div>
                    </div>
                </div>

                <div class="field-grid offer-fields">
                    <div class="field">
                        <label for="manager_name">–Ü–º º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞</label>
                        <input type="text"
                               id="manager_name"
                               name="manager_name"
                               value="{{ form.manager_name.value|default_if_none:'' }}"
                               placeholder="–í–∞—à–µ —ñ–º º—è"
                               autocomplete="name">
                        {% if form.manager_name.errors %}
                            <div class="offer-error">{{ form.manager_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="field">
                        <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                        <input type="tel"
                               id="phone"
                               name="phone"
                               value="{{ form.phone.value|default_if_none:'' }}"
                               placeholder="+380..."
                               autocomplete="tel">
                        {% if form.phone.errors %}
                            <div class="offer-error">{{ form.phone.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="offer-messengers">
                    <div class="offer-messengers-head">
                        <p class="eyebrow">–ö–æ–Ω—Ç–∞–∫—Ç–∏</p>
                        <h4 class="offer-messengers-title">–ú–µ—Å–µ–Ω–¥–∂–µ—Ä–∏</h4>
                    </div>

                    <div class="offer-messenger-row" data-messenger="viber">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="viber_enabled" name="viber_enabled" {% if form.viber_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-viber" aria-hidden="true">V</span>
                                <span>Viber</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="text"
                                   id="viber"
                                   name="viber"
                                   value="{{ form.viber.value|default_if_none:'' }}"
                                   placeholder="+380... (–Ω–æ–º–µ—Ä)"
                                   class="offer-messenger-input"
                                   autocomplete="tel">
                            <div class="offer-messenger-help">–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è Viber</div>
                        </div>
                    </div>
                    {% if form.viber.errors %}
                        <div class="offer-error">{{ form.viber.errors.0 }}</div>
                    {% endif %}

                    <div class="offer-messenger-row" data-messenger="whatsapp">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="whatsapp_enabled" name="whatsapp_enabled" {% if form.whatsapp_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-whatsapp" aria-hidden="true">W</span>
                                <span>WhatsApp</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="text"
                                   id="whatsapp"
                                   name="whatsapp"
                                   value="{{ form.whatsapp.value|default_if_none:'' }}"
                                   placeholder="+380... (–Ω–æ–º–µ—Ä)"
                                   class="offer-messenger-input"
                                   autocomplete="tel">
                            <div class="offer-messenger-help">–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è WhatsApp</div>
                        </div>
                    </div>
                    {% if form.whatsapp.errors %}
                        <div class="offer-error">{{ form.whatsapp.errors.0 }}</div>
                    {% endif %}

                    <div class="offer-messenger-row" data-messenger="telegram">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="telegram_enabled" name="telegram_enabled" {% if form.telegram_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-telegram" aria-hidden="true">T</span>
                                <span>Telegram</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="text"
                                   id="telegram"
                                   name="telegram"
                                   value="{{ form.telegram.value|default_if_none:'' }}"
                                   placeholder="@username –∞–±–æ +380..."
                                   class="offer-messenger-input"
                                   autocomplete="username">
                            <div class="offer-messenger-help">–õ–æ–≥—ñ–Ω @username –∞–±–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è Telegram</div>
                        </div>
                    </div>
                    {% if form.telegram.errors %}
                        <div class="offer-error">{{ form.telegram.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="offer-actions">
                <button type="submit" class="btn-primary offer-submit" id="offer-submit">
                    <span class="offer-btn-spinner" aria-hidden="true"></span>
                    <span class="offer-btn-text">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é</span>
                </button>
                <div class="offer-actions-sub">
                    –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–µ –∑ –ø–æ—à—Ç–∏ <span class="offer-mono">cooperation@twocomms.shop</span>.
                </div>
            </div>
        </form>

        <div class="offer-preview">
            <div class="offer-card offer-preview-card">
                <div class="offer-card-head offer-preview-head">
                    <div>
                        <p class="eyebrow">–ü—Ä–µ–≤ º—é</p>
                        <h3 class="offer-card-title">–Ø–∫ –≤–∏–≥–ª—è–¥–∞—Ç–∏–º–µ –ª–∏—Å—Ç</h3>
                    </div>
                    <div class="offer-preview-tabs" id="offer-preview-tabs" data-default-tab="{{ preview_mode|default:'VISUAL' }}">
                        <button type="button" class="offer-preview-tab" data-offer-preview-tab="VISUAL">VISUAL</button>
                        <button type="button" class="offer-preview-tab" data-offer-preview-tab="LIGHT">LIGHT</button>
                    </div>
                </div>
                <div class="offer-preview-meta">
                    <div class="offer-preview-meta-line">
                        <span class="offer-preview-meta-label">–¢–µ–º–∞</span>
                        <span class="offer-preview-meta-value" id="offer-preview-subject">{{ preview_subject }}</span>
                    </div>
                    <div class="offer-preview-meta-sub" id="offer-preview-preheader">{{ preview_preheader }}</div>
                </div>
                <div class="offer-preview-surface" id="offer-preview-surface">
                    <div class="offer-preview-pane" id="offer-preview-visual">{{ preview_visual_html|safe }}</div>
                    <pre class="offer-preview-pane offer-preview-pane-light" id="offer-preview-light">{{ preview_light_text }}</pre>
                </div>
            </div>
        </div>
    </div>

    <div class="offer-history">
        <div class="panel-header offer-history-head">
            <div>
                <p class="eyebrow">–Ü—Å—Ç–æ—Ä—ñ—è</p>
                <h3 class="offer-card-title">–û—Å—Ç–∞–Ω–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –ö–ü</h3>
            </div>
        </div>
        <div class="table-shell">
            <table class="nexus-table">
                <thead>
                    <tr>
                        <th>–û—Ç—Ä–∏–º—É–≤–∞—á</th>
                        <th>–î–∞–Ω—ñ –≤ –ª–∏—Å—Ç—ñ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody id="offer-history-body">
                    {% if logs %}
                        {% for log in logs %}
                            {% include "management/partials/commercial_offer_log_row.html" with log=log %}
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td class="table-empty" colspan="5">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö –ö–ü</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal-overlay" id="offer-confirm-modal" aria-hidden="true">
    <div class="modal-card offer-confirm-card">
        <div class="modal-header">
            <div>
                <p class="eyebrow">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</p>
                <h3>–ü–æ–≤—Ç–æ—Ä–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞</h3>
            </div>
            <button type="button" class="modal-close" id="offer-confirm-close" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
        </div>
        <div class="modal-body">
            <p class="offer-confirm-text" id="offer-confirm-text">
                –ù–∞ —Ü–µ–π email –≤–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–ª–∏ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —â–µ —Ä–∞–∑?
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost" id="offer-confirm-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button type="button" class="btn-primary" id="offer-confirm-ok">–¢–∞–∫, –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="offer-log-modal" aria-hidden="true">
    <div class="modal-card offer-log-card">
        <div class="modal-header">
            <div>
                <p class="eyebrow">–ü–µ—Ä–µ–≥–ª—è–¥</p>
                <h3 id="offer-log-modal-title">–õ–∏—Å—Ç</h3>
                <div class="offer-log-modal-meta" id="offer-log-modal-meta"></div>
            </div>
            <button type="button" class="modal-close" id="offer-log-close" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
        </div>
        <div class="modal-body offer-log-modal-body">
            <div class="offer-preview-tabs offer-log-tabs" id="offer-log-tabs">
                <button type="button" class="offer-preview-tab" data-offer-log-tab="VISUAL">VISUAL</button>
                <button type="button" class="offer-preview-tab" data-offer-log-tab="LIGHT">LIGHT</button>
            </div>

            <div class="offer-log-pane offer-log-pane-visual" id="offer-log-pane-visual">
                <iframe class="offer-log-iframe" id="offer-log-iframe" title="Email preview" sandbox=""></iframe>
            </div>

            <pre class="offer-log-pane offer-log-pane-light" id="offer-log-pane-light"></pre>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost" id="offer-log-close-2">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('offer-form');
    if (!form) return;

    const previewVisual = document.getElementById('offer-preview-visual');
    const previewLight = document.getElementById('offer-preview-light');
    const previewSubject = document.getElementById('offer-preview-subject');
    const previewPreheader = document.getElementById('offer-preview-preheader');
    const previewTabButtons = Array.from(document.querySelectorAll('[data-offer-preview-tab]'));

    const alertStack = document.getElementById('offer-alert-stack');
    const historyBody = document.getElementById('offer-history-body');

    const confirmModal = document.getElementById('offer-confirm-modal');
    const confirmOk = document.getElementById('offer-confirm-ok');
    const confirmCancel = document.getElementById('offer-confirm-cancel');
    const confirmClose = document.getElementById('offer-confirm-close');
    const confirmText = document.getElementById('offer-confirm-text');
    const confirmResend = document.getElementById('confirm_resend');

    const logModal = document.getElementById('offer-log-modal');
    const logClose = document.getElementById('offer-log-close');
    const logClose2 = document.getElementById('offer-log-close-2');
    const logTitle = document.getElementById('offer-log-modal-title');
    const logMeta = document.getElementById('offer-log-modal-meta');
    const logIframe = document.getElementById('offer-log-iframe');
    const logPaneVisual = document.getElementById('offer-log-pane-visual');
    const logPaneLight = document.getElementById('offer-log-pane-light');
    const logTabButtons = Array.from(document.querySelectorAll('[data-offer-log-tab]'));

    const submitBtn = document.getElementById('offer-submit');
    const submitText = submitBtn?.querySelector('.offer-btn-text');

    const recipientEmail = document.getElementById('recipient_email');
    const recipientName = document.getElementById('recipient_name');
    const mode = document.getElementById('mode');
    const segmentMode = document.getElementById('segment_mode');
    const subjectPreset = document.getElementById('subject_preset');
    const subjectCustomWrap = document.getElementById('subject_custom_wrap');
    const subjectCustom = document.getElementById('subject_custom');

    const teeEntry = document.getElementById('tee_entry');
    const teeRetailExample = document.getElementById('tee_retail_example');
    const hoodieEntry = document.getElementById('hoodie_entry');
    const hoodieRetailExample = document.getElementById('hoodie_retail_example');
    const teeProfitDisplay = document.getElementById('tee_profit_display');
    const hoodieProfitDisplay = document.getElementById('hoodie_profit_display');

    const showManager = document.getElementById('show_manager');
    const managerName = document.getElementById('manager_name');
    const phone = document.getElementById('phone');
    const viberEnabled = document.getElementById('viber_enabled');
    const viber = document.getElementById('viber');
    const whatsappEnabled = document.getElementById('whatsapp_enabled');
    const whatsapp = document.getElementById('whatsapp');
    const telegramEnabled = document.getElementById('telegram_enabled');
    const telegram = document.getElementById('telegram');

    const dupHint = document.getElementById('offer-email-dup-hint');
    let dupExists = false;
    let dupCount = 0;
    let dupLast = '';
    let checkTimer = null;
    let abortController = null;

    let previewTimer = null;
    let previewAbortController = null;
    let activePreviewTab = 'VISUAL';
    let activeLogTab = 'VISUAL';

    function parseIntSafe(value) {
        const raw = String(value || '').replace(/\s+/g, '').trim();
        if (!raw) return null;
        const num = Number(raw);
        if (!Number.isFinite(num)) return null;
        return Math.trunc(num);
    }

    function fmtNumber(value) {
        if (value === null || value === undefined) return '‚Äî';
        try {
            return Number(value).toLocaleString('uk-UA');
        } catch (e) {
            return String(value);
        }
    }

    function syncUnitProfits() {
        const teeEntryVal = parseIntSafe(teeEntry?.value);
        const teeRetailVal = parseIntSafe(teeRetailExample?.value);
        const teeProfit = (teeEntryVal !== null && teeRetailVal !== null) ? (teeRetailVal - teeEntryVal) : null;
        if (teeProfitDisplay) teeProfitDisplay.textContent = teeProfit === null ? '‚Äî' : fmtNumber(teeProfit);

        const hoodieEntryVal = parseIntSafe(hoodieEntry?.value);
        const hoodieRetailVal = parseIntSafe(hoodieRetailExample?.value);
        const hoodieProfit = (hoodieEntryVal !== null && hoodieRetailVal !== null) ? (hoodieRetailVal - hoodieEntryVal) : null;
        if (hoodieProfitDisplay) hoodieProfitDisplay.textContent = hoodieProfit === null ? '‚Äî' : fmtNumber(hoodieProfit);
    }

    function syncSubjectCustom() {
        const isCustom = subjectPreset && subjectPreset.value === 'CUSTOM';
        if (subjectCustomWrap) subjectCustomWrap.hidden = !isCustom;
        if (!isCustom && subjectCustom) subjectCustom.value = '';
    }

    const messengerRows = [
        { row: document.querySelector('[data-messenger="viber"]'), toggle: viberEnabled, input: viber },
        { row: document.querySelector('[data-messenger="whatsapp"]'), toggle: whatsappEnabled, input: whatsapp },
        { row: document.querySelector('[data-messenger="telegram"]'), toggle: telegramEnabled, input: telegram },
    ].filter((x) => x.row && x.toggle && x.input);

    function syncMessengerUI() {
        const showMgr = !!showManager?.checked;

        if (managerName) {
            managerName.readOnly = !showMgr;
            managerName.classList.toggle('is-readonly', !showMgr);
        }
        if (phone) {
            phone.readOnly = !showMgr;
            phone.classList.toggle('is-readonly', !showMgr);
        }

        messengerRows.forEach(({ row, toggle, input }) => {
            toggle.disabled = !showMgr;
            const enabled = showMgr && !!toggle.checked;
            row.classList.toggle('is-enabled', enabled);
            row.classList.toggle('is-disabled', !enabled);
            input.readOnly = !enabled;
            input.setAttribute('aria-disabled', String(!enabled));
        });
    }

    function setActivePreview(tab) {
        activePreviewTab = tab;
        previewTabButtons.forEach((btn) => {
            const isActive = btn.getAttribute('data-offer-preview-tab') === tab;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-selected', String(isActive));
        });
        if (previewVisual) previewVisual.style.display = tab === 'VISUAL' ? '' : 'none';
        if (previewLight) previewLight.style.display = tab === 'LIGHT' ? '' : 'none';
    }

    function setActiveLog(tab) {
        activeLogTab = tab;
        logTabButtons.forEach((btn) => {
            const isActive = btn.getAttribute('data-offer-log-tab') === tab;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-selected', String(isActive));
        });
        if (logPaneVisual) logPaneVisual.style.display = tab === 'VISUAL' ? '' : 'none';
        if (logPaneLight) logPaneLight.style.display = tab === 'LIGHT' ? '' : 'none';
    }

    async function updatePreviewNow() {
        if (previewAbortController) previewAbortController.abort();
        previewAbortController = new AbortController();

        try {
            const formData = new FormData(form);
            const resp = await fetch('{% url "management_commercial_offer_email_preview_api" %}', {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
                signal: previewAbortController.signal,
            });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data || !data.ok) return;

            if (previewVisual) previewVisual.innerHTML = data.html || '';
            if (previewLight) previewLight.textContent = data.text || '';
            if (previewSubject) previewSubject.textContent = data.subject || '';
            if (previewPreheader) previewPreheader.textContent = data.preheader || '';
        } catch (e) {
            if (e && e.name === 'AbortError') return;
        }
    }

    function schedulePreviewUpdate() {
        if (previewTimer) clearTimeout(previewTimer);
        previewTimer = setTimeout(updatePreviewNow, 320);
    }

    function setDupHint(data) {
        dupExists = !!data.exists;
        dupCount = Number.isFinite(data.count) ? data.count : 0;
        dupLast = data.lastSentAtDisplay || '';
        if (!dupExists) {
            dupHint.hidden = true;
            dupHint.textContent = '';
            return;
        }

        const lastPart = dupLast ? ` –û—Å—Ç–∞–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∞: ${dupLast}.` : '';
        dupHint.hidden = false;
        dupHint.textContent = `–¶–µ–π email –≤–∂–µ –æ—Ç—Ä–∏–º—É–≤–∞–≤ –ö–ü (${dupCount}).${lastPart} –í–æ–Ω–∞ –±—É–¥–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ —â–µ —Ä–∞–∑.`;
    }

    async function checkDuplicateEmail(value) {
        const email = (value || '').trim();
        confirmResend.value = '0';
        if (!email || !email.includes('@')) {
            setDupHint({ exists: false, count: 0, lastSentAtDisplay: '' });
            return;
        }

        if (abortController) abortController.abort();
        abortController = new AbortController();
        try {
            const url = `{% url 'management_commercial_offer_email_check_api' %}?email=${encodeURIComponent(email)}`;
            const resp = await fetch(url, { signal: abortController.signal, headers: { 'Accept': 'application/json' } });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data || !data.ok) return;
            setDupHint(data);
        } catch (e) {
            // ignore
        }
    }

    function scheduleDuplicateCheck() {
        if (checkTimer) clearTimeout(checkTimer);
        checkTimer = setTimeout(() => checkDuplicateEmail(recipientEmail.value), 350);
    }

    function openConfirmModal() {
        const email = (recipientEmail.value || '').trim();
        const lastPart = dupLast ? ` (–æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä–∞–∑: ${dupLast})` : '';
        confirmText.textContent = `–ù–∞ email ${email}${lastPart} –≤–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–ª–∏ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —â–µ —Ä–∞–∑?`;
        confirmModal.classList.add('show');
        confirmModal.setAttribute('aria-hidden', 'false');
    }

    function closeConfirmModal() {
        confirmModal.classList.remove('show');
        confirmModal.setAttribute('aria-hidden', 'true');
    }

    function setAlert(kind, text) {
        const el = document.createElement('div');
        el.className = `offer-alert offer-alert-${kind}`;
        el.textContent = text;
        alertStack.innerHTML = '';
        alertStack.appendChild(el);
        window.setTimeout(() => {
            if (el.parentNode === alertStack) {
                el.style.opacity = '0.0';
                el.style.transform = 'translateY(-4px)';
                el.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                window.setTimeout(() => { if (el.parentNode === alertStack) alertStack.innerHTML = ''; }, 240);
            }
        }, 5500);
    }

    function setButtonState(state) {
        if (state === 'loading') {
            submitBtn.classList.add('is-loading');
            submitBtn.disabled = true;
            if (submitText) submitText.textContent = '–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ‚Ä¶';
            return;
        }
        if (state === 'success') {
            submitBtn.classList.remove('is-loading');
            submitBtn.classList.add('is-success');
            submitBtn.disabled = true;
            if (submitText) submitText.textContent = '–ö–ü –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ';
            return;
        }
        submitBtn.classList.remove('is-loading');
        submitBtn.classList.remove('is-success');
        submitBtn.disabled = false;
        if (submitText) submitText.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é';
    }

    function clearRecipientFields() {
        recipientEmail.value = '';
        recipientName.value = '';
        confirmResend.value = '0';
        setDupHint({ exists: false, count: 0, lastSentAtDisplay: '' });
        schedulePreviewUpdate();
    }

    function prependHistoryRow(rowHtml) {
        const emptyRow = historyBody.querySelector('tr .table-empty')?.closest('tr');
        if (emptyRow) emptyRow.remove();

        const tmp = document.createElement('tbody');
        tmp.innerHTML = rowHtml.trim();
        const row = tmp.querySelector('tr');
        if (row) historyBody.prepend(row);
    }

    async function sendOffer() {
        const email = (recipientEmail.value || '').trim();
        if (!email) {
            setAlert('danger', '–í–∫–∞–∂—ñ—Ç—å email –æ—Ç—Ä–∏–º—É–≤–∞—á–∞.');
            return;
        }

        setButtonState('loading');
        alertStack.innerHTML = '';

        const formData = new FormData(form);
        try {
            const resp = await fetch('{% url "management_commercial_offer_email_send_api" %}', {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
            });

            if (resp.status === 409) {
                const data = await resp.json();
                if (data && data.needs_confirmation) {
                    if (data.duplicate) {
                        setDupHint({
                            exists: true,
                            count: data.duplicate.count || 0,
                            lastSentAtDisplay: data.duplicate.lastSentAtDisplay || ''
                        });
                    }
                    setButtonState('idle');
                    openConfirmModal();
                    return;
                }
            }

            const data = await resp.json();
            if (!resp.ok || !data || !data.ok) {
                setButtonState('idle');
                if (data && data.errors) {
                    const firstKey = Object.keys(data.errors)[0];
                    const firstMsg = firstKey ? (data.errors[firstKey][0] || '') : '';
                    setAlert('danger', firstMsg || '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ —Ñ–æ—Ä–º–∏.');
                } else {
                    setAlert('danger', (data && data.message) ? data.message : '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª–∏—Å—Ç.');
                }
                return;
            }

            if (data.sent) {
                prependHistoryRow(data.row_html || '');
                setAlert('success', data.message || '–ö–ü —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ.');
                setButtonState('success');
                clearRecipientFields();
                window.setTimeout(() => setButtonState('idle'), 2400);
            } else {
                setButtonState('idle');
                setAlert('danger', data.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª–∏—Å—Ç.');
            }
        } catch (e) {
            setButtonState('idle');
            setAlert('danger', '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
        }
    }

    async function fetchLog(url) {
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
        if (!resp.ok) return null;
        const data = await resp.json();
        if (!data || !data.ok || !data.log) return null;
        return data.log;
    }

    function openLogModal(log) {
        if (!logModal) return;
        if (logTitle) logTitle.textContent = log.subject || '–õ–∏—Å—Ç';
        if (logMeta) {
            const metaParts = [
                log.recipient_email || '',
                log.created_at_display || '',
                `${(log.mode || '').toUpperCase()}${log.segment_mode ? ' / ' + (log.segment_mode || '').toUpperCase() : ''}`,
            ].filter(Boolean);
            logMeta.textContent = metaParts.join(' ‚Ä¢ ');
        }
        if (logIframe) {
            const html = log.body_html || '<div style="font-family:Arial,Helvetica,sans-serif;padding:18px;">HTML –≤—ñ–¥—Å—É—Ç–Ω—ñ–π.</div>';
            logIframe.srcdoc = html;
        }
        if (logPaneLight) logPaneLight.textContent = log.body_text || '';

        setActiveLog((log.mode || '').toUpperCase() === 'LIGHT' ? 'LIGHT' : 'VISUAL');

        logModal.classList.add('show');
        logModal.setAttribute('aria-hidden', 'false');
    }

    function closeLogModal() {
        if (!logModal) return;
        logModal.classList.remove('show');
        logModal.setAttribute('aria-hidden', 'true');
    }

    function fillFormFromLog(log) {
        recipientEmail.value = log.recipient_email || '';
        recipientName.value = log.recipient_name || '';

        if (mode) mode.value = (log.mode || 'VISUAL').toUpperCase();
        if (segmentMode) segmentMode.value = (log.segment_mode || 'NEUTRAL').toUpperCase();
        if (subjectPreset) subjectPreset.value = (log.subject_preset || 'PRESET_1').toUpperCase();
        if (subjectCustom) subjectCustom.value = log.subject_custom || '';
        syncSubjectCustom();

        if (teeEntry) teeEntry.value = log.tee_entry ?? '';
        if (teeRetailExample) teeRetailExample.value = log.tee_retail_example ?? '';
        if (hoodieEntry) hoodieEntry.value = log.hoodie_entry ?? '';
        if (hoodieRetailExample) hoodieRetailExample.value = log.hoodie_retail_example ?? '';
        syncUnitProfits();

        if (showManager) showManager.checked = !!log.show_manager;
        if (managerName) managerName.value = log.manager_name || '';
        if (phone) phone.value = log.phone || '';
        if (viberEnabled) viberEnabled.checked = !!(log.viber || '').trim();
        if (viber) viber.value = log.viber || '';
        if (whatsappEnabled) whatsappEnabled.checked = !!(log.whatsapp || '').trim();
        if (whatsapp) whatsapp.value = log.whatsapp || '';
        if (telegramEnabled) telegramEnabled.checked = !!(log.telegram || '').trim();
        if (telegram) telegram.value = log.telegram || '';
        confirmResend.value = '0';

        syncMessengerUI();
        scheduleDuplicateCheck();
        schedulePreviewUpdate();

        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function handleHistoryClick(e) {
        const actionBtn = e.target.closest('[data-offer-log-action]');
        if (!actionBtn) return;
        const action = actionBtn.getAttribute('data-offer-log-action');
        const url = actionBtn.getAttribute('data-url');
        if (!action || !url) return;

        actionBtn.disabled = true;
        fetchLog(url).then((log) => {
            if (!log) return;
            if (action === 'view') openLogModal(log);
            if (action === 'duplicate') fillFormFromLog(log);
        }).finally(() => {
            actionBtn.disabled = false;
        });
    }

    function bindPreviewChange(el, eventName = 'input') {
        if (!el) return;
        el.addEventListener(eventName, () => schedulePreviewUpdate());
    }

    [recipientName, managerName, phone, viber, whatsapp, telegram, teeEntry, teeRetailExample, hoodieEntry, hoodieRetailExample, subjectCustom].forEach((el) => bindPreviewChange(el, 'input'));
    [mode, segmentMode, subjectPreset, subjectCustom].forEach((el) => bindPreviewChange(el, 'change'));
    [showManager, viberEnabled, whatsappEnabled, telegramEnabled].forEach((el) => bindPreviewChange(el, 'change'));

    [teeEntry, teeRetailExample, hoodieEntry, hoodieRetailExample].forEach((el) => {
        if (!el) return;
        el.addEventListener('input', syncUnitProfits);
    });

    if (subjectPreset) subjectPreset.addEventListener('change', syncSubjectCustom);
    if (showManager) showManager.addEventListener('change', syncMessengerUI);
    messengerRows.forEach(({ toggle, input }) => {
        toggle.addEventListener('change', syncMessengerUI);
        input.addEventListener('input', syncMessengerUI);
    });

    previewTabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const tab = btn.getAttribute('data-offer-preview-tab');
            if (!tab) return;
            setActivePreview(tab);
        });
    });

    if (mode) {
        mode.addEventListener('change', () => {
            const m = (mode.value || '').toUpperCase();
            if (m === 'LIGHT') setActivePreview('LIGHT');
            if (m === 'VISUAL') setActivePreview('VISUAL');
        });
    }

    logTabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const tab = btn.getAttribute('data-offer-log-tab');
            if (!tab) return;
            setActiveLog(tab);
        });
    });

    if (logClose) logClose.addEventListener('click', closeLogModal);
    if (logClose2) logClose2.addEventListener('click', closeLogModal);
    if (logModal) logModal.addEventListener('click', (e) => { if (e.target === logModal) closeLogModal(); });

    recipientEmail.addEventListener('input', scheduleDuplicateCheck);
    recipientEmail.addEventListener('change', scheduleDuplicateCheck);

    confirmCancel.addEventListener('click', closeConfirmModal);
    confirmClose.addEventListener('click', closeConfirmModal);
    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) closeConfirmModal();
    });
    confirmOk.addEventListener('click', () => {
        confirmResend.value = '1';
        closeConfirmModal();
        sendOffer();
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (dupExists && confirmResend.value !== '1') {
            openConfirmModal();
            return;
        }
        sendOffer();
    });

    if (historyBody) historyBody.addEventListener('click', handleHistoryClick);

    setActivePreview((mode && (mode.value || '').toUpperCase() === 'LIGHT') ? 'LIGHT' : 'VISUAL');
    syncSubjectCustom();
    syncMessengerUI();
    syncUnitProfits();
    schedulePreviewUpdate();
    scheduleDuplicateCheck();
});
</script>
{% endblock %}
