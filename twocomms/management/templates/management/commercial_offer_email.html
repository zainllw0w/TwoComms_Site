{% extends "management/base.html" %}

{% block title %}Комерційні пропозиції{% endblock %}

{% block content %}
<div class="clients-panel offer-panel">
    <div class="panel-header">
        <div>
            <p class="eyebrow">Комерційні пропозиції</p>
            <h2>Комерційні пропозиції</h2>
        </div>
        <div class="panel-actions">
            <a class="btn-ghost" href="{% url 'management_home' %}">← До панелі</a>
        </div>
    </div>

    <div class="cp-top-tabs" role="tablist" aria-label="Категорії КП">
        <a href="?tab=email" class="cp-top-tab{% if cp_tab == 'email' %} active{% endif %}" role="tab" aria-selected="{% if cp_tab == 'email' %}true{% else %}false{% endif %}">КП на e-mail</a>
        <a href="?tab=messengers" class="cp-top-tab{% if cp_tab == 'messengers' %} active{% endif %}" role="tab" aria-selected="{% if cp_tab == 'messengers' %}true{% else %}false{% endif %}">КП у месенджери</a>
    </div>

    <div class="cp-pane cp-pane-messengers" {% if cp_tab != 'messengers' %}style="display:none"{% endif %}>
        <div class="offer-grid offer-grid-single">
            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">КП у месенджери</p>
                        <h3 class="offer-card-title">Тільки копіювання — без відправлення із системи</h3>
                        <div class="offer-help">Оберіть варіант, натисніть «Скопіювати повідомлення» і надішліть вручну в месенджер.</div>
                    </div>
                </div>

                <div class="cp-messenger-toolbar">
                    <div class="cp-subtabs" role="tablist" aria-label="Канал">
                        <button type="button" class="cp-subtab active" data-channel="telegram">Telegram</button>
                        <button type="button" class="cp-subtab" data-channel="generic">Інші месенджери</button>
                    </div>
                </div>

                <div class="field-grid offer-fields cp-messenger-controls">
                    <div class="field">
                        <label for="cp-template-type">Шаблон повідомлення</label>
                        <select id="cp-template-type">
                            <option value="FIRST_CONTACT" selected>FIRST_CONTACT — перше повідомлення</option>
                            <option value="FOLLOW_UP">FOLLOW_UP — нагадування</option>
                            <option value="PRICING_REPLY">PRICING_REPLY — відповідь про ціни</option>
                            <option value="DROP_REPLY">DROP_REPLY — відповідь для дропу</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="cp-message-length">Довжина</label>
                        <select id="cp-message-length">
                            <option value="SHORT">SHORT — коротко</option>
                            <option value="STANDARD" selected>STANDARD — стандарт</option>
                            <option value="LONG">LONG — детальніше</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="cp-opt-tier">Обсяг опту (для розрахунку входу)</label>
                        <select id="cp-opt-tier">
                            <option value="">Не обрано (100+)</option>
                            <option value="8_15">8–15</option>
                            <option value="16_31">16–31</option>
                            <option value="32_63">32–63</option>
                            <option value="64_99">64–99</option>
                            <option value="100_PLUS">100+</option>
                        </select>
                    </div>
                    <div class="field field-span-2">
                        <label>Опції повідомлення</label>
                        <div class="cp-toggle-grid">
                            <label class="offer-check">
                                <input type="checkbox" id="cp-use-markdown" checked>
                                <span>Автоформат Telegram (жирний/курсив/цитата/спойлер/код)</span>
                            </label>
                            <label class="offer-check">
                                <input type="checkbox" id="cp-show-receipt" checked>
                                <span>Блок “квитанція/чек”</span>
                            </label>
                            <label class="offer-check">
                                <input type="checkbox" id="cp-show-opt-tiers">
                                <span>Показати ступені опту</span>
                            </label>
                            <label class="offer-check">
                                <input type="checkbox" id="cp-show-dropship-loyalty">
                                <span>Показати лояльність -10 грн/замовлення</span>
                            </label>
                            <label class="offer-check">
                                <input type="checkbox" id="cp-use-spoiler-hint">
                                <span>Підказка про спойлер (EDGY)</span>
                            </label>
                            <label class="offer-check">
                                <input type="checkbox" id="cp-include-general-tg" checked>
                                <span>Додати “запасний канал”</span>
                            </label>
                        </div>
                        <div class="cp-inline-hint" id="cp-spoiler-hint" hidden>
                            Якщо сегмент EDGY — назви можна приховати: виділи слово в Telegram → Формат → Спойлер.
                        </div>
                    </div>
                </div>

                <div class="cp-preview-hint" id="cp-mono-hint">
                    Формат Telegram застосовується автоматично при вставці (жирний/курсив/цитата/спойлер/код).
                </div>
                <div class="cp-preview-shell">
                    <div class="cp-preview" id="cp-preview" aria-label="Попередній перегляд"></div>
                </div>
                <div class="cp-validation" id="cp-validation"></div>

                <div class="cp-messenger-actions">
                    <button type="button" class="btn-primary" id="cp-copy-btn">Скопіювати повідомлення</button>
                    <div class="cp-copy-status" id="cp-copy-status" role="status" aria-live="polite"></div>
                </div>

                {{ messenger_context|json_script:"cp-messenger-context" }}
                <script>
                (function() {
                    const dataEl = document.getElementById('cp-messenger-context');
                    if (!dataEl) return;
                    let context = {};
                    try { context = JSON.parse(dataEl.textContent || '{}'); } catch (e) { context = {}; }

                    const preview = document.getElementById('cp-preview');
                    const copyBtn = document.getElementById('cp-copy-btn');
                    const statusEl = document.getElementById('cp-copy-status');
                    const validationEl = document.getElementById('cp-validation');
                    const monoHint = document.getElementById('cp-mono-hint');
                    const spoilerHint = document.getElementById('cp-spoiler-hint');
                    const subTabs = Array.from(document.querySelectorAll('.cp-subtab'));

                    const templateTypeEl = document.getElementById('cp-template-type');
                    const messageLengthEl = document.getElementById('cp-message-length');
                    const optTierEl = document.getElementById('cp-opt-tier');
                    const showReceiptEl = document.getElementById('cp-show-receipt');
                    const showOptTiersEl = document.getElementById('cp-show-opt-tiers');
                    const showDropshipEl = document.getElementById('cp-show-dropship-loyalty');
                    const useSpoilerHintEl = document.getElementById('cp-use-spoiler-hint');
                    const includeGeneralTgEl = document.getElementById('cp-include-general-tg');
                    const useMarkdownEl = document.getElementById('cp-use-markdown');
                    const shopNameEl = document.getElementById('recipient_name');
                    const segmentModeEl = document.getElementById('segment_mode');

                    const pricing = context.pricing || {};
                    const optTiers = pricing.optTiers || {};
                    const manager = context.manager || {};
                    const links = context.links || {};

                    const separator = '━━━━━━━━━━━━━━━━━━━━';
                    const monoHintTexts = {
                        auto: 'Формат Telegram застосовується автоматично при вставці (жирний/курсив/цитата/спойлер/код).',
                        manual: 'Щоб було як на скріні: після вставки виділи блок між лініями ━━━ і обери Формат → Моноширинний (або Code).',
                    };
                    const forbiddenPatterns = [
                        { pattern: /нуль\s+ризик/i, label: 'нуль ризиків' },
                        { pattern: /гарантован.*прибут/i, label: 'гарантований прибуток' },
                        { pattern: /маржа\s*40%/i, label: 'маржа 40% як факт' },
                        { pattern: /\bcrm\b/i, label: 'CRM' },
                    ];

                    let activeChannel = 'telegram';

                    const escapeHtml = (value) => String(value || '')
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\"/g, '&quot;')
                        .replace(/'/g, '&#39;');

                    const formatUah = (value) => {
                        if (!value && value !== 0) return '—';
                        return `${value} грн`;
                    };

                    const getOptTierEntry = () => {
                        const key = (optTierEl && optTierEl.value) || '';
                        if (key && optTiers[key]) return optTiers[key].hoodie || 0;
                        const fallback = optTiers['100_PLUS'] || {};
                        return fallback.hoodie || 0;
                    };

                    const getOptTierLabel = () => {
                        const key = (optTierEl && optTierEl.value) || '';
                        if (key && optTiers[key]) return optTiers[key].label || key;
                        return (optTiers['100_PLUS'] || {}).label || '100+';
                    };

                    const buildEntryText = () => {
                        const key = (optTierEl && optTierEl.value) || '';
                        if (key && optTiers[key]) {
                            return `(для обсягу ${getOptTierLabel()}) ${formatUah(getOptTierEntry())}`;
                        }
                        return `від ${formatUah(getOptTierEntry())}`;
                    };

                    const buildReceiptBlock = () => {
                        const hoodieRetail = (pricing.retailExamples || {}).hoodie || 0;
                        const hoodieEntry = getOptTierEntry();
                        const hoodieProfit = Math.max(0, hoodieRetail - hoodieEntry);
                        return [
                            separator,
                            'ЧЕК',
                            separator,
                            'ТЕСТ 14 ДНІВ  | S–XL',
                            'Оплата: лише доставка',
                            'Формат: Опт або Дроп',
                            '',
                            'ЮНІТ-ЕКОНОМІКА (ПРИКЛАД)',
                            'Худі (фліс):',
                            `вхід ${buildEntryText()}`,
                            `роздріб (приклад) ${formatUah(hoodieRetail)}`,
                            `прибуток ~${formatUah(hoodieProfit)}`,
                            separator,
                        ];
                    };

                    const buildDropshipLoyalty = () => {
                        if (!showDropshipEl || !showDropshipEl.checked) return [];
                        const step = pricing.dropshipLoyaltyStep || 10;
                        const maxDiscount = pricing.maxDropDiscount || 0;
                        const maxPart = maxDiscount ? ` до -${maxDiscount} грн/шт` : '';
                        return [`   + лояльність: кожне наступне замовлення -${step} грн (накопичується)${maxPart}`];
                    };

                    const buildOptTiersBlock = (forceShow) => {
                        if (!forceShow && (!showOptTiersEl || !showOptTiersEl.checked)) return [];
                        return [
                            '',
                            'Опт-ступені: 8–15 / 16–31 / 32–63 / 64–99 / 100+',
                            '(скажіться обсяг — підберу точний “вхід”)',
                        ];
                    };

                    const buildDisclaimer = () => [
                        'Це приклад розрахунку. Роздрібну ціну встановлюєте ви.',
                    ];

                    const buildSegmentLine = () => {
                        if (!useSpoilerHintEl || !useSpoilerHintEl.checked) return [];
                        const seg = (segmentModeEl && segmentModeEl.value) || 'NEUTRAL';
                        if (seg === 'EDGY') return ['Сегмент: зухвалі хіти'];
                        return [];
                    };

                    const buildFooter = (options) => {
                        const lines = [];
                        const includeContacts = options && options.includeContacts;
                        const includeManager = options && options.includeManager;
                        const includeBrand = options && options.includeBrand;
                        const includeGeneral = options && options.includeGeneral;

                        if (includeManager) lines.push(`— ${manager.name || 'менеджер TwoComms'}`);
                        if (includeContacts) {
                            if (manager.phone) lines.push(`Тел: ${manager.phone}`);
                            if (manager.telegram) lines.push(`TG: ${manager.telegram}`);
                        }
                        if (includeGeneral && links.general_tg) lines.push(`Запасний канал: ${links.general_tg}`);
                        if (includeBrand) lines.push('TwoComms — одяг для свідомих.');
                        return lines;
                    };

                    const buildFirstContact = (length) => {
                        const shopName = (shopNameEl && shopNameEl.value || '').trim();
                        const greetingName = shopName ? `, ${shopName}` : '';
                        const hoodieRetail = (pricing.retailExamples || {}).hoodie || 0;
                        const hoodieEntry = getOptTierEntry();
                        const hoodieProfit = Math.max(0, hoodieRetail - hoodieEntry);

                        if (length === 'SHORT') {
                            const lines = [
                                `Вітаю${greetingName}! Я ${manager.name || 'менеджер TwoComms'} з TwoComms.`,
                                '',
                                'Тест-ростовка S–XL на 14 днів:',
                                'повернення залишків, сплачуєте лише доставку.',
                                '',
                                ...buildSegmentLine(),
                                '',
                                'Опт (кратно 8) або Дроп (фікс).',
                            ];
                            if (showReceiptEl && showReceiptEl.checked) {
                                lines.push('');
                                lines.push(...buildReceiptBlock());
                                lines.push(...buildDisclaimer());
                            } else {
                                lines.push(`Приклад по худі: вхід ${buildEntryText()} → роздріб (приклад) ${formatUah(hoodieRetail)} → ~${formatUah(hoodieProfit)}`);
                                lines.push(...buildDisclaimer());
                            }
                            lines.push('');
                            lines.push(`Каталог: ${links.catalog || ''}`.trim());
                            lines.push('Якщо ок — напишіть “ТЕСТ”.');
                            lines.push('TwoComms — одяг для свідомих.');
                            return lines;
                        }

                        const lines = [
                            'TWOCOMMS • КП / ТЕСТ-РОСТОВКА (14 ДНІВ)',
                            '',
                            `Вітаю${greetingName}! Я ${manager.name || 'менеджер TwoComms'} з TwoComms (Street & Military).`,
                            '',
                            'Можемо відправити тест-ростовку S–XL на 14 днів:',
                            '• не зайшло — повертаєте залишки',
                            '• сплачуєте лише доставку',
                        ];

                        if (showReceiptEl && showReceiptEl.checked) {
                            lines.push('');
                            lines.push(...buildReceiptBlock());
                            lines.push(...buildDisclaimer());
                        } else {
                            lines.push('');
                            lines.push(`Юніт-економіка (приклад): худі — вхід ${buildEntryText()}, роздріб (приклад) ${formatUah(hoodieRetail)}, ~${formatUah(hoodieProfit)}.`);
                            lines.push(...buildDisclaimer());
                        }

                        lines.push('');
                        lines.push(...buildSegmentLine());
                        lines.push('Формати:');
                        lines.push('1) ОПТ — від 8 шт, договір/КЕП, ціна нижча при більшому обсягу (кратно 8)');
                        lines.push('2) ДРОП — без складу, XML, кабінет партнера (ТТН/трекінг)');
                        lines.push(...buildDropshipLoyalty());

                        lines.push(...buildOptTiersBlock(false));

                        if (length === 'LONG') {
                            lines.push('');
                            lines.push('Якщо підкажете обсяг і канал продажів — підкажу, що вигідніше: опт чи дроп.');
                        }

                        lines.push('');
                        lines.push('Каталог/умови:');
                        if (links.catalog) lines.push(`• ${links.catalog}`);
                        if (links.wholesale) lines.push(`• Опт: ${links.wholesale}`);
                        if (links.dropship) lines.push(`• Дроп: ${links.dropship}`);
                        lines.push('');
                        lines.push('Якщо цікаво — напишіть: ТЕСТ ✅');
                        lines.push('');
                        lines.push(...buildFooter({
                            includeContacts: true,
                            includeManager: true,
                            includeBrand: true,
                            includeGeneral: includeGeneralTgEl && includeGeneralTgEl.checked,
                        }));

                        return lines;
                    };

                    const buildFollowUp = (length) => {
                        const shopName = (shopNameEl && shopNameEl.value || '').trim();
                        const prefix = shopName ? `${shopName}, ` : '';
                        const lines = [
                            `${prefix}піднімусь коротко ⤴️`,
                            'Можу дати тест-ростовку S–XL на 14 днів (повернення залишків, оплата лише доставки).',
                            'Якщо цікаво — напишіть “ТЕСТ”.',
                            `— ${manager.name || 'менеджер TwoComms'}`,
                        ];
                        if (length === 'LONG') {
                            lines.splice(2, 0, 'Опт або дроп — підкажу найкращий варіант під ваш формат.');
                        }
                        if (includeGeneralTgEl && includeGeneralTgEl.checked && links.general_tg) {
                            lines.push(`Запасний канал: ${links.general_tg}`);
                        }
                        lines.push('TwoComms — одяг для свідомих.');
                        return lines;
                    };

                    const buildPricingReply = () => {
                        const lines = [
                            'Коротко по цінах:',
                            '• ДРОП — фікс (не залежить від кількості)',
                            '• ОПТ — залежить від обсягу (кратно 8)',
                            '',
                            'Опт-ступені: 8–15 / 16–31 / 32–63 / 64–99 / 100+',
                            '',
                            'Напишіть ваш плановий обсяг — і дам точний “вхід” під нього + підкажу що вигідніше (опт чи дроп).',
                            '',
                            'TwoComms — одяг для свідомих.',
                        ];
                        if (showDropshipEl && showDropshipEl.checked) {
                            lines.splice(4, 0, ...buildDropshipLoyalty());
                        }
                        return lines;
                    };

                    const buildDropReply = () => {
                        const hoodieRetail = (pricing.retailExamples || {}).hoodie || 0;
                        const dropHoodie = (pricing.dropFixed || {}).hoodie || 0;
                        const profit = Math.max(0, hoodieRetail - dropHoodie);

                        const lines = [
                            'Коротко по дропу:',
                            '• фікс ціна (не залежить від кількості)',
                            '• без складу, XML, кабінет партнера (ТТН/трекінг)',
                            ...buildDropshipLoyalty(),
                            '',
                            `Приклад по худі: вхід ${formatUah(dropHoodie)} → роздріб (приклад) ${formatUah(hoodieRetail)} → ~${formatUah(profit)}`,
                            ...buildDisclaimer(),
                            '',
                            'Якщо цікаво — напишіть: ТАК.',
                            'TwoComms — одяг для свідомих.',
                        ];
                        return lines;
                    };

                    const buildMessage = () => {
                        const templateType = (templateTypeEl && templateTypeEl.value) || 'FIRST_CONTACT';
                        const length = (messageLengthEl && messageLengthEl.value) || 'STANDARD';

                        if (templateType === 'FOLLOW_UP') return buildFollowUp(length);
                        if (templateType === 'PRICING_REPLY') return buildPricingReply();
                        if (templateType === 'DROP_REPLY') return buildDropReply();
                        return buildFirstContact(length);
                    };

                    const buildHtmlMessage = (plainText) => {
                        const lines = String(plainText || '').split('\n');
                        const separatorIndexes = [];
                        lines.forEach((line, idx) => {
                            const trimmed = line.trim();
                            if (trimmed && /^[━]+$/.test(trimmed)) {
                                separatorIndexes.push(idx);
                            }
                        });
                        const codeStart = separatorIndexes.length >= 2 ? separatorIndexes[0] : -1;
                        const codeEnd = separatorIndexes.length >= 2 ? separatorIndexes[separatorIndexes.length - 1] : -1;

                        const formatLine = (rawLine) => {
                            const line = rawLine || '';
                            const trimmed = line.trim();
                            if (!trimmed) return '';

                            const quoteLine = trimmed.replace(/^\*+|\*+$/g, '');
                            if (/Це приклад/i.test(quoteLine)) {
                                return `<blockquote><em>${escapeHtml(quoteLine)}</em></blockquote>`;
                            }

                            let safe = escapeHtml(line);
                            if (/^TWOCOMMS/i.test(trimmed)) {
                                return `<strong>${safe}</strong>`;
                            }
                            if (/^Коротко по/i.test(trimmed)) {
                                return `<strong>${safe}</strong>`;
                            }
                            if (/^Формати:/i.test(trimmed) || /^Каталог\/умови:/i.test(trimmed)) {
                                return `<u><strong>${safe}</strong></u>`;
                            }
                            if (/^ЮНІТ-ЕКОНОМІКА/i.test(trimmed)) {
                                return `<strong>${safe}</strong>`;
                            }
                            if (/напишіть/i.test(trimmed)) {
                                safe = safe.replace(/(ТЕСТ|ТАК)/g, '<u><strong>$1</strong></u>');
                                return `<strong>${safe}</strong>`;
                            }
                            if (/TwoComms — одяг для свідомих\./i.test(trimmed)) {
                                return `<em>${safe}</em>`;
                            }
                            if (/^2\) ДРОП/i.test(trimmed)) {
                                safe = safe.replace(/без складу/i, '<s>склад</s> без складу');
                                return safe;
                            }
                            if (useSpoilerHintEl && useSpoilerHintEl.checked && /зухвалі хіти/i.test(trimmed)) {
                                safe = safe.replace(/зухвалі хіти/gi, '<span class="tg-spoiler">зухвалі хіти</span>');
                                return safe;
                            }
                            return safe;
                        };

                        const htmlParts = [];
                        let idx = 0;
                        while (idx < lines.length) {
                            if (idx === codeStart && codeEnd >= codeStart) {
                                const block = lines.slice(codeStart, codeEnd + 1).join('\n');
                                htmlParts.push(`<pre><code>${escapeHtml(block)}</code></pre>`);
                                idx = codeEnd + 1;
                                continue;
                            }
                            const formatted = formatLine(lines[idx]);
                            if (!formatted) {
                                htmlParts.push('<div><br></div>');
                            } else if (formatted.startsWith('<blockquote>')) {
                                htmlParts.push(formatted);
                            } else {
                                htmlParts.push(`<div>${formatted}</div>`);
                            }
                            idx += 1;
                        }
                        return htmlParts.join('');
                    };

                    const wrapClipboardHtml = (fragment) => {
                        if (!fragment) return '';
                        return `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body><!--StartFragment-->${fragment}<!--EndFragment--></body></html>`;
                    };

                    const buildRtfMessage = (plainText) => {
                        const lines = String(plainText || '').split('\n');
                        const separatorIndexes = [];
                        lines.forEach((line, idx) => {
                            const trimmed = line.trim();
                            if (trimmed && /^[━]+$/.test(trimmed)) {
                                separatorIndexes.push(idx);
                            }
                        });
                        const codeStart = separatorIndexes.length >= 2 ? separatorIndexes[0] : -1;
                        const codeEnd = separatorIndexes.length >= 2 ? separatorIndexes[separatorIndexes.length - 1] : -1;

                        const rtfEscape = (text) => {
                            const value = String(text || '');
                            let out = '';
                            for (let i = 0; i < value.length; i += 1) {
                                const code = value.charCodeAt(i);
                                const ch = value[i];
                                if (ch === '\\') {
                                    out += '\\\\';
                                    continue;
                                }
                                if (ch === '{') {
                                    out += '\\{';
                                    continue;
                                }
                                if (ch === '}') {
                                    out += '\\}';
                                    continue;
                                }
                                if (code < 0x80) {
                                    out += ch;
                                    continue;
                                }
                                const signed = code > 0x7fff ? code - 0x10000 : code;
                                out += `\\u${signed}?`;
                            }
                            return out;
                        };

                        const rtfWrap = (text, options) => {
                            const opts = options || {};
                            let out = '';
                            if (opts.bold) out += '\\b ';
                            if (opts.italic) out += '\\i ';
                            if (opts.underline) out += '\\ul ';
                            if (opts.strike) out += '\\strike ';
                            out += rtfEscape(text);
                            if (opts.strike) out += '\\strike0 ';
                            if (opts.underline) out += '\\ul0 ';
                            if (opts.italic) out += '\\i0 ';
                            if (opts.bold) out += '\\b0 ';
                            return out;
                        };

                        const rtfBoldLineWithAction = (text) => {
                            const re = /(ТЕСТ|ТАК)/g;
                            let out = '\\b ';
                            let idx = 0;
                            let match;
                            while ((match = re.exec(text)) !== null) {
                                out += rtfEscape(text.slice(idx, match.index));
                                out += '\\ul ' + rtfEscape(match[0]) + '\\ul0 ';
                                idx = match.index + match[0].length;
                            }
                            out += rtfEscape(text.slice(idx)) + '\\b0 ';
                            return out;
                        };

                        let out = '{\\rtf1\\ansi\\deff0';
                        out += '{\\fonttbl{\\f0\\fnil Helvetica;}{\\f1\\fnil Courier New;}}';
                        out += '\\viewkind4\\uc1\\pard\\f0\\fs22 ';

                        lines.forEach((rawLine, idx) => {
                            const line = rawLine || '';
                            const trimmed = line.trim();
                            if (idx >= codeStart && idx <= codeEnd && codeStart >= 0) {
                                out += '\\f1\\fs20 ' + rtfEscape(line) + '\\par\\f0\\fs22 ';
                                return;
                            }
                            if (!trimmed) {
                                out += '\\par ';
                                return;
                            }
                            if (/Це приклад/i.test(trimmed)) {
                                out += '\\pard\\li360\\i ' + rtfEscape(trimmed) + '\\i0\\par\\pard\\li0 ';
                                return;
                            }
                            if (/^TWOCOMMS/i.test(trimmed) || /^Коротко по/i.test(trimmed) || /^ЮНІТ-ЕКОНОМІКА/i.test(trimmed)) {
                                out += rtfWrap(trimmed, { bold: true }) + '\\par ';
                                return;
                            }
                            if (/^Формати:/i.test(trimmed) || /^Каталог\/умови:/i.test(trimmed)) {
                                out += rtfWrap(trimmed, { bold: true, underline: true }) + '\\par ';
                                return;
                            }
                            if (/напишіть/i.test(trimmed)) {
                                out += rtfBoldLineWithAction(trimmed) + '\\par ';
                                return;
                            }
                            if (/TwoComms — одяг для свідомих\./i.test(trimmed)) {
                                out += rtfWrap(trimmed, { italic: true }) + '\\par ';
                                return;
                            }
                            if (/^2\) ДРОП/i.test(trimmed) && /без складу/i.test(trimmed)) {
                                const parts = trimmed.split(/без складу/i);
                                out += rtfEscape(parts[0].trimEnd() + ' ');
                                out += '\\strike ' + rtfEscape('склад') + '\\strike0 ';
                                out += rtfEscape(' без складу' + (parts[1] || '')) + '\\par ';
                                return;
                            }
                            out += rtfEscape(trimmed) + '\\par ';
                        });

                        out += '}';
                        return out;
                    };

                    const safeBuildHtml = (plainText) => {
                        try {
                            return buildHtmlMessage(plainText);
                        } catch (e) {
                            return '';
                        }
                    };

                    const safeBuildRtf = (plainText) => {
                        try {
                            return buildRtfMessage(plainText);
                        } catch (e) {
                            return '';
                        }
                    };

                    const buildClipboardPayload = (plainText) => {
                        const fragment = safeBuildHtml(plainText);
                        return {
                            plain: String(plainText || ''),
                            html: wrapClipboardHtml(fragment),
                            htmlFragment: fragment,
                            rtf: safeBuildRtf(plainText),
                        };
                    };

                    const buildClipboardItem = (payload, types) => {
                        const allowed = Array.isArray(types) ? types : [];
                        const item = {};
                        if (allowed.includes('rtf') && payload.rtf) {
                            item['text/rtf'] = new Blob([payload.rtf], { type: 'text/rtf' });
                        }
                        if (allowed.includes('html')) {
                            const html = payload.html || payload.htmlFragment;
                            if (html) item['text/html'] = new Blob([html], { type: 'text/html' });
                        }
                        if (allowed.includes('plain')) {
                            item['text/plain'] = new Blob([payload.plain], { type: 'text/plain' });
                        }
                        if (!Object.keys(item).length) return null;
                        return new ClipboardItem(item);
                    };

                    const copyClipboardPayload = async (payload) => {
                        if (!navigator.clipboard || !navigator.clipboard.write || !window.ClipboardItem) return false;
                        const attempts = [
                            ['rtf', 'html'],
                            ['html'],
                            ['rtf'],
                            ['rtf', 'html', 'plain'],
                            ['html', 'plain'],
                            ['plain'],
                        ];
                        for (const types of attempts) {
                            try {
                                const item = buildClipboardItem(payload, types);
                                if (!item) continue;
                                await navigator.clipboard.write([item]);
                                return true;
                            } catch (e) {
                                continue;
                            }
                        }
                        return false;
                    };

                    const copyWithFormats = (payload, includePlain) => {
                        try {
                            let ok = false;
                            const handler = (event) => {
                                const clipboardData = event.clipboardData;
                                if (!clipboardData) return;
                                if (payload.rtf) clipboardData.setData('text/rtf', payload.rtf);
                                if (payload.html) clipboardData.setData('text/html', payload.html);
                                if (includePlain || (!payload.rtf && !payload.html)) {
                                    clipboardData.setData('text/plain', payload.plain || '');
                                }
                                event.preventDefault();
                                ok = true;
                            };
                            document.addEventListener('copy', handler, { once: true });
                            const ta = document.createElement('textarea');
                            ta.value = payload.plain || '';
                            ta.setAttribute('readonly', '');
                            ta.style.position = 'fixed';
                            ta.style.left = '-9999px';
                            document.body.appendChild(ta);
                            ta.select();
                            document.execCommand('copy');
                            document.body.removeChild(ta);
                            return ok;
                        } catch (e) {
                            return false;
                        }
                    };

                    const copyRichHtml = (html, plainText) => {
                        try {
                            const container = document.createElement('div');
                            container.contentEditable = 'true';
                            container.style.position = 'fixed';
                            container.style.left = '-9999px';
                            container.style.top = '0';
                            container.style.whiteSpace = 'pre-wrap';
                            container.innerHTML = html || escapeHtml(plainText).replace(/\n/g, '<br>');
                            document.body.appendChild(container);
                            const selection = window.getSelection();
                            const range = document.createRange();
                            range.selectNodeContents(container);
                            selection.removeAllRanges();
                            selection.addRange(range);
                            const ok = document.execCommand('copy');
                            selection.removeAllRanges();
                            document.body.removeChild(container);
                            return ok;
                        } catch (e) {
                            return false;
                        }
                    };

                    const copyFromPreview = () => {
                        if (!preview) return false;
                        try {
                            const selection = window.getSelection();
                            const range = document.createRange();
                            range.selectNodeContents(preview);
                            selection.removeAllRanges();
                            selection.addRange(range);
                            const ok = document.execCommand('copy');
                            selection.removeAllRanges();
                            return ok;
                        } catch (e) {
                            return false;
                        }
                    };

                    const copyHtmlOnly = async (html) => {
                        if (!html) return false;
                        try {
                            if (navigator.clipboard && navigator.clipboard.write && window.ClipboardItem) {
                                const item = new ClipboardItem({
                                    'text/html': new Blob([html], { type: 'text/html' }),
                                });
                                await navigator.clipboard.write([item]);
                                return true;
                            }
                        } catch (e) {}
                        try {
                            let ok = false;
                            const handler = (event) => {
                                event.clipboardData.setData('text/html', html);
                                event.preventDefault();
                                ok = true;
                            };
                            document.addEventListener('copy', handler, { once: true });
                            document.execCommand('copy');
                            return ok;
                        } catch (e) {
                            return false;
                        }
                    };

                    const renderPreview = (txt) => {
                        if (!preview) return;
                        if (useMarkdownEl && useMarkdownEl.checked && activeChannel === 'telegram') {
                            const html = safeBuildHtml(txt);
                            if (html) {
                                preview.innerHTML = html;
                                return;
                            }
                        }
                        if (!txt) {
                            preview.textContent = '';
                            return;
                        }
                        const lines = String(txt).split('\n');
                        const separatorIndexes = [];
                        lines.forEach((line, idx) => {
                            const trimmed = line.trim();
                            if (trimmed && /^[━]+$/.test(trimmed)) {
                                separatorIndexes.push(idx);
                            }
                        });
                        if (separatorIndexes.length >= 2) {
                            const start = separatorIndexes[0];
                            const end = separatorIndexes[separatorIndexes.length - 1];
                            const before = lines.slice(0, start).join('\n');
                            const receipt = lines.slice(start, end + 1).join('\n');
                            const after = lines.slice(end + 1).join('\n');
                            const parts = [];
                            if (before) parts.push(escapeHtml(before));
                            parts.push(`<span class="cp-preview-receipt">${escapeHtml(receipt)}</span>`);
                            if (after) parts.push(escapeHtml(after));
                            preview.innerHTML = parts.join('\n');
                            return;
                        }
                        preview.textContent = txt;
                    };

                    const validateMessage = (txt) => {
                        const warnings = [];
                        forbiddenPatterns.forEach((item) => {
                            if (item.pattern.test(txt)) {
                                warnings.push({ kind: 'danger', text: `Знайдено заборонену фразу: ${item.label}` });
                            }
                        });
                        if (!String(txt).toUpperCase().includes('ПРИКЛАД')) {
                            warnings.push({ kind: 'warning', text: 'Немає позначки “ПРИКЛАД” у юніт-економіці.' });
                        }
                        if (String(txt).length > 4096) {
                            warnings.push({ kind: 'danger', text: `Довжина повідомлення ${String(txt).length} символів — ліміт Telegram 4096.` });
                        }
                        return warnings;
                    };

                    const renderValidation = (warnings) => {
                        if (!validationEl) return;
                        if (!warnings.length) {
                            validationEl.innerHTML = '';
                            return;
                        }
                        validationEl.innerHTML = warnings.map((item) => (
                            `<div class="cp-validation-item ${item.kind === 'danger' ? 'is-danger' : ''}">${escapeHtml(item.text)}</div>`
                        )).join('');
                    };

                    const setStatus = (msg, kind) => {
                        if (!statusEl) return;
                        statusEl.textContent = msg || '';
                        statusEl.dataset.kind = kind || '';
                        if (msg) {
                            clearTimeout(setStatus._t);
                            setStatus._t = setTimeout(() => { statusEl.textContent = ''; statusEl.dataset.kind = ''; }, 1800);
                        }
                    };

                    const copyText = async (txt) => {
                        if (useMarkdownEl && useMarkdownEl.checked && activeChannel === 'telegram') {
                            const payload = buildClipboardPayload(txt);
                            if (copyRichHtml(payload.htmlFragment || payload.html, txt)) return true;
                            if (copyFromPreview()) return true;
                            if (await copyClipboardPayload(payload)) return true;
                            if (copyWithFormats(payload, false)) return true;
                            if (copyWithFormats(payload, true)) return true;
                        }
                        try {
                            if (navigator.clipboard && navigator.clipboard.write && window.ClipboardItem) {
                                const item = new ClipboardItem({
                                    'text/plain': new Blob([txt], { type: 'text/plain' }),
                                });
                                await navigator.clipboard.write([item]);
                                return true;
                            }
                        } catch (e) {}
                        try {
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                await navigator.clipboard.writeText(txt);
                                return true;
                            }
                        } catch (e) {}
                        try {
                            const ta = document.createElement('textarea');
                            ta.value = txt;
                            ta.setAttribute('readonly', '');
                            ta.style.position = 'fixed';
                            ta.style.left = '-9999px';
                            document.body.appendChild(ta);
                            ta.select();
                            const ok = document.execCommand('copy');
                            document.body.removeChild(ta);
                            return ok;
                        } catch (e) {
                            return false;
                        }
                    };

                    const render = () => {
                        const txt = buildMessage().join('\n').trim();
                        renderPreview(txt);
                        renderValidation(validateMessage(txt));
                        if (monoHint) {
                            if (useMarkdownEl && useMarkdownEl.checked && activeChannel === 'telegram') {
                                monoHint.textContent = monoHintTexts.auto;
                            } else {
                                monoHint.textContent = monoHintTexts.manual;
                            }
                            monoHint.style.display = activeChannel === 'telegram' ? 'block' : 'none';
                        }
                        if (spoilerHint && useSpoilerHintEl) {
                            spoilerHint.hidden = !useSpoilerHintEl.checked;
                        }
                        return txt;
                    };

                    subTabs.forEach((btn) => {
                        btn.addEventListener('click', () => {
                            activeChannel = btn.dataset.channel || 'telegram';
                            subTabs.forEach(b => b.classList.toggle('active', b === btn));
                            render();
                        });
                    });

                    if (templateTypeEl) {
                        templateTypeEl.addEventListener('change', () => {
                            if (templateTypeEl.value === 'DROP_REPLY' && showDropshipEl) {
                                showDropshipEl.checked = true;
                            }
                            render();
                        });
                    }

                    [messageLengthEl, optTierEl, showReceiptEl, showOptTiersEl, showDropshipEl, useSpoilerHintEl, includeGeneralTgEl, useMarkdownEl, segmentModeEl].forEach((el) => {
                        if (!el) return;
                        el.addEventListener('change', render);
                    });

                    if (shopNameEl) {
                        shopNameEl.addEventListener('input', render);
                    }

                    if (copyBtn) {
                        copyBtn.addEventListener('click', async () => {
                            const txt = buildMessage().join('\n').trim();
                            if (!txt) return;
                            const ok = await copyText(txt);
                            setStatus(ok ? 'Скопійовано' : 'Не вдалося скопіювати', ok ? 'ok' : 'err');
                        });
                    }

                    render();
                })();
                </script>
            </div>
        </div>
    </div>

    <div class="cp-pane cp-pane-email" {% if cp_tab != 'email' %}style="display:none"{% endif %}>
    <div id="offer-alert-stack"></div>

    {% if sent_success %}
        <div class="offer-alert offer-alert-success">КП успішно надіслано.</div>
    {% endif %}

    {% if send_error %}
        <div class="offer-alert offer-alert-danger">{{ send_error }}</div>
    {% endif %}

    {% if form.non_field_errors %}
        <div class="offer-alert offer-alert-danger">{{ form.non_field_errors.0 }}</div>
    {% endif %}

    <div class="offer-grid">
        <form method="post" class="offer-form" id="offer-form" action="{% url 'management_commercial_offer_email' %}">
            {% csrf_token %}
            <input type="hidden" name="confirm_resend" id="confirm_resend" value="0">
            <input type="hidden" name="gallery_neutral" id="gallery_neutral" value="{{ gallery_neutral_json|default:'[]' }}">
            <input type="hidden" name="gallery_edgy" id="gallery_edgy" value="{{ gallery_edgy_json|default:'[]' }}">

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">Отримувач</p>
                        <h3 class="offer-card-title">Куди відправляємо</h3>
                    </div>
                </div>
                <div class="field-grid offer-fields">
                    <div class="field field-span-2">
                        <label for="recipient_email">Email</label>
                        <input type="email"
                               id="recipient_email"
                               name="recipient_email"
                               value="{{ form.recipient_email.value|default_if_none:'' }}"
                               placeholder="brand@example.com"
                               autocomplete="email"
                               required>
                        <div class="offer-dup-hint" id="offer-email-dup-hint" hidden></div>
                        {% if form.recipient_email.errors %}
                            <div class="offer-error">{{ form.recipient_email.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="field field-span-2">
                        <label for="recipient_name">Імʼя або компанія (опційно)</label>
                        <input type="text"
                               id="recipient_name"
                               name="recipient_name"
                               value="{{ form.recipient_name.value|default_if_none:'' }}"
                               placeholder="Наприклад: Brand / Олександр"
                               autocomplete="organization">
                        {% if form.recipient_name.errors %}
                            <div class="offer-error">{{ form.recipient_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">Шаблон</p>
                        <h3 class="offer-card-title">Режим, контент і тема</h3>
                    </div>
                </div>

                <div class="field-grid offer-fields">
                    <div class="field">
                        <label for="mode">Режим</label>
                        <select id="mode" name="mode">
                            {% with mode_val=form.mode.value|default:"VISUAL" %}
                                <option value="LIGHT" {% if mode_val == "LIGHT" %}selected{% endif %}>LIGHT — максимальна доставлюваність</option>
                                <option value="VISUAL" {% if mode_val == "VISUAL" %}selected{% endif %}>VISUAL — красивий HTML (Safe Dark)</option>
                            {% endwith %}
                        </select>
                        <div class="offer-field-hint">Light — майже plain-text. Visual — компактний брендований лист.</div>
                        {% if form.mode.errors %}
                            <div class="offer-error">{{ form.mode.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field">
                        <label for="segment_mode">Сегмент</label>
                        <select id="segment_mode" name="segment_mode">
                            {% with seg_val=form.segment_mode.value|default:"NEUTRAL" %}
                                <option value="NEUTRAL" {% if seg_val == "NEUTRAL" %}selected{% endif %}>NEUTRAL — спокійні хіти</option>
                                <option value="EDGY" {% if seg_val == "EDGY" %}selected{% endif %}>EDGY — дерзкі хіти</option>
                            {% endwith %}
                        </select>
                        <div class="offer-field-hint">Впливає на підбірку товарів у листі.</div>
                        {% if form.segment_mode.errors %}
                            <div class="offer-error">{{ form.segment_mode.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2">
                        <label for="subject_preset">Тема листа</label>
                        <select id="subject_preset" name="subject_preset">
                            {% with subject_val=form.subject_preset.value|default:"PRESET_1" %}
                                <option value="PRESET_1" {% if subject_val == "PRESET_1" %}selected{% endif %}>TwoComms: Тест-ростовка 14 днів…</option>
                                <option value="PRESET_2" {% if subject_val == "PRESET_2" %}selected{% endif %}>Опт від 8 шт / Дропшип…</option>
                                <option value="PRESET_3" {% if subject_val == "PRESET_3" %}selected{% endif %}>📦 Тест-драйв 14 днів…</option>
                                <option value="CUSTOM" {% if subject_val == "CUSTOM" %}selected{% endif %}>Custom</option>
                            {% endwith %}
                        </select>
                        {% if form.subject_preset.errors %}
                            <div class="offer-error">{{ form.subject_preset.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2" id="subject_custom_wrap" {% if form.subject_preset.value != "CUSTOM" %}hidden{% endif %}>
                        <label for="subject_custom">Custom тема</label>
                        <input type="text"
                               id="subject_custom"
                               name="subject_custom"
                               value="{{ form.subject_custom.value|default_if_none:'' }}"
                               placeholder="Напишіть свою тему листа">
                        {% if form.subject_custom.errors %}
                            <div class="offer-error">{{ form.subject_custom.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="offer-unit">
                    <div class="offer-unit-head">
                        <div class="offer-unit-head-row">
                            <div>
                                <div class="offer-unit-title">Приклад юніт-економіки</div>
                                <div class="offer-unit-sub">Це приклад розрахунку. Роздрібну ціну встановлюєте ви.</div>
                            </div>
                            <button type="button" class="btn-ghost small" id="offer-unit-fill-defaults">Заповнити дефолтами</button>
                        </div>
                        <div class="offer-unit-note" id="offer-unit-note" hidden></div>
                    </div>

                    <div class="offer-unit-controls">
                        <div class="field">
                            <label for="pricing_mode">Приклад: база “вхід”</label>
                            <select id="pricing_mode" name="pricing_mode">
                                {% with pval=form.pricing_mode.value|default:"OPT" %}
                                    <option value="OPT" {% if pval == "OPT" %}selected{% endif %}>OPT — опт (tier)</option>
                                    <option value="DROP" {% if pval == "DROP" %}selected{% endif %}>DROP — дроп (фікс)</option>
                                {% endwith %}
                            </select>
                        </div>
                        <div class="field" id="opt_tier_wrap">
                            <label for="opt_tier">Опт: обсяг (tier)</label>
                            <select id="opt_tier" name="opt_tier">
                                {% with tval=form.opt_tier.value|default:"8_15" %}
                                    <option value="8_15" {% if tval == "8_15" %}selected{% endif %}>8–15 (мінімальне)</option>
                                    <option value="16_31" {% if tval == "16_31" %}selected{% endif %}>16–31</option>
                                    <option value="32_63" {% if tval == "32_63" %}selected{% endif %}>32–63</option>
                                    <option value="64_99" {% if tval == "64_99" %}selected{% endif %}>64–99</option>
                                    <option value="100_PLUS" {% if tval == "100_PLUS" %}selected{% endif %}>100+ (макс вигода)</option>
                                {% endwith %}
                            </select>
                            <div class="offer-field-hint">Впливає на вхідні ціни в листі (опт).</div>
                        </div>
                    </div>

                    <details class="offer-unit-advanced" id="offer-drop-advanced">
                        <summary>Дроп ціни (advanced)</summary>
                        <div class="field-grid offer-unit-advanced-grid">
                            <div class="field">
                                <label for="drop_tee_price">Футболка — дроп (грн)</label>
                                <input type="number"
                                       id="drop_tee_price"
                                       name="drop_tee_price"
                                       value="{{ form.drop_tee_price.value|default_if_none:'' }}"
                                       placeholder="Напр. 570"
                                       inputmode="numeric">
                                {% if form.drop_tee_price.errors %}
                                    <div class="offer-error">{{ form.drop_tee_price.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="field">
                                <label for="drop_hoodie_price">Худі — дроп (грн)</label>
                                <input type="number"
                                       id="drop_hoodie_price"
                                       name="drop_hoodie_price"
                                       value="{{ form.drop_hoodie_price.value|default_if_none:'' }}"
                                       placeholder="Напр. 1350"
                                       inputmode="numeric">
                                {% if form.drop_hoodie_price.errors %}
                                    <div class="offer-error">{{ form.drop_hoodie_price.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </details>

                    <label class="offer-check offer-check-link offer-unit-loyalty">
                        <input type="checkbox" id="dropship_loyalty_bonus" name="dropship_loyalty_bonus" {% if form.dropship_loyalty_bonus.value %}checked{% endif %}>
                        <span>Показувати бонус дроп-лояльності (-10 грн до наступного замовлення)</span>
                    </label>

                    <div class="field-grid offer-unit-grid">
                        <div class="field">
                            <label for="tee_entry">Футболка — вхід (грн)</label>
                            <input type="number"
                                   id="tee_entry"
                                   name="tee_entry"
                                   value="{{ form.tee_entry.value|default_if_none:'' }}"
                                   placeholder="Напр. 540"
                                   inputmode="numeric">
                            {% if form.tee_entry.errors %}
                                <div class="offer-error">{{ form.tee_entry.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field">
                            <label for="tee_retail_example">Футболка — роздріб (приклад, грн)</label>
                            <input type="number"
                                   id="tee_retail_example"
                                   name="tee_retail_example"
                                   value="{{ form.tee_retail_example.value|default_if_none:'' }}"
                                   placeholder="Напр. 750"
                                   inputmode="numeric">
                            <div class="offer-profit-line">Різниця*: <span class="offer-profit" id="tee_profit_display">—</span> грн</div>
                            <div class="offer-field-warn" id="tee_profit_warn" hidden></div>
                            {% if form.tee_retail_example.errors %}
                                <div class="offer-error">{{ form.tee_retail_example.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field">
                            <label for="hoodie_entry">Худі — вхід (грн)</label>
                            <input type="number"
                                   id="hoodie_entry"
                                   name="hoodie_entry"
                                   value="{{ form.hoodie_entry.value|default_if_none:'' }}"
                                   placeholder="Напр. 1300"
                                   inputmode="numeric">
                            {% if form.hoodie_entry.errors %}
                                <div class="offer-error">{{ form.hoodie_entry.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field">
                            <label for="hoodie_retail_example">Худі — роздріб (приклад, грн)</label>
                            <input type="number"
                                   id="hoodie_retail_example"
                                   name="hoodie_retail_example"
                                   value="{{ form.hoodie_retail_example.value|default_if_none:'' }}"
                                   placeholder="Напр. 1790"
                                   inputmode="numeric">
                            <div class="offer-profit-line">Різниця*: <span class="offer-profit" id="hoodie_profit_display">—</span> грн</div>
                            <div class="offer-field-warn" id="hoodie_profit_warn" hidden></div>
                            {% if form.hoodie_retail_example.errors %}
                                <div class="offer-error">{{ form.hoodie_retail_example.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">Оффер</p>
                        <h3 class="offer-card-title">CTA і мікротекст</h3>
                    </div>
                </div>

                <div class="field-grid offer-fields">
                    <div class="field">
                        <label for="cta_type">Куди веде кнопка</label>
                        <select id="cta_type" name="cta_type">
                            {% with cta_val=form.cta_type.value|default:"" %}
                                <option value="" {% if cta_val == "" %}selected{% endif %}>Авто (рекомендовано)</option>
                                <option value="TELEGRAM_MANAGER" {% if cta_val == "TELEGRAM_MANAGER" %}selected{% endif %}>Telegram менеджера</option>
                                <option value="WHATSAPP_MANAGER" {% if cta_val == "WHATSAPP_MANAGER" %}selected{% endif %}>WhatsApp менеджера</option>
                                <option value="TELEGRAM_GENERAL" {% if cta_val == "TELEGRAM_GENERAL" %}selected{% endif %}>Telegram загальний</option>
                                <option value="MAILTO_COOPERATION" {% if cta_val == "MAILTO_COOPERATION" %}selected{% endif %}>Email cooperation@</option>
                                <option value="REPLY_HINT_ONLY" {% if cta_val == "REPLY_HINT_ONLY" %}selected{% endif %}>Відповідь на лист (без лінка)</option>
                                <option value="CUSTOM_URL" {% if cta_val == "CUSTOM_URL" %}selected{% endif %}>Свій URL</option>
                            {% endwith %}
                        </select>
                        <div class="offer-field-hint">Авто: Telegram менеджера → WhatsApp менеджера → email.</div>
                        {% if form.cta_type.errors %}
                            <div class="offer-error">{{ form.cta_type.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field">
                        <label for="cta_button_text">Текст кнопки</label>
                        <input type="text"
                               id="cta_button_text"
                               name="cta_button_text"
                               value="{{ form.cta_button_text.value|default_if_none:'' }}"
                               placeholder="Запросити тест-ростовку">
                        {% if form.cta_button_text.errors %}
                            <div class="offer-error">{{ form.cta_button_text.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2" id="cta_custom_url_wrap" {% if form.cta_type.value != "CUSTOM_URL" %}hidden{% endif %}>
                        <label for="cta_custom_url">Custom URL</label>
                        <input type="url"
                               id="cta_custom_url"
                               name="cta_custom_url"
                               value="{{ form.cta_custom_url.value|default_if_none:'' }}"
                               placeholder="https://...">
                        {% if form.cta_custom_url.errors %}
                            <div class="offer-error">{{ form.cta_custom_url.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2">
                        <label for="cta_microtext">Мікротекст під CTA</label>
                        <input type="text"
                               id="cta_microtext"
                               name="cta_microtext"
                               value="{{ form.cta_microtext.value|default_if_none:'' }}"
                               placeholder="Менеджер підтвердить умови під ваш обсяг.">
                        {% if form.cta_microtext.errors %}
                            <div class="offer-error">{{ form.cta_microtext.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">Посилання</p>
                        <h3 class="offer-card-title">Що додати в лист</h3>
                    </div>
                </div>

                <div class="offer-links-grid">
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_catalog_link" name="include_catalog_link" {% if form.include_catalog_link.value %}checked{% endif %}>
                        <span>Каталог</span>
                    </label>
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_wholesale_link" name="include_wholesale_link" {% if form.include_wholesale_link.value %}checked{% endif %}>
                        <span>Опт</span>
                    </label>
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_dropship_link" name="include_dropship_link" {% if form.include_dropship_link.value %}checked{% endif %}>
                        <span>Дроп</span>
                    </label>
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_instagram_link" name="include_instagram_link" {% if form.include_instagram_link.value %}checked{% endif %}>
                        <span>Instagram</span>
                    </label>
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_site_link" name="include_site_link" {% if form.include_site_link.value %}checked{% endif %}>
                        <span>Сайт</span>
                    </label>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">Товари</p>
                        <h3 class="offer-card-title">Товари в листі (галерея)</h3>
                    </div>
                    <div class="offer-card-actions">
                        <button type="button" class="btn-ghost small" id="offer-gallery-default">Дефолт для сегмента</button>
                        <button type="button" class="btn-ghost small" id="offer-gallery-add">+ Слот</button>
                        <button type="button" class="btn-ghost small" id="offer-gallery-remove">− Слот</button>
                    </div>
                </div>

                <div class="offer-field-hint">
                    Вставте URL товару (<span class="offer-mono">/product/...</span>) або URL картинки. Порожні слоти в лист не потраплять.
                </div>

                <div class="offer-gallery" id="offer-gallery">
                    <div class="offer-gallery-list" id="offer-gallery-list"></div>
                    <div class="offer-gallery-note" id="offer-gallery-note" hidden></div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">Відправник</p>
                        <h3 class="offer-card-title">Налаштування менеджера</h3>
                    </div>
                </div>

                <div class="offer-toggle-row">
                    <label class="offer-switch" aria-label="Показувати менеджера">
                        <input type="checkbox" id="show_manager" name="show_manager" {% if form.show_manager.value %}checked{% endif %}>
                        <span class="offer-switch-track"></span>
                    </label>
                    <div class="offer-toggle-meta">
                        <div class="offer-toggle-title">Показувати менеджера у листі</div>
                        <div class="offer-toggle-sub">Якщо вимкнути — лист буде без персональних контактів.</div>
                    </div>
                </div>

                <div class="field-grid offer-fields">
                    <div class="field">
                        <label for="manager_name">Імʼя менеджера</label>
                        <input type="text"
                               id="manager_name"
                               name="manager_name"
                               value="{{ form.manager_name.value|default_if_none:'' }}"
                               placeholder="Ваше імʼя"
                               autocomplete="name">
                        {% if form.manager_name.errors %}
                            <div class="offer-error">{{ form.manager_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="field">
                        <label for="general_tg">Резервний Telegram (опційно)</label>
                        <input type="text"
                               id="general_tg"
                               name="general_tg"
                               value="{{ form.general_tg.value|default_if_none:'' }}"
                               placeholder="https://t.me/twocomms або @username"
                               autocomplete="url">
                        {% if form.general_tg.errors %}
                            <div class="offer-error">{{ form.general_tg.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="offer-messengers">
                    <div class="offer-messengers-head">
                        <p class="eyebrow">Контакти</p>
                        <h4 class="offer-messengers-title">Контакти менеджера</h4>
                    </div>

                    <div class="offer-messenger-row" data-messenger="phone">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="phone_enabled" name="phone_enabled" {% if form.phone_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-phone" aria-hidden="true">☎</span>
                                <span>Телефон</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="tel"
                                   id="phone"
                                   name="phone"
                                   value="{{ form.phone.value|default_if_none:'' }}"
                                   placeholder="+380XXXXXXXXX"
                                   class="offer-messenger-input"
                                   autocomplete="tel">
                            <div class="offer-messenger-help">Формат: +380XXXXXXXXX</div>
                        </div>
                    </div>
                    {% if form.phone.errors %}
                        <div class="offer-error">{{ form.phone.errors.0 }}</div>
                    {% endif %}

                    <div class="offer-messenger-row" data-messenger="viber">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="viber_enabled" name="viber_enabled" {% if form.viber_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-viber" aria-hidden="true">V</span>
                                <span>Viber</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="text"
                                   id="viber"
                                   name="viber"
                                   value="{{ form.viber.value|default_if_none:'' }}"
                                   placeholder="+380... (номер)"
                                   class="offer-messenger-input"
                                   autocomplete="tel">
                            <div class="offer-messenger-help">Вкажіть номер телефону для Viber</div>
                        </div>
                    </div>
                    {% if form.viber.errors %}
                        <div class="offer-error">{{ form.viber.errors.0 }}</div>
                    {% endif %}

                    <div class="offer-messenger-row" data-messenger="whatsapp">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="whatsapp_enabled" name="whatsapp_enabled" {% if form.whatsapp_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-whatsapp" aria-hidden="true">W</span>
                                <span>WhatsApp</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="text"
                                   id="whatsapp"
                                   name="whatsapp"
                                   value="{{ form.whatsapp.value|default_if_none:'' }}"
                                   placeholder="+380... (номер)"
                                   class="offer-messenger-input"
                                   autocomplete="tel">
                            <div class="offer-messenger-help">Вкажіть номер телефону для WhatsApp</div>
                        </div>
                    </div>
                    {% if form.whatsapp.errors %}
                        <div class="offer-error">{{ form.whatsapp.errors.0 }}</div>
                    {% endif %}

                    <div class="offer-messenger-row" data-messenger="telegram">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="telegram_enabled" name="telegram_enabled" {% if form.telegram_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-telegram" aria-hidden="true">T</span>
                                <span>Telegram</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="text"
                                   id="telegram"
                                   name="telegram"
                                   value="{{ form.telegram.value|default_if_none:'' }}"
                                   placeholder="@username або +380..."
                                   class="offer-messenger-input"
                                   autocomplete="username">
                            <div class="offer-messenger-help">Логін @username або номер телефону для Telegram</div>
                        </div>
                    </div>
                    {% if form.telegram.errors %}
                        <div class="offer-error">{{ form.telegram.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="offer-actions">
                <button type="submit" class="btn-primary offer-submit" id="offer-submit">
                    <span class="offer-btn-spinner" aria-hidden="true"></span>
                    <span class="offer-btn-text">Відправити комерційну пропозицію</span>
                </button>
                <div class="offer-actions-sub">
                    Відправлення піде з пошти <span class="offer-mono">cooperation@twocomms.shop</span>.
                </div>
            </div>
        </form>

        <div class="offer-preview">
            <div class="offer-card offer-preview-card">
                <div class="offer-card-head offer-preview-head">
                    <div>
                        <p class="eyebrow">Превʼю</p>
                        <h3 class="offer-card-title">Як виглядатиме лист</h3>
                    </div>
                    <div class="offer-preview-actions">
                        <div class="offer-preview-tabs" id="offer-preview-tabs" data-default-tab="{{ preview_mode|default:'VISUAL' }}">
                            <button type="button" class="offer-preview-tab" data-offer-preview-tab="VISUAL">VISUAL</button>
                            <button type="button" class="offer-preview-tab" data-offer-preview-tab="LIGHT">LIGHT</button>
                        </div>
                        <div class="offer-preview-sizes" id="offer-preview-sizes">
                            <button type="button" class="offer-preview-size" data-offer-preview-size="DESKTOP">600px</button>
                            <button type="button" class="offer-preview-size" data-offer-preview-size="MOBILE">360px</button>
                        </div>
                        <label class="offer-check offer-check-link offer-preview-images">
                            <input type="checkbox" id="offer-preview-images-toggle" checked>
                            <span>Показувати картинки</span>
                        </label>
                    </div>
                </div>
                <div class="offer-preview-meta">
                    <div class="offer-preview-meta-line">
                        <span class="offer-preview-meta-label">Тема</span>
                        <span class="offer-preview-meta-value" id="offer-preview-subject">{{ preview_subject }}</span>
                    </div>
                    <div class="offer-preview-meta-sub" id="offer-preview-preheader">{{ preview_preheader }}</div>
                </div>
                <div class="offer-preview-surface" id="offer-preview-surface">
                    <div class="offer-preview-viewport" id="offer-preview-viewport">
                        <template id="offer-preview-initial-visual">{{ preview_visual_html|safe }}</template>
                        <iframe class="offer-preview-pane offer-preview-iframe"
                                id="offer-preview-visual"
                                title="VISUAL preview"
                                sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>
                        <pre class="offer-preview-pane offer-preview-pane-light" id="offer-preview-light">{{ preview_light_text }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="offer-history">
        <div class="panel-header offer-history-head">
            <div>
                <p class="eyebrow">Історія</p>
                <h3 class="offer-card-title">Останні відправлені КП</h3>
            </div>
        </div>
        <div class="table-shell">
            <table class="nexus-table">
                <thead>
                    <tr>
                        <th>Отримувач</th>
                        <th>Дані в листі</th>
                        <th>Статус</th>
                        <th>Дата</th>
                        <th>Дії</th>
                    </tr>
                </thead>
                <tbody id="offer-history-body">
                    {% if logs %}
                        {% for log in logs %}
                            {% include "management/partials/commercial_offer_log_row.html" with log=log %}
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td class="table-empty" colspan="5">Поки що немає відправлених КП</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal-overlay" id="offer-confirm-modal" aria-hidden="true">
    <div class="modal-card offer-confirm-card">
        <div class="modal-header">
            <div>
                <p class="eyebrow">Підтвердження</p>
                <h3>Повторна відправка</h3>
            </div>
            <button type="button" class="modal-close" id="offer-confirm-close" aria-label="Закрити">×</button>
        </div>
        <div class="modal-body">
            <p class="offer-confirm-text" id="offer-confirm-text">
                На цей email вже відправляли комерційну пропозицію. Відправити ще раз?
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost" id="offer-confirm-cancel">Скасувати</button>
            <button type="button" class="btn-primary" id="offer-confirm-ok">Так, відправити</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="offer-log-modal" aria-hidden="true">
    <div class="modal-card offer-log-card">
        <div class="modal-header">
            <div>
                <p class="eyebrow">Перегляд</p>
                <h3 id="offer-log-modal-title">Лист</h3>
                <div class="offer-log-modal-meta" id="offer-log-modal-meta"></div>
            </div>
            <button type="button" class="modal-close" id="offer-log-close" aria-label="Закрити">×</button>
        </div>
        <div class="modal-body offer-log-modal-body">
            <div class="offer-preview-tabs offer-log-tabs" id="offer-log-tabs">
                <button type="button" class="offer-preview-tab" data-offer-log-tab="VISUAL">VISUAL</button>
                <button type="button" class="offer-preview-tab" data-offer-log-tab="LIGHT">LIGHT</button>
            </div>

            <div class="offer-log-pane offer-log-pane-visual" id="offer-log-pane-visual">
                <iframe class="offer-log-iframe" id="offer-log-iframe" title="Email preview" sandbox=""></iframe>
            </div>

            <pre class="offer-log-pane offer-log-pane-light" id="offer-log-pane-light"></pre>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost small" id="offer-log-copy-text">Скопіювати текст</button>
            <button type="button" class="btn-ghost small" id="offer-log-copy-html">Скопіювати HTML</button>
            <button type="button" class="btn-ghost" id="offer-log-close-2">Закрити</button>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function initManagementCommercialOfferEmailPage() {
    const form = document.getElementById('offer-form');
    if (!form) return;
    if (form.dataset.mgmtInitialized === '1') return;
    form.dataset.mgmtInitialized = '1';

	    const previewVisual = document.getElementById('offer-preview-visual');
	    const previewInitialVisual = document.getElementById('offer-preview-initial-visual');
	    const previewImagesToggle = document.getElementById('offer-preview-images-toggle');
	    const previewLight = document.getElementById('offer-preview-light');
	    const previewSubject = document.getElementById('offer-preview-subject');
	    const previewPreheader = document.getElementById('offer-preview-preheader');
	    const previewTabButtons = Array.from(document.querySelectorAll('[data-offer-preview-tab]'));

    const alertStack = document.getElementById('offer-alert-stack');
    const historyBody = document.getElementById('offer-history-body');

    const confirmModal = document.getElementById('offer-confirm-modal');
    const confirmOk = document.getElementById('offer-confirm-ok');
    const confirmCancel = document.getElementById('offer-confirm-cancel');
    const confirmClose = document.getElementById('offer-confirm-close');
    const confirmText = document.getElementById('offer-confirm-text');
    const confirmResend = document.getElementById('confirm_resend');

    const logModal = document.getElementById('offer-log-modal');
    const logClose = document.getElementById('offer-log-close');
    const logClose2 = document.getElementById('offer-log-close-2');
    const logCopyText = document.getElementById('offer-log-copy-text');
    const logCopyHtml = document.getElementById('offer-log-copy-html');
    const logTitle = document.getElementById('offer-log-modal-title');
    const logMeta = document.getElementById('offer-log-modal-meta');
    const logIframe = document.getElementById('offer-log-iframe');
    const logPaneVisual = document.getElementById('offer-log-pane-visual');
    const logPaneLight = document.getElementById('offer-log-pane-light');
    const logTabButtons = Array.from(document.querySelectorAll('[data-offer-log-tab]'));

    const submitBtn = document.getElementById('offer-submit');
    const submitText = submitBtn?.querySelector('.offer-btn-text');

    const recipientEmail = document.getElementById('recipient_email');
    const recipientName = document.getElementById('recipient_name');
    const mode = document.getElementById('mode');
    const segmentMode = document.getElementById('segment_mode');
    const subjectPreset = document.getElementById('subject_preset');
    const subjectCustomWrap = document.getElementById('subject_custom_wrap');
    const subjectCustom = document.getElementById('subject_custom');

    const ctaType = document.getElementById('cta_type');
    const ctaButtonText = document.getElementById('cta_button_text');
    const ctaCustomUrlWrap = document.getElementById('cta_custom_url_wrap');
    const ctaCustomUrl = document.getElementById('cta_custom_url');
    const ctaMicrotext = document.getElementById('cta_microtext');

    const includeCatalogLink = document.getElementById('include_catalog_link');
    const includeWholesaleLink = document.getElementById('include_wholesale_link');
    const includeDropshipLink = document.getElementById('include_dropship_link');
    const includeInstagramLink = document.getElementById('include_instagram_link');
    const includeSiteLink = document.getElementById('include_site_link');

    const teeEntry = document.getElementById('tee_entry');
    const teeRetailExample = document.getElementById('tee_retail_example');
    const hoodieEntry = document.getElementById('hoodie_entry');
    const hoodieRetailExample = document.getElementById('hoodie_retail_example');
    const teeProfitDisplay = document.getElementById('tee_profit_display');
    const hoodieProfitDisplay = document.getElementById('hoodie_profit_display');
    const teeProfitWarn = document.getElementById('tee_profit_warn');
    const hoodieProfitWarn = document.getElementById('hoodie_profit_warn');
	    const unitFillDefaultsBtn = document.getElementById('offer-unit-fill-defaults');
	    const unitNote = document.getElementById('offer-unit-note');
	    const pricingMode = document.getElementById('pricing_mode');
	    const optTierWrap = document.getElementById('opt_tier_wrap');
	    const optTier = document.getElementById('opt_tier');
	    const dropTeePrice = document.getElementById('drop_tee_price');
	    const dropHoodiePrice = document.getElementById('drop_hoodie_price');
	    const dropshipLoyaltyBonus = document.getElementById('dropship_loyalty_bonus');

    const showManager = document.getElementById('show_manager');
    const managerName = document.getElementById('manager_name');
    const generalTg = document.getElementById('general_tg');
    const phoneEnabled = document.getElementById('phone_enabled');
    const phone = document.getElementById('phone');
    const viberEnabled = document.getElementById('viber_enabled');
    const viber = document.getElementById('viber');
    const whatsappEnabled = document.getElementById('whatsapp_enabled');
    const whatsapp = document.getElementById('whatsapp');
    const telegramEnabled = document.getElementById('telegram_enabled');
    const telegram = document.getElementById('telegram');

    const galleryNeutral = document.getElementById('gallery_neutral');
    const galleryEdgy = document.getElementById('gallery_edgy');
    const galleryList = document.getElementById('offer-gallery-list');
    const galleryNote = document.getElementById('offer-gallery-note');
    const galleryBtnDefault = document.getElementById('offer-gallery-default');
    const galleryBtnAdd = document.getElementById('offer-gallery-add');
    const galleryBtnRemove = document.getElementById('offer-gallery-remove');

    const previewViewport = document.getElementById('offer-preview-viewport');
    const previewSizeButtons = Array.from(document.querySelectorAll('[data-offer-preview-size]'));

    const dupHint = document.getElementById('offer-email-dup-hint');
    let dupExists = false;
    let dupCount = 0;
    let dupLast = '';
    let checkTimer = null;
    let abortController = null;

    let previewTimer = null;
    let previewAbortController = null;
    let activePreviewTab = 'VISUAL';
    let activeLogTab = 'VISUAL';
    let activePreviewSize = 'DESKTOP';
    let currentLogHtml = '';
    let currentLogText = '';

    let unitDefaults = null;

    const galleryState = {
        NEUTRAL: [],
        EDGY: [],
    };
    const gallerySlots = {
        NEUTRAL: 3,
        EDGY: 3,
    };
    const galleryResolveTimers = new Map();

    function parseIntSafe(value) {
        const raw = String(value || '').replace(/\s+/g, '').trim();
        if (!raw) return null;
        const num = Number(raw);
        if (!Number.isFinite(num)) return null;
        return Math.trunc(num);
    }

    function fmtNumber(value) {
        if (value === null || value === undefined) return '—';
        try {
            return Number(value).toLocaleString('uk-UA');
        } catch (e) {
            return String(value);
        }
    }

    function syncUnitProfits() {
        const defaultVal = (key) => {
            if (!unitDefaults) return null;
            const v = unitDefaults[key];
            return Number.isFinite(v) ? Math.trunc(v) : null;
        };

        const effective = (el, key) => {
            const v = parseIntSafe(el?.value);
            if (v !== null) return v;
            return defaultVal(key);
        };

        const setWarn = (warnEl, inputEl, text) => {
            if (warnEl) {
                warnEl.hidden = !text;
                warnEl.textContent = text || '';
            }
            if (inputEl) inputEl.classList.toggle('offer-input-warn', !!text);
        };

        const teeEntryVal = effective(teeEntry, 'tee_entry_default');
        const teeRetailVal = effective(teeRetailExample, 'tee_retail_default');
        if (teeEntryVal !== null && teeRetailVal !== null) {
            const raw = teeRetailVal - teeEntryVal;
            const profit = Math.max(0, raw);
            if (teeProfitDisplay) teeProfitDisplay.textContent = fmtNumber(profit);
            setWarn(teeProfitWarn, teeRetailExample, raw < 0 ? 'Роздріб менше за вхід — перевірте цифри.' : '');
        } else {
            if (teeProfitDisplay) teeProfitDisplay.textContent = '—';
            setWarn(teeProfitWarn, teeRetailExample, '');
        }

        const hoodieEntryVal = effective(hoodieEntry, 'hoodie_entry_default');
        const hoodieRetailVal = effective(hoodieRetailExample, 'hoodie_retail_default');
        if (hoodieEntryVal !== null && hoodieRetailVal !== null) {
            const raw = hoodieRetailVal - hoodieEntryVal;
            const profit = Math.max(0, raw);
            if (hoodieProfitDisplay) hoodieProfitDisplay.textContent = fmtNumber(profit);
            setWarn(hoodieProfitWarn, hoodieRetailExample, raw < 0 ? 'Роздріб менше за вхід — перевірте цифри.' : '');
        } else {
            if (hoodieProfitDisplay) hoodieProfitDisplay.textContent = '—';
            setWarn(hoodieProfitWarn, hoodieRetailExample, '');
        }
    }

    function syncPricingUI() {
        const isDrop = (pricingMode?.value || 'OPT').toUpperCase() === 'DROP';
        if (optTierWrap) optTierWrap.hidden = isDrop;
        if (optTier) optTier.disabled = isDrop;
    }

    function syncSubjectCustom() {
        const isCustom = subjectPreset && subjectPreset.value === 'CUSTOM';
        if (subjectCustomWrap) subjectCustomWrap.hidden = !isCustom;
        if (!isCustom && subjectCustom) subjectCustom.value = '';
    }

    function syncCtaCustomUrl() {
        const isCustom = ctaType && ctaType.value === 'CUSTOM_URL';
        if (ctaCustomUrlWrap) ctaCustomUrlWrap.hidden = !isCustom;
        if (!isCustom && ctaCustomUrl) ctaCustomUrl.value = '';
    }

    const messengerRows = [
        { row: document.querySelector('[data-messenger="phone"]'), toggle: phoneEnabled, input: phone },
        { row: document.querySelector('[data-messenger="viber"]'), toggle: viberEnabled, input: viber },
        { row: document.querySelector('[data-messenger="whatsapp"]'), toggle: whatsappEnabled, input: whatsapp },
        { row: document.querySelector('[data-messenger="telegram"]'), toggle: telegramEnabled, input: telegram },
    ].filter((x) => x.row && x.toggle && x.input);

    function syncMessengerUI() {
        const showMgr = !!showManager?.checked;

        if (managerName) {
            managerName.readOnly = !showMgr;
            managerName.classList.toggle('is-readonly', !showMgr);
        }

        messengerRows.forEach(({ row, toggle, input }) => {
            toggle.disabled = !showMgr;
            const enabled = showMgr && !!toggle.checked;
            row.classList.toggle('is-enabled', enabled);
            row.classList.toggle('is-disabled', !enabled);
            input.readOnly = !enabled;
            input.setAttribute('aria-disabled', String(!enabled));
        });
    }

    function setActivePreview(tab) {
        activePreviewTab = tab;
        previewTabButtons.forEach((btn) => {
            const isActive = btn.getAttribute('data-offer-preview-tab') === tab;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-selected', String(isActive));
        });
        if (previewVisual) previewVisual.style.display = tab === 'VISUAL' ? '' : 'none';
        if (previewLight) previewLight.style.display = tab === 'LIGHT' ? '' : 'none';
    }

    function setPreviewSize(size) {
        activePreviewSize = size;
        previewSizeButtons.forEach((btn) => {
            const isActive = btn.getAttribute('data-offer-preview-size') === size;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-selected', String(isActive));
        });
        if (!previewViewport) return;
        previewViewport.classList.toggle('is-mobile', size === 'MOBILE');
    }

    function setActiveLog(tab) {
        activeLogTab = tab;
        logTabButtons.forEach((btn) => {
            const isActive = btn.getAttribute('data-offer-log-tab') === tab;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-selected', String(isActive));
        });
        if (logPaneVisual) logPaneVisual.style.display = tab === 'VISUAL' ? '' : 'none';
        if (logPaneLight) logPaneLight.style.display = tab === 'LIGHT' ? '' : 'none';
    }

    let lastPreviewVisualHtml = (previewInitialVisual && previewInitialVisual.innerHTML) ? previewInitialVisual.innerHTML.trim() : '';

    function buildPreviewDoc(bodyHtml) {
        const showImages = !previewImagesToggle || !!previewImagesToggle.checked;
        const imagesCss = showImages ? '' : 'img{display:none !important;}';
        const safeBody = String(bodyHtml || '');
        return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">` +
            `<base target="_blank">` +
            `<style>html,body{margin:0;padding:0;background:#121212;}${imagesCss}</style>` +
            `</head><body>${safeBody}</body></html>`;
    }

    function renderVisualPreview(html) {
        lastPreviewVisualHtml = String(html || '');
        if (!previewVisual) return;
        previewVisual.srcdoc = buildPreviewDoc(lastPreviewVisualHtml);
    }

    function refreshVisualPreview() {
        renderVisualPreview(lastPreviewVisualHtml);
    }

    async function updatePreviewNow() {
        if (previewAbortController) previewAbortController.abort();
        previewAbortController = new AbortController();

        try {
            const formData = new FormData(form);
            const resp = await fetch('{% url "management_commercial_offer_email_preview_api" %}', {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
                signal: previewAbortController.signal,
            });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data || !data.ok) return;

            renderVisualPreview(data.html || '');
            if (previewLight) previewLight.textContent = data.text || '';
            if (previewSubject) previewSubject.textContent = data.subject || '';
            if (previewPreheader) previewPreheader.textContent = data.preheader || '';
        } catch (e) {
            if (e && e.name === 'AbortError') return;
        }
    }

    function schedulePreviewUpdate() {
        if (previewTimer) clearTimeout(previewTimer);
        previewTimer = setTimeout(updatePreviewNow, 320);
    }

    function setUnitNoteText(text) {
        if (!unitNote) return;
        unitNote.hidden = !text;
        unitNote.textContent = text || '';
    }

    async function loadUnitDefaults() {
        try {
            const params = new URLSearchParams();
            if (pricingMode && pricingMode.value) params.set('pricing_mode', pricingMode.value);
            if (optTier && optTier.value) params.set('opt_tier', optTier.value);
            const dropTeeVal = parseIntSafe(dropTeePrice?.value);
            const dropHoodieVal = parseIntSafe(dropHoodiePrice?.value);
            if (dropTeeVal !== null) params.set('drop_tee_price', String(dropTeeVal));
            if (dropHoodieVal !== null) params.set('drop_hoodie_price', String(dropHoodieVal));

            const url = `{% url "management_commercial_offer_email_unit_defaults_api" %}?${params.toString()}`;
            const resp = await fetch(url, {
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
            });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data || !data.ok || !data.defaults) return;
            unitDefaults = data.defaults;
            if (unitDefaults && unitDefaults.retail_source === 'fallback') {
                setUnitNoteText('Застосовані fallback-ціни для роздробу (не вдалося підтягнути з сайту).');
            } else {
                setUnitNoteText('');
            }
            syncUnitProfits();
        } catch (e) {
            // ignore
        }
    }

    async function fillUnitDefaults() {
        if (!unitDefaults) await loadUnitDefaults();
        if (!unitDefaults) return;
        if (teeEntry) teeEntry.value = unitDefaults.tee_entry_default ?? '';
        if (teeRetailExample) teeRetailExample.value = unitDefaults.tee_retail_default ?? '';
        if (hoodieEntry) hoodieEntry.value = unitDefaults.hoodie_entry_default ?? '';
        if (hoodieRetailExample) hoodieRetailExample.value = unitDefaults.hoodie_retail_default ?? '';
        syncUnitProfits();
        schedulePreviewUpdate();
    }

    function parseJsonGallery(value) {
        try {
            const data = JSON.parse(String(value || '[]'));
            if (!Array.isArray(data)) return [];
            return data.slice(0, 6).map((item) => {
                if (typeof item === 'string') {
                    const url = String(item || '').trim();
                    return url ? { url, caption: '' } : null;
                }
                if (item && typeof item === 'object') {
                    const url = String(item.url || item.link || item.href || '').trim();
                    const caption = String(item.caption || item.title || '').trim();
                    return url ? { url, caption } : null;
                }
                return null;
            }).filter(Boolean);
        } catch (e) {
            return [];
        }
    }

    function normalizeGallerySlots(slots) {
        const list = Array.isArray(slots) ? slots : [];
        return list.slice(0, 6).map((slot) => ({
            url: String(slot?.url || '').trim(),
            caption: String(slot?.caption || '').trim(),
        }));
    }

    function syncGalleryHidden() {
        if (galleryNeutral) galleryNeutral.value = JSON.stringify(normalizeGallerySlots(galleryState.NEUTRAL));
        if (galleryEdgy) galleryEdgy.value = JSON.stringify(normalizeGallerySlots(galleryState.EDGY));
    }

    function escapeAttr(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function getActiveSegment() {
        const seg = (segmentMode?.value || 'NEUTRAL').toUpperCase();
        return seg === 'EDGY' ? 'EDGY' : 'NEUTRAL';
    }

    function renderGallery() {
        if (!galleryList) return;
        const seg = getActiveSegment();
        const slotsData = galleryState[seg] || [];
        const slots = Math.max(0, Math.min(6, gallerySlots[seg] || 0));

        const html = Array.from({ length: slots }).map((_, idx) => {
            const slot = slotsData[idx] || { url: '', caption: '' };
            const url = String(slot.url || '').trim();
            const caption = String(slot.caption || '').trim();
            return `
                <div class="offer-gallery-slot" data-slot-index="${idx}">
                    <div class="offer-gallery-slot-main">
                        <input type="url" class="offer-gallery-url" value="${escapeAttr(url)}" placeholder="https://twocomms.shop/product/... або https://...jpg">
                        <button type="button" class="offer-gallery-clear" aria-label="Очистити" ${url ? '' : 'disabled'}>×</button>
                    </div>
                    <div class="offer-gallery-slot-sub">
                        <input type="text" class="offer-gallery-caption" value="${escapeAttr(caption)}" placeholder="Підпис (коротко)">
                    </div>
                    <div class="offer-gallery-preview" hidden>
                        <div class="offer-gallery-thumb"><img alt="" /></div>
                        <div class="offer-gallery-preview-meta">
                            <div class="offer-gallery-title"></div>
                            <a class="offer-gallery-open" href="#" target="_blank" rel="noopener">Відкрити</a>
                        </div>
                    </div>
                    <div class="offer-gallery-error" hidden></div>
                </div>
            `;
        }).join('');
        galleryList.innerHTML = html;

        galleryList.querySelectorAll('.offer-gallery-url').forEach((input) => {
            input.addEventListener('input', () => scheduleGallerySync());
            input.addEventListener('change', () => scheduleGallerySync());
        });
        galleryList.querySelectorAll('.offer-gallery-caption').forEach((input) => {
            input.addEventListener('input', () => scheduleGallerySync());
            input.addEventListener('change', () => scheduleGallerySync());
        });
        galleryList.querySelectorAll('.offer-gallery-clear').forEach((btn) => {
            btn.addEventListener('click', (e) => {
                const slot = e.target.closest('.offer-gallery-slot');
                if (!slot) return;
                const input = slot.querySelector('.offer-gallery-url');
                const caption = slot.querySelector('.offer-gallery-caption');
                if (!input) return;
                input.value = '';
                if (caption) caption.value = '';
                scheduleGallerySync();
            });
        });

        scheduleGallerySync();
    }

    function setGalleryNote(text) {
        if (!galleryNote) return;
        galleryNote.hidden = !text;
        galleryNote.textContent = text || '';
    }

    let gallerySyncTimer = null;
    function scheduleGallerySync() {
        if (gallerySyncTimer) clearTimeout(gallerySyncTimer);
        gallerySyncTimer = setTimeout(syncGalleryFromUI, 220);
    }

    function syncGalleryFromUI() {
        const seg = getActiveSegment();
        if (!galleryList) return;
        const slotEls = Array.from(galleryList.querySelectorAll('.offer-gallery-slot'));
        const slots = slotEls.slice(0, 6).map((slotEl) => {
            const url = String(slotEl.querySelector('.offer-gallery-url')?.value || '').trim();
            const caption = String(slotEl.querySelector('.offer-gallery-caption')?.value || '').trim();
            return { url, caption };
        });
        galleryState[seg] = slots;
        gallerySlots[seg] = Math.max(gallerySlots[seg] || 0, slots.length);
        syncGalleryHidden();
        resolveGallerySlots();
        schedulePreviewUpdate();
    }

    function updateSlotUI(slotEl, data, errorText) {
        if (!slotEl) return;
        const preview = slotEl.querySelector('.offer-gallery-preview');
        const img = slotEl.querySelector('.offer-gallery-thumb img');
        const titleEl = slotEl.querySelector('.offer-gallery-title');
        const openEl = slotEl.querySelector('.offer-gallery-open');
        const errEl = slotEl.querySelector('.offer-gallery-error');
        const clearBtn = slotEl.querySelector('.offer-gallery-clear');
        const captionInput = slotEl.querySelector('.offer-gallery-caption');

        const hasUrl = !!slotEl.querySelector('.offer-gallery-url')?.value?.trim();
        if (clearBtn) clearBtn.disabled = !hasUrl;

        if (errorText) {
            if (errEl) {
                errEl.hidden = false;
                errEl.textContent = errorText;
            }
            if (preview) preview.hidden = true;
            return;
        }

        if (!data) {
            if (errEl) {
                errEl.hidden = true;
                errEl.textContent = '';
            }
            if (preview) preview.hidden = true;
            return;
        }

        const caption = String(captionInput?.value || '').trim();
        const title = caption || data.title || '';
        if (img) img.src = data.img_url || '';
        if (img) img.alt = title;
        if (titleEl) titleEl.textContent = title;
        if (openEl) openEl.href = data.link_url || data.url || '#';
        if (errEl) {
            errEl.hidden = true;
            errEl.textContent = '';
        }
        if (preview) preview.hidden = false;
    }

    async function resolveProductUrl(url) {
        const clean = String(url || '').trim();
        if (!clean) return null;
        const resp = await fetch(`{% url "management_commercial_offer_email_resolve_product_api" %}?url=${encodeURIComponent(clean)}`, {
            headers: { 'Accept': 'application/json' },
            credentials: 'same-origin',
        });
        if (!resp.ok) return null;
        const data = await resp.json();
        if (!data || !data.ok || !data.item) return null;
        return data.item;
    }

    function resolveGallerySlots() {
        const seg = getActiveSegment();
        const slots = galleryState[seg] || [];
        const slotEls = Array.from(galleryList?.querySelectorAll('.offer-gallery-slot') || []);

        slotEls.forEach((slotEl) => {
            const idx = Number(slotEl.getAttribute('data-slot-index') || '0');
            const url = String(slots[idx]?.url || '').trim();

            const timerKey = `${seg}:${idx}`;
            if (galleryResolveTimers.has(timerKey)) {
                clearTimeout(galleryResolveTimers.get(timerKey));
                galleryResolveTimers.delete(timerKey);
            }

            if (!url) {
                updateSlotUI(slotEl, null, '');
                return;
            }

            const t = setTimeout(async () => {
                try {
                    updateSlotUI(slotEl, null, '');
                    const item = await resolveProductUrl(url);
                    if (!item) {
                        updateSlotUI(slotEl, null, 'Не вдалося обробити URL (перевірте товар або картинку).');
                        return;
                    }
                    updateSlotUI(slotEl, item, '');
                } catch (e) {
                    updateSlotUI(slotEl, null, 'Помилка при завантаженні товару.');
                }
            }, 320);
            galleryResolveTimers.set(timerKey, t);
        });
    }

    async function setGalleryDefaultsForSegment(seg) {
        try {
            const resp = await fetch(`{% url "management_commercial_offer_email_gallery_defaults_api" %}?segment=${encodeURIComponent(seg)}`, {
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
            });
            if (!resp.ok) return null;
            const data = await resp.json();
            if (!data || !data.ok || !Array.isArray(data.urls)) return null;
            return data;
        } catch (e) {
            return null;
        }
    }

    function setDupHint(data) {
        dupExists = !!data.exists;
        dupCount = Number.isFinite(data.count) ? data.count : 0;
        dupLast = data.lastSentAtDisplay || '';
        if (!dupExists) {
            dupHint.hidden = true;
            dupHint.textContent = '';
            return;
        }

        const lastPart = dupLast ? ` Остання відправка: ${dupLast}.` : '';
        dupHint.hidden = false;
        dupHint.textContent = `Цей email вже отримував КП (${dupCount}).${lastPart} Вона буде відправлена ще раз.`;
    }

    async function checkDuplicateEmail(value) {
        const email = (value || '').trim();
        confirmResend.value = '0';
        if (!email || !email.includes('@')) {
            setDupHint({ exists: false, count: 0, lastSentAtDisplay: '' });
            return;
        }

        if (abortController) abortController.abort();
        abortController = new AbortController();
        try {
            const url = `{% url 'management_commercial_offer_email_check_api' %}?email=${encodeURIComponent(email)}`;
            const resp = await fetch(url, { signal: abortController.signal, headers: { 'Accept': 'application/json' } });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data || !data.ok) return;
            setDupHint(data);
        } catch (e) {
            // ignore
        }
    }

    function scheduleDuplicateCheck() {
        if (checkTimer) clearTimeout(checkTimer);
        checkTimer = setTimeout(() => checkDuplicateEmail(recipientEmail.value), 350);
    }

    function openConfirmModal() {
        const email = (recipientEmail.value || '').trim();
        const lastPart = dupLast ? ` (останній раз: ${dupLast})` : '';
        confirmText.textContent = `На email ${email}${lastPart} вже відправляли комерційну пропозицію. Відправити ще раз?`;
        confirmModal.classList.add('show');
        confirmModal.setAttribute('aria-hidden', 'false');
    }

    function closeConfirmModal() {
        confirmModal.classList.remove('show');
        confirmModal.setAttribute('aria-hidden', 'true');
    }

    function setAlert(kind, text) {
        const el = document.createElement('div');
        el.className = `offer-alert offer-alert-${kind}`;
        el.textContent = text;
        alertStack.innerHTML = '';
        alertStack.appendChild(el);
        window.setTimeout(() => {
            if (el.parentNode === alertStack) {
                el.style.opacity = '0.0';
                el.style.transform = 'translateY(-4px)';
                el.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                window.setTimeout(() => { if (el.parentNode === alertStack) alertStack.innerHTML = ''; }, 240);
            }
        }, 5500);
    }

    async function copyToClipboard(text) {
        const value = String(text || '');
        if (!value) {
            setAlert('danger', 'Немає даних для копіювання.');
            return;
        }
        try {
            await navigator.clipboard.writeText(value);
            setAlert('success', 'Скопійовано в буфер обміну.');
        } catch (e) {
            try {
                const ta = document.createElement('textarea');
                ta.value = value;
                ta.setAttribute('readonly', '');
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                setAlert('success', 'Скопійовано в буфер обміну.');
            } catch (e2) {
                setAlert('danger', 'Не вдалося скопіювати.');
            }
        }
    }

    function setButtonState(state) {
        if (state === 'loading') {
            submitBtn.classList.add('is-loading');
            submitBtn.disabled = true;
            if (submitText) submitText.textContent = 'Відправляємо…';
            return;
        }
        if (state === 'success') {
            submitBtn.classList.remove('is-loading');
            submitBtn.classList.add('is-success');
            submitBtn.disabled = true;
            if (submitText) submitText.textContent = 'КП надіслано';
            return;
        }
        submitBtn.classList.remove('is-loading');
        submitBtn.classList.remove('is-success');
        submitBtn.disabled = false;
        if (submitText) submitText.textContent = 'Відправити комерційну пропозицію';
    }

    function clearRecipientFields() {
        recipientEmail.value = '';
        recipientName.value = '';
        confirmResend.value = '0';
        setDupHint({ exists: false, count: 0, lastSentAtDisplay: '' });
        schedulePreviewUpdate();
    }

    function prependHistoryRow(rowHtml) {
        const emptyRow = historyBody.querySelector('tr .table-empty')?.closest('tr');
        if (emptyRow) emptyRow.remove();

        const tmp = document.createElement('tbody');
        tmp.innerHTML = rowHtml.trim();
        const row = tmp.querySelector('tr');
        if (row) historyBody.prepend(row);
    }

    async function sendOffer() {
        const email = (recipientEmail.value || '').trim();
        if (!email) {
            setAlert('danger', 'Вкажіть email отримувача.');
            return;
        }

        setButtonState('loading');
        alertStack.innerHTML = '';

        const formData = new FormData(form);
        try {
            const resp = await fetch('{% url "management_commercial_offer_email_send_api" %}', {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
            });

            if (resp.status === 409) {
                const data = await resp.json();
                if (data && data.needs_confirmation) {
                    if (data.duplicate) {
                        setDupHint({
                            exists: true,
                            count: data.duplicate.count || 0,
                            lastSentAtDisplay: data.duplicate.lastSentAtDisplay || ''
                        });
                    }
                    setButtonState('idle');
                    openConfirmModal();
                    return;
                }
            }

            const data = await resp.json();
            if (!resp.ok || !data || !data.ok) {
                setButtonState('idle');
                if (data && data.errors) {
                    const firstKey = Object.keys(data.errors)[0];
                    const firstMsg = firstKey ? (data.errors[firstKey][0] || '') : '';
                    setAlert('danger', firstMsg || 'Перевірте дані форми.');
                } else {
                    setAlert('danger', (data && data.message) ? data.message : 'Не вдалося відправити лист.');
                }
                return;
            }

            if (data.row_html) {
                prependHistoryRow(data.row_html || '');
            }
            if (data.sent) {
                setAlert('success', data.message || 'КП успішно надіслано.');
                setButtonState('success');
                clearRecipientFields();
                window.setTimeout(() => setButtonState('idle'), 2400);
            } else {
                setButtonState('idle');
                setAlert('danger', data.message || 'Не вдалося відправити лист.');
            }
        } catch (e) {
            setButtonState('idle');
            setAlert('danger', 'Помилка мережі. Спробуйте ще раз.');
        }
    }

    async function fetchLog(url) {
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
        if (!resp.ok) return null;
        const data = await resp.json();
        if (!data || !data.ok || !data.log) return null;
        return data.log;
    }

    async function resendLog(url) {
        const csrf = form.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        const fd = new FormData();
        if (csrf) fd.append('csrfmiddlewaretoken', csrf);

        const resp = await fetch(url, {
            method: 'POST',
            body: fd,
            headers: { 'Accept': 'application/json' },
            credentials: 'same-origin',
        });
        let data = null;
        try {
            data = await resp.json();
        } catch (e) {
            data = null;
        }
        if (!resp.ok || !data || !data.ok) {
            return { ok: false, message: (data && data.message) ? data.message : 'Не вдалося відправити лист.', error: data && data.error ? data.error : '' };
        }
        return data;
    }

    function openLogModal(log) {
        if (!logModal) return;
        if (logTitle) logTitle.textContent = log.subject || 'Лист';
        if (logMeta) {
            const metaParts = [
                log.recipient_email || '',
                log.created_at_display || '',
                `${(log.mode || '').toUpperCase()}${log.segment_mode ? ' / ' + (log.segment_mode || '').toUpperCase() : ''}`,
            ].filter(Boolean);
            logMeta.textContent = metaParts.join(' • ');
        }
        if (logIframe) {
            const html = log.body_html || '<div style="font-family:Arial,Helvetica,sans-serif;padding:18px;">HTML відсутній.</div>';
            logIframe.srcdoc = html;
        }
        currentLogHtml = log.body_html || '';
        currentLogText = log.body_text || '';
        if (logPaneLight) logPaneLight.textContent = currentLogText || '';

        setActiveLog((log.mode || '').toUpperCase() === 'LIGHT' ? 'LIGHT' : 'VISUAL');

        logModal.classList.add('show');
        logModal.setAttribute('aria-hidden', 'false');
    }

    function closeLogModal() {
        if (!logModal) return;
        logModal.classList.remove('show');
        logModal.setAttribute('aria-hidden', 'true');
    }

	    function fillFormFromLog(log) {
        recipientEmail.value = log.recipient_email || '';
        recipientName.value = log.recipient_name || '';

        if (mode) mode.value = (log.mode || 'VISUAL').toUpperCase();
        if (segmentMode) segmentMode.value = (log.segment_mode || 'NEUTRAL').toUpperCase();
        if (subjectPreset) subjectPreset.value = (log.subject_preset || 'PRESET_1').toUpperCase();
        if (subjectCustom) subjectCustom.value = log.subject_custom || '';
        syncSubjectCustom();

	        if (ctaType) ctaType.value = (log.cta_type || '').toUpperCase();
	        if (ctaButtonText) ctaButtonText.value = log.cta_button_text || '';
	        if (ctaCustomUrl) ctaCustomUrl.value = log.cta_custom_url || '';
	        if (ctaMicrotext) ctaMicrotext.value = log.cta_microtext || '';
	        syncCtaCustomUrl();

	        if (pricingMode) pricingMode.value = (log.pricing_mode || 'OPT').toUpperCase();
	        if (optTier) optTier.value = (log.opt_tier || '8_15').toUpperCase();
	        if (dropTeePrice) dropTeePrice.value = log.drop_tee_price ?? '';
	        if (dropHoodiePrice) dropHoodiePrice.value = log.drop_hoodie_price ?? '';
	        if (dropshipLoyaltyBonus) dropshipLoyaltyBonus.checked = !!log.dropship_loyalty_bonus;
	        syncPricingUI();

	        if (teeEntry) teeEntry.value = log.tee_entry ?? '';
	        if (teeRetailExample) teeRetailExample.value = log.tee_retail_example ?? '';
	        if (hoodieEntry) hoodieEntry.value = log.hoodie_entry ?? '';
	        if (hoodieRetailExample) hoodieRetailExample.value = log.hoodie_retail_example ?? '';
	        loadUnitDefaults().finally(() => syncUnitProfits());

        if (showManager) showManager.checked = !!log.show_manager;
        if (managerName) managerName.value = log.manager_name || '';
        if (generalTg) generalTg.value = log.general_tg || '';
        if (phoneEnabled) phoneEnabled.checked = !!(log.phone_enabled ?? ((log.phone || '').trim()));
        if (phone) phone.value = log.phone || '';
        if (viberEnabled) viberEnabled.checked = !!(log.viber || '').trim();
        if (viber) viber.value = log.viber || '';
        if (whatsappEnabled) whatsappEnabled.checked = !!(log.whatsapp || '').trim();
        if (whatsapp) whatsapp.value = log.whatsapp || '';
        if (telegramEnabled) telegramEnabled.checked = !!(log.telegram || '').trim();
        if (telegram) telegram.value = log.telegram || '';

        if (includeCatalogLink) includeCatalogLink.checked = log.include_catalog_link ?? true;
        if (includeWholesaleLink) includeWholesaleLink.checked = log.include_wholesale_link ?? true;
        if (includeDropshipLink) includeDropshipLink.checked = log.include_dropship_link ?? true;
        if (includeInstagramLink) includeInstagramLink.checked = log.include_instagram_link ?? true;
        if (includeSiteLink) includeSiteLink.checked = log.include_site_link ?? true;

	        const seg = (log.segment_mode || 'NEUTRAL').toUpperCase() === 'EDGY' ? 'EDGY' : 'NEUTRAL';
	        const galleryItems = Array.isArray(log.gallery_urls) ? log.gallery_urls.slice(0, 6).map((item) => {
	            if (typeof item === 'string') {
	                const url = String(item || '').trim();
	                return url ? { url, caption: '' } : null;
	            }
	            if (item && typeof item === 'object') {
	                const url = String(item.url || item.link || item.href || '').trim();
	                const caption = String(item.caption || item.title || '').trim();
	                return url ? { url, caption } : null;
	            }
	            return null;
	        }).filter(Boolean) : [];
	        if (seg === 'EDGY') {
	            galleryState.EDGY = galleryItems;
	            gallerySlots.EDGY = Math.max(3, galleryItems.length || 0);
	        } else {
	            galleryState.NEUTRAL = galleryItems;
	            gallerySlots.NEUTRAL = Math.max(3, galleryItems.length || 0);
	        }
	        syncGalleryHidden();
	        renderGallery();

        confirmResend.value = '0';

        syncMessengerUI();
        scheduleDuplicateCheck();
        schedulePreviewUpdate();

        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function handleHistoryClick(e) {
        const actionBtn = e.target.closest('[data-offer-log-action]');
        if (!actionBtn) return;
        const action = actionBtn.getAttribute('data-offer-log-action');
        const url = actionBtn.getAttribute('data-url');
        if (!action || !url) return;

        actionBtn.disabled = true;
        if (action === 'resend') {
            resendLog(url).then((res) => {
                if (!res || !res.ok) {
                    setAlert('danger', (res && res.message) ? res.message : 'Не вдалося відправити лист.');
                    return;
                }
                if (res.row_html) prependHistoryRow(res.row_html || '');
                setAlert(res.sent ? 'success' : 'danger', res.message || (res.sent ? 'КП успішно надіслано.' : 'Не вдалося відправити лист.'));
            }).finally(() => {
                actionBtn.disabled = false;
            });
            return;
        }

        fetchLog(url).then((log) => {
            if (!log) return;
            if (action === 'view') openLogModal(log);
            if (action === 'duplicate') fillFormFromLog(log);
        }).finally(() => {
            actionBtn.disabled = false;
        });
    }

    function bindPreviewChange(el, eventName = 'input') {
        if (!el) return;
        el.addEventListener(eventName, () => schedulePreviewUpdate());
    }

	    [recipientName, managerName, generalTg, phone, viber, whatsapp, telegram, dropTeePrice, dropHoodiePrice, teeEntry, teeRetailExample, hoodieEntry, hoodieRetailExample, subjectCustom, ctaButtonText, ctaCustomUrl, ctaMicrotext].forEach((el) => bindPreviewChange(el, 'input'));
	    [mode, segmentMode, subjectPreset, ctaType, pricingMode, optTier].forEach((el) => bindPreviewChange(el, 'change'));
	    [showManager, phoneEnabled, viberEnabled, whatsappEnabled, telegramEnabled, dropshipLoyaltyBonus, includeCatalogLink, includeWholesaleLink, includeDropshipLink, includeInstagramLink, includeSiteLink].forEach((el) => bindPreviewChange(el, 'change'));

    [teeEntry, teeRetailExample, hoodieEntry, hoodieRetailExample].forEach((el) => {
        if (!el) return;
        el.addEventListener('input', syncUnitProfits);
    });

	    if (subjectPreset) subjectPreset.addEventListener('change', syncSubjectCustom);
	    if (ctaType) ctaType.addEventListener('change', syncCtaCustomUrl);
	    if (pricingMode) pricingMode.addEventListener('change', () => {
	        syncPricingUI();
	        loadUnitDefaults().finally(() => syncUnitProfits());
	    });
	    if (optTier) optTier.addEventListener('change', () => {
	        loadUnitDefaults().finally(() => syncUnitProfits());
	    });
	    [dropTeePrice, dropHoodiePrice].forEach((el) => {
	        if (!el) return;
	        el.addEventListener('input', () => loadUnitDefaults().finally(() => syncUnitProfits()));
	        el.addEventListener('change', () => loadUnitDefaults().finally(() => syncUnitProfits()));
	    });
	    if (showManager) showManager.addEventListener('change', syncMessengerUI);
	    messengerRows.forEach(({ toggle, input }) => {
	        toggle.addEventListener('change', syncMessengerUI);
	        input.addEventListener('input', syncMessengerUI);
	    });

	    previewTabButtons.forEach((btn) => {
	        btn.addEventListener('click', () => {
	            const tab = btn.getAttribute('data-offer-preview-tab');
	            if (!tab) return;
	            setActivePreview(tab);
	        });
	    });

	    if (previewImagesToggle) {
	        previewImagesToggle.addEventListener('change', () => {
	            refreshVisualPreview();
	        });
	    }

    previewSizeButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const size = btn.getAttribute('data-offer-preview-size');
            if (!size) return;
            setPreviewSize(size);
        });
    });

    if (mode) {
        mode.addEventListener('change', () => {
            const m = (mode.value || '').toUpperCase();
            if (m === 'LIGHT') setActivePreview('LIGHT');
            if (m === 'VISUAL') setActivePreview('VISUAL');
        });
    }

    if (segmentMode) {
        segmentMode.addEventListener('change', () => {
            renderGallery();
        });
    }

    logTabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const tab = btn.getAttribute('data-offer-log-tab');
            if (!tab) return;
            setActiveLog(tab);
        });
    });

    if (logClose) logClose.addEventListener('click', closeLogModal);
    if (logClose2) logClose2.addEventListener('click', closeLogModal);
    if (logCopyText) logCopyText.addEventListener('click', () => copyToClipboard(currentLogText));
    if (logCopyHtml) logCopyHtml.addEventListener('click', () => copyToClipboard(currentLogHtml || logIframe?.srcdoc || ''));
    if (logModal) logModal.addEventListener('click', (e) => { if (e.target === logModal) closeLogModal(); });

    recipientEmail.addEventListener('input', scheduleDuplicateCheck);
    recipientEmail.addEventListener('change', scheduleDuplicateCheck);

    confirmCancel.addEventListener('click', closeConfirmModal);
    confirmClose.addEventListener('click', closeConfirmModal);
    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) closeConfirmModal();
    });
    confirmOk.addEventListener('click', () => {
        confirmResend.value = '1';
        closeConfirmModal();
        sendOffer();
    });

    if (unitFillDefaultsBtn) unitFillDefaultsBtn.addEventListener('click', fillUnitDefaults);

    if (galleryBtnAdd) galleryBtnAdd.addEventListener('click', () => {
        const seg = getActiveSegment();
        gallerySlots[seg] = Math.min(6, (gallerySlots[seg] || 0) + 1);
        renderGallery();
    });
    if (galleryBtnRemove) galleryBtnRemove.addEventListener('click', () => {
        const seg = getActiveSegment();
        gallerySlots[seg] = Math.max(0, (gallerySlots[seg] || 0) - 1);
        renderGallery();
    });
	    if (galleryBtnDefault) galleryBtnDefault.addEventListener('click', async () => {
	        const seg = getActiveSegment();
	        const res = await setGalleryDefaultsForSegment(seg);
	        if (!res) {
	            setGalleryNote('Не вдалося підтягнути дефолтний набір.');
	            return;
	        }
	        const raw = Array.isArray(res.urls) ? res.urls : [];
	        const slots = raw.slice(0, 6).map((item) => {
	            if (typeof item === 'string') {
	                const url = String(item || '').trim();
	                return url ? { url, caption: '' } : null;
	            }
	            if (item && typeof item === 'object') {
	                const url = String(item.url || item.link || item.href || '').trim();
	                const caption = String(item.caption || item.title || '').trim();
	                return url ? { url, caption } : null;
	            }
	            return null;
	        }).filter(Boolean);
	        galleryState[seg] = slots;
	        gallerySlots[seg] = Math.max(3, slots.length);
	        syncGalleryHidden();
	        renderGallery();
	        if (res.source === 'fallback') {
	            setGalleryNote('Використано fallback-набір (без даних сайту).');
	        } else {
            setGalleryNote('Поставили дефолтний набір для сегмента.');
        }
        schedulePreviewUpdate();
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (dupExists && confirmResend.value !== '1') {
            openConfirmModal();
            return;
        }
        sendOffer();
    });

    if (historyBody) historyBody.addEventListener('click', handleHistoryClick);

	    setActivePreview((mode && (mode.value || '').toUpperCase() === 'LIGHT') ? 'LIGHT' : 'VISUAL');
	    setPreviewSize('DESKTOP');
	    syncSubjectCustom();
	    syncCtaCustomUrl();
	    syncMessengerUI();
	    syncPricingUI();
	    galleryState.NEUTRAL = parseJsonGallery(galleryNeutral?.value);
	    galleryState.EDGY = parseJsonGallery(galleryEdgy?.value);
	    gallerySlots.NEUTRAL = Math.max(3, galleryState.NEUTRAL.length || 0);
	    gallerySlots.EDGY = Math.max(3, galleryState.EDGY.length || 0);
	    renderGallery();
	    renderVisualPreview(lastPreviewVisualHtml);
	    loadUnitDefaults().finally(() => syncUnitProfits());
	    schedulePreviewUpdate();
	    scheduleDuplicateCheck();
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initManagementCommercialOfferEmailPage);
} else {
    initManagementCommercialOfferEmailPage();
}
</script>
{% endblock %}
