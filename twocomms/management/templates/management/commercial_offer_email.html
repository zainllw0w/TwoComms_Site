{% extends "management/base.html" %}

{% block title %}–ö–æ–º–µ—Ä—Ü—ñ–π–Ω—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó{% endblock %}

{% block content %}
<div class="clients-panel offer-panel">
    <div class="panel-header">
        <div>
            <p class="eyebrow">–ö–æ–º–µ—Ä—Ü—ñ–π–Ω—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</p>
            <h2>–ö–æ–º–µ—Ä—Ü—ñ–π–Ω—ñ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</h2>
        </div>
        <div class="panel-actions">
            <a class="btn-ghost" href="{% url 'management_home' %}">‚Üê –î–æ –ø–∞–Ω–µ–ª—ñ</a>
        </div>
    </div>

    <div class="cp-top-tabs" role="tablist" aria-label="–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –ö–ü">
        <a href="?tab=email" class="cp-top-tab{% if cp_tab == 'email' %} active{% endif %}" role="tab" aria-selected="{% if cp_tab == 'email' %}true{% else %}false{% endif %}">–ö–ü –Ω–∞ e-mail</a>
        <a href="?tab=messengers" class="cp-top-tab{% if cp_tab == 'messengers' %} active{% endif %}" role="tab" aria-selected="{% if cp_tab == 'messengers' %}true{% else %}false{% endif %}">–ö–ü —É –º–µ—Å–µ–Ω–¥–∂–µ—Ä–∏</a>
    </div>

    <div class="cp-pane cp-pane-messengers" {% if cp_tab != 'messengers' %}style="display:none"{% endif %}>
        <div class="offer-grid offer-grid-single">
            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–ö–ü —É –º–µ—Å–µ–Ω–¥–∂–µ—Ä–∏</p>
                        <h3 class="offer-card-title">–¢—ñ–ª—å–∫–∏ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è ‚Äî –±–µ–∑ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —ñ–∑ —Å–∏—Å—Ç–µ–º–∏</h3>
                        <div class="offer-help">–û–±–µ—Ä—ñ—Ç—å –≤–∞—Ä—ñ–∞–Ω—Ç, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏¬ª —ñ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –≤—Ä—É—á–Ω—É –≤ –º–µ—Å–µ–Ω–¥–∂–µ—Ä.</div>
                    </div>
                </div>

                <div class="cp-messenger-toolbar">
                    <div class="cp-subtabs" role="tablist" aria-label="–ö–∞–Ω–∞–ª">
                        <button type="button" class="cp-subtab active" data-channel="telegram">Telegram</button>
                        <button type="button" class="cp-subtab" data-channel="generic">–Ü–Ω—à—ñ –º–µ—Å–µ–Ω–¥–∂–µ—Ä–∏</button>
                    </div>
                    <div class="cp-template-pills" id="cp-template-pills" aria-label="–®–∞–±–ª–æ–Ω">
                        {% for tpl in messenger_templates %}
                            <button type="button" class="cp-pill{% if forloop.first %} active{% endif %}" data-template="{{ tpl.key }}">{{ tpl.title }}</button>
                        {% endfor %}
                    </div>
                </div>

                <div class="cp-preview-shell">
                    <pre class="cp-preview" id="cp-preview" aria-label="–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥"></pre>
                </div>

                <div class="cp-messenger-actions">
                    <button type="button" class="btn-primary" id="cp-copy-btn">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                    <div class="cp-copy-status" id="cp-copy-status" role="status" aria-live="polite"></div>
                </div>

                {{ messenger_templates|json_script:"cp-messenger-templates" }}
                <script>
                (function() {
                    const dataEl = document.getElementById('cp-messenger-templates');
                    if (!dataEl) return;
                    let templates = [];
                    try { templates = JSON.parse(dataEl.textContent || '[]'); } catch (e) { templates = []; }
                    if (!Array.isArray(templates) || !templates.length) return;

                    const preview = document.getElementById('cp-preview');
                    const copyBtn = document.getElementById('cp-copy-btn');
                    const statusEl = document.getElementById('cp-copy-status');
                    const pillsWrap = document.getElementById('cp-template-pills');
                    const subTabs = Array.from(document.querySelectorAll('.cp-subtab'));

                    let activeChannel = 'telegram';
                    let activeKey = (templates[0] || {}).key;

                    const getActiveTpl = () => templates.find(t => t.key === activeKey) || templates[0];
                    const buildText = () => {
                        const tpl = getActiveTpl();
                        if (!tpl) return '';
                        return String(tpl[activeChannel] || tpl.telegram || tpl.generic || '').trim();
                    };
                    const render = () => {
                        const txt = buildText();
                        if (preview) preview.textContent = txt;
                    };

                    const setStatus = (msg, kind) => {
                        if (!statusEl) return;
                        statusEl.textContent = msg || '';
                        statusEl.dataset.kind = kind || '';
                        if (msg) {
                            clearTimeout(setStatus._t);
                            setStatus._t = setTimeout(() => { statusEl.textContent = ''; statusEl.dataset.kind = ''; }, 1800);
                        }
                    };

                    const copyText = async (txt) => {
                        try {
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                await navigator.clipboard.writeText(txt);
                                return true;
                            }
                        } catch (e) {}
                        try {
                            const ta = document.createElement('textarea');
                            ta.value = txt;
                            ta.setAttribute('readonly', '');
                            ta.style.position = 'fixed';
                            ta.style.left = '-9999px';
                            document.body.appendChild(ta);
                            ta.select();
                            const ok = document.execCommand('copy');
                            document.body.removeChild(ta);
                            return ok;
                        } catch (e) {
                            return false;
                        }
                    };

                    if (pillsWrap) {
                        pillsWrap.addEventListener('click', (e) => {
                            const btn = e.target.closest('button[data-template]');
                            if (!btn) return;
                            activeKey = btn.dataset.template;
                            pillsWrap.querySelectorAll('button[data-template]').forEach(b => b.classList.toggle('active', b === btn));
                            render();
                        });
                    }

                    subTabs.forEach(btn => {
                        btn.addEventListener('click', () => {
                            activeChannel = btn.dataset.channel || 'telegram';
                            subTabs.forEach(b => b.classList.toggle('active', b === btn));
                            render();
                        });
                    });

                    if (copyBtn) {
                        copyBtn.addEventListener('click', async () => {
                            const txt = buildText();
                            if (!txt) return;
                            const ok = await copyText(txt);
                            setStatus(ok ? '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ' : '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏', ok ? 'ok' : 'err');
                        });
                    }

                    render();
                })();
                </script>
            </div>
        </div>
    </div>

    <div class="cp-pane cp-pane-email" {% if cp_tab != 'email' %}style="display:none"{% endif %}>
    <div id="offer-alert-stack"></div>

    {% if sent_success %}
        <div class="offer-alert offer-alert-success">–ö–ü —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ.</div>
    {% endif %}

    {% if send_error %}
        <div class="offer-alert offer-alert-danger">{{ send_error }}</div>
    {% endif %}

    {% if form.non_field_errors %}
        <div class="offer-alert offer-alert-danger">{{ form.non_field_errors.0 }}</div>
    {% endif %}

    <div class="offer-grid">
        <form method="post" class="offer-form" id="offer-form" action="{% url 'management_commercial_offer_email' %}">
            {% csrf_token %}
            <input type="hidden" name="confirm_resend" id="confirm_resend" value="0">
            <input type="hidden" name="gallery_neutral" id="gallery_neutral" value="{{ gallery_neutral_json|default:'[]' }}">
            <input type="hidden" name="gallery_edgy" id="gallery_edgy" value="{{ gallery_edgy_json|default:'[]' }}">

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–û—Ç—Ä–∏–º—É–≤–∞—á</p>
                        <h3 class="offer-card-title">–ö—É–¥–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ</h3>
                    </div>
                </div>
                <div class="field-grid offer-fields">
                    <div class="field field-span-2">
                        <label for="recipient_email">Email</label>
                        <input type="email"
                               id="recipient_email"
                               name="recipient_email"
                               value="{{ form.recipient_email.value|default_if_none:'' }}"
                               placeholder="brand@example.com"
                               autocomplete="email"
                               required>
                        <div class="offer-dup-hint" id="offer-email-dup-hint" hidden></div>
                        {% if form.recipient_email.errors %}
                            <div class="offer-error">{{ form.recipient_email.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="field field-span-2">
                        <label for="recipient_name">–Ü–º º—è –∞–±–æ –∫–æ–º–ø–∞–Ω—ñ—è (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                        <input type="text"
                               id="recipient_name"
                               name="recipient_name"
                               value="{{ form.recipient_name.value|default_if_none:'' }}"
                               placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: Brand / –û–ª–µ–∫—Å–∞–Ω–¥—Ä"
                               autocomplete="organization">
                        {% if form.recipient_name.errors %}
                            <div class="offer-error">{{ form.recipient_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–®–∞–±–ª–æ–Ω</p>
                        <h3 class="offer-card-title">–†–µ–∂–∏–º, –∫–æ–Ω—Ç–µ–Ω—Ç —ñ —Ç–µ–º–∞</h3>
                    </div>
                </div>

                <div class="field-grid offer-fields">
                    <div class="field">
                        <label for="mode">–†–µ–∂–∏–º</label>
                        <select id="mode" name="mode">
                            {% with mode_val=form.mode.value|default:"VISUAL" %}
                                <option value="LIGHT" {% if mode_val == "LIGHT" %}selected{% endif %}>LIGHT ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –¥–æ—Å—Ç–∞–≤–ª—é–≤–∞–Ω—ñ—Å—Ç—å</option>
                                <option value="VISUAL" {% if mode_val == "VISUAL" %}selected{% endif %}>VISUAL ‚Äî –∫—Ä–∞—Å–∏–≤–∏–π HTML (Safe Dark)</option>
                            {% endwith %}
                        </select>
                        <div class="offer-field-hint">Light ‚Äî –º–∞–π–∂–µ plain-text. Visual ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π –±—Ä–µ–Ω–¥–æ–≤–∞–Ω–∏–π –ª–∏—Å—Ç.</div>
                        {% if form.mode.errors %}
                            <div class="offer-error">{{ form.mode.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field">
                        <label for="segment_mode">–°–µ–≥–º–µ–Ω—Ç</label>
                        <select id="segment_mode" name="segment_mode">
                            {% with seg_val=form.segment_mode.value|default:"NEUTRAL" %}
                                <option value="NEUTRAL" {% if seg_val == "NEUTRAL" %}selected{% endif %}>NEUTRAL ‚Äî —Å–ø–æ–∫—ñ–π–Ω—ñ —Ö—ñ—Ç–∏</option>
                                <option value="EDGY" {% if seg_val == "EDGY" %}selected{% endif %}>EDGY ‚Äî –¥–µ—Ä–∑–∫—ñ —Ö—ñ—Ç–∏</option>
                            {% endwith %}
                        </select>
                        <div class="offer-field-hint">–í–ø–ª–∏–≤–∞—î –Ω–∞ –ø—ñ–¥–±—ñ—Ä–∫—É —Ç–æ–≤–∞—Ä—ñ–≤ —É –ª–∏—Å—Ç—ñ.</div>
                        {% if form.segment_mode.errors %}
                            <div class="offer-error">{{ form.segment_mode.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2">
                        <label for="subject_preset">–¢–µ–º–∞ –ª–∏—Å—Ç–∞</label>
                        <select id="subject_preset" name="subject_preset">
                            {% with subject_val=form.subject_preset.value|default:"PRESET_1" %}
                                <option value="PRESET_1" {% if subject_val == "PRESET_1" %}selected{% endif %}>TwoComms: –¢–µ—Å—Ç-—Ä–æ—Å—Ç–æ–≤–∫–∞ 14 –¥–Ω—ñ–≤‚Ä¶</option>
                                <option value="PRESET_2" {% if subject_val == "PRESET_2" %}selected{% endif %}>–û–ø—Ç –≤—ñ–¥ 8 —à—Ç / –î—Ä–æ–ø—à–∏–ø‚Ä¶</option>
                                <option value="PRESET_3" {% if subject_val == "PRESET_3" %}selected{% endif %}>üì¶ –¢–µ—Å—Ç-–¥—Ä–∞–π–≤ 14 –¥–Ω—ñ–≤‚Ä¶</option>
                                <option value="CUSTOM" {% if subject_val == "CUSTOM" %}selected{% endif %}>Custom</option>
                            {% endwith %}
                        </select>
                        {% if form.subject_preset.errors %}
                            <div class="offer-error">{{ form.subject_preset.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2" id="subject_custom_wrap" {% if form.subject_preset.value != "CUSTOM" %}hidden{% endif %}>
                        <label for="subject_custom">Custom —Ç–µ–º–∞</label>
                        <input type="text"
                               id="subject_custom"
                               name="subject_custom"
                               value="{{ form.subject_custom.value|default_if_none:'' }}"
                               placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤–æ—é —Ç–µ–º—É –ª–∏—Å—Ç–∞">
                        {% if form.subject_custom.errors %}
                            <div class="offer-error">{{ form.subject_custom.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="offer-unit">
                    <div class="offer-unit-head">
                        <div class="offer-unit-head-row">
                            <div>
                                <div class="offer-unit-title">–ü—Ä–∏–∫–ª–∞–¥ —é–Ω—ñ—Ç-–µ–∫–æ–Ω–æ–º—ñ–∫–∏</div>
                                <div class="offer-unit-sub">–¶–µ –ø—Ä–∏–∫–ª–∞–¥ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É. –†–æ–∑–¥—Ä—ñ–±–Ω—É —Ü—ñ–Ω—É –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç–µ –≤–∏.</div>
                            </div>
                            <button type="button" class="btn-ghost small" id="offer-unit-fill-defaults">–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –¥–µ—Ñ–æ–ª—Ç–∞–º–∏</button>
                        </div>
                        <div class="offer-unit-note" id="offer-unit-note" hidden></div>
                    </div>

                    <div class="offer-unit-controls">
                        <div class="field">
                            <label for="pricing_mode">–ü—Ä–∏–∫–ª–∞–¥: –±–∞–∑–∞ ‚Äú–≤—Ö—ñ–¥‚Äù</label>
                            <select id="pricing_mode" name="pricing_mode">
                                {% with pval=form.pricing_mode.value|default:"OPT" %}
                                    <option value="OPT" {% if pval == "OPT" %}selected{% endif %}>OPT ‚Äî –æ–ø—Ç (tier)</option>
                                    <option value="DROP" {% if pval == "DROP" %}selected{% endif %}>DROP ‚Äî –¥—Ä–æ–ø (—Ñ—ñ–∫—Å)</option>
                                {% endwith %}
                            </select>
                        </div>
                        <div class="field" id="opt_tier_wrap">
                            <label for="opt_tier">–û–ø—Ç: –æ–±—Å—è–≥ (tier)</label>
                            <select id="opt_tier" name="opt_tier">
                                {% with tval=form.opt_tier.value|default:"8_15" %}
                                    <option value="8_15" {% if tval == "8_15" %}selected{% endif %}>8‚Äì15 (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–µ)</option>
                                    <option value="16_31" {% if tval == "16_31" %}selected{% endif %}>16‚Äì31</option>
                                    <option value="32_63" {% if tval == "32_63" %}selected{% endif %}>32‚Äì63</option>
                                    <option value="64_99" {% if tval == "64_99" %}selected{% endif %}>64‚Äì99</option>
                                    <option value="100_PLUS" {% if tval == "100_PLUS" %}selected{% endif %}>100+ (–º–∞–∫—Å –≤–∏–≥–æ–¥–∞)</option>
                                {% endwith %}
                            </select>
                            <div class="offer-field-hint">–í–ø–ª–∏–≤–∞—î –Ω–∞ –≤—Ö—ñ–¥–Ω—ñ —Ü—ñ–Ω–∏ –≤ –ª–∏—Å—Ç—ñ (–æ–ø—Ç).</div>
                        </div>
                    </div>

                    <details class="offer-unit-advanced" id="offer-drop-advanced">
                        <summary>–î—Ä–æ–ø —Ü—ñ–Ω–∏ (advanced)</summary>
                        <div class="field-grid offer-unit-advanced-grid">
                            <div class="field">
                                <label for="drop_tee_price">–§—É—Ç–±–æ–ª–∫–∞ ‚Äî –¥—Ä–æ–ø (–≥—Ä–Ω)</label>
                                <input type="number"
                                       id="drop_tee_price"
                                       name="drop_tee_price"
                                       value="{{ form.drop_tee_price.value|default_if_none:'' }}"
                                       placeholder="–ù–∞–ø—Ä. 570"
                                       inputmode="numeric">
                                {% if form.drop_tee_price.errors %}
                                    <div class="offer-error">{{ form.drop_tee_price.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="field">
                                <label for="drop_hoodie_price">–•—É–¥—ñ ‚Äî –¥—Ä–æ–ø (–≥—Ä–Ω)</label>
                                <input type="number"
                                       id="drop_hoodie_price"
                                       name="drop_hoodie_price"
                                       value="{{ form.drop_hoodie_price.value|default_if_none:'' }}"
                                       placeholder="–ù–∞–ø—Ä. 1350"
                                       inputmode="numeric">
                                {% if form.drop_hoodie_price.errors %}
                                    <div class="offer-error">{{ form.drop_hoodie_price.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </details>

                    <label class="offer-check offer-check-link offer-unit-loyalty">
                        <input type="checkbox" id="dropship_loyalty_bonus" name="dropship_loyalty_bonus" {% if form.dropship_loyalty_bonus.value %}checked{% endif %}>
                        <span>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –±–æ–Ω—É—Å –¥—Ä–æ–ø-–ª–æ—è–ª—å–Ω–æ—Å—Ç—ñ (-10 –≥—Ä–Ω –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è)</span>
                    </label>

                    <div class="field-grid offer-unit-grid">
                        <div class="field">
                            <label for="tee_entry">–§—É—Ç–±–æ–ª–∫–∞ ‚Äî –≤—Ö—ñ–¥ (–≥—Ä–Ω)</label>
                            <input type="number"
                                   id="tee_entry"
                                   name="tee_entry"
                                   value="{{ form.tee_entry.value|default_if_none:'' }}"
                                   placeholder="–ù–∞–ø—Ä. 540"
                                   inputmode="numeric">
                            {% if form.tee_entry.errors %}
                                <div class="offer-error">{{ form.tee_entry.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field">
                            <label for="tee_retail_example">–§—É—Ç–±–æ–ª–∫–∞ ‚Äî —Ä–æ–∑–¥—Ä—ñ–± (–ø—Ä–∏–∫–ª–∞–¥, –≥—Ä–Ω)</label>
                            <input type="number"
                                   id="tee_retail_example"
                                   name="tee_retail_example"
                                   value="{{ form.tee_retail_example.value|default_if_none:'' }}"
                                   placeholder="–ù–∞–ø—Ä. 750"
                                   inputmode="numeric">
                            <div class="offer-profit-line">–†—ñ–∑–Ω–∏—Ü—è*: <span class="offer-profit" id="tee_profit_display">‚Äî</span> –≥—Ä–Ω</div>
                            <div class="offer-field-warn" id="tee_profit_warn" hidden></div>
                            {% if form.tee_retail_example.errors %}
                                <div class="offer-error">{{ form.tee_retail_example.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field">
                            <label for="hoodie_entry">–•—É–¥—ñ ‚Äî –≤—Ö—ñ–¥ (–≥—Ä–Ω)</label>
                            <input type="number"
                                   id="hoodie_entry"
                                   name="hoodie_entry"
                                   value="{{ form.hoodie_entry.value|default_if_none:'' }}"
                                   placeholder="–ù–∞–ø—Ä. 1300"
                                   inputmode="numeric">
                            {% if form.hoodie_entry.errors %}
                                <div class="offer-error">{{ form.hoodie_entry.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field">
                            <label for="hoodie_retail_example">–•—É–¥—ñ ‚Äî —Ä–æ–∑–¥—Ä—ñ–± (–ø—Ä–∏–∫–ª–∞–¥, –≥—Ä–Ω)</label>
                            <input type="number"
                                   id="hoodie_retail_example"
                                   name="hoodie_retail_example"
                                   value="{{ form.hoodie_retail_example.value|default_if_none:'' }}"
                                   placeholder="–ù–∞–ø—Ä. 1790"
                                   inputmode="numeric">
                            <div class="offer-profit-line">–†—ñ–∑–Ω–∏—Ü—è*: <span class="offer-profit" id="hoodie_profit_display">‚Äî</span> –≥—Ä–Ω</div>
                            <div class="offer-field-warn" id="hoodie_profit_warn" hidden></div>
                            {% if form.hoodie_retail_example.errors %}
                                <div class="offer-error">{{ form.hoodie_retail_example.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–û—Ñ—Ñ–µ—Ä</p>
                        <h3 class="offer-card-title">CTA —ñ –º—ñ–∫—Ä–æ—Ç–µ–∫—Å—Ç</h3>
                    </div>
                </div>

                <div class="field-grid offer-fields">
                    <div class="field">
                        <label for="cta_type">–ö—É–¥–∏ –≤–µ–¥–µ –∫–Ω–æ–ø–∫–∞</label>
                        <select id="cta_type" name="cta_type">
                            {% with cta_val=form.cta_type.value|default:"" %}
                                <option value="" {% if cta_val == "" %}selected{% endif %}>–ê–≤—Ç–æ (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)</option>
                                <option value="TELEGRAM_MANAGER" {% if cta_val == "TELEGRAM_MANAGER" %}selected{% endif %}>Telegram –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>
                                <option value="WHATSAPP_MANAGER" {% if cta_val == "WHATSAPP_MANAGER" %}selected{% endif %}>WhatsApp –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>
                                <option value="TELEGRAM_GENERAL" {% if cta_val == "TELEGRAM_GENERAL" %}selected{% endif %}>Telegram –∑–∞–≥–∞–ª—å–Ω–∏–π</option>
                                <option value="MAILTO_COOPERATION" {% if cta_val == "MAILTO_COOPERATION" %}selected{% endif %}>Email cooperation@</option>
                                <option value="REPLY_HINT_ONLY" {% if cta_val == "REPLY_HINT_ONLY" %}selected{% endif %}>–í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –ª–∏—Å—Ç (–±–µ–∑ –ª—ñ–Ω–∫–∞)</option>
                                <option value="CUSTOM_URL" {% if cta_val == "CUSTOM_URL" %}selected{% endif %}>–°–≤—ñ–π URL</option>
                            {% endwith %}
                        </select>
                        <div class="offer-field-hint">–ê–≤—Ç–æ: Telegram –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Üí WhatsApp –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ‚Üí email.</div>
                        {% if form.cta_type.errors %}
                            <div class="offer-error">{{ form.cta_type.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field">
                        <label for="cta_button_text">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏</label>
                        <input type="text"
                               id="cta_button_text"
                               name="cta_button_text"
                               value="{{ form.cta_button_text.value|default_if_none:'' }}"
                               placeholder="–ó–∞–ø—Ä–æ—Å–∏—Ç–∏ —Ç–µ—Å—Ç-—Ä–æ—Å—Ç–æ–≤–∫—É">
                        {% if form.cta_button_text.errors %}
                            <div class="offer-error">{{ form.cta_button_text.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2" id="cta_custom_url_wrap" {% if form.cta_type.value != "CUSTOM_URL" %}hidden{% endif %}>
                        <label for="cta_custom_url">Custom URL</label>
                        <input type="url"
                               id="cta_custom_url"
                               name="cta_custom_url"
                               value="{{ form.cta_custom_url.value|default_if_none:'' }}"
                               placeholder="https://...">
                        {% if form.cta_custom_url.errors %}
                            <div class="offer-error">{{ form.cta_custom_url.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="field field-span-2">
                        <label for="cta_microtext">–ú—ñ–∫—Ä–æ—Ç–µ–∫—Å—Ç –ø—ñ–¥ CTA</label>
                        <input type="text"
                               id="cta_microtext"
                               name="cta_microtext"
                               value="{{ form.cta_microtext.value|default_if_none:'' }}"
                               placeholder="–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–º–æ–≤–∏ –ø—ñ–¥ –≤–∞—à –æ–±—Å—è–≥.">
                        {% if form.cta_microtext.errors %}
                            <div class="offer-error">{{ form.cta_microtext.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</p>
                        <h3 class="offer-card-title">–©–æ –¥–æ–¥–∞—Ç–∏ –≤ –ª–∏—Å—Ç</h3>
                    </div>
                </div>

                <div class="offer-links-grid">
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_catalog_link" name="include_catalog_link" {% if form.include_catalog_link.value %}checked{% endif %}>
                        <span>–ö–∞—Ç–∞–ª–æ–≥</span>
                    </label>
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_wholesale_link" name="include_wholesale_link" {% if form.include_wholesale_link.value %}checked{% endif %}>
                        <span>–û–ø—Ç</span>
                    </label>
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_dropship_link" name="include_dropship_link" {% if form.include_dropship_link.value %}checked{% endif %}>
                        <span>–î—Ä–æ–ø</span>
                    </label>
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_instagram_link" name="include_instagram_link" {% if form.include_instagram_link.value %}checked{% endif %}>
                        <span>Instagram</span>
                    </label>
                    <label class="offer-check offer-check-link">
                        <input type="checkbox" id="include_site_link" name="include_site_link" {% if form.include_site_link.value %}checked{% endif %}>
                        <span>–°–∞–π—Ç</span>
                    </label>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–¢–æ–≤–∞—Ä–∏</p>
                        <h3 class="offer-card-title">–¢–æ–≤–∞—Ä–∏ –≤ –ª–∏—Å—Ç—ñ (–≥–∞–ª–µ—Ä–µ—è)</h3>
                    </div>
                    <div class="offer-card-actions">
                        <button type="button" class="btn-ghost small" id="offer-gallery-default">–î–µ—Ñ–æ–ª—Ç –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞</button>
                        <button type="button" class="btn-ghost small" id="offer-gallery-add">+ –°–ª–æ—Ç</button>
                        <button type="button" class="btn-ghost small" id="offer-gallery-remove">‚àí –°–ª–æ—Ç</button>
                    </div>
                </div>

                <div class="offer-field-hint">
                    –í—Å—Ç–∞–≤—Ç–µ URL —Ç–æ–≤–∞—Ä—É (<span class="offer-mono">/product/...</span>) –∞–±–æ URL –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ü–æ—Ä–æ–∂–Ω—ñ —Å–ª–æ—Ç–∏ –≤ –ª–∏—Å—Ç –Ω–µ –ø–æ—Ç—Ä–∞–ø–ª—è—Ç—å.
                </div>

                <div class="offer-gallery" id="offer-gallery">
                    <div class="offer-gallery-list" id="offer-gallery-list"></div>
                    <div class="offer-gallery-note" id="offer-gallery-note" hidden></div>
                </div>
            </div>

            <div class="offer-card">
                <div class="offer-card-head">
                    <div>
                        <p class="eyebrow">–í—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫</p>
                        <h3 class="offer-card-title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
                    </div>
                </div>

                <div class="offer-toggle-row">
                    <label class="offer-switch" aria-label="–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞">
                        <input type="checkbox" id="show_manager" name="show_manager" {% if form.show_manager.value %}checked{% endif %}>
                        <span class="offer-switch-track"></span>
                    </label>
                    <div class="offer-toggle-meta">
                        <div class="offer-toggle-title">–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —É –ª–∏—Å—Ç—ñ</div>
                        <div class="offer-toggle-sub">–Ø–∫—â–æ –≤–∏–º–∫–Ω—É—Ç–∏ ‚Äî –ª–∏—Å—Ç –±—É–¥–µ –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤.</div>
                    </div>
                </div>

                <div class="field-grid offer-fields">
                    <div class="field">
                        <label for="manager_name">–Ü–º º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞</label>
                        <input type="text"
                               id="manager_name"
                               name="manager_name"
                               value="{{ form.manager_name.value|default_if_none:'' }}"
                               placeholder="–í–∞—à–µ —ñ–º º—è"
                               autocomplete="name">
                        {% if form.manager_name.errors %}
                            <div class="offer-error">{{ form.manager_name.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div class="field">
                        <label for="general_tg">–†–µ–∑–µ—Ä–≤–Ω–∏–π Telegram (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                        <input type="text"
                               id="general_tg"
                               name="general_tg"
                               value="{{ form.general_tg.value|default_if_none:'' }}"
                               placeholder="https://t.me/twocomms –∞–±–æ @username"
                               autocomplete="url">
                        {% if form.general_tg.errors %}
                            <div class="offer-error">{{ form.general_tg.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="offer-messengers">
                    <div class="offer-messengers-head">
                        <p class="eyebrow">–ö–æ–Ω—Ç–∞–∫—Ç–∏</p>
                        <h4 class="offer-messengers-title">–ö–æ–Ω—Ç–∞–∫—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h4>
                    </div>

                    <div class="offer-messenger-row" data-messenger="phone">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="phone_enabled" name="phone_enabled" {% if form.phone_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-phone" aria-hidden="true">‚òé</span>
                                <span>–¢–µ–ª–µ—Ñ–æ–Ω</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="tel"
                                   id="phone"
                                   name="phone"
                                   value="{{ form.phone.value|default_if_none:'' }}"
                                   placeholder="+380XXXXXXXXX"
                                   class="offer-messenger-input"
                                   autocomplete="tel">
                            <div class="offer-messenger-help">–§–æ—Ä–º–∞—Ç: +380XXXXXXXXX</div>
                        </div>
                    </div>
                    {% if form.phone.errors %}
                        <div class="offer-error">{{ form.phone.errors.0 }}</div>
                    {% endif %}

                    <div class="offer-messenger-row" data-messenger="viber">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="viber_enabled" name="viber_enabled" {% if form.viber_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-viber" aria-hidden="true">V</span>
                                <span>Viber</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="text"
                                   id="viber"
                                   name="viber"
                                   value="{{ form.viber.value|default_if_none:'' }}"
                                   placeholder="+380... (–Ω–æ–º–µ—Ä)"
                                   class="offer-messenger-input"
                                   autocomplete="tel">
                            <div class="offer-messenger-help">–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è Viber</div>
                        </div>
                    </div>
                    {% if form.viber.errors %}
                        <div class="offer-error">{{ form.viber.errors.0 }}</div>
                    {% endif %}

                    <div class="offer-messenger-row" data-messenger="whatsapp">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="whatsapp_enabled" name="whatsapp_enabled" {% if form.whatsapp_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-whatsapp" aria-hidden="true">W</span>
                                <span>WhatsApp</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="text"
                                   id="whatsapp"
                                   name="whatsapp"
                                   value="{{ form.whatsapp.value|default_if_none:'' }}"
                                   placeholder="+380... (–Ω–æ–º–µ—Ä)"
                                   class="offer-messenger-input"
                                   autocomplete="tel">
                            <div class="offer-messenger-help">–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è WhatsApp</div>
                        </div>
                    </div>
                    {% if form.whatsapp.errors %}
                        <div class="offer-error">{{ form.whatsapp.errors.0 }}</div>
                    {% endif %}

                    <div class="offer-messenger-row" data-messenger="telegram">
                        <label class="offer-check offer-check-messenger">
                            <input type="checkbox" id="telegram_enabled" name="telegram_enabled" {% if form.telegram_enabled.value %}checked{% endif %}>
                            <span class="offer-messenger-label">
                                <span class="offer-messenger-icon offer-messenger-icon-telegram" aria-hidden="true">T</span>
                                <span>Telegram</span>
                            </span>
                        </label>
                        <div class="offer-messenger-input-wrap">
                            <input type="text"
                                   id="telegram"
                                   name="telegram"
                                   value="{{ form.telegram.value|default_if_none:'' }}"
                                   placeholder="@username –∞–±–æ +380..."
                                   class="offer-messenger-input"
                                   autocomplete="username">
                            <div class="offer-messenger-help">–õ–æ–≥—ñ–Ω @username –∞–±–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è Telegram</div>
                        </div>
                    </div>
                    {% if form.telegram.errors %}
                        <div class="offer-error">{{ form.telegram.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="offer-actions">
                <button type="submit" class="btn-primary offer-submit" id="offer-submit">
                    <span class="offer-btn-spinner" aria-hidden="true"></span>
                    <span class="offer-btn-text">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é</span>
                </button>
                <div class="offer-actions-sub">
                    –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–µ –∑ –ø–æ—à—Ç–∏ <span class="offer-mono">cooperation@twocomms.shop</span>.
                </div>
            </div>
        </form>

        <div class="offer-preview">
            <div class="offer-card offer-preview-card">
                <div class="offer-card-head offer-preview-head">
                    <div>
                        <p class="eyebrow">–ü—Ä–µ–≤ º—é</p>
                        <h3 class="offer-card-title">–Ø–∫ –≤–∏–≥–ª—è–¥–∞—Ç–∏–º–µ –ª–∏—Å—Ç</h3>
                    </div>
                    <div class="offer-preview-actions">
                        <div class="offer-preview-tabs" id="offer-preview-tabs" data-default-tab="{{ preview_mode|default:'VISUAL' }}">
                            <button type="button" class="offer-preview-tab" data-offer-preview-tab="VISUAL">VISUAL</button>
                            <button type="button" class="offer-preview-tab" data-offer-preview-tab="LIGHT">LIGHT</button>
                        </div>
                        <div class="offer-preview-sizes" id="offer-preview-sizes">
                            <button type="button" class="offer-preview-size" data-offer-preview-size="DESKTOP">600px</button>
                            <button type="button" class="offer-preview-size" data-offer-preview-size="MOBILE">360px</button>
                        </div>
                        <label class="offer-check offer-check-link offer-preview-images">
                            <input type="checkbox" id="offer-preview-images-toggle" checked>
                            <span>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏</span>
                        </label>
                    </div>
                </div>
                <div class="offer-preview-meta">
                    <div class="offer-preview-meta-line">
                        <span class="offer-preview-meta-label">–¢–µ–º–∞</span>
                        <span class="offer-preview-meta-value" id="offer-preview-subject">{{ preview_subject }}</span>
                    </div>
                    <div class="offer-preview-meta-sub" id="offer-preview-preheader">{{ preview_preheader }}</div>
                </div>
                <div class="offer-preview-surface" id="offer-preview-surface">
                    <div class="offer-preview-viewport" id="offer-preview-viewport">
                        <template id="offer-preview-initial-visual">{{ preview_visual_html|safe }}</template>
                        <iframe class="offer-preview-pane offer-preview-iframe"
                                id="offer-preview-visual"
                                title="VISUAL preview"
                                sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>
                        <pre class="offer-preview-pane offer-preview-pane-light" id="offer-preview-light">{{ preview_light_text }}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="offer-history">
        <div class="panel-header offer-history-head">
            <div>
                <p class="eyebrow">–Ü—Å—Ç–æ—Ä—ñ—è</p>
                <h3 class="offer-card-title">–û—Å—Ç–∞–Ω–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ –ö–ü</h3>
            </div>
        </div>
        <div class="table-shell">
            <table class="nexus-table">
                <thead>
                    <tr>
                        <th>–û—Ç—Ä–∏–º—É–≤–∞—á</th>
                        <th>–î–∞–Ω—ñ –≤ –ª–∏—Å—Ç—ñ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody id="offer-history-body">
                    {% if logs %}
                        {% for log in logs %}
                            {% include "management/partials/commercial_offer_log_row.html" with log=log %}
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td class="table-empty" colspan="5">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö –ö–ü</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal-overlay" id="offer-confirm-modal" aria-hidden="true">
    <div class="modal-card offer-confirm-card">
        <div class="modal-header">
            <div>
                <p class="eyebrow">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</p>
                <h3>–ü–æ–≤—Ç–æ—Ä–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞</h3>
            </div>
            <button type="button" class="modal-close" id="offer-confirm-close" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
        </div>
        <div class="modal-body">
            <p class="offer-confirm-text" id="offer-confirm-text">
                –ù–∞ —Ü–µ–π email –≤–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–ª–∏ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —â–µ —Ä–∞–∑?
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost" id="offer-confirm-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button type="button" class="btn-primary" id="offer-confirm-ok">–¢–∞–∫, –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="offer-log-modal" aria-hidden="true">
    <div class="modal-card offer-log-card">
        <div class="modal-header">
            <div>
                <p class="eyebrow">–ü–µ—Ä–µ–≥–ª—è–¥</p>
                <h3 id="offer-log-modal-title">–õ–∏—Å—Ç</h3>
                <div class="offer-log-modal-meta" id="offer-log-modal-meta"></div>
            </div>
            <button type="button" class="modal-close" id="offer-log-close" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
        </div>
        <div class="modal-body offer-log-modal-body">
            <div class="offer-preview-tabs offer-log-tabs" id="offer-log-tabs">
                <button type="button" class="offer-preview-tab" data-offer-log-tab="VISUAL">VISUAL</button>
                <button type="button" class="offer-preview-tab" data-offer-log-tab="LIGHT">LIGHT</button>
            </div>

            <div class="offer-log-pane offer-log-pane-visual" id="offer-log-pane-visual">
                <iframe class="offer-log-iframe" id="offer-log-iframe" title="Email preview" sandbox=""></iframe>
            </div>

            <pre class="offer-log-pane offer-log-pane-light" id="offer-log-pane-light"></pre>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost small" id="offer-log-copy-text">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç</button>
            <button type="button" class="btn-ghost small" id="offer-log-copy-html">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ HTML</button>
            <button type="button" class="btn-ghost" id="offer-log-close-2">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function initManagementCommercialOfferEmailPage() {
    const form = document.getElementById('offer-form');
    if (!form) return;
    if (form.dataset.mgmtInitialized === '1') return;
    form.dataset.mgmtInitialized = '1';

	    const previewVisual = document.getElementById('offer-preview-visual');
	    const previewInitialVisual = document.getElementById('offer-preview-initial-visual');
	    const previewImagesToggle = document.getElementById('offer-preview-images-toggle');
	    const previewLight = document.getElementById('offer-preview-light');
	    const previewSubject = document.getElementById('offer-preview-subject');
	    const previewPreheader = document.getElementById('offer-preview-preheader');
	    const previewTabButtons = Array.from(document.querySelectorAll('[data-offer-preview-tab]'));

    const alertStack = document.getElementById('offer-alert-stack');
    const historyBody = document.getElementById('offer-history-body');

    const confirmModal = document.getElementById('offer-confirm-modal');
    const confirmOk = document.getElementById('offer-confirm-ok');
    const confirmCancel = document.getElementById('offer-confirm-cancel');
    const confirmClose = document.getElementById('offer-confirm-close');
    const confirmText = document.getElementById('offer-confirm-text');
    const confirmResend = document.getElementById('confirm_resend');

    const logModal = document.getElementById('offer-log-modal');
    const logClose = document.getElementById('offer-log-close');
    const logClose2 = document.getElementById('offer-log-close-2');
    const logCopyText = document.getElementById('offer-log-copy-text');
    const logCopyHtml = document.getElementById('offer-log-copy-html');
    const logTitle = document.getElementById('offer-log-modal-title');
    const logMeta = document.getElementById('offer-log-modal-meta');
    const logIframe = document.getElementById('offer-log-iframe');
    const logPaneVisual = document.getElementById('offer-log-pane-visual');
    const logPaneLight = document.getElementById('offer-log-pane-light');
    const logTabButtons = Array.from(document.querySelectorAll('[data-offer-log-tab]'));

    const submitBtn = document.getElementById('offer-submit');
    const submitText = submitBtn?.querySelector('.offer-btn-text');

    const recipientEmail = document.getElementById('recipient_email');
    const recipientName = document.getElementById('recipient_name');
    const mode = document.getElementById('mode');
    const segmentMode = document.getElementById('segment_mode');
    const subjectPreset = document.getElementById('subject_preset');
    const subjectCustomWrap = document.getElementById('subject_custom_wrap');
    const subjectCustom = document.getElementById('subject_custom');

    const ctaType = document.getElementById('cta_type');
    const ctaButtonText = document.getElementById('cta_button_text');
    const ctaCustomUrlWrap = document.getElementById('cta_custom_url_wrap');
    const ctaCustomUrl = document.getElementById('cta_custom_url');
    const ctaMicrotext = document.getElementById('cta_microtext');

    const includeCatalogLink = document.getElementById('include_catalog_link');
    const includeWholesaleLink = document.getElementById('include_wholesale_link');
    const includeDropshipLink = document.getElementById('include_dropship_link');
    const includeInstagramLink = document.getElementById('include_instagram_link');
    const includeSiteLink = document.getElementById('include_site_link');

    const teeEntry = document.getElementById('tee_entry');
    const teeRetailExample = document.getElementById('tee_retail_example');
    const hoodieEntry = document.getElementById('hoodie_entry');
    const hoodieRetailExample = document.getElementById('hoodie_retail_example');
    const teeProfitDisplay = document.getElementById('tee_profit_display');
    const hoodieProfitDisplay = document.getElementById('hoodie_profit_display');
    const teeProfitWarn = document.getElementById('tee_profit_warn');
    const hoodieProfitWarn = document.getElementById('hoodie_profit_warn');
	    const unitFillDefaultsBtn = document.getElementById('offer-unit-fill-defaults');
	    const unitNote = document.getElementById('offer-unit-note');
	    const pricingMode = document.getElementById('pricing_mode');
	    const optTierWrap = document.getElementById('opt_tier_wrap');
	    const optTier = document.getElementById('opt_tier');
	    const dropTeePrice = document.getElementById('drop_tee_price');
	    const dropHoodiePrice = document.getElementById('drop_hoodie_price');
	    const dropshipLoyaltyBonus = document.getElementById('dropship_loyalty_bonus');

    const showManager = document.getElementById('show_manager');
    const managerName = document.getElementById('manager_name');
    const generalTg = document.getElementById('general_tg');
    const phoneEnabled = document.getElementById('phone_enabled');
    const phone = document.getElementById('phone');
    const viberEnabled = document.getElementById('viber_enabled');
    const viber = document.getElementById('viber');
    const whatsappEnabled = document.getElementById('whatsapp_enabled');
    const whatsapp = document.getElementById('whatsapp');
    const telegramEnabled = document.getElementById('telegram_enabled');
    const telegram = document.getElementById('telegram');

    const galleryNeutral = document.getElementById('gallery_neutral');
    const galleryEdgy = document.getElementById('gallery_edgy');
    const galleryList = document.getElementById('offer-gallery-list');
    const galleryNote = document.getElementById('offer-gallery-note');
    const galleryBtnDefault = document.getElementById('offer-gallery-default');
    const galleryBtnAdd = document.getElementById('offer-gallery-add');
    const galleryBtnRemove = document.getElementById('offer-gallery-remove');

    const previewViewport = document.getElementById('offer-preview-viewport');
    const previewSizeButtons = Array.from(document.querySelectorAll('[data-offer-preview-size]'));

    const dupHint = document.getElementById('offer-email-dup-hint');
    let dupExists = false;
    let dupCount = 0;
    let dupLast = '';
    let checkTimer = null;
    let abortController = null;

    let previewTimer = null;
    let previewAbortController = null;
    let activePreviewTab = 'VISUAL';
    let activeLogTab = 'VISUAL';
    let activePreviewSize = 'DESKTOP';
    let currentLogHtml = '';
    let currentLogText = '';

    let unitDefaults = null;

    const galleryState = {
        NEUTRAL: [],
        EDGY: [],
    };
    const gallerySlots = {
        NEUTRAL: 3,
        EDGY: 3,
    };
    const galleryResolveTimers = new Map();

    function parseIntSafe(value) {
        const raw = String(value || '').replace(/\s+/g, '').trim();
        if (!raw) return null;
        const num = Number(raw);
        if (!Number.isFinite(num)) return null;
        return Math.trunc(num);
    }

    function fmtNumber(value) {
        if (value === null || value === undefined) return '‚Äî';
        try {
            return Number(value).toLocaleString('uk-UA');
        } catch (e) {
            return String(value);
        }
    }

    function syncUnitProfits() {
        const defaultVal = (key) => {
            if (!unitDefaults) return null;
            const v = unitDefaults[key];
            return Number.isFinite(v) ? Math.trunc(v) : null;
        };

        const effective = (el, key) => {
            const v = parseIntSafe(el?.value);
            if (v !== null) return v;
            return defaultVal(key);
        };

        const setWarn = (warnEl, inputEl, text) => {
            if (warnEl) {
                warnEl.hidden = !text;
                warnEl.textContent = text || '';
            }
            if (inputEl) inputEl.classList.toggle('offer-input-warn', !!text);
        };

        const teeEntryVal = effective(teeEntry, 'tee_entry_default');
        const teeRetailVal = effective(teeRetailExample, 'tee_retail_default');
        if (teeEntryVal !== null && teeRetailVal !== null) {
            const raw = teeRetailVal - teeEntryVal;
            const profit = Math.max(0, raw);
            if (teeProfitDisplay) teeProfitDisplay.textContent = fmtNumber(profit);
            setWarn(teeProfitWarn, teeRetailExample, raw < 0 ? '–†–æ–∑–¥—Ä—ñ–± –º–µ–Ω—à–µ –∑–∞ –≤—Ö—ñ–¥ ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü–∏—Ñ—Ä–∏.' : '');
        } else {
            if (teeProfitDisplay) teeProfitDisplay.textContent = '‚Äî';
            setWarn(teeProfitWarn, teeRetailExample, '');
        }

        const hoodieEntryVal = effective(hoodieEntry, 'hoodie_entry_default');
        const hoodieRetailVal = effective(hoodieRetailExample, 'hoodie_retail_default');
        if (hoodieEntryVal !== null && hoodieRetailVal !== null) {
            const raw = hoodieRetailVal - hoodieEntryVal;
            const profit = Math.max(0, raw);
            if (hoodieProfitDisplay) hoodieProfitDisplay.textContent = fmtNumber(profit);
            setWarn(hoodieProfitWarn, hoodieRetailExample, raw < 0 ? '–†–æ–∑–¥—Ä—ñ–± –º–µ–Ω—à–µ –∑–∞ –≤—Ö—ñ–¥ ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü–∏—Ñ—Ä–∏.' : '');
        } else {
            if (hoodieProfitDisplay) hoodieProfitDisplay.textContent = '‚Äî';
            setWarn(hoodieProfitWarn, hoodieRetailExample, '');
        }
    }

    function syncPricingUI() {
        const isDrop = (pricingMode?.value || 'OPT').toUpperCase() === 'DROP';
        if (optTierWrap) optTierWrap.hidden = isDrop;
        if (optTier) optTier.disabled = isDrop;
    }

    function syncSubjectCustom() {
        const isCustom = subjectPreset && subjectPreset.value === 'CUSTOM';
        if (subjectCustomWrap) subjectCustomWrap.hidden = !isCustom;
        if (!isCustom && subjectCustom) subjectCustom.value = '';
    }

    function syncCtaCustomUrl() {
        const isCustom = ctaType && ctaType.value === 'CUSTOM_URL';
        if (ctaCustomUrlWrap) ctaCustomUrlWrap.hidden = !isCustom;
        if (!isCustom && ctaCustomUrl) ctaCustomUrl.value = '';
    }

    const messengerRows = [
        { row: document.querySelector('[data-messenger="phone"]'), toggle: phoneEnabled, input: phone },
        { row: document.querySelector('[data-messenger="viber"]'), toggle: viberEnabled, input: viber },
        { row: document.querySelector('[data-messenger="whatsapp"]'), toggle: whatsappEnabled, input: whatsapp },
        { row: document.querySelector('[data-messenger="telegram"]'), toggle: telegramEnabled, input: telegram },
    ].filter((x) => x.row && x.toggle && x.input);

    function syncMessengerUI() {
        const showMgr = !!showManager?.checked;

        if (managerName) {
            managerName.readOnly = !showMgr;
            managerName.classList.toggle('is-readonly', !showMgr);
        }

        messengerRows.forEach(({ row, toggle, input }) => {
            toggle.disabled = !showMgr;
            const enabled = showMgr && !!toggle.checked;
            row.classList.toggle('is-enabled', enabled);
            row.classList.toggle('is-disabled', !enabled);
            input.readOnly = !enabled;
            input.setAttribute('aria-disabled', String(!enabled));
        });
    }

    function setActivePreview(tab) {
        activePreviewTab = tab;
        previewTabButtons.forEach((btn) => {
            const isActive = btn.getAttribute('data-offer-preview-tab') === tab;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-selected', String(isActive));
        });
        if (previewVisual) previewVisual.style.display = tab === 'VISUAL' ? '' : 'none';
        if (previewLight) previewLight.style.display = tab === 'LIGHT' ? '' : 'none';
    }

    function setPreviewSize(size) {
        activePreviewSize = size;
        previewSizeButtons.forEach((btn) => {
            const isActive = btn.getAttribute('data-offer-preview-size') === size;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-selected', String(isActive));
        });
        if (!previewViewport) return;
        previewViewport.classList.toggle('is-mobile', size === 'MOBILE');
    }

    function setActiveLog(tab) {
        activeLogTab = tab;
        logTabButtons.forEach((btn) => {
            const isActive = btn.getAttribute('data-offer-log-tab') === tab;
            btn.classList.toggle('is-active', isActive);
            btn.setAttribute('aria-selected', String(isActive));
        });
        if (logPaneVisual) logPaneVisual.style.display = tab === 'VISUAL' ? '' : 'none';
        if (logPaneLight) logPaneLight.style.display = tab === 'LIGHT' ? '' : 'none';
    }

    let lastPreviewVisualHtml = (previewInitialVisual && previewInitialVisual.innerHTML) ? previewInitialVisual.innerHTML.trim() : '';

    function buildPreviewDoc(bodyHtml) {
        const showImages = !previewImagesToggle || !!previewImagesToggle.checked;
        const imagesCss = showImages ? '' : 'img{display:none !important;}';
        const safeBody = String(bodyHtml || '');
        return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">` +
            `<base target="_blank">` +
            `<style>html,body{margin:0;padding:0;background:#121212;}${imagesCss}</style>` +
            `</head><body>${safeBody}</body></html>`;
    }

    function renderVisualPreview(html) {
        lastPreviewVisualHtml = String(html || '');
        if (!previewVisual) return;
        previewVisual.srcdoc = buildPreviewDoc(lastPreviewVisualHtml);
    }

    function refreshVisualPreview() {
        renderVisualPreview(lastPreviewVisualHtml);
    }

    async function updatePreviewNow() {
        if (previewAbortController) previewAbortController.abort();
        previewAbortController = new AbortController();

        try {
            const formData = new FormData(form);
            const resp = await fetch('{% url "management_commercial_offer_email_preview_api" %}', {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
                signal: previewAbortController.signal,
            });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data || !data.ok) return;

            renderVisualPreview(data.html || '');
            if (previewLight) previewLight.textContent = data.text || '';
            if (previewSubject) previewSubject.textContent = data.subject || '';
            if (previewPreheader) previewPreheader.textContent = data.preheader || '';
        } catch (e) {
            if (e && e.name === 'AbortError') return;
        }
    }

    function schedulePreviewUpdate() {
        if (previewTimer) clearTimeout(previewTimer);
        previewTimer = setTimeout(updatePreviewNow, 320);
    }

    function setUnitNoteText(text) {
        if (!unitNote) return;
        unitNote.hidden = !text;
        unitNote.textContent = text || '';
    }

    async function loadUnitDefaults() {
        try {
            const params = new URLSearchParams();
            if (pricingMode && pricingMode.value) params.set('pricing_mode', pricingMode.value);
            if (optTier && optTier.value) params.set('opt_tier', optTier.value);
            const dropTeeVal = parseIntSafe(dropTeePrice?.value);
            const dropHoodieVal = parseIntSafe(dropHoodiePrice?.value);
            if (dropTeeVal !== null) params.set('drop_tee_price', String(dropTeeVal));
            if (dropHoodieVal !== null) params.set('drop_hoodie_price', String(dropHoodieVal));

            const url = `{% url "management_commercial_offer_email_unit_defaults_api" %}?${params.toString()}`;
            const resp = await fetch(url, {
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
            });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data || !data.ok || !data.defaults) return;
            unitDefaults = data.defaults;
            if (unitDefaults && unitDefaults.retail_source === 'fallback') {
                setUnitNoteText('–ó–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ fallback-—Ü—ñ–Ω–∏ –¥–ª—è —Ä–æ–∑–¥—Ä–æ–±—É (–Ω–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –∑ —Å–∞–π—Ç—É).');
            } else {
                setUnitNoteText('');
            }
            syncUnitProfits();
        } catch (e) {
            // ignore
        }
    }

    async function fillUnitDefaults() {
        if (!unitDefaults) await loadUnitDefaults();
        if (!unitDefaults) return;
        if (teeEntry) teeEntry.value = unitDefaults.tee_entry_default ?? '';
        if (teeRetailExample) teeRetailExample.value = unitDefaults.tee_retail_default ?? '';
        if (hoodieEntry) hoodieEntry.value = unitDefaults.hoodie_entry_default ?? '';
        if (hoodieRetailExample) hoodieRetailExample.value = unitDefaults.hoodie_retail_default ?? '';
        syncUnitProfits();
        schedulePreviewUpdate();
    }

    function parseJsonGallery(value) {
        try {
            const data = JSON.parse(String(value || '[]'));
            if (!Array.isArray(data)) return [];
            return data.slice(0, 6).map((item) => {
                if (typeof item === 'string') {
                    const url = String(item || '').trim();
                    return url ? { url, caption: '' } : null;
                }
                if (item && typeof item === 'object') {
                    const url = String(item.url || item.link || item.href || '').trim();
                    const caption = String(item.caption || item.title || '').trim();
                    return url ? { url, caption } : null;
                }
                return null;
            }).filter(Boolean);
        } catch (e) {
            return [];
        }
    }

    function normalizeGallerySlots(slots) {
        const list = Array.isArray(slots) ? slots : [];
        return list.slice(0, 6).map((slot) => ({
            url: String(slot?.url || '').trim(),
            caption: String(slot?.caption || '').trim(),
        }));
    }

    function syncGalleryHidden() {
        if (galleryNeutral) galleryNeutral.value = JSON.stringify(normalizeGallerySlots(galleryState.NEUTRAL));
        if (galleryEdgy) galleryEdgy.value = JSON.stringify(normalizeGallerySlots(galleryState.EDGY));
    }

    function escapeAttr(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function getActiveSegment() {
        const seg = (segmentMode?.value || 'NEUTRAL').toUpperCase();
        return seg === 'EDGY' ? 'EDGY' : 'NEUTRAL';
    }

    function renderGallery() {
        if (!galleryList) return;
        const seg = getActiveSegment();
        const slotsData = galleryState[seg] || [];
        const slots = Math.max(0, Math.min(6, gallerySlots[seg] || 0));

        const html = Array.from({ length: slots }).map((_, idx) => {
            const slot = slotsData[idx] || { url: '', caption: '' };
            const url = String(slot.url || '').trim();
            const caption = String(slot.caption || '').trim();
            return `
                <div class="offer-gallery-slot" data-slot-index="${idx}">
                    <div class="offer-gallery-slot-main">
                        <input type="url" class="offer-gallery-url" value="${escapeAttr(url)}" placeholder="https://twocomms.shop/product/... –∞–±–æ https://...jpg">
                        <button type="button" class="offer-gallery-clear" aria-label="–û—á–∏—Å—Ç–∏—Ç–∏" ${url ? '' : 'disabled'}>√ó</button>
                    </div>
                    <div class="offer-gallery-slot-sub">
                        <input type="text" class="offer-gallery-caption" value="${escapeAttr(caption)}" placeholder="–ü—ñ–¥–ø–∏—Å (–∫–æ—Ä–æ—Ç–∫–æ)">
                    </div>
                    <div class="offer-gallery-preview" hidden>
                        <div class="offer-gallery-thumb"><img alt="" /></div>
                        <div class="offer-gallery-preview-meta">
                            <div class="offer-gallery-title"></div>
                            <a class="offer-gallery-open" href="#" target="_blank" rel="noopener">–í—ñ–¥–∫—Ä–∏—Ç–∏</a>
                        </div>
                    </div>
                    <div class="offer-gallery-error" hidden></div>
                </div>
            `;
        }).join('');
        galleryList.innerHTML = html;

        galleryList.querySelectorAll('.offer-gallery-url').forEach((input) => {
            input.addEventListener('input', () => scheduleGallerySync());
            input.addEventListener('change', () => scheduleGallerySync());
        });
        galleryList.querySelectorAll('.offer-gallery-caption').forEach((input) => {
            input.addEventListener('input', () => scheduleGallerySync());
            input.addEventListener('change', () => scheduleGallerySync());
        });
        galleryList.querySelectorAll('.offer-gallery-clear').forEach((btn) => {
            btn.addEventListener('click', (e) => {
                const slot = e.target.closest('.offer-gallery-slot');
                if (!slot) return;
                const input = slot.querySelector('.offer-gallery-url');
                const caption = slot.querySelector('.offer-gallery-caption');
                if (!input) return;
                input.value = '';
                if (caption) caption.value = '';
                scheduleGallerySync();
            });
        });

        scheduleGallerySync();
    }

    function setGalleryNote(text) {
        if (!galleryNote) return;
        galleryNote.hidden = !text;
        galleryNote.textContent = text || '';
    }

    let gallerySyncTimer = null;
    function scheduleGallerySync() {
        if (gallerySyncTimer) clearTimeout(gallerySyncTimer);
        gallerySyncTimer = setTimeout(syncGalleryFromUI, 220);
    }

    function syncGalleryFromUI() {
        const seg = getActiveSegment();
        if (!galleryList) return;
        const slotEls = Array.from(galleryList.querySelectorAll('.offer-gallery-slot'));
        const slots = slotEls.slice(0, 6).map((slotEl) => {
            const url = String(slotEl.querySelector('.offer-gallery-url')?.value || '').trim();
            const caption = String(slotEl.querySelector('.offer-gallery-caption')?.value || '').trim();
            return { url, caption };
        });
        galleryState[seg] = slots;
        gallerySlots[seg] = Math.max(gallerySlots[seg] || 0, slots.length);
        syncGalleryHidden();
        resolveGallerySlots();
        schedulePreviewUpdate();
    }

    function updateSlotUI(slotEl, data, errorText) {
        if (!slotEl) return;
        const preview = slotEl.querySelector('.offer-gallery-preview');
        const img = slotEl.querySelector('.offer-gallery-thumb img');
        const titleEl = slotEl.querySelector('.offer-gallery-title');
        const openEl = slotEl.querySelector('.offer-gallery-open');
        const errEl = slotEl.querySelector('.offer-gallery-error');
        const clearBtn = slotEl.querySelector('.offer-gallery-clear');
        const captionInput = slotEl.querySelector('.offer-gallery-caption');

        const hasUrl = !!slotEl.querySelector('.offer-gallery-url')?.value?.trim();
        if (clearBtn) clearBtn.disabled = !hasUrl;

        if (errorText) {
            if (errEl) {
                errEl.hidden = false;
                errEl.textContent = errorText;
            }
            if (preview) preview.hidden = true;
            return;
        }

        if (!data) {
            if (errEl) {
                errEl.hidden = true;
                errEl.textContent = '';
            }
            if (preview) preview.hidden = true;
            return;
        }

        const caption = String(captionInput?.value || '').trim();
        const title = caption || data.title || '';
        if (img) img.src = data.img_url || '';
        if (img) img.alt = title;
        if (titleEl) titleEl.textContent = title;
        if (openEl) openEl.href = data.link_url || data.url || '#';
        if (errEl) {
            errEl.hidden = true;
            errEl.textContent = '';
        }
        if (preview) preview.hidden = false;
    }

    async function resolveProductUrl(url) {
        const clean = String(url || '').trim();
        if (!clean) return null;
        const resp = await fetch(`{% url "management_commercial_offer_email_resolve_product_api" %}?url=${encodeURIComponent(clean)}`, {
            headers: { 'Accept': 'application/json' },
            credentials: 'same-origin',
        });
        if (!resp.ok) return null;
        const data = await resp.json();
        if (!data || !data.ok || !data.item) return null;
        return data.item;
    }

    function resolveGallerySlots() {
        const seg = getActiveSegment();
        const slots = galleryState[seg] || [];
        const slotEls = Array.from(galleryList?.querySelectorAll('.offer-gallery-slot') || []);

        slotEls.forEach((slotEl) => {
            const idx = Number(slotEl.getAttribute('data-slot-index') || '0');
            const url = String(slots[idx]?.url || '').trim();

            const timerKey = `${seg}:${idx}`;
            if (galleryResolveTimers.has(timerKey)) {
                clearTimeout(galleryResolveTimers.get(timerKey));
                galleryResolveTimers.delete(timerKey);
            }

            if (!url) {
                updateSlotUI(slotEl, null, '');
                return;
            }

            const t = setTimeout(async () => {
                try {
                    updateSlotUI(slotEl, null, '');
                    const item = await resolveProductUrl(url);
                    if (!item) {
                        updateSlotUI(slotEl, null, '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–±—Ä–æ–±–∏—Ç–∏ URL (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–æ–≤–∞—Ä –∞–±–æ –∫–∞—Ä—Ç–∏–Ω–∫—É).');
                        return;
                    }
                    updateSlotUI(slotEl, item, '');
                } catch (e) {
                    updateSlotUI(slotEl, null, '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É.');
                }
            }, 320);
            galleryResolveTimers.set(timerKey, t);
        });
    }

    async function setGalleryDefaultsForSegment(seg) {
        try {
            const resp = await fetch(`{% url "management_commercial_offer_email_gallery_defaults_api" %}?segment=${encodeURIComponent(seg)}`, {
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
            });
            if (!resp.ok) return null;
            const data = await resp.json();
            if (!data || !data.ok || !Array.isArray(data.urls)) return null;
            return data;
        } catch (e) {
            return null;
        }
    }

    function setDupHint(data) {
        dupExists = !!data.exists;
        dupCount = Number.isFinite(data.count) ? data.count : 0;
        dupLast = data.lastSentAtDisplay || '';
        if (!dupExists) {
            dupHint.hidden = true;
            dupHint.textContent = '';
            return;
        }

        const lastPart = dupLast ? ` –û—Å—Ç–∞–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∞: ${dupLast}.` : '';
        dupHint.hidden = false;
        dupHint.textContent = `–¶–µ–π email –≤–∂–µ –æ—Ç—Ä–∏–º—É–≤–∞–≤ –ö–ü (${dupCount}).${lastPart} –í–æ–Ω–∞ –±—É–¥–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ —â–µ —Ä–∞–∑.`;
    }

    async function checkDuplicateEmail(value) {
        const email = (value || '').trim();
        confirmResend.value = '0';
        if (!email || !email.includes('@')) {
            setDupHint({ exists: false, count: 0, lastSentAtDisplay: '' });
            return;
        }

        if (abortController) abortController.abort();
        abortController = new AbortController();
        try {
            const url = `{% url 'management_commercial_offer_email_check_api' %}?email=${encodeURIComponent(email)}`;
            const resp = await fetch(url, { signal: abortController.signal, headers: { 'Accept': 'application/json' } });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data || !data.ok) return;
            setDupHint(data);
        } catch (e) {
            // ignore
        }
    }

    function scheduleDuplicateCheck() {
        if (checkTimer) clearTimeout(checkTimer);
        checkTimer = setTimeout(() => checkDuplicateEmail(recipientEmail.value), 350);
    }

    function openConfirmModal() {
        const email = (recipientEmail.value || '').trim();
        const lastPart = dupLast ? ` (–æ—Å—Ç–∞–Ω–Ω—ñ–π —Ä–∞–∑: ${dupLast})` : '';
        confirmText.textContent = `–ù–∞ email ${email}${lastPart} –≤–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–ª–∏ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —â–µ —Ä–∞–∑?`;
        confirmModal.classList.add('show');
        confirmModal.setAttribute('aria-hidden', 'false');
    }

    function closeConfirmModal() {
        confirmModal.classList.remove('show');
        confirmModal.setAttribute('aria-hidden', 'true');
    }

    function setAlert(kind, text) {
        const el = document.createElement('div');
        el.className = `offer-alert offer-alert-${kind}`;
        el.textContent = text;
        alertStack.innerHTML = '';
        alertStack.appendChild(el);
        window.setTimeout(() => {
            if (el.parentNode === alertStack) {
                el.style.opacity = '0.0';
                el.style.transform = 'translateY(-4px)';
                el.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                window.setTimeout(() => { if (el.parentNode === alertStack) alertStack.innerHTML = ''; }, 240);
            }
        }, 5500);
    }

    async function copyToClipboard(text) {
        const value = String(text || '');
        if (!value) {
            setAlert('danger', '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è.');
            return;
        }
        try {
            await navigator.clipboard.writeText(value);
            setAlert('success', '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É.');
        } catch (e) {
            try {
                const ta = document.createElement('textarea');
                ta.value = value;
                ta.setAttribute('readonly', '');
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                setAlert('success', '–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É.');
            } catch (e2) {
                setAlert('danger', '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏.');
            }
        }
    }

    function setButtonState(state) {
        if (state === 'loading') {
            submitBtn.classList.add('is-loading');
            submitBtn.disabled = true;
            if (submitText) submitText.textContent = '–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ‚Ä¶';
            return;
        }
        if (state === 'success') {
            submitBtn.classList.remove('is-loading');
            submitBtn.classList.add('is-success');
            submitBtn.disabled = true;
            if (submitText) submitText.textContent = '–ö–ü –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ';
            return;
        }
        submitBtn.classList.remove('is-loading');
        submitBtn.classList.remove('is-success');
        submitBtn.disabled = false;
        if (submitText) submitText.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–º–µ—Ä—Ü—ñ–π–Ω—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é';
    }

    function clearRecipientFields() {
        recipientEmail.value = '';
        recipientName.value = '';
        confirmResend.value = '0';
        setDupHint({ exists: false, count: 0, lastSentAtDisplay: '' });
        schedulePreviewUpdate();
    }

    function prependHistoryRow(rowHtml) {
        const emptyRow = historyBody.querySelector('tr .table-empty')?.closest('tr');
        if (emptyRow) emptyRow.remove();

        const tmp = document.createElement('tbody');
        tmp.innerHTML = rowHtml.trim();
        const row = tmp.querySelector('tr');
        if (row) historyBody.prepend(row);
    }

    async function sendOffer() {
        const email = (recipientEmail.value || '').trim();
        if (!email) {
            setAlert('danger', '–í–∫–∞–∂—ñ—Ç—å email –æ—Ç—Ä–∏–º—É–≤–∞—á–∞.');
            return;
        }

        setButtonState('loading');
        alertStack.innerHTML = '';

        const formData = new FormData(form);
        try {
            const resp = await fetch('{% url "management_commercial_offer_email_send_api" %}', {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin',
            });

            if (resp.status === 409) {
                const data = await resp.json();
                if (data && data.needs_confirmation) {
                    if (data.duplicate) {
                        setDupHint({
                            exists: true,
                            count: data.duplicate.count || 0,
                            lastSentAtDisplay: data.duplicate.lastSentAtDisplay || ''
                        });
                    }
                    setButtonState('idle');
                    openConfirmModal();
                    return;
                }
            }

            const data = await resp.json();
            if (!resp.ok || !data || !data.ok) {
                setButtonState('idle');
                if (data && data.errors) {
                    const firstKey = Object.keys(data.errors)[0];
                    const firstMsg = firstKey ? (data.errors[firstKey][0] || '') : '';
                    setAlert('danger', firstMsg || '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ —Ñ–æ—Ä–º–∏.');
                } else {
                    setAlert('danger', (data && data.message) ? data.message : '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª–∏—Å—Ç.');
                }
                return;
            }

            if (data.row_html) {
                prependHistoryRow(data.row_html || '');
            }
            if (data.sent) {
                setAlert('success', data.message || '–ö–ü —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ.');
                setButtonState('success');
                clearRecipientFields();
                window.setTimeout(() => setButtonState('idle'), 2400);
            } else {
                setButtonState('idle');
                setAlert('danger', data.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª–∏—Å—Ç.');
            }
        } catch (e) {
            setButtonState('idle');
            setAlert('danger', '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
        }
    }

    async function fetchLog(url) {
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
        if (!resp.ok) return null;
        const data = await resp.json();
        if (!data || !data.ok || !data.log) return null;
        return data.log;
    }

    async function resendLog(url) {
        const csrf = form.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        const fd = new FormData();
        if (csrf) fd.append('csrfmiddlewaretoken', csrf);

        const resp = await fetch(url, {
            method: 'POST',
            body: fd,
            headers: { 'Accept': 'application/json' },
            credentials: 'same-origin',
        });
        let data = null;
        try {
            data = await resp.json();
        } catch (e) {
            data = null;
        }
        if (!resp.ok || !data || !data.ok) {
            return { ok: false, message: (data && data.message) ? data.message : '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª–∏—Å—Ç.', error: data && data.error ? data.error : '' };
        }
        return data;
    }

    function openLogModal(log) {
        if (!logModal) return;
        if (logTitle) logTitle.textContent = log.subject || '–õ–∏—Å—Ç';
        if (logMeta) {
            const metaParts = [
                log.recipient_email || '',
                log.created_at_display || '',
                `${(log.mode || '').toUpperCase()}${log.segment_mode ? ' / ' + (log.segment_mode || '').toUpperCase() : ''}`,
            ].filter(Boolean);
            logMeta.textContent = metaParts.join(' ‚Ä¢ ');
        }
        if (logIframe) {
            const html = log.body_html || '<div style="font-family:Arial,Helvetica,sans-serif;padding:18px;">HTML –≤—ñ–¥—Å—É—Ç–Ω—ñ–π.</div>';
            logIframe.srcdoc = html;
        }
        currentLogHtml = log.body_html || '';
        currentLogText = log.body_text || '';
        if (logPaneLight) logPaneLight.textContent = currentLogText || '';

        setActiveLog((log.mode || '').toUpperCase() === 'LIGHT' ? 'LIGHT' : 'VISUAL');

        logModal.classList.add('show');
        logModal.setAttribute('aria-hidden', 'false');
    }

    function closeLogModal() {
        if (!logModal) return;
        logModal.classList.remove('show');
        logModal.setAttribute('aria-hidden', 'true');
    }

	    function fillFormFromLog(log) {
        recipientEmail.value = log.recipient_email || '';
        recipientName.value = log.recipient_name || '';

        if (mode) mode.value = (log.mode || 'VISUAL').toUpperCase();
        if (segmentMode) segmentMode.value = (log.segment_mode || 'NEUTRAL').toUpperCase();
        if (subjectPreset) subjectPreset.value = (log.subject_preset || 'PRESET_1').toUpperCase();
        if (subjectCustom) subjectCustom.value = log.subject_custom || '';
        syncSubjectCustom();

	        if (ctaType) ctaType.value = (log.cta_type || '').toUpperCase();
	        if (ctaButtonText) ctaButtonText.value = log.cta_button_text || '';
	        if (ctaCustomUrl) ctaCustomUrl.value = log.cta_custom_url || '';
	        if (ctaMicrotext) ctaMicrotext.value = log.cta_microtext || '';
	        syncCtaCustomUrl();

	        if (pricingMode) pricingMode.value = (log.pricing_mode || 'OPT').toUpperCase();
	        if (optTier) optTier.value = (log.opt_tier || '8_15').toUpperCase();
	        if (dropTeePrice) dropTeePrice.value = log.drop_tee_price ?? '';
	        if (dropHoodiePrice) dropHoodiePrice.value = log.drop_hoodie_price ?? '';
	        if (dropshipLoyaltyBonus) dropshipLoyaltyBonus.checked = !!log.dropship_loyalty_bonus;
	        syncPricingUI();

	        if (teeEntry) teeEntry.value = log.tee_entry ?? '';
	        if (teeRetailExample) teeRetailExample.value = log.tee_retail_example ?? '';
	        if (hoodieEntry) hoodieEntry.value = log.hoodie_entry ?? '';
	        if (hoodieRetailExample) hoodieRetailExample.value = log.hoodie_retail_example ?? '';
	        loadUnitDefaults().finally(() => syncUnitProfits());

        if (showManager) showManager.checked = !!log.show_manager;
        if (managerName) managerName.value = log.manager_name || '';
        if (generalTg) generalTg.value = log.general_tg || '';
        if (phoneEnabled) phoneEnabled.checked = !!(log.phone_enabled ?? ((log.phone || '').trim()));
        if (phone) phone.value = log.phone || '';
        if (viberEnabled) viberEnabled.checked = !!(log.viber || '').trim();
        if (viber) viber.value = log.viber || '';
        if (whatsappEnabled) whatsappEnabled.checked = !!(log.whatsapp || '').trim();
        if (whatsapp) whatsapp.value = log.whatsapp || '';
        if (telegramEnabled) telegramEnabled.checked = !!(log.telegram || '').trim();
        if (telegram) telegram.value = log.telegram || '';

        if (includeCatalogLink) includeCatalogLink.checked = log.include_catalog_link ?? true;
        if (includeWholesaleLink) includeWholesaleLink.checked = log.include_wholesale_link ?? true;
        if (includeDropshipLink) includeDropshipLink.checked = log.include_dropship_link ?? true;
        if (includeInstagramLink) includeInstagramLink.checked = log.include_instagram_link ?? true;
        if (includeSiteLink) includeSiteLink.checked = log.include_site_link ?? true;

	        const seg = (log.segment_mode || 'NEUTRAL').toUpperCase() === 'EDGY' ? 'EDGY' : 'NEUTRAL';
	        const galleryItems = Array.isArray(log.gallery_urls) ? log.gallery_urls.slice(0, 6).map((item) => {
	            if (typeof item === 'string') {
	                const url = String(item || '').trim();
	                return url ? { url, caption: '' } : null;
	            }
	            if (item && typeof item === 'object') {
	                const url = String(item.url || item.link || item.href || '').trim();
	                const caption = String(item.caption || item.title || '').trim();
	                return url ? { url, caption } : null;
	            }
	            return null;
	        }).filter(Boolean) : [];
	        if (seg === 'EDGY') {
	            galleryState.EDGY = galleryItems;
	            gallerySlots.EDGY = Math.max(3, galleryItems.length || 0);
	        } else {
	            galleryState.NEUTRAL = galleryItems;
	            gallerySlots.NEUTRAL = Math.max(3, galleryItems.length || 0);
	        }
	        syncGalleryHidden();
	        renderGallery();

        confirmResend.value = '0';

        syncMessengerUI();
        scheduleDuplicateCheck();
        schedulePreviewUpdate();

        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function handleHistoryClick(e) {
        const actionBtn = e.target.closest('[data-offer-log-action]');
        if (!actionBtn) return;
        const action = actionBtn.getAttribute('data-offer-log-action');
        const url = actionBtn.getAttribute('data-url');
        if (!action || !url) return;

        actionBtn.disabled = true;
        if (action === 'resend') {
            resendLog(url).then((res) => {
                if (!res || !res.ok) {
                    setAlert('danger', (res && res.message) ? res.message : '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª–∏—Å—Ç.');
                    return;
                }
                if (res.row_html) prependHistoryRow(res.row_html || '');
                setAlert(res.sent ? 'success' : 'danger', res.message || (res.sent ? '–ö–ü —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ.' : '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ª–∏—Å—Ç.'));
            }).finally(() => {
                actionBtn.disabled = false;
            });
            return;
        }

        fetchLog(url).then((log) => {
            if (!log) return;
            if (action === 'view') openLogModal(log);
            if (action === 'duplicate') fillFormFromLog(log);
        }).finally(() => {
            actionBtn.disabled = false;
        });
    }

    function bindPreviewChange(el, eventName = 'input') {
        if (!el) return;
        el.addEventListener(eventName, () => schedulePreviewUpdate());
    }

	    [recipientName, managerName, generalTg, phone, viber, whatsapp, telegram, dropTeePrice, dropHoodiePrice, teeEntry, teeRetailExample, hoodieEntry, hoodieRetailExample, subjectCustom, ctaButtonText, ctaCustomUrl, ctaMicrotext].forEach((el) => bindPreviewChange(el, 'input'));
	    [mode, segmentMode, subjectPreset, ctaType, pricingMode, optTier].forEach((el) => bindPreviewChange(el, 'change'));
	    [showManager, phoneEnabled, viberEnabled, whatsappEnabled, telegramEnabled, dropshipLoyaltyBonus, includeCatalogLink, includeWholesaleLink, includeDropshipLink, includeInstagramLink, includeSiteLink].forEach((el) => bindPreviewChange(el, 'change'));

    [teeEntry, teeRetailExample, hoodieEntry, hoodieRetailExample].forEach((el) => {
        if (!el) return;
        el.addEventListener('input', syncUnitProfits);
    });

	    if (subjectPreset) subjectPreset.addEventListener('change', syncSubjectCustom);
	    if (ctaType) ctaType.addEventListener('change', syncCtaCustomUrl);
	    if (pricingMode) pricingMode.addEventListener('change', () => {
	        syncPricingUI();
	        loadUnitDefaults().finally(() => syncUnitProfits());
	    });
	    if (optTier) optTier.addEventListener('change', () => {
	        loadUnitDefaults().finally(() => syncUnitProfits());
	    });
	    [dropTeePrice, dropHoodiePrice].forEach((el) => {
	        if (!el) return;
	        el.addEventListener('input', () => loadUnitDefaults().finally(() => syncUnitProfits()));
	        el.addEventListener('change', () => loadUnitDefaults().finally(() => syncUnitProfits()));
	    });
	    if (showManager) showManager.addEventListener('change', syncMessengerUI);
	    messengerRows.forEach(({ toggle, input }) => {
	        toggle.addEventListener('change', syncMessengerUI);
	        input.addEventListener('input', syncMessengerUI);
	    });

	    previewTabButtons.forEach((btn) => {
	        btn.addEventListener('click', () => {
	            const tab = btn.getAttribute('data-offer-preview-tab');
	            if (!tab) return;
	            setActivePreview(tab);
	        });
	    });

	    if (previewImagesToggle) {
	        previewImagesToggle.addEventListener('change', () => {
	            refreshVisualPreview();
	        });
	    }

    previewSizeButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const size = btn.getAttribute('data-offer-preview-size');
            if (!size) return;
            setPreviewSize(size);
        });
    });

    if (mode) {
        mode.addEventListener('change', () => {
            const m = (mode.value || '').toUpperCase();
            if (m === 'LIGHT') setActivePreview('LIGHT');
            if (m === 'VISUAL') setActivePreview('VISUAL');
        });
    }

    if (segmentMode) {
        segmentMode.addEventListener('change', () => {
            renderGallery();
        });
    }

    logTabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const tab = btn.getAttribute('data-offer-log-tab');
            if (!tab) return;
            setActiveLog(tab);
        });
    });

    if (logClose) logClose.addEventListener('click', closeLogModal);
    if (logClose2) logClose2.addEventListener('click', closeLogModal);
    if (logCopyText) logCopyText.addEventListener('click', () => copyToClipboard(currentLogText));
    if (logCopyHtml) logCopyHtml.addEventListener('click', () => copyToClipboard(currentLogHtml || logIframe?.srcdoc || ''));
    if (logModal) logModal.addEventListener('click', (e) => { if (e.target === logModal) closeLogModal(); });

    recipientEmail.addEventListener('input', scheduleDuplicateCheck);
    recipientEmail.addEventListener('change', scheduleDuplicateCheck);

    confirmCancel.addEventListener('click', closeConfirmModal);
    confirmClose.addEventListener('click', closeConfirmModal);
    confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) closeConfirmModal();
    });
    confirmOk.addEventListener('click', () => {
        confirmResend.value = '1';
        closeConfirmModal();
        sendOffer();
    });

    if (unitFillDefaultsBtn) unitFillDefaultsBtn.addEventListener('click', fillUnitDefaults);

    if (galleryBtnAdd) galleryBtnAdd.addEventListener('click', () => {
        const seg = getActiveSegment();
        gallerySlots[seg] = Math.min(6, (gallerySlots[seg] || 0) + 1);
        renderGallery();
    });
    if (galleryBtnRemove) galleryBtnRemove.addEventListener('click', () => {
        const seg = getActiveSegment();
        gallerySlots[seg] = Math.max(0, (gallerySlots[seg] || 0) - 1);
        renderGallery();
    });
	    if (galleryBtnDefault) galleryBtnDefault.addEventListener('click', async () => {
	        const seg = getActiveSegment();
	        const res = await setGalleryDefaultsForSegment(seg);
	        if (!res) {
	            setGalleryNote('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –Ω–∞–±—ñ—Ä.');
	            return;
	        }
	        const raw = Array.isArray(res.urls) ? res.urls : [];
	        const slots = raw.slice(0, 6).map((item) => {
	            if (typeof item === 'string') {
	                const url = String(item || '').trim();
	                return url ? { url, caption: '' } : null;
	            }
	            if (item && typeof item === 'object') {
	                const url = String(item.url || item.link || item.href || '').trim();
	                const caption = String(item.caption || item.title || '').trim();
	                return url ? { url, caption } : null;
	            }
	            return null;
	        }).filter(Boolean);
	        galleryState[seg] = slots;
	        gallerySlots[seg] = Math.max(3, slots.length);
	        syncGalleryHidden();
	        renderGallery();
	        if (res.source === 'fallback') {
	            setGalleryNote('–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ fallback-–Ω–∞–±—ñ—Ä (–±–µ–∑ –¥–∞–Ω–∏—Ö —Å–∞–π—Ç—É).');
	        } else {
            setGalleryNote('–ü–æ—Å—Ç–∞–≤–∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –Ω–∞–±—ñ—Ä –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞.');
        }
        schedulePreviewUpdate();
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (dupExists && confirmResend.value !== '1') {
            openConfirmModal();
            return;
        }
        sendOffer();
    });

    if (historyBody) historyBody.addEventListener('click', handleHistoryClick);

	    setActivePreview((mode && (mode.value || '').toUpperCase() === 'LIGHT') ? 'LIGHT' : 'VISUAL');
	    setPreviewSize('DESKTOP');
	    syncSubjectCustom();
	    syncCtaCustomUrl();
	    syncMessengerUI();
	    syncPricingUI();
	    galleryState.NEUTRAL = parseJsonGallery(galleryNeutral?.value);
	    galleryState.EDGY = parseJsonGallery(galleryEdgy?.value);
	    gallerySlots.NEUTRAL = Math.max(3, galleryState.NEUTRAL.length || 0);
	    gallerySlots.EDGY = Math.max(3, galleryState.EDGY.length || 0);
	    renderGallery();
	    renderVisualPreview(lastPreviewVisualHtml);
	    loadUnitDefaults().finally(() => syncUnitProfits());
	    schedulePreviewUpdate();
	    scheduleDuplicateCheck();
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initManagementCommercialOfferEmailPage);
} else {
    initManagementCommercialOfferEmailPage();
}
</script>
{% endblock %}
