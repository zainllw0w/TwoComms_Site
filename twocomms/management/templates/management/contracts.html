{% extends "management/base.html" %}
{% load static %}

{% block title %}Сформувати договір - TwoComms Management{% endblock %}

{% block extra_css %}
<style>
    .contracts-page {
        max-width: 1500px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .contracts-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        background: var(--panel-strong);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 18px 22px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }

    .contracts-header h2 {
        margin: 4px 0 0;
        letter-spacing: 0.04em;
    }

    .contracts-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .contract-layout {
        display: grid;
        grid-template-columns: minmax(320px, 0.9fr) minmax(360px, 1.1fr);
        gap: 18px;
        min-height: 0;
    }

    .contract-form-card,
    .contract-preview-card {
        background: var(--panel-strong);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 18px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
    }

    .contract-section {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px 16px 18px;
    }

    .contract-section h4 {
        margin: 0 0 12px;
        font-size: 1rem;
        letter-spacing: 0.04em;
    }

    .contract-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
    }

    .preview-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
    }

    .preview-title {
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        font-size: 0.82rem;
    }

    .preview-status {
        color: var(--muted);
        font-size: 0.85rem;
    }

    .preview-status.is-error {
        color: #fca5a5;
    }

    .preview-status.is-success {
        color: #86efac;
    }

    .preview-body {
        flex: 1 1 auto;
        min-height: 520px;
        background: rgba(7, 10, 16, 0.55);
        border-radius: 14px;
        padding: 16px;
        overflow: auto;
    }

    .preview-body .docx-wrapper {
        background: transparent;
        padding: 0;
    }

    .preview-body .docx {
        background: transparent;
    }

    .preview-body .docx-page {
        margin: 0 auto 18px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
        border-radius: 6px;
    }

    .contract-status {
        font-size: 0.85rem;
        color: var(--muted);
        min-height: 20px;
    }

    .contract-status.is-error {
        color: #fca5a5;
    }

    .contract-status.is-success {
        color: #86efac;
    }

    .contract-download {
        display: none;
    }

    .contract-download.is-visible {
        display: inline-flex;
    }

    .field input.is-readonly {
        opacity: 0.7;
        cursor: default;
    }

    @media (max-width: 1100px) {
        .contract-layout {
            grid-template-columns: 1fr;
        }
        .preview-body {
            min-height: 420px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="contracts-page">
    <div class="contracts-header">
        <div>
            <p class="eyebrow">Менеджмент</p>
            <h2>Сформувати договір</h2>
        </div>
        <div class="contracts-actions">
            <button type="button" class="btn-ghost" id="preview-refresh">Оновити прев’ю</button>
            <button type="button" class="btn-primary" id="contract-generate">Сформувати договір</button>
            <a class="btn-primary contract-download" id="contract-download" href="#" download>Завантажити</a>
        </div>
    </div>

    <div class="contract-layout">
        <form id="contract-form" class="contract-form-card">
            {% csrf_token %}
            <div class="contract-status" id="contract-status"></div>

            <div class="contract-section">
                <h4>Реквізити Реалізатора</h4>
                <div class="field-grid">
                    <div class="field field-span-2">
                        <label for="realizer-name">ПІБ / Назва ФОП</label>
                        <input id="realizer-name" name="realizer_name" type="text" placeholder="ФОП: ..." required>
                    </div>
                    <div class="field">
                        <label for="realizer-code">РНОКПП / ЄДРПОУ</label>
                        <input id="realizer-code" name="realizer_code" type="text" placeholder="2995319678" required>
                    </div>
                    <div class="field field-span-2">
                        <label for="realizer-address">Адреса реєстрації</label>
                        <input id="realizer-address" name="realizer_address" type="text" placeholder="м. ..." required>
                    </div>
                    <div class="field">
                        <label for="realizer-iban">IBAN</label>
                        <input id="realizer-iban" name="realizer_iban" type="text" placeholder="UA..." required>
                    </div>
                    <div class="field">
                        <label for="realizer-phone">Телефон</label>
                        <input id="realizer-phone" name="realizer_phone" type="text" placeholder="+380..." required>
                    </div>
                    <div class="field">
                        <label for="realizer-email">Email</label>
                        <input id="realizer-email" name="realizer_email" type="email" placeholder="email@example.com" required>
                    </div>
                </div>
            </div>

            <div class="contract-section">
                <h4>Доставка / Одержувач</h4>
                <div class="checkbox-field" style="margin-bottom: 10px;">
                    <label>
                        <input type="checkbox" id="recipient-same" checked>
                        Одержувач = Реалізатор
                    </label>
                </div>
                <div class="field-grid">
                    <div class="field field-span-2">
                        <label for="delivery-address">Адреса / відділення доставки</label>
                        <input id="delivery-address" name="delivery_address" type="text" placeholder="Нова Пошта, відділення..." required>
                    </div>
                    <div class="field">
                        <label for="recipient-name">ПІБ одержувача</label>
                        <input id="recipient-name" name="recipient_name" type="text" placeholder="Інна" required>
                    </div>
                    <div class="field">
                        <label for="recipient-phone">Телефон одержувача</label>
                        <input id="recipient-phone" name="recipient_phone" type="text" placeholder="+380..." required>
                    </div>
                </div>
            </div>

            <div class="contract-section">
                <h4>Товар і партія</h4>
                <div class="field-grid">
                    <div class="field">
                        <label for="product-type">Тип товару</label>
                        <select id="product-type" name="product_type" required>
                            <option value="hoodie">Худі</option>
                            <option value="tshirt">Футболка</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="product-select-hoodie">Позиція (худі)</label>
                        <select id="product-select-hoodie">
                            <option value="">Не вибрано</option>
                            {% for item in hoodie_products %}
                            <option value="{{ item.id }}" data-drop-price="{{ item.drop_price|default:0 }}" data-title="{{ item.title|escape }}">{{ item.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="field">
                        <label for="product-select-tshirt">Позиція (футболка)</label>
                        <select id="product-select-tshirt">
                            <option value="">Не вибрано</option>
                            {% for item in tshirt_products %}
                            <option value="{{ item.id }}" data-drop-price="{{ item.drop_price|default:0 }}" data-title="{{ item.title|escape }}">{{ item.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="field field-span-2">
                        <label for="product-print">Назва / принт</label>
                        <input id="product-print" name="product_print" type="text" placeholder="Мені поЖуй - це філософія" required>
                    </div>
                    <div class="field field-span-2">
                        <label for="product-title">Назва у таблиці (за потреби)</label>
                        <input id="product-title" name="product_title" type="text" placeholder="Худі \"...\"">
                        <div class="field-help">Заповнюється автоматично, можна змінити вручну.</div>
                    </div>
                    <div class="field">
                        <label for="product-price">Ціна дропа, грн</label>
                        <input id="product-price" name="product_price" type="text" class="is-readonly" readonly>
                    </div>
                </div>
                <div class="field-grid" style="margin-top: 12px;">
                    <div class="field">
                        <label for="qty-s">S (кількість)</label>
                        <input id="qty-s" type="number" min="0" value="1">
                    </div>
                    <div class="field">
                        <label for="qty-m">M (кількість)</label>
                        <input id="qty-m" type="number" min="0" value="1">
                    </div>
                    <div class="field">
                        <label for="qty-l">L (кількість)</label>
                        <input id="qty-l" type="number" min="0" value="1">
                    </div>
                    <div class="field">
                        <label for="qty-xl">XL (кількість)</label>
                        <input id="qty-xl" type="number" min="0" value="1">
                    </div>
                </div>
            </div>

            <div class="contract-section">
                <h4>Номер і дата договору</h4>
                <div class="contract-meta">
                    <div class="field">
                        <label for="contract-number">Номер</label>
                        <input id="contract-number" type="text" class="is-readonly" value="{{ next_contract_number }}" readonly>
                    </div>
                    <div class="field">
                        <label for="contract-date">Дата</label>
                        <input id="contract-date" type="text" class="is-readonly" value="{{ contract_date_display }}" readonly>
                    </div>
                </div>
            </div>
        </form>

        <div class="contract-preview-card">
            <div class="preview-toolbar">
                <div class="preview-title">Прев’ю договору</div>
                <div class="preview-status" id="preview-status">Очікуємо дані…</div>
            </div>
            <div class="preview-body" id="contract-preview">
                <div class="preview-status" style="padding: 12px;">Заповніть форму, щоб побачити прев’ю.</div>
            </div>
        </div>
    </div>
</div>

{{ prefill_payload|json_script:"contract-prefill" }}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/jszip.min.js' %}"></script>
<script src="{% static 'js/docx-preview.js' %}"></script>
<script>
    (() => {
        const form = document.getElementById('contract-form');
        const statusEl = document.getElementById('contract-status');
        const previewStatus = document.getElementById('preview-status');
        const previewRefresh = document.getElementById('preview-refresh');
        const previewEl = document.getElementById('contract-preview');
        const downloadBtn = document.getElementById('contract-download');
        const generateBtn = document.getElementById('contract-generate');
        const recipientSame = document.getElementById('recipient-same');
        const productType = document.getElementById('product-type');
        const hoodieSelect = document.getElementById('product-select-hoodie');
        const tshirtSelect = document.getElementById('product-select-tshirt');
        const productPrint = document.getElementById('product-print');
        const productTitle = document.getElementById('product-title');
        const productPrice = document.getElementById('product-price');
        const contractNumberField = document.getElementById('contract-number');
        const qtyFields = {
            S: document.getElementById('qty-s'),
            M: document.getElementById('qty-m'),
            L: document.getElementById('qty-l'),
            XL: document.getElementById('qty-xl'),
        };
        const prefill = JSON.parse(document.getElementById('contract-prefill').textContent || '{}');

        const dropHoodiePrice = {{ drop_hoodie_price|default:1350 }};
        const dropTeePrice = {{ drop_tee_price|default:570 }};
        let previewTimeout = null;
        let previewAbort = null;

        const formatPrice = (value) => parseInt(value || 0, 10);

        const getSelectedProduct = () => {
            const type = productType.value;
            const select = type === 'hoodie' ? hoodieSelect : tshirtSelect;
            if (!select || !select.value) return null;
            const option = select.options[select.selectedIndex];
            if (!option) return null;
            return {
                id: option.value,
                title: option.dataset.title || option.textContent,
                dropPrice: parseInt(option.dataset.dropPrice || '0', 10),
            };
        };

        const getProductTypeForms = () => {
            const type = productType.value;
            if (type === 'hoodie') {
                return { title: 'Худі' };
            }
            return { title: 'Футболка' };
        };

        const computePrice = () => {
            const selected = getSelectedProduct();
            if (selected && selected.dropPrice) {
                return selected.dropPrice;
            }
            return productType.value === 'hoodie' ? dropHoodiePrice : dropTeePrice;
        };

        const buildPayload = () => {
            const selected = getSelectedProduct();
            const price = computePrice();
            const quantities = {};
            ['S', 'M', 'L', 'XL'].forEach((size) => {
                const field = qtyFields[size];
                let qty = parseInt(field?.value || '0', 10);
                if (Number.isNaN(qty) || qty < 0) qty = 0;
                quantities[size] = qty;
            });
            const title = productTitle.value.trim() || selected?.title || `${getProductTypeForms().title} "${productPrint.value.trim()}"`;
            return {
                realizer_name: document.getElementById('realizer-name').value.trim(),
                realizer_code: document.getElementById('realizer-code').value.trim(),
                realizer_address: document.getElementById('realizer-address').value.trim(),
                realizer_iban: document.getElementById('realizer-iban').value.trim(),
                realizer_phone: document.getElementById('realizer-phone').value.trim(),
                realizer_email: document.getElementById('realizer-email').value.trim(),
                delivery_address: document.getElementById('delivery-address').value.trim(),
                recipient_name: document.getElementById('recipient-name').value.trim(),
                recipient_phone: document.getElementById('recipient-phone').value.trim(),
                product_type: productType.value,
                product_id: selected?.id || '',
                product_print: productPrint.value.trim(),
                product_title: title,
                quantities,
            };
        };

        const getMissingFields = (payload) => {
            const required = [
                ['realizer_name', 'ПІБ / Назва ФОП'],
                ['realizer_code', 'РНОКПП / ЄДРПОУ'],
                ['realizer_address', 'Адреса'],
                ['realizer_iban', 'IBAN'],
                ['realizer_phone', 'Телефон'],
                ['realizer_email', 'Email'],
                ['delivery_address', 'Адреса доставки'],
                ['recipient_name', 'ПІБ одержувача'],
                ['recipient_phone', 'Телефон одержувача'],
                ['product_print', 'Назва / принт'],
            ];
            return required.filter(([key]) => !payload[key]).map(([, label]) => label);
        };

        const syncRecipient = () => {
            const realizerName = document.getElementById('realizer-name').value.trim();
            const realizerPhone = document.getElementById('realizer-phone').value.trim();
            const recipientName = document.getElementById('recipient-name');
            const recipientPhone = document.getElementById('recipient-phone');
            if (recipientSame.checked) {
                recipientName.value = realizerName;
                recipientPhone.value = realizerPhone;
                recipientName.setAttribute('disabled', 'disabled');
                recipientPhone.setAttribute('disabled', 'disabled');
            } else {
                recipientName.removeAttribute('disabled');
                recipientPhone.removeAttribute('disabled');
            }
        };

        const toggleProductSelect = () => {
            const type = productType.value;
            hoodieSelect.parentElement.style.display = type === 'hoodie' ? 'block' : 'none';
            tshirtSelect.parentElement.style.display = type === 'tshirt' ? 'block' : 'none';
        };

        const setStatus = (text, mode) => {
            statusEl.textContent = text || '';
            statusEl.classList.remove('is-error', 'is-success');
            if (mode) statusEl.classList.add(mode);
        };

        const setPreviewStatus = (text, mode) => {
            previewStatus.textContent = text || '';
            previewStatus.classList.remove('is-error', 'is-success');
            if (mode) previewStatus.classList.add(mode);
        };

        const renderDocxBuffer = async (buffer) => {
            previewEl.innerHTML = '';
            await window.docx.renderAsync(buffer, previewEl, null, {
                className: 'docx',
                inWrapper: true,
                ignoreWidth: false,
                ignoreHeight: false,
            });
        };

        const setDownload = (link, label) => {
            if (!link) {
                downloadBtn.classList.remove('is-visible');
                downloadBtn.href = '#';
                downloadBtn.textContent = 'Завантажити';
                return;
            }
            downloadBtn.classList.add('is-visible');
            downloadBtn.href = link;
            downloadBtn.textContent = label || 'Завантажити';
        };

        const updateDerived = () => {
            productPrice.value = formatPrice(computePrice());
        };

        const applyPrefill = () => {
            if (!prefill || !Object.keys(prefill).length) return;
            const map = {
                realizer_name: 'realizer-name',
                realizer_code: 'realizer-code',
                realizer_address: 'realizer-address',
                realizer_iban: 'realizer-iban',
                realizer_phone: 'realizer-phone',
                realizer_email: 'realizer-email',
                delivery_address: 'delivery-address',
                recipient_name: 'recipient-name',
                recipient_phone: 'recipient-phone',
                product_type: 'product-type',
                product_print: 'product-print',
                product_title: 'product-title',
            };
            Object.entries(map).forEach(([key, id]) => {
                if (prefill[key]) {
                    const el = document.getElementById(id);
                    if (el) el.value = prefill[key];
                }
            });
            if (prefill.product_type && prefill.product_id) {
                if (prefill.product_type === 'hoodie') {
                    hoodieSelect.value = String(prefill.product_id);
                } else if (prefill.product_type === 'tshirt') {
                    tshirtSelect.value = String(prefill.product_id);
                }
            }
            if (prefill.quantities) {
                Object.keys(qtyFields).forEach((size) => {
                    if (prefill.quantities[size] != null) {
                        qtyFields[size].value = prefill.quantities[size];
                    }
                });
            }
            if (prefill.recipient_name && prefill.realizer_name && prefill.recipient_name !== prefill.realizer_name) {
                recipientSame.checked = false;
            }
            if (prefill.recipient_phone && prefill.realizer_phone && prefill.recipient_phone !== prefill.realizer_phone) {
                recipientSame.checked = false;
            }
        };

        const schedulePreview = () => {
            if (previewTimeout) {
                clearTimeout(previewTimeout);
            }
            previewTimeout = setTimeout(loadPreview, 600);
        };

        const renderGeneratedDoc = async (downloadUrl, contractNumber) => {
            if (!downloadUrl) return;
            if (previewAbort) {
                previewAbort.abort();
                previewAbort = null;
            }
            const numberLabel = contractNumber ? ` № ${contractNumber}` : '';
            setPreviewStatus(`Завантажуємо готовий договір${numberLabel}...`, '');
            try {
                const response = await fetch(downloadUrl, { credentials: 'same-origin' });
                if (!response.ok) {
                    throw new Error('Не вдалося завантажити готовий договір.');
                }
                const buffer = await response.arrayBuffer();
                await renderDocxBuffer(buffer);
                setPreviewStatus(`Готовий договір${numberLabel}`, 'is-success');
            } catch (err) {
                previewEl.innerHTML = '<div class="preview-status">Помилка прев’ю.</div>';
                setPreviewStatus(err.message || 'Помилка прев’ю', 'is-error');
            }
        };

        const loadPreview = async () => {
            const payload = buildPayload();
            const missing = getMissingFields(payload);
            if (missing.length) {
                previewEl.innerHTML = '<div class="preview-status">Заповніть форму, щоб побачити прев’ю.</div>';
                setPreviewStatus(`Не заповнено: ${missing.join(', ')}`, 'is-error');
                return;
            }
            if (previewAbort) {
                previewAbort.abort();
            }
            previewAbort = new AbortController();
            setPreviewStatus('Оновлюємо прев’ю...', '');
            try {
                const csrfToken = form.querySelector('input[name=csrfmiddlewaretoken]').value;
                const response = await fetch('{% url "management_contracts_preview_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    signal: previewAbort.signal,
                    body: JSON.stringify(payload),
                });
                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    const msg = data.fields ? `Заповніть: ${data.fields.join(', ')}` : 'Не вдалося згенерувати прев’ю.';
                    throw new Error(msg);
                }
                const nextNumber = response.headers.get('X-Contract-Number');
                if (nextNumber) {
                    contractNumberField.value = nextNumber;
                }
                const buffer = await response.arrayBuffer();
                await renderDocxBuffer(buffer);
                setPreviewStatus('Прев’ю оновлено', 'is-success');
            } catch (err) {
                if (err.name === 'AbortError') return;
                previewEl.innerHTML = '<div class="preview-status">Помилка прев’ю.</div>';
                setPreviewStatus(err.message || 'Помилка прев’ю', 'is-error');
            }
        };

        const bindEvents = () => {
            previewRefresh.addEventListener('click', loadPreview);
            recipientSame.addEventListener('change', () => {
                syncRecipient();
                schedulePreview();
            });
            productType.addEventListener('change', () => {
                toggleProductSelect();
                updateDerived();
                schedulePreview();
            });
            hoodieSelect.addEventListener('change', () => {
                const selected = getSelectedProduct();
                if (selected?.title) {
                    productTitle.value = selected.title;
                }
                updateDerived();
                schedulePreview();
            });
            tshirtSelect.addEventListener('change', () => {
                const selected = getSelectedProduct();
                if (selected?.title) {
                    productTitle.value = selected.title;
                }
                updateDerived();
                schedulePreview();
            });

            form.querySelectorAll('input, select, textarea').forEach((input) => {
                input.addEventListener('input', () => {
                    if (recipientSame.checked && (input.id === 'realizer-name' || input.id === 'realizer-phone')) {
                        syncRecipient();
                    }
                    updateDerived();
                    schedulePreview();
                });
            });

            generateBtn.addEventListener('click', async () => {
                setStatus('Формуємо договір...', '');
                setDownload('');
                generateBtn.disabled = true;

                const payload = buildPayload();
                const csrfToken = form.querySelector('input[name=csrfmiddlewaretoken]').value;

                try {
                    const response = await fetch('{% url "management_contracts_generate_api" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify(payload),
                    });
                    const data = await response.json();
                    if (!response.ok || !data.ok) {
                        const msg = data.fields ? `Заповніть: ${data.fields.join(', ')}` : 'Не вдалося сформувати договір.';
                        throw new Error(msg);
                    }
                    setStatus(`Готово. Договір № ${data.contract.contract_number}`, 'is-success');
                    setDownload(data.contract.download_url, `Завантажити № ${data.contract.contract_number}`);
                    contractNumberField.value = data.contract.contract_number;
                    await renderGeneratedDoc(data.contract.download_url, data.contract.contract_number);
                } catch (err) {
                    setStatus(err.message || 'Помилка генерації.', 'is-error');
                } finally {
                    generateBtn.disabled = false;
                }
            });
        };

        applyPrefill();
        toggleProductSelect();
        syncRecipient();
        updateDerived();
        bindEvents();
        schedulePreview();
    })();
</script>
{% endblock %}
