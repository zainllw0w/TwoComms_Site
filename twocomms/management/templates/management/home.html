{% extends "management/base.html" %}

{% block content %}
<div class="clients-panel">
    <div class="panel-header">
        <div>
            <p class="eyebrow">Активні контакти</p>
            <h2>Панель керування клієнтами</h2>
        </div>
        <div class="panel-actions">
            <div class="report-hint">
                <div class="report-title">Звіт о 19:00 (пн–пт)</div>
                <div class="report-countdown" id="report-countdown">--:--:--</div>
            </div>
            <form id="report-form" method="post" action="{% url 'management_send_report' %}">
                {% csrf_token %}
                <button
                    class="btn-primary"
                    id="report-submit"
                    type="submit"
                    data-sent="{{ has_report_today|yesno:'true,false' }}"
                    data-progress-points="{{ progress_points_pct|default:0 }}"
                    data-progress-clients="{{ progress_clients_pct|default:0 }}">
                    {% if has_report_today %}Відправити ще раз{% else %}Відправити звіт{% endif %}
                </button>
            </form>
            <button class="btn-primary open-add-client">+ Додати клієнта</button>
        </div>
    </div>

    {% if grouped_clients %}
        {% for label, items in grouped_clients %}
        <div class="date-group">
            <div class="date-chip">{{ label }}</div>
            <div class="table-shell">
                <table class="nexus-table">
                    <thead>
                        <tr>
                            <th>Магазин/Insta</th>
                            <th>Телефон</th>
                            <th>ПІБ</th>
                            <th>Статус</th>
                            <th>Джерело</th>
                            <th>Результат</th>
                            <th>Наступний дзвінок</th>
                            <th class="col-actions">Дія</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for client in items %}
                        <tr data-client-id="{{ client.id }}"
                            data-shop="{{ client.shop_name|escape }}"
                            data-phone="{{ client.phone|escape }}"
                            data-full-name="{{ client.full_name|escape }}"
                            data-role="{{ client.role }}"
                            data-source="{{ client.source|escape }}"
                            data-call-result="{{ client.call_result }}"
                            data-call-details="{{ client.call_result_details|escape }}"
                            data-next-call-date="{{ client.next_call_at|date:'Y-m-d' }}"
                            data-next-call-time="{{ client.next_call_at|date:'H:i' }}">
                            <td>{{ client.shop_name }}</td>
                            <td>{{ client.phone }}</td>
                            <td>{{ client.full_name }}</td>
                            <td><span class="status-badge role-{{ client.role }}">{{ client.get_role_display }}</span></td>
                            <td>{{ client.source }}</td>
                            <td>
                                <span class="result-badge result-{{ client.call_result }}">{{ client.get_call_result_display }}</span>
                                {% if client.call_result_details %}<span class="muted-detail">• {{ client.call_result_details }}</span>{% endif %}
                            </td>
                            <td>
                                {% if client.next_call_at %}
                                    {{ client.next_call_at|date:"d.m.Y H:i" }}
                                {% else %}
                                    –
                                {% endif %}
                            </td>
                            <td class="actions-cell">
                                <button type="button" class="icon-btn edit-client" aria-label="Редагувати">
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M4 17.25V20h2.75L17.81 8.94l-2.75-2.75L4 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 2.75 2.75 1.83-1.83z"/>
                                    </svg>
                                </button>
                                <form method="post" action="{% url 'management_delete_client' client.id %}" class="inline-form delete-client-form">
                                    {% csrf_token %}
                                    <button type="submit" class="icon-btn ghost danger" aria-label="Видалити" onclick="return confirm('Видалити клієнта?');">
                                        <svg viewBox="0 0 24 24" aria-hidden="true">
                                            <path d="M6 7h12l-1 14H7L6 7zm5-3h2l1 1h5v2H5V5h5l1-1z"/>
                                        </svg>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="table-empty">Немає даних. Додайте першого клієнта.</div>
    {% endif %}
</div>

<!-- Modal: Add Client -->
<div id="client-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div>
                <p class="eyebrow">Новий контакт</p>
                <h3>Додати клієнта</h3>
            </div>
            <button type="button" class="modal-close" aria-label="Закрити">×</button>
        </div>
        <form id="client-form" method="post" class="modal-body">
            {% csrf_token %}
            <div class="field-grid">
                <input type="hidden" name="client_id" id="client_id" value="">
                <div class="field">
                    <label for="shop_name">Магазин / Instagram</label>
                    <input type="text" id="shop_name" name="shop_name" placeholder="@shop або назва" required>
                </div>
                <div class="field">
                    <label for="phone">Номер телефону</label>
                    <input type="tel" id="phone" name="phone" placeholder="+380..." required>
                </div>
                <div class="field">
                    <label for="full_name">ПІБ (необовʼязково)</label>
                    <input type="text" id="full_name" name="full_name" placeholder="ПІБ (необовʼязково)">
                </div>
                <div class="field">
                    <label for="role">Статус людини</label>
                    <select id="role" name="role">
                        <option value="owner">Власник</option>
                        <option value="supervisor">Управляючий</option>
                        <option value="manager">Менеджер</option>
                        <option value="realizer">Реалізатор</option>
                        <option value="other">Інше</option>
                    </select>
                    <input type="text" id="role_custom" name="role_custom" class="field-conditional" placeholder="Кого саме?" />
                </div>
                <div class="field">
                    <label for="source">Де взяли контакт</label>
                    <select id="source" name="source">
                        <option value="instagram">Instagram</option>
                        <option value="prom_ua">Prom.ua</option>
                        <option value="google_maps">Google Карти</option>
                        <option value="forums">Сайти / форуми</option>
                        <option value="other">Інше</option>
                    </select>
                    <input type="url" id="source_link" name="source_link" class="field-conditional" placeholder="Вкажіть лінк" />
                    <input type="text" id="source_other" name="source_other" class="field-conditional" placeholder="Що саме?" />
                </div>
                <div class="field">
                    <label for="call_result">Підсумок розмови</label>
                    <select id="call_result" name="call_result">
                        <option value="order">Оформив замовлення</option>
                        <option value="sent_email">Відправили КП на e-mail</option>
                        <option value="sent_messenger">Відправили КП у месенджери</option>
                        <option value="wrote_ig">Написали в Instagram</option>
                        <option value="no_answer">Не відповідає</option>
                        <option value="not_interested">Не цікавить</option>
                        <option value="invalid_number">Номер недоступний</option>
                        <option value="xml_connected">Підключив XML</option>
                        <option value="thinking">Подумає</option>
                        <option value="expensive">Дорого</option>
                        <option value="waiting_payment">Очікується оплата</option>
                        <option value="waiting_prepayment">Очікується передоплата</option>
                        <option value="test_batch">Замовив тестову партію</option>
                        <option value="other">Інше</option>
                    </select>
                    <textarea id="call_result_other" name="call_result_other" class="field-conditional" placeholder="Що саме інше?"></textarea>
                </div>
                <div class="field field-span-2">
                    <label>Наступний дзвінок</label>
                    <div class="next-call-options">
                        <label class="pill-radio">
                            <input type="radio" name="next_call_type" value="scheduled" checked>
                            <span>Дата та час</span>
                        </label>
                        <label class="pill-radio">
                            <input type="radio" name="next_call_type" value="no_follow">
                            <span>Неконверcійний клієнт</span>
                        </label>
                    </div>
                    <div class="next-call-datetime" id="next_call_datetime">
                        <input type="date" id="next_call_date" name="next_call_date">
                        <input type="time" id="next_call_time" name="next_call_time">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-ghost modal-close">Відмінити</button>
                <button type="submit" class="btn-primary">Зберегти</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('client-modal');
    const body = document.body;
    const openButtons = document.querySelectorAll('.open-add-client');
    const closeButtons = modal.querySelectorAll('.modal-close');
    const roleSelect = document.getElementById('role');
    const roleCustom = document.getElementById('role_custom');
    const sourceSelect = document.getElementById('source');
    const sourceLink = document.getElementById('source_link');
    const sourceOther = document.getElementById('source_other');
    const callResultSelect = document.getElementById('call_result');
    const callResultOther = document.getElementById('call_result_other');
    const nextCallRadios = document.querySelectorAll('input[name="next_call_type"]');
    const nextCallWrap = document.getElementById('next_call_datetime');
    const nextCallDate = document.getElementById('next_call_date');
    const nextCallTime = document.getElementById('next_call_time');
    const clientIdInput = document.getElementById('client_id');
    const shopNameInput = document.getElementById('shop_name');
    const phoneInput = document.getElementById('phone');
    const fullNameInput = document.getElementById('full_name');
    const modalTitle = document.querySelector('.modal-header h3');
    const modalSubmit = modal.querySelector('.modal-footer .btn-primary');
    const editButtons = document.querySelectorAll('.edit-client');
    const reportCountdown = document.getElementById('report-countdown');
    const reportSubmit = document.getElementById('report-submit');
    const reportForm = document.getElementById('report-form');

    const setDefaultDateTime = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        const dateIso = now.toISOString().slice(0, 10);
        const timeIso = now.toTimeString().slice(0, 5);
        nextCallDate.value = dateIso;
        nextCallTime.value = timeIso;
    };
    setDefaultDateTime();

    const openModal = () => {
        modal.classList.add('show');
        body.classList.add('modal-open');
    };

    const closeModal = () => {
        modal.classList.remove('show');
        body.classList.remove('modal-open');
    };

    closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    const toggleRole = () => {
        const show = roleSelect.value === 'other';
        roleCustom.style.display = show ? 'block' : 'none';
        if (!show) roleCustom.value = '';
    };

    const toggleSource = () => {
        sourceLink.style.display = sourceSelect.value === 'forums' ? 'block' : 'none';
        sourceOther.style.display = sourceSelect.value === 'other' ? 'block' : 'none';
        if (sourceSelect.value !== 'forums') sourceLink.value = '';
        if (sourceSelect.value !== 'other') sourceOther.value = '';
    };

    const toggleCallResult = () => {
        const show = callResultSelect.value === 'other';
        callResultOther.style.display = show ? 'block' : 'none';
        if (!show) callResultOther.value = '';
    };

    const toggleNextCall = () => {
        const selected = document.querySelector('input[name="next_call_type"]:checked');
        const show = selected && selected.value === 'scheduled';
        nextCallWrap.style.display = show ? 'flex' : 'none';
        if (!show) {
            nextCallDate.value = '';
            nextCallTime.value = '';
        } else if (!nextCallDate.value || !nextCallTime.value) {
            setDefaultDateTime();
        }
    };

    const resetForm = () => {
        document.getElementById('client-form').reset();
        clientIdInput.value = '';
        setDefaultDateTime();
        document.querySelector('input[name="next_call_type"][value="scheduled"]').checked = true;
        toggleRole();
        toggleSource();
        toggleCallResult();
        toggleNextCall();
    };

    const mapSourceValue = (sourceText) => {
        const text = (sourceText || '').toLowerCase();
        if (text.includes('instagram')) return { val: 'instagram', link: '', other: '' };
        if (text.includes('prom')) return { val: 'prom_ua', link: '', other: '' };
        if (text.includes('google')) return { val: 'google_maps', link: '', other: '' };
        if (text.includes('сайти') || text.includes('форум')) {
            const parts = sourceText.split(':');
            return { val: 'forums', link: parts.slice(1).join(':').trim(), other: '' };
        }
        return { val: 'other', link: '', other: sourceText };
    };

    const fillFormForEdit = (row) => {
        const cid = row.dataset.clientId || '';
        clientIdInput.value = cid;
        shopNameInput.value = row.dataset.shop || '';
        phoneInput.value = row.dataset.phone || '';
        fullNameInput.value = row.dataset.fullName || '';
        roleSelect.value = row.dataset.role || 'manager';
        roleCustom.value = roleSelect.value === 'other' ? (row.dataset.callDetails || '').replace('Роль: ', '') : '';

        const mapped = mapSourceValue(row.dataset.source || '');
        sourceSelect.value = mapped.val;
        sourceLink.value = mapped.link;
        sourceOther.value = mapped.other;

        callResultSelect.value = row.dataset.callResult || 'thinking';
        callResultOther.value = callResultSelect.value === 'other'
            ? (row.dataset.callDetails || '').replace('Інше: ', '').trim()
            : '';

        if (row.dataset.nextCallDate && row.dataset.nextCallTime) {
            document.querySelector('input[name="next_call_type"][value="scheduled"]').checked = true;
            nextCallDate.value = row.dataset.nextCallDate;
            nextCallTime.value = row.dataset.nextCallTime;
        } else {
            document.querySelector('input[name="next_call_type"][value="no_follow"]').checked = true;
            nextCallDate.value = '';
            nextCallTime.value = '';
        }

        modalTitle.textContent = 'Редагувати клієнта';
        modalSubmit.textContent = 'Оновити';

        toggleRole();
        toggleSource();
        toggleCallResult();
        toggleNextCall();
    };

    const openCreate = () => {
        resetForm();
        modalTitle.textContent = 'Додати клієнта';
        modalSubmit.textContent = 'Зберегти';
        openModal();
    };

    openButtons.forEach(btn => btn.addEventListener('click', openCreate));
    editButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const row = e.currentTarget.closest('tr');
            if (!row) return;
            fillFormForEdit(row);
            openModal();
        });
    });

    roleSelect.addEventListener('change', toggleRole);
    sourceSelect.addEventListener('change', toggleSource);
    callResultSelect.addEventListener('change', toggleCallResult);
    nextCallRadios.forEach(r => r.addEventListener('change', toggleNextCall));

    toggleRole();
    toggleSource();
    toggleCallResult();
    toggleNextCall();

    // Apply initial arc progress
    const arcFill = document.getElementById('gauge-arc-fill');
    if (arcFill) {
        const arcLen = 251.3;
        const init = parseFloat(arcFill.dataset.progress || '0');
        arcFill.style.strokeDashoffset = arcLen * (1 - init / 100);
    }

    // AJAX submit to update stats instantly
    const clientForm = document.getElementById('client-form');
    clientForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(clientForm);
        try {
            const res = await fetch("", {
                method: "POST",
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'},
            });
            const data = await res.json();
            if (!data.success) {
                clientForm.submit();
                return;
            }
            // Update gauges
            const pointsValEl = document.getElementById('gauge-points-value');
            const arcFill = document.getElementById('gauge-arc-fill');
            const pointsLegend = document.getElementById('points-legend');
            const clientsBar = document.getElementById('clients-bar');
            const clientsLegend = document.getElementById('clients-legend');
            if (pointsValEl) pointsValEl.textContent = data.user_points_today;
            if (arcFill) {
                const arcLen = 251.3;
                arcFill.style.strokeDashoffset = arcLen * (1 - data.progress_points_pct / 100);
            }
            if (pointsLegend) pointsLegend.textContent = `Бали за сьогодні: ${data.user_points_today} / ${data.target_points}`;
            if (clientsBar) clientsBar.style.width = `${data.progress_clients_pct}%`;
            if (clientsLegend) clientsLegend.textContent = `Оброблено: ${data.processed_today} / ${data.target_clients}`;

            // Insert row into "Сьогодні" group if available
            if (data.latest) {
                const todayChip = Array.from(document.querySelectorAll('.date-chip')).find(chip => chip.textContent.trim() === 'Сьогодні');
                if (todayChip) {
                    const table = todayChip.parentElement.querySelector('table');
                    const tbody = table ? table.querySelector('tbody') : null;
                    if (tbody) {
                        const tr = document.createElement('tr');
                        tr.dataset.clientId = data.latest.id;
                        tr.dataset.shop = data.latest.shop;
                        tr.dataset.phone = data.latest.phone;
                        tr.dataset.fullName = data.latest.full_name;
                        tr.dataset.role = data.latest.role;
                        tr.dataset.source = data.latest.source;
                        tr.dataset.callResult = data.latest.call_result;
                        tr.dataset.callDetails = data.latest.call_result_details || '';
                        tr.dataset.nextCallDate = '';
                        tr.dataset.nextCallTime = '';
                        tr.innerHTML = `
                            <td>${data.latest.shop}</td>
                            <td>${data.latest.phone}</td>
                            <td>${data.latest.full_name}</td>
                            <td><span class="status-badge role-${data.latest.role}">${data.latest.role_display}</span></td>
                            <td>${data.latest.source}</td>
                            <td><span class="result-badge result-${data.latest.call_result}">${data.latest.call_result_display}</span>${data.latest.call_result_details ? '<span class="muted-detail">• '+data.latest.call_result_details+'</span>' : ''}</td>
                            <td>${data.latest.next_call}</td>
                            <td class="actions-cell">
                                <button type="button" class="icon-btn edit-client" aria-label="Редагувати">
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M4 17.25V20h2.75L17.81 8.94l-2.75-2.75L4 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 2.75 2.75 1.83-1.83z"/>
                                    </svg>
                                </button>
                                <form method="post" action="/clients/${data.latest.id}/delete/" class="inline-form delete-client-form">
                                    <input type="hidden" name="csrfmiddlewaretoken" value="${formData.get('csrfmiddlewaretoken') || ''}">
                                    <button type="submit" class="icon-btn ghost danger" aria-label="Видалити" onclick="return confirm('Видалити клієнта?');">
                                        <svg viewBox="0 0 24 24" aria-hidden="true">
                                            <path d="M6 7h12l-1 14H7L6 7zm5-3h2l1 1h5v2H5V5h5l1-1z"/>
                                        </svg>
                                    </button>
                                </form>
                            </td>`;
                        tbody.prepend(tr);
                    }
                }
            }
            closeModal();
        } catch (err) {
            clientForm.submit();
        }
    });

    // Countdown to next weekday 19:00
    const updateCountdown = () => {
        if (!reportCountdown) return;
        const now = new Date();
        let target = new Date(now);
        target.setHours(19, 0, 0, 0);

        const baseLabel = (reportSubmit && reportSubmit.dataset.sent === 'true')
            ? 'Відправити ще раз'
            : 'Відправити звіт';

        const day = target.getDay(); // 0 Sun, 6 Sat
        const isWeekend = day === 0 || day === 6;
        const passedToday = now > target;

        // У будній день після 19:00 показуємо нагадування до 00:00, не перезапускаючи таймер
        if (!isWeekend && passedToday) {
            reportCountdown.textContent = 'Треба відправити звіт';
            reportCountdown.style.color = '#ff7e29';
            if (reportSubmit) reportSubmit.textContent = baseLabel;
            return;
        }

        if (isWeekend || passedToday) {
            let offset = 1;
            while (true) {
                const candidate = new Date(target);
                candidate.setDate(target.getDate() + offset);
                const d = candidate.getDay();
                if (d !== 0 && d !== 6) {
                    target = candidate;
                    target.setHours(19, 0, 0, 0);
                    break;
                }
                offset += 1;
            }
        }

        const diffMs = target - now;
        if (diffMs <= 0) {
            reportCountdown.textContent = 'Час подати звіт';
            reportCountdown.style.color = '#ff7e29';
            if (reportSubmit) reportSubmit.textContent = baseLabel;
            return;
        }
        const totalSec = Math.floor(diffMs / 1000);
        const hours = String(Math.floor(totalSec / 3600)).padStart(2, '0');
        const minutes = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
        const seconds = String(totalSec % 60).padStart(2, '0');
        reportCountdown.textContent = `Залишилось ${hours}:${minutes}:${seconds}`;
        reportCountdown.style.color = totalSec < 3600 ? '#ff7e29' : '#ffb347';
        if (reportSubmit) reportSubmit.textContent = baseLabel;
    };

    updateCountdown();
    setInterval(updateCountdown, 1000);

    // Confirmation before sending report if норма не виконана
    if (reportForm && reportSubmit) {
        reportForm.addEventListener('submit', (e) => {
            const pts = parseInt(reportSubmit.dataset.progressPoints || '0', 10);
            const cls = parseInt(reportSubmit.dataset.progressClients || '0', 10);
            if (pts < 100 || cls < 100) {
                const ok = confirm('Денна норма не заповнена (бали або клієнти). Відправити звіт зараз?');
                if (!ok) {
                    e.preventDefault();
                }
            }
        });
    }
});
</script>
{% endblock %}
