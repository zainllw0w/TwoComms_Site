{% extends 'management/base.html' %}

{% block content %}
<!-- Tab: Main (–ì–æ–ª–æ–≤–Ω–∞) -->
<div id="tab-main" class="tab-content active animate-fade-in">

    <!-- Daily Points Gauge (Semi-circle) -->
    <div class="row align-items-center mb-4">
        <div class="col-auto">
            <div class="gauge-wrapper">
                <div class="gauge-semicircle">
                    <div class="gauge-fill" style="transform: rotate(153deg);"></div> <!-- 85% -->
                    <div class="gauge-cover">
                        <div class="gauge-value">85</div>
                        <div class="gauge-label">–±–∞–ª–ª–æ–≤</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <h1 class="page-title-large">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {{ user.first_name|default:user.username }}!</h1>
            <p class="text-secondary">–°–µ–≥–æ–¥–Ω—è –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥–∞–∂.</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary glow-effect" onclick="openModal()">
                <span style="margin-right: 8px; font-size: 1.2em;">+</span> –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
            </button>
        </div>
    </div>

    <!-- Client Processing List (Grouped by Date) -->
    <div class="glass-panel">
        <div class="panel-header">
            <h2 class="panel-title">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
        </div>

        <div class="table-container">
            {% regroup clients by created_at|date:"d.m.Y" as date_list %}

            <table class="custom-table">
                <thead>
                    <tr>
                        <th>–ú–∞–≥–∞–∑–∏–Ω / –ò–Ω—Å—Ç–∞–≥—Ä–∞–º</th>
                        <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                        <th>–ò—Ç–æ–≥</th>
                        <th>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</th>
                    </tr>
                </thead>
                <tbody>
                    {% for date in date_list %}
                    <!-- Date Header Row -->
                    <tr class="date-header-row">
                        <td colspan="6">
                            <span class="date-badge">üìÖ {{ date.grouper }}</span>
                        </td>
                    </tr>

                    {% for client in date.list %}
                    <tr class="client-row animate-slide-up"
                        style="animation-delay: {{ forloop.counter0|add:forloop.parentloop.counter0|add:1 }}00ms;">
                        <td>
                            <div class="shop-name">{{ client.shop_name }}</div>
                        </td>
                        <td>
                            <div class="client-name">{{ client.full_name }}</div>
                            <div class="client-phone">{{ client.phone }}</div>
                            <span class="badge badge-gray mt-1">{{ client.get_contact_role_display }}</span>
                        </td>
                        <td>
                            <span class="badge badge-warning">–ù–æ–≤—ã–π</span>
                        </td>
                        <td>{{ client.source }}</td>
                        <td>
                            {% if client.last_call_result %}
                            <div class="call-result" title="{{ client.get_last_call_result_display }}">
                                {{ client.get_last_call_result_display }}
                            </div>
                            {% if client.last_call_result == 'other' and client.last_call_result_text %}
                            <div class="text-secondary small">{{ client.last_call_result_text }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if client.is_non_conversion %}
                            <span class="badge badge-danger">–û—Ç–∫–∞–∑</span>
                            {% elif client.next_call_at %}
                            <div class="next-call-date">
                                {{ client.next_call_at|date:"d.m H:i" }}
                            </div>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% empty %}
                    <tr>
                        <td colspan="6" class="empty-state">
                            –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞".
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Placeholder for other tabs -->
<div id="tab-stats" class="tab-content">
    <div class="glass-panel">
        <div class="panel-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <p class="text-secondary mt-2">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
    </div>
</div>

<div id="tab-reports" class="tab-content">
    <div class="glass-panel">
        <div class="panel-title">–û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å</div>
        <p class="text-secondary mt-2">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
    </div>
</div>

<div id="tab-settings" class="tab-content">
    <div class="glass-panel">
        <div class="panel-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <p class="text-secondary mt-2">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
    </div>
</div>

<!-- ADD CLIENT MODAL -->
<div id="addClientModal" class="modal-overlay">
    <div class="modal-content animate-scale-in">
        <div class="modal-header">
            <h3 class="modal-title">–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>

        <form id="addClientForm" method="post" action="{% url 'management:client_create' %}" class="ajax-form">
            {% csrf_token %}

            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ / Instagram</label>
                <input type="text" name="shop_name" class="form-input" required placeholder="@example_shop">
            </div>

            <div class="form-row">
                <div class="form-group col-half">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" name="phone" class="form-input" required placeholder="+380...">
                </div>
                <div class="form-group col-half">
                    <label class="form-label">–ü–Ü–ë –ö–æ–Ω—Ç–∞–∫—Ç–∞</label>
                    <input type="text" name="full_name" class="form-input" required placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">–†–æ–ª—å –∫–æ–Ω—Ç–∞–∫—Ç–∞</label>
                <select name="contact_role" class="form-input">
                    <option value="owner">–í–ª–∞–¥–µ–ª–µ—Ü (–£–ø—Ä–∞–≤–ª—è—é—â–∏–π)</option>
                    <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                    <option value="realizer">–†–µ–∞–ª–∏–∑–∞—Ç–æ—Ä</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                <input type="text" name="source" class="form-input" placeholder="–û—Ç–∫—É–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç?">
            </div>

            <div class="separator"></div>

            <div class="form-group">
                <label class="form-label">–ò—Ç–æ–≥ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞</label>
                <select name="last_call_result" id="callResultSelect" class="form-input"
                    onchange="toggleOtherInput(this)">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏—Ç–æ–≥ --</option>
                    <option value="order">–û—Ñ–æ—Ä–º–∏–ª –∑–∞–∫–∞–∑</option>
                    <option value="sent_offer_email">–û—Ç–ø—Ä–∞–≤–∏–ª–∏ –ö–ü –Ω–∞ –µ–º–µ–π–ª</option>
                    <option value="sent_offer_messenger">–û—Ç–ø—Ä–∞–≤–∏–ª–∏ –ö–ü –Ω–∞ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã</option>
                    <option value="wrote_instagram">–ù–∞–ø–∏—Å–∞–ª–∏ –≤ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º</option>
                    <option value="thinking">–ü–æ–¥—É–º–∞–µ—Ç</option>
                    <option value="expensive">–î–æ—Ä–æ–≥–æ</option>
                    <option value="no_answer">–ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç</option>
                    <option value="not_interested">–ù–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç</option>
                    <option value="number_unavailable">–ù–æ–º–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</option>
                    <option value="other">–î—Ä—É–≥–æ–µ...</option>
                </select>
            </div>

            <div class="form-group hidden" id="otherResultContainer">
                <label class="form-label">–£–∫–∞–∂–∏—Ç–µ –∏—Ç–æ–≥</label>
                <textarea name="last_call_result_text" class="form-input" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</label>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="nonConversionCheck" name="is_non_conversion"
                        onchange="toggleDateInput(this)">
                    <label for="nonConversionCheck">–ù–µ–∫–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–π (–û—Ç–∫–∞–∑)</label>
                </div>
                <input type="datetime-local" id="nextCallInput" name="next_call_at" class="form-input mt-2">
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Gauge Animation (Simple Logic)
    document.addEventListener('DOMContentLoaded', function () {
        // You can fetch points from backend later
        const points = 85;
        const maxPoints = 100;
        const degrees = (points / maxPoints) * 180;
        const gaugeFill = document.querySelector('.gauge-fill');
        if (gaugeFill) {
            setTimeout(() => {
                gaugeFill.style.transform = `rotate(${degrees}deg)`;
            }, 500);
        }
    });

    // Modal Logic
    const modal = document.getElementById('addClientModal');

    function openModal() {
        modal.classList.add('open');
    }

    function closeModal() {
        modal.classList.remove('open');
    }

    function toggleOtherInput(select) {
        const container = document.getElementById('otherResultContainer');
        if (select.value === 'other') {
            container.classList.remove('hidden');
        } else {
            container.classList.add('hidden');
        }
    }

    function toggleDateInput(checkbox) {
        const dateInput = document.getElementById('nextCallInput');
        dateInput.disabled = checkbox.checked;
        if (checkbox.checked) {
            dateInput.value = '';
            dateInput.classList.add('disabled-input');
        } else {
            dateInput.classList.remove('disabled-input');
        }
    }

    // Close on overlay click
    modal.addEventListener('click', function (e) {
        if (e.target === modal) {
            closeModal();
        }
    });
</script>
{% endblock %}