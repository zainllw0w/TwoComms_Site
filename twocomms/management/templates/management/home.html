{% extends 'management/base.html' %}

{% block content %}
<!-- Tab: Main (Головна) -->
<div id="tab-main" class="tab-content active">

    <!-- Stats Row -->
    <div style="display: flex; gap: 20px; margin-bottom: 30px;">
        <div class="glass-panel animate-slide-up" <!-- HOME TAB -->
            <div id="home-content" class="tab-content active slide-up">

                <!-- Top Stats Cards (Placeholder for "Growth/Velocity" style) -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px;">
                    <div class="card" style="margin-bottom: 0;">
                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Клиентов
                            сегодня</div>
                        <div style="font-size: 24px; font-weight: 600; margin-top: 8px;">12</div>
                        <div style="font-size: 11px; color: var(--success-color); margin-top: 4px;">+2 новых</div>
                    </div>
                    <div class="card" style="margin-bottom: 0;">
                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Конверсия
                        </div>
                        <div style="font-size: 24px; font-weight: 600; margin-top: 8px;">8.4%</div>
                        <div style="font-size: 11px; color: var(--accent-color); margin-top: 4px;">↑ High</div>
                    </div>
                    <div class="card" style="margin-bottom: 0;">
                        <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Баллы
                        </div>
                        <div style="font-size: 24px; font-weight: 600; margin-top: 8px;">85</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">из 100</div>
                    </div>
                </div>

                <!-- Client Processing List -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Обработка клиентов</h2>
                        <button class="btn btn-primary" onclick="openModal()">+ Добавить клиента</button>
                    </div>

                    <div class="table-container">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th>Магазин / Инстаграм</th>
                                    <th>Контакты (ПІБ, Тел)</th>
                                    <th>Статус</th>
                                    <th>Источник</th>
                                    <th>Итог разговора</th>
                                    <th>Следующий шаг</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for client in clients %}
                                <tr>
                                    <td>
                                        <div style="font-weight: 500;">{{ client.shop_name }}</div>
                                    </td>
                                    <td>
                                        <div style="font-size: 13px;">{{ client.full_name }}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">{{ client.phone }}
                                        </div>
                                        <span class="badge badge-gray" style="margin-top: 4px;">{{
                                            client.get_contact_role_display }}</span>
                                    </td>
                                    <td>
                                        <span class="badge badge-warning">Новый</span>
                                    </td>
                                    <td>{{ client.source }}</td>
                                    <td>
                                        {% if client.last_call_result %}
                                        <div
                                            style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            {{ client.get_last_call_result_display }}
                                        </div>
                                        {% else %}
                                        <span style="color: var(--text-secondary);">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if client.is_non_conversion %}
                                        <span class="badge badge-danger">Отказ</span>
                                        {% elif client.next_call_at %}
                                        <div style="color: var(--accent-color);">{{ client.next_call_at|date:"d.m H:i"
                                            }}</div>
                                        {% else %}
                                        <span style="color: var(--text-secondary);">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6"
                                        style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                        Нет активных клиентов. Нажмите "Добавить клиента".
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Placeholder for other tabs -->
            <div id="stats-content" class="tab-content">
                <div class="card">
                    <div class="card-title">Статистика</div>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Раздел в разработке...</p>
                </div>
            </div>

            <!-- ADD CLIENT MODAL -->
            <div id="addClientModal" class="modal-overlay">
                <div class="modal-content fade-in">
                    <div class="card-header">
                        <h3 class="card-title">Новый клиент</h3>
                        <button
                            style="background:none; border:none; color: var(--text-secondary); cursor:pointer; font-size: 20px;"
                            onclick="closeModal()">×</button>
                    </div>

                    <form id="addClientForm" method="post" action="{% url 'management:client_create' %}">
                        {% csrf_token %}

                        <div class="form-group">
                            <label class="form-label">Название магазина / Instagram</label>
                            <input type="text" name="shop_name" class="form-input" required placeholder="@example_shop">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">Телефон</label>
                                <input type="text" name="phone" class="form-input" required placeholder="+380...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ПІБ Контакта</label>
                                <input type="text" name="full_name" class="form-input" required
                                    placeholder="Имя Фамилия">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Роль контакта</label>
                            <select name="contact_role" class="form-input">
                                <option value="owner">Владелец (Управляющий)</option>
                                <option value="manager">Менеджер</option>
                                <option value="realizer">Реализатор</option>
                                <option value="other">Другое</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Источник</label>
                            <input type="text" name="source" class="form-input" placeholder="Откуда контакт?">
                        </div>

                        <hr style="border: 0; border-top: 1px solid var(--card-border); margin: 20px 0;">

                        <div class="form-group">
                            <label class="form-label">Итог разговора</label>
                            <select name="last_call_result" id="callResultSelect" class="form-input"
                                onchange="toggleOtherInput(this)">
                                <option value="">-- Выберите итог --</option>
                                <option value="order">Оформил заказ</option>
                                <option value="email_sent">Отправили КП на емейл</option>
                                <option value="thinking">Подумает</option>
                                <option value="expensive">Дорого</option>
                                <option value="no_answer">Не отвечает</option>
                                <option value="other">Другое...</option>
                            </select>
                        </div>

                        <div class="form-group" id="otherResultContainer" style="display: none;">
                            <label class="form-label">Укажите итог</label>
                            <input type="text" name="last_call_result_text" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Следующий шаг</label>
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="nonConversionCheck" name="is_non_conversion"
                                    onchange="toggleDateInput(this)">
                                <label for="nonConversionCheck"
                                    style="font-size: 13px; color: var(--text-primary);">Неконверсионный (Отказ)</label>
                            </div>

                            <input type="datetime-local" id="nextCallInput" name="next_call_at" class="form-input">
                        </div>

                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Отмена</button>
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endblock %}

            {% block scripts %}
            <script>
                function openModal() {
                    document.getElementById('addClientModal').classList.add('open');
                }

                function closeModal() {
                    document.getElementById('addClientModal').classList.remove('open');
                }

                function toggleOtherInput(select) {
                    const container = document.getElementById('otherResultContainer');
                    container.style.display = select.value === 'other' ? 'block' : 'none';
                }

                function toggleDateInput(checkbox) {
                    const dateInput = document.getElementById('nextCallInput');
                    dateInput.disabled = checkbox.checked;
                    if (checkbox.checked) dateInput.value = '';
                }

                // Close modal on click outside
                document.getElementById('addClientModal').addEventListener('click', function (e) {
                    if (e.target === this) closeModal();
                });
            </script>
            {% endblock %}