{% extends "management/base.html" %}
{% load static %}

{% block content %}
<section class="admin-panel">
    <div class="panel-header">
        <div>
            <p class="eyebrow">Адміністрування</p>
            <h2>
                {% if admin_tab == 'invoices' %}
                    Накладні
                {% elif admin_tab == 'payouts' %}
                    Виплати
                {% elif admin_tab == 'shops' %}
                    Магазини
                {% else %}
                    Менеджери та прогрес
                {% endif %}
            </h2>
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="?tab=managers" class="btn-ghost small{% if admin_tab == 'managers' %} active{% endif %}">Менеджери та прогрес</a>
                <a href="?tab=invoices" class="btn-ghost small{% if admin_tab == 'invoices' %} active{% endif %}">Накладні</a>
                <a href="?tab=payouts" class="btn-ghost small{% if admin_tab == 'payouts' %} active{% endif %}">Виплати</a>
                <a href="?tab=shops" class="btn-ghost small{% if admin_tab == 'shops' %} active{% endif %}">Магазини</a>
                <a href="{% url 'management_stats_admin' %}" class="btn-ghost small">Статистика менеджерів</a>
            </div>
        </div>
    </div>
    {% if admin_tab == 'invoices' %}
    <div class="table-shell">
        <table class="nexus-table">
            <thead>
                <tr>
                    <th>Накладна</th>
                    <th>Менеджер</th>
                    <th>Компанія</th>
                    <th>Сума</th>
                    <th>Створено</th>
                    <th>Excel</th>
                    <th>Дії</th>
                </tr>
            </thead>
            <tbody>
                {% for inv in invoices_for_review %}
                <tr data-invoice-id="{{ inv.id }}">
                    <td>#{{ inv.invoice_number }}</td>
                    <td>{{ inv.created_by.get_full_name|default:inv.created_by.username }}</td>
                    <td>{{ inv.company_name }}</td>
                    <td>{{ inv.total_amount }} грн</td>
                    <td>{{ inv.created_at|date:"d.m.Y H:i" }}</td>
                    <td>
                        <a class="btn-ghost small" href="{% url 'management_invoices_download' inv.id %}" target="_blank" rel="noopener">Скачати</a>
                    </td>
                    <td style="white-space: nowrap;">
                        <button type="button" class="btn-ghost small" data-action="approve" data-invoice-id="{{ inv.id }}" style="border-color: rgba(16,185,129,0.4); color: #d1fae5; background: rgba(16,185,129,0.12);">Підтвердити</button>
                        <button type="button" class="btn-ghost small" data-action="reject" data-invoice-id="{{ inv.id }}" style="border-color: rgba(239,68,68,0.35); color: #fee2e2; background: rgba(239,68,68,0.12);">Відхилити</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="table-empty">Немає накладних на перевірці</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% elif admin_tab == 'payouts' %}
    <div class="admin-payouts">
        <section class="payouts-stats" aria-label="Загальна статистика">
            <div class="payouts-stats__grid admin-payouts-summary">
                <div class="stat-card">
                    <div class="stat-card__label">Менеджерів</div>
                    <div class="stat-card__value">{{ payouts_summary.managers|default:0 }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__label">Баланс</div>
                    <div class="stat-card__value">{{ payouts_summary.balance|floatformat:2 }} грн</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__label">Доступно</div>
                    <div class="stat-card__value">{{ payouts_summary.available|floatformat:2 }} грн</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__label">Заморожено</div>
                    <div class="stat-card__value">{{ payouts_summary.frozen|floatformat:2 }} грн</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__label">В обробці</div>
                    <div class="stat-card__value">{{ payouts_summary.reserved|floatformat:2 }} грн</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__label">Виплачено</div>
                    <div class="stat-card__value">{{ payouts_summary.paid_total|floatformat:2 }} грн</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__label">Активні запити</div>
                    <div class="stat-card__value">{{ payouts_summary.active_requests|default:0 }}</div>
                </div>
            </div>
        </section>

        <section class="admin-payouts-grid" aria-label="Менеджери">
            {% for p in payouts_payload %}
            <article class="admin-payout-card" data-user-id="{{ p.id }}">
                <div class="admin-payout-card__head">
                    <div>
                        <div class="admin-payout-card__name">{{ p.name }}</div>
                        <div class="admin-payout-card__meta">
                            <span>{{ p.position }}</span>
                            <span>• Картка {{ p.card_mask }}</span>
                            {% if p.days_worked is not None %}
                                <span>• Днів у роботі: {{ p.days_worked }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="admin-payout-card__status">
                        {% if p.active_request %}
                            <span class="status-chip status-{{ p.active_request.status }}">{{ p.active_request.get_status_display }}</span>
                        {% else %}
                            <span class="status-chip status-none">Немає активних</span>
                        {% endif %}
                    </div>
                </div>

                <div class="admin-payout-card__metrics">
                    <div class="admin-metric">
                        <div class="admin-metric__label">Баланс</div>
                        <div class="admin-metric__value">{{ p.balance|floatformat:2 }} грн</div>
                    </div>
                    <div class="admin-metric">
                        <div class="admin-metric__label">Доступно</div>
                        <div class="admin-metric__value">{{ p.available|floatformat:2 }} грн</div>
                    </div>
                    <div class="admin-metric">
                        <div class="admin-metric__label">Заморожено</div>
                        <div class="admin-metric__value">{{ p.frozen|floatformat:2 }} грн</div>
                    </div>
                    <div class="admin-metric">
                        <div class="admin-metric__label">В обробці</div>
                        <div class="admin-metric__value">{{ p.reserved|floatformat:2 }} грн</div>
                    </div>
                    <div class="admin-metric">
                        <div class="admin-metric__label">Нараховано</div>
                        <div class="admin-metric__value">{{ p.total_accrued|floatformat:2 }} грн</div>
                    </div>
                    <div class="admin-metric">
                        <div class="admin-metric__label">Виплачено</div>
                        <div class="admin-metric__value">{{ p.paid_total|floatformat:2 }} грн</div>
                    </div>
                    <div class="admin-metric">
                        <div class="admin-metric__label">Накладних</div>
                        <div class="admin-metric__value">{{ p.accruals_count|default:0 }}</div>
                    </div>
                    <div class="admin-metric">
                        <div class="admin-metric__label">Запитів</div>
                        <div class="admin-metric__value">{{ p.total_requests|default:0 }}</div>
                    </div>
                </div>

                <div class="admin-payout-card__timeline">
                    <div>
                        <div class="admin-payout-card__hint">Найближча розморозка</div>
                        <div class="admin-payout-card__value">
                            {% if p.next_unfreeze_label %}
                                {{ p.next_unfreeze_label }}{% if p.next_unfreeze_date %} • до {{ p.next_unfreeze_date }}{% endif %}
                            {% else %}
                                — немає заморожених сум
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div class="admin-payout-card__hint">Останній запит</div>
                        <div class="admin-payout-card__value">
                            {% if p.last_request_at %}
                                {{ p.last_request_at|date:"d.m.Y H:i" }}
                            {% else %}
                                —
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div class="admin-payout-card__hint">Остання виплата</div>
                        <div class="admin-payout-card__value">
                            {% if p.last_paid_at %}
                                {{ p.last_paid_at|date:"d.m.Y" }}
                            {% else %}
                                —
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if p.active_request %}
                <div class="admin-payout-card__actions">
                    <div class="admin-payout-card__request">
                        Запит #{{ p.active_request.id }} • {{ p.active_request.amount|floatformat:2 }} грн • {{ p.active_request.created_at|date:"d.m.Y H:i" }}
                    </div>
                    <div class="admin-payout-card__buttons">
                        {% if p.active_request.status == 'processing' %}
                            <button type="button" class="btn-ghost small" data-payout-action="approve" data-request-id="{{ p.active_request.id }}" style="border-color: rgba(16,185,129,0.4); color: #d1fae5; background: rgba(16,185,129,0.12);">Схвалити</button>
                            <button type="button" class="btn-ghost small" data-payout-action="reject" data-request-id="{{ p.active_request.id }}" style="border-color: rgba(239,68,68,0.35); color: #fee2e2; background: rgba(239,68,68,0.12);">Відхилити</button>
                        {% elif p.active_request.status == 'approved' %}
                            <button type="button" class="btn-ghost small" data-payout-action="paid" data-request-id="{{ p.active_request.id }}" style="border-color: rgba(59,130,246,0.4); color: #dbeafe; background: rgba(59,130,246,0.12);">Позначити як виплачене</button>
                            <button type="button" class="btn-ghost small" data-payout-action="reject" data-request-id="{{ p.active_request.id }}" style="border-color: rgba(239,68,68,0.35); color: #fee2e2; background: rgba(239,68,68,0.12);">Відхилити</button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <details class="admin-payout-card__details">
                    <summary>Дії та деталі</summary>
                    <div class="admin-alert" data-kind="" role="status"></div>

                    <div class="admin-payout-card__forms">
                        <div class="admin-payout-form">
                            <div class="admin-payout-form__title">Налаштування менеджера</div>
                            <div class="admin-payout-form__grid">
                                <label>
                                    Посада
                                    <input class="admin-mini-input" type="text" name="position" value="{{ p.position|default:'' }}">
                                </label>
                                <label>
                                    Ставка (грн)
                                    <input class="admin-mini-input" type="number" name="base_salary" min="0" step="1" value="{{ p.base_salary|default:0 }}">
                                </label>
                                <label>
                                    % з продажів
                                    <input class="admin-mini-input" type="number" name="percent" min="0" max="100" step="0.01" value="{{ p.percent|default:0 }}">
                                </label>
                                <label>
                                    Дата старту
                                    <input class="admin-mini-input" type="date" name="started_at" value="{% if p.started_at %}{{ p.started_at|date:'Y-m-d' }}{% endif %}">
                                </label>
                            </div>
                            <button type="button" class="btn-ghost small" data-payout-action="save-settings">Зберегти налаштування</button>
                        </div>

                        <div class="admin-payout-form">
                            <div class="admin-payout-form__title">Ручна виплата</div>
                            <div class="admin-payout-form__grid">
                                <label>
                                    Сума (грн)
                                    <input class="admin-mini-input" type="number" name="manual_amount" min="0" step="0.01" placeholder="0.00">
                                </label>
                                <label>
                                    Дата виплати
                                    <input class="admin-mini-input" type="date" name="manual_paid_at">
                                </label>
                            </div>
                            <button type="button" class="btn-ghost small" data-payout-action="manual-payout">Додати виплату</button>
                        </div>

                        <div class="admin-payout-form">
                            <div class="admin-payout-form__title">Коригування балансу</div>
                            <div class="admin-payout-form__grid">
                                <label>
                                    Тип
                                    <select class="admin-mini-input" name="adjust_direction">
                                        <option value="credit">+ Нарахування</option>
                                        <option value="debit">- Списання</option>
                                    </select>
                                </label>
                                <label>
                                    Сума (грн)
                                    <input class="admin-mini-input" type="number" name="adjust_amount" min="0" step="0.01" placeholder="0.00">
                                </label>
                                <label>
                                    Заморожено до
                                    <input class="admin-mini-input" type="date" name="adjust_frozen_until">
                                </label>
                                <label>
                                    Пояснення
                                    <input class="admin-mini-input" type="text" name="adjust_note" placeholder="Напр. бонус або штраф">
                                </label>
                            </div>
                            <button type="button" class="btn-ghost small" data-payout-action="adjust-balance">Застосувати</button>
                        </div>
                    </div>

                    <div class="admin-payout-card__frozen">
                        <div class="admin-payout-form__title">Заморожені нарахування</div>
                        <div class="admin-payout-frozen-list">
                            {% for item in p.frozen_items %}
                            <div class="admin-payout-frozen-item">
                                <div class="admin-payout-frozen-amount">{{ item.amount|floatformat:2 }} грн</div>
                                <div class="admin-payout-frozen-meta">{{ item.reason }}</div>
                                <div class="admin-payout-frozen-meta">до {{ item.frozen_until }}{% if item.days_left is not None %} • {{ item.days_left }} дн{% endif %}</div>
                            </div>
                            {% empty %}
                            <div class="table-empty">Заморожених сум немає</div>
                            {% endfor %}
                        </div>
                    </div>
                </details>
            </article>
            {% empty %}
            <div class="table-empty">Немає менеджерів для виплат</div>
            {% endfor %}
        </section>

        <section class="payouts-history" aria-label="Запити на виплати">
            <div class="panel-subhead">
                <div>
                    <p class="eyebrow">Запити</p>
                    <h3>Останні виплати та запити</h3>
                </div>
            </div>
            <div class="table-shell">
                <table class="nexus-table admin-payout-requests">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Менеджер</th>
                            <th>Сума</th>
                            <th>Статус</th>
                            <th>Тип</th>
                            <th>Причина</th>
                            <th>Дії</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in payout_requests %}
                        <tr data-request-id="{{ req.id }}">
                            <td>{{ req.created_at|date:"d.m.Y H:i" }}</td>
                            <td>{{ req.owner.get_full_name|default:req.owner.username }}</td>
                            <td>{{ req.amount|floatformat:2 }} грн</td>
                            <td><span class="status-chip status-{{ req.status }}">{{ req.get_status_display }}</span></td>
                            <td>{{ req.get_kind_display }}</td>
                            <td>{% if req.status == 'rejected' %}{{ req.rejection_reason|default:"—" }}{% else %}—{% endif %}</td>
                            <td style="white-space: nowrap;">
                                {% if req.status == 'processing' %}
                                    <button type="button" class="btn-ghost small" data-payout-action="approve" data-request-id="{{ req.id }}" style="border-color: rgba(16,185,129,0.4); color: #d1fae5; background: rgba(16,185,129,0.12);">Схвалити</button>
                                    <button type="button" class="btn-ghost small" data-payout-action="reject" data-request-id="{{ req.id }}" style="border-color: rgba(239,68,68,0.35); color: #fee2e2; background: rgba(239,68,68,0.12);">Відхилити</button>
                                {% elif req.status == 'approved' %}
                                    <button type="button" class="btn-ghost small" data-payout-action="paid" data-request-id="{{ req.id }}" style="border-color: rgba(59,130,246,0.4); color: #dbeafe; background: rgba(59,130,246,0.12);">Виплачено</button>
                                    <button type="button" class="btn-ghost small" data-payout-action="reject" data-request-id="{{ req.id }}" style="border-color: rgba(239,68,68,0.35); color: #fee2e2; background: rgba(239,68,68,0.12);">Відхилити</button>
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="table-empty">Немає запитів</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>
    {% elif admin_tab == 'shops' %}
    <div class="shops-grid" id="shops-grid">
        {% for shop in shops_payload %}
        <div class="shop-card" data-shop-id="{{ shop.id }}">
            <div class="shop-media">
                {% if shop.photo_url %}
                    <img class="shop-img" src="{{ shop.photo_url }}" alt="{{ shop.name|escape }}">
                {% else %}
                    <img class="shop-img" src="{% static 'img/placeholder.jpg' %}" alt="placeholder">
                {% endif %}

                <div class="shop-badges">
                    {% if shop.shop_type == 'test' %}
                        <span class="shop-badge badge-test">Тестова партія</span>
                    {% else %}
                        <span class="shop-badge badge-full">Опт / повний</span>
                    {% endif %}

                    {% if shop.timer %}
                        <span class="shop-badge badge-timer badge-timer-{{ shop.timer.status }}">{{ shop.timer.label }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="shop-body">
                <div class="shop-title">{{ shop.name }}</div>
                <div class="shop-meta">
                    {% if shop.total_amount and shop.total_amount != '0' and shop.total_amount != '0.00' %}
                        Підсумок: <span class="shop-amount">{{ shop.total_amount }} грн</span>
                    {% else %}
                        <span class="shop-muted">Немає суми по накладних</span>
                    {% endif %}
                </div>
                <div class="shop-meta">
                    {% if shop.primary_phone %}
                        <span class="shop-muted">☎</span> {{ shop.primary_phone }}
                    {% endif %}
                    {% if shop.created_by %}
                        <span class="shop-muted">•</span> Додав: {{ shop.created_by }}
                    {% endif %}
                    {% if shop.managed_by %}
                        <span class="shop-muted">•</span> Веде: {{ shop.managed_by }}
                    {% endif %}
                </div>
            </div>

            <div class="shop-actions">
                <button type="button" class="btn-ghost small" data-action="edit">Редагувати</button>
                <button type="button" class="btn-ghost small" data-action="manage">Менеджмент товарів</button>
                <button type="button" class="btn-ghost small" data-action="invoices">Дивитись накладну</button>
                <button type="button" class="btn-ghost small danger" data-action="delete">Видалити</button>
            </div>
        </div>
        {% empty %}
            <div class="shop-muted">Немає магазинів</div>
        {% endfor %}
    </div>

    <div class="shops-pagination">
        <div class="shops-page-info">Сторінка {{ page_obj.number }} з {{ page_obj.paginator.num_pages }}</div>
        <div class="shops-page-actions">
            {% if page_obj.has_previous %}
                <a class="btn-ghost small" href="?tab=shops&page={{ page_obj.previous_page_number }}">← Назад</a>
            {% endif %}
            {% if page_obj.has_next %}
                <a class="btn-ghost small" href="?tab=shops&page={{ page_obj.next_page_number }}">Далі →</a>
            {% endif %}
        </div>
    </div>

    <!-- Shop Create/Edit Modal -->
    <div class="modal-overlay" id="shop-modal">
        <div class="modal-card">
            <div class="modal-header">
                <div>
                    <p class="eyebrow" id="shop-modal-eyebrow">Магазин</p>
                    <h3 id="shop-modal-title">Додати магазин</h3>
                </div>
                <button type="button" class="modal-close" aria-label="Закрити">×</button>
            </div>
            <form id="shop-form" class="modal-body" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="shop_id" name="shop_id">

                <div class="shop-form-section">
                    <div class="section-title">Базові дані</div>
                    <div class="field-grid">
                        <div class="field">
                            <label for="shop_photo">Фото (опціонально)</label>
                            <input type="file" id="shop_photo" name="photo" accept="image/*">
                        </div>
                        <div class="field">
                            <label for="shop_name">Назва магазину</label>
                            <input type="text" id="shop_name" name="name" required>
                        </div>
                        <div class="field">
                            <label for="owner_full_name">ПІБ власника</label>
                            <input type="text" id="owner_full_name" name="owner_full_name">
                        </div>
                    </div>
                </div>

                <div class="shop-form-section">
                    <div class="section-title">Контакти</div>
                    <div id="phones-wrap" class="repeater"></div>
                    <button type="button" class="btn-ghost small" id="add-phone-btn">+ Додати номер</button>
                </div>

                <div class="shop-form-section">
                    <div class="section-title">Канали / посилання</div>
                    <div class="field-grid">
                        <div class="field checkbox-field">
                            <label class="checkline">
                                <input type="checkbox" id="ch_website" data-toggle="website_url">
                                <span>Сайт</span>
                            </label>
                            <input type="text" id="website_url" name="website_url" placeholder="twoComms.shop або https://..." style="display:none;">
                        </div>
                        <div class="field checkbox-field">
                            <label class="checkline">
                                <input type="checkbox" id="ch_instagram" data-toggle="instagram_url">
                                <span>Instagram / Instashop</span>
                            </label>
                            <input type="text" id="instagram_url" name="instagram_url" placeholder="instagram.com/... або https://instagram.com/..." style="display:none;">
                        </div>
                        <div class="field checkbox-field">
                            <label class="checkline">
                                <input type="checkbox" id="ch_prom" data-toggle="prom_url">
                                <span>Prom.ua</span>
                            </label>
                            <input type="text" id="prom_url" name="prom_url" placeholder="prom.ua/... або https://prom.ua/..." style="display:none;">
                        </div>
                        <div class="field checkbox-field field-span-2">
                            <label class="checkline">
                                <input type="checkbox" id="ch_other" data-toggle="other_sales_channel">
                                <span>Інше</span>
                            </label>
                            <input type="text" id="other_sales_channel" name="other_sales_channel" placeholder="Лінк або опис" style="display:none;">
                        </div>
                    </div>
                </div>

                <div class="shop-form-section">
                    <div class="section-title">Локація / реєстрація</div>
                    <div class="field-grid">
                        <div class="field field-span-2">
                            <label for="registration_place">Де зареєстровано магазин</label>
                            <input type="text" id="registration_place" name="registration_place">
                        </div>
                        <div class="field checkbox-field">
                            <label class="checkline">
                                <input type="checkbox" id="is_physical" name="is_physical">
                                <span>Фізичний магазин (потрібна адреса)</span>
                            </label>
                        </div>
                        <div class="field">
                            <label for="city">Місто</label>
                            <input type="text" id="city" name="city">
                        </div>
                        <div class="field field-span-2">
                            <label for="address">Адреса (детально)</label>
                            <textarea id="address" name="address"></textarea>
                        </div>
                    </div>
                </div>

                <div class="shop-form-section">
                    <div class="section-title">Тип магазину</div>
                    <div class="type-switch">
                        <label class="pill-radio">
                            <input type="radio" name="shop_type" value="full" checked>
                            <span>Повний магазин</span>
                        </label>
                        <label class="pill-radio">
                            <input type="radio" name="shop_type" value="test">
                            <span>Тестовий магазин (14 днів)</span>
                        </label>
                    </div>

                    <div id="test-fields" class="test-fields" style="display:none;">
                        <div class="field-grid">
                            <div class="field">
                                <label for="test_product_id">Який товар вигружено</label>
                                <select id="test_product_id" name="test_product_id">
                                    <option value="">—</option>
                                    {% for p in test_products %}
                                        <option value="{{ p.id }}">{{ p.category__name }} — {{ p.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field">
                                <label for="test_connected_at">Дата підключення (старт таймера)</label>
                                <input type="date" id="test_connected_at" name="test_connected_at">
                            </div>
                            <div class="field">
                                <label for="test_package_mode">Комплектація</label>
                                <select id="test_package_mode">
                                    <option value="rostovka">Ростовка (S → XL)</option>
                                    <option value="custom">Інше</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="test_package_value">Деталі комплектації</label>
                                <input type="text" id="test_package_value" placeholder="Напр.: S, M, L, XL">
                            </div>
                            <div class="field field-span-2">
                                <label for="test_contract_file">Договір (файл)</label>
                                <input type="file" id="test_contract_file" name="test_contract_file">
                                <div id="test-contract-current" class="shop-muted" style="display:none; margin-top:-2px;"></div>
                            </div>
                        </div>
                        <input type="hidden" id="test_package_json" name="test_package_json">
                    </div>
                </div>

                <div class="shop-form-section">
                    <div class="section-title">Відправки (ТТН) та накладні</div>
                    <div id="shipments-wrap" class="repeater"></div>
                    <button type="button" class="btn-ghost small" id="add-shipment-btn">+ Додати ТТН</button>
                </div>

                <div class="shop-form-section">
                    <div class="section-title">Нотатки</div>
                    <div class="field">
                        <textarea id="notes" name="notes" placeholder="Коротко: статус, домовленості, нюанси…"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-ghost modal-close">Відмінити</button>
                    <button type="submit" class="btn-primary" id="shop-save-btn">Зберегти</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoices Modal -->
    <div class="modal-overlay" id="shop-invoices-modal">
        <div class="modal-card">
            <div class="modal-header">
                <div>
                    <p class="eyebrow">Накладні</p>
                    <h3 id="shop-invoices-title">Накладні магазину</h3>
                </div>
                <button type="button" class="modal-close" aria-label="Закрити">×</button>
            </div>
            <div class="modal-body">
                <div id="shop-invoices-body" class="shop-modal-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-ghost modal-close">Закрити</button>
            </div>
        </div>
    </div>

    <!-- Management Modal -->
    <div class="modal-overlay" id="shop-manage-modal">
        <div class="modal-card">
            <div class="modal-header">
                <div>
                    <p class="eyebrow">Менеджмент</p>
                    <h3 id="shop-manage-title">Менеджмент магазину</h3>
                </div>
                <button type="button" class="modal-close" aria-label="Закрити">×</button>
            </div>
            <div class="modal-body">
                <div class="shop-manage-grid">
                    <div class="shop-manage-block">
                        <div class="block-title">Контакти / історія</div>
                        <div class="shop-next-contact">
                            <div class="shop-next-row">
                                <div class="shop-next-label">Наступний контакт</div>
                                <input type="datetime-local" id="shop-next-contact-at">
                                <button type="button" class="btn-ghost small" id="shop-next-contact-save">Зберегти</button>
                                <button type="button" class="btn-ghost small" id="shop-next-contact-clear">Очистити</button>
                            </div>
                        </div>
                        <div class="shop-comm-form">
                            <div class="field-grid">
                                <div class="field">
                                    <label for="comm_contacted_at">Коли</label>
                                    <input type="datetime-local" id="comm_contacted_at">
                                </div>
                                <div class="field">
                                    <label for="comm_person">З ким</label>
                                    <input type="text" id="comm_person">
                                </div>
                                <div class="field">
                                    <label for="comm_phone">Номер</label>
                                    <input type="text" id="comm_phone">
                                </div>
                                <div class="field field-span-2">
                                    <label for="comm_note">Нотатка</label>
                                    <textarea id="comm_note"></textarea>
                                </div>
                            </div>
                            <button type="button" class="btn-primary" id="comm_add_btn">Додати запис</button>
                        </div>
                        <div id="shop-comm-list" class="shop-comm-list"></div>
                    </div>

                    <div class="shop-manage-block">
                        <div class="block-title">Товари / залишки</div>
                        <div id="shop-inventory" class="shop-inventory"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-ghost modal-close">Закрити</button>
            </div>
        </div>
    </div>

    {{ shops_payload|json_script:"shops-data" }}
    {{ test_products|json_script:"test-products-data" }}
    {% else %}
    <div class="table-shell">
        <table class="nexus-table">
            <thead>
                <tr>
                    <th>Користувач</th>
                    <th>Статус</th>
                    <th>Сьогодні (клієнти)</th>
                    <th>Всього (клієнти)</th>
                    <th>Бали сьогодні</th>
                    <th>Бали всього</th>
                    <th>Онлайн</th>
                    <th>Останній вхід</th>
                    <th>Огляд</th>
                </tr>
            </thead>
            <tbody>
                {% for u in admin_user_data %}
                <tr>
                    <td>{{ u.name }}</td>
                    <td>{{ u.role }}</td>
                    <td>{{ u.today }}</td>
                    <td>{{ u.total }}</td>
                    <td>{{ u.points_today }}</td>
                    <td>{{ u.points_total }}</td>
                    <td>
                        {% if u.online %}
                            <span class="status-dot online">●</span> Онлайн
                        {% else %}
                            <span class="status-dot offline">●</span> Оффлайн
                        {% endif %}
                    </td>
                    <td>{{ u.last_login }}</td>
                    <td>
                        <button type="button" class="btn-ghost small admin-overview" data-user-id="{{ u.id }}">Огляд</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</section>

{% if admin_tab == 'managers' %}
<div id="admin-overview-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div>
                <p class="eyebrow">Список клієнтів</p>
                <h3 id="admin-overview-title">Огляд користувача</h3>
                <div id="admin-overview-subtitle" class="admin-overview-subtitle"></div>
            </div>
            <button type="button" class="modal-close" aria-label="Закрити">×</button>
        </div>
        <div class="modal-body admin-overview-body">
            <div class="admin-overview-toolbar">
                <div class="admin-overview-search">
                    <input type="text" id="admin-overview-search" placeholder="Пошук: магазин, телефон, ПІБ…">
                </div>
                <div class="admin-overview-chips" id="admin-overview-chips"></div>
            </div>
            <div id="admin-overview-list" class="admin-overview-list"></div>
            <div class="admin-overview-more">
                <button type="button" class="btn-ghost small" id="admin-overview-load-more" style="display:none;">Показати ще</button>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost modal-close">Закрити</button>
        </div>
    </div>
</div>

{{ admin_user_data|json_script:"admin-users-data" }}
{% endif %}
{% endblock %}

{% block extra_js %}
{% if admin_tab == 'invoices' %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action][data-invoice-id]');
    if (!btn) return;
    const invoiceId = btn.dataset.invoiceId;
    const action = btn.dataset.action;
    if (!invoiceId || !action) return;

    btn.disabled = true;
    try {
        if (action === 'approve') {
            const res = await fetch(`/admin-panel/invoices/${invoiceId}/approve/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({})
            });
            const data = await res.json().catch(() => ({}));
            if (!data.ok) throw new Error(data.error || 'Помилка підтвердження');
            const row = document.querySelector(`tr[data-invoice-id="${invoiceId}"]`);
            if (row) row.remove();
        } else if (action === 'reject') {
            const reason = prompt('Вкажіть причину відхилення:');
            if (!reason) { btn.disabled = false; return; }
            const res = await fetch(`/admin-panel/invoices/${invoiceId}/reject/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ reason })
            });
            const data = await res.json().catch(() => ({}));
            if (!data.ok) throw new Error(data.error || 'Помилка відхилення');
            const row = document.querySelector(`tr[data-invoice-id="${invoiceId}"]`);
            if (row) row.remove();
        }
    } catch (err) {
        alert(err.message || 'Помилка');
        btn.disabled = false;
    }
});
</script>
{% elif admin_tab == 'payouts' %}
<script>
const getCookie = (name) => {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
};

const payoutUrls = {
    settings: "{% url 'management_admin_payout_settings_save_api' %}",
    manual: "{% url 'management_admin_payout_manual_create_api' %}",
    adjust: "{% url 'management_admin_payout_adjust_api' %}",
    approve: (id) => `/admin-panel/payouts/api/request/${id}/approve/`,
    reject: (id) => `/admin-panel/payouts/api/request/${id}/reject/`,
    paid: (id) => `/admin-panel/payouts/api/request/${id}/paid/`,
};

const setCardAlert = (card, message, kind) => {
    if (!card) return;
    const alert = card.querySelector('.admin-alert');
    if (!alert) return;
    alert.textContent = message || '';
    alert.dataset.kind = kind || '';
};

const postJson = async (url, payload) => {
    const resp = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify(payload || {}),
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok || !data.ok) {
        const msg = (data && data.error) ? data.error : 'Помилка запиту.';
        throw new Error(msg);
    }
    return data;
};

document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-payout-action]');
    if (!btn) return;
    const action = btn.dataset.payoutAction;
    const requestId = btn.dataset.requestId;
    const card = btn.closest('.admin-payout-card');
    const userId = card ? card.dataset.userId : null;

    btn.disabled = true;
    try {
        if (action === 'save-settings') {
            if (!card || !userId) throw new Error('Не знайдено менеджера.');
            const payload = {
                user_id: userId,
                position: card.querySelector('[name="position"]')?.value || '',
                base_salary: card.querySelector('[name="base_salary"]')?.value || 0,
                percent: card.querySelector('[name="percent"]')?.value || 0,
                started_at: card.querySelector('[name="started_at"]')?.value || '',
            };
            setCardAlert(card, 'Зберігаємо налаштування…', 'info');
            await postJson(payoutUrls.settings, payload);
            setCardAlert(card, 'Налаштування збережені.', 'ok');
        } else if (action === 'manual-payout') {
            if (!card || !userId) throw new Error('Не знайдено менеджера.');
            const amount = card.querySelector('[name="manual_amount"]')?.value || '';
            const paidAt = card.querySelector('[name="manual_paid_at"]')?.value || '';
            if (!amount || Number(amount) <= 0) {
                throw new Error('Вкажіть суму виплати.');
            }
            setCardAlert(card, 'Створюємо виплату…', 'info');
            await postJson(payoutUrls.manual, { user_id: userId, amount, paid_at: paidAt });
            setCardAlert(card, 'Виплату додано. Оновлюємо…', 'ok');
            setTimeout(() => window.location.reload(), 650);
        } else if (action === 'adjust-balance') {
            if (!card || !userId) throw new Error('Не знайдено менеджера.');
            const direction = card.querySelector('[name="adjust_direction"]')?.value || 'credit';
            const amount = card.querySelector('[name="adjust_amount"]')?.value || '';
            const note = card.querySelector('[name="adjust_note"]')?.value || '';
            const frozenUntil = card.querySelector('[name="adjust_frozen_until"]')?.value || '';
            if (!amount || Number(amount) <= 0) {
                throw new Error('Вкажіть суму коригування.');
            }
            setCardAlert(card, 'Додаємо коригування…', 'info');
            await postJson(payoutUrls.adjust, {
                user_id: userId,
                direction,
                amount,
                note,
                frozen_until: frozenUntil,
            });
            setCardAlert(card, 'Коригування додано. Оновлюємо…', 'ok');
            setTimeout(() => window.location.reload(), 650);
        } else if (action === 'approve' || action === 'reject' || action === 'paid') {
            if (!requestId) throw new Error('Не знайдено запит.');
            let payload = {};
            if (action === 'reject') {
                const reason = prompt('Вкажіть причину відхилення:');
                if (!reason) {
                    btn.disabled = false;
                    return;
                }
                payload = { reason };
            }
            const url = payoutUrls[action](requestId);
            await postJson(url, payload);
            setTimeout(() => window.location.reload(), 650);
        }
    } catch (err) {
        if (card) {
            setCardAlert(card, err.message || 'Помилка.', 'err');
        } else {
            alert(err.message || 'Помилка.');
        }
    } finally {
        btn.disabled = false;
    }
});
</script>
{% elif admin_tab == 'shops' %}
<script src="{% static 'js/management-shops.js' %}"></script>
{% elif admin_tab == 'managers' %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const body = document.body;
    const adminDataEl = document.getElementById('admin-users-data');
    const adminModal = document.getElementById('admin-overview-modal');
    const adminModalTitle = document.getElementById('admin-overview-title');
    const adminModalSubtitle = document.getElementById('admin-overview-subtitle');
    const adminModalList = document.getElementById('admin-overview-list');
    const adminChips = document.getElementById('admin-overview-chips');
    const adminSearch = document.getElementById('admin-overview-search');
    const adminLoadMore = document.getElementById('admin-overview-load-more');
    let adminUsers = [];
    if (adminDataEl) {
        try { adminUsers = JSON.parse(adminDataEl.textContent); } catch (e) { adminUsers = []; }
    }

    // Apply gauge arc if present
    const arcFill = document.getElementById('gauge-arc-fill');
    if (arcFill) {
        const arcLen = 251.3;
        const init = parseFloat(arcFill.dataset.progress || '0');
        arcFill.style.strokeDashoffset = arcLen * (1 - init / 100);
    }

    const adminCloseModal = () => {
        if (!adminModal) return;
        adminModal.classList.remove('show');
        body.classList.remove('modal-open');
    };
    if (adminModal) {
        adminModal.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', adminCloseModal));
        adminModal.addEventListener('click', (e) => { if (e.target === adminModal) adminCloseModal(); });
    }
    const clientsUrlTemplate = "{% url 'management_admin_user_clients' 0 %}";
    const state = {
        userId: null,
        offset: 0,
        limit: 80,
        total: 0,
        hasMore: false,
        query: '',
        loaded: [],
    };

    const setChips = (user) => {
        if (!adminChips) return;
        const chips = [];
        const mk = (label, value, tone='') => {
            const el = document.createElement('div');
            el.className = `admin-chip ${tone}`.trim();
            el.textContent = `${label}: ${value}`;
            return el;
        };
        chips.push(mk('Сьогодні', `${user.today} клієнтів`, 'accent'));
        chips.push(mk('Бали', `${user.points_today}`, 'accent'));
        chips.push(mk('Всього', `${user.total} клієнтів`, ''));
        chips.push(mk('Бали', `${user.points_total}`, ''));
        adminChips.innerHTML = '';
        chips.forEach(c => adminChips.appendChild(c));
    };

    const escapeText = (v) => (v === null || v === undefined) ? '' : String(v);

    const pill = (text, cls) => {
        const el = document.createElement('span');
        el.className = `pill ${cls || ''}`.trim();
        el.textContent = escapeText(text);
        return el;
    };

    const renderOverview = () => {
        if (!adminModalList) return;
        adminModalList.innerHTML = '';
        if (!state.loaded.length) {
            const empty = document.createElement('div');
            empty.className = 'table-empty';
            empty.textContent = state.query ? 'Нічого не знайдено' : 'Немає клієнтів';
            adminModalList.appendChild(empty);
            return;
        }
        const groups = new Map();
        for (const c of state.loaded) {
            const key = c.created_date_label || '—';
            if (!groups.has(key)) groups.set(key, []);
            groups.get(key).push(c);
        }
        for (const [label, clients] of groups.entries()) {
            const group = document.createElement('div');
            group.className = 'overview-group';
            const head = document.createElement('div');
            head.className = 'overview-group-title';
            head.textContent = `${label} • ${clients.length}`;
            group.appendChild(head);

            for (const c of clients) {
                const details = document.createElement('details');
                details.className = 'client-item';

                const summary = document.createElement('summary');
                summary.className = 'client-summary';

                const left = document.createElement('div');
                left.className = 'client-left';
                const shop = document.createElement('div');
                shop.className = 'client-shop';
                shop.textContent = escapeText(c.shop);
                const sub = document.createElement('div');
                sub.className = 'client-sub';
                const subParts = [];
                if (c.phone) subParts.push(escapeText(c.phone));
                if (c.full_name) subParts.push(escapeText(c.full_name));
                sub.textContent = subParts.join(' • ') || '—';
                left.appendChild(shop);
                left.appendChild(sub);

                const right = document.createElement('div');
                right.className = 'client-right';
                right.appendChild(pill(c.result, `result result-${escapeText(c.result_code)}`));
                right.appendChild(pill(c.role, `role role-${escapeText(c.role_code)}`));
                right.appendChild(pill(`+${c.points || 0}`, 'points'));
                if (c.next_call && c.next_call !== '–') {
                    right.appendChild(pill(c.next_call, `next next-${escapeText(c.next_call_status)}`));
                }
                const created = document.createElement('div');
                created.className = 'client-created';
                created.textContent = escapeText(c.created);
                right.appendChild(created);

                summary.appendChild(left);
                summary.appendChild(right);
                details.appendChild(summary);

                const body = document.createElement('div');
                body.className = 'client-details';

                const rows = [
                    ['ПІБ', c.full_name || '—'],
                    ['Телефон', c.phone || '—'],
                    ['Статус', c.role || '—'],
                    ['Джерело', c.source || '—'],
                    ['Підсумок', (c.result || '—') + (c.details ? ` • ${c.details}` : '')],
                    ['Наступний дзвінок', c.next_call || '—'],
                ];
                rows.forEach(([k, v]) => {
                    const row = document.createElement('div');
                    row.className = 'client-detail';
                    const kk = document.createElement('div');
                    kk.className = 'client-k';
                    kk.textContent = k;
                    const vv = document.createElement('div');
                    vv.className = 'client-v';
                    vv.textContent = escapeText(v);
                    row.appendChild(kk);
                    row.appendChild(vv);
                    body.appendChild(row);
                });
                details.appendChild(body);
                group.appendChild(details);
            }
            adminModalList.appendChild(group);
        }
    };

    const setLoading = () => {
        if (!adminModalList) return;
        adminModalList.innerHTML = '<div class="table-empty">Завантаження…</div>';
    };

    const fetchPage = (reset = false) => {
        if (!state.userId) return;
        if (reset) {
            state.offset = 0;
            state.loaded = [];
        }
        setLoading();
        const url = new URL(clientsUrlTemplate.replace('/0/', `/${state.userId}/`), window.location.origin);
        url.searchParams.set('offset', String(state.offset));
        url.searchParams.set('limit', String(state.limit));
        if (state.query) url.searchParams.set('q', state.query);
        fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(r => r.json())
            .then(data => {
                if (!data || !data.ok) throw new Error('bad');
                state.total = data.total || 0;
                state.hasMore = !!data.has_more;
                state.loaded = state.loaded.concat(data.clients || []);
                state.offset = state.loaded.length;
                renderOverview();
                if (adminLoadMore) adminLoadMore.style.display = state.hasMore ? 'inline-flex' : 'none';
            })
            .catch(() => {
                if (!adminModalList) return;
                adminModalList.innerHTML = '<div class="table-empty">Помилка завантаження</div>';
                if (adminLoadMore) adminLoadMore.style.display = 'none';
            });
    };

    if (adminLoadMore) {
        adminLoadMore.addEventListener('click', () => fetchPage(false));
    }
    if (adminSearch) {
        let t = null;
        adminSearch.addEventListener('input', () => {
            clearTimeout(t);
            t = setTimeout(() => {
                state.query = adminSearch.value.trim();
                fetchPage(true);
            }, 280);
        });
    }

    document.querySelectorAll('.admin-overview').forEach(btn => {
        btn.addEventListener('click', () => {
            if (!adminModal) return;
            const uid = parseInt(btn.dataset.userId, 10);
            const user = adminUsers.find(u => u.id === uid);
            if (!user) return;
            adminModalTitle.textContent = `Огляд: ${user.name}`;
            if (adminModalSubtitle) {
                adminModalSubtitle.textContent = `${user.role} • Останній вхід: ${user.last_login}`;
            }
            if (adminSearch) adminSearch.value = '';
            state.userId = uid;
            state.query = '';
            setChips(user);
            fetchPage(true);
            adminModal.classList.add('show');
            body.classList.add('modal-open');
        });
    });
});
</script>
{% endif %}
{% endblock %}
