{% extends "management/base.html" %}

{% block content %}
<section class="admin-panel">
    <div class="panel-header">
        <div>
            <p class="eyebrow">Адміністрування</p>
            <h2>{% if admin_tab == 'invoices' %}Накладні{% else %}Менеджери та прогрес{% endif %}</h2>
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="?tab=managers" class="btn-ghost small{% if admin_tab != 'invoices' %} active{% endif %}">Менеджери та прогрес</a>
                <a href="?tab=invoices" class="btn-ghost small{% if admin_tab == 'invoices' %} active{% endif %}">Накладні</a>
            </div>
        </div>
    </div>
    {% if admin_tab == 'invoices' %}
    <div class="table-shell">
        <table class="nexus-table">
            <thead>
                <tr>
                    <th>Накладна</th>
                    <th>Менеджер</th>
                    <th>Компанія</th>
                    <th>Сума</th>
                    <th>Створено</th>
                    <th>Excel</th>
                    <th>Дії</th>
                </tr>
            </thead>
            <tbody>
                {% for inv in invoices_for_review %}
                <tr data-invoice-id="{{ inv.id }}">
                    <td>#{{ inv.invoice_number }}</td>
                    <td>{{ inv.created_by.get_full_name|default:inv.created_by.username }}</td>
                    <td>{{ inv.company_name }}</td>
                    <td>{{ inv.total_amount }} грн</td>
                    <td>{{ inv.created_at|date:"d.m.Y H:i" }}</td>
                    <td>
                        <a class="btn-ghost small" href="{% url 'management_invoices_download' inv.id %}" target="_blank" rel="noopener">Скачати</a>
                    </td>
                    <td style="white-space: nowrap;">
                        <button type="button" class="btn-ghost small" data-action="approve" data-invoice-id="{{ inv.id }}" style="border-color: rgba(16,185,129,0.4); color: #d1fae5; background: rgba(16,185,129,0.12);">Підтвердити</button>
                        <button type="button" class="btn-ghost small" data-action="reject" data-invoice-id="{{ inv.id }}" style="border-color: rgba(239,68,68,0.35); color: #fee2e2; background: rgba(239,68,68,0.12);">Відхилити</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="table-empty">Немає накладних на перевірці</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="table-shell">
        <table class="nexus-table">
            <thead>
                <tr>
                    <th>Користувач</th>
                    <th>Статус</th>
                    <th>Сьогодні (клієнти)</th>
                    <th>Всього (клієнти)</th>
                    <th>Бали сьогодні</th>
                    <th>Бали всього</th>
                    <th>Онлайн</th>
                    <th>Останній вхід</th>
                    <th>Огляд</th>
                </tr>
            </thead>
            <tbody>
                {% for u in admin_user_data %}
                <tr>
                    <td>{{ u.name }}</td>
                    <td>{{ u.role }}</td>
                    <td>{{ u.today }}</td>
                    <td>{{ u.total }}</td>
                    <td>{{ u.points_today }}</td>
                    <td>{{ u.points_total }}</td>
                    <td>
                        {% if u.online %}
                            <span class="status-dot online">●</span> Онлайн
                        {% else %}
                            <span class="status-dot offline">●</span> Оффлайн
                        {% endif %}
                    </td>
                    <td>{{ u.last_login }}</td>
                    <td>
                        <button type="button" class="btn-ghost small admin-overview" data-user-id="{{ u.id }}">Огляд</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
    {% endif %}

{% if admin_tab != 'invoices' %}
<div id="admin-overview-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div>
                <p class="eyebrow">Список клієнтів</p>
                <h3 id="admin-overview-title">Огляд користувача</h3>
                <div id="admin-overview-subtitle" class="admin-overview-subtitle"></div>
            </div>
            <button type="button" class="modal-close" aria-label="Закрити">×</button>
        </div>
        <div class="modal-body admin-overview-body">
            <div class="admin-overview-toolbar">
                <div class="admin-overview-search">
                    <input type="text" id="admin-overview-search" placeholder="Пошук: магазин, телефон, ПІБ…">
                </div>
                <div class="admin-overview-chips" id="admin-overview-chips"></div>
            </div>
            <div id="admin-overview-list" class="admin-overview-list"></div>
            <div class="admin-overview-more">
                <button type="button" class="btn-ghost small" id="admin-overview-load-more" style="display:none;">Показати ще</button>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-ghost modal-close">Закрити</button>
        </div>
    </div>
</div>

{{ admin_user_data|json_script:"admin-users-data" }}
{% endif %}
{% endblock %}

{% block extra_js %}
{% if admin_tab == 'invoices' %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action][data-invoice-id]');
    if (!btn) return;
    const invoiceId = btn.dataset.invoiceId;
    const action = btn.dataset.action;
    if (!invoiceId || !action) return;

    btn.disabled = true;
    try {
        if (action === 'approve') {
            const res = await fetch(`/admin-panel/invoices/${invoiceId}/approve/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({})
            });
            const data = await res.json().catch(() => ({}));
            if (!data.ok) throw new Error(data.error || 'Помилка підтвердження');
            const row = document.querySelector(`tr[data-invoice-id="${invoiceId}"]`);
            if (row) row.remove();
        } else if (action === 'reject') {
            const reason = prompt('Вкажіть причину відхилення:');
            if (!reason) { btn.disabled = false; return; }
            const res = await fetch(`/admin-panel/invoices/${invoiceId}/reject/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                body: JSON.stringify({ reason })
            });
            const data = await res.json().catch(() => ({}));
            if (!data.ok) throw new Error(data.error || 'Помилка відхилення');
            const row = document.querySelector(`tr[data-invoice-id="${invoiceId}"]`);
            if (row) row.remove();
        }
    } catch (err) {
        alert(err.message || 'Помилка');
        btn.disabled = false;
    }
});
</script>
{% else %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const body = document.body;
    const adminDataEl = document.getElementById('admin-users-data');
    const adminModal = document.getElementById('admin-overview-modal');
    const adminModalTitle = document.getElementById('admin-overview-title');
    const adminModalSubtitle = document.getElementById('admin-overview-subtitle');
    const adminModalList = document.getElementById('admin-overview-list');
    const adminChips = document.getElementById('admin-overview-chips');
    const adminSearch = document.getElementById('admin-overview-search');
    const adminLoadMore = document.getElementById('admin-overview-load-more');
    let adminUsers = [];
    if (adminDataEl) {
        try { adminUsers = JSON.parse(adminDataEl.textContent); } catch (e) { adminUsers = []; }
    }

    // Apply gauge arc if present
    const arcFill = document.getElementById('gauge-arc-fill');
    if (arcFill) {
        const arcLen = 251.3;
        const init = parseFloat(arcFill.dataset.progress || '0');
        arcFill.style.strokeDashoffset = arcLen * (1 - init / 100);
    }

    const adminCloseModal = () => {
        if (!adminModal) return;
        adminModal.classList.remove('show');
        body.classList.remove('modal-open');
    };
    if (adminModal) {
        adminModal.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', adminCloseModal));
        adminModal.addEventListener('click', (e) => { if (e.target === adminModal) adminCloseModal(); });
    }
    const clientsUrlTemplate = "{% url 'management_admin_user_clients' 0 %}";
    const state = {
        userId: null,
        offset: 0,
        limit: 80,
        total: 0,
        hasMore: false,
        query: '',
        loaded: [],
    };

    const setChips = (user) => {
        if (!adminChips) return;
        const chips = [];
        const mk = (label, value, tone='') => {
            const el = document.createElement('div');
            el.className = `admin-chip ${tone}`.trim();
            el.textContent = `${label}: ${value}`;
            return el;
        };
        chips.push(mk('Сьогодні', `${user.today} клієнтів`, 'accent'));
        chips.push(mk('Бали', `${user.points_today}`, 'accent'));
        chips.push(mk('Всього', `${user.total} клієнтів`, ''));
        chips.push(mk('Бали', `${user.points_total}`, ''));
        adminChips.innerHTML = '';
        chips.forEach(c => adminChips.appendChild(c));
    };

    const escapeText = (v) => (v === null || v === undefined) ? '' : String(v);

    const pill = (text, cls) => {
        const el = document.createElement('span');
        el.className = `pill ${cls || ''}`.trim();
        el.textContent = escapeText(text);
        return el;
    };

    const renderOverview = () => {
        if (!adminModalList) return;
        adminModalList.innerHTML = '';
        if (!state.loaded.length) {
            const empty = document.createElement('div');
            empty.className = 'table-empty';
            empty.textContent = state.query ? 'Нічого не знайдено' : 'Немає клієнтів';
            adminModalList.appendChild(empty);
            return;
        }
        const groups = new Map();
        for (const c of state.loaded) {
            const key = c.created_date_label || '—';
            if (!groups.has(key)) groups.set(key, []);
            groups.get(key).push(c);
        }
        for (const [label, clients] of groups.entries()) {
            const group = document.createElement('div');
            group.className = 'overview-group';
            const head = document.createElement('div');
            head.className = 'overview-group-title';
            head.textContent = `${label} • ${clients.length}`;
            group.appendChild(head);

            for (const c of clients) {
                const details = document.createElement('details');
                details.className = 'client-item';

                const summary = document.createElement('summary');
                summary.className = 'client-summary';

                const left = document.createElement('div');
                left.className = 'client-left';
                const shop = document.createElement('div');
                shop.className = 'client-shop';
                shop.textContent = escapeText(c.shop);
                const sub = document.createElement('div');
                sub.className = 'client-sub';
                const subParts = [];
                if (c.phone) subParts.push(escapeText(c.phone));
                if (c.full_name) subParts.push(escapeText(c.full_name));
                sub.textContent = subParts.join(' • ') || '—';
                left.appendChild(shop);
                left.appendChild(sub);

                const right = document.createElement('div');
                right.className = 'client-right';
                right.appendChild(pill(c.result, `result result-${escapeText(c.result_code)}`));
                right.appendChild(pill(c.role, `role role-${escapeText(c.role_code)}`));
                right.appendChild(pill(`+${c.points || 0}`, 'points'));
                if (c.next_call && c.next_call !== '–') {
                    right.appendChild(pill(c.next_call, `next next-${escapeText(c.next_call_status)}`));
                }
                const created = document.createElement('div');
                created.className = 'client-created';
                created.textContent = escapeText(c.created);
                right.appendChild(created);

                summary.appendChild(left);
                summary.appendChild(right);
                details.appendChild(summary);

                const body = document.createElement('div');
                body.className = 'client-details';

                const rows = [
                    ['ПІБ', c.full_name || '—'],
                    ['Телефон', c.phone || '—'],
                    ['Статус', c.role || '—'],
                    ['Джерело', c.source || '—'],
                    ['Підсумок', (c.result || '—') + (c.details ? ` • ${c.details}` : '')],
                    ['Наступний дзвінок', c.next_call || '—'],
                ];
                rows.forEach(([k, v]) => {
                    const row = document.createElement('div');
                    row.className = 'client-detail';
                    const kk = document.createElement('div');
                    kk.className = 'client-k';
                    kk.textContent = k;
                    const vv = document.createElement('div');
                    vv.className = 'client-v';
                    vv.textContent = escapeText(v);
                    row.appendChild(kk);
                    row.appendChild(vv);
                    body.appendChild(row);
                });
                details.appendChild(body);
                group.appendChild(details);
            }
            adminModalList.appendChild(group);
        }
    };

    const setLoading = () => {
        if (!adminModalList) return;
        adminModalList.innerHTML = '<div class="table-empty">Завантаження…</div>';
    };

    const fetchPage = (reset = false) => {
        if (!state.userId) return;
        if (reset) {
            state.offset = 0;
            state.loaded = [];
        }
        setLoading();
        const url = new URL(clientsUrlTemplate.replace('/0/', `/${state.userId}/`), window.location.origin);
        url.searchParams.set('offset', String(state.offset));
        url.searchParams.set('limit', String(state.limit));
        if (state.query) url.searchParams.set('q', state.query);
        fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(r => r.json())
            .then(data => {
                if (!data || !data.ok) throw new Error('bad');
                state.total = data.total || 0;
                state.hasMore = !!data.has_more;
                state.loaded = state.loaded.concat(data.clients || []);
                state.offset = state.loaded.length;
                renderOverview();
                if (adminLoadMore) adminLoadMore.style.display = state.hasMore ? 'inline-flex' : 'none';
            })
            .catch(() => {
                if (!adminModalList) return;
                adminModalList.innerHTML = '<div class="table-empty">Помилка завантаження</div>';
                if (adminLoadMore) adminLoadMore.style.display = 'none';
            });
    };

    if (adminLoadMore) {
        adminLoadMore.addEventListener('click', () => fetchPage(false));
    }
    if (adminSearch) {
        let t = null;
        adminSearch.addEventListener('input', () => {
            clearTimeout(t);
            t = setTimeout(() => {
                state.query = adminSearch.value.trim();
                fetchPage(true);
            }, 280);
        });
    }

    document.querySelectorAll('.admin-overview').forEach(btn => {
        btn.addEventListener('click', () => {
            if (!adminModal) return;
            const uid = parseInt(btn.dataset.userId, 10);
            const user = adminUsers.find(u => u.id === uid);
            if (!user) return;
            adminModalTitle.textContent = `Огляд: ${user.name}`;
            if (adminModalSubtitle) {
                adminModalSubtitle.textContent = `${user.role} • Останній вхід: ${user.last_login}`;
            }
            if (adminSearch) adminSearch.value = '';
            state.userId = uid;
            state.query = '';
            setChips(user);
            fetchPage(true);
            adminModal.classList.add('show');
            body.classList.add('modal-open');
        });
    });
});
</script>
{% endif %}
{% endblock %}
