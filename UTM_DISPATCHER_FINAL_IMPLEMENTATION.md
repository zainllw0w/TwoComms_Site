# üéØ UTM Dispatcher - –§–∏–Ω–∞–ª—å–Ω–∞—è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è v3.0

## üìã –î–∞—Ç–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏: 2025-01-30

---

## ‚ú® –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

### –í–µ—Ä—Å–∏—è 3.0 - –§–∏–Ω–∞–ª—å–Ω–∞—è (2025-01-30)

**–ù–æ–≤–æ–µ –≤ v3.0:**

#### 1. ‚úÖ –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (`utm_cohort_analysis.py`)
–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∫–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

**–§—É–Ω–∫—Ü–∏–∏:**
- `get_cohort_analysis()` - –∫–æ–≥–æ—Ä—Ç–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏:
  - **retention** - —É–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (%)
  - **ltv** - Lifetime Value (–∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥)
  - **orders** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤
  - **revenue** - –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
  
- `get_source_ltv_comparison()` - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ LTV –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
- `get_repeat_purchase_rate()` - –∞–Ω–∞–ª–∏–∑ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫
- `get_campaign_ab_test_results()` - A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–≥–æ—Ä—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:**
- `cohort_type`: 'day', 'week', 'month'
- `metric`: 'retention', 'ltv', 'orders', 'revenue'
- `utm_source`: —Ñ–∏–ª—å—Ç—Ä –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É
- `start_date` / `end_date`: –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from storefront.utm_cohort_analysis import get_cohort_analysis
from datetime import datetime, timedelta
from django.utils import timezone

# –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π (retention –ø–æ –Ω–µ–¥–µ–ª—è–º)
start = timezone.now() - timedelta(days=90)
end = timezone.now()

cohort_data = get_cohort_analysis(
    start_date=start,
    end_date=end,
    cohort_type='week',
    metric='retention',
    utm_source='facebook'
)

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# {
#   'cohorts': ['2024-11-01', '2024-11-08', ...],  # –î–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∫–æ–≥–æ—Ä—Ç
#   'periods': ['–¢–∏–∂–¥–µ–Ω—å 0', '–¢–∏–∂–¥–µ–Ω—å 1', ...],    # –ü–µ—Ä–∏–æ–¥—ã –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞
#   'matrix': [[100, 45, 32, ...], ...],            # Retention % –ø–æ –Ω–µ–¥–µ–ª—è–º
#   'totals': [{'cohort': '...', 'size': 150, ...}]
# }
```

---

#### 2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ Email –û—Ç—á–µ—Ç—ã

**Management Command:** `send_utm_report`

```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –∑–∞ –Ω–µ–¥–µ–ª—é
python manage.py send_utm_report --period week --recipients admin@example.com

# –û—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü —Å CSV –≤–ª–æ–∂–µ–Ω–∏—è–º–∏
python manage.py send_utm_report --period month --recipients admin@example.com,marketing@example.com --attach-csv

# HTML –æ—Ç—á–µ—Ç
python manage.py send_utm_report --period today --format html --recipients admin@example.com

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏)
python manage.py send_utm_report --period week --dry-run
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `--period` - –ø–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞ (today/week/month/all_time)
- `--recipients` - email –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
- `--format` - —Ñ–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞ (html/text)
- `--attach-csv` - –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å CSV —Ñ–∞–π–ª—ã
- `--dry-run` - —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞:**
1. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ vs –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥
2. –¢–æ–ø-5 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞
3. LTV –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (–¢–æ–ø-5)
4. –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
5. –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–π
6. CSV –≤–ª–æ–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   - utm_sources.csv
   - utm_campaigns.csv

**–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Cron:**
```bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
chmod +x setup_utm_email_reports.sh
./setup_utm_email_reports.sh

# –ë—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ:
# - –£–∫–∞–∑–∞—Ç—å email –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
# - –í—ã–±—Ä–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ/–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ/–µ–∂–µ–º–µ—Å—è—á–Ω–æ)
# - –ü—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å –ª–∏ CSV
# - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
```

**–ü—Ä–∏–º–µ—Ä—ã Cron —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π:**
```bash
# –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 9:00
0 9 * * * cd /path/to/project && .venv/bin/python manage.py send_utm_report --period today --recipients admin@example.com

# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –ø–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞–º –≤ 9:00
0 9 * * 1 cd /path/to/project && .venv/bin/python manage.py send_utm_report --period week --recipients marketing@example.com --attach-csv

# –ï–∂–µ–º–µ—Å—è—á–Ω–æ 1-–≥–æ —á–∏—Å–ª–∞ –≤ 9:00
0 9 1 * * cd /path/to/project && .venv/bin/python manage.py send_utm_report --period month --recipients boss@example.com --attach-csv
```

---

#### 3. ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ API Endpoints

**–ù–æ–≤—ã–µ endpoints –¥–ª—è –∫–æ–≥–æ—Ä—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:**

```bash
# –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (retention)
GET /api/utm/cohort-analysis/?cohort_type=week&metric=retention&start_date=2024-11-01&end_date=2025-01-30

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
# - cohort_type: day/week/month
# - metric: retention/ltv/orders/revenue
# - utm_source: —Ñ–∏–ª—å—Ç—Ä –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# - start_date: –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (ISO —Ñ–æ—Ä–º–∞—Ç)
# - end_date: –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (ISO —Ñ–æ—Ä–º–∞—Ç)

# LTV —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
GET /api/utm/ltv-comparison/?period=month

# –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
GET /api/utm/repeat-rate/?period=month&utm_source=facebook

# A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏
GET /api/utm/ab-test/?campaign=winter_sale_2025&period=month
```

**–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ API endpoints (17 —à—Ç—É–∫):**
1. `/api/utm/general-stats/` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
2. `/api/utm/sources/` - –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
3. `/api/utm/campaigns/` - –ø–æ –∫–∞–º–ø–∞–Ω–∏—è–º
4. `/api/utm/content/` - –ø–æ –∫—Ä–µ–∞—Ç–∏–≤–∞–º
5. `/api/utm/funnel/` - –≤–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–π
6. `/api/utm/geo/` - –≥–µ–æ–≥—Ä–∞—Ñ–∏—è
7. `/api/utm/devices/` - —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
8. `/api/utm/browsers/` - –±—Ä–∞—É–∑–µ—Ä—ã
9. `/api/utm/operating-systems/` - –û–°
10. `/api/utm/returning-visitors/` - –≤–æ–∑–≤—Ä–∞—Ç—ã
11. `/api/utm/sessions/` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏
12. `/api/utm/{id}/session-detail/` - –¥–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–∏
13. `/api/utm/compare/` - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤
14. `/api/utm/roi/` - —Ä–∞—Å—á–µ—Ç ROI
15. `/api/utm/cohort-analysis/` - –∫–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ ‚≠ê NEW
16. `/api/utm/ltv-comparison/` - LTV —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ ‚≠ê NEW
17. `/api/utm/repeat-rate/` - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ ‚≠ê NEW
18. `/api/utm/ab-test/` - A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚≠ê NEW

**–≠–∫—Å–ø–æ—Ä—Ç:**
- `/api/utm/export-csv/` - —ç–∫—Å–ø–æ—Ä—Ç –≤ CSV (4 —Ç–∏–ø–∞)

---

#### 4. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Admin Panel

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ:**
- LTV —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (–¢–æ–ø-5)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫:
  - –ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫
  - –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
  - –°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–∫–∞–∑–∞–º–∏ (–¥–Ω–∏)

**–û–±–Ω–æ–≤–ª–µ–Ω context –≤ `_build_dispatcher_context()`:**
```python
context = {
    ...
    'ltv_comparison': get_source_ltv_comparison(period)[:5],
    'repeat_rate': get_repeat_purchase_rate(period),
    ...
}
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Ç–æ–≥–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã (v3.0):**
- ‚úÖ `utm_cohort_analysis.py` - 450+ —Å—Ç—Ä–æ–∫
- ‚úÖ `management/commands/send_utm_report.py` - 495 —Å—Ç—Ä–æ–∫
- ‚úÖ `setup_utm_email_reports.sh` - 150 —Å—Ç—Ä–æ–∫

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- ‚úÖ `utm_api_views.py` - +120 —Å—Ç—Ä–æ–∫ (4 –Ω–æ–≤—ã—Ö endpoint)
- ‚úÖ `views/admin.py` - +15 —Å—Ç—Ä–æ–∫ (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–≥–æ—Ä—Ç)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è - –æ–±–Ω–æ–≤–ª–µ–Ω–∞

### –ò—Ç–æ–≥–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã:

| –ú–µ—Ç—Ä–∏–∫–∞ | v1.0 | v2.0 | v3.0 |
|---------|------|------|------|
| **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞** | 1800 | 3000 | 4200+ |
| **API Endpoints** | 0 | 13 | 18 |
| **Management Commands** | 0 | 0 | 1 |
| **Shell Scripts** | 0 | 0 | 1 |
| **–¢–∏–ø–æ–≤ —ç–∫—Å–ø–æ—Ä—Ç–∞** | 0 | 4 | 4 |
| **–ì—Ä–∞—Ñ–∏–∫–æ–≤** | 0 | 2 | 2 |
| **–ú–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω** | 0 | 1 | 1 |
| **–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–≤** | 0 | 1 | 1 |
| **–§—É–Ω–∫—Ü–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏** | 10 | 12 | 16 |

---

## üéì –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

### 1. –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω:**
- –ü–æ–Ω—è—Ç—å retention –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –Ω–µ–¥–µ–ª—è–º/–º–µ—Å—è—Ü–∞–º
- –°—Ä–∞–≤–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç—Ä–∞—Ñ–∏–∫–∞
- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π LTV –ø–æ –∫–æ–≥–æ—Ä—Ç–∞–º
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ —Ä–∞—Å—Ö–æ–¥—ã

**–ü—Ä–∏–º–µ—Ä: Retention –∞–Ω–∞–ª–∏–∑ Facebook –∫–∞–º–ø–∞–Ω–∏–∏**

```python
from storefront.utm_cohort_analysis import get_cohort_analysis
from django.utils import timezone
from datetime import timedelta

# –ê–Ω–∞–ª–∏–∑ retention –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 –¥–Ω–µ–π
data = get_cohort_analysis(
    start_date=timezone.now() - timedelta(days=60),
    end_date=timezone.now(),
    cohort_type='week',
    metric='retention',
    utm_source='facebook'
)

# –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:
# cohorts[0] = '2024-12-01' - –∫–æ–≥–æ—Ä—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏—à–ª–∞ –≤ —ç—Ç—É –Ω–µ–¥–µ–ª—é
# matrix[0] = [100, 45, 32, 25, 20] - retention –ø–æ –Ω–µ–¥–µ–ª—è–º
# 100% - –Ω–µ–¥–µ–ª—è 0 (–ø–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ)
# 45% - –Ω–µ–¥–µ–ª—è 1 (–≤–µ—Ä–Ω—É–ª–∏—Å—å —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é)
# 32% - –Ω–µ–¥–µ–ª—è 2 (–≤–µ—Ä–Ω—É–ª–∏—Å—å —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏)
```

**–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è retention:**
- ‚úÖ –•–æ—Ä–æ—à–∏–π retention: > 40% —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é, > 20% —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü
- ‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π retention: 20-40% —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é, 10-20% —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü
- ‚ùå –ü–ª–æ—Ö–æ–π retention: < 20% —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é, < 10% —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü

**–ü—Ä–∏–º–µ—Ä: LTV –∞–Ω–∞–ª–∏–∑**

```python
# LTV –ø–æ –∫–æ–≥–æ—Ä—Ç–∞–º
data = get_cohort_analysis(
    start_date=timezone.now() - timedelta(days=90),
    end_date=timezone.now(),
    cohort_type='month',
    metric='ltv'
)

# matrix[0] = [1200, 2500, 3200, 3500] - –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ã–π LTV –≤ –≥—Ä–Ω
# –ö–æ–≥–æ—Ä—Ç–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞ 3500 –≥—Ä–Ω –∑–∞ 3 –º–µ—Å—è—Ü–∞
# LTV –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è = 3500 / —Ä–∞–∑–º–µ—Ä –∫–æ–≥–æ—Ä—Ç—ã
```

---

### 2. LTV –°—Ä–∞–≤–Ω–µ–Ω–∏–µ

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω:**
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∞–º—ã–µ —Ü–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å max CPA (Cost Per Acquisition) –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- –ü—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```python
from storefront.utm_cohort_analysis import get_source_ltv_comparison

ltv_data = get_source_ltv_comparison('month')

for source in ltv_data[:5]:
    print(f"""
    –ò—Å—Ç–æ—á–Ω–∏–∫: {source['utm_source']}
    LTV –Ω–∞ —Å–µ—Å—Å–∏—é: {source['ltv_per_session']} –≥—Ä–Ω
    –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {source['avg_order_value']} –≥—Ä–Ω
    –ó–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å–µ—Å—Å–∏—é: {source['orders_per_session']}
    
    üëâ –ú–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –¥–æ {source['ltv_per_session'] * 0.7} –≥—Ä–Ω –Ω–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ
    """)
```

**–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:**
- –ï—Å–ª–∏ `ltv_per_session` > `CPA` ‚Üí –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏–±—ã–ª—å–Ω—ã–π ‚úÖ
- –ï—Å–ª–∏ `orders_per_session` > 1 ‚Üí –≤—ã—Å–æ–∫–∏–π repeat rate ‚úÖ
- –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Å `avg_order_value` –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è

---

### 3. –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω:**
- –û—Ü–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç–∞
- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π LTV
- –°–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É

**–ü—Ä–∏–º–µ—Ä:**

```python
from storefront.utm_cohort_analysis import get_repeat_purchase_rate

# –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
repeat = get_repeat_purchase_rate('month')
print(f"""
–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏: {repeat['repeat_rate']}%
–°—Ä–µ–¥–Ω–∏—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞: {repeat['avg_orders_per_customer']}
–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–∫–∞–∑–∞–º–∏: {repeat['avg_time_between_orders']} –¥–Ω–µ–π
""")

# –ü–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É Facebook
repeat_fb = get_repeat_purchase_rate('month', utm_source='facebook')
print(f"Facebook repeat rate: {repeat_fb['repeat_rate']}%")
```

**–ë–µ–Ω—á–º–∞—Ä–∫–∏:**
- üü¢ –û—Ç–ª–∏—á–Ω–æ: repeat rate > 30%
- üü° –•–æ—Ä–æ—à–æ: repeat rate 15-30%
- üü† –°—Ä–µ–¥–Ω–µ: repeat rate 5-15%
- üî¥ –ü–ª–æ—Ö–æ: repeat rate < 5%

**–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–∫–∞–∑–∞–º–∏:**
- < 30 –¥–Ω–µ–π - –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ (–æ–¥–µ–∂–¥–∞)
- 30-60 –¥–Ω–µ–π - —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ
- > 60 –¥–Ω–µ–π - —Å–µ–∑–æ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã

---

### 4. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω:**
- –°—Ä–∞–≤–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–∑–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è A/B —Ç–µ—Å—Ç–∞
- –û—Ü–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫—É—é –∑–Ω–∞—á–∏–º–æ—Å—Ç—å

**–ü—Ä–∏–º–µ—Ä:**

```python
from storefront.utm_cohort_analysis import get_campaign_ab_test_results

# A/B —Ç–µ—Å—Ç –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –¥–ª—è –∫–∞–º–ø–∞–Ω–∏–∏ "winter_sale"
results = get_campaign_ab_test_results('winter_sale_2025', 'week')

print(f"–ö–∞–º–ø–∞–Ω–∏—è: {results['campaign']}")
print(f"–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: {results['winner']}")
print(f"–£–ª—É—á—à–µ–Ω–∏–µ: +{results['winner_lift']}%")

for variant in results['variants']:
    print(f"""
    –í–∞—Ä–∏–∞–Ω—Ç: {variant['utm_content']}
    –°–µ—Å—Å–∏–π: {variant['sessions']}
    CR%: {variant['conversion_rate']}%
    –î–æ—Ö–æ–¥: {variant['revenue']} –≥—Ä–Ω
    Confidence: {variant['confidence']}%
    """)
```

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ó–∞–ø—É—Å—Ç–∏—Ç–µ 2+ –∫—Ä–µ–∞—Ç–∏–≤–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ `utm_content`:
  - `utm_content=video_ad_1`
  - `utm_content=image_ad_1`
- –î–∞–π—Ç–µ –Ω–∞–±—Ä–∞—Ç—å—Å—è –º–∏–Ω–∏–º—É–º 100+ —Å–µ—Å—Å–∏–π –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —á–µ—Ä–µ–∑ API
- –ï—Å–ª–∏ `winner_lift` > 10% –∏ `confidence` > 90% ‚Üí –º–∞—Å—à—Ç–∞–±–∏—Ä—É–π—Ç–µ

---

### 5. Email –æ—Ç—á–µ—Ç—ã

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤:**

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
./setup_utm_email_reports.sh

# 2. –£–∫–∞–∂–∏—Ç–µ email
Email: marketing@twocomms.shop

# 3. –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å—Ç–æ—Ç—É
–í—ã–±–æ—Ä (1-3): 2  # –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ

# 4. CSV?
–ü—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å CSV —Ñ–∞–π–ª—ã? y

# 5. –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç —Å–µ–π—á–∞—Å? y
```

**–†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ crontab:**

```bash
crontab -e

# –î–æ–±–∞–≤—å—Ç–µ:
# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞–º –≤ 9:00
0 9 * * 1 cd /home/twocomms && .venv/bin/python twocomms/manage.py send_utm_report --period week --recipients marketing@twocomms.shop --attach-csv >> logs/utm_email_reports.log 2>&1
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

```bash
# Dry run (–±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏)
python manage.py send_utm_report --period week --recipients test@example.com --dry-run

# –†–µ–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
python manage.py send_utm_report --period today --recipients admin@example.com

# –° CSV –≤–ª–æ–∂–µ–Ω–∏—è–º–∏
python manage.py send_utm_report --period month --recipients boss@example.com --attach-csv
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

**Python –ø–∞–∫–µ—Ç—ã (—É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã):**
- Django REST Framework ‚úÖ
- user-agents (–¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ UA) ‚úÖ
- PyYAML (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è GeoIP) ‚úÖ

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è:**
- Celery –ù–ï –Ω—É–∂–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ–º cron + management commands)
- Redis –ù–ï –Ω—É–∂–µ–Ω –¥–ª—è –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- WebSockets –ù–ï –Ω—É–∂–Ω—ã (AJAX –¥–ª—è live-updates)

### Email –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

**–î–æ–±–∞–≤—å—Ç–µ –≤ `settings.py` (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç):**

```python
# Email backend –¥–ª—è production
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = os.environ.get('EMAIL_HOST', 'smtp.gmail.com')
EMAIL_PORT = int(os.environ.get('EMAIL_PORT', '587'))
EMAIL_USE_TLS = True
EMAIL_HOST_USER = os.environ.get('EMAIL_HOST_USER', '')
EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_HOST_PASSWORD', '')
DEFAULT_FROM_EMAIL = os.environ.get('DEFAULT_FROM_EMAIL', 'noreply@twocomms.shop')

# –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ (–≤—ã–≤–æ–¥–∏—Ç –≤ –∫–æ–Ω—Å–æ–ª—å)
# EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
```

**Environment variables:**

```bash
# –í .env –¥–æ–±–∞–≤—å—Ç–µ:
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
DEFAULT_FROM_EMAIL=noreply@twocomms.shop
```

---

## üéØ Use Cases –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –±—é–¥–∂–µ—Ç–∞

**–ó–∞–¥–∞—á–∞:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∞–º—ã–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

**–®–∞–≥–∏:**
1. –ü–æ–ª—É—á–∏—Ç—å LTV —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ:
```python
ltv_data = get_source_ltv_comparison('month')
```

2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å max CPA –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞:
```python
for source in ltv_data:
    max_cpa = source['ltv_per_session'] * 0.7  # 70% –æ—Ç LTV - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π CPA
    print(f"{source['utm_source']}: max CPA = {max_cpa} –≥—Ä–Ω")
```

3. –°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏:
```python
# –ï—Å–ª–∏ CPA < max_cpa ‚Üí –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º
# –ï—Å–ª–∏ CPA > max_cpa ‚Üí –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –∏–ª–∏ –æ—Ç–∫–ª—é—á–∞–µ–º
```

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: A/B —Ç–µ—Å—Ç –Ω–æ–≤—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

**–ó–∞–¥–∞—á–∞:** –í—ã–±—Ä–∞—Ç—å –ª—É—á—à–∏–π –∫—Ä–µ–∞—Ç–∏–≤ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

**–®–∞–≥–∏:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å 2 –∫—Ä–µ–∞—Ç–∏–≤–∞:
   - –í–∏–¥–µ–æ: `utm_content=video_winter_1`
   - –§–æ—Ç–æ: `utm_content=image_winter_1`

2. –ß–µ—Ä–µ–∑ 3-5 –¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
```bash
curl "https://twocomms.shop/api/utm/ab-test/?campaign=winter_sale&period=week"
```

3. –ï—Å–ª–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω (lift > 10%):
   - –í—ã–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏–π –∫—Ä–µ–∞—Ç–∏–≤
   - –£–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –Ω–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
   - –°–æ–∑–¥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞

**–ó–∞–¥–∞—á–∞:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –ø–æ email

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```bash
# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
./setup_utm_email_reports.sh

# –í—ã–±—Ä–∞—Ç—å:
# - Email: boss@twocomms.shop
# - –ß–∞—Å—Ç–æ—Ç–∞: –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
# - CSV: –î–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 9:00 –Ω–∞ email –ø—Ä–∏–¥–µ—Ç:
- HTML –æ—Ç—á–µ—Ç —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∑–∞ –Ω–µ–¥–µ–ª—é
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–µ–¥–µ–ª–µ–π
- CSV —Ñ–∞–π–ª—ã —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–Ω—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä

---

## üìà KPI –∏ –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –î–ª—è –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞:

1. **LTV/CPA ratio > 3x** - –ø—Ä–∏–±—ã–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
2. **Repeat rate > 20%** - –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫
3. **Retention Week 1 > 30%** - —Ö–æ—Ä–æ—à–µ–µ —É–¥–µ—Ä–∂–∞–Ω–∏–µ
4. **ROI > 150%** - –æ—Ç–ª–∏—á–Ω–∞—è –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å

### –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:

1. **API response time < 500ms** - –±—ã—Å—Ç—Ä–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
2. **Cohort coverage > 80%** - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
3. **Email delivery rate = 100%** - –æ—Ç—á–µ—Ç—ã –¥–æ—Ö–æ–¥—è—Ç
4. **Data freshness < 5 min** - –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

---

## üöÄ Roadmap v4.0 (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
- [ ] **Dashboard –≤–∏–¥–∂–µ—Ç—ã** (drag & drop layout)
- [ ] **Real-time WebSocket updates** (Django Channels)
- [ ] **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Meta Ads API** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤)
- [ ] **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Google Ads API** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤)

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
- [ ] **Cohort heat maps** (–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è retention)
- [ ] **Automated insights** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
- [ ] **Multi-touch attribution** (—É—á–µ—Ç –≤—Å–µ—Ö –∫–∞—Å–∞–Ω–∏–π –≤ –≤–æ—Ä–æ–Ω–∫–µ)
- [ ] **Predictive LTV** (ML –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ)

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
- [ ] **Excel export** (—Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- [ ] **PDF reports** (–∫—Ä–∞—Å–∏–≤—ã–µ –æ—Ç—á–µ—Ç—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
- [ ] **Slack integration** (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Slack)
- [ ] **Telegram bot** (–æ—Ç—á–µ—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram)

---

## üéì Best Practices

### 1. Naming Conventions –¥–ª—è UTM:

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```
utm_source=facebook
utm_medium=cpc
utm_campaign=winter_sale_2025
utm_content=video_ad_1
utm_term=women_clothing
```

**–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
```
utm_source=Facebook Ads  ‚ùå (–ø—Ä–æ–±–µ–ª—ã, –∑–∞–≥–ª–∞–≤–Ω—ã–µ)
utm_medium=CPC Traffic   ‚ùå (–ø—Ä–æ–±–µ–ª—ã)
utm_campaign=–ó–∏–º–∞ 2025   ‚ùå (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã)
```

### 2. –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑:

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `week` –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π (e-commerce)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `month` –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –ú–∏–Ω–∏–º—É–º 3-5 –∫–æ–≥–æ—Ä—Ç –¥–ª—è –Ω–∞–¥–µ–∂–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤
- –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ –∫–æ–≥–æ—Ä—Ç—ã –∏–∑ –æ–¥–Ω–æ–≥–æ —Å–µ–∑–æ–Ω–∞

### 3. Email –æ—Ç—á–µ—Ç—ã:

- –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ - –¥–ª—è –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–≤ (–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
- –ï–∂–µ–º–µ—Å—è—á–Ω–æ - –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ (—Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è)
- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏
- –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π—Ç–µ CSV –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

### 4. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

- –ú–∏–Ω–∏–º—É–º 100 —Å–µ—Å—Å–∏–π –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–µ –±–æ–ª–µ–µ 3-4 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –î–∞–π—Ç–µ —Ç–µ—Å—Ç—É –º–∏–Ω–∏–º—É–º 3-5 –¥–Ω–µ–π
- –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ confidence > 90%

---

## üìû Troubleshooting

### Email –æ—Ç—á–µ—Ç—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ email**
```bash
python manage.py shell
>>> from django.core.mail import send_mail
>>> send_mail('Test', 'Test message', 'from@example.com', ['to@example.com'])
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –õ–æ–≥–∏**
```bash
tail -f logs/utm_email_reports.log
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 3: Cron**
```bash
crontab -l  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
grep CRON /var/log/syslog  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```

### API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ:

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ**
```bash
python manage.py shell
>>> from storefront.models import UTMSession
>>> UTMSession.objects.count()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥**
```bash
curl "https://twocomms.shop/api/utm/general-stats/?period=all_time"
```

### –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã–π:

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
1. –£–º–µ–Ω—å—à–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç (start_date / end_date)
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `cohort_type='month'` –≤–º–µ—Å—Ç–æ 'day'
3. –î–æ–±–∞–≤—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä `utm_source`
4. –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î:

```python
python manage.py dbshell
CREATE INDEX idx_utm_first_seen_source ON storefront_utmsession(first_seen, utm_source);
CREATE INDEX idx_utm_last_seen ON storefront_utmsession(last_seen);
```

---

## ‚úÖ Checklist —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [x] –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (4 –º–µ—Ç—Ä–∏–∫–∏: retention, ltv, orders, revenue)
- [x] LTV —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
- [x] –ê–Ω–∞–ª–∏–∑ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫
- [x] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤
- [x] Email –æ—Ç—á–µ—Ç—ã (HTML + Text + CSV)
- [x] Management command send_utm_report
- [x] Setup script –¥–ª—è email –æ—Ç—á–µ—Ç–æ–≤
- [x] 4 –Ω–æ–≤—ã—Ö API endpoints
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ admin panel
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–ø–æ–ª–Ω–∞—è)
- [x] Best practices
- [x] Troubleshooting guide
- [x] Use cases –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**UTM Dispatcher v3.0** - —ç—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å:
- üìä –ö–æ–≥–æ—Ä—Ç–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º
- üí∞ LTV –∏ ROI –º–µ—Ç—Ä–∏–∫–∞–º–∏
- üìß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ—Ç—á–µ—Ç–∞–º–∏
- üß™ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- üöÄ 18 API endpoints
- üìà 4200+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- ‚ú® Production-ready

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production!** üéØ

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –í–Ω–µ–¥—Ä–µ–Ω–∏–µ Real-time updates –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏ (v4.0)

---

**–í–µ—Ä—Å–∏—è:** 3.0 (Final)  
**–î–∞—Ç–∞:** 2025-01-30  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready  
**–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è + API + Email –æ—Ç—á–µ—Ç—ã

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–ü—Ä–æ–µ–∫—Ç:** TwoComms.shop UTM Dispatcher
