# 🔄 ВИЗУАЛЬНАЯ СХЕМА: Lead vs Purchase

## 📊 ПОТОК 1: ЗАЯВКА (LEAD)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ НА САЙТЕ                         │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. Заполняет форму заказа:                                      │
│     - ФИО: Іван Петренко                                         │
│     - Телефон: +380501234567                                     │
│     - Город: Київ                                                │
│     - Отделение НП: Відділення №5                                │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. Нажимает "Оформити замовлення"                               │
│     НЕ выбирает оплату картой                                    │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. BACKEND: create_order()                                      │
│     ✅ Создается Order                                           │
│     ✅ order.payment_status = 'unpaid'                           │
│     ✅ order.status = 'new'                                      │
│     ✅ Telegram уведомление менеджеру                            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. REDIRECT: /orders/success/123/                               │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. СТРАНИЦА: order_success.html                                 │
│     📄 Текст: "Ваша заявка відправлена в обробку"               │
│     📄 "Менеджер зв'яжеться з вами найближчим часом"            │
│     📊 Статус: "Не оплачено"                                     │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. JAVASCRIPT: Проверяет payment_status                         │
│     ❓ payment_status = 'unpaid'                                 │
│     ❓ isPaid = false                                            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. ОТПРАВКА СОБЫТИЙ                                             │
│                                                                   │
│  📋 Facebook Pixel:                                              │
│     fbq('track', 'Lead', {                                       │
│       value: 1599.00,                                            │
│       currency: 'UAH',                                           │
│       content_name: 'Order TWC...',                              │
│       content_category: 'order_lead'                             │
│     }, {                                                         │
│       em: 'user@example.com',    ← Advanced Matching            │
│       ph: '380501234567',                                        │
│       fn: 'іван',                                                │
│       ln: 'петренко',                                            │
│       ct: 'київ'                                                 │
│     })                                                           │
│                                                                   │
│  📊 Google Tag Manager:                                          │
│     dataLayer.push({                                             │
│       event: 'lead',                                             │
│       lead_data: {                                               │
│         order_id: 'TWC...',                                      │
│         value: 1599.00,                                          │
│         currency: 'UAH',                                         │
│         payment_status: 'unpaid'                                 │
│       },                                                         │
│       user_data: { ... }         ← Enhanced Conversions         │
│     })                                                           │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. РЕЗУЛЬТАТ                                                     │
│     ✅ Lead зарегистрирован в Facebook                           │
│     ✅ Lead зарегистрирован в Google Ads (если настроен)         │
│     ✅ Менеджер получил Telegram уведомление                     │
│     ⏳ Менеджер должен позвонить клиенту                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 💳 ПОТОК 2: ПОКУПКА (PURCHASE)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ НА САЙТЕ                         │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. Заполняет форму заказа:                                      │
│     - ФИО: Іван Петренко                                         │
│     - Телефон: +380501234567                                     │
│     - Город: Київ                                                │
│     - Отделение НП: Відділення №5                                │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. Нажимает "Оформити замовлення"                               │
│     ✅ ВЫБИРАЕТ оплату картой (MonoPay)                          │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. BACKEND: create_order()                                      │
│     ✅ Создается Order                                           │
│     ✅ order.payment_status = 'unpaid' (пока)                    │
│     ✅ order.status = 'new'                                      │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. REDIRECT: MonoPay страница оплаты                            │
│     💳 Вводит данные карты                                       │
│     💳 Подтверждает оплату                                       │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. MonoPay обрабатывает платеж                                  │
│     💰 Деньги списаны                                            │
│     📤 MonoPay отправляет WEBHOOK на сервер                      │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. BACKEND: monobank_webhook()                                  │
│     ✅ Получает подтверждение оплаты                             │
│     ✅ Обновляет order.payment_status = 'paid'                   │
│     ✅ Обновляет order.status = 'confirmed'                      │
│     ✅ Telegram уведомление об оплате                            │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. REDIRECT: /orders/success/123/                               │
│     (через payment_callback или monobank_return)                 │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. СТРАНИЦА: order_success.html                                 │
│     📄 Текст: "✅ Оплата успішно пройшла!"                       │
│     📄 "Ваше замовлення оплачено через Monobank"                 │
│     📊 Статус: "Оплачено" (зеленый badge)                        │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  9. JAVASCRIPT: Проверяет payment_status                         │
│     ❓ payment_status = 'paid'                                   │
│     ❓ isPaid = true                                             │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  10. ОТПРАВКА СОБЫТИЙ                                            │
│                                                                   │
│  ✅ Facebook Pixel:                                              │
│     fbq('track', 'Purchase', {                                   │
│       value: 1599.00,                                            │
│       currency: 'UAH',                                           │
│       contents: [{id: '123', quantity: 2}, ...],                 │
│       content_type: 'product'                                    │
│     }, {                                                         │
│       em: 'user@example.com',    ← Advanced Matching            │
│       ph: '380501234567',                                        │
│       fn: 'іван',                                                │
│       ln: 'петренко',                                            │
│       ct: 'київ'                                                 │
│     })                                                           │
│                                                                   │
│  ✅ Google Tag Manager:                                          │
│     dataLayer.push({                                             │
│       event: 'purchase',                                         │
│       ecommerce: {                                               │
│         transaction_id: 'TWC...',                                │
│         value: 1599.00,                                          │
│         currency: 'UAH',                                         │
│         items: [...]                                             │
│       },                                                         │
│       user_data: { ... }         ← Enhanced Conversions         │
│     })                                                           │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│  11. РЕЗУЛЬТАТ                                                    │
│     ✅ Purchase зарегистрирован в Facebook                       │
│     ✅ Purchase зарегистрирован в Google Ads                     │
│     ✅ ROAS рассчитан правильно                                  │
│     ✅ Менеджер получил уведомление об оплате                    │
│     🚀 Заказ отправляется в обработку                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔀 СРАВНЕНИЕ: ДО И ПОСЛЕ

### ❌ ДО ИСПРАВЛЕНИЯ:

```
┌───────────┐          ┌──────────────┐
│  Заявка   │  ──────→ │   Purchase   │  ← НЕПРАВИЛЬНО!
│ (unpaid)  │          │   Event      │
└───────────┘          └──────────────┘

┌───────────┐          ┌──────────────┐
│  Покупка  │  ──────→ │   Purchase   │  ← Правильно
│  (paid)   │          │   Event      │
└───────────┘          └──────────────┘

ПРОБЛЕМА: Оба отправляют Purchase → статистика искажена
```

### ✅ ПОСЛЕ ИСПРАВЛЕНИЯ:

```
┌───────────┐          ┌──────────────┐
│  Заявка   │  ──────→ │     Lead     │  ✅ ПРАВИЛЬНО!
│ (unpaid)  │          │    Event     │
└───────────┘          └──────────────┘

┌───────────┐          ┌──────────────┐
│  Покупка  │  ──────→ │   Purchase   │  ✅ ПРАВИЛЬНО!
│  (paid)   │          │    Event     │
└───────────┘          └──────────────┘

РЕШЕНИЕ: Разные события → точная статистика
```

---

## 📊 ВОРОНКА КОНВЕРСИИ

```
┌─────────────────────────────────────────────────────────────────┐
│                        РЕКЛАМНАЯ КАМПАНИЯ                        │
│                      (Facebook Ads / Google Ads)                 │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     КЛИК ПО ОБЪЯВЛЕНИЮ                           │
│                      Трафик на сайт                              │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ПРОСМОТР ТОВАРА                               │
│              ViewContent Event (уже работает)                    │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                 ДОБАВЛЕНИЕ В КОРЗИНУ                             │
│              AddToCart Event (уже работает)                      │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│               НАЧАЛО ОФОРМЛЕНИЯ ЗАКАЗА                           │
│            InitiateCheckout Event (уже работает)                 │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                  ┌────────┴────────┐
                  │                 │
                  ▼                 ▼
      ┌─────────────────┐  ┌─────────────────┐
      │   БЕЗ ОПЛАТЫ    │  │   С ОПЛАТОЙ     │
      │                 │  │                 │
      │  📋 Lead Event  │  │ ✅ Purchase     │
      │  ✅ НОВОЕ!      │  │    Event        │
      │                 │  │                 │
      │  payment_status │  │  payment_status │
      │  = unpaid       │  │  = paid         │
      └────────┬────────┘  └────────┬────────┘
               │                    │
               ▼                    │
      ┌─────────────────┐           │
      │ Звонок менеджера│           │
      │                 │           │
      │  ⏱ Конверсия:  │           │
      │  Lead→Purchase  │           │
      └────────┬────────┘           │
               │                    │
               └───────┬────────────┘
                       │
                       ▼
              ┌─────────────────┐
              │   ВЫПОЛНЕНИЕ    │
              │    ЗАКАЗА       │
              │                 │
              │ - Подготовка    │
              │ - Отправка      │
              │ - Доставка      │
              └─────────────────┘
```

---

## 💰 РАСЧЕТ ROAS

### ❌ ДО ИСПРАВЛЕНИЯ:

```
Заявки (unpaid): 100 шт × 0 грн = 0 грн
Покупки (paid):   50 шт × 1500 грн = 75,000 грн

Facebook считал:
Purchase события: 150 шт (100 Lead + 50 Purchase)
Доход: 75,000 грн
ROAS = 75,000 грн / Рекламный бюджет

❌ ПРОБЛЕМА: Facebook считал что 150 покупок, 
   но реально только 50!
```

### ✅ ПОСЛЕ ИСПРАВЛЕНИЯ:

```
Заявки (unpaid): 100 шт → Lead Event
Покупки (paid):   50 шт → Purchase Event

Facebook считает:
Lead события:     100 шт
Purchase события:  50 шт
Доход: 75,000 грн
ROAS = 75,000 грн / Рекламный бюджет

✅ ПРАВИЛЬНО: Facebook видит реальные цифры!

+ Можно оптимизировать конверсию Lead → Purchase
+ Можно создать ретаргетинг на Lead без Purchase
+ Можно анализировать качество менеджеров
```

---

## 🎯 СТРАТЕГИЯ ОПТИМИЗАЦИИ

```
┌─────────────────────────────────────────────────────────────────┐
│                     КАМПАНИЯ 1: LEAD                             │
│                                                                   │
│  Цель: Получить максимум заявок (Lead)                           │
│  Оптимизация: Lead Event                                         │
│  Ставка: Низкая (например, 100-150 грн за Lead)                 │
│  Аудитория: Широкая (холодный трафик)                            │
│  KPI: CPL (Cost Per Lead)                                        │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   МЕНЕДЖЕР ОБРАБАТЫВАЕТ                          │
│                                                                   │
│  - Звонит клиентам с Lead                                        │
│  - Подтверждает заказ                                            │
│  - Конвертирует Lead → Purchase                                  │
│                                                                   │
│  KPI: Конверсия Lead → Purchase                                  │
│  Цель: > 40% конверсия                                           │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   КАМПАНИЯ 2: PURCHASE                           │
│                                                                   │
│  Цель: Максимизировать оплаченные покупки                        │
│  Оптимизация: Purchase Event                                     │
│  Ставка: Высокая (например, 500-800 грн за Purchase)            │
│  Аудитория:                                                      │
│    1. Ретаргетинг Lead без Purchase (прошло > 2 дней)           │
│    2. Lookalike от Purchase (не Lead!)                           │
│    3. Теплый трафик (были на сайте)                              │
│  KPI: ROAS (Return on Ad Spend)                                  │
│  Цель: ROAS > 3.0                                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔍 ЛОГИКА ПРОВЕРКИ В КОДЕ

```javascript
// order_success.html, строка ~135

var paymentStatus = el.dataset.paymentStatus;  // 'paid' или 'unpaid'
var isPaid = paymentStatus === 'paid';

if (isPaid) {
  // ========================================
  // СЦЕНАРИЙ A: ОПЛАЧЕННЫЙ ЗАКАЗ
  // ========================================
  
  console.log('✅ Order is PAID');
  
  // Facebook Pixel Purchase
  fbq('track', 'Purchase', {...}, advancedMatchingData);
  
  // GTM Purchase
  dataLayer.push({
    event: 'purchase',
    ecommerce: {...}
  });
  
  console.log('✅ GTM Purchase event sent (PAID)');
  console.log('✅ Meta Pixel Purchase event sent (PAID)');
  
} else {
  // ========================================
  // СЦЕНАРИЙ B: НЕОПЛАЧЕННЫЙ ЗАКАЗ (ЗАЯВКА)
  // ========================================
  
  console.log('📋 Order is UNPAID (Lead)');
  
  // Facebook Pixel Lead
  fbq('track', 'Lead', {...}, advancedMatchingData);
  
  // GTM Lead
  dataLayer.push({
    event: 'lead',
    lead_data: {...}
  });
  
  console.log('📋 GTM Lead event sent (UNPAID)');
  console.log('📋 Meta Pixel Lead event sent (UNPAID)');
}
```

---

**Теперь ваш сайт правильно отслеживает Lead и Purchase! 🎉**

