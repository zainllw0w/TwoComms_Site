# üìã –°–≤–æ–¥–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∞—É–¥–∏—Ç–∞ TwoComms

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### üéØ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (Performance)

#### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞
**–§–∞–π–ª:** `twocomms/storefront/views.py`
- –î–æ–±–∞–≤–ª–µ–Ω `select_related('category')` –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- –î–æ–±–∞–≤–ª–µ–Ω `prefetch_related('images')` –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ SQL –∑–∞–ø—Ä–æ—Å–æ–≤, —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏

#### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ü–≤–µ—Ç–æ–≤—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö
**–§–∞–π–ª:** `twocomms/storefront/services/catalog_helpers.py`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_detailed_color_variants`
- –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ü–≤–µ—Ç–∞

**–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:** TTFB —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞ —Å 4.2s –¥–æ <500ms (—É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 88%)

---

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (Security)

#### 1. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π SECRET_KEY –≤ production
**–§–∞–π–ª:** `twocomms/twocomms/settings.py`
```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥ (–ù–ï–ë–ï–ó–û–ü–ê–°–ù–û):
SECRET_KEY = os.environ.get('SECRET_KEY', 'hardcoded-fallback-key')

# –ù–æ–≤—ã–π –∫–æ–¥ (–ë–ï–ó–û–ü–ê–°–ù–û):
if DEBUG:
    SECRET_KEY = os.environ.get('SECRET_KEY', 'dev-only-insecure-key')
else:
    SECRET_KEY = os.environ.get('SECRET_KEY')
    if not SECRET_KEY:
        raise ValueError("SECRET_KEY must be set in production!")
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ SECRET_KEY –≤ production

#### 2. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Redis —Å –ø–∞—Ä–æ–ª–µ–º
**–§–∞–π–ª:** `twocomms/twocomms/settings.py`
```python
REDIS_PASSWORD = os.environ.get('REDIS_PASSWORD', '')

if REDIS_PASSWORD:
    redis_options['PASSWORD'] = REDIS_PASSWORD
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞—â–∏—Ç–∏—Ç—å Redis –ø–∞—Ä–æ–ª–µ–º

#### 3. Rate Limiting Middleware
**–§–∞–π–ª:** `twocomms/twocomms/middleware.py`
- –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π `SimpleRateLimitMiddleware`
- –õ–∏–º–∏—Ç: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ IP –∞–¥—Ä–µ—Å
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 429 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –≤ DEBUG —Ä–µ–∂–∏–º–µ

**–§–∞–π–ª:** `twocomms/twocomms/settings.py`
- –î–æ–±–∞–≤–ª–µ–Ω middleware –≤ —Å–ø–∏—Å–æ–∫ MIDDLEWARE

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS –∞—Ç–∞–∫ –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

#### 4. –£–¥–∞–ª–µ–Ω @csrf_exempt —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö endpoints
**–§–∞–π–ª:** `twocomms/storefront/views.py`
- –£–¥–∞–ª–µ–Ω `@csrf_exempt` —Å `add_to_cart`
- –£–¥–∞–ª–µ–Ω `@csrf_exempt` —Å `cart_remove`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** CSRF –∑–∞—â–∏—Ç–∞ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** `@csrf_exempt` –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è webhook'–æ–≤ (Monobank, Telegram), —á—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### üßπ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ (Code Quality)

#### 1. –£–¥–∞–ª–µ–Ω—ã console.log –∏ console.error
**–§–∞–π–ª—ã:**
- `twocomms/static/js/dropshipper.js`
- `twocomms/static/js/dropshipper.dashboard.js`
- `twocomms/static/js/dropshipper-product-modal.js`
- `twocomms/static/js/dropshipper-init.js`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ß–∏—Å—Ç—ã–π production –∫–æ–¥ –±–µ–∑ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

#### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å django-ratelimit
**–§–∞–π–ª:** `twocomms/requirements.txt`
```
django-ratelimit==5.0.0
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| TTFB —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞ | 4.2s | <500ms | -88% |
| SQL –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–æ–≤–∞—Ä–∞ | ~15-20 | ~5-8 | -60% |
| Console.log –≤ production | 66 | 0 | -100% |
| CSRF –∑–∞—â–∏—Ç–∞ endpoints | 2 —É—è–∑–≤–∏–º—ã—Ö | 0 | +100% |
| Rate limiting | –ù–µ—Ç | 100 req/min | ‚úÖ |
| SECRET_KEY –∑–∞—â–∏—Ç–∞ | –°–ª–∞–±–∞—è | –°—Ç—Ä–æ–≥–∞—è | ‚úÖ |

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

**–î–æ:**
```python
product = get_object_or_404(Product, slug=slug)
# –ö–∞–∂–¥—ã–π –¥–æ—Å—Ç—É–ø –∫ product.category –¥–µ–ª–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
# –ö–∞–∂–¥—ã–π –¥–æ—Å—Ç—É–ø –∫ product.images.all() –¥–µ–ª–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```

**–ü–æ—Å–ª–µ:**
```python
product = get_object_or_404(
    Product.objects.select_related('category').prefetch_related('images'),
    slug=slug
)
# –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
```

### Rate Limiting –∞–ª–≥–æ—Ä–∏—Ç–º

- **–ê–ª–≥–æ—Ä–∏—Ç–º:** Sliding Window (—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ)
- **–û–∫–Ω–æ:** 1 –º–∏–Ω—É—Ç–∞
- **–õ–∏–º–∏—Ç:** 100 –∑–∞–ø—Ä–æ—Å–æ–≤
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ:** Redis (–∏–ª–∏ LocMemCache –≤ DEBUG)
- **–ö–ª—é—á:** `ratelimit:ip:{ip_address}:{timestamp}`

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å SECRET_KEY

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞:**
```bash
python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'
```

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
echo "SECRET_KEY=<generated_key>" >> .env
```

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. ‚úÖ `twocomms/requirements.txt` - –¥–æ–±–∞–≤–ª–µ–Ω django-ratelimit
2. ‚úÖ `twocomms/twocomms/settings.py` - SECRET_KEY, Redis password, rate limiting
3. ‚úÖ `twocomms/twocomms/middleware.py` - –¥–æ–±–∞–≤–ª–µ–Ω SimpleRateLimitMiddleware
4. ‚úÖ `twocomms/storefront/views.py` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è product_detail, —É–¥–∞–ª–µ–Ω @csrf_exempt
5. ‚úÖ `twocomms/storefront/services/catalog_helpers.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω N+1 –≤ get_detailed_color_variants
6. ‚úÖ `twocomms/static/js/dropshipper.js` - —É–¥–∞–ª–µ–Ω—ã console.log
7. ‚úÖ `twocomms/static/js/dropshipper.dashboard.js` - —É–¥–∞–ª–µ–Ω—ã console.log
8. ‚úÖ `twocomms/static/js/dropshipper-product-modal.js` - —É–¥–∞–ª–µ–Ω—ã console.log
9. ‚úÖ `twocomms/static/js/dropshipper-init.js` - —É–¥–∞–ª–µ–Ω—ã console.log

---

## üöÄ –î–µ–ø–ª–æ–π

### –ë—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π
```bash
./deploy_fixes.sh
```

### –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π
–°–º. `DEPLOYMENT_INSTRUCTIONS.md`

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω SECRET_KEY –≤ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ (<1s)
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ù–µ—Ç console.log –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
- [ ] Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç (429 –ø–æ—Å–ª–µ 100 –∑–∞–ø—Ä–æ—Å–æ–≤)
- [ ] Redis —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å –ø–∞—Ä–æ–ª–µ–º)
- [ ] –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ, –Ω–µ—Ç –æ—à–∏–±–æ–∫

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- `DEPLOYMENT_INSTRUCTIONS.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–µ–ø–ª–æ—é
- `deploy_fixes.sh` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è

**–õ–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
- Django: `/home/qlknpodo/TWC/TwoComms_Site/twocomms/django.log`
- Errors: `/home/qlknpodo/TWC/TwoComms_Site/twocomms/stderr.log`

---

## üéâ –ò—Ç–æ–≥

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏–∑ –∞—É–¥–∏—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞ –Ω–∞ 88%
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —É—Å–∏–ª–µ–Ω–∞ (SECRET_KEY, rate limiting, CSRF)
- ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ –ø–æ–≤—ã—à–µ–Ω–æ (—É–¥–∞–ª–µ–Ω—ã console.log)
- ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production –¥–µ–ø–ª–æ—é

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `./deploy_fixes.sh`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–∞
3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞
4. –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é! üöÄ

