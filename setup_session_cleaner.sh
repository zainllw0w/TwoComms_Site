#!/bin/bash
# ==============================================================================
# –°–ö–†–ò–ü–¢ –£–°–¢–ê–ù–û–í–ö–ò –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô –û–ß–ò–°–¢–ö–ò –°–¢–ê–†–´–• –°–ï–°–°–ò–ô DJANGO
# ==============================================================================
# 
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç cron –∑–∞–¥–∞—á—É –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ—Å—Å–∏–π
# –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Django. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
# –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–æ—Å—Ç–∞ —Ç–∞–±–ª–∏—Ü—ã —Å–µ—Å—Å–∏–π.
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä: scp setup_session_cleaner.sh qlknpodo@195.191.24.169:~/
#   2. –ó–∞–ø—É—Å—Ç–∏—Ç—å: ssh qlknpodo@195.191.24.169 "bash ~/setup_session_cleaner.sh"
#
# –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
#   - –°–æ–∑–¥–∞–µ—Ç –ª–æ–≥-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
#   - –î–æ–±–∞–≤–ª—è–µ—Ç cron –∑–∞–¥–∞—á—É (–µ—Å–ª–∏ –µ—ë –µ—â–µ –Ω–µ—Ç)
#   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ cron –∑–∞–¥–∞—á–∏
#
# ==============================================================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
PROJECT_DIR="/home/qlknpodo/TWC/TwoComms_Site/twocomms"
VENV_PYTHON="/home/qlknpodo/virtualenv/TWC/TwoComms_Site/twocomms/3.13/bin/python"
LOG_DIR="/home/qlknpodo/logs"
LOG_FILE="$LOG_DIR/clearsessions.log"

# Cron –∑–∞–¥–∞—á–∞ (–∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 —É—Ç—Ä–∞)
CRON_COMMAND="0 3 * * * cd $PROJECT_DIR && $VENV_PYTHON manage.py clearsessions >> $LOG_FILE 2>&1"
CRON_COMMENT="# Django: –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–µ—Å—Å–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ $(date +%Y-%m-%d))"

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–µ—Å—Å–∏–π Django${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# 1. –°–æ–∑–¥–∞—Ç—å –ª–æ–≥-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
echo -e "${YELLOW}[1/4]${NC} –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
mkdir -p "$LOG_DIR"
echo -e "${GREEN}‚úì${NC} –õ–æ–≥-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≥–æ—Ç–æ–≤–∞: $LOG_DIR"
echo ""

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ cron –∑–∞–¥–∞—á–∏
echo -e "${YELLOW}[2/4]${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö cron –∑–∞–¥–∞—á..."
EXISTING_CRON=$(crontab -l 2>/dev/null || echo "")

if echo "$EXISTING_CRON" | grep -q "clearsessions"; then
    echo -e "${YELLOW}‚ö†${NC}  Cron –∑–∞–¥–∞—á–∞ –¥–ª—è clearsessions —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    echo ""
    echo "–¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ clearsessions:"
    echo "$EXISTING_CRON" | grep "clearsessions"
    echo ""
    echo -e "${YELLOW}–•–æ—Ç–∏—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å? (y/n)${NC}"
    read -r REPLACE
    
    if [[ "$REPLACE" != "y" ]]; then
        echo -e "${RED}–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º${NC}"
        exit 0
    fi
    
    # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏ clearsessions
    echo -e "${YELLOW}–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á...${NC}"
    NEW_CRON=$(echo "$EXISTING_CRON" | grep -v "clearsessions")
    echo "$NEW_CRON" | crontab -
    echo -e "${GREEN}‚úì${NC} –°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏ —É–¥–∞–ª–µ–Ω—ã"
fi
echo ""

# 3. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é cron –∑–∞–¥–∞—á—É
echo -e "${YELLOW}[3/4]${NC} –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π cron –∑–∞–¥–∞—á–∏..."
(crontab -l 2>/dev/null || echo ""; echo "$CRON_COMMENT"; echo "$CRON_COMMAND") | crontab -
echo -e "${GREEN}‚úì${NC} Cron –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞"
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo -e "${YELLOW}[4/4]${NC} –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
echo ""
echo "–¢–µ–∫—É—â–∏–µ cron –∑–∞–¥–∞—á–∏:"
echo "-------------------------------------------"
crontab -l | grep -A 1 "Django:" || crontab -l
echo "-------------------------------------------"
echo ""

# 5. –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ clearsessions
echo -e "${YELLOW}–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ—á–∏—Å—Ç–∫—É —Å–µ–π—á–∞—Å? (y/n)${NC}"
read -r RUN_TEST

if [[ "$RUN_TEST" == "y" ]]; then
    echo -e "${YELLOW}–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏...${NC}"
    cd "$PROJECT_DIR"
    
    # –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å virtualenv –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
    source /home/qlknpodo/virtualenv/TWC/TwoComms_Site/twocomms/3.13/bin/activate
    python manage.py clearsessions
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úì${NC} –¢–µ—Å—Ç–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    else
        echo -e "${RED}‚úó${NC} –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ clearsessions"
        exit 1
    fi
fi
echo ""

# –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  ‚úì –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
echo "  ‚Ä¢ –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 —É—Ç—Ä–∞"
echo "  ‚Ä¢ –ö–æ–º–∞–Ω–¥–∞: python manage.py clearsessions"
echo "  ‚Ä¢ –õ–æ–≥ —Ñ–∞–π–ª: $LOG_FILE"
echo "  ‚Ä¢ –ü—Ä–æ–µ–∫—Ç: $PROJECT_DIR"
echo ""
echo "–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤:"
echo "  tail -f $LOG_FILE"
echo ""
echo "–î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:"
echo "  cd $PROJECT_DIR && $VENV_PYTHON manage.py clearsessions"
echo ""
echo -e "${GREEN}–ì–æ—Ç–æ–≤–æ! üéâ${NC}"

