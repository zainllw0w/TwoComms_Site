# Исправление Mono-checkout в мини-корзине: полная оплата вместо предоплаты

**Дата:** 2025-01-25
**Статус:** ✅ Завершено и развернуто на продакшен

## Проблема

В мини-корзине при использовании Mono-checkout применялась предоплата 200 гривен вместо полной оплаты заказа.

## Причина

В функции `monobank_create_checkout()` в файле `twocomms/storefront/views.py` для авторизованных пользователей использовалась функция `_prepare_checkout_customer_data()`, которая брала тип оплаты (`pay_type`) из профиля пользователя. Если в профиле был установлен тип оплаты `prepay_200` (предоплата 200 грн), то для мини-корзины также применялась предоплата.

## Решение

Для мини-корзины Mono-checkout добавлена принудительная установка полной оплаты независимо от настроек профиля пользователя:

```python
else:
    customer = _prepare_checkout_customer_data(request)
    # ВАЖНО: Для мини-корзины Mono Checkout всегда используем полную оплату
    # независимо от настроек профиля пользователя
    customer['pay_type'] = 'online_full'
    monobank_logger.info('Forced full payment for mini cart checkout: %s', customer)
```

## Изменения в коде

**Файл:** `twocomms/storefront/views.py`  
**Строки:** 5962-5967

Добавлена логика принудительной установки `pay_type = 'online_full'` для авторизованных пользователей в блоке обработки корзины в функции `monobank_create_checkout()`.

## Развертывание

1. ✅ Изменения добавлены в репозиторий
2. ✅ Закоммичено с сообщением "Fix mini cart Mono checkout: always use full payment instead of prepayment"
3. ✅ Запушено в `origin/main`
4. ✅ Развернуто на продакшен сервере через SSH
5. ✅ Приложение перезапущено (touch wsgi.py)

## Логика типов оплаты

### Поддерживаемые типы:
- `online_full` - полная оплата онлайн (дефолт для мини-корзины)
- `prepay_200` - предоплата 200 грн, остаток при получении

### Поведение в мини-корзине:
- **Всегда** используется полная оплата (`online_full`)
- Не зависит от настроек профиля пользователя
- Не зависит от формы выбора типа оплаты

### Поведение в обычной корзине/чек-ауте:
- Используется тип оплаты из профиля пользователя (для авторизованных)
- Или тип оплаты из формы (для гостей)

## Тестирование

Необходимо проверить:
1. Авторизованный пользователь с типом оплаты `prepay_200` в профиле
2. Использование Mono-checkout в мини-корзине
3. Ожидаемый результат: создается платеж на полную сумму заказа, а не на 200 грн

## Контекст

Эта правка учитывает бизнес-логику, согласно которой мини-корзина предполагает быструю покупку с полной оплатой, в отличие от основной корзины, где пользователь может выбрать тип оплаты.

