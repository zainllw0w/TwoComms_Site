# üìä UTM –î–∏—Å–ø–µ—Ç—á–µ—Ä - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üéØ –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

**UTM –î–∏—Å–ø–µ—Ç—á–µ—Ä** - —ç—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è UTM-–º–µ—Ç–æ–∫ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π –¥–ª—è Django e-commerce –ø—Ä–æ–µ–∫—Ç–∞ TwoComms.

–ü–æ–∑–≤–æ–ª—è–µ—Ç:
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ (Meta, Google Ads, TikTok, etc.)
- ‚úÖ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π
- ‚úÖ –°—Ç—Ä–æ–∏—Ç—å –≤–æ—Ä–æ–Ω–∫—É –∫–æ–Ω–≤–µ—Ä—Å–∏–π
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –ª—É—á—à–∏–µ –∫—Ä–µ–∞—Ç–∏–≤—ã –∏ –∫–∞–Ω–∞–ª—ã
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞—Ç—å data-driven —Ä–µ—à–µ–Ω–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–∫–ª–∞–º—ã

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### –ú–æ–¥–µ–ª–∏ –∏ –ë–î
```
twocomms/storefront/models.py
‚îú‚îÄ‚îÄ UTMSession (—Å—Ç—Ä–æ–∫–∏ 925-1056)
‚îÇ   ‚îú‚îÄ‚îÄ UTM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ –ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ ID
‚îÇ   ‚îú‚îÄ‚îÄ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –±—Ä–∞—É–∑–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤–∏–∑–∏—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ –ö–æ–Ω–≤–µ—Ä—Å–∏–∏
‚îî‚îÄ‚îÄ UserAction (—Å—Ç—Ä–æ–∫–∏ 1059-1132)
    ‚îú‚îÄ‚îÄ –¢–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π (11 —Ç–∏–ø–æ–≤)
    ‚îú‚îÄ‚îÄ –°–≤—è–∑–∏ —Å UTM –∏ Order
    ‚îî‚îÄ‚îÄ –ë–∞–ª–ª—ã

twocomms/orders/models.py
‚îî‚îÄ‚îÄ Order —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∏ 56-70)
    ‚îú‚îÄ‚îÄ utm_session (FK)
    ‚îî‚îÄ‚îÄ utm_* –ø–æ–ª—è (–∫—ç—à)
```

### Backend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
```
twocomms/storefront/
‚îú‚îÄ‚îÄ utm_middleware.py (205 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ UTMTrackingMiddleware
‚îÇ       ‚îú‚îÄ‚îÄ –ó–∞—Ö–≤–∞—Ç UTM –∏–∑ URL
‚îÇ       ‚îú‚îÄ‚îÄ –ó–∞—Ö–≤–∞—Ç platform IDs
‚îÇ       ‚îú‚îÄ‚îÄ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ IP
‚îÇ       ‚îî‚îÄ‚îÄ –ü–∞—Ä—Å–∏–Ω–≥ User-Agent
‚îÇ
‚îú‚îÄ‚îÄ utm_utils.py (377 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ get_client_ip()
‚îÇ   ‚îú‚îÄ‚îÄ get_geolocation()
‚îÇ   ‚îú‚îÄ‚îÄ parse_user_agent()
‚îÇ   ‚îú‚îÄ‚îÄ calculate_action_points()
‚îÇ   ‚îú‚îÄ‚îÄ sanitize_utm_param()
‚îÇ   ‚îî‚îÄ‚îÄ is_bot_user_agent()
‚îÇ
‚îú‚îÄ‚îÄ utm_tracking.py (256 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ record_user_action()
‚îÇ   ‚îú‚îÄ‚îÄ record_add_to_cart()
‚îÇ   ‚îú‚îÄ‚îÄ record_remove_from_cart()
‚îÇ   ‚îú‚îÄ‚îÄ record_initiate_checkout()
‚îÇ   ‚îú‚îÄ‚îÄ record_lead()
‚îÇ   ‚îú‚îÄ‚îÄ record_purchase()
‚îÇ   ‚îú‚îÄ‚îÄ link_order_to_utm()
‚îÇ   ‚îî‚îÄ‚îÄ mark_user_registered()
‚îÇ
‚îî‚îÄ‚îÄ utm_analytics.py (582 —Å—Ç—Ä–æ–∫–∏)
    ‚îú‚îÄ‚îÄ get_general_stats()
    ‚îú‚îÄ‚îÄ get_sources_stats()
    ‚îú‚îÄ‚îÄ get_campaigns_stats()
    ‚îú‚îÄ‚îÄ get_content_stats()
    ‚îú‚îÄ‚îÄ get_funnel_stats()
    ‚îú‚îÄ‚îÄ get_geo_stats()
    ‚îú‚îÄ‚îÄ get_device_stats()
    ‚îú‚îÄ‚îÄ get_browser_stats()
    ‚îú‚îÄ‚îÄ get_os_stats()
    ‚îú‚îÄ‚îÄ get_returning_visitors_stats()
    ‚îî‚îÄ‚îÄ get_recent_sessions()
```

### Views –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
```
twocomms/storefront/views/
‚îú‚îÄ‚îÄ admin.py
‚îÇ   ‚îî‚îÄ‚îÄ _build_dispatcher_context() (—Å—Ç—Ä–æ–∫–∏ 1164-1295)
‚îÇ
‚îú‚îÄ‚îÄ cart.py
‚îÇ   ‚îú‚îÄ‚îÄ add_to_cart() ‚Üí record_add_to_cart()
‚îÇ   ‚îî‚îÄ‚îÄ remove_from_cart() ‚Üí record_remove_from_cart()
‚îÇ
‚îî‚îÄ‚îÄ checkout.py
    ‚îú‚îÄ‚îÄ checkout() ‚Üí record_initiate_checkout()
    ‚îî‚îÄ‚îÄ create_order() ‚Üí link_order_to_utm()

twocomms/accounts/
‚îî‚îÄ‚îÄ ajax_auth_views.py
    ‚îî‚îÄ‚îÄ ajax_register() ‚Üí mark_user_registered()
```

### Frontend
```
twocomms_django_theme/templates/
‚îú‚îÄ‚îÄ pages/admin_panel.html
‚îÇ   ‚îî‚îÄ‚îÄ –ù–∞–≤–∏–≥–∞—Ü–∏—è "–î–∏—Å–ø–µ—Ç—á–µ—Ä" (—Å—Ç—Ä–æ–∫–∏ 101-106)
‚îÇ
‚îî‚îÄ‚îÄ partials/admin_dispatcher_section.html (428 —Å—Ç—Ä–æ–∫)
    ‚îú‚îÄ‚îÄ Header —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
    ‚îú‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ç—Ä–∏–∫ (4 —à—Ç)
    ‚îú‚îÄ‚îÄ –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–π (6 —ç—Ç–∞–ø–æ–≤)
    ‚îú‚îÄ‚îÄ –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (Top 20)
    ‚îú‚îÄ‚îÄ –¢–∞–±–ª–∏—Ü–∞ –∫–∞–º–ø–∞–Ω–∏–π (Top 20)
    ‚îú‚îÄ‚îÄ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—è
    ‚îî‚îÄ‚îÄ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏ (30 —à—Ç)
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```
twocomms/twocomms/settings.py
‚îî‚îÄ‚îÄ MIDDLEWARE (—Å—Ç—Ä–æ–∫–∞ 141)
    ‚îî‚îÄ‚îÄ 'storefront.utm_middleware.UTMTrackingMiddleware'
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏
```
twocomms/storefront/migrations/
‚îî‚îÄ‚îÄ 0033_useraction_utmsession_and_more.py

twocomms/orders/migrations/
‚îî‚îÄ‚îÄ 0037_order_utm_campaign_order_utm_content_and_more.py
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install user-agents pyyaml ua-parser

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–¥–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏):
# pip install geoip2
```

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
python manage.py migrate storefront
python manage.py migrate orders
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# Systemd
sudo systemctl restart twocomms

# –ò–õ–ò touch wsgi
touch twocomms/wsgi.py
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞

–û—Ç–∫—Ä–æ–π—Ç–µ: `https://twocomms.shop/admin-panel?section=dispatcher`

---

## üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –î–ª—è –¥–µ–ø–ª–æ—è
üìÑ **[UTM_DISPATCHER_DEPLOYMENT_GUIDE.md](UTM_DISPATCHER_DEPLOYMENT_GUIDE.md)**
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- –®–∞–≥–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GeoIP2
- Troubleshooting
- SSH –∫–æ–º–∞–Ω–¥—ã

### –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
üìÑ **[UTM_DISPATCHER_TESTING_CHECKLIST.md](UTM_DISPATCHER_TESTING_CHECKLIST.md)**
- –ü–æ–ª–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- Pre-deploy –ø—Ä–æ–≤–µ—Ä–∫–∏
- Post-deploy –ø—Ä–æ–≤–µ—Ä–∫–∏
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- Edge cases
- Performance —Ç–µ—Å—Ç—ã

### –†–µ–∑—é–º–µ
üìÑ **[UTM_DISPATCHER_IMPLEMENTATION_SUMMARY.md](UTM_DISPATCHER_IMPLEMENTATION_SUMMARY.md)**
- –û–±–∑–æ—Ä –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–¥–∞
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production
- KPI –∏ –º–µ—Ç—Ä–∏–∫–∏

### –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
üìÑ **[UTM_TRACKING_SYSTEM_COMPLETE_SPECIFICATION.md](UTM_TRACKING_SYSTEM_COMPLETE_SPECIFICATION.md)**
- –ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã (2354 —Å—Ç—Ä–æ–∫–∏)
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

---

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

#### 1. UTM –≤ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏—è—Ö

**Facebook Ads:**
```
https://twocomms.shop/?utm_source=facebook&utm_medium=cpc&utm_campaign={{campaign.name}}&utm_content={{ad.id}}
```

**Google Ads:**
```
{lpurl}?utm_source=google&utm_medium=cpc&utm_campaign={campaign}&utm_content={creative}&utm_term={keyword}
```

**TikTok Ads:**
```
https://twocomms.shop/?utm_source=tiktok&utm_medium=paid_social&utm_campaign=YOUR_CAMPAIGN&utm_content=ad_id
```

#### 2. –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:
```
https://twocomms.shop/admin-panel?section=dispatcher
```

–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:
- –°—å–æ–≥–æ–¥–Ω—ñ - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
- –¢–∏–∂–¥–µ–Ω—å - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
- –ú—ñ—Å—è—Ü—å - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
- –í–µ—Å—å —á–∞—Å - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ

#### 3. –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö

**–û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏:**
- –í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏
- –ö–æ–Ω–≤–µ—Ä—Å–∏–∏
- CR%
- –î–æ—Ö–æ–¥
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫

**–ü–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º:**
- –ö–∞–∫–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏–Ω–æ—Å–∏—Ç –±–æ–ª—å—à–µ —Ç—Ä–∞—Ñ–∏–∫–∞?
- –ö–∞–∫–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–∞–º—ã–π –∫–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–π?
- –ö–∞–∫–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏–Ω–æ—Å–∏—Ç –±–æ–ª—å—à–µ –¥–æ—Ö–æ–¥–∞?

**–ü–æ –∫–∞–º–ø–∞–Ω–∏—è–º:**
- –ö–∞–∫–∞—è –∫–∞–º–ø–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ?
- –ö–∞–∫–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ç—Å—è –ª—É—á—à–µ?

**–ü–æ –∫—Ä–µ–∞—Ç–∏–≤–∞–º:**
- –ö–∞–∫–æ–π –∫—Ä–µ–∞—Ç–∏–≤ (utm_content) —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ?
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

**–í–æ—Ä–æ–Ω–∫–∞:**
- –ù–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ —Ç–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?
- –ì–¥–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é?

---

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏

1. –°–æ–∑–¥–∞–π—Ç–µ –∫–∞–º–ø–∞–Ω–∏—é —Å UTM:
```
utm_source=facebook
utm_medium=cpc
utm_campaign=new_collection_winter_2025
utm_content=video_ad_1
```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–µ–∫–ª–∞–º—É

3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ:
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Å—Å–∏–π
   - CR%
   - –°—Ä–µ–¥–Ω–∏–π —á–µ–∫

4. –ï—Å–ª–∏ CR% < 2%:
   - –ò–∑–º–µ–Ω–∏—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤
   - –ò–∑–º–µ–Ω–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é
   - –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π utm_content –¥–ª—è A/B —Ç–µ—Å—Ç–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤

1. –°–æ–∑–¥–∞–π—Ç–µ 2 –æ–±—ä—è–≤–ª–µ–Ω–∏—è:
```
# –ö—Ä–µ–∞—Ç–∏–≤ A (–≤–∏–¥–µ–æ)
utm_content=video_ad_winter

# –ö—Ä–µ–∞—Ç–∏–≤ B (—Ñ–æ—Ç–æ)
utm_content=photo_ad_winter
```

2. –ß–µ—Ä–µ–∑ 3-7 –¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ:
   - –ö–∞–∫–æ–π –∫—Ä–µ–∞—Ç–∏–≤ –¥–∞–ª –±–æ–ª—å—à–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–π?
   - –ö–∞–∫–æ–π —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ –≤—ã—à–µ?

3. –£–≤–µ–ª–∏—á—å—Ç–µ –±—é–¥–∂–µ—Ç –Ω–∞ –ª—É—á—à–∏–π –∫—Ä–µ–∞—Ç–∏–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ê–Ω–∞–ª–∏–∑ –≤–æ—Ä–æ–Ω–∫–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–æ—Ä–æ–Ω–∫—É –∫–æ–Ω–≤–µ—Ä—Å–∏–π

2. –°–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–≤–∞–ª–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ:
```
–°–µ—Å—Å–∏–∏: 1000 (100%)
  ‚Üì
–ü—Ä–æ—Å–º–æ—Ç—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤: 600 (60%) ‚Üê 40% –æ—Ç–≤–∞–ª–∞
  ‚Üì
–í –∫–æ—Ä–∑–∏–Ω—É: 200 (20%) ‚Üê 66% –æ—Ç–≤–∞–ª–∞ (–ø–ª–æ—Ö–æ!)
  ‚Üì
–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ: 150 (15%)
  ‚Üì
–õ–∏–¥—ã: 100 (10%)
  ‚Üì
–ü–æ–∫—É–ø–∫–∏: 80 (8%)
```

3. –ï—Å–ª–∏ –±–æ–ª—å—à–æ–π –æ—Ç–≤–∞–ª –Ω–∞ "–í –∫–æ—Ä–∑–∏–Ω—É":
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
   - –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —Ñ–æ—Ç–æ
   - –£–ª—É—á—à–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏—è
   - –î–æ–±–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤—ã

---

## üîç API –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from storefront.utm_analytics import *

# –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
stats = get_general_stats('today')
print(f"–°–µ—Å—Å–∏–π: {stats['total_sessions']}")
print(f"–ö–æ–Ω–≤–µ—Ä—Å–∏–π: {stats['total_conversions']}")
print(f"CR%: {stats['conversion_rate']}")
print(f"–î–æ—Ö–æ–¥: {stats['total_revenue']} –≥—Ä–Ω")

# –¢–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
sources = get_sources_stats('week', limit=10)
for source in sources:
    print(f"{source['utm_source']}: {source['sessions']} —Å–µ—Å—Å–∏–π, CR={source['conversion_rate']}%")

# –í–æ—Ä–æ–Ω–∫–∞
funnel = get_funnel_stats('month')
print(f"–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø–æ–∫—É–ø–∫—É: {funnel['purchase_rate']}%")
```

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤

```python
from storefront.models import UTMSession
from django.db.models import Count, Avg, Sum

# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å: —Ç–æ–ø –∫–∞–º–ø–∞–Ω–∏–π –ø–æ –¥–æ—Ö–æ–¥—É
report = UTMSession.objects.filter(
    is_converted=True,
    orders__payment_status='paid'
).values('utm_campaign').annotate(
    total_revenue=Sum('orders__total_sum'),
    orders_count=Count('orders'),
    avg_order=Avg('orders__total_sum')
).order_by('-total_revenue')[:10]

for item in report:
    print(f"{item['utm_campaign']}: {item['total_revenue']} –≥—Ä–Ω ({item['orders_count']} –∑–∞–∫–∞–∑–æ–≤)")
```

---

## üé® –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏ –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫

#### 1. –í analytics.py –¥–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é:

```python
def get_custom_metric(period: str) -> Dict:
    sessions_qs = UTMSession.objects.all()
    sessions_qs = filter_by_period(sessions_qs, 'first_seen', period)
    
    # –í–∞—à–∞ –ª–æ–≥–∏–∫–∞
    custom_data = sessions_qs.aggregate(
        custom_metric=Count('id')
    )
    
    return {
        'custom_metric': custom_data['custom_metric']
    }
```

#### 2. –í _build_dispatcher_context –¥–æ–±–∞–≤—å—Ç–µ –≤—ã–∑–æ–≤:

```python
context['custom_stats'] = get_custom_metric(period)
```

#### 3. –í —à–∞–±–ª–æ–Ω–µ –¥–æ–±–∞–≤—å—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:

```html
<div class="stat-card">
    <div class="stat-value">{{ custom_stats.custom_metric }}</div>
    <div class="stat-label">–í–∞—à–∞ –º–µ—Ç—Ä–∏–∫–∞</div>
</div>
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π

–í `utm_tracking.py`:

```python
def record_custom_action(request, **kwargs):
    return record_user_action(
        request,
        action_type='custom_action',  # –î–æ–±–∞–≤—å—Ç–µ –≤ UserAction.ACTION_TYPES
        **kwargs
    )
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: UTM –Ω–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. Middleware –¥–æ–±–∞–≤–ª–µ–Ω –≤ settings.py?
2. URL —Å–æ–¥–µ—Ä–∂–∏—Ç UTM-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã?
3. –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö?

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
tail -f /var/log/django/error.log | grep UTM
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∞–¥–º–∏–Ω–∫–µ

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã (–º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã)?
2. –ï—Å—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î?
3. –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π?

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
SELECT COUNT(*) FROM storefront_utmsession;
SELECT COUNT(*) FROM storefront_useraction;
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∞–¥–º–∏–Ω–∫–∏

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
1. –î–æ–±–∞–≤—å—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
2. –£–º–µ–Ω—å—à–∏—Ç–µ limit –¥–ª—è —Ç–∞–±–ª–∏—Ü
3. –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î

```python
# –í _build_dispatcher_context
from django.core.cache import cache

cache_key = f'dispatcher_stats_{period}'
stats = cache.get(cache_key)
if not stats:
    stats = get_general_stats(period)
    cache.set(cache_key, stats, 300)  # 5 –º–∏–Ω—É—Ç
```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ —ç—Ç–æ–π –ø–∞–ø–∫–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `/var/log/django/error.log`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î: `python manage.py dbshell`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏: `python manage.py showmigrations`

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
python manage.py check

# –¢–µ—Å—Ç middleware
python manage.py shell -c "from storefront.utm_middleware import UTMTrackingMiddleware; print('OK')"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º
python manage.py dbshell -c "SELECT TABLE_NAME, TABLE_ROWS FROM information_schema.TABLES WHERE TABLE_NAME LIKE '%utm%';"
```

---

## üìà Roadmap (–±—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è)

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (2025-01-30):

- [x] **–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV/Excel** - 4 —Ç–∏–ø–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ (—Å–µ—Å—Å–∏–∏, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –∫–∞–º–ø–∞–Ω–∏–∏, –∫–æ–Ω—Ç–µ–Ω—Ç)
- [x] **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ (Chart.js)** - –≤–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–π + –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- [x] **–î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–µ—Å—Å–∏–∏** - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- [x] **API endpoints –¥–ª—è AJAX –∑–∞–≥—Ä—É–∑–∫–∏** - 13 –Ω–æ–≤—ã—Ö REST API endpoints
- [x] **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤** - —Ç–µ–∫—É—â–∏–π vs –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–∏–æ–¥ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- [x] **ROI-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä** - live-—Ä–∞—Å—á–µ—Ç –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ —Ä–µ–∫–ª–∞–º—ã

**üìÑ –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [UTM_DISPATCHER_AUDIT_IMPROVEMENTS.md](UTM_DISPATCHER_AUDIT_IMPROVEMENTS.md)

### üîú –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:

- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã –ø–æ email
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Meta Ads API (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤)
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Ads API
- [ ] –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Å–∏–π (ML)
- [ ] Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (WebSockets)
- [ ] Dashboard widgets (drag & drop)
- [ ] –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üéâ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –í–µ—Ä—Å–∏—è 2.0 (2025-01-30)

**–ß—Ç–æ –Ω–æ–≤–æ–≥–æ:**
1. ‚ú® 13 –Ω–æ–≤—ã—Ö API endpoints –¥–ª—è AJAX –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
2. üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV (—Å–µ—Å—Å–∏–∏, –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –∫–∞–º–ø–∞–Ω–∏–∏, –∫–æ–Ω—Ç–µ–Ω—Ç)
3. üîç –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Å—Å–∏–∏
4. üìä –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ Chart.js (–≤–æ—Ä–æ–Ω–∫–∞ + –∏—Å—Ç–æ—á–Ω–∏–∫–∏)
5. üí∞ ROI –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å live-—Ä–∞—Å—á–µ—Ç–æ–º
6. üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–æ–≤
7. üé® –£–ª—É—á—à–µ–Ω–Ω—ã–π UI —Å gradient –¥–∏–∑–∞–π–Ω–æ–º –∏ –∞–Ω–∏–º–∞—Ü–∏—è–º–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ ~1200 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- –ù–æ–≤—ã–π —Ñ–∞–π–ª: `utm_api_views.py` (560+ —Å—Ç—Ä–æ–∫)
- –û–±–Ω–æ–≤–ª–µ–Ω–æ: `utm_analytics.py` (+150 —Å—Ç—Ä–æ–∫)
- –û–±–Ω–æ–≤–ª–µ–Ω–æ: `admin_dispatcher_section.html` (+300 —Å—Ç—Ä–æ–∫)
- Chart.js 4.4.0 –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
- DRF –¥–ª—è REST API
- UTF-8 BOM –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:** 100% ‚úÖ

---

## üë• –ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä—ã

- **AI Assistant** - –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã (2025-01-30)
- **AI Assistant** - –∞—É–¥–∏—Ç, —É–ª—É—á—à–µ–Ω–∏—è, API endpoints (2025-01-30)

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

Proprietary - TwoComms.shop

---

**–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –∫–∞–º–ø–∞–Ω–∏—è–º–∏!**

---

## üéØ –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –Ω–æ–≤—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º

### API Endpoints:
```bash
# –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
curl "https://twocomms.shop/api/utm/general-stats/?period=week"

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤
curl "https://twocomms.shop/api/utm/compare/?period=today"

# ROI —Ä–∞—Å—á–µ—Ç
curl "https://twocomms.shop/api/utm/roi/?period=week&ad_spend=5000"

# –î–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–∏
curl "https://twocomms.shop/api/utm/123/session_detail/"
```

### –≠–∫—Å–ø–æ—Ä—Ç CSV:
```
https://twocomms.shop/api/utm/export-csv/?period=week&type=sessions
https://twocomms.shop/api/utm/export-csv/?period=month&type=sources
https://twocomms.shop/api/utm/export-csv/?period=today&type=campaigns
```

### UI Features:
- **ROI –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä:** –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –¥–æ —Å–µ–∫—Ü–∏–∏ "ROI –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"
- **–ì—Ä–∞—Ñ–∏–∫–∏:** –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–π –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- **–î–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–∏:** –ö–Ω–æ–ø–∫–∞ "–î–µ—Ç–∞–ª—ñ" –≤ —Ç–∞–±–ª–∏—Ü–µ "–û—Å—Ç–∞–Ω–Ω—ñ —Å–µ—Å—ñ—ó"
- **–≠–∫—Å–ø–æ—Ä—Ç:** 3 –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–µ–π —Å–µ—Å—Å–∏–π

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-01-30 ‚ú®
