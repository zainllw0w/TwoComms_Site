# Серверные действия для агента без SSH-доступа

У агента нет SSH: он готовит инструкции, разработчик выполняет. Если доступ появится — агент может сам подключиться по SSH и выполнить эти шаги. Ниже порядок действий на сервере (TwoComms, Django + WhiteNoise).

## 1. Обновить код
- `cd /home/qlknpodo/TWC/TwoComms_Site/twocomms`
- `git pull` (ветка `main`). Убедиться, что хеш соответствует последнему коммиту.

## 2. Сборка/обновление статики (если менялись CSS/JS)
- Активировать venv: `source /home/qlknpodo/virtualenv/TWC/TwoComms_Site/twocomms/3.13/bin/activate`
- Собрать сжатые CSS (если менялись): `npm install` при смене зависимостей, затем `npm run build:css` (postcss/purgecss) — проверить, что `styles.purged.css` обновился.
- Сборка статики Django (если требуется обновить хеши/manifest):
  - `python manage.py collectstatic --noinput`
- Если используется compressor offline и менялись шаблоны/стили:
  - `python manage.py compress --force`

## 3. Проверить/инвалидировать кеш
- Если стоит CDN/прокси — инвалидация статики/медиа, чтобы новые хеши подтянулись. Минимум: сбросить кеш Nginx/Cloudflare, если включен.
- Убедиться, что WhiteNoise отдаёт файлы с актуальными заголовками (immutable, долгий max-age). Можно проверить через `curl -I https://site/css/styles.purged.css`.

## 4. Перезагрузка службы (если есть uWSGI/gunicorn)
- Перезагрузить приложение после обновления кода: `systemctl restart <service>` или `touch` wsgi, если так принято. Уточнить имя сервиса (например, `twocomms.service`), если требуется.

## 5. Проверка после деплоя
- Прогнать быстрый smoke: главная, каталог, карточка товара. Проверить, что статика грузится (200), нет 500/404.
- Снять свежий Lighthouse (mobile throttling) для валидации LCP/FCP/TBT.

## 6. Дополнительно (если будет доступ)
- Прогнать серверный скрипт оптимизации медиа, если появились новые большие изображения: `python optimize_images.py --yes --quality 80 --max-width 1400 --max-height 1400 --min-size-kb 120`.
- Проверить логи веб-сервера/приложения на ошибки после релиза.

### Если SSH будет доступен
Агент может сам выполнить шаги 1–6. Если нет — разработчик выполняет по инструкции, агент анализирует результаты (скриншоты Lighthouse, логи).
