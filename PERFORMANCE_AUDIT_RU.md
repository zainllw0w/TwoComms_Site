# –î–µ—Ç–∞–ª—å–Ω—ã–π –ê—É–¥–∏—Ç –ü—Ä–æ–µ–∫—Ç–∞ TwoComms (Deep Dive)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞, UX –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ TwoComms.
**–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∫ –∑–∞–ø—É—Å–∫—É —Ä–µ–∫–ª–∞–º—ã, –æ–±–µ—Å–ø–µ—á–∏–≤ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã.

---

## 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ü—Ä–æ–±–ª–µ–º—ã (Critical Issues)
*–û—à–∏–±–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç—Ä–∞—Ñ–∏–∫–∞.*

### 1.1. N+1 –ó–∞–ø—Ä–æ—Å—ã –≤ –ö–æ—Ä–∑–∏–Ω–µ (Database)
**–§–∞–π–ª:** `twocomms/storefront/views/cart.py`
**–°—Ç—Ä–æ–∫–∏:** ~138-208 (—Ü–∏–∫–ª `for item_key, item_data in cart.items():`)
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ –ø–µ—Ä–µ–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–∞–ø—Ä–æ—Å –∫ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞:
```python
product = Product.objects.select_related('category').get(id=product_id)
```
–ï—Å–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ### 4.5. N+1 Queries (Backend)
**–§–∞–π–ª:** `storefront/views/cart.py`, `storefront/views/checkout.py`, `storefront/views/product.py`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
1.  **Cart:** –í `view_cart` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏—Ç–µ—Ä–∞—Ü–∏—è –ø–æ `cart.items()` –∏ –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `Product.objects.get(id=product_id)`.
2.  **Checkout:** –í `checkout` –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚Äî –∑–∞–ø—Ä–æ—Å —Ç–æ–≤–∞—Ä–∞ –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞.
3.  **Product Detail:** –í `product_detail` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `product.images.all()` –±–µ–∑ `prefetch_related`. –¢–∞–∫–∂–µ `build_color_preview_map` –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
**–†–∏—Å–∫:**
*   **Cart/Checkout:** –ü—Ä–∏ –∫–æ—Ä–∑–∏–Ω–µ –∏–∑ 10 —Ç–æ–≤–∞—Ä–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è 10+ –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
*   **Product Detail:** –õ–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è –±–ª–æ–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π).
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
*   **Cart/Checkout:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Product.objects.in_bulk(ids)` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º.
*   **Product Detail:** –î–æ–±–∞–≤–∏—Ç—å `prefetch_related('images')` –∫ –∑–∞–ø—Ä–æ—Å—É —Ç–æ–≤–∞—Ä–∞. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å `build_color_preview_map` —á–µ—Ä–µ–∑ `prefetch_related` –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏ –∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

### 4.6. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã –ë–î
**–§–∞–π–ª:** `orders/models.py`, `storefront/models.py`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
1.  **Order:** –ü–æ–ª—è `phone` –∏ `email` —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ (–≤ –∞–¥–º–∏–Ω–∫–µ, –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞), –Ω–æ –Ω–µ –∏–º–µ—é—Ç –∏–Ω–¥–µ–∫—Å–æ–≤.
2.  **Product:** –ü–æ–ª–µ `status` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (`status='published'`), –Ω–æ –Ω–µ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ (—Ö–æ—Ç—è —ç—Ç–æ CharField —Å choices).
**–†–∏—Å–∫:** –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ –±–∞–∑—ã.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å `db_index=True` –¥–ª—è `Order.phone`, `Order.email` –∏ `Product.status`.

### 4.7. "Fat Views" (–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
**–§–∞–π–ª:** `storefront/views/checkout.py`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–§—É–Ω–∫—Ü–∏—è `create_order` –∑–∞–Ω–∏–º–∞–µ—Ç –æ–∫–æ–ª–æ 300 —Å—Ç—Ä–æ–∫. –û–Ω–∞ —Å–º–µ—à–∏–≤–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞, UTM-—Ç—Ä–µ–∫–∏–Ω–≥, –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –æ—á–∏—Å—Ç–∫—É —Å–µ—Å—Å–∏–∏.
**–†–∏—Å–∫:** –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏, —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ —Å–µ—Ä–≤–∏—Å `OrderService.create_order(...)`.

---2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PurgeCSS –∏–ª–∏ —Ä–∞–∑–±–∏—Ç—å –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π CSS (inline) –∏ –æ—Å—Ç–∞–ª—å–Ω–æ–π (async).
**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –£–ª—É—á—à–µ–Ω–∏–µ First Contentful Paint (FCP) –∏ LCP –Ω–∞ 0.5-1.5 —Å–µ–∫—É–Ω–¥—ã.

### 1.3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ò–Ω–¥–µ–∫—Å–æ–≤ –ë–î (Database Performance)
**–§–∞–π–ª—ã:** `orders/models.py`, `storefront/models.py`
**–ü–æ–ª—è:** `Order.phone`, `Order.email`, `Product.price`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü–æ–ª—è, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —á–∞—Å—Ç–æ –∏–¥–µ—Ç –ø–æ–∏—Å–∫ (–∞–¥–º–∏–Ω–∫–∞, —Ñ–∏–ª—å—Ç—Ä—ã), –Ω–µ –∏–º–µ—é—Ç –∏–Ω–¥–µ–∫—Å–∞ (`db_index=True`).
**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:** –ü–æ–∏—Å–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–º –ø–µ—Ä–µ–±–æ—Ä–æ–º —Ç–∞–±–ª–∏—Ü—ã (Full Table Scan). –° —Ä–æ—Å—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –∞–¥–º–∏–Ω–∫–∞ –Ω–∞—á–Ω–µ—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å `db_index=True` –∏ —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏.

---

## 2. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –ü–∏–∫—Å–µ–ª–∏ (Analytics & Ads)
*–ê–Ω–∞–ª–∏–∑ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã Meta Pixel, GTM –∏ TikTok Pixel.*

### 2.1. TikTok Pixel: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ setInterval
**–§–∞–π–ª:** `static/js/analytics-loader.js`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–§—É–Ω–∫—Ü–∏—è `loadTikTokPixel` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `setInterval` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `ttq`.
**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:** –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –æ–ø—Ä–æ—Å (polling) –Ω–∞–≥—Ä—É–∂–∞–µ—Ç Main Thread, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ —Ä–µ–∫–ª–∞–º—ã).
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `onload` callback –Ω–∞ —Ç–µ–≥–µ `<script>` –∏–ª–∏ `MutationObserver`.

### 2.2. –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Data Layer (GTM)
**–§–∞–π–ª:** `static/js/analytics-loader.js`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
```javascript
win.dataLayer.push({
  'event': eventName,
  'eventParameters': payload
});
```
–≠—Ç–æ **–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç** —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É GA4 Ecommerce (–≥–¥–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è `ecommerce: { items: [...] }`).
**–°—Ç–∞—Ç—É—Å:** ‚ÑπÔ∏è **–û—Å—Ç–∞–≤–ª–µ–Ω–æ –∫–∞–∫ –µ—Å—Ç—å –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –∑–∞–∫–∞–∑—á–∏–∫–∞.**
**–†–∏—Å–∫:** –ï—Å–ª–∏ –≤ GTM –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ `eventParameters`, –¥–∞–Ω–Ω—ã–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –∫–æ–º–º–µ—Ä—Ü–∏–∏ (–¥–æ—Ö–æ–¥, —Ç–æ–≤–∞—Ä—ã) **–Ω–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è** –≤ GA4.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** (–û—Ç–ª–æ–∂–µ–Ω–∞) –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–±—ã—Ç–∏–π –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ GA4 Ecommerce.

### 2.3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `noscript` –¥–ª—è Meta Pixel
**–§–∞–π–ª:** `templates/base.html`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í `base.html` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–≥ `<noscript>` —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø–∏–∫—Å–µ–ª—è.
**–†–∏—Å–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º JS (—Ä–µ–¥–∫–æ, –Ω–æ –±—ã–≤–∞–µ—Ç) –∏–ª–∏ —Å–±–æ–∏ –∑–∞–≥—Ä—É–∑–∫–∏ JS –Ω–µ –±—É–¥—É—Ç –æ—Ç—Å–ª–µ–∂–µ–Ω—ã.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `<noscript>` –∫–æ–¥ Meta Pixel.

### 4.4. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (–ö–∞—Ç–∞–ª–æ–≥ –∏ –ü–æ–∏—Å–∫)
**–§–∞–π–ª:** `templates/pages/catalog.html`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–≥ `{% cache 600 catalog_products cat_slug %}`.
**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
1.  **–ü–∞–≥–∏–Ω–∞—Ü–∏—è:** –ö–ª—é—á –∫—ç—à–∞ –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2, 3 –∏ —Ç.–¥. –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã 1.
2.  **–ü–æ–∏—Å–∫:** View `search` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç –∂–µ —à–∞–±–ª–æ–Ω, –Ω–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç `cat_slug`. –ö–ª—é—á –∫—ç—à–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—É—Å—Ç—ã–º (`catalog_products`). **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ!** –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Ö—É–¥–∏") –∑–∞–∫—ç—à–∏—Ä—É–µ—Ç—Å—è, –∏ –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ –ª—é–±—ã–º –∑–∞–ø—Ä–æ—Å–∞–º –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è "—Ö—É–¥–∏".
**–†–∏—Å–∫:** üî¥ **CRITICAL**. –ü–æ–ª–Ω–∞—è –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
1.  –î–ª—è –ø–æ–∏—Å–∫–∞: **–û—Ç–∫–ª—é—á–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —à–∞–±–ª–æ–Ω–∞ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ —Å–ª–∏—à–∫–æ–º –¥–∏–Ω–∞–º–∏—á–Ω—ã).
2.  –î–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞: –î–æ–±–∞–≤–∏—Ç—å `request.GET.urlencode` –≤ –∫–ª—é—á: `{% cache 600 catalog_products cat_slug request.GET.urlencode %}`.

---

## 3. –ö–∞—á–µ—Å—Ç–≤–æ –ö–æ–¥–∞ –∏ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Code Quality)
*–ü—Ä–æ–±–ª–µ–º—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å.*

### 3.1. "–¢–æ–ª—Å—Ç—ã–µ" View (Fat Views)
**–§–∞–π–ª—ã:** `storefront/views/cart.py`, `storefront/views/monobank.py`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–æ–≤, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API –±–∞–Ω–∫–æ–≤ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è —Å–º–µ—à–∞–Ω–∞ —Å –ª–æ–≥–∏–∫–æ–π –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (HTTP response).
**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:** –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, —Å–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–Ω–µ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤ —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π (`services/`).

---

## 4. –ú–æ–±–∏–ª—å–Ω–∞—è –í–µ—Ä—Å–∏—è –∏ UX (Mobile)
*–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö.*

### 4.1. –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏ `!important`
**–§–∞–π–ª:** `static/css/styles.css`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ 22,000 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞. –û–≥—Ä–æ–º–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `!important` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –º–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å–∞—Ö –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö).
**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
1.  **–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:** 480KB+ CSS ‚Äî —ç—Ç–æ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ. –ü–∞—Ä—Å–∏–Ω–≥ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫.
2.  **–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏:** `!important` –¥–µ–ª–∞–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π.
3.  **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞:** –ë—Ä–∞—É–∑–µ—Ä—É —Å–ª–æ–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–∏–ª–∏ –ø—Ä–∏ —Ç–∞–∫–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
1.  –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ CSS, —É–¥–∞–ª–∏–≤ –¥—É–±–ª–∏–∫–∞—Ç—ã.
2.  –†–∞–∑–±–∏—Ç—å –Ω–∞ –º–æ–¥—É–ª–∏ (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã).
3.  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—é (BEM –∏–ª–∏ Utility-first) –≤–º–µ—Å—Ç–æ –±–æ—Ä—å–±—ã —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç—å—é.

### 4.2. –¢—è–∂–µ–ª—ã–µ CSS –∞–Ω–∏–º–∞—Ü–∏–∏
**–§–∞–π–ª:** `static/css/styles.css`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–ª–æ–∂–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —Ñ–æ–Ω–∞ (`backgroundShift`, `noiseMove`) –Ω–∞ `body::before` –∏ `body::after`.
**–†–∏—Å–∫:** –ù–∞ —Å–ª–∞–±—ã—Ö –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —ç—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –ª–∞–≥–∏ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (Jank) –∏ –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –±–∞—Ç–∞—Ä–µ–∏.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å `@media (prefers-reduced-motion: reduce)` –∏ –∫–ª–∞—Å—Å `.perf-lite` (—É–∂–µ –µ—Å—Ç—å, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏—é) –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–π –Ω–∞ —Å–ª–∞–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

---

## 5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (Security)
*–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏.*

### 5.1. Stored XSS (Cross-Site Scripting)
**–§–∞–π–ª:** `storefront/views/cart.py`, `static/js/modules/cart.js`
**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í `cart_items_api` (backend) –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞ (`product.title`, `color_label`) –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ JSON –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
–í `cart.js` (frontend) —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ DOM —á–µ—Ä–µ–∑ `innerHTML` –±–µ–∑ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏:
```javascript
<h3 class="cart-item-title">${item.product_title || ''}</h3>
```
**–†–∏—Å–∫:** –ï—Å–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –ø–æ–ø–∞–¥–µ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–π JS-–∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É –∏–ª–∏ –∏–º–ø–æ—Ä—Ç), –æ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ—Ä–∑–∏–Ω–µ.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
1.  **Backend:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `django.utils.html.escape` –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π –≤ `cart_items_api`.
2.  **Frontend:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `textContent` –≤–º–µ—Å—Ç–æ `innerHTML` –∏–ª–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π.

### 5.2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ (Settings)
**–§–∞–π–ª:** `twocomms/production_settings.py`
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
*   `DEBUG = False` ‚Äî –≤–µ—Ä–Ω–æ.
*   `ALLOWED_HOSTS` ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ENV.
*   `SECURE_SSL_REDIRECT = True` ‚Äî –≤–µ—Ä–Ω–æ.
*   `X_FRAME_OPTIONS = 'SAMEORIGIN'` ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç Clickjacking –≤–∫–ª—é—á–µ–Ω–∞.
*   `SESSION_COOKIE_SECURE = True` ‚Äî –≤–µ—Ä–Ω–æ.
**–ó–∞–º–µ—á–∞–Ω–∏–µ:**
–í `settings.py` –µ—Å—Ç—å —Ö–∞—Ä–¥–∫–æ–¥ –∫–ª—é—á–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: `SECRET_KEY = os.environ.get('SECRET_KEY', 'dev-only-...')`.
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ `SECRET_KEY` –≤—Å–µ–≥–¥–∞ –∑–∞–¥–∞–Ω —á–µ—Ä–µ–∑ ENV –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

---
---

## 6. –ì–ª—É–±–æ–∫–∏–π –ê—É–¥–∏—Ç (Phase 2: Deep Dive)

–í —Ä–∞–º–∫–∞—Ö —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –±—ã–ª–∏ –≤—ã—è–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏.

### 6.1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ Middleware (Rate Limiting)
**–§–∞–π–ª:** `twocomms/middleware.py`, `twocomms/settings.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** Middleware `SimpleRateLimitMiddleware` –ø–æ–¥–∫–ª—é—á–µ–Ω **–ø–µ—Ä–µ–¥** `WhiteNoiseMiddleware` –∏ –Ω–µ –∏–º–µ–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤.
**–†–∏—Å–∫:** **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**.
1.  **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –ó–∞–≥—Ä—É–∑–∫–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å 50+ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏/—Å—Ç–∏–ª—è–º–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ 50+ –∑–∞–ø—Ä–æ—Å–æ–≤. –õ–∏–º–∏—Ç 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω –±—É–¥–µ—Ç –∏—Å—á–µ—Ä–ø–∞–Ω –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç –±–∞–Ω (429 Too Many Requests).
2.  **–ó–∞–¥–µ—Ä–∂–∫–∞ (Latency):** –î–ª—è *–∫–∞–∂–¥–æ–≥–æ* —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞ (–∫–∞—Ä—Ç–∏–Ω–∫–∞, CSS, JS) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –≤ Redis (`cache.get` + `cache.set`). –≠—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç 2 —Å–µ—Ç–µ–≤—ã—Ö –≤—ã–∑–æ–≤–∞ –Ω–∞ –∫–∞–∂–¥—ã–π –∞—Å—Å–µ—Ç, –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –∑–∞–º–µ–¥–ª—è—è –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**.
*   Middleware –ø–µ—Ä–µ–º–µ—â–µ–Ω –ø–æ—Å–ª–µ `WhiteNoiseMiddleware`.
*   –î–æ–±–∞–≤–ª–µ–Ω–æ —è–≤–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è `STATIC_URL` –∏ `MEDIA_URL`.

### 6.2. –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ë–î (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ –∑–∞–∫–∞–∑–æ–≤)
**–§–∞–π–ª:** `orders/models.py` (–º–µ—Ç–æ–¥—ã `generate_order_number` –≤ `Order` –∏ `DropshipperOrder`)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–∏–Ω–µ–π–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä.
```python
counter = 1
while True:
    number = f"TWC{date_str}N{counter:02d}"
    if not Order.objects.filter(order_number=number).exists(): # <--- –ó–ê–ü–†–û–° –í –ë–î –í –¶–ò–ö–õ–ï
        return number
    counter += 1
```
**–†–∏—Å–∫:** **–í–´–°–û–ö–ò–ô**.
–ï—Å–ª–∏ –∑–∞ –¥–µ–Ω—å —Å–æ–∑–¥–∞–Ω–æ 500 –∑–∞–∫–∞–∑–æ–≤, —Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ 501-–≥–æ –∑–∞–∫–∞–∑–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ **500 SQL-–∑–∞–ø—Ä–æ—Å–æ–≤** `SELECT ... EXISTS`, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω—ã–π –Ω–æ–º–µ—Ä. –≠—Ç–æ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –∫ –∫–æ–Ω—Ü—É –¥–Ω—è –∏ –Ω–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**.
*   –ê–ª–≥–æ—Ä–∏—Ç–º –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `aggregate(Max('order_number'))`.
*   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–Ω–∏–∂–µ–Ω–æ —Å O(N) –¥–æ O(1).

### 6.3. –†–∏—Å–∫ Overselling (Backend)
**–§–∞–π–ª:** `storefront/views/checkout.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –º–µ—Ç–æ–¥–µ `create_order` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ (`select_for_update`) –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º.
**–†–∏—Å–∫:** **–°–†–ï–î–ù–ò–ô**.
–ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∑–∞–∫–∞–∑–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–æ–≤–∞—Ä–∞ –¥–≤—É–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –æ–±–∞ –∑–∞–∫–∞–∑–∞ –ø—Ä–æ–π–¥—É—Ç —É—Å–ø–µ—à–Ω–æ, —á—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø—Ä–æ–¥–∞–∂–µ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞ (overselling).
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**.
*   –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ `select_for_update()` –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ç–æ–≤–∞—Ä–∞.
*   –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ (`stock >= qty`) –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
*   –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å–ø–∏—Å–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.

### 6.4. Frontend: –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –∏ XSS
**–§–∞–π–ª:** `static/js/modules/cart.js`
**–ü—Ä–æ–±–ª–µ–º–∞ 1 (XSS):** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `innerHTML` –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞ (`item.product_title`, `item.color_label`), –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞. –ï—Å–ª–∏ –ë–î –±—É–¥–µ—Ç —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–ª–∏ –∞–¥–º–∏–Ω –≤—Å—Ç–∞–≤–∏—Ç —Å–∫—Ä–∏–ø—Ç –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
**–ü—Ä–æ–±–ª–µ–º–∞ 2 (Memory Leak):** `CartPageController` —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–π–º–µ—Ä—ã –∏ —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π, –Ω–æ –Ω–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ –º–µ—Ç–æ–¥ `destroy()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∞–∫—Ç—É–∞–ª—å–Ω–æ –µ—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –±—É–¥–µ—Ç SPA-–ø–µ—Ä–µ—Ö–æ–¥).
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û (XSS)**.
*   –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `escapeHtml`.
*   –í—Å–µ –≤—ã–≤–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ `renderItem` —Ç–µ–ø–µ—Ä—å —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è.

### 6.5. Browser Verification (Manual Check Required)
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–º –Ω–µ —É–¥–∞–ª–∞—Å—å –∏–∑-–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–µ–¥—É—é—â–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–∞ –∂–∏–≤–æ–º —Å–∞–π—Ç–µ:
1.  **Checkout Flow:** –ü—Ä–æ–π—Ç–∏ –ø—É—Ç—å –æ—Ç –∫–æ—Ä–∑–∏–Ω—ã –¥–æ "–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑".
2.  **Mobile Menu:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.
3.  **Console Errors:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12) –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∞—Å–Ω—ã—Ö –æ—à–∏–±–æ–∫ JS –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

## 7. –ì–ª—É–±–æ–∫–∏–π –ê—É–¥–∏—Ç –®–∞–±–ª–æ–Ω–æ–≤ (Phase 4: Template Deep Dive)

## 7. –ì–ª—É–±–æ–∫–∏–π –ê—É–¥–∏—Ç –®–∞–±–ª–æ–Ω–æ–≤ (Phase 4: Template Deep Dive)

### 7.1. –ê–Ω–∞–ª–∏–∑ `base.html` (Core Layout)
**–§–∞–π–ª:** `twocomms_django_theme/templates/base.html`
**–ü—Ä–æ–±–ª–µ–º—ã:**
1.  **Blocking Script:** –°–∫—Ä–∏–ø—Ç `analytics-loader.js` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ `<head>` (—Å—Ç—Ä–æ–∫–∞ 402) –±–µ–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ `defer` –∏–ª–∏ `async`. –≠—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞.
2.  **Excessive Inline CSS:** –û–≥—Ä–æ–º–Ω—ã–π –±–ª–æ–∫ "Critical CSS" (—Å—Ç—Ä–æ–∫–∏ 122-291) —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä HTML –¥–æ–∫—É–º–µ–Ω—Ç–∞.
3.  **Hardcoded Credentials:** ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ GTM (`GTM-PRLLBF9H`) –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω –≤ –∫–æ–¥–µ, —Ö–æ—Ç—è –¥—Ä—É–≥–∏–µ ID (TikTok) –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.
4.  **DOM Size:** –°–∫—Ä—ã—Ç—ã–µ –ø–∞–Ω–µ–ª–∏ (`#mini-cart-panel-mobile`, `#user-panel-mobile`) —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –≤ DOM –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ (—Ö–æ—Ç—å –∏ —Å–∫—Ä—ã—Ç—ã CSS). –≠—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∑–ª–æ–≤ DOM.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
*   –î–æ–±–∞–≤–∏—Ç—å `defer` –∫ `analytics-loader.js`.
*   –í—ã–Ω–µ—Å—Ç–∏ –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `django-compressor`.
*   –í—ã–Ω–µ—Å—Ç–∏ GTM ID –≤ `settings.py`.
*   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `{% if not request.user_agent.is_mobile %}` (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ) –∏–ª–∏ –ª–µ–Ω–∏–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–∞–Ω–µ–ª–µ–π.

### 7.2. –ê–Ω–∞–ª–∏–∑ `catalog.html` (Product List)
**–§–∞–π–ª:** `twocomms_django_theme/templates/pages/catalog.html`
**–ü—Ä–æ–±–ª–µ–º—ã:**
1.  **CRITICAL: Broken Caching:** –°—Ç—Ä–æ–∫–∞ 136 `{% cache 600 catalog_products cat_slug %}` –∫—ç—à–∏—Ä—É–µ—Ç —Å–µ—Ç–∫—É —Ç–æ–≤–∞—Ä–æ–≤, –∏–≥–Ω–æ—Ä–∏—Ä—É—è GET-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–∞–≥–∏–Ω–∞—Ü–∏—è, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, —Ñ–∏–ª—å—Ç—Ä—ã). –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—Å–µ–≥–¥–∞ –≤–∏–¥—è—Ç –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.
2.  **Potential N+1 (Colors):** –°—Ç—Ä–æ–∫–∞ 151 `{% for v in p.colors_preview %}`. –ï—Å–ª–∏ `colors_preview` –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞, —ç—Ç–æ N+1. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `prefetch_related` –≤–æ view.
3.  **Potential N+1 (Category Covers):** –°—Ç—Ä–æ–∫–∞ 121 `c.cover.url` –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –ï—Å–ª–∏ `cover` –Ω–µ –≤ `select_related`, —ç—Ç–æ N+1.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
*   **–°—Ä–æ—á–Ω–æ:** –î–æ–±–∞–≤–∏—Ç—å `request.GET.urlencode` –≤ –∫–ª—é—á –∫—ç—à–∞ –∏–ª–∏ —É–±—Ä–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–ª—É—á—à–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å QuerySet).
*   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `views.py` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ `prefetch_related('colors')` –∏ `select_related('cover')` –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

### 7.3. –ê–Ω–∞–ª–∏–∑ `product_detail.html` (Product Page)
**–§–∞–π–ª:** `twocomms_django_theme/templates/pages/product_detail.html`
**–ü—Ä–æ–±–ª–µ–º—ã:**
1.  **Excessive Inline JS:** –°—Ç—Ä–æ–∫–∏ 712-800+ —Å–æ–¥–µ—Ä–∂–∞—Ç –±–æ–ª—å—à—É—é –ª–æ–≥–∏–∫—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è `offer_id` –∏ –∫–∞—Ä—É—Å–µ–ª–∏. –≠—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É.
2.  **Potential N+1:** –°—Ç—Ä–æ–∫–∞ 120 `{% for v in color_variants %}` –∏ 172 `{% for ph in images %}`. –¢—Ä–µ–±—É–µ—Ç—Å—è `prefetch_related('variants', 'images')` –≤–æ view.
3.  **LCP Optimization:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∞ 30) –∏–º–µ–µ—Ç `loading="eager"`, —á—Ç–æ —Ö–æ—Ä–æ—à–æ, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `<img>` –≤–º–µ—Å—Ç–æ `optimized_image` (—Ö–æ—Ç—è `optimized_image` –∑–∞–≥—Ä—É–∂–µ–Ω).

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
*   –í—ã–Ω–µ—Å—Ç–∏ JS –ª–æ–≥–∏–∫—É –≤ `static/js/pages/product-detail.js`.
*   –£–±–µ–¥–∏—Ç—å—Å—è –≤ –Ω–∞–ª–∏—á–∏–∏ `prefetch_related` –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

### 7.4. –ê–Ω–∞–ª–∏–∑ `partials/product_card.html`
**–§–∞–π–ª:** `twocomms_django_theme/templates/partials/product_card.html`
**–ü—Ä–æ–±–ª–µ–º—ã:**
1.  **High N+1 Risk:** –®–∞–±–ª–æ–Ω –∞–∫—Ç–∏–≤–Ω–æ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `p.display_image`, `p.main_image`, `p.category.name`, `p.points_reward`. –ü–æ—Å–∫–æ–ª—å–∫—É —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –≤ —Ü–∏–∫–ª–µ (–¥–æ 20-40 —Ä–∞–∑ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ), –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `select_related` –¥–ª—è —ç—Ç–∏—Ö –ø–æ–ª–µ–π –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —Å–æ—Ç–Ω—è–º –∑–∞–ø—Ä–æ—Å–æ–≤.
2.  **Inline Event Handlers:** –°—Ç—Ä–æ–∫–∞ 35 `onclick="...toggleFavorite..."`. –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
*   **–ö—Ä–∏—Ç–∏—á–Ω–æ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `CatalogView` –∏ `ProductListView` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ `.select_related('category', 'main_image', 'display_image')`.

### 7.5. –ê–Ω–∞–ª–∏–∑ `cart.html` (Cart & Checkout)
**–§–∞–π–ª:** `twocomms_django_theme/templates/pages/cart.html`
**–ü—Ä–æ–±–ª–µ–º—ã:**
1.  **N+1 Risk:** –°—Ç—Ä–æ–∫–∞ 93 `it.color_variant.images.exists` –∏ 98 `it.product.main_image`. –í `checkout.py` (—Ñ—É–Ω–∫—Ü–∏—è `checkout`) —Ç–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ü–∏–∫–ª–µ `for item_key, item_data in cart.items()` —Å `Product.objects.get(id=...)` (—Å—Ç—Ä–æ–∫–∞ 66). –≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π N+1.
2.  **Broken Route / Missing Template:** View `checkout` (–≤ `storefront/views/checkout.py`) —Ä–µ–Ω–¥–µ—Ä–∏—Ç `pages/checkout.html`, –Ω–æ —ç—Ç–æ—Ç —Ñ–∞–π–ª **–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** –≤ –ø–∞–ø–∫–µ —à–∞–±–ª–æ–Ω–æ–≤. –í–µ—Ä–æ—è—Ç–Ω–æ, –º–∞—Ä—à—Ä—É—Ç `/checkout/` —Å–ª–æ–º–∞–Ω (500 Error).
3.  **Logic in Template:** –°—Ç—Ä–æ–∫–∞ 214 `{% with prof=request.user.userprofile %}`. –ï—Å–ª–∏ `userprofile` –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω —Å `user`, —ç—Ç–æ –ª–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
*   **Critical:** –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å `checkout` view (–µ—Å–ª–∏ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –µ–≥–æ.
*   **Critical:** –í `cart` view –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Product.objects.in_bulk(ids)` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ 1 –∑–∞–ø—Ä–æ—Å (–∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –≤ `create_order`).
*   –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `request.user` –∏–º–µ–µ—Ç `select_related('userprofile')` –≤ middleware –∏–ª–∏ view.

### 7.6. –ê–Ω–∞–ª–∏–∑ `order_success.html`
**–§–∞–π–ª:** `twocomms_django_theme/templates/pages/order_success.html`
**–ü—Ä–æ–±–ª–µ–º—ã:**
1.  **Excessive Inline CSS:** –®–∞–±–ª–æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ 800 —Å—Ç—Ä–æ–∫ –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª–µ–π (–∞–Ω–∏–º–∞—Ü–∏–∏, –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã). –≠—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä HTML –∏ –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º –∫–∞–∫ CSS —Ñ–∞–π–ª.
2.  **Performance:** –°–ª–æ–∂–Ω—ã–µ CSS –∞–Ω–∏–º–∞—Ü–∏–∏ (`box-shadow`, `filter: blur`) –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ—Å–∞–¥–∫—É FPS –Ω–∞ —Å–ª–∞–±—ã—Ö –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
*   –í—ã–Ω–µ—Å—Ç–∏ —Å—Ç–∏–ª–∏ –≤ `static/css/pages/order-success.css`.
*   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `will-change` –¥–ª—è –∞–Ω–∏–º–∏—Ä—É–µ–º—ã—Ö —Å–≤–æ–π—Å—Ç–≤ –∏–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö (`@media (prefers-reduced-motion)`).

## 9. –ê–Ω–∞–ª–∏–∑ –°–∫—Ä—ã—Ç–æ–π –õ–æ–≥–∏–∫–∏ (Phase 6: Hidden Logic)

### 9.1. –°–∏–≥–Ω–∞–ª—ã (Signals) - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ `post_save` / `pre_save`. –≠—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ –∞–¥–º–∏–Ω–∞) –∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á.

1.  **`storefront/signals.py` (CRITICAL):**
    *   **–õ–æ–≥–∏–∫–∞:** –ü—Ä–∏ *–∫–∞–∂–¥–æ–º* —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ (`post_save`, `post_delete`) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `call_command('generate_google_merchant_feed')`.
    *   **–í–ª–∏—è–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è XML —Ñ–∏–¥–∞ (–º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å —Å–µ–∫—É–Ω–¥—ã –∏–ª–∏ –º–∏–Ω—É—Ç—ã) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ. –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –±—É–¥–µ—Ç "–≤–∏—Å–Ω—É—Ç—å" –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤.
    *   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–Ω–µ—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ñ–∏–¥–∞ –≤ Celery task –∏–ª–∏ Cron job (—Ä–∞–∑ –≤ —á–∞—Å/—Å—É—Ç–∫–∏).

2.  **`orders/signals.py` (HIGH):**
    *   **–õ–æ–≥–∏–∫–∞:** –í `pre_save` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `Order.objects.get(pk=instance.pk)` (–ª–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î) –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram (`telegram_notifier.send_...`).
    *   **–í–ª–∏—è–Ω–∏–µ:** –ï—Å–ª–∏ Telegram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–π, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏–ª–∏ —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≤–∏—Å–Ω–µ—Ç –∏–ª–∏ —É–ø–∞–¥–µ—Ç —Å –æ—à–∏–±–∫–æ–π (500).
    *   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (—á–µ—Ä–µ–∑ `transaction.on_commit` + background task).

3.  **`storefront/ai_signals.py` (MEDIUM):**
    *   **–õ–æ–≥–∏–∫–∞:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è OpenAI API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SEO.
    *   **–í–ª–∏—è–Ω–∏–µ:** –ó–∞–¥–µ—Ä–∂–∫–∞ 2-10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.
    *   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É.

### 9.2. Context Processors
**–§–∞–π–ª:** `storefront/context_processors.py`

1.  **`orders_processing_count`:**
    *   **–†–∏—Å–∫:** –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –ë–î –Ω–∞ *–∫–∞–∂–¥–æ–π* —Å—Ç—Ä–∞–Ω–∏—Ü–µ –¥–ª—è staff-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    *   **–ü–ª—é—Å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (60 —Å–µ–∫).
    *   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `Order.get_processing_count()` (–≤ `orders/models.py`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã (`status='new'`).

### 9.3. Management Commands
**–§–∞–π–ª:** `storefront/management/commands/generate_google_merchant_feed.py`
*   **CRITICAL N+1:** –í–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å `ProductColorVariant.objects.filter(product=product)`.
    *   –ï—Å–ª–∏ 1000 —Ç–æ–≤–∞—Ä–æ–≤ -> 1001 –∑–∞–ø—Ä–æ—Å –∫ –ë–î.
    *   –í —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –≤—ã–∑–æ–≤–æ–º –∏–∑ —Å–∏–≥–Ω–∞–ª–∞ —ç—Ç–æ **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ** –≤–µ—à–∞–µ—Ç –∞–¥–º–∏–Ω–∫—É –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤.
*   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
    1.  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `prefetch_related('color_variants__color', 'color_variants__images')` –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ —Ç–æ–≤–∞—Ä–æ–≤.
    2.  –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É —Å–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏ (Python dict) –≤–º–µ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Ü–∏–∫–ª–µ.

### 9.4. Serializers & Models Properties
1.  **`orders/models.py`:**
    *   **Property `color_name`:** –û–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `self.color_variant.color`. –ï—Å–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ `OrderItem` –Ω–µ —Å–¥–µ–ª–∞—Ç—å `select_related('color_variant__color')`, —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç N+1 –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏.

2.  **`storefront/serializers.py`:**
    *   –í —Ü–µ–ª–æ–º –∫–æ–¥ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π (`ProductListSerializer` –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω).
    *   `CartItemSerializer` –¥–µ–ª–∞–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é —á–µ—Ä–µ–∑ `exists()`, —á—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

## 10. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (Phase 7: Infrastructure)

### 10.1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ (CRITICAL)
*   **Celery / Django-Q:** –í –ø—Ä–æ–µ–∫—Ç–µ **–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á.
*   **–í–ª–∏—è–Ω–∏–µ:** –í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–Ω–æ—Å—É —Ç—è–∂–µ–ª—ã—Ö –∑–∞–¥–∞—á (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–¥–æ–≤, –æ—Ç–ø—Ä–∞–≤–∫–∞ Telegram, AI –≥–µ–Ω–µ—Ä–∞—Ü–∏—è) —Ç—Ä–µ–±—É—é—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á. –ë–µ–∑ —ç—Ç–æ–≥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.
*   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–Ω–µ–¥—Ä–∏—Ç—å **Celery + Redis** (—Ç–∞–∫ –∫–∞–∫ Redis —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫—ç—à–∞).

### 10.2. Telegram Notifications
*   **–§–∞–π–ª:** `orders/telegram_notifications.py`
*   **–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `requests.post` (—Å—Ç—Ä–æ–∫–∞ 46).
*   **–†–∏—Å–∫:** –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å API Telegram (timeout), —Å–∞–π—Ç –±—É–¥–µ—Ç –∂–¥–∞—Ç—å 10 —Å–µ–∫—É–Ω–¥ (timeout=10) –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –æ—Ç–¥–∞—Ç—å –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∏–ª–∏ —É–ø–∞–¥–µ—Ç —Å 500 –æ—à–∏–±–∫–æ–π.

### 10.3. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ –®–∞–±–ª–æ–Ω—ã (CRITICAL)
*   **URL:** `/checkout/` -> `storefront.views.checkout.checkout`
*   **Template:** `pages/checkout.html` (—Å—Ç—Ä–æ–∫–∞ 123 –≤ `checkout.py`)
*   **–°—Ç–∞—Ç—É—Å:** **–§–ê–ô–õ –û–¢–°–£–¢–°–¢–í–£–ï–¢**.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ `/checkout/` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É 500 (TemplateDoesNotExist).
*   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°—Ä–æ—á–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —à–∞–±–ª–æ–Ω –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –Ω–∞ —Ä–∞–±–æ—á–∏–π —á–µ–∫–∞—É—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ React –∏–ª–∏ –¥—Ä—É–≥–æ–π view).


## 11. –ú–µ—Ç–∞-–ê–Ω–∞–ª–∏–∑ –∏ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (Phase 8: Meta-Analysis)

–í —ç—Ç–æ–π —Ñ–∞–∑–µ –º—ã –ø—Ä–æ–≤–µ–ª–∏ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –Ω–∞—Ö–æ–¥–æ–∫ –∏ —É–≥–ª—É–±–∏–ª–∏—Å—å –≤ –º–µ—Ö–∞–Ω–∏–∑–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞–ª–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏—è.

### 11.1. –¢–∞–π–Ω–∞ Checkout (–†–∞–∑–≥–∞–¥–∫–∞)
- **–ù–∞—Ö–æ–¥–∫–∞**: –†–∞–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–π "—Å–ª–æ–º–∞–Ω–Ω—ã–π" view `checkout` (—Å—Å—ã–ª–∞—é—â–∏–π—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω `pages/checkout.html`) –æ–∫–∞–∑–∞–ª—Å—è **–º–µ—Ä—Ç–≤—ã–º –∫–æ–¥–æ–º**.
- **–†–µ–∞–ª—å–Ω–æ—Å—Ç—å**: –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (JavaScript) —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Monobank.
- **–ú–µ—Ö–∞–Ω–∏–∑–º**:
    - –í `main.js` (—Å—Ç—Ä–æ–∫–∞ 1152) —Ñ—É–Ω–∫—Ü–∏—è `bindMonobankPay` –≤–µ—à–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫–∏ —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º `data-monobank-pay-trigger`.
    - –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è AJAX-–∑–∞–ø—Ä–æ—Å (–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞), –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ URL –æ–ø–ª–∞—Ç—ã Monobank (`data.invoice_url`).
- **–†–∏—Å–∫**: View `checkout` –≤—Å–µ –µ—â–µ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ URL `/checkout/`. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–ª–∏ –±–æ—Ç) –ø–æ–ø–∞–¥–µ—Ç —Ç—É–¥–∞ –Ω–∞–ø—Ä—è–º—É—é, –æ–Ω –ø–æ–ª—É—á–∏—Ç 500 Error.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –£–¥–∞–ª–∏—Ç—å `storefront/views/checkout.py` –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π URL, –ª–∏–±–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é/–∫–æ—Ä–∑–∏–Ω—É.

### 11.2. Middleware Deep Dive
- **`UTMTrackingMiddleware` (storefront/utm_middleware.py)**:
    - **–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ (—É—Å–ª–æ–≤–Ω–æ)**.
    - **–ê–Ω–∞–ª–∏–∑**: –í –∫–æ–¥–µ –µ—Å—Ç—å –≤—ã–∑–æ–≤ `get_geolocation`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π API (`ip-api.com`), –Ω–æ —ç—Ç–æ—Ç –≤—ã–∑–æ–≤ **–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω** (—Å—Ç—Ä–æ–∫–∞ 110). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ `GeoIP2`.
    - **–†–∏—Å–∫**: –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É 110 –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏, —Å–∞–π—Ç "–≤—Å—Ç–∞–Ω–µ—Ç" (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å).
- **`ImageOptimizationMiddleware` (twocomms/image_middleware.py)**:
    - **–°—Ç–∞—Ç—É—Å**: üî¥ **CRITICAL PERFORMANCE RISK**.
    - **–ê–Ω–∞–ª–∏–∑**: Middleware –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç **–∫–∞–∂–¥—ã–π** –æ—Ç–≤–µ—Ç —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –µ–≥–æ –≤ –ø–∞–º—è—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —á–µ—Ä–µ–∑ PIL (Pillow) **—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ** –ø–µ—Ä–µ–¥ –æ—Ç–¥–∞—á–µ–π –∫–ª–∏–µ–Ω—Ç—É.
    - **–ü—Ä–æ–±–ª–µ–º–∞**: –≠—Ç–æ CPU-bound –æ–ø–µ—Ä–∞—Ü–∏—è. –ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∑–∞—Ö–æ–¥–µ 10-20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–∏—Ö –Ω–µ–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, CPU —Å–µ—Ä–≤–µ—Ä–∞ —É–π–¥–µ—Ç –≤ –ø–æ–ª–∫—É 100%, –±–ª–æ–∫–∏—Ä—É—è –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
    - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –û—Ç–∫–ª—é—á–∏—Ç—å —ç—Ç–æ—Ç middleware. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å:
        1. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–≤ `save()` –º–æ–¥–µ–ª–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ Celery).
        2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CDN —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π "–Ω–∞ –ª–µ—Ç—É" (Cloudflare, Cloudinary).
        3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sorl-thumbnail` –≤ —à–∞–±–ª–æ–Ω–∞—Ö.

### 11.3. Frontend & Static Files
- **`main.js`**:
    - **–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**. –ü–æ–¥–∫–ª—é—á–µ–Ω –≤ `base.html` –∫–∞–∫ –º–æ–¥—É–ª—å. –°–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –ª–æ–≥–∏–∫—É —á–µ–∫–∞—É—Ç–∞.
- **–°–∂–∞—Ç–∏–µ (Compression)**:
    - **–ù–∞—Å—Ç—Ä–æ–π–∫–∞**: `COMPRESS_ENABLED = False` –≤ `settings.py`.
    - **WhiteNoise**: –í–∫–ª—é—á–µ–Ω (`CompressedManifestStaticFilesStorage`). –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç Gzip/Brotli —Å–∂–∞—Ç–∏–µ, —á—Ç–æ —Ö–æ—Ä–æ—à–æ.
    - **–£–ø—É—â–µ–Ω–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å**: –ë–µ–∑ `django-compressor` (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∞) CSS/JS —Ñ–∞–π–ª—ã –Ω–µ –º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è (—É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤) –∏ –Ω–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª. –≠—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ–±—ä–µ–º —Ç—Ä–∞—Ñ–∏–∫–∞.

### 11.4. Caching Infrastructure
- **Redis**: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `django_redis.cache.RedisCache` –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–∞, –ø—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ –≤ –ª–æ–≥–∏–∫–µ –∫–ª—é—á–µ–π (–∫–∞–∫ –Ω–∞–π–¥–µ–Ω–æ –≤ –§–∞–∑–µ 5).

## 12. –ò—Ç–æ–≥–æ–≤–æ–µ –†–µ–∑—é–º–µ (Executive Summary)
–ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é –±–∞–∑—É, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç **–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ** –ø—Ä–æ–±–ª–µ–º—ã, –¥–µ–ª–∞—é—â–∏–µ –∑–∞–ø—É—Å–∫ —Ä–µ–∫–ª–∞–º—ã –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–º.

**–¢–æ–ø-5 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ü—Ä–æ–±–ª–µ–º (MUST FIX):**
1.  **–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (CPU & I/O):**
    *   `ImageOptimizationMiddleware`: –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–∂–∞—Ç–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –Ω–∞ –ª–µ—Ç—É (CPU kill).
    *   `storefront/signals.py`: –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–¥–æ–≤ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.
    *   `orders/signals.py`: –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ Telegram (I/O wait).
2.  **N+1 –ó–∞–ø—Ä–æ—Å—ã:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ `cart.py` (–∫–æ—Ä–∑–∏–Ω–∞) –∏ `generate_google_merchant_feed.py`.
3.  **–ú–µ—Ä—Ç–≤—ã–π –ö–æ–¥ / Confusion:** View `checkout` —Å–ª–æ–º–∞–Ω, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –ø—É—Ç–∞–Ω–∏—Ü—É –∏ —Ä–∏—Å–∫ 500 –æ—à–∏–±–∫–∏ –ø–æ –ø—Ä—è–º–æ–º—É URL.
4.  **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ö–∞—Ç–∞–ª–æ–≥–∞:** –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–ª—é—á –∫—ç—à–∞ –ª–æ–º–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã.
5.  **Frontend Performance:** –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π `analytics-loader.js` –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ JS/CSS.

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ–∫–ª–∞–º–µ:** üî¥ **–ù–ï –ì–û–¢–û–í**

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π:**
1.  **Disable Dangerous Middleware:** –û—Ç–∫–ª—é—á–∏—Ç—å `ImageOptimizationMiddleware` –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.
2.  **Setup Celery:** –í–Ω–µ–¥—Ä–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –¥–ª—è Telegram, OpenAI –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∏–¥–æ–≤.
3.  **Cleanup Dead Code:** –£–¥–∞–ª–∏—Ç—å `checkout.py` –∏ –º–∞—Ä—à—Ä—É—Ç `/checkout/`.
4.  **Optimize DB:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 –≤ –∫–æ—Ä–∑–∏–Ω–µ –∏ —Ñ–∏–¥–∞—Ö.
5.  **Fix Caching:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.
---
*–î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∞–≥–µ–Ω—Ç–æ–º Antigravity.*
