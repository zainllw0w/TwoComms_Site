# PERFORMANCE_FIX_FOLLOWUP

## 1. Перепроверка исправлений 1‑16

- **Проблема #16 (COMPRESS_OFFLINE)** — предыдущий агент выставил `COMPRESS_OFFLINE = not DEBUG`, но не добавил защиту и шаг `python manage.py compress` в рабочий процесс. На сервере выполняли только `git pull`, поэтому Django Compressor пытался найти `staticfiles/CACHE/manifest.json` и падал с `OfflineGenerationError`, что и давало 500-ые.
- **Что сделано сейчас**:
  - добавил функцию `_ensure_compress_offline()` в `settings.py`/`production_settings.py`. Если манифест отсутствует, проект автоматически откатывается в on-the-fly режим и выводит предупреждение, вместо полного падения;
  - описал требование запускать `python manage.py compress --force` перед `collectstatic` (см. ниже), чтобы оффлайн-режим действительно работал.
- Остальные пункты 1‑15 остались без ощутимых изменений — CSS по‑прежнему ~475 KB, `backdrop-filter` используется сотни раз, поэтому нагрузка на GPU/CPU не упала.

## 2. Новые оптимизации

- **Глобальный режим `effects-lite`**:
  - класс назначается сразу на `<html>`, а JS может снять его только если устройство явно мощное (`>=12 GB RAM` и `>=8` ядер) или пользователь вручную включил high‑quality;
  - добавлены CSS-переопределения: `backdrop-filter` полностью отключается, фоновые частицы/«свечения» и дорогие анимации не запускаются, стеклянные блоки получают статичный фон. Это значительно снижает GPU load на ПК и старых Android.
- **LocalStorage-переключатель**:
  - можно записать `localStorage.setItem('twc-effects-mode','high')` чтобы вернуть стеклянный интерфейс, или `...'lite'` чтобы снова зафиксировать лёгкий режим;
  - класс `effects-high` добавлен для будущего UI-переключателя.
- **Документация** — текущее описание (этот файл) фиксирует, что именно изменено, что ещё осталось (CSS-дубликаты, backdrop/filter, тяжёлые анимации) и почему прошлые правки не дали эффекта.

## 3. Рекомендации по деплою

1. Локально собрать бандлы:
   ```bash
   SECRET_KEY=dummy DEBUG=1 python3 manage.py compress --force
   python3 manage.py collectstatic --noinput
   ```
2. На сервере выполнять тот же порядок (compress → collectstatic), иначе `_ensure_compress_offline()` переведёт проект в on-the-fly режим.
3. После `git pull` обязательно:
   ```bash
   source /home/qlknpodo/virtualenv/TWC/TwoComms_Site/twocomms/3.13/bin/activate
   python manage.py compress --force
   python manage.py collectstatic --noinput
   ```

## 4. Следующие шаги

- Разобрать файл `styles.css`: в нём несколько тысяч строк с дубликатами и закомментированными блоками; нужно вынести повторяющиеся секции в модули и разбить CSS по страницам.
- Перепроверить `ImageOptimizationMiddleware` (проблема #7): сейчас он всё ещё перекодирует изображения при первом запросе и всегда отдаёт WebP без проверки `Accept` — это тормозит и может ломать Safari <14.
- После чистки CSS добавить лёгкий UI-тогглер между режимами «Lite / High», чтобы пользователи могли включить визуальные эффекты по желанию без локального `localStorage` хака.
