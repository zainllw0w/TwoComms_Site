# Исправление отображения всех товаров при предоплате в Monobank Checkout

**Дата:** 2025-01-25  
**Статус:** ✅ Завершено и развернуто

## Проблема

При оформлении предоплаты (prepay_200) в Monobank Checkout отображался только первый товар одной позицией, даже если в заказе было несколько товаров.

**Пример проблемы:**
- Заказ: "Слава України" + "Тихі зимовий"
- Отображалось: только "Слава України" одной позицией с предоплатой 200 грн
- Ожидалось: оба товара отдельными позициями с полными ценами

## Решение

Изменена логика формирования корзины для предоплаты: теперь все товары показываются отдельными позициями с полными ценами (как при полной оплате), а информация о предоплате добавляется в описание последнего товара.

### Что изменилось

**До:**
- Берётся только первый товар (`items[0]`)
- Создаётся одна позиция с названием первого товара
- Цена: 200 грн (предоплата)
- Описание: информация о предоплате

**После:**
- Проходим по всем товарам (`enumerate(items)`)
- Создаём отдельную позицию для каждого товара
- Каждый товар со своей полной ценой (`unit_price`)
- Количество (`cnt`) для каждого товара корректное
- Изображение для каждого товара
- В описание последнего товара добавляется информация о предоплате

### Формат отображения

**Пример для 2 товаров:**

**Позиция 1:**
- Название: Слава України • розмір M • синій
- Цена: 350 грн (полная цена)
- Количество: 1
- Изображение: ✅

**Позиция 2:**
- Название: Тихі зимовий • розмір L • чорний
- Цена: 200 грн (полная цена)
- Количество: 1
- Изображение: ✅
- **Описание:** Передплата 200 грн за 2 товарів. Залишок 350.00 грн — при отриманні на Новій Пошті

### Описание

- **1 товар:** "Передплата 200 грн. Залишок X грн — при отриманні на Новій Пошті"
- **Несколько товаров:** "Передплата 200 грн за N товарів. Залишок X грн — при отриманні на Новій Пошті"

## Изменения в коде

**Файл:** `twocomms/storefront/views.py`  
**Функция:** `_build_monobank_checkout_payload()`  
**Строки:** 5680-5742

### Ключевые изменения:

1. **Цикл по всем товарам** вместо одного первого
2. **Полные цены** для каждого товара
3. **Корректные количества** для каждого товара
4. **Изображения** для каждого товара
5. **Описание** добавляется только к последнему товару

### Код:

```python
if is_prepay:
    # Для предоплаты добавляем все товары отдельными позициями с полными ценами
    for idx, item in enumerate(items):
        # ... формирование данных для товара ...
        
        product_entry = {
            'name': product_name,
            'cnt': qty,
            'price': _as_number(unit_price_major),  # полная цена
        }
        
        if item.product.main_image:
            product_entry['icon'] = request.build_absolute_uri(item.product.main_image.url)
        
        # Для последнего товара добавляем описание
        if idx == len(items) - 1:
            if len(items) > 1:
                product_entry['description'] = f'Передплата 200 грн за {len(items)} товарів. Залишок {total_order_sum - prepay_amount:.2f} грн — при отриманні на Новій Пошті'
            else:
                product_entry['description'] = f'Передплата 200 грн. Залишок {total_order_sum - prepay_amount:.2f} грн — при отриманні на Новій Пошті'
        
        products.append(product_entry)
```

## Логика расчета

1. **Полная сумма заказа:** `order.total_sum + order.discount_amount`
2. **Предоплата:** 200 грн (фиксированная)
3. **Остаток к доплате:** `полная_сумма - 200`
4. **Сумма в basket:** может добавляться балансирующая позиция, если нужно

## Развертывание

- ✅ Закоммичено: "Update prepayment checkout: show all items separately with full prices and remaining amount info"
- ✅ Запушено в `origin/main`
- ✅ Развернуто на продакшен
- ✅ Приложение перезапущено

## Преимущества

1. **Прозрачность:** Пользователь видит все товары в заказе
2. **Полная информация:** Каждый товар со своим изображением и полной ценой
3. **Корректность:** Количество для каждого товара правильное
4. **Информативность:** Чёткое указание остатка к доплате
5. **Единообразие:** Формат как при полной оплате

## Тестирование

Нужно проверить:
1. Заказ с 1 товаром — должна быть 1 позиция с описанием предоплаты
2. Заказ с 2+ товарами — должны быть все позиции, описание у последнего
3. Товары с разными количествами — количества корректные
4. Товары с изображениями — изображения показываются
5. Остаток к доплате — считается правильно

