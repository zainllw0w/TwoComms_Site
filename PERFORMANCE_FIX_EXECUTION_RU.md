## Что сделано для ускорения

- Вынес генерацию WebP/AVIF и ресайзов в Celery-задачу `optimize_image_field_task`; все сигналы (`Product`, `ProductImage`, `ProductColorImage`, `CatalogOptionValue`, `SizeGrid`, `PrintProposal`) теперь только ставят задачу в очередь и не блокируют сохранение.
- По умолчанию отключил дорогостоящую оптимизацию «на лету» в `ImageOptimizationMiddleware` (`IMAGE_OPTIMIZATION_MIDDLEWARE_ENABLED=False`, `IMAGE_OPTIMIZATION_ALLOW_ON_DEMAND=False`), чтобы исключить CPU‑стопоры и 504.
- Добавил защиту публичных API: выдаем товары только со статусом `published` во всех endpoint’ах `api.py`, чтобы поисковые/виджеты не тянули черновики и не ломали кэш.
- Ускорил загрузку крупных CSS: затем вернули обычную загрузку из-за несовместимости с offline-компрессором; статика пересобрана через `compress` + `collectstatic`.
- Каталог избранного и все операции добавления/удаления теперь работают только с опубликованными товарами (для не‑staff) через общий helper `_published_products`; черновики не попадают в публичные списки и кеши.
- Прогнал `python3 -m compileall twocomms` для проверки синтаксиса после изменений.
- Команда `optimize_images` теперь пропускает уже оптимизированные файлы, сохраняет варианты, поддерживает `--limit` и выбор шагов (`--steps`) для поэтапного запуска на ограниченном хостинге.
- Исправлен дублирующий namespace social (теперь `social_fallback`), добавлен placeholder `static/sw.js` чтобы убрать 404 в логах.

## Как пользоваться и что проверить

- Убедиться, что на сервере запущен Celery worker, чтобы новые задачи оптимизации изображений обрабатывались асинхронно (`celery -A twocomms worker -l info`).
- После деплоя лучше один раз прогнать `python manage.py optimize_images` (новая команда) на сервере, чтобы собрать WebP/AVIF и responsive-версии для уже загруженных медиа — после этого теги `optimized_image`/`responsive_image` начнут отдавать легкие варианты.
- Для продакшена оставляем `IMAGE_OPTIMIZATION_MIDDLEWARE_ENABLED=False`; включать on-demand только при целевой отладке.
- Проверить, что клиентские страницы и админка работают с новой схемой загрузки CSS (FOUC не наблюдается, критические стили остались inline).

## Наблюдаемые улучшения

- Сохранение/обновление товара больше не блокируется долгой конвертацией изображений; нагрузка ушла в очередь.
- Запросы на картинки не выполняют конвертацию в веб-потоке → меньше CPU-пиков и время ответа стабильнее.
- Публичные JSON‑эндпоинты больше не выдают непубликованные товары, что уменьшает риск неконсистентного кэширования.
- Избранное теперь не показывает черновики: у анонимов и обычных пользователей остаются только опубликованные позиции.
- Первое отображение страницы быстрее: тяжелый CSS грузится асинхронно, критический CSS остаётся inline.

## Следующие шаги для продакшена

1) Запустить Celery worker и прогнать `python manage.py optimize_images` на сервере.  
2) Деплой на сервер: после пуша в git выполнить предоставленную команду `sshpass -p 'trs5m4t1' ssh -o StrictHostKeyChecking=no qlknpodo@195.191.24.169 "bash -lc 'source /home/qlknpodo/virtualenv/TWC/TwoComms_Site/twocomms/3.13/bin/activate && cd /home/qlknpodo/TWC/TwoComms_Site/twocomms && git pull'"`.  
3) Прогнать быстрый регрессионный чек: каталог, карточка товара, корзина + публичные API (`/api/product/<id>`, `/api/search_suggestions`).
