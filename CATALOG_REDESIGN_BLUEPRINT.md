# Product Catalog Redesign Blueprint

## 1. Цели и границы
- Полностью обновить управление каталогами и товарами: от доменных моделей до UI/UX.
- Объединить работу с цветами, изображениями, SEO и AI-инструментами в единый поток.
- Сохранить обратную совместимость с существующими товарами, не ломая текущий пользовательский опыт.
- Повысить производительность (кеши, ленивые операции, минимизация запросов) и улучшить DX для администраторов.

## 2. Текущий ландшафт
- **Модели**: `Product`, `Category`, `Color`, `ProductColorVariant`, `ProductColorImage` живут отдельно; нет сущностей каталога/опций/size grid.
- **Формы и вьюхи**: `ProductForm` и `add_product` во `views.py` покрывают базовую CRUD-логику + работу с цветами в одном массивном обработчике.
- **Шаблон**: `templates/pages/add_product_new.html` — современный UI, но логика смешана, drag & drop и система сеток отсутствуют.
- **JS/CSS**: Общий `main.js` и `styles.css` содержат оптимизации, анимации, но отсутствует специализированный модуль для конструктора товаров.
- **SEO/AI**: Поля в моделях есть, но авто-генерация и аналитика минимальны, нет пайплайна.
- **API**: Django views, частично AJAX (JSON) без выделенного слоя сериализации.

## 3. Целевая архитектура

### 3.1 Доменные модели и хранилище
1. **Каталоги и опции**
   - Создать модели `Catalog`, `CatalogOption`, `CatalogOptionValue`, `SizeGrid` согласно ТЗ.
   - Нормализовать связи: `Product.catalog` (`PROTECT`), `CatalogOption` с упорядочиванием и типами, `CatalogOptionValue` с медиа.
2. **Продукт**
   - Расширить `Product` дополнительными полями: статус публикации, SEO поля (title, description, keywords), AI маркеры, reference на size grid и recommendation tags.
   - Добавить служебные поля для drag & drop (`order`, `priority_score`) и контроля публикации.
3. **Цвета**
   - Сохранить `Color` как справочник, вынести создание/поиск в сервис, запретить дубликаты hex.
   - Дополнить `ProductColorVariant` полями для ассортимента (sku, stock, barcode), привязать drag & drop порядок.
4. **Изображения**
   - Выделить общую сущность `MediaAsset` (опционально) либо сервис, отвечающий за сохранение, оптимизацию и связь с цветами и продуктом.
5. **Миграции**
   - Поэтапно: сначала модели `Catalog*`, затем изменение `Product`, далее перенос/нормализация данных.
   - Provide data-migration скрипты для заполнения slug, каталога по умолчанию и связи существующих цветов.

### 3.2 Сервисный слой
- Создать `storefront/services/catalog/` с модулями:
  - `catalog_service.py` — CRUD и бизнес-правила для каталогов/опций.
  - `color_service.py` — дедупликация цветов, drag & drop порядка, генерация палитр.
  - `media_service.py` — загрузка, компрессия, генерация превью/вебп, интеграция с S3/CDN.
  - `ai_service.py` — обёртка над AI-провайдерами (SEO текст, ALT-тексты, рекомендация ключевых слов).
  - `seo_service.py` — генерация мета тегов, slug, canonical, структурированные данные.
  - `recommendation_service.py` — подбор связанных товаров, трендов, tags.
- Логику вынести из громоздкого `add_product` в отдельные use-case функции/классы.

### 3.3 API и представления
- Разделить интерфейсы:
  - Django views для HTML (admin UI).
  - DRF viewsets/эндпоинты (`/api/catalogs/`, `/api/products/`, `/api/products/:id/colors/`) для динамического UI и интеграций.
- Ввести сериализаторы: для продукта, вариантов цвета, каталога, size grid.
- Добавить эндпоинты:
  - Drag & drop reorder (PATCH).
  - Предпросмотр SEO/AI (POST).
  - Автосохранение черновика (PATCH/PUT).
- Использовать пермишены (администратор/дропшипер) + rate limit для AI/SEO генерации.

### 3.4 Формы и административный UI
- Создать модуль `forms/catalog.py` с формами каталогов, size grids, опций.
- Обновить `ProductForm`:
  - Вынести во `forms/product.py`, разбить на подформы (основная информация, цены, SEO, AI, рекомендации).
  - Добавить `ModelFormSet` для цветовых вариантов и изображений.
- Использовать `FormWizard` или кастомный `Stepper` (JS) для пошагового заполнения.
- Обеспечить сохранение черновиков через hidden autosave (AJAX) и вывод прогресса чеклиста.

### 3.5 Шаблоны и фронтенд
- Новый шаблон `templates/pages/product_builder.html` (рабочее название) с разделами:
  1. Основная информация.
  2. Каталог/категории/теги.
  3. Цвета и изображения (drag & drop, multi-upload, предпросмотр).
  4. SEO/AI (генерация, анализ, проверки лимитов).
  5. Рекомендации и size grid.
  6. Предпросмотр + публикация.
- Компонентный подход (partials) и макросы, переиспользующиеся в других админских шаблонах.
- JS-модули:
  - `product-builder.js` — orchestrator (state machine, autosave, tabs).
  - `color-manager.js` — drag & drop, dedup, preview, upload queue.
  - `media-uploader.js` — оптимизация картинок, прогресс-бары, обработка ошибок.
  - `seo-ai-panel.js` — вызовы AI, подсветка ключевых слов, счетчики символов.
- Использовать `IntersectionObserver`, `MutationObserver` для реактивности без heavy framework; предусмотреть возможность перехода на htmx/Stimulus при необходимости.

### 3.6 AI и SEO пайплайн
- Подготовить абстракцию `AIProvider` (OpenAI/Local) + настройки через `.env`.
- Асинхронная обработка (Celery/RQ) для генерации контента и анализа изображений; fallback — синхронный с тайм-аутом.
- Хранить AI вывод в JSONB-поля или отдельной модели `ProductAIInsights`.
- Автоматически генерировать:
  - ALT-тексты для изображений.
  - SEO title/description, keywords.
  - Подсказки по описанию и рекомендациям.
- Логировать запросы и ответы, сохранять историю генераций.

### 3.7 Производительность и кеширование
- Использовать Redis кеш для:
  - Списков каталогов/опций.
  - Пререндеренных цветовых превью.
  - Результатов SEO/AI анализа (с TTL).
- Внедрить ленивую загрузку изображений, генерацию webp/avif, background tasks для тяжелых операций.
- Добавить метрики (Prometheus/exporter) для ключевых операций (AI, загрузка изображений).

### 3.8 Безопасность и контроль доступа
- Отделить роли (администратор, менеджер контента, дропшипер) через `django.contrib.auth` + `UserProfile`.
- Проверять права на уровне views/API.
- Валидировать и санитизировать HTML описаний (bleach/markdown).
- Ограничить размеры файлов и типы MIME, проверять изображения (Pillow).

### 3.9 Интеграции и совместимость
- Предусмотреть миграцию существующих товаров: маппинг категорий → каталоги, цвета → Color справочник.
- Обеспечить обратную совместимость URL и slug.
- Синхронизироваться с существующими страницами (`dropshipper_products.html`, `dropshipper_dashboard.html`) через частичные шаблоны и API.

## 4. Дорожная карта реализации

### Фаза 0 — Подготовка
- Актуализировать ветку (git pull), включить фичефлаг `CATALOG_REDESIGN`.
- Настроить окружение (Celery/Redis, AI ключи), обновить `requirements.txt` (Pillow extras, requests, drf).
- Создать временные бэкапы БД и статических файлов.

### Фаза 1 — Домен и данные
- Добавить модели `Catalog*`, миграции, админку.
- Расширить `Product` + связанные модели, подготовить миграционные скрипты.
- Написать сервисы работы с каталогом/цветами, покрыть unit-тестами.
- Создать фикстуры/seed данные для dev среды.

### Фаза 2 — Backend логика
- Реализовать пайплайн сохранения товара (сервисы + viewsets).
- Добавить DRF сериализаторы и эндпоинты для каталога, цветов, изображений, SEO.
- Вынести функции из `views.py` в модульные контроллеры (`storefront/views/catalog.py`, `storefront/views/product_builder.py`).
- Настроить права и rate limiting.

### Фаза 3 — UI/UX
- Создать новый шаблон конструктора товара и partials.
- Написать JS-модули (builder, colors, uploader, seo/ai) + подключить в `base.html` по фичефлагу.
- Реализовать drag & drop, множественную загрузку, предпросмотр, чеклисты.
- Обновить стили (`styles.css`, новые SCSS/utility классы).

### Фаза 4 — AI и SEO
- Внедрить AI сервис (включая очередь задач), создать UI для генерации/редактирования.
- Подключить анализ изображений, генерацию ALT-текста, рекомендации.
- Настроить SEO автоматику, предупреждения и предпросмотр.

### Фаза 5 — Тестирование и запуск
- Покрыть unit-тестами модели, сервисы, сериализаторы, JS (Jest/Vitest).
- Написать интеграционные тесты (Django + Playwright для UI).
- Прогнать чеклист, smoke-тесты, нагрузочные тесты изображений.
- Обновить документацию (README, user guide), подготовить инструкции отката.
- Запустить за фичефлагом, собрать фидбек, раскатить на всех пользователей.

## 5. Стратегия тестирования
- **Unit**: модели, сервисы, сериализаторы, формы.
- **Integration**: основные сценарии добавления товара, drag & drop, AI генерации (mock).
- **E2E/UI**: добавление товара через новый интерфейс (Playwright).
- **Performance**: загрузка каталога, генерация рекомендаций, стресс-тест мульти-аплоада.
- **Regression**: существующие страницы каталога, корзины, API дропшипа.

## 6. Риски и меры
- **Миграция данных**: риск неконсистентности цветов → dry-run миграций, резервные копии, reversible scripts.
- **AI зависимость**: недоступность провайдера → graceful fallback, кеширование прошлых генераций.
- **Производительность**: тяжелые изображения и AI → очереди задач, лимиты размера, фоновые оптимизации.
- **UX сложность**: перегруженность интерфейса → поэтапный UX (stepper), подсказки, режим черновика.
- **Совместимость**: старые шаблоны/URL → фичефлаг, двойной рендеринг до полной миграции.

## 7. Инструменты и наблюдаемость
- **MCP/Context7**: для проверки best practices и актуальной документации Django/DRF.
- **CI/CD**: обновить пайплайн (линтеры, tests, build статик, collectstatic).
- **Observability**: Sentry для фронта/бэка, Prometheus/Grafana для бэкенда, логирование AI.
- **Dev Experience**: make-команды (`make migrate_catalog`, `make seed_catalog`), скрипты автогенерации данных.

## 8. Основные артефакты
- Новые модели и миграции.
- Сервисный слой (`storefront/services/catalog/*`).
- DRF эндпоинты + сериализаторы.
- Новый шаблон и JS модули конструктора товара.
- Документация: гайд по работе с конструктором, инструкции по откату, чеклисты тестирования.

---

## 9. Состояние проекта (24.10.2025)

### Выполнено
- **Домен**: добавлены `Catalog`, `CatalogOption`, `CatalogOptionValue`, `SizeGrid`, расширен `Product`, обновлены цветовые варианты; миграции `storefront/0032_*`, `productcolors/0003_*`, `orders/0034_*`.
- **Формы**: переработаны `ProductForm`, `ProductSEOForm`, подготовлены formset’ы (`CatalogOptionFormSet`, `build_color_variant_formset`) и вложенные formset’ы изображений.
- **Backend**: создан сервис `storefront/services/product_builder.py`; расширены сериализаторы и `viewsets`, добавлен `AdminProductBuilderViewSet`, новые маршруты в `api_urls.py`.
- **UI/UX**: шаблон `product_builder.html`, drag&drop цветов, мультизагрузка изображений, size-grid превью, прогресс и чек-лист; обновлены `product-builder.css/js`.
- **Документы**: `CATALOG_REDESIGN_CHECKLIST.md` и `CATALOG_REDESIGN_BLUEPRINT.md` дополнены актуальной информацией.

### Оставшиеся задачи
- **Фаза 4**: AI (описания, ключевые слова, ALT) через очередь задач; UI-триггеры для генерации; кеширование и журналирование AI-ответов.
- **Фаза 5**: unit/integration/E2E тесты (конструктор, API, сервисы), обновление инструкций по деплою/откату, итоговая проверка. Тесты пока не запускаются из-за отсутствия прав на создание тестовой БД в MySQL.

### Быстрый старт для продолжения
1. Начинать с сервиса `storefront/services/product_builder.py` и `AdminProductBuilderViewSet`: здесь лежит логика подготовки данных для конструктора.
2. Для AI интеграций использовать заготовки в `storefront/seo_utils.py` и `storefront/ai_signals.py` (учесть флаги `USE_AI_*` и наличие `OPENAI_API_KEY`).
3. Для тестирования договориться о правах на тестовую БД или временно использовать SQLite через настройки `DATABASES['default']['TEST']`.
