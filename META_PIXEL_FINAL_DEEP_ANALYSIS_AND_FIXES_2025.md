# üî¨ –§–ò–ù–ê–õ–¨–ù–´–ô –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó META PIXEL ‚Äî –ê–ö–¢–£–õ–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –í–ï–†–°–ò–Ø 5.1

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-01-30  
**–í–µ—Ä—Å–∏—è:** 5.1 ‚Äî –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–∞  
**–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:** Context7 + —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ + —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º SDK Meta  
**–°—Ç–∞—Ç—É—Å:** –õ–æ–∂–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–Ω—è—Ç—ã, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

---

## üìã EXECUTIVE SUMMARY

–ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≤–∏–∑–∏—è –∫–æ–¥–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ–∫–∞–∑–∞–ª–∞, —á—Ç–æ –¥–≤–µ —Ä–∞–Ω–µ–µ –∑–∞—è–≤–ª–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (country_code –∏ —Ñ–ª–∞–≥–∏ —Å–æ–±—ã—Ç–∏–π) –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç—Å—è. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –≤—ã—è–≤–ª–µ–Ω **1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥** (race condition –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ Monobank webhook) –∏ **8 –≤–∞–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º**, –≤–ª–∏—è—é—â–∏—Ö –Ω–∞ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

### –°–Ω—è—Ç—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
1. **–ü–†–û–ë–õ–ï–ú–ê #1 (country_code)** ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `user_data.country_code` (—Å–º. `twocomms/orders/facebook_conversions_service.py:141-147`) –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `facebook_business.adobjects.serverside.UserData` –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ SDK. –ü–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `country_code`, SDK —Å–∞–º –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏ —Ö–µ—à–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –ø–æ—ç—Ç–æ–º—É –∑–∞–º–µ–Ω–∞ –Ω–∞ `country` –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
2. **–ü–†–û–ë–õ–ï–ú–´ #11/#11B (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤)** ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `_record_monobank_status()` (—Å–º. `twocomms/storefront/views/utils.py:503-549`): –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç—Å—è `facebook_events.lead_sent/purchase_sent`. –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–±–µ–ª —Å–≤—è–∑–∞–Ω —Ç–æ–ª—å–∫–æ —Å —Ç–µ–º, —á—Ç–æ –ø—É—Ç—å —á–µ—Ä–µ–∑ Nova Poshta –Ω–µ –ø–∏—à–µ—Ç —ç—Ç–∏ —Ñ–ª–∞–≥–∏ (–ø–æ–¥—Ä–æ–±–Ω–æ –≤ –ø—Ä–æ–±–ª–µ–º–µ #9).

### –¢–µ–∫—É—â–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)
1. **Race condition –≤ `_record_monobank_status()`** ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–≤—É–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º webhook-–∑–∞–ø—Ä–æ—Å–∞–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å Purchase/Lead –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑.

### –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
2. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞ Conversions API –Ω–∞ –æ—à–∏–±–∫–∏.  
3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `event_time` —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π –±–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏.  
4. –ì–æ—Ä–æ–¥ —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è –¥–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (–ø—Ä–æ–±–µ–ª—ã –∏ –∑–Ω–∞–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è, Meta –Ω–µ —Å–º–æ–∂–µ—Ç —Å–º–∞—Ç—á–∏—Ç—å).  
5. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–∞–∫–∞—è –∂–µ –≤–∞–ª–∏–¥–∞—Ü–∏—è email/phone/value, –∫–∞–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.  
6. –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–º–∏–ª–∏–∏ —Ä–∞–∑–ª–∏—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É `analytics-loader.js` –∏ `order_success.html`/—Å–µ—Ä–≤–µ—Ä–æ–º.  
7. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ —Å—Ç—Ä–æ–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ `sessionStorage`, —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ —Ñ–ª–∞–≥–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.  
8. –ù–µ—Ç retry/backoff –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö API.  
9. –ü—É—Ç—å —á–µ—Ä–µ–∑ Nova Poshta –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `facebook_events.purchase_sent`, –ø–æ—ç—Ç–æ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –±—É–¥—É—â–∞—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–µ –≤–∏–¥—è—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ.

---

## ‚úÖ –°–Ω—è—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #1: country_code –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–ö–æ–¥:** `twocomms/orders/facebook_conversions_service.py:141-147`
- **–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏:** –≤ SDK `facebook_business.adobjects.serverside.UserData` (—Å–º. `user_data.py`, —Å—Ç—Ä–æ–∫–∏ 72-116 –∏ 616-655) –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `country_code/country_codes`. –ú–µ—Ç–æ–¥ `normalize()` —Å–∞–º –ø—Ä–∏–≤–æ–¥–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫ –¥–≤—É–º –±—É–∫–≤–∞–º ISO –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç SHA-256, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—â—ë –Ω–µ –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–æ. –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (`self._hash_data('ua')`) —É–∂–µ –¥–∞—ë—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SHA-256 –∏ –Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è Meta.
- **–í—ã–≤–æ–¥:** –æ—à–∏–±–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–æ–∏—Ç –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä–∞–Ω—ã –∑–∞–∫–∞–∑–∞, –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤—ã–π–¥–µ—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã UA.

## ‚úÖ –°–Ω—è—Ç–∞—è –ø—Ä–æ–±–ª–µ–º–∞ #11/#11B: –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ñ–ª–∞–≥–æ–≤
- **–ö–æ–¥:** `twocomms/storefront/views/utils.py:504-549`
- **–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏:** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ Monobank `facebook_events.lead_sent/purchase_sent` –≤—ã—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `send_lead_event()`/`send_purchase_event()`. –ü–æ—ç—Ç–æ–º—É –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö webhook-–æ–≤. 
- **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–±–µ–ª:** –º–µ—Ç–æ–¥ `facebook_conversions_service.send_purchase_event()` —Å–∞–º –ø–æ —Å–µ–±–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ `payment_payload['fb_conversions_api']`, –∞ –Ω–µ `facebook_events`. –ü–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ Nova Poshta (—Å–º. –ø—Ä–æ–±–ª–µ–º—É #9) –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ –Ω–µ –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥–æ–≤ –≤ `facebook_events`, –Ω–æ —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –±–∞–≥ –∏–∑ EXECUTIVE SUMMARY 5.0.

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê #1: Race condition –≤ `_record_monobank_status()`
**–§–∞–π–ª:** `twocomms/storefront/views/utils.py:385-620`

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
- –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞ –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `transaction.atomic()` + `select_for_update()`.
- –ï—Å–ª–∏ Monobank –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –¥–≤–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ—á—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –æ–±–µ –≤–µ—Ç–∫–∏ —É–≤–∏–¥—è—Ç `payment_status='prepaid'`, –æ–±–µ –ø–æ—Å—Ç–∞–≤—è—Ç `paid` –∏ –æ—Ç–ø—Ä–∞–≤—è—Ç Purchase/Lead, –ø–æ–∫–∞ –≤—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –µ—â—ë –Ω–µ —É–≤–∏–¥–µ–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π.

### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
- –î—É–±–ª–∏–∫–∞—Ç—ã —Å–æ–±—ã—Ç–∏–π –≤ Conversions API ‚Üí –∑–∞–≤—ã—à–µ–Ω–Ω—ã–π ROAS –∏ –Ω–µ–≤–µ—Ä–Ω–∞—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å.
- –í–æ–∑–º–æ–∂–Ω—ã –≥–æ–Ω–∫–∏ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ `payment_payload` (–∏—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å —á–∞—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤).

### –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
1. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ `_record_monobank_status()` `order_id`, –∞ –≤–Ω—É—Ç—Ä–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∑–∞–∫–∞–∑ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π.
2. –û–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤—Å—é —Ñ—É–Ω–∫—Ü–∏—é –≤ `transaction.atomic()`.

```python
from django.db import transaction
from orders.models import Order

def _record_monobank_status(order_id, payload, source='api'):
    with transaction.atomic():
        order = (Order.objects
                 .select_for_update()
                 .select_related('user')
                 .get(pk=order_id))
        return _record_monobank_status_locked(order, payload, source)
```

3. –í–Ω—É—Ç—Ä–∏ `*_locked` –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–∏—Ç–∞—Ç—å `payment_payload = order.payment_payload or {}` –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ñ–ª–∞–≥–æ–≤, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤–∏–¥–µ—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #2: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞ Conversions API
**–§–∞–π–ª:** `twocomms/orders/facebook_conversions_service.py:333-365` –∏ `374-455`

### –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
- –ü–æ—Å–ª–µ `event_request.execute()` –æ—Ç–≤–µ—Ç –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è ‚Äî –ª–æ–≥–≥–µ—Ä —Å–æ–æ–±—â–∞–µ—Ç –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–∂–µ –µ—Å–ª–∏ Meta –≤–µ—Ä–Ω—É–ª–∞ `errors` / `events_dropped`.

### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
- –°–æ–±—ã—Ç–∏—è –º–æ–≥—É—Ç —Ç–∏—Ö–æ –æ—Ç–≤–µ—Ä–≥–∞—Ç—å—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –Ω–µ–≤–µ—Ä–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–≥–æ `event_time`), –Ω–æ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ –≤—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –æ—Ç–≤–µ—Ç–∞ (–æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –∫–∞–∫ –∞—Ç—Ä–∏–±—É—Ç—ã –∏–ª–∏ —á–µ—Ä–µ–∑ `response.get(...)`). –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `errors` —Å—Ä–∞–∑—É –ø–∏—Å–∞—Ç—å –≤ –ª–æ–≥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `False`.

```python
response = event_request.execute()
errors = getattr(response, 'errors', None) or response.get('errors')
if errors:
    logger.error('‚ùå Facebook API errors: %s', errors)
    return False

received = getattr(response, 'events_received', None) or response.get('events_received')
if received in (0, None):
    logger.error('‚ùå Facebook API accepted 0 events')
    return False
```
–ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Å—Ö–µ–º—É –∫ `send_purchase_event()` –∏ `send_lead_event()`.

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #3: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `event_time` —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
**–§–∞–π–ª:** `twocomms/orders/facebook_conversions_service.py:313-318 –∏ 405-408`

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
`event_time` –≤—Å–µ–≥–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∏–∑ `order.created`. –ü—Ä–∏ –∑–∞–∫–∞–∑–∞—Ö —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏—Å—Ç–∏–∫–æ–π (–º–µ—à—å—à–µ >7 –¥–Ω–µ–π –º–µ–∂–¥—É —Å–æ–∑–¥–∞–Ω–∏–µ–º –∏ –æ–ø–ª–∞—Ç–æ–π/–ø–æ–ª—É—á–µ–Ω–∏–µ–º) Meta –æ—Ç–∫–ª–æ–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∫–∞–∫ —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å `order.created` —Å —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –∏:
- –ª–∏–±–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è, –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ >604800 —Å–µ–∫—É–Ω–¥;
- –ª–∏–±–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.

```python
current_time = int(time.time())
event_time = int(order.created.timestamp())
if current_time - event_time > 604800:
    logger.warning('Order %s older than 7 days, adjusting event_time', order.order_number)
    event_time = current_time
```

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #4: –ì–æ—Ä–æ–¥ —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è –¥–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
**–§–∞–π–ª:** `twocomms/orders/facebook_conversions_service.py:141-144`

### –î–µ—Ç–∞–ª–∏
`self._hash_data(order.city)` –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫—É –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, –Ω–æ –Ω–µ —É–¥–∞–ª—è–µ—Ç –ø—Ä–æ–±–µ–ª—ã –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã. Meta –æ–∂–∏–¥–∞–µ—Ç `ct = sha256(only letters/digits)`. –î–ª—è ¬´New York¬ª —Å–µ–π—á–∞—Å –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è `sha256("new york")`, –∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî `sha256("newyork")`, –ø–æ—ç—Ç–æ–º—É Event Match Quality —Å–Ω–∏–∂–∞–µ—Ç—Å—è.

### –†–µ—à–µ–Ω–∏–µ
–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –≥–æ—Ä–æ–¥ –ø–µ—Ä–µ–¥ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—Å–º. –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç SDK –¥–ª—è `field == "ct"`).

```python
import re
if order.city:
    normalized = re.sub(r'[^a-z0-9]', '', order.city.lower().strip())
    if normalized:
        user_data.city = self._hash_data(normalized)
```

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #5: –ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email/phone/value
**–§–∞–π–ª—ã:**
- –ö–ª–∏–µ–Ω—Ç: `twocomms/twocomms_django_theme/static/js/analytics-loader.js:687-707` (—Ñ—É–Ω–∫—Ü–∏–∏ `isValidEmail/isValidPhone`)
- –°–µ—Ä–≤–µ—Ä: `twocomms/orders/facebook_conversions_service.py:121-140`

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
–ë—Ä–∞—É–∑–µ—Ä –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ email/—Ç–µ–ª–µ—Ñ–æ–Ω –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏, –∞ —Å–µ—Ä–≤–µ—Ä —Ö–µ—à–∏—Ä—É–µ—Ç –≤—Å—ë –ø–æ–¥—Ä—è–¥. –í–Ω—É—Ç—Ä–∏ `_prepare_custom_data()` —Ç–∞–∫–∂–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ `total_sum > 0`.

### –†–∏—Å–∫–∏
- –ù–∞ —Å–µ—Ä–≤–µ—Ä –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å –º—É—Å–æ—Ä–Ω—ã–µ email/—Ç–µ–ª–µ—Ñ–æ–Ω—ã (–æ—à–∏–±–∫–∏ –≤–≤–æ–¥–∞, —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ), —á—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç Match Quality –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ–ª—é –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–î–æ–±–∞–≤–∏—Ç—å —Ç–µ –∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –µ—Å—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:

```python
from django.core.validators import validate_email
from django.core.exceptions import ValidationError

def _is_valid_email(value: str) -> bool:
    try:
        validate_email(value)
        return True
    except ValidationError:
        return False

def _is_valid_phone(digits: str) -> bool:
    return 10 <= len(digits) <= 15
```
–ò –ø—Ä–∏–º–µ–Ω—è—Ç—å –∏—Ö –ø–µ—Ä–µ–¥ `self._hash_data(...)`. –î–ª—è `value` ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ, –µ—Å–ª–∏ —Å—É–º–º–∞ ‚â§ 0.

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #6: –†–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–º–∏–ª–∏–∏
**–§–∞–π–ª—ã:**
- `analytics-loader.js:821-828` ‚Äî –±–µ—Ä—ë—Ç—Å—è –≤—Å—ë –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–ª–æ–≤–∞.
- `order_success.html:2028-2044` –∏ `facebook_conversions_service.py:133-139` ‚Äî –±–µ—Ä—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ.

### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
–û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ `ln="–ø–µ—Ç—Ä–æ–≤ —Å–∏–¥–æ—Ä–æ–≤"`, –∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ `ln="—Å–∏–¥–æ—Ä–æ–≤"`. Meta –≤–∏–¥–∏—Ç —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Å–Ω–∏–∂–∞–µ—Ç Event Match Quality.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–ü—Ä–∏–≤–µ—Å—Ç–∏ –≤—Å–µ —Ç—Ä–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∫ –æ–¥–Ω–æ–º—É –ø—Ä–∞–≤–∏–ª—É. –ü—Ä–æ—â–µ –≤—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ¬´–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ¬ª –∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:

```javascript
// analytics-loader.js
match.ln = parts[parts.length - 1].toLowerCase();
```

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #7: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç `sessionStorage`
**–§–∞–π–ª:** `twocomms/twocomms_django_theme/templates/pages/order_success.html:1820-2234`

### –ß—Ç–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ
- –§–ª–∞–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `sessionStorage` (`gtm_purchase_<orderId>` –∏ `gtm_lead_<orderId>`).
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä–æ–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ –¥—Ä—É–≥–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç —Å–µ—Å—Å–∏—é, —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤—è—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–∂–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª `facebook_events.purchase_sent`.

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–æ–¥—Ç—è–≥–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ñ–ª–∞–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–≤–æ–¥–∏—Ç—å `data-purchase-sent="true"` –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –µ–≥–æ –≤–º–µ—Å—Ç–µ —Å `sessionStorage`).
2. –ü–æ—Å–ª–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã #9 –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `order.payment_payload.facebook_events.purchase_sent` –ø—Ä—è–º–æ –≤ —à–∞–±–ª–æ–Ω–µ:

```django
{% if order.payment_payload.facebook_events.purchase_sent %}
  <!-- Purchase —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º -->
{% endif %}
```

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #8: –ù–µ—Ç retry/backoff –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
**–§–∞–π–ª:** `twocomms/orders/facebook_conversions_service.py:281-372, 374-460`

### –°—É—Ç—å
–ü—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏ –∏–∑ SDK –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É. –õ—é–±–æ–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±–æ–π —Å–µ—Ç–∏/Meta –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Ç–µ—Ä–µ —Å–æ–±—ã—Ç–∏—è.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–î–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –ø—Ä–æ—Å—Ç–æ–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä —Å 3 –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∏ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π.

```python
def retry(max_attempts=3, base_delay=1):
    def decorator(func):
        def wrapper(*args, **kwargs):
            delay = base_delay
            for attempt in range(max_attempts):
                try:
                    return func(*args, **kwargs)
                except Exception:
                    if attempt == max_attempts - 1:
                        raise
                    time.sleep(delay)
                    delay *= 2
        return wrapper
    return decorator
```
–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ `send_purchase_event`/`send_lead_event` –∏–ª–∏ –≤—ã–Ω–µ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Celery —Å `retry`.

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #9: –ü—É—Ç—å —á–µ—Ä–µ–∑ Nova Poshta –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–ª–∞–≥ `facebook_events.purchase_sent`
**–§–∞–π–ª:** `twocomms/orders/nova_poshta_service.py:500-520`

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ ¬´–ø–æ—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞¬ª –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `fb_service.send_purchase_event(order)`, –Ω–æ `order.payment_payload['facebook_events']` –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.

### –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∏ –∏ –±—É–¥—É—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å–º. –ø—Ä–æ–±–ª–µ–º—É #7) –Ω–µ —É–≤–∏–¥—è—Ç, —á—Ç–æ Purchase —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.
- –ü—Ä–∏ —Ä—É—á–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö `facebook_events.purchase_sent` –æ—Å—Ç–∞–Ω–µ—Ç—Å—è `False`, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ—à–∏—Ç, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –Ω–µ —É—Ö–æ–¥–∏–ª–æ, –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –ø–æ–≤—Ç–æ—Ä. 

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ—Ç –∂–µ —Ñ–ª–∞–≥, —á—Ç–æ –∏ –≤ `_record_monobank_status()`:

```python
payment_payload = order.payment_payload or {}
facebook_events = payment_payload.setdefault('facebook_events', {})
facebook_events['purchase_sent'] = True
facebook_events['purchase_sent_at'] = timezone.now().isoformat()
order.payment_payload = payment_payload
order.save(update_fields=['payment_payload'])
```

---

## üìä –°–í–û–î–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ü–†–û–ë–õ–ï–ú
| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
|---|----------|-------------|------|--------|
| 1 | Race condition –≤ `_record_monobank_status()` | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | `storefront/views/utils.py` | –¢—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∏–∫—Å–∞ |
| 2 | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞ Conversions API | üü° –í–∞–∂–Ω–æ | `orders/facebook_conversions_service.py` | –ò—Å–ø—Ä–∞–≤–∏—Ç—å |
| 3 | `event_time` >7 –¥–Ω–µ–π –±–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ | üü° –í–∞–∂–Ω–æ | `orders/facebook_conversions_service.py` | –ò—Å–ø—Ä–∞–≤–∏—Ç—å |
| 4 | –ì–æ—Ä–æ–¥ —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è –¥–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ | üü° –í–∞–∂–Ω–æ | `orders/facebook_conversions_service.py` | –ò—Å–ø—Ä–∞–≤–∏—Ç—å |
| 5 | –ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email/phone/value | üü° –í–∞–∂–Ω–æ | `orders/facebook_conversions_service.py` | –ò—Å–ø—Ä–∞–≤–∏—Ç—å |
| 6 | –†–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–∞–º–∏–ª–∏–∏ —Ñ—Ä–æ–Ω—Ç/—Å–µ—Ä–≤–µ—Ä | üü° –í–∞–∂–Ω–æ | `analytics-loader.js`, `order_success.html`, `facebook_conversions_service.py` | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å |
| 7 | –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `sessionStorage` | üü° –°—Ä–µ–¥–Ω–∏–π | `order_success.html` | –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ —Ñ–ª–∞–≥–∏ |
| 8 | –ù–µ—Ç retry/backoff | üü° –°—Ä–µ–¥–Ω–∏–π | `orders/facebook_conversions_service.py` | –î–æ–±–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ |
| 9 | Nova Poshta –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `facebook_events.purchase_sent` | üü° –°—Ä–µ–¥–Ω–∏–π | `orders/nova_poshta_service.py` | –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Ñ–ª–∞–≥–∞ |

---

## ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –ö–û–†–†–ï–ö–¢–ù–û
1. **Event ID** ‚Äî `order.get_purchase_event_id()` / `get_lead_event_id()` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ, –∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –ø–æ—ç—Ç–æ–º—É –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ `event_id` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞.
2. **Offer ID –∏ CustomData** ‚Äî `build_offer_id()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Google Merchant feed.
3. **–õ–æ–≥–∏–∫–∞ Lead vs Purchase** ‚Äî –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ ‚Üí Lead (200 UAH), –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ ‚Üí Purchase, –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—ã–ª–∫–∏ ‚Üí Purchase ‚Äî –≤—Å—è —Ü–µ–ø–æ—á–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞.
4. **–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ email/phone/name** ‚Äî SHA-256 –≤–µ–∑–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
5. **FBP/FBC/external_id** ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ `payment_payload.tracking` –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è.

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï
–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–∞–Ω–∏–ª–∞ –ª–æ–∂–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–≤–æ–≥–∏ –∏ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–ª–∞ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∏—Å–∫–∞—Ö. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å–ª–µ–¥—É—é—â–∏–µ:
1. –û–±–µ—Ä–Ω—É—Ç—å `_record_monobank_status()` –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –¥—É–±–ª–∏.
2. –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ API + retry/backoff, –∏–Ω–∞—á–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Meta –æ—Å—Ç–∞—ë—Ç—Å—è ¬´—á—ë—Ä–Ω—ã–º —è—â–∏–∫–æ–º¬ª.
3. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –≥–æ—Ä–æ–¥, `event_time`, –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ —Ñ–∞–º–∏–ª–∏–∏ ‚Äî —ç—Ç–æ –Ω–∞–ø—Ä—è–º—É—é –≤–ª–∏—è–µ—Ç –Ω–∞ Event Match Quality.
4. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ —Å —Ñ—Ä–æ–Ω—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—É—é –æ–ø–æ—Ä—É (`facebook_events.*`), –≤ —Ç–æ–º —á–∏—Å–ª–µ –¥–ª—è –ø—É—Ç–∏ —á–µ—Ä–µ–∑ Nova Poshta.

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —ç—Ç–∏—Ö –ø–æ–ø—Ä–∞–≤–æ–∫ –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≥–Ω–∞—Ç—å QA (Meta Test Events + —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑) –∏ –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç.


